<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>HTML 转 PDF 或 图片</title>
    <url>/PHP/html-to-pdf-image.html</url>
    <content><![CDATA[<div class="note danger"><p><a href="https://packagist.org/packages/knplabs/knp-snappy" target="_blank" rel="noopener">KnpLabs/snappy</a></p></div>
<h5 id="knp-snappy-安装"><a href="#knp-snappy-安装" class="headerlink" title="knp-snappy 安装"></a>knp-snappy 安装</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">composer require knplabs/knp-snappy</span><br></pre></td></tr></table></figure>
<h5 id="WINDOWS-系统安装扩展包-wkhtmltopdf-windows"><a href="#WINDOWS-系统安装扩展包-wkhtmltopdf-windows" class="headerlink" title="WINDOWS 系统安装扩展包 wkhtmltopdf-windows"></a>WINDOWS 系统安装扩展包 <a href="https://packagist.org/packages/wemersonjanuario/wkhtmltopdf-windows" target="_blank" rel="noopener">wkhtmltopdf-windows</a></h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">composer require wemersonjanuario/wkhtmltopdf-windows</span><br><span class="line"></span><br><span class="line"><span class="comment">#二进制文件路径(32位和64位)</span></span><br><span class="line">vendor\wemersonjanuario\wkhtmltopdf-windows\bin</span><br></pre></td></tr></table></figure>
<h5 id="LINUX-系统扩展包"><a href="#LINUX-系统扩展包" class="headerlink" title="LINUX 系统扩展包"></a>LINUX 系统扩展包</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#i386 的二进制文件</span></span><br><span class="line">composer require h4cc/wkhtmltopdf-i386</span><br><span class="line">composer require h4cc/wkhtmltoimage-i386</span><br><span class="line"></span><br><span class="line"><span class="comment">#amd64</span></span><br><span class="line">composer require h4cc/wkhtmltopdf-amd64</span><br><span class="line">composer require h4cc/wkhtmltoimage-amd64</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Knp</span>\<span class="title">Snappy</span>\<span class="title">Pdf</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Knp</span>\<span class="title">Snappy</span>\<span class="title">Image</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">$baseDir = <span class="keyword">__DIR__</span>;</span><br><span class="line">$pdfBinaryFile = $baseDir . <span class="string">'/vendor/wemersonjanuario/wkhtmltopdf-windows/bin/64bit/wkhtmltopdf.exe'</span>;</span><br><span class="line">$imageBinaryFile = $baseDir . <span class="string">'/vendor/wemersonjanuario/wkhtmltopdf-windows/bin/64bit/wkhtmltoimage.exe'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (strpos(PHP_OS, <span class="string">'Linux'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">    $h4ccPath = $baseDir . <span class="string">'/vendor/h4cc/'</span>;</span><br><span class="line">    $systemBit = exec(<span class="string">'getconf LONG_BIT'</span>);</span><br><span class="line">    <span class="keyword">if</span> ($systemBit == <span class="string">'32'</span>) &#123;</span><br><span class="line">        $pdfBinaryFile = $h4ccPath . <span class="string">'wkhtmltopdf-i386/bin/wkhtmltopdf-i386'</span>;</span><br><span class="line">        $imageBinaryFile = $h4ccPath . <span class="string">'wkhtmltoimage-i386/bin/wkhtmltoimage-i386'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $pdfBinaryFile = $h4ccPath . <span class="string">'wkhtmltopdf-amd64/bin/wkhtmltopdf-amd64'</span>;</span><br><span class="line">        $imageBinaryFile = $h4ccPath . <span class="string">'wkhtmltoimage-amd64/bin/wkhtmltoimage-amd64'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$html = <span class="string">&lt;&lt;&lt;HTML</span></span><br><span class="line"><span class="string">    &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">    &lt;html lang="zh"&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;meta charset="UTF-8"&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">            &lt;p style="font-family: 'Microsoft YaHei'"&gt;Hello World, 你好 世界!&lt;/p&gt;        </span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">HTML;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// HTML 转 PDF</span></span><br><span class="line">$pdfSnappy = <span class="keyword">new</span> Pdf($pdfBinaryFile);</span><br><span class="line">$pdfSnappy-&gt;generateFromHtml($html, $baseDir . <span class="string">'/test.pdf'</span>, [], <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// HTML 转 图片</span></span><br><span class="line">$imageSnappy = <span class="keyword">new</span> Image($imageBinaryFile);</span><br><span class="line">$imageSnappy-&gt;generateFromHtml($html, $baseDir . <span class="string">'/test.png'</span>, [</span><br><span class="line">    <span class="string">'width'</span> =&gt; <span class="number">100</span>,</span><br><span class="line">    <span class="string">'height'</span> =&gt; <span class="number">100</span>,</span><br><span class="line">    <span class="string">'quality'</span> =&gt; <span class="number">100</span></span><br><span class="line">], <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成海报(海报背景 + 二维码 + LOGO + 文字描述)</span></span><br><span class="line">$backgroundImage = $baseDir . <span class="string">'/bg.jpg'</span>;</span><br><span class="line">$qrcodeImage = $baseDir . <span class="string">'/qrcode.png'</span>;</span><br><span class="line">$logoImage = $baseDir . <span class="string">'/logo.png'</span>;</span><br><span class="line">$title = <span class="string">"海报标题AAAABBBBCCCCDDDD"</span>;</span><br><span class="line">$outputImage = $baseDir . <span class="string">'/poster.png'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">list</span> ($width, $height) = getimagesize($backgroundImage);</span><br><span class="line">$snappy = <span class="keyword">new</span> Image($imageBinaryFile);</span><br><span class="line">$snappy-&gt;generateFromHtml(generateHtml($backgroundImage, $qrcodeImage, $logoImage, $title), $outputImage, [</span><br><span class="line">    <span class="string">'width'</span> =&gt; $width,</span><br><span class="line">    <span class="string">'height'</span> =&gt; $height,</span><br><span class="line">    <span class="string">'quality'</span> =&gt; <span class="number">100</span></span><br><span class="line">], <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成HTML</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $backgroundImage</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $qrcodeImage</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $logoImage</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $title</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateHtml</span><span class="params">($backgroundImage, $qrcodeImage, $logoImage, $title)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $html = <span class="string">&lt;&lt;&lt;HTML</span></span><br><span class="line"><span class="string">        &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">        &lt;html lang="zh"&gt;</span></span><br><span class="line"><span class="string">        &lt;head&gt;</span></span><br><span class="line"><span class="string">            &lt;meta charset="UTF-8"&gt;</span></span><br><span class="line"><span class="string">            &lt;meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"&gt;</span></span><br><span class="line"><span class="string">            &lt;title&gt;&lt;/title&gt;</span></span><br><span class="line"><span class="string">            &lt;style&gt;</span></span><br><span class="line"><span class="string">                body, html &#123;</span></span><br><span class="line"><span class="string">                    width: 100%;</span></span><br><span class="line"><span class="string">                    height: 100%;</span></span><br><span class="line"><span class="string">                    margin: 0;</span></span><br><span class="line"><span class="string">                    padding: 0;</span></span><br><span class="line"><span class="string">                    font-family: "Microsoft YaHei"</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                .container &#123;</span></span><br><span class="line"><span class="string">                    position: relative;</span></span><br><span class="line"><span class="string">                    display: flex;</span></span><br><span class="line"><span class="string">                    width: 100%;</span></span><br><span class="line"><span class="string">                    height: 100%;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                .img-bg &#123;</span></span><br><span class="line"><span class="string">                    position: absolute;</span></span><br><span class="line"><span class="string">                    top: 0;</span></span><br><span class="line"><span class="string">                    left: 0;</span></span><br><span class="line"><span class="string">                    width: 100%;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                .content &#123;</span></span><br><span class="line"><span class="string">                    position: relative;</span></span><br><span class="line"><span class="string">                    z-index: 999;</span></span><br><span class="line"><span class="string">                    left: 25%;</span></span><br><span class="line"><span class="string">                    top: 37.5%;</span></span><br><span class="line"><span class="string">                    width: 50%;</span></span><br><span class="line"><span class="string">                    height: 25%;</span></span><br><span class="line"><span class="string">                    border-radius: 7px;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                .img-qrcode &#123;</span></span><br><span class="line"><span class="string">                    width: 100%;</span></span><br><span class="line"><span class="string">                    height: 100%;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                .img-logo &#123;</span></span><br><span class="line"><span class="string">                    position: absolute;</span></span><br><span class="line"><span class="string">                    top: 40%;</span></span><br><span class="line"><span class="string">                    left: 40%;</span></span><br><span class="line"><span class="string">                    width: 20%;</span></span><br><span class="line"><span class="string">                    height: 20%;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                .title &#123;</span></span><br><span class="line"><span class="string">                    width: 90%;</span></span><br><span class="line"><span class="string">                    margin: 2px auto;</span></span><br><span class="line"><span class="string">                    overflow: hidden;</span></span><br><span class="line"><span class="string">                    font-size: 20px;</span></span><br><span class="line"><span class="string">                    display: -webkit-box;</span></span><br><span class="line"><span class="string">                    -webkit-line-clamp: 2;</span></span><br><span class="line"><span class="string">                    text-overflow: ellipsis;</span></span><br><span class="line"><span class="string">                    -webkit-box-orient: vertical;</span></span><br><span class="line"><span class="string">                    text-align: center;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &lt;/style&gt;</span></span><br><span class="line"><span class="string">        &lt;/head&gt;</span></span><br><span class="line"><span class="string">        &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;div class="container"&gt;</span></span><br><span class="line"><span class="string">            &lt;img src="<span class="subst">&#123;$backgroundImage&#125;</span>" class="img-bg"&gt;</span></span><br><span class="line"><span class="string">            &lt;div class="content"&gt;</span></span><br><span class="line"><span class="string">                &lt;img src="<span class="subst">&#123;$qrcodeImage&#125;</span>" class="img-qrcode"&gt;</span></span><br><span class="line"><span class="string">                &lt;img src="<span class="subst">&#123;$logoImage&#125;</span>" class="img-logo"&gt;</span></span><br><span class="line"><span class="string">                &lt;div class="title"&gt;<span class="subst">&#123;$title&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;</span></span><br><span class="line"><span class="string">HTML;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note warning"><p>Linux 字体安装(生成PDF或图片时乱码或方块)</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. /usr/share/fonts 新建目录 windows</span><br><span class="line">2. 上传字体文件至 windows 目录下</span><br><span class="line">3. 建立字体索引信息</span><br><span class="line"><span class="built_in">cd</span> /usr/share/fonts/windows</span><br><span class="line">mkfontscale</span><br><span class="line">mkfontdir</span><br><span class="line">4. 更新字体缓存</span><br><span class="line"><span class="built_in">fc</span>-cache</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看系统中的字体</span></span><br><span class="line"><span class="built_in">fc</span>-list</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看系统中的中文字体</span></span><br><span class="line"><span class="built_in">fc</span>-list :lang=zh</span><br></pre></td></tr></table></figure>
<div class="note warning"><p>Mac 生成图片失败</p></div>
<blockquote><p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载地址</span></span><br><span class="line">https://wkhtmltopdf.org/downloads.html</span><br><span class="line"><span class="comment"># 终端</span></span><br><span class="line">wkhtmltopdf --version</span><br><span class="line">wkhtmltoimage --version</span><br><span class="line"><span class="comment"># 查看路径</span></span><br><span class="line"><span class="built_in">which</span> wkhtmltopdf</span><br><span class="line"><span class="built_in">which</span> wkhtmltoimage</span><br></pre></td></tr></table></figure>
<blockquote><p>运行</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 生成失败原因：wkhtmltoimg 0.12.6 中默认禁用本地文件访问，需配置 enable-local-file-access 为 true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Knp</span>\<span class="title">Snappy</span>\<span class="title">Image</span>;</span><br><span class="line"></span><br><span class="line">$options = [</span><br><span class="line">    <span class="string">'quality'</span> =&gt; <span class="number">100</span>,</span><br><span class="line">    <span class="string">'enable-local-file-access'</span> =&gt; <span class="keyword">true</span></span><br><span class="line">];</span><br><span class="line">$imageSnappy = <span class="keyword">new</span> Image(<span class="string">'/usr/local/bin/wkhtmltoimage'</span>);</span><br><span class="line">$imageSnappy-&gt;generateFromHtml($html, $outputImage, $options, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>GitLab CI 自动化部署</title>
    <url>/Other/gitlab-ci-automatic-deploy.html</url>
    <content><![CDATA[<div class="note danger"><p>在项目根目录下添加 .gitlab-ci.yml 文件，并将 GitLab 项目配置为使用 Runner，则每次提交或推送都会触发 CI pipeline.<br><a href="https://docs.gitlab.com/ee/ci/quick_start/index.html" target="_blank" rel="noopener">点击查看官方文档</a></p></div>
<hr>
<div class="note primary"><p>GitLab-Runner</p></div>
<blockquote><p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Mac</span></span><br><span class="line">brea install gitlab-runner</span><br><span class="line"><span class="comment"># 登录后启动（后台运行）</span></span><br><span class="line">brew services start gitlab-runner</span><br><span class="line"></span><br><span class="line"><span class="comment"># 其它环境</span></span><br><span class="line">https://docs.gitlab.com/runner/install/</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<blockquote><p>配置</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 登录 GitLab，获取 URL 和 TOKEN</span></span><br><span class="line">Shared Runner：Adimn Area -&gt; Overview -&gt; Runners（需要管理员权限）</span><br><span class="line">Group Runner：Group -&gt; Settings -&gt; CI/CD -&gt; Runner</span><br><span class="line">Specific Runner：Project -&gt; Settings -&gt; CI/CD -&gt; Runner</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册 gitlab-runner register</span></span><br><span class="line"><span class="comment"># sev @ sevdeiMac in ~/Desktop/update [10:14:20] C:130</span></span><br><span class="line">$ gitlab-runner register</span><br><span class="line">Runtime platform                                    arch=amd64 os=darwin pid=4659 revision=7a6612da version=13.12.0</span><br><span class="line">WARNING: Running <span class="keyword">in</span> user-mode.</span><br><span class="line">WARNING: Use sudo <span class="keyword">for</span> system-mode:</span><br><span class="line">WARNING: $ sudo gitlab-runner...</span><br><span class="line"></span><br><span class="line">Enter the GitLab instance URL (<span class="keyword">for</span> example, https://gitlab.com/):</span><br><span class="line">http://192.168.0.77:7777/</span><br><span class="line">Enter the registration token:</span><br><span class="line">LhV6syDworzQ_oDyezmP</span><br><span class="line">Enter a description <span class="keyword">for</span> the runner:</span><br><span class="line">[sevdeiMac.local]:</span><br><span class="line">Enter tags <span class="keyword">for</span> the runner (comma-separated):</span><br><span class="line"></span><br><span class="line">Registering runner... succeeded                     runner=LhV6syDw</span><br><span class="line">Enter an executor: docker, shell, ssh, virtualbox, custom, docker-ssh, parallels, docker+machine, docker-ssh+machine, kubernetes:</span><br><span class="line">shell</span><br><span class="line">Runner registered successfully. Feel free to start it, but <span class="keyword">if</span> it<span class="string">'s running already the config should be automatically reloaded!</span></span><br></pre></td></tr></table></figure>
<blockquote class="blockquote-center"><p>以下部署脚本，需先配置 SSH 公钥登录</p>
</blockquote>
<div class="note primary"><p>配置 PHP 项目的部署脚本</p></div>
<blockquote><p>.gitlab-ci.yml</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 测试服务器 121.21.21.21，端口 7777，用户 www，项目目录 /data/server</span></span><br><span class="line"><span class="comment"># 生产服务器 121.21.21.22，端口 7777，用户 www，项目目录 /data/server</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-test:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">deploy</span></span><br><span class="line"><span class="attr">  variables:</span></span><br><span class="line"><span class="attr">    SERVER_IP:</span> <span class="string">"121.21.21.21"</span></span><br><span class="line"><span class="attr">    SERVER_PORT:</span> <span class="string">"7777"</span></span><br><span class="line"><span class="attr">    SERVER_USERNAME:</span> <span class="string">"www"</span></span><br><span class="line"><span class="attr">    PROJECT_DIR:</span> <span class="string">"/data/server"</span></span><br><span class="line"><span class="attr">  script:</span> <span class="string">"sh ./deploy.sh"</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-prod:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">deploy</span></span><br><span class="line"><span class="attr">  variables:</span></span><br><span class="line"><span class="attr">    SERVER_IP:</span> <span class="string">"121.21.21.22"</span></span><br><span class="line"><span class="attr">    SERVER_PORT:</span> <span class="string">"7777"</span></span><br><span class="line"><span class="attr">    SERVER_USERNAME:</span> <span class="string">"www"</span></span><br><span class="line"><span class="attr">    PROJECT_DIR:</span> <span class="string">"/data/server"</span></span><br><span class="line"><span class="attr">  script:</span> <span class="string">"sh ./deploy.sh"</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>
<blockquote><p>deploay.sh</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">rsync -azv -e <span class="string">"ssh -p <span class="variable">$&#123;SERVER_PORT&#125;</span>"</span> --delete \</span><br><span class="line">	--exclude=.git \</span><br><span class="line">	--exclude=.idea \</span><br><span class="line">	--exclude=.gitignore \</span><br><span class="line">	--exclude=.gitattributes \</span><br><span class="line">	--exclude=.gitlab-ci.yml \</span><br><span class="line">	--exclude=.DS_Store \</span><br><span class="line">	--exclude=.env \</span><br><span class="line">	--exclude=vendor \</span><br><span class="line">	./ <span class="variable">$&#123;SERVER_USER&#125;</span>@<span class="variable">$&#123;SERVER_IP&#125;</span>:<span class="variable">$&#123;PROJECT_DIR&#125;</span></span><br><span class="line">ssh -p <span class="variable">$&#123;SERVER_PORT&#125;</span> <span class="variable">$&#123;SERVER_USER&#125;</span>@<span class="variable">$&#123;SERVER_IP&#125;</span> &lt;&lt; EOF</span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$&#123;PROJECT_DIR&#125;</span></span><br><span class="line">  composer install</span><br><span class="line">  <span class="built_in">exit</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<div class="note primary"><p>配置前端项目的部署脚本 </p></div>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 前端采用 npm 作为包管理工具，vue 作为框架，打包后的目录名为 dist</span></span><br><span class="line"><span class="comment"># 测试服务器 121.21.21.21，端口 7777，用户 www，项目目录 /data/client</span></span><br><span class="line"><span class="comment"># 生产服务器 121.21.21.22，端口 7777，用户 www，项目目录 /data/client</span></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">build</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">build</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">npm</span> <span class="string">config</span> <span class="string">set</span> <span class="string">registry</span> <span class="attr">https://registry.npm.taobao.org</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-test:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">deploy</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">build:stage</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">rsync</span> <span class="bullet">-azv</span> <span class="bullet">-e</span> <span class="string">"ssh -p 7777"</span> <span class="bullet">--delete</span> <span class="string">dist/</span> <span class="string">www@121.21.21.21:/data/client</span></span><br><span class="line"><span class="attr">  cache:</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">node_modules/</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-prod:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">deploy</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">rsync</span> <span class="bullet">-azv</span> <span class="bullet">-e</span> <span class="string">"ssh -p 7777"</span> <span class="bullet">--delete</span> <span class="string">dist/</span> <span class="string">www@121.21.21.22:/data/client</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>
<hr>
<div class="note warning"><p>参考资料</p></div>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/184936276" target="_blank" rel="noopener">Gitlab-ci:从零开始的前端自动化部署</a></li>
<li><a href="https://www.ebaina.com/articles/140000005035" target="_blank" rel="noopener">.gitlab-ci.yml关键词完整解析（一）</a></li>
<li><a href="https://www.ebaina.com/articles/140000005088" target="_blank" rel="noopener">.gitlab-ci.yml关键词完整解析（二）</a></li>
<li><a href="https://www.ebaina.com/articles/140000005154" target="_blank" rel="noopener">.gitlab-ci.yml关键词完整解析（三）</a></li>
</ul>
]]></content>
      <categories>
        <category>Other</category>
      </categories>
      <tags>
        <tag>gitlab</tag>
        <tag>deploy</tag>
        <tag>runner</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP 系列 (三)</title>
    <url>/PHP/php-series-3.html</url>
    <content><![CDATA[<div class="note danger"><p>cURL 模拟登录</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$data = [</span><br><span class="line">    <span class="string">'email'</span> =&gt; <span class="string">'test@126.com'</span>,</span><br><span class="line">    <span class="string">'password'</span> =&gt; <span class="string">'123456'</span>,</span><br><span class="line">];</span><br><span class="line"><span class="comment">// 模拟登录</span></span><br><span class="line">$cookie = <span class="keyword">__DIR__</span> . <span class="string">'/cookie.txt'</span>;</span><br><span class="line">$ch = curl_init();</span><br><span class="line">curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 连接结束后,保存 cookie 信息的文件</span></span><br><span class="line">curl_setopt($ch, CURLOPT_COOKIEJAR, $cookie);</span><br><span class="line">curl_setopt($ch, CURLOPT_POST, <span class="keyword">true</span>);</span><br><span class="line">curl_setopt($ch, CURLOPT_POSTFIELDS, $data);</span><br><span class="line">$result = curl_exec($ch);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 采集数据</span></span><br><span class="line">$url = <span class="string">'http://xxx.com/login'</span>;</span><br><span class="line">$ch = curl_init();</span><br><span class="line">curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 包含 cookie 数据的文件</span></span><br><span class="line">curl_setopt($ch, CURLOPT_COOKIEFILE, $cookie);</span><br><span class="line">$result = curl_exec($ch);</span><br><span class="line">$result = json_decode($result, <span class="keyword">true</span>, JSON_UNESCAPED_UNICODE);</span><br><span class="line">var_dump($result);</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p>通过 SSH 拷贝远程文件至本地</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SSH2</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> resource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $ssh;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SSH2 constructor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $host</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int    $port</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $password</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $host, int $port, string $username, string $password)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ssh = ssh2_connect($host, $port);</span><br><span class="line">        ssh2_auth_password(<span class="keyword">$this</span>-&gt;ssh, $username, $password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Exec.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $command</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span><span class="params">(string $command)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $stream = ssh2_exec(<span class="keyword">$this</span>-&gt;ssh, $command);</span><br><span class="line">        stream_set_blocking($stream, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> stream_get_contents($stream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Scp send.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string   $local</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string   $remote</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int|null $mode</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scpSend</span><span class="params">(string $local, string $remote, ?int $mode = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ssh2_scp_send(<span class="keyword">$this</span>-&gt;ssh, $local, $remote, $mode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Scp recv.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $remote</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $local</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scpRecv</span><span class="params">(string $remote, string $local)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ssh2_scp_recv(<span class="keyword">$this</span>-&gt;ssh, $remote, $local);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $ip = <span class="string">'192.168.0.77'</span>;</span><br><span class="line">    $username = <span class="string">'root'</span>;</span><br><span class="line">    $password = <span class="string">'root'</span>;</span><br><span class="line">    $ssh2 = <span class="keyword">new</span> SSH2($ip, <span class="number">22</span>, $username, $password);</span><br><span class="line">    <span class="comment">// 打包远程文件</span></span><br><span class="line">    $ssh2-&gt;exec(<span class="string">'cd /data/backup &amp;&amp; rm -rf backup.zip &amp;&amp; zip -r backup.zip ./'</span>);</span><br><span class="line">    <span class="comment">// 拷贝远程文件至本地</span></span><br><span class="line">    $ssh2-&gt;scpRecv(<span class="string">'/data/backup/backup.zip'</span>, <span class="string">'D:\backup\backup.zip'</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">exit</span>($e-&gt;getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>cURL 代理 (GuzzleHttp)</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// curl --proxy 127.0.0.1:58591 https://www.google.com/</span></span><br><span class="line"></span><br><span class="line">    $url = <span class="string">'https://www.google.com/'</span>;</span><br><span class="line">    $client = <span class="keyword">new</span> GuzzleHttp\Client([</span><br><span class="line">        <span class="string">'timeout'</span> =&gt; <span class="number">3</span></span><br><span class="line">    ]);</span><br><span class="line">    $response = $client-&gt;get($url, [</span><br><span class="line">        <span class="string">'curl'</span> =&gt; [</span><br><span class="line">            CURLOPT_SSL_VERIFYPEER =&gt; <span class="number">0</span>,</span><br><span class="line">            CURLOPT_SSL_VERIFYHOST =&gt; <span class="number">0</span>,</span><br><span class="line">            CURLOPT_PROXY =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">            CURLOPT_PROXYPORT =&gt; <span class="string">'58591'</span>,</span><br><span class="line">        ]</span><br><span class="line">    ]);</span><br><span class="line">    var_dump(json_decode($response-&gt;getBody()-&gt;getContents(), <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">3</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="number">0</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class="number">0</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_PROXY, <span class="string">'127.0.0.1'</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_PROXYPORT, <span class="string">'58591'</span>);</span><br><span class="line">    $result = curl_exec($ch);</span><br><span class="line">    curl_close($ch);</span><br><span class="line">    var_dump(json_decode($result, <span class="keyword">true</span>));</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable $t) &#123;</span><br><span class="line">    <span class="keyword">exit</span>($t-&gt;getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>合并多维数组</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 需求：处理多维数组，并以一维数组的显示如下结果</span></span><br><span class="line"><span class="comment"> * A 品牌 =&gt; 一组</span></span><br><span class="line"><span class="comment"> * B 品牌 =&gt; 一组</span></span><br><span class="line"><span class="comment"> * ...</span></span><br><span class="line"><span class="comment"> * E 品牌 =&gt; 二组</span></span><br><span class="line"><span class="comment"> * ...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">$brandArray = [];</span><br><span class="line">$brandGroups = [</span><br><span class="line">    <span class="string">'一组'</span> =&gt; [</span><br><span class="line">        [<span class="string">'A 品牌'</span>],</span><br><span class="line">        [</span><br><span class="line">            <span class="string">'B 品牌'</span>,</span><br><span class="line">            <span class="string">'C 品牌'</span>,</span><br><span class="line">        ],</span><br><span class="line">        [<span class="string">'D 品牌'</span>],</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">'二组'</span> =&gt; [</span><br><span class="line">        [</span><br><span class="line">            <span class="string">'E 品牌'</span>,</span><br><span class="line">            <span class="string">'F 品牌'</span>,</span><br><span class="line">        ],</span><br><span class="line">        [<span class="string">'G 品牌'</span>],</span><br><span class="line">    ]</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第一种：foreach - 数组有几个层级，就得遍历几次</span></span><br><span class="line"><span class="keyword">foreach</span> ($brandGroups <span class="keyword">as</span> $groupName =&gt; $groups) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($groups <span class="keyword">as</span> $brands) &#123;</span><br><span class="line">        $brandArray = array_merge($brandArray, array_fill_keys($brands, $groupName));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种：RecursiveIteratorIterator</span></span><br><span class="line"><span class="keyword">foreach</span> ($brandGroups <span class="keyword">as</span> $groupName =&gt; $groups) &#123;</span><br><span class="line">    $it = <span class="keyword">new</span> \RecursiveIteratorIterator(<span class="keyword">new</span> \RecursiveArrayIterator($groups));</span><br><span class="line">    $brandArray = array_merge($brandArray, array_fill_keys(iterator_to_array($it, <span class="keyword">false</span>), $groupName));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三种：array_walk_recursive</span></span><br><span class="line"><span class="keyword">foreach</span> ($brandGroups <span class="keyword">as</span> $groupName =&gt; $groups) &#123;</span><br><span class="line">    $brands = [];</span><br><span class="line">    array_walk_recursive($groups, <span class="function"><span class="keyword">function</span> <span class="params">($arr)</span> <span class="title">use</span> <span class="params">(&amp;$brands)</span> </span>&#123;</span><br><span class="line">        $brands[] = $arr;</span><br><span class="line">    &#125;);</span><br><span class="line">    $brandArray = array_merge($brandArray, array_fill_keys($brands, $groupName));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dd($brandArray);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP 相关问题</title>
    <url>/PHP/php-questions.html</url>
    <content><![CDATA[<div class="note danger"><p>$_SERVER[‘path_info’] WINDOWS环境下, 奇葩问题</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 路由地址以H5开头的, 首字母会被转化为大写</span></span><br><span class="line"><span class="comment"># 例：test.com/h5/getUser</span></span><br><span class="line">path_info = H5/getUser</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>Redis 扩展 ping() 返回值</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. redis extension &lt; 5.0, ping() <span class="built_in">return</span> +PONG</span><br><span class="line">2. redis extension &gt;= 5.0, ping() <span class="built_in">return</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 若设置了 $message, 则 ping($message = null) 成功后, 返回 $message, 兼容 redis 4.x 和 5.x 的 ping() 写法</span></span><br><span class="line"><span class="keyword">if</span> (!(<span class="variable">$redis</span>-&gt;ping(<span class="string">'+PONG'</span>) === <span class="string">'+PONG'</span>)) &#123;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="string">'redis connection is not available'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>NodeJs &amp; Npm</title>
    <url>/NodeJs/nodejs-npm.html</url>
    <content><![CDATA[<div class="note danger"><p>Node.js 基于 Chrome V8 引擎的 JavaScript 运行环境</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Mac </span></span><br><span class="line">brew install node</span><br><span class="line"><span class="comment"># Linux </span></span><br><span class="line">wget https://nodejs.org/dist/v14.17.3/node-v14.17.3-linux-x64.tar.xz</span><br><span class="line">tar -xvf node-v14.17.3-linux-x64.tar.xz</span><br><span class="line">mv node-v14.17.3-linux-x64 /usr/<span class="built_in">local</span>/node</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/node/bin/node /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/node/bin/npm /usr/<span class="built_in">local</span>/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 node 版本</span></span><br><span class="line">node -v</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>NPM 是 Node.js 默认的包管理工具</p></div>
<blockquote><p>常用命令</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看包管理工具版本</span></span><br><span class="line">npm -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看全局安装的包</span></span><br><span class="line">npm list -g --depth 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前目录安装的包</span></span><br><span class="line">npm list</span><br><span class="line"></span><br><span class="line"><span class="comment"># npm 设置国内代理(原代理 https://registry.npmjs.org/)</span></span><br><span class="line">npm config <span class="built_in">set</span> registry https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>
<blockquote><p><code>npm i</code> 和 <code>npm ci</code> 区别</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install（npm i) 适用场景：安装新依赖或者升级已有依赖</span><br><span class="line">1. npm i 将安装所有 package.json 中的依赖。</span><br><span class="line">2. 如果使用 ^ 或 ~ 标识依赖的版本，npm i 将精准安装所标识的版本。</span><br><span class="line">3. npm i 会更新 package-lock.json 文件。</span><br><span class="line"></span><br><span class="line">npm ci 适用场景：在 CI/CD 场景中使用，确保依赖版本一致</span><br><span class="line">1. 将删除 node_modules 文件夹以确保干净的环境。</span><br><span class="line">2. 依照 package-lock.json 里的依赖版本精准安装。</span><br><span class="line">3. 强依赖于 package-lock.json，如果 package-lock.json 不存在，npm ci 将不会工作。</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>NodeJs</category>
      </categories>
      <tags>
        <tag>nodejs</tag>
        <tag>npm</tag>
      </tags>
  </entry>
  <entry>
    <title>Mac 常用软件</title>
    <url>/Mac/mac-common-software.html</url>
    <content><![CDATA[<div class="note danger"><p>Homebrew</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装方式一：</span></span><br><span class="line">/bin/bash -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装方式二（推荐）：</span></span><br><span class="line"><span class="comment"># 浏览器访问 install.sh，下载后编辑 install.sh</span></span><br><span class="line"><span class="comment"># 将 https://github.com/Homebrew/brew 替换为 https://github.com.cnpmjs.org/Homebrew/brew.git</span></span><br><span class="line">sh install.sh</span><br><span class="line"><span class="comment"># 当代码运行到 Tapping homebrew/core 时，Ctrl + C 退出进程</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/Homebrew/Library/Taps/homebrew</span><br><span class="line"><span class="comment"># 下载 homebrew-core</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com.cnpmjs.org/Homebrew/homebrew-core.git</span><br><span class="line"><span class="comment"># 下载 homebrew-services</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com.cnpmjs.org/Homebrew/homebrew-services.git</span><br><span class="line"></span><br><span class="line">brew update</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>iTerm2 + zsh</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置默认终端软件，左上角菜单栏：iTerm2 → Make iTerm2 Default Term</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 oh-my-zsh（如果太慢，就浏览器访问 install.sh，下载后运行 sh install.sh）</span></span><br><span class="line">sh -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置主题，修改 ZSH_THEME="ys"</span></span><br><span class="line">vim ~/.zshrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载配色包 - https://github.com/mbadolato/iTerm2-Color-Schemes.git</span></span><br><span class="line"><span class="comment"># 配色方案 iTerm2-Color-Schemes-master/schemes/Mirage.itermcolors</span></span><br><span class="line">iTerm2 -&gt; Prefenences -&gt; Profiles -&gt; Colors -&gt; Color Presets -&gt; Import 导入配色方案</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>Git 安装并替换默认 Git</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载并安装 git，https://git-scm.com/download/mac 选择 Binary installer 下的 installer</span></span><br><span class="line"><span class="comment"># 安装后的 git 位于 /usr/local/bin/git</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名默认 git</span></span><br><span class="line">sudo mv /usr/bin/git /usr/bin/git-system</span><br><span class="line"><span class="comment"># 若提示 Operation not permitted, 则需要关闭 rootless 机制, 然后重新运行上面的命令</span></span><br><span class="line">重启 -&gt; <span class="built_in">command</span> + r (恢复模式）-&gt; 打开终端 -&gt; 输入命令 csrutil <span class="built_in">disable</span> -&gt; 重启</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Mac</category>
      </categories>
      <tags>
        <tag>mac</tag>
      </tags>
  </entry>
  <entry>
    <title>Mac 下 Homebrew 搭建 PHP 开发环境</title>
    <url>/Mac/mac-homebrew-php.html</url>
    <content><![CDATA[<div class="note danger"><p>PHP</p></div>
<blockquote><p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install php</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">brew services start php@7.4</span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">brew services restart php@7.4</span><br><span class="line"><span class="comment"># 查看安装好的php路径</span></span><br><span class="line">brew --prefix php@7.4</span><br></pre></td></tr></table></figure>
<blockquote><p>配置</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置 /usr/local/etc/php/7.4/php-fpm.conf</span></span><br><span class="line">pid = /usr/<span class="built_in">local</span>/var/run/php74-fpm.pid</span><br><span class="line">error_log = /Users/sev/Development/logs/php74-fpm.log</span><br><span class="line"></span><br><span class="line">vim ~/.bash_profile</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">"/usr/local/opt/php@7.4/bin:<span class="variable">$PATH</span>"</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">"/usr/local/opt/php@7.4/sbin:<span class="variable">$PATH</span>"</span></span><br><span class="line"><span class="built_in">export</span> LDFLAGS=<span class="string">"-L/usr/local/opt/php@7.4/lib"</span></span><br><span class="line"><span class="built_in">export</span> CPPFLAGS=<span class="string">"-I/usr/local/opt/php@7.4/include"</span></span><br><span class="line"><span class="comment"># 注意：source ~/.bash_profile, 关闭窗口后就失效, 配置打开终端就生效</span></span><br><span class="line">vim ~/.zshrc</span><br><span class="line"><span class="comment"># 在文件尾部添加一行</span></span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<blockquote><p>redis 扩展</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载 Redis 包并解压</span></span><br><span class="line">phpize</span><br><span class="line">./configure --with-php-config=/usr/<span class="built_in">local</span>/opt/php@7.4/bin/php-config</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># /usr/local/etc/php/7.4/conf.d/ext-redis.ini</span></span><br><span class="line">extension=redis.so</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看是否安装</span></span><br><span class="line">php -m | grep redis</span><br></pre></td></tr></table></figure>
<blockquote><p>替换默认 PHP</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim ~/.bash_profile</span><br><span class="line"><span class="built_in">export</span> PATH=/Applications/MAMP/bin/php/php7.4.12/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换后，PHP 命令行响应慢（原因：尝试执行 DNS 查找本地计算机的主机名）</span></span><br><span class="line"><span class="comment"># 查看 Mac 名称：系统偏好设置 -&gt; 共享 -&gt; sevdeiMac.local</span></span><br><span class="line"><span class="comment"># 配置 hosts，加入以下两行代码</span></span><br><span class="line">127.0.0.1 sevdeiMac.local</span><br><span class="line">::1 sevdeiMac.local</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>Nginx</p></div>
<blockquote><p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install nginx</span><br><span class="line"><span class="comment"># 查看配置是否正常</span></span><br><span class="line">sudo nginx -t</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">sudo nginx</span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure>
<blockquote><p>配置 <code>/usr/local/etc/nginx/nginx.conf</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pid        /usr/<span class="built_in">local</span>/var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">access_log           /Users/sev/Development/logs/nginx_access.log;</span><br><span class="line">error_log            /Users/sev/Development/logs/nginx_error.log;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">    root   html;</span><br><span class="line">    index  index.html index.htm index.php;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~ \.php$ &#123;</span><br><span class="line">    root           html;</span><br><span class="line">    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">    fastcgi_index  index.php;</span><br><span class="line">    <span class="comment">#fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span></span><br><span class="line">    fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">    include        fastcgi_params;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include /Users/sev/Development/nginx/conf.d/*.conf;</span><br></pre></td></tr></table></figure>
<blockquote><p>配置 sock 连接 PHP, 方便支持 PHP 多版本</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置 /usr/local/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment"># 配置用户/组（与 php 运行的用户/组 一致)</span></span><br><span class="line">user sev staff;</span><br><span class="line"></span><br><span class="line">location ~ \.php$ &#123;</span><br><span class="line">    root           html;</span><br><span class="line">    fastcgi_pass   /usr/<span class="built_in">local</span>/var/run/php74-fpm.sock;</span><br><span class="line">    fastcgi_index  index.php;</span><br><span class="line">    <span class="comment">#fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span></span><br><span class="line">    fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">    include        fastcgi_params;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 /usr/local/etc/php/7.4/php-fpm.d/www.conf</span></span><br><span class="line">; listen = 127.0.0.1:9000</span><br><span class="line">listen = /usr/<span class="built_in">local</span>/var/run/php74-fpm.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 Nginx 和 PHP 服务</span></span><br></pre></td></tr></table></figure>
<div class="note danger"><p>Redis</p></div>
<blockquote><p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install redis</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">brew services start redis</span><br><span class="line"><span class="comment"># 通过配置文件启动 nginx</span></span><br><span class="line">redis-server /usr/<span class="built_in">local</span>/etc/redis.conf</span><br></pre></td></tr></table></figure>
<blockquote><p>配置</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置 /usr/local/etc/redis.conf</span></span><br><span class="line">daemonize yes</span><br><span class="line">requirepass 123456</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启配置</span></span><br><span class="line">cp /usr/<span class="built_in">local</span>/Cellar/redis/6.2.4/homebrew.mxcl.redis.plist ~/Library/LaunchAgents</span><br><span class="line">launchctl load ~/Library/LaunchAgents/homebrew.mxcl.redis.plist</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>MySQL</p></div>
<blockquote><p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install mysql@5.7</span><br><span class="line"><span class="comment"># 启动数据库</span></span><br><span class="line">brew services start mysql@5.7</span><br><span class="line"><span class="comment"># 默认无密码</span></span><br></pre></td></tr></table></figure>
<blockquote><p>配置</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim ~/.bash_profile</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">"/usr/local/opt/mysql@5.7/bin:<span class="variable">$PATH</span>"</span></span><br><span class="line"><span class="built_in">export</span> LDFLAGS=<span class="string">"-L/usr/local/opt/mysql@5.7/lib"</span></span><br><span class="line"><span class="built_in">export</span> CPPFLAGS=<span class="string">"-I/usr/local/opt/mysql@5.7/include"</span></span><br><span class="line"><span class="comment"># 运行</span></span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改密码</span></span><br><span class="line">mysql -u root -p</span><br><span class="line">use mysql;</span><br><span class="line">UPDATE user SET authentication_string=password(<span class="string">'123456'</span>) WHERE user=<span class="string">'root'</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"><span class="comment"># 提示：ERROR 1819 (HY000): Your password does not satisfy the current policy requirements</span></span><br><span class="line">SET GLOBAL validate_password_policy=LOW;</span><br><span class="line">SET GLOBAL validate_password_length=6;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Mac</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>mac</tag>
      </tags>
  </entry>
  <entry>
    <title>Mac 配置</title>
    <url>/Mac/mac-configuration.html</url>
    <content><![CDATA[<div class="note danger"><p>开启/关闭允许安装 “任何来源” 的软件</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 开启</span></span><br><span class="line">sudo spctl --master-disable</span><br><span class="line"><span class="comment"># 关闭</span></span><br><span class="line">sudo spctl --master-enable</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>设置一位密码</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwpolicy -clearaccountpolicies</span><br><span class="line"><span class="comment"># 提示 Clearing global acount policies 则表示成功</span></span><br></pre></td></tr></table></figure>
<div class="note danger"><p>访达文件自动排序</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">打开访达 - 工具栏 - 显示 - 查看显示选项 - 分组方式（无）、排序方式（种类）- 点击「用作默认」</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Mac</category>
      </categories>
      <tags>
        <tag>mac</tag>
      </tags>
  </entry>
  <entry>
    <title>Laravel Doctrine</title>
    <url>/Laravel/laravel-doctrine.html</url>
    <content><![CDATA[<div class="note danger"><p>Laravel8.x 安装 laravel-doctrine/orm</p></div>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 降低相关包版本，以便安装 laravel-doctrine/orm</span></span><br><span class="line">composer require doctrine/dbal:<span class="string">"^2.6"</span></span><br><span class="line">composer require doctrine/inflector:<span class="string">"^1.4"</span></span><br><span class="line">composer require laravel-doctrine/orm:<span class="string">"~1.7"</span></span><br><span class="line"><span class="comment"># 发布配置文件</span></span><br><span class="line">php artisan vendor:publish --tag=<span class="string">"config"</span> --provider=<span class="string">"LaravelDoctrine\ORM\DoctrineServiceProvider"</span></span><br></pre></td></tr></table></figure>
<h4 id="生成元数据和实休"><a href="#生成元数据和实休" class="headerlink" title="生成元数据和实休"></a>生成元数据和实休</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成元数据</span></span><br><span class="line">php artisan doctrine:mapping:import --namespace=App\\Entities\\ xml database/mappings</span><br><span class="line"><span class="comment"># 配置 doctrine.php</span></span><br><span class="line"><span class="string">'meta'</span> =&gt; env(<span class="string">'DOCTRINE_METADATA'</span>, <span class="string">'xml'</span>),</span><br><span class="line"><span class="string">'paths'</span> =&gt; [base_path(<span class="string">'database/mappings'</span>)],</span><br><span class="line"><span class="comment"># 生成实体</span></span><br><span class="line">php artisan doctrine:generate:entities / --generate-methods</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需注意一点，如果 meta =&gt; env('DOCTRINE_METADATA', 'annotations'), 则生成实体时，命名必须包含 --generate-annotations</span></span><br><span class="line">php artisan doctrine:generate:entities / --generate-methods --generate-annotations</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h4><blockquote><p>Repository.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">ReflectionClass</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\&#123;<span class="title">EntityRepository</span>, <span class="title">OptimisticLockException</span>, <span class="title">ORMException</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Class DoctrineBaseRepository</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span> App\Repository</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Repository</span> <span class="keyword">extends</span> <span class="title">EntityRepository</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $data</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">($data)</span>: <span class="title">object</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $entity = <span class="keyword">new</span> <span class="keyword">$this</span>-&gt;_entityName();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepare($entity, $data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $id</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($data, $id)</span>: <span class="title">object</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $entity = <span class="keyword">$this</span>-&gt;find($id);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepare($entity, $data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $object</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ORMException|OptimisticLockException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">($object)</span>: <span class="title">object</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_em-&gt;persist($object);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_em-&gt;flush($object);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $object</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ORMException|OptimisticLockException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span><span class="params">($object)</span>: <span class="title">object</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_em-&gt;remove($object);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_em-&gt;flush($object);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $object;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object $entity</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>        $data</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">prepare</span><span class="params">(object $entity, $data)</span>: <span class="title">object</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $set = <span class="string">'set'</span>;</span><br><span class="line">        $ref = <span class="keyword">new</span> ReflectionClass($entity);</span><br><span class="line">        <span class="keyword">foreach</span> ($ref-&gt;getProperties() <span class="keyword">as</span> $reflectionProperty) &#123;</span><br><span class="line">            $field = $reflectionProperty-&gt;getName();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($data[$field])) &#123;</span><br><span class="line">                $setter = $set . ucfirst($field);</span><br><span class="line">                $entity-&gt;$setter($data[$field]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $entity;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote><p>UserRepository.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Entities</span>\<span class="title">Users</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">EntityManager</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">Repository</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $_entityName = Users::class;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(EntityManager $em)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::__construct($em, $em-&gt;getClassMetadata(<span class="keyword">$this</span>-&gt;_entityName));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote><p>UserController.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $repositoryName</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Repository</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRepository</span><span class="params">(string $repositoryName)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> app($repositoryName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $repository = <span class="keyword">$this</span>-&gt;getRepository(UserRepository::class);</span><br><span class="line">        dd($repository-&gt;find(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Laravel</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>laravel</tag>
        <tag>doctrine</tag>
      </tags>
  </entry>
  <entry>
    <title>Git 常用命令</title>
    <url>/Git/git-commands.html</url>
    <content><![CDATA[<div class="note danger"><p>删除 git branch -a 中不存在的远程分支</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看所有分支</span></span><br><span class="line">git branch -a </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看本地分支对应的远程分支的状态</span></span><br><span class="line">git remote show origin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除没用的引用</span></span><br><span class="line">git remote prune origin</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>标签命令</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除所有本地标签</span></span><br><span class="line">git tag -d $(git tag -l)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取远程所有标签</span></span><br><span class="line">git fetch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除所有远程标签</span></span><br><span class="line">git push origin --delete $(git tag -l) <span class="comment"># Pushing once should be faster than multiple times</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 若要删除所有远程标签，步骤如下：删除所有本地标签 -&gt; 获取远程所有标签 -&gt; 删除所有远程标签</span></span><br></pre></td></tr></table></figure>
<div class="note danger"><p>导出变更文件</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 命令</span></span><br><span class="line">git archive -o 导出路径/xxx.zip NewCommitId $(git diff --name-only OldCommitId NewCommitId)</span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line">git archive -o ~/Desktop/update/update.zip 71a5f092424ce9c0fedcc127e7a0879170a4c45a $(git diff --name-only b7e3d2c8cb1c98f8c9ea006971ce50ba5d97488b 71a5f092424ce9c0fedcc127e7a0879170a4c45a)</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux 常用命令</title>
    <url>/Linux/linux-commands.html</url>
    <content><![CDATA[<div class="note danger"><p>chmod</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#修改web目录下所有文件夹与文件的权限</span></span><br><span class="line">chmod -R 755 web</span><br><span class="line"><span class="comment">#修改web目录下的所有目录权限</span></span><br><span class="line">find web -<span class="built_in">type</span> d -<span class="built_in">exec</span> chmod 755 &#123;&#125; \;</span><br><span class="line"><span class="comment">#修改web目录下的所有文件权限</span></span><br><span class="line">find web -<span class="built_in">type</span> f -<span class="built_in">exec</span> chmod 644 &#123;&#125; \;</span><br><span class="line"><span class="comment">#批量清空web目录下所有文件内容</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `find web -<span class="built_in">type</span> f`;<span class="keyword">do</span> cat /dev/null &gt; <span class="variable">$i</span>;<span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<div class="note danger"><p>chown</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#修改文件或目录的所属组和所有者</span></span><br><span class="line">chown -R 组:用户 路径</span><br><span class="line"><span class="comment">#修改web目录及子文件所属组和所有者</span></span><br><span class="line">chown -R www:www web</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p>端口/进程</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#杀死所有进程名包含WorkerMan的进程</span></span><br><span class="line">ps aux|grep WorkerMan|grep -v grep|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9;</span><br><span class="line"><span class="comment"># 管道符 "|" 用来隔开两个命令, 管道符左边命令的输出会作为管道符右边命令的输入</span></span><br><span class="line"><span class="comment"># "ps -ef" 是linux里查看所有进程的命令, 这时检索出的进程将作为下一条命令"grep WorkerMan"的输入</span></span><br><span class="line"><span class="comment"># "grep workerman" 的输出结果是所有含有关键字"WorkerMan"的进程</span></span><br><span class="line"><span class="comment"># "grep -v grep" 是在列出的进程中去除含有关键字"grep"的进程</span></span><br><span class="line"><span class="comment"># "xargs kill -9" 中的 xargs 命令是用来把前面命令的输出结果(PID)作为"kill -9"命令的参数, 并执行该命令, "kill -9"会强行杀掉指定进程</span></span><br><span class="line"><span class="comment"># "ps x" 是linux里显示所有进程的命令, 不以终端机来区分</span></span><br><span class="line"><span class="comment"># "awk '&#123;print $1&#125;'"  会匹配输出结果的第一个字段, $2 表示输出第二个字段；若是 awk '&#123;print $1, $2&#125;' 会匹配输出结果的第一个和第二个字段</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看指定端口被哪个程序占用了</span></span><br><span class="line">netstat -anp|grep 8383</span><br><span class="line">lsof -i:8383</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有的端口占用情况</span></span><br><span class="line">netstat -ano</span><br><span class="line"></span><br><span class="line"><span class="comment">#Windows查看指定端口的占用情况</span></span><br><span class="line">netstat -aon|findstr <span class="string">"9050"</span></span><br><span class="line">协议    本地地址              外部地址               状态            PID</span><br><span class="line">TCP    127.0.0.1:9050         0.0.0.0:0              LISTENING       2016</span><br><span class="line"></span><br><span class="line"><span class="comment">#Windows 查看PID对应的进程</span></span><br><span class="line">tasklist|findstr <span class="string">"2016"</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment">#Windows 结束进程</span></span><br><span class="line">taskkill /f /t /im tor.exe</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>tar/zip</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#tar打包</span></span><br><span class="line">tar -cvf web.tar web/</span><br><span class="line"><span class="comment">#tar解压</span></span><br><span class="line">tar -xvf web.tar</span><br><span class="line"></span><br><span class="line"><span class="comment">#zip打包</span></span><br><span class="line">zip -r web.zip web/</span><br><span class="line"><span class="comment">#zip解压并覆盖</span></span><br><span class="line">unzip -o web.zip</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>文件</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#新增文件</span></span><br><span class="line">touch test.txt</span><br><span class="line"><span class="comment">#清空文件</span></span><br><span class="line">&gt; test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前目录下的文件数量</span></span><br><span class="line">ls | wc -l</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>df/du</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看磁盘的使用情况以及文件系统被挂载的位置</span></span><br><span class="line">df -lh</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看目录所占空间</span></span><br><span class="line">du -sh [可选,目录名]</span><br><span class="line">	</span><br><span class="line"><span class="comment">#列出目录下所有文件大小</span></span><br><span class="line">du -sh *</span><br><span class="line"></span><br><span class="line"><span class="comment">#获得机器中所有的硬盘的分区情况</span></span><br><span class="line">fdisk -l</span><br><span class="line">	</span><br><span class="line"><span class="comment">#查看目录挂载点</span></span><br><span class="line">df [目录名] -kh</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>防火墙 Firewall</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看所有信息</span></span><br><span class="line">firewall-cmd --list-all</span><br><span class="line"><span class="comment">#添加开放端口(--permanent 表示永久生效)</span></span><br><span class="line">firewall-cmd --add-port=80/tcp --permanent</span><br><span class="line"><span class="comment">#删除开放端口</span></span><br><span class="line">firewall-cmd --remove-port=80/tcp --permanent</span><br><span class="line"><span class="comment">#重启服务</span></span><br><span class="line">systemctl restart firewalld</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>yum </p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#安装失败后, 删除 /etc/yum.repos.d 目录下对应的 repo, 然后运行 yum clean all</span></span><br></pre></td></tr></table></figure>
<div class="note danger"><p>ENV</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看PATH环境变量</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$PATH</span></span><br><span class="line"><span class="comment">#设置PATH</span></span><br><span class="line"><span class="built_in">export</span> PATH=路径1:路径2</span><br><span class="line"><span class="comment">#重新执行</span></span><br><span class="line"><span class="built_in">source</span> .bashrc</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>服务器时间同步以及修改为24小时制</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#安装ntpdate工具</span></span><br><span class="line">yum -y install ntp ntpdate</span><br><span class="line"><span class="comment">#设置系统时间与网络时间同步</span></span><br><span class="line">ntpdate cn.pool.ntp.org</span><br><span class="line"><span class="comment">#将系统时间写入硬件时间</span></span><br><span class="line">hwclock --systohc</span><br><span class="line"><span class="comment">#强制系统时间写入CMOS中防止重启失效</span></span><br><span class="line">hwclock -w</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改为24小时制</span></span><br><span class="line">vi /etc/sysconfig/clock </span><br><span class="line">ZONE=<span class="string">"Asian/Shanghai"</span></span><br><span class="line">UTC=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">cp /etc/localtime /usr/share/zoneinfo/Asia/Shanghai</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>通过进程名来杀死指定进程</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pkill -f <span class="string">"进程名"</span></span><br></pre></td></tr></table></figure>
<div class="note danger"><p>创建软链接</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ln -s 源文件或目录 目标文件或目录</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>防火墙 Iptables</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#添加iptables 3306 端口</span></span><br><span class="line">iptables -I INPUT 4 -p tcp -m state --state NEW -m tcp --dport 3306 -j ACCEPT</span><br><span class="line"><span class="comment">#永久保存iptables规则</span></span><br><span class="line">service iptables save </span><br><span class="line"></span><br><span class="line"><span class="comment">#添加iptables 3306 端口</span></span><br><span class="line">vi /etc/sysconfig/iptables</span><br><span class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 3306 -j ACCEPT</span><br><span class="line"><span class="comment">#保存退出并重启</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看添加的iptables规则</span></span><br><span class="line">iptables -nvL</span><br><span class="line"><span class="comment">#查看防火墙状态</span></span><br><span class="line">service iptables status</span><br><span class="line"><span class="comment">#停止防火墙</span></span><br><span class="line">service iptables stop</span><br><span class="line"><span class="comment">#启动防火墙</span></span><br><span class="line">service iptables start</span><br><span class="line"><span class="comment">#重启防火墙</span></span><br><span class="line">service iptables restart</span><br><span class="line"><span class="comment">#永久关闭防火墙</span></span><br><span class="line">chkconfig iptables off</span><br><span class="line"><span class="comment">#永久关闭后重启</span></span><br><span class="line">chkconfig iptables on</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>scp - Linux 之间复制文件和目录</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 参数说明 </span></span><br><span class="line">-r 递归复制整个目录</span><br><span class="line">-P 指定端口号(大写的 P)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地复制至远程</span></span><br><span class="line">scp local_file remote_username@remote_ip:remote_folder </span><br><span class="line"><span class="comment"># 远程复制到本地</span></span><br><span class="line">scp remote_username@remote_ip:remote_folder local_file</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>删除过期文件</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rm -rf /data/`date -d <span class="string">"3 days ago"</span> +%Y%m%d`.txt</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>Centos7 开机启动自定义脚本</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 赋予脚本可执行权限</span></span><br><span class="line">chmod +x /test.sh</span><br><span class="line"><span class="comment">#2. 打开 /etc/rc.d/rc.local, 在末尾添加以下内容</span></span><br><span class="line">/bin/sh /test.sh</span><br><span class="line"><span class="comment">#3. 在 centos7 中, /etc/rc.d/rc.local 权限被降低了, 需要赋予执行权限</span></span><br><span class="line">chmod +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>systemctl </p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看启动项 enabled是开机启动, disabled是开机不启动</span></span><br><span class="line">systemctl list-unit-files </span><br><span class="line"><span class="comment"># 查看开机启动项</span></span><br><span class="line">systemctl list-unit-files | grep <span class="built_in">enable</span></span><br><span class="line"><span class="comment"># 查看某服务</span></span><br><span class="line">systemctl list-unit-files | grep postfix</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>指定用户运行命令</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su - 用户名 -c <span class="string">"命令"</span></span><br></pre></td></tr></table></figure>
<div class="note danger"><p>SSH 免密公钥登录</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 服务器 IP：121.21.211.211，端口：7777，用户名：www</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 RSA 公钥私钥文件（这里存储路径 /Users/sev/.ssh)</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line"><span class="comment"># 将公钥追加到远程服务器的 authorized_keys 文件</span></span><br><span class="line">ssh-copy-id -i /Users/sev/.ssh/id_rsa.pub -p 7777 www@121.21.211.211</span><br><span class="line"><span class="comment"># 尝试登录</span></span><br><span class="line">ssh -p 7777 www@121.21.211.211</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>rsync 远程数据同步</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line">-v, --verbose 详细模式输出</span><br><span class="line">-a, --archive 归档(压缩)模式,表示以递归方式传输文件,并保持所有文件属性等同于 -rlptgoD (无 -H,-A,-X)</span><br><span class="line">-r, --recursive 对子目录以递归模式处理</span><br><span class="line">-e, --rsh=COMMAND 指定使用rsh,ssh方式进行数据同步</span><br><span class="line">-z, --compress 在传输过程中进行压缩</span><br><span class="line">-i, --itemize-changes 输出对所有更新的变更摘要</span><br><span class="line">-h, --human-readable 用人类可读的格式输出数字</span><br><span class="line"></span><br><span class="line">--delete 删除那些 DST 中 SRC 没有的文件（镜像同步）</span><br><span class="line">--exclude=PATTERN 排除符合匹配规则的文件</span><br><span class="line"></span><br><span class="line">-l, --links 不处理符号链接(保留符号链接)</span><br><span class="line">-L, --copy-links 将符号链接处理为具体的文件或者文件夹</span><br><span class="line">-p, --perms 保留权限</span><br><span class="line">-o, --owner 保留所有者(仅限superuser)</span><br><span class="line">-g, --group 保留组</span><br><span class="line">-t, --<span class="built_in">times</span> 保留修改时间</span><br><span class="line">--devices 保留设备文件(仅限superuser)</span><br><span class="line">--specials 保留特殊文件</span><br><span class="line">-D 和--devices --specials一样</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example - 同步本地本件（/Users/sev/test/ 目录下的文件）至远程服务器的 /home/www/test 目录下</span></span><br><span class="line">rsync -azv -e <span class="string">"ssh -p 7777"</span> --delete \</span><br><span class="line">	--exclude=.git \</span><br><span class="line">	--exclude=.idea \</span><br><span class="line">	--exclude=vendor \</span><br><span class="line">	--exclude=.gitignore \</span><br><span class="line">	--exclude=.gitlab-ci.yml \</span><br><span class="line">	--exclude=.DS_Store \</span><br><span class="line">	/Users/sev/<span class="built_in">test</span>/ www@121.21.211.211:/home/www/<span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<div class="note danger"><p>expect 自动化交互套件，主要应用于执行命令和程序时，系统以交互形式要求输入指定字符串，实现交互通信。</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 常用选项</span></span><br><span class="line">-c  执行脚本前先执行的命令，可多次使用。</span><br><span class="line">-d  debug模式，可以在运行时输出一些诊断信息，与在脚本开始处使用exp_internal 1相似。</span><br><span class="line">-D  启用交换调式器,可设一整数参数。</span><br><span class="line">-f  从文件读取命令，仅用于使用<span class="comment">#!时。如果文件名为"-"，则从stdin读取(使用"./-"从文件名为-的文件读取)。</span></span><br><span class="line">-i  交互式输入命令，使用<span class="string">"exit"</span>或<span class="string">"EOF"</span>退出输入状态。</span><br><span class="line">--  标示选项结束(如果你需要传递与expect选项相似的参数给脚本时)，可放到<span class="comment">#!行:#!/usr/bin/expect --。</span></span><br><span class="line">-v  显示expect版本信息</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内部命令</span></span><br><span class="line">spawn               交互程序开始后面跟命令或者指定程序</span><br><span class="line">expect              获取匹配信息匹配成功则执行expect后面的程序动作</span><br><span class="line">send exp_send       用于发送指定的字符串信息</span><br><span class="line">exp_continue        在expect中多次匹配就需要用到</span><br><span class="line">send_user           用来打印输出 相当于shell中的<span class="built_in">echo</span></span><br><span class="line"><span class="built_in">exit</span>                退出expect脚本</span><br><span class="line">eof                 expect执行结束 退出</span><br><span class="line"><span class="built_in">set</span>                 定义变量</span><br><span class="line">puts                输出变量</span><br><span class="line"><span class="built_in">set</span> timeout         设置超时时间</span><br><span class="line">interact            交互模式</span><br></pre></td></tr></table></figure>
<blockquote><p>SSH 登录</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/expect -f</span></span><br><span class="line"><span class="comment"># 脚本名称：login.exp；运行命令：expect login.exp</span></span><br><span class="line">spawn ssh root@192.168.0.77</span><br><span class="line">expect &#123;</span><br><span class="line">  <span class="string">"*yes/no"</span> &#123;</span><br><span class="line">    send <span class="string">"yes\r"</span></span><br><span class="line">    exp_continue</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">"*assword:"</span> &#123;</span><br><span class="line">    send <span class="string">"123456\r"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">expect <span class="string">"]#"</span> &#123;</span><br><span class="line">    send <span class="string">"pwd\r"</span></span><br><span class="line">&#125;</span><br><span class="line">expect <span class="string">"]#"</span> &#123;</span><br><span class="line">    send <span class="string">"exit\r"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">expect eof</span><br></pre></td></tr></table></figure>
<blockquote><p>shell 内嵌 except 脚本</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Hello"</span></span><br><span class="line"></span><br><span class="line">/usr/bin/expect &lt;&lt;-EOF</span><br><span class="line">  spawn ssh root@192.168.0.77</span><br><span class="line">  expect &#123;</span><br><span class="line">    <span class="string">"*yes/no"</span> &#123;</span><br><span class="line">      send <span class="string">"yes\r"</span></span><br><span class="line">      exp_continue</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">"*assword:"</span> &#123;</span><br><span class="line">      end <span class="string">"123456\r"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  expect <span class="string">"]#"</span> &#123;</span><br><span class="line">    send <span class="string">"pwd\r"</span></span><br><span class="line">  &#125;</span><br><span class="line">  expect <span class="string">"]#"</span> &#123;</span><br><span class="line">    send <span class="string">"exit\r"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  expect eof</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"World"</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx 负载均衡</title>
    <url>/Nginx/nginx-server-load-balancer.html</url>
    <content><![CDATA[<div class="note danger"><p>负载均衡SLB（Server Load Balancer）是一种对流量进行按需分发的服务，通过将流量分发到不同的后端服务来扩展应用系统的服务吞吐能力，并且可以消除系统中的单点故障，提升应用系统的可用性。<br>即将项目部署在多台服务器，通过 nginx 负载均衡策略转发请求至不同的服务器。</p></div>
<table>
<thead>
<tr>
<th>域名</th>
<th>项目路径</th>
<th>监听端口</th>
<th>配置文件</th>
</tr>
</thead>
<tbody>
<tr>
<td>sev.test.com</td>
<td>/data/project/test;</td>
<td>80</td>
<td>sev.test.com.conf</td>
</tr>
<tr>
<td>sev.test.com</td>
<td>/data/project/test;</td>
<td>8001</td>
<td>sev.test.com.8001.conf</td>
</tr>
<tr>
<td>sev.test.com</td>
<td>/data/project/test;</td>
<td>8002</td>
<td>sev.test.com.8002.conf</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h2 id="配置并运行"><a href="#配置并运行" class="headerlink" title="配置并运行"></a>配置并运行</h2><blockquote><p><code>sev.test.com.conf</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">log_format main</span><br><span class="line">    <span class="string">'$remote_addr $remote_user [$time_local] $http_x_Forwarded_for $request '</span></span><br><span class="line">    <span class="string">'$http_x_forwarded_for '</span></span><br><span class="line">    <span class="string">'$upstream_addr '</span></span><br><span class="line">    <span class="string">'ups_resp_time: $upstream_response_time '</span></span><br><span class="line">    <span class="string">'request_time: $request_time'</span>;</span><br><span class="line"></span><br><span class="line">upstream sev.test.com &#123;</span><br><span class="line">    server localhost:8001;</span><br><span class="line">    server localhost:8002;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  sev.test.com;</span><br><span class="line"></span><br><span class="line">    root   /data/project/<span class="built_in">test</span>;</span><br><span class="line"></span><br><span class="line">    access_log /data/logs/sev-test-com.log main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://sev.test.com;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        try_files        <span class="variable">$uri</span> =404;</span><br><span class="line">        fastcgi_pass     unix:/usr/<span class="built_in">local</span>/var/run/php74-fpm.sock;</span><br><span class="line">        fastcgi_param    SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include          fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote><p><code>sev.test.com.8001.conf</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       8001;</span><br><span class="line">    server_name  sev.test.com;</span><br><span class="line"></span><br><span class="line">    root   /data/project/<span class="built_in">test</span>;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index  index.php index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        try_files        <span class="variable">$uri</span> =404;</span><br><span class="line">        fastcgi_pass     unix:/usr/<span class="built_in">local</span>/var/run/php74-fpm.sock;</span><br><span class="line">        fastcgi_param    SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include          fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote><p><code>sev.test.com.8002.conf</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       8002;</span><br><span class="line">    server_name  sev.test.com;</span><br><span class="line"></span><br><span class="line">    root   /data/project/test;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index  index.php index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        try_files        $uri =404;</span><br><span class="line">        fastcgi_pass     unix:/usr/local/var/run/php74-fpm.sock;</span><br><span class="line">        fastcgi_param    SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        include          fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote><p><code>/data/project/test/index.php</code></p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $_SERVER[<span class="string">'REMOTE_ADDR'</span>] . <span class="string">' - '</span> . $_SERVER[<span class="string">'SERVER_PORT'</span>];</span><br></pre></td></tr></table></figure>
<blockquote><p>访问 <code>sev.test.com</code>，每次输出的端口在 8001 和 8002 交替</p>
</blockquote>
<hr>
<h2 id="负载均衡配置说明"><a href="#负载均衡配置说明" class="headerlink" title="负载均衡配置说明"></a>负载均衡配置说明</h2><div class="note primary"><p>轮询（默认）</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. nginx 负载默认采用「轮询」试，顾名思义，所有请求都按照时间顺序分配到不同的服务上</span><br><span class="line">2. 在轮询中，如果服务器down掉了，会自动剔除该服务器。</span><br><span class="line">3. 此策略适合服务器配置相当，无状态且短平快的服务使用。</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line">fail_timeout    与 max_fails 结合使用</span><br><span class="line">max_fails       设置在 fail_timeout 参数设置的时间内最大失败次数，如果在这个时间内，所有针对该服务器的请求都失败了，那么认为该服务器会被认为是停机了</span><br><span class="line">fail_time       服务器会被认为停机的时间长度，默认为10s。</span><br><span class="line">backup          标记该服务器为备用服务器。当主服务器停止时，请求会被发送到它这里。</span><br><span class="line">down            标记服务器永久停机了。</span><br><span class="line"><span class="comment"># 配置示例</span></span><br><span class="line">server localhost:8001;</span><br><span class="line">server localhost:8002 backup;</span><br><span class="line">server localhost:8003 max_fails=3 fail_timeout=20s;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">upstream sev.test.com &#123;</span><br><span class="line">    server localhost:8001;</span><br><span class="line">    server localhost:8002;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求 10次 结果：8001 与 8002 处理的请求数相等</span></span><br><span class="line">8001</span><br><span class="line">8002</span><br><span class="line">8001</span><br><span class="line">8002</span><br><span class="line">8001</span><br><span class="line">8002</span><br><span class="line">8001</span><br><span class="line">8002</span><br><span class="line">8001</span><br><span class="line">8002</span><br></pre></td></tr></table></figure>
<div class="note primary"><p>权重</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. 在轮询策略的基础上制定沦陷的几率</span><br><span class="line">2. 权重越高分配到需要处理的请求越多。</span><br><span class="line">3. 此策略可以与 least_conn 和 ip_hash 结合使用。</span><br><span class="line">4. 此策略比较适合服务器的硬件配置差别比较大的情况。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">upstream sev.test.com &#123;</span><br><span class="line">    server localhost:8001 weight=1;</span><br><span class="line">    server localhost:8002 weight=2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 请求 10次 结果：8002 处理的请求数是 8001 的两倍</span><br><span class="line">8001</span><br><span class="line">8002</span><br><span class="line">8002</span><br><span class="line">8001</span><br><span class="line">8002</span><br><span class="line">8002</span><br><span class="line">8001</span><br><span class="line">8002</span><br><span class="line">8002</span><br><span class="line">8001</span><br></pre></td></tr></table></figure>
<div class="note primary"><p>iphash</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. 负载均衡器按照客户端IP地址的分配方式，可以确保相同客户端的请求一直发送到相同的服务器。这样每个访客都固定访问一个后端服务器。</span><br><span class="line">2. 在nginx版本1.3.1之前，不能在ip_hash中使用权重（weight）。</span><br><span class="line">3. ip_hash 不能与 backup同时使用。</span><br><span class="line">4. 此策略适合有状态服务，比如session。</span><br><span class="line">5. 当有服务器需要剔除，必须手动down掉。</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">upstream sev.test.com &#123;</span><br><span class="line">		ip_hash;</span><br><span class="line">    server localhost:8001;</span><br><span class="line">    server localhost:8002;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求 10次 结果：127.0.0.1 的 访问全是 8002 端口</span></span><br><span class="line">8002</span><br><span class="line">8002</span><br><span class="line">8002</span><br><span class="line">8002</span><br><span class="line">8002</span><br><span class="line">8002</span><br><span class="line">8002</span><br><span class="line">8002</span><br><span class="line">8002</span><br><span class="line">8002</span><br></pre></td></tr></table></figure>
<div class="note primary"><p>最小连接</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. 把请求转发给连接数较少的后端服务器。轮询算法是把请求平均的转发给各个后端，使它们的负载大致相同；但是，有些请求占用的时间很长，会导致其所在的后端负载较高。这种情况下，least_conn这种方式就可以达到更好的负载均衡效果</span><br><span class="line">2. 此负载均衡策略适合请求处理时间长短不一造成服务器过载的情况。</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">upstream sev.test.com &#123;</span><br><span class="line">		least_conn;</span><br><span class="line">    server localhost:8001;</span><br><span class="line">    server localhost:8002;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求 10次 结果：8001 与 8002 处理的请求数大致相等（根据连接数变化）</span></span><br><span class="line">8002</span><br><span class="line">8001</span><br><span class="line">8002</span><br><span class="line">8002</span><br><span class="line">8001</span><br><span class="line">8002</span><br><span class="line">8001</span><br><span class="line">8002</span><br><span class="line">8001</span><br><span class="line">8002</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Laravel API 开发心得</title>
    <url>/Laravel/laravel-api.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>虽然开发了几年，但一直没有使用 <code>Laravel</code> 作为项目框架，在 <code>Laravel</code> 里，属于不折不扣的新人，正好新项目用了 <code>Laravel</code>，在这分享一下 <code>Laravel</code> 开发 <code>API</code> 心得，希望能给想使用 <code>Laravel</code> 开发的人带来帮助。</p>
<blockquote>
<p>通过实现「用户注册」接口，来介绍每个功能的使用场景。<br>PS：「用户注册」接口纯粹是为了方便介绍，所以没有使用自带的 Auth 模块.</p>
</blockquote>
<h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul>
<li><a href="#开发环境">开发环境</a></li>
<li><a href="#项目搭建">项目搭建</a></li>
<li><a href="#目录结构">目录结构</a></li>
<li><a href="#路由加载">路由加载</a></li>
<li><a href="#API规范">API 规范</a></li>
<li><a href="#Enum枚举">Enum 枚举</a></li>
<li><a href="#表单场景验证">表单场景验证</a></li>
<li><a href="#事件监听">事件监听</a></li>
<li><a href="#用户注册">用户注册</a></li>
<li><a href="#Eloquent条件查询">Eloquent 条件查询</a></li>
<li><a href="#模型事件">模型事件</a></li>
<li><a href="#队列">队列</a></li>
<li><a href="#Passport认证">Passport OAuth 认证</a></li>
<li><a href="#资料">资料</a></li>
<li><a href="#补充点">补充点</a></li>
<li><a href="#升级8.x">升级8.x</a></li>
</ul>
<a id="more"></a>
<h2 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Docker - PHP7.4 + MySQL5.7 + Nginx1.19</span><br><span class="line">IDE：PhpStorm</span><br></pre></td></tr></table></figure>
<h2 id="项目搭建"><a href="#项目搭建" class="headerlink" title="项目搭建"></a>项目搭建</h2><p><strong>一、安装 <code>Laravel</code></strong><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer create-project --prefer-dist laravel/laravel:^6.2 <span class="built_in">test</span></span><br></pre></td></tr></table></figure></p>
<p><strong>二、<code>Laravel</code> - <code>User</code> 相关文件处理</strong><br>1) 删除以下文件<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">app/Http/Controllers/Auth 目录</span><br><span class="line">database/factories/UserFactory.php</span><br><span class="line">database/migrations/2014_10_12_000000_create_users_table.php</span><br><span class="line">database/migrations/2014_10_12_100000_create_password_resets_table.php</span><br><span class="line">resources/views/welcome.blade.php</span><br></pre></td></tr></table></figure></p>
<p>2) 移动 <code>app/User.php</code> 到 <code>app/Models/User/User.php</code></p>
<p><strong>三、配置</strong><br>1) <code>.env</code> - 配置数据库<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DB_CONNECTION=mysql</span><br><span class="line">DB_HOST=127.0.0.1</span><br><span class="line">DB_PORT=3306</span><br><span class="line">DB_DATABASE=laravel</span><br><span class="line">DB_USERNAME=root</span><br><span class="line">DB_PASSWORD=123456</span><br></pre></td></tr></table></figure></p>
<p>2) <code>config/app.php</code> - 配置时区<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">'timezone'</span> =&gt; <span class="string">'Asia/Shanghai'</span></span><br></pre></td></tr></table></figure></p>
<p><strong>四、中间件 <code>AcceptHeader</code></strong></p>
<blockquote>
<p>Accept 决定了响应返回的格式，设置为 application/json, 遇到的所有报错 Laravel 会默认处理为 JSON 格式</p>
</blockquote>
<p>1) 新建 <code>app/Http/Middleware/AcceptHeader.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcceptHeader</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Closure $next</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $request-&gt;headers-&gt;set(<span class="string">'Accept'</span>, <span class="string">'application/json'</span>);</span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2) <code>app/Http/Kernel.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">protected</span> $middlewareGroups = [</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'api'</span> =&gt; [</span><br><span class="line">        \App\Http\Middleware\AcceptHeader::class,</span><br><span class="line">        ...</span><br><span class="line">    ],</span><br><span class="line">];</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p><strong>五、创建 <code>users</code> 表</strong><br>1) 创建迁移<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">php artisan make:migration create_users_table --create=users</span><br></pre></td></tr></table></figure></p>
<p>2) 编辑 <code>database/migrations/2021_04_29_070350_create_users_table.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Schema</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Schema</span>\<span class="title">Blueprint</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Migrations</span>\<span class="title">Migration</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">DB</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateUsersTable</span> <span class="keyword">extends</span> <span class="title">Migration</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> TABLE = <span class="string">'users'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the migrations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Schema::create(<span class="keyword">self</span>::TABLE, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint $table)</span> </span>&#123;</span><br><span class="line">            $table-&gt;integerIncrements(<span class="string">'id'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'account'</span>, <span class="number">32</span>)-&gt;comment(<span class="string">'账号'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'password'</span>)-&gt;comment(<span class="string">'密码'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'register_address'</span>)-&gt;comment(<span class="string">'注册地址'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'last_location'</span>)-&gt;default(<span class="string">''</span>)-&gt;comment(<span class="string">'最后登录位置'</span>);</span><br><span class="line">            $table-&gt;unsignedInteger(<span class="string">'last_ip'</span>)-&gt;comment(<span class="string">'最后登录IP'</span>);</span><br><span class="line">            $table-&gt;timestamps();</span><br><span class="line">        &#125;);</span><br><span class="line">        DB::statement(<span class="string">'ALTER TABLE '</span> . <span class="keyword">self</span>::TABLE . <span class="string">' COMMENT "用户表"'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reverse the migrations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">down</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Schema::dropIfExists(<span class="keyword">self</span>::TABLE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3） 执行迁移<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ php artisan migrate</span><br></pre></td></tr></table></figure></p>
<p><strong>六、安装扩展包</strong></p>
<p>1) <code>laravel-ide-helper</code> - <a href="https://github.com/barryvdh/laravel-ide-helper" target="_blank" rel="noopener">IDE 智能提示插件</a><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer require <span class="string">"barryvdh/laravel-ide-helper:2.8.*"</span> --dev</span><br><span class="line">$ php artisan ide-helper:generate</span><br><span class="line">$ php artisan ide-helper:models</span><br></pre></td></tr></table></figure></p>
<p>2) <code>laravel-telescope</code> - <a href="https://github.com/laravel/telescope" target="_blank" rel="noopener">调试工具</a><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer require <span class="string">"laravel/telescope:^3.0"</span> --dev</span><br><span class="line">$ php artisan telescope:install</span><br><span class="line">$ php artisan migrate --path=./vendor/laravel/telescope/src/Storage/migrations/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一般也不需要配置 `laravel-telescope`, 删除以下文件</span></span><br><span class="line">config/telescope.php</span><br><span class="line">config/app.php -&gt; TelescopeServiceProvider 服务注册</span><br><span class="line">app/Providers/TelescopeServiceProvider.php</span><br></pre></td></tr></table></figure></p>
<p><strong>七、取消扩展包自动发现,并在 <code>AppServiceProvider</code> 注册</strong></p>
<p>1) <code>composer.json</code><br><figure class="highlight"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">"extra": &#123;</span><br><span class="line">    "laravel": &#123;</span><br><span class="line">        "dont-discover": [</span><br><span class="line">            "barryvdh/laravel-ide-helper",</span><br><span class="line">            <span class="string">"laravel/telescope"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>2) <code>app/Providers/AppServiceProvider.php</code> - 仅本地环境注册服务<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;app-&gt;isLocal()) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;app-&gt;register(<span class="string">'Barryvdh\LaravelIdeHelper\IdeHelperServiceProvider'</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;app-&gt;register(<span class="string">'Laravel\Telescope\TelescopeServiceProvider'</span>);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><ul>
<li>app 目录<br>Console - 自定义的 Artisan 命令目录<br>Enums - 枚举目录<br>Exceptions - 异常处理目录<br>Http - 包含控制器、中间件以及表单请求等目录<br>Jobs - 队列任务目录<br>Libraries - 第三方包目录(包含扩展包封装类)<br>Listeners - 事件监听目录<br>ModelFilters - 模型过滤器目录<br>Models - 模型目录<br>Observers - 模型观察者目录<br>Providers - 服务提供者目录<br>Services - 业务服务类目录</li>
<li>route 目录<br>api - 接口目录</li>
</ul>
<h2 id="路由加载"><a href="#路由加载" class="headerlink" title="路由加载"></a>路由加载</h2><p>1) 删除 <code>routes/api.php</code> &amp; <code>routes/web.php</code> 路由文件</p>
<p>2) 编辑 <code>app/Providers/RouteServiceProvider.php</code>, 加载 <code>routes/api</code> 目录下的路由文件<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Support</span>\<span class="title">Providers</span>\<span class="title">RouteServiceProvider</span> <span class="title">as</span> <span class="title">ServiceProvider</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Route</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This namespace is applied to your controller routes.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * In addition, it is set as the URL generator's root namespace.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $namespace = <span class="string">'App\Http\Controllers\V1'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The path to the "home" route for your application.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> HOME = <span class="string">'/'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Define your route model bindings, pattern filters, etc.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * [<span class="doctag">@return</span>](https://learnku.com/users/31554) void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::boot();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Define the routes for the application.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * [<span class="doctag">@return</span>](https://learnku.com/users/31554) void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">map</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mapApiRoutes();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Define the "api" routes for the application.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * These routes are typically stateless.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * [<span class="doctag">@return</span>](https://learnku.com/users/31554) void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mapApiRoutes</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Route::prefix(<span class="string">'v1'</span>)</span><br><span class="line">            -&gt;middleware(<span class="string">'api'</span>)</span><br><span class="line">            -&gt;namespace(<span class="keyword">$this</span>-&gt;namespace)</span><br><span class="line">            -&gt;name(<span class="string">'v1.'</span>)</span><br><span class="line">            -&gt;group(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">foreach</span> (glob(base_path(<span class="string">'routes'</span>) . <span class="string">'/api/*.php'</span>) <span class="keyword">as</span> $file) &#123;</span><br><span class="line">                    <span class="keyword">require</span> $file;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3) 新建「路由」 <code>routes/api/user.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">Route::prefix(<span class="string">'user'</span>)</span><br><span class="line">    -&gt;namespace(<span class="string">'User'</span>)</span><br><span class="line">    -&gt;name(<span class="string">'user.'</span>)</span><br><span class="line">    -&gt;group(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        Route::post(<span class="string">'register'</span>, <span class="string">'UserController@register'</span>)-&gt;name(<span class="string">'user.register'</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></p>
<p>4) 新建「控制器」 <code>app/Http/Controllers/V1/User/UserController.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">V1</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="API规范"><a href="#API规范" class="headerlink" title="API规范"></a>API规范</h2><blockquote>
<p>参考 <a href="https://github.com/Jiannei/laravel-response" target="_blank" rel="noopener">Jiannei/laravel-response</a><br>由于个人并不太喜欢用 <code>RESTful</code> 规范的 <code>HTTP</code> 状态码以及 <code>Enum</code> 的定义, 就整了个新包 <a href="https://github.com/sevming/laravel-response" target="_blank" rel="noopener">sevming/laravel-response</a>, 默认 <code>HTTP</code> 返回状态码为 <code>200</code></p>
</blockquote>
<p>1) 安装<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer require sevming/laravel-response:^1.0.2</span><br></pre></td></tr></table></figure></p>
<p>2) 编辑 <code>app/Exceptions/Handler.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span> <span class="keyword">extends</span> <span class="title">ExceptionHandler</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> \<span class="title">Sevming</span>\<span class="title">LaravelResponse</span>\<span class="title">Support</span>\<span class="title">Traits</span>\<span class="title">ExceptionTrait</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Enum枚举"><a href="#Enum枚举" class="headerlink" title="Enum枚举"></a>Enum枚举</h2><p>1) 新建 <code>app/Enums/ResponseEnum.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Enums</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResponseEnum</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// sevming/laravel-response 默认以 '|' 作为分割错误码与错误信息的字符串</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> INVALID_REQUEST = <span class="string">'无效请求|21001'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2) 编辑 <code>app/Http/Controllers/V1/User/UserController.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">use</span> <span class="title">Sevming</span>\<span class="title">LaravelResponse</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Enums</span>\<span class="title">ResponseEnum</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Response::fail(ResponseEnum::INVALID_REQUEST);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>3) <code>POST</code> 请求 <code>/v1/user/register</code><br><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"status"</span>: <span class="string">"fail"</span>,</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"21001"</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"无效请求"</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"errors"</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="表单场景验证"><a href="#表单场景验证" class="headerlink" title="表单场景验证"></a>表单场景验证</h2><p>1) 新建「表单验证基类」 <code>app/Http/Requests/FormRequest.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Http</span>\<span class="title">FormRequest</span> <span class="title">as</span> <span class="title">BaseFormRequest</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FormRequest</span> <span class="keyword">extends</span> <span class="title">BaseFormRequest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">SceneValidator</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine if the user is authorized to make this request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authorize</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2) 新建 <code>app/Http/Requests/SceneValidator.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Validation</span>\&#123;<span class="title">Factory</span>, <span class="title">Validator</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> SceneValidator</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">protected</span> $scene = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $onlyRule = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $autoValidate = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Validate.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string|array $scene</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validate</span><span class="params">($scene = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;autoValidate) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_array($scene)) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;onlyRule = $scene;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;scene = $scene;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;handleValidate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 覆盖 ValidatesWhenResolvedTrait-&gt;validateResolved</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validateResolved</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (method_exists(<span class="keyword">$this</span>, <span class="string">'autoValidate'</span>)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;autoValidate = <span class="keyword">$this</span>-&gt;container-&gt;call([<span class="keyword">$this</span>, <span class="string">'autoValidate'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;autoValidate) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;handleValidate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle validate.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">handleValidate</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::validateResolved();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义 FormRequest-&gt;getValidatorInstance 下 validator 验证器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Factory $factory</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Validator</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validator</span><span class="params">(Factory $factory)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $validationData = <span class="keyword">$this</span>-&gt;isMethod(<span class="string">'GET'</span>) ? <span class="keyword">$this</span>-&gt;query() : <span class="keyword">$this</span>-&gt;post();</span><br><span class="line">        <span class="keyword">return</span> $factory-&gt;make($validationData, <span class="keyword">$this</span>-&gt;getRules(), <span class="keyword">$this</span>-&gt;messages(), <span class="keyword">$this</span>-&gt;attributes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get rules.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRules</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handleScene(<span class="keyword">$this</span>-&gt;container-&gt;call([<span class="keyword">$this</span>, <span class="string">'rules'</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle scene.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $rules</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">handleScene</span><span class="params">(array $rules)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;onlyRule) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handleRules(<span class="keyword">$this</span>-&gt;onlyRule, $rules);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;scene) &amp;&amp; method_exists(<span class="keyword">$this</span>, <span class="string">'scene'</span>)) &#123;</span><br><span class="line">            $scene = <span class="keyword">$this</span>-&gt;container-&gt;call([<span class="keyword">$this</span>, <span class="string">'scene'</span>]);</span><br><span class="line">            <span class="keyword">if</span> (array_key_exists(<span class="keyword">$this</span>-&gt;scene, $scene)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handleRules($scene[<span class="keyword">$this</span>-&gt;scene], $rules);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $rules;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle rules.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $sceneRules</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $rules</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">handleRules</span><span class="params">(array $sceneRules, array $rules)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $result = [];</span><br><span class="line">        <span class="keyword">foreach</span> ($sceneRules <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_numeric($key) &amp;&amp; array_key_exists($value, $rules)) &#123;</span><br><span class="line">                $result[$value] = $rules[$value];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $result[$key] = $value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3) 新建「请求类」 <code>app/Http/Requests/User/UserRequest.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">FormRequest</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRequest</span> <span class="keyword">extends</span> <span class="title">FormRequest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $autoValidate = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rules</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'account'</span> =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">            <span class="string">'password'</span> =&gt; <span class="string">'required|string|min:6'</span>,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scene</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'register'</span> =&gt; [</span><br><span class="line">                <span class="string">'account'</span>,</span><br><span class="line">                <span class="string">'password'</span>,</span><br><span class="line">            ],</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4) 编辑 <code>app/Http/Controllers/V1/User/UserController.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">User</span>\<span class="title">UserRequest</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">(UserRequest $request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $params = $request-&gt;post();</span><br><span class="line">    $request-&gt;validate(<span class="string">'register'</span>);</span><br><span class="line">    dd($params);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>5) <code>POST</code> 请求 <code>/v1/user/register</code><br><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"># 请求数据</span><br><span class="line">account:test</span><br><span class="line">password:12345</span><br><span class="line"></span><br><span class="line"># 返回数据 - 错误提示为英文</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"status"</span>: <span class="string">"fail"</span>,</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"20002"</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"Unprocessable Entity"</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"errors"</span>: &#123;</span><br><span class="line">        <span class="attr">"password"</span>: [</span><br><span class="line">            <span class="string">"The password must be at least 6 characters."</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>6) 安装 <code>overtrue/laravel-lang</code> - <a href="https://github.com/overtrue/laravel-lang" target="_blank" rel="noopener">语言包</a><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">composer require <span class="string">"overtrue/laravel-lang:~3.0"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 配置 config/app.php</span></span><br><span class="line">Illuminate\Translation\TranslationServiceProvider::class</span><br><span class="line">替换</span><br><span class="line">Overtrue\LaravelLang\TranslationServiceProvider::class</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 配置 config/app.php</span></span><br><span class="line"><span class="string">'locale'</span> =&gt; <span class="string">'zh-CN'</span></span><br></pre></td></tr></table></figure></p>
<p>7) 重新请求接口，返回数据如下：<br><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"status"</span>: <span class="string">"fail"</span>,</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"20002"</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"Unprocessable Entity"</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"errors"</span>: &#123;</span><br><span class="line">        <span class="attr">"password"</span>: [</span><br><span class="line">            <span class="string">"密码 至少为 6 个字符。"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="事件监听"><a href="#事件监听" class="headerlink" title="事件监听"></a>事件监听</h2><blockquote>
<p>QueryListener - SQL 日志记录</p>
</blockquote>
<p>1) 新建 <code>app/Listeners/QueryListener.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Listeners</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Events</span>\<span class="title">QueryExecuted</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueryListener</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create the event listener.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle the event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  QueryExecuted  $event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(QueryExecuted $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">true</span> === config(<span class="string">'app.debug'</span>)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($event-&gt;bindings <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">                <span class="keyword">if</span> ($value <span class="keyword">instanceof</span> \DateTimeInterface) &#123;</span><br><span class="line">                    $event-&gt;bindings[$key] = $value-&gt;format(<span class="string">'Y-m-d H:i:s'</span>);</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (is_bool($value)) &#123;</span><br><span class="line">                    $event-&gt;bindings[$key] = (int)$value;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $sql = str_replace(<span class="string">'?'</span>, <span class="string">"'%s'"</span>, $event-&gt;sql);</span><br><span class="line">            logger(<span class="string">"[&#123;$event-&gt;time&#125;ms] "</span> . vsprintf($sql, $event-&gt;bindings));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2) 编辑 <code>app/Providers/EventServiceProvider.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">protected</span> $listen = [</span><br><span class="line">    \Illuminate\Database\Events\QueryExecuted::class =&gt; [</span><br><span class="line">        \App\Listeners\QueryListener::class</span><br><span class="line">    ],</span><br><span class="line">];</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<h2 id="用户注册"><a href="#用户注册" class="headerlink" title="用户注册"></a>用户注册</h2><p>1) 新建「腾讯地图类」 <code>app/Libraries/TencentMapLibrary.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Libraries</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> \<span class="title">Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TencentMapLibrary</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过IP获取用户位置信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $ip</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getLocationByIp</span><span class="params">(string $ip)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'福建省厦门市'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2) 新建「服务类」 <code>app/Services/User/UserService.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> \<span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Libraries</span>\<span class="title">TencentMapLibrary</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">User</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array     $params</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> User</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createUser</span><span class="params">(array $params)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $userData = [</span><br><span class="line">            <span class="string">'account'</span> =&gt; $params[<span class="string">'account'</span>],</span><br><span class="line">            <span class="string">'password'</span> =&gt; bcrypt($params[<span class="string">'password'</span>]),</span><br><span class="line">            <span class="string">'last_ip'</span> =&gt; request()-&gt;ip(),</span><br><span class="line">        ];</span><br><span class="line">        $location = TencentMapLibrary::getLocationByIp($userData[<span class="string">'last_ip'</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($location)) &#123;</span><br><span class="line">            $userData[<span class="string">'register_address'</span>] = $location;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> User::create($userData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3) 编辑 <code>app/Models/User/User.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Auth</span>\<span class="title">User</span> <span class="title">as</span> <span class="title">Authenticatable</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $guarded = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">findByAccount</span><span class="params">(string $account)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::query()</span><br><span class="line">            -&gt;where(<span class="string">'account'</span>, $account)</span><br><span class="line">            -&gt;first();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setLastIpAttribute</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;attributes[<span class="string">'last_ip'</span>] = ip2long($value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getLastIpAttribute</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> long2ip($value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4) 编辑 <code>app/Enums/ResponseEnum.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> USER_ACCOUNT_REGISTERED = <span class="string">'账号已注册|23001'</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>5) 编辑 <code>app/Http/Controllers/V1/User/UserController.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">V1</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> \<span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">JsonResponse</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Sevming</span>\<span class="title">LaravelResponse</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Enums</span>\<span class="title">ResponseEnum</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">User</span>\<span class="title">UserRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">User</span>\<span class="title">UserService</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">User</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> UserService</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $service;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UserService $userService)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;service = $userService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> UserRequest $request</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> JsonResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">(UserRequest $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $params = $request-&gt;post();</span><br><span class="line">        $request-&gt;validate(<span class="string">'register'</span>);</span><br><span class="line">        $user = User::findByAccount($params[<span class="string">'account'</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($user)) &#123;</span><br><span class="line">            Response::fail(ResponseEnum::USER_ACCOUNT_REGISTERED);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $user = <span class="keyword">$this</span>-&gt;service-&gt;createUser($params);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response::success([</span><br><span class="line">            <span class="string">'id'</span> =&gt; $user-&gt;id</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Eloquent条件查询"><a href="#Eloquent条件查询" class="headerlink" title="Eloquent条件查询"></a><a href="https://github.com/Tucker-Eric/EloquentFilter" target="_blank" rel="noopener">Eloquent条件查询</a></h2><p>1) 安装<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer require tucker-eric/eloquentfilter:^2.4</span><br></pre></td></tr></table></figure></p>
<p>2) 新建 <code>app/Models/ModelTrait.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Models</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> ModelTrait</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">modelFilter</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> config(<span class="string">'eloquentfilter.namespace'</span>, <span class="string">'App\\ModelFilters\\'</span>)</span><br><span class="line">            . str_replace(<span class="keyword">__NAMESPACE__</span> . <span class="string">'\\'</span>, <span class="string">''</span>, get_class(<span class="keyword">$this</span>)) . <span class="string">'Filter'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3) 新建「模型过滤类」 <code>app/ModelFilters/User/UserFilter.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">ModelFilters</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">EloquentFilter</span>\<span class="title">ModelFilter</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFilter</span> <span class="keyword">extends</span> <span class="title">ModelFilter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">account</span><span class="params">($account)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;where(<span class="string">'account'</span>, $account);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4) 编辑 <code>app/Models/User/User.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">use</span> <span class="title">EloquentFilter</span>\<span class="title">Filterable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">ModelTrait</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">use</span> <span class="title">Filterable</span>, <span class="title">ModelTrait</span>;</span><br><span class="line">  ...  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">findByAccount</span><span class="params">(string $account)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">static</span>::filter([</span><br><span class="line">          <span class="string">'account'</span> =&gt; $account</span><br><span class="line">      ])</span><br><span class="line">          -&gt;first();</span><br><span class="line">   &#125;   </span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="模型事件"><a href="#模型事件" class="headerlink" title="模型事件"></a>模型事件</h2><blockquote>
<p>优化用户注册时的地址获取</p>
</blockquote>
<p>1) 新建「观察者类」 <code>app/Observers/User/UserObserver.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Observers</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">DB</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Libraries</span>\<span class="title">TencentMapLibrary</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">User</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserObserver</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saved</span><span class="params">(User $user)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        rescue(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($user)</span> </span>&#123;</span><br><span class="line">            $wasRecentlyCreated = $user-&gt;wasRecentlyCreated;</span><br><span class="line">            <span class="keyword">if</span> ($wasRecentlyCreated || $user-&gt;wasChanged(<span class="string">'last_ip'</span>)) &#123;</span><br><span class="line">                $location = TencentMapLibrary::getLocationByIp($user-&gt;last_ip);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">empty</span>($location)) &#123;</span><br><span class="line">                    $data = [<span class="string">'last_location'</span> =&gt; $location];</span><br><span class="line">                    $wasRecentlyCreated &amp;&amp; ($data[<span class="string">'register_address'</span>] = $data[<span class="string">'last_location'</span>]);</span><br><span class="line">                    DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'id'</span>, $user-&gt;id)-&gt;update($data);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2) 编辑 <code>app/Models/User/User.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Observers</span>\<span class="title">User</span>\<span class="title">UserObserver</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::boot();</span><br><span class="line">        <span class="keyword">static</span>::observe(UserObserver::class);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3) 编辑 <code>app/Services/User/UserService.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createUser</span><span class="params">(array $params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $userData = [</span><br><span class="line">        <span class="string">'account'</span> =&gt; $params[<span class="string">'account'</span>],</span><br><span class="line">        <span class="string">'password'</span> =&gt; bcrypt($params[<span class="string">'password'</span>]),</span><br><span class="line">        <span class="string">'register_address'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'last_ip'</span> =&gt; request()-&gt;ip(),</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">return</span> User::create($userData);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<h2 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h2><blockquote>
<p>用户注册地址获取修改为队列方式</p>
</blockquote>
<p>1) <code>.env</code> 队列配置<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">QUEUE_CONNECTION=redis</span><br><span class="line"></span><br><span class="line">REDIS_HOST=127.0.0.1</span><br><span class="line">REDIS_PASSWORD=123456</span><br><span class="line">REDIS_PORT=6379</span><br></pre></td></tr></table></figure></p>
<p>2) 新建「任务类」 <code>app/Jobs/User/UserLocation.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Jobs</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Bus</span>\<span class="title">Queueable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Queue</span>\<span class="title">ShouldQueue</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Bus</span>\<span class="title">Dispatchable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\&#123;<span class="title">InteractsWithQueue</span>, <span class="title">SerializesModels</span>&#125;;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Libraries</span>\<span class="title">TencentMapLibrary</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">DB</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">User</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserLocation</span> <span class="keyword">implements</span> <span class="title">ShouldQueue</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Dispatchable</span>, <span class="title">InteractsWithQueue</span>, <span class="title">Queueable</span>, <span class="title">SerializesModels</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $user;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $wasRecentlyCreated;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(User $user, bool $wasRecentlyCreated)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;user = $user;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;wasRecentlyCreated = $wasRecentlyCreated;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $location = TencentMapLibrary::getLocationByIp(<span class="keyword">$this</span>-&gt;user-&gt;last_ip);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($location)) &#123;</span><br><span class="line">            $data = [<span class="string">'last_location'</span> =&gt; $location];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;wasRecentlyCreated &amp;&amp; ($data[<span class="string">'register_address'</span>] = $data[<span class="string">'last_location'</span>]);</span><br><span class="line">            DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'id'</span>, <span class="keyword">$this</span>-&gt;user-&gt;id)-&gt;update($data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3) 编辑 <code>app/Observers/User/UserObserver.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Observers</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Jobs</span>\<span class="title">User</span>\<span class="title">UserLocation</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">User</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserObserver</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saved</span><span class="params">(User $user)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        rescue(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($user)</span> </span>&#123;</span><br><span class="line">            $wasRecentlyCreated = $user-&gt;wasRecentlyCreated;</span><br><span class="line">            <span class="keyword">if</span> ($wasRecentlyCreated || $user-&gt;wasChanged(<span class="string">'last_ip'</span>)) &#123;</span><br><span class="line">                dispatch(<span class="keyword">new</span> UserLocation($user, $wasRecentlyCreated));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4) 开启队列监听<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ php artisan queue:listen</span><br></pre></td></tr></table></figure></p>
<h2 id="Passport认证"><a href="#Passport认证" class="headerlink" title="Passport认证"></a><a href="https://github.com/laravel/passport" target="_blank" rel="noopener">Passport认证</a></h2><blockquote>
<p>实现用户注册后返回 Token, 以及删除无效 Token</p>
</blockquote>
<p>1) 安装 &amp; 配置<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer require laravel/passport:^9.4.0</span><br><span class="line">$ php artisan migrate --path=./vendor/laravel/passport/database/migrations/</span><br><span class="line">$ php artisan passport:keys</span><br><span class="line">$ php artisan passport:client --personal</span><br><span class="line">$ php artisan vendor:publish --tag=passport-config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装报错</span></span><br><span class="line">laravel/passport[v9.4.0, ..., 9.x-dev] require phpseclib/phpseclib ^2.0 -&gt; found phpseclib/phpseclib</span><br><span class="line"><span class="comment"># 删除 laravel/telescope 包后再安装, 之后再重新安装 laravel/telescope</span></span><br><span class="line">$ composer remove laravel/telescope --dev</span><br></pre></td></tr></table></figure></p>
<p>2) <code>.env</code> 配置, 保存刚刚生成的「个人客户端」<code>CLIENT_ID</code> &amp; <code>CLIENT_SECRET</code><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PASSPORT_PERSONAL_ACCESS_CLIENT_ID=1</span><br><span class="line">PASSPORT_PERSONAL_ACCESS_CLIENT_SECRET=jToNhXPoQVxVkBrdljCwk5oWzO7hroozHkqQ9Kja</span><br></pre></td></tr></table></figure></p>
<p>3) 配置 <code>app/Providers/AuthServiceProvider.php</code>, 设置 <code>TOKEN</code> 有效期一周<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Passport</span>\<span class="title">Passport</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    Passport::personalAccessClientId(config(<span class="string">'passport.personal_access_client.id'</span>));</span><br><span class="line">    Passport::personalAccessTokensExpireIn(now()-&gt;addWeek());</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>4) 编辑 <code>app/Providers/EventServiceProvider.php</code> 监听 <code>Token</code> 创建事件<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">protected</span> $listen = [</span><br><span class="line">    ...</span><br><span class="line">    \Laravel\Passport\Events\AccessTokenCreated::class =&gt; [</span><br><span class="line">        \App\Listeners\PassportAccessTokenCreated::class</span><br><span class="line">    ]</span><br><span class="line">];</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>5) 新建 <code>app/Listeners/PassportAccessTokenCreated.php</code> 删除过期 <code>Token</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Listeners</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Passport</span>\<span class="title">Events</span>\<span class="title">AccessTokenCreated</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Passport</span>\<span class="title">Token</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PassportAccessTokenCreated</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(AccessTokenCreated $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Token::query()</span><br><span class="line">            -&gt;where(<span class="string">'id'</span>, <span class="string">'&lt;&gt;'</span>, $event-&gt;tokenId)</span><br><span class="line">            -&gt;where(<span class="string">'user_id'</span>, $event-&gt;userId)</span><br><span class="line">            -&gt;where(<span class="string">'client_id'</span>, $event-&gt;clientId)</span><br><span class="line">            -&gt;where(<span class="string">'revoked'</span>, <span class="number">0</span>)</span><br><span class="line">            -&gt;where(<span class="string">'expires_at'</span>, <span class="string">'&lt;='</span>, now()-&gt;toDateTimeString())</span><br><span class="line">            -&gt;delete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>6) 编辑 <code>app/Models/User/User.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Passport</span>\<span class="title">HasApiTokens</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Filterable</span>, <span class="title">ModelTrait</span>, <span class="title">HasApiTokens</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>7) 编辑 <code>app/Observers/User/UserObserver.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saved</span><span class="params">(User $user)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $user-&gt;setAttribute(<span class="string">'token'</span>, $user-&gt;createToken($user-&gt;id)-&gt;accessToken);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>8) 编辑 <code>app/Http/Controllers/V1/User/UserController.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">(UserRequest $request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> Response::success([</span><br><span class="line">        <span class="string">'id'</span> =&gt; $user-&gt;id,</span><br><span class="line">        <span class="string">'token'</span> =&gt; $user-&gt;token</span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p><strong>使用 <code>Token</code> 作为用户的登录凭证</strong></p>
<p>1) 编辑 <code>routes/api/user.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">Route::prefix(<span class="string">'user'</span>)</span><br><span class="line">    -&gt;namespace(<span class="string">'User'</span>)</span><br><span class="line">    -&gt;name(<span class="string">'user.'</span>)</span><br><span class="line">    -&gt;group(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        Route::middleware(<span class="string">'auth:api'</span>)-&gt;group(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">            Route::get(<span class="string">'mock'</span>, <span class="string">'UserController@mock'</span>)-&gt;name(<span class="string">'user.mock'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></p>
<p>2) 编辑 <code>app/Http/Controllers/V1/User/UserController.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    dump(auth()-&gt;user());</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>3) 编辑 <code>config/auth.php</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'guards'</span> =&gt; [</span><br><span class="line">    ...</span><br><span class="line">        <span class="string">'api'</span> =&gt; [</span><br><span class="line">            <span class="string">'driver'</span> =&gt; <span class="string">'passport'</span>,</span><br><span class="line">            <span class="string">'provider'</span> =&gt; <span class="string">'users'</span>,</span><br><span class="line">            <span class="string">'hash'</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line">         ],</span><br><span class="line">     ],</span><br><span class="line">     <span class="string">'providers'</span> =&gt; [</span><br><span class="line">         <span class="string">'users'</span> =&gt; [</span><br><span class="line">             <span class="string">'driver'</span> =&gt; <span class="string">'eloquent'</span>,</span><br><span class="line">             <span class="string">'model'</span> =&gt; App\Models\User\User::class,</span><br><span class="line">          ],</span><br><span class="line">     ],</span><br><span class="line">     ...</span><br><span class="line">];</span><br></pre></td></tr></table></figure></p>
<p>4) <code>Postman</code> 配置 <code>Header</code><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Authorization: Bearer &#123;token&#125;</span><br></pre></td></tr></table></figure></p>
<p>4) <code>GET</code> 请求接口 <code>/v1/user/mock</code>, 可以看到用户的信息</p>
<p>5) 通过查看 <code>SQL</code> 日志, 发现 <code>Passport</code> 查询语句太多了, 安装 <a href="https://github.com/overtrue/laravel-passport-cache-token" target="_blank" rel="noopener">overtrue/laravel-passport-cache-token</a>, 支持配置缓存方式，具体可查看包文档说明<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer require overtrue/laravel-passport-cache-token:^2.1</span><br></pre></td></tr></table></figure></p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><p>1) 底层原理</p>
<ul>
<li>服务容器<br><a href="https://learnku.com/articles/789/laravel-learning-notes-the-magic-of-the-service-container" target="_blank" rel="noopener">Laravel 学习笔记 —— 神奇的服务容器</a><br><a href="https://learnku.com/docs/the-laravel-way/5.6/Tao-3-3/2930" target="_blank" rel="noopener">Laravel 服务容器的初始化</a></li>
<li>中间件<br><a href="https://learnku.com/articles/5180/laravel-middleware-principle" target="_blank" rel="noopener">Laravel 中间件原理</a></li>
<li>管道流<br><a href="https://learnku.com/articles/5206/the-use-of-php-built-in-function-array-reduce-in-laravel" target="_blank" rel="noopener">Laravel 管道流原理</a><br><a href="https://learnku.com/articles/2769/laravel-pipeline-realization-of-the-principle-of-single-component" target="_blank" rel="noopener">Laravel Pipeline 组件的实现原理</a></li>
<li>异常处理<br><a href="https://learnku.com/articles/23934" target="_blank" rel="noopener">Laravel 源码阅读指南–异常处理</a><br><a href="https://learnku.com/articles/5657/laravel-exceptions-exception-and-error-handling" target="_blank" rel="noopener">Laravel Exceptions——异常与错误处理</a></li>
<li>队列<br><a href="https://learnku.com/articles/5325/analysis-of-the-laravel-queue-system-worker" target="_blank" rel="noopener">剖析 Laravel 队列系统–Worker</a></li>
<li>认证<br><a href="https://learnku.com/articles/3825/laravel-authentication-principle-and-full-custom-authentication" target="_blank" rel="noopener">Laravel 认证原理及完全自定义认证</a></li>
<li>其它原理<br><a href="https://learnku.com/blog/leoyang" target="_blank" rel="noopener">leoyang 的博客</a><br><a href="https://learnku.com/docs/the-laravel-way/5.6" target="_blank" rel="noopener">Laravel之道</a></li>
</ul>
<p>2) 架构</p>
<ul>
<li><a href="https://learnku.com/laravel/t/21913" target="_blank" rel="noopener">基于 Module 的 Laravel API 架构</a></li>
<li><a href="https://learnku.com/articles/6153/laravel-modular-development" target="_blank" rel="noopener">Laravel 模块化开发</a></li>
<li><a href="https://learnku.com/articles/19452" target="_blank" rel="noopener">打造 Laravel 优美架构 谈可维护性与弹性设计</a></li>
<li><a href="https://learnku.com/laravel/t/12791/laravel-program-architecture-design-idea-use-action-class" target="_blank" rel="noopener">Laravel 程序架构设计思路：使用动作类</a></li>
<li><a href="https://learnku.com/articles/33413" target="_blank" rel="noopener">什么？快来开启 MVC 的拓展模式</a></li>
<li><a href="https://learnku.com/laravel/t/44687" target="_blank" rel="noopener">程序架构讨论：你的应用就是一个扩展的容器</a></li>
<li><a href="https://learnku.com/articles/6754/laravel-service-design-pattern" target="_blank" rel="noopener">Laravel - 服务设计模式</a></li>
<li><a href="https://www.kancloud.cn/curder/laravel/408485" target="_blank" rel="noopener">如何使用Service模式</a></li>
<li><a href="https://learnku.com/articles/6232/about-the-design-patterns-of-repository" target="_blank" rel="noopener">关于 Repository 的设计模式</a></li>
<li><a href="https://learnku.com/laravel/t/31798" target="_blank" rel="noopener">在 Laravel 5.8 中正确地应用 Repository 设计模式</a></li>
</ul>
<p>3) API 规范相关讨论</p>
<ul>
<li><a href="https://learnku.com/laravel/t/7078/can-you-write-api-well-specification-for-controversial-discussion-welcome-here" target="_blank" rel="noopener">还能不能好好的写 API 了？</a></li>
</ul>
<p>4) 表单场景验证</p>
<ul>
<li><a href="https://learnku.com/laravel/t/31215" target="_blank" rel="noopener">修改 Laravel FormRequest 验证，实现场景验证</a></li>
<li><a href="https://learnku.com/articles/38825#24c2cd" target="_blank" rel="noopener">Laravel 验证类 实现 路由场景验证 和 控制器场景验证</a></li>
</ul>
<p>5) 模型相关</p>
<ul>
<li><a href="https://learnku.com/articles/21372" target="_blank" rel="noopener">如何更快的找到自己所需的模型关联类型？</a></li>
<li><a href="https://learnku.com/laravel/t/15620/laravel-eloquent-model-associated-quick-lookup-table" target="_blank" rel="noopener">Laravel Eloquent 模型关联速查表</a></li>
<li><a href="https://learnku.com/articles/21555" target="_blank" rel="noopener">模型关联给我们带来了哪些便利</a></li>
<li><a href="https://learnku.com/articles/29100" target="_blank" rel="noopener">Laravel 模型过滤（Filter）设计</a></li>
<li><a href="https://learnku.com/laravel/t/41055" target="_blank" rel="noopener">关于模型全局作用域是否支持动态传参？</a></li>
<li><a href="https://learnku.com/articles/14365/some-experience-of-simple-and-multi-conditional-query-in-project" target="_blank" rel="noopener">对于项目中简单的多条件查询的一些心得体会</a></li>
<li><a href="https://learnku.com/articles/52851" target="_blank" rel="noopener">whereHas性能调优——采用 where in 语法实现优化 查询关联</a></li>
<li><a href="https://learnku.com/articles/13708/optimization-of-eloquents-wherehas-plus-where-in" target="_blank" rel="noopener">给 Eloquent 的 whereHas 加个 where in 的优化</a></li>
<li><a href="https://learnku.com/articles/5003/how-do-i-register-a-final-model-event-listener" target="_blank" rel="noopener">如何注册一个最后执行的模型事件监听器</a></li>
<li><a href="https://learnku.com/articles/5572/summary-of-orm-observer-usage-pit-warning" target="_blank" rel="noopener">ORM Observer 使用小结</a></li>
</ul>
<p>6) API 资源</p>
<ul>
<li><a href="https://learnku.com/laravel/t/7625/dynamically-hide-the-api-field-in-laravel" target="_blank" rel="noopener">在 Laravel 中动态隐藏 API 字段</a></li>
</ul>
<p>7) 队列</p>
<ul>
<li><a href="https://learnku.com/articles/4605/laravel-use-of-the-correct-attitude-of-the-consumer-queue" target="_blank" rel="noopener">Laravel 消费队列的正确使用姿势</a></li>
</ul>
<h2 id="补充点"><a href="#补充点" class="headerlink" title="补充点"></a>补充点</h2><p>1) 关于 <code>PhpStorm</code> 中 <code>Laravel</code> 的路由跳转 (<code>Windows</code> 下 <code>Ctrl</code> + <code>鼠标左键</code> 点击路由跳转至对应控制器)，<code>Demo</code> 中无法跳转问题</p>
<ul>
<li><p>编辑 <code>routes/api/user.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    Route::group([</span><br><span class="line">        <span class="string">'prefix'</span> =&gt; <span class="string">'user'</span>,</span><br><span class="line">        <span class="string">'namespace'</span> =&gt; <span class="string">'User'</span></span><br><span class="line">        <span class="string">'as'</span> =&gt; <span class="string">'user.'</span>,</span><br><span class="line">    ], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新生成 <code>ide-helper.php</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ php artisan ide-helper:generate</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>2) 跨域</p>
<ul>
<li><p>安装 <code>fruitcake/laravel-cors</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer require <span class="string">"fruitcake/laravel-cors:^2.0"</span></span><br><span class="line">$ php artisan vendor:publish --tag=<span class="string">"cors"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑 <code>app/Http/Kernel.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">protected</span> $middleware = [</span><br><span class="line">    \App\Http\Middleware\TrustProxies::class,</span><br><span class="line">    \Fruitcake\Cors\HandleCors::class,</span><br><span class="line">    ...</span><br><span class="line">];</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑 <code>config/cors.php</code> - <a href="https://github.com/fruitcake/laravel-cors" target="_blank" rel="noopener">查看更多配置</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">'paths'</span> =&gt; [<span class="string">'v1/*'</span>]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>3) 添加模型 <code>saveQuietly</code> 方法 - 保存给定的模型而不触发任何事件 (<code>Laravel 8.x 框架自带</code>)</p>
<ul>
<li>编辑 <code>app/Models/ModelTrait.php</code><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Save the model to the database without raising any events.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $options</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saveQuietly</span><span class="params">(array $options = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static</span>::withoutEvents(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($options)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;save($options);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="升级8-x"><a href="#升级8-x" class="headerlink" title="升级8.x"></a>升级8.x</h2><p>直接安装 8.x 版本, 再按文档搭项目，相关包版本变化如下：</p>
<ul>
<li><code>laravel/laravel:^6.2</code> to <code>^8.4.0</code></li>
<li><code>barryvdh/laravel-ide-helper:2.8.*</code> to <code>^2.10</code></li>
<li><p><code>laravel/telescope:^3.0</code> to <code>^4.4</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># migrations 路径变更</span></span><br><span class="line">php artisan migrate --path=./vendor/laravel/telescope/database/migrations/</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>overtrue/laravel-lang:~3.0</code> to <code>~5.0</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 编辑 config/app.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 与 3.0 版本不同, 这个无需替换服务提供者</span></span><br><span class="line">Illuminate\Translation\TranslationServiceProvider::class  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置语言</span></span><br><span class="line"><span class="string">'locale'</span> =&gt; <span class="string">'zh_CN'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>tucker-eric/eloquentfilter:^2.4</code> to <code>^3.0</code></p>
</li>
<li><p><code>laravel/passport:^9.4.0</code> to <code>^10.1</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 与 9.x 版本不同, 不需要在 `AuthServiceProvider` 配置 personalAccessClientId(), 且此方法在新版本的包中已移除</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>sevming/laravel-response:^1.0.2</code> to <code>^1.0.3</code></p>
</li>
<li><code>fruitcake/laravel-cors</code> - 无需安装，框架自带</li>
<li><code>app/Models/ModelTrait</code> =&gt; <code>saveQuietly</code> 不需要添加，框架自带</li>
</ul>
]]></content>
      <categories>
        <category>Laravel</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>laravel</tag>
      </tags>
  </entry>
  <entry>
    <title>Supervisord 进程管理工具</title>
    <url>/Other/supervisord.html</url>
    <content><![CDATA[<div class="note danger"><p>Supervisord 进程管理工具</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">yum install supervisor</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载自定义配置</span></span><br><span class="line">vim /etc/supervisord.conf</span><br><span class="line">[include]</span><br><span class="line">files = supervisord.d/*.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建 laravel.conf</span></span><br><span class="line">vim /etc/supervisord.d/laravel.conf</span><br><span class="line">[program:laravel]</span><br><span class="line">process_name=%(program_name)s_%(process_num)02d</span><br><span class="line"><span class="built_in">command</span>=php /data/wwwroot/laravel.com/artisan queue:work --sleep=3</span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">user=www</span><br><span class="line">numprocs=4</span><br><span class="line">redirect_stderr=<span class="literal">true</span></span><br><span class="line">stdout_logfile=/data/supervisor/laravel.com/queue.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建 /data/supervisor/laravel.com 目录,并设置文件属组</span></span><br><span class="line">mkdir -p /data/supervisor/laravel.com</span><br><span class="line">chown -R www:www /data/supervisor</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行命令</span></span><br><span class="line">supervisorctl reread</span><br><span class="line">supervisorctl update</span><br><span class="line">supervisorctl start laravel:*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题</span></span><br><span class="line"><span class="comment"># supervisorctl reread - error: &lt;class 'socket.error'&gt;, [Errno 2] No such file or directory: file: /usr/lib64/python2.7/socket.py line: 224</span></span><br><span class="line">supervisord -c /etc/supervisord.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># Error: Another program is already listening on a port that one of our HTTP servers is configured to use.</span></span><br><span class="line"><span class="comment"># 第一种：</span></span><br><span class="line">ps aux | grep supervisord</span><br><span class="line"><span class="built_in">kill</span> 进程号</span><br><span class="line"><span class="comment"># 第二种</span></span><br><span class="line">supervisorctl</span><br><span class="line">reread</span><br><span class="line">update</span><br><span class="line">start all</span><br><span class="line">status</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p>常用命令</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动 supervisord, 默认去找 $CWD/supervisord.conf</span></span><br><span class="line">supervisord</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 supervisord, 到指定路径下去找配置文件</span></span><br><span class="line">supervisord -c /etc/supervisord.d/xxx.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 supervisord 管理的所有进程</span></span><br><span class="line">supervisorctl start all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止 supervisord 管理的所有进程</span></span><br><span class="line">supervisorctl stop all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动  supervisord 管理的某一个特定进程</span></span><br><span class="line">supervisorctl start program-name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止 supervisord 管理的某一个特定进程</span></span><br><span class="line">supervisorctl stop program-name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启所有进程</span></span><br><span class="line">supervisorctl restart all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启某一进程</span></span><br><span class="line">supervisorctl reatart program-name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 supervisord 当前管理的所有进程的状态</span></span><br><span class="line">supervisorctl status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取有更新(增加)的配置文件, 但不会启动新添加的程序, 也不会重启任何程序</span></span><br><span class="line">supervisorctl reread</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启配置文件修改过的程序, 配置没有改动的进程不会收到影响而重启</span></span><br><span class="line">supervisorctl update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 载入最新的配置文件, 停止原有的进程并按照新的配置启动</span></span><br><span class="line">supervisorctl reload</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>/etc/supervisord.conf 说明</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[unix_http_server]</span><br><span class="line">file=/var/run/supervisor/supervisor.sock   ; socket 文件路径, supervisorctl 用 XML_RPC 和 supervisord 通信就是通过它进行的</span><br><span class="line">;chmod=0700                                ; default 0700, socket 文件权限</span><br><span class="line">;chown=nobody:nogroup                      ; socket 文件属组</span><br><span class="line"></span><br><span class="line">[supervisord]</span><br><span class="line">logfile=/var/<span class="built_in">log</span>/supervisor/supervisord.log  ; supervisord 主进程的日志路径</span><br><span class="line">;directory=/tmp              ; default is not to <span class="built_in">cd</span> during start, 当 supervisord 作为守护进程运行的时候, 启动 supervisord 进程之前, 会先切换到这个目录</span><br><span class="line">;nocleanup=<span class="literal">true</span>              ; default <span class="literal">false</span>, 在 supervisord 进程启动的时候, 把以前子进程产生的日志文件 (路径为 AUTO  的情况下) 清除掉. 如果想要看历史日志, 可以设置为 <span class="literal">true</span></span><br><span class="line">;childlogdir=/tmp            ; default <span class="variable">$TMP</span>, 当子进程日志路径为 AUTO 的时候, 子进程日志文件的存放路径</span><br><span class="line"></span><br><span class="line">;[program:theprogramname]      ; 管理的子进程, <span class="string">":"</span> 后面的是名字</span><br><span class="line">;<span class="built_in">command</span>=/bin/cat              ; the program (relative uses PATH, can take args)</span><br><span class="line">;process_name=%(program_name)s ; default %(program_name)s, 进程名 - 如果 numprocs 参数为 1 的话, 就不用管这个参数</span><br><span class="line">;numprocs=1                    ; default 1, 启动进程的数量</span><br><span class="line">;directory=/tmp                ; def no cwd, 进程运行前, 会先切换到这个目录</span><br><span class="line">;<span class="built_in">umask</span>=022                     ; <span class="built_in">umask</span> <span class="keyword">for</span> process (default None)</span><br><span class="line">;priority=999                  ; default 999, 子进程启动关闭优先级, 优先级低的, 最先启动, 关闭的时候最后关闭</span><br><span class="line">;autostart=<span class="literal">true</span>                ; default <span class="literal">true</span>, 子进程将在 supervisord 启动后被自动启动</span><br><span class="line">;autorestart=<span class="literal">true</span>              ; default <span class="literal">true</span>, 子进程挂掉后自动重启的情况, 有三种情况：<span class="literal">false</span> | unexpected | <span class="literal">true</span></span><br><span class="line">                                <span class="literal">false</span> 无论什么情况下都不会被重新启动;  </span><br><span class="line">                                unexpected 只有当进程的退出码不在下面的 exitcodes 里面定义的退出码的时候才会被自动重启; </span><br><span class="line">                                <span class="literal">true</span> 只要子进程挂掉, 将会被无条件的重启</span><br><span class="line">;startsecs=10                  ; default 1, 子进程启动多少秒之后, 此时状态如果是 running, 则认为启动成功</span><br><span class="line">;startretries=3                ; default 3, 当进程启动失败后, 最大尝试启动的次数, 当超过 3 次后, supervisor 将把此进程的状态置为 FAIL</span><br><span class="line">;exitcodes=0,2                 ; default 0,2, 和上面的的 autorestart=unexpected 对应</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Other</category>
      </categories>
      <tags>
        <tag>supervisord</tag>
      </tags>
  </entry>
  <entry>
    <title>Laravel 系列 (一)</title>
    <url>/Laravel/laravel-series-1.html</url>
    <content><![CDATA[<div class="note danger"><p>助手函数</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">php artisan make:provider HelperServiceProvider</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># config/app.php</span></span><br><span class="line">...</span><br><span class="line">App\Providers\HelperServiceProvider::class,</span><br><span class="line">App\Providers\AppServiceProvider::class,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelperServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register services.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bootstrap services.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (glob(app_path(<span class="string">'Helpers'</span>) . <span class="string">'/*.php'</span>) <span class="keyword">as</span> $helperFile) &#123;</span><br><span class="line">            <span class="keyword">require_once</span> $helperFile;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p><code>nwidart/laravel-modules</code> - 模块化管理</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">composer require <span class="string">"nwidart/laravel-modules:^6.0"</span></span><br><span class="line"></span><br><span class="line">php artisan vendor:publish --provider=<span class="string">"Nwidart\Modules\LaravelModulesServiceProvider"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># config/modules.php 配置</span></span><br><span class="line"><span class="comment"># 1.修改命名空间 (Modules =&gt; App\Modules)</span></span><br><span class="line"><span class="string">'namespace'</span> =&gt; <span class="string">'App\Modules'</span></span><br><span class="line"><span class="string">'modules'</span> =&gt; base_path(<span class="string">'app/Modules'</span>),</span><br><span class="line"><span class="comment"># 2.重命名 resource (Transformers =&gt; Http/Resources)</span></span><br><span class="line"><span class="string">'resource'</span> =&gt; [<span class="string">'path'</span> =&gt; <span class="string">'Http/Resources'</span>, <span class="string">'generate'</span> =&gt; <span class="literal">false</span>]</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p><code>laravel/passport</code> </p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Traits</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Error</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">TypeError</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DateTimeImmutable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">ResponseInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Passport</span>\<span class="title">Passport</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Laminas</span>\<span class="title">Diactoros</span>\<span class="title">Response</span> <span class="title">as</span> <span class="title">Psr7Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Passport</span>\<span class="title">Bridge</span>\&#123;</span><br><span class="line">    <span class="title">Client</span>,</span><br><span class="line">    <span class="title">AccessToken</span>,</span><br><span class="line">    <span class="title">AccessTokenRepository</span>,</span><br><span class="line">    <span class="title">RefreshTokenRepository</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">use</span> <span class="title">League</span>\<span class="title">OAuth2</span>\<span class="title">Server</span>\<span class="title">CryptKey</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">League</span>\<span class="title">OAuth2</span>\<span class="title">Server</span>\<span class="title">Entities</span>\&#123;<span class="title">AccessTokenEntityInterface</span>, <span class="title">RefreshTokenEntityInterface</span>&#125;;</span><br><span class="line"><span class="keyword">use</span> <span class="title">League</span>\<span class="title">OAuth2</span>\<span class="title">Server</span>\<span class="title">ResponseTypes</span>\&#123;<span class="title">ResponseTypeInterface</span>, <span class="title">AbstractResponseType</span>, <span class="title">BearerTokenResponse</span>&#125;;</span><br><span class="line"><span class="keyword">use</span> <span class="title">League</span>\<span class="title">OAuth2</span>\<span class="title">Server</span>\<span class="title">Exception</span>\<span class="title">UniqueTokenIdentifierConstraintViolationException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">League</span>\<span class="title">OAuth2</span>\<span class="title">Server</span>\<span class="title">Exception</span>\<span class="title">OAuthServerException</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> PassportToken</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> CryptKey</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $privateKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $userIdentifier</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int    $clientId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool   $ouput</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|null|ResponseInterface</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> OAuthServerException|UniqueTokenIdentifierConstraintViolationException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getBearerTokenByUser</span><span class="params">(string $userIdentifier, int $clientId = <span class="number">0</span>, bool $ouput = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;makeCryptKey(<span class="string">'private'</span>);</span><br><span class="line">        $accessToken = <span class="keyword">$this</span>-&gt;issueAccessToken($userIdentifier, $clientId);</span><br><span class="line">        $refreshToken = <span class="keyword">$this</span>-&gt;issueRefreshToken($accessToken);</span><br><span class="line"></span><br><span class="line">        $tokenResponse = <span class="keyword">$this</span>-&gt;getResponse();</span><br><span class="line">        $tokenResponse-&gt;setAccessToken($accessToken);</span><br><span class="line">        $tokenResponse-&gt;setRefreshToken($refreshToken);</span><br><span class="line">        $response = $tokenResponse-&gt;generateHttpResponse(<span class="keyword">new</span> Psr7Response());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!$ouput) &#123;</span><br><span class="line">            <span class="keyword">return</span> json_decode($response-&gt;getBody()-&gt;__toString(), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Issue an access token.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $userIdentifier</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $clientId</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> AccessTokenEntityInterface</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> OAuthServerException|UniqueTokenIdentifierConstraintViolationException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">issueAccessToken</span><span class="params">(string $userIdentifier, string $clientId)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">		<span class="comment">// 这里 $clientId 必须是 oauth_clients 表存在的记录, 不然生成的 access_token 无法通过校验</span></span><br><span class="line">		<span class="comment">// 参考源码 vendor\laravel\passport\src\Bridge\ClientRepository.php - validateClient</span></span><br><span class="line">        $client = <span class="keyword">new</span> Client($clientId, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        $accessToken = <span class="keyword">new</span> AccessToken($userIdentifier, [], $client);</span><br><span class="line">        $accessToken-&gt;setExpiryDateTime((<span class="keyword">new</span> DateTimeImmutable())-&gt;add(Passport::tokensExpireIn()));</span><br><span class="line">        $accessToken-&gt;setPrivateKey(<span class="keyword">$this</span>-&gt;privateKey);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> AccessTokenRepository $accessTokenRepository */</span></span><br><span class="line">        $accessTokenRepository = app(AccessTokenRepository::class);</span><br><span class="line"></span><br><span class="line">        $maxGenerationAttempts = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">while</span> ($maxGenerationAttempts-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            $accessToken-&gt;setIdentifier(<span class="keyword">$this</span>-&gt;generateUniqueIdentifier());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                $accessTokenRepository-&gt;persistNewAccessToken($accessToken);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> $accessToken;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UniqueTokenIdentifierConstraintViolationException $e) &#123;</span><br><span class="line">                <span class="keyword">if</span> ($maxGenerationAttempts === <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> $e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Issue an refresh token.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> AccessTokenEntityInterface $accessToken</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> RefreshTokenEntityInterface</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> OAuthServerException|UniqueTokenIdentifierConstraintViolationException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">issueRefreshToken</span><span class="params">(AccessTokenEntityInterface $accessToken)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> RefreshTokenRepository $refreshTokenRepository */</span></span><br><span class="line">        $refreshTokenRepository = app(RefreshTokenRepository::class);</span><br><span class="line">        $refreshToken = $refreshTokenRepository-&gt;getNewRefreshToken();</span><br><span class="line">        $refreshToken-&gt;setExpiryDateTime((<span class="keyword">new</span> DateTimeImmutable())-&gt;add(Passport::refreshTokensExpireIn()));</span><br><span class="line">        $refreshToken-&gt;setAccessToken($accessToken);</span><br><span class="line"></span><br><span class="line">        $maxGenerationAttempts = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">while</span> ($maxGenerationAttempts-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            $refreshToken-&gt;setIdentifier(<span class="keyword">$this</span>-&gt;generateUniqueIdentifier());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                $refreshTokenRepository-&gt;persistNewRefreshToken($refreshToken);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> $refreshToken;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UniqueTokenIdentifierConstraintViolationException $e) &#123;</span><br><span class="line">                <span class="keyword">if</span> ($maxGenerationAttempts === <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> $e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the token type that grants will return in the HTTP response.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ResponseTypeInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getResponse</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $responseType = <span class="keyword">new</span> BearerTokenResponse();</span><br><span class="line">        <span class="keyword">if</span> ($responseType <span class="keyword">instanceof</span> AbstractResponseType) &#123;</span><br><span class="line">            $responseType-&gt;setPrivateKey(<span class="keyword">$this</span>-&gt;privateKey);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $responseType-&gt;setEncryptionKey(app(<span class="string">'encrypter'</span>)-&gt;getKey());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $responseType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a CryptKey instance without permissions check.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $type</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">makeCryptKey</span><span class="params">($type)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $key = str_replace(<span class="string">'\\n'</span>, <span class="string">"\n"</span>, config(<span class="string">'passport.'</span> . $type . <span class="string">'_key'</span>));</span><br><span class="line">        <span class="keyword">if</span> (!$key) &#123;</span><br><span class="line">            $key = <span class="string">'file://'</span> . Passport::keyPath(<span class="string">'oauth-'</span> . $type . <span class="string">'.key'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;privateKey = <span class="keyword">new</span> CryptKey($key, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Generate a new unique identifier.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $length</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> OAuthServerException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">generateUniqueIdentifier</span><span class="params">($length = <span class="number">40</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> \bin2hex(\random_bytes($length));</span><br><span class="line">            <span class="comment">// @codeCoverageIgnoreStart</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (TypeError $e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> OAuthServerException::serverError(<span class="string">'An unexpected error has occurred'</span>, $e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Error $e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> OAuthServerException::serverError(<span class="string">'An unexpected error has occurred'</span>, $e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">            <span class="comment">// If you get this message, the CSPRNG failed hard.</span></span><br><span class="line">            <span class="keyword">throw</span> OAuthServerException::serverError(<span class="string">'Could not generate a random string'</span>, $e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// @codeCoverageIgnoreEnd</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Laravel</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>laravel</tag>
      </tags>
  </entry>
  <entry>
    <title>Laravel 相关问题</title>
    <url>/Laravel/laravel-questions.html</url>
    <content><![CDATA[<div class="note danger"><p>第三方包 <code>laravel-ide-helper</code> 执行 <code>ide-helper:modles</code> 报错</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Exception: Unknown database <span class="built_in">type</span> geometry requested, Doctrine\DBAL\Platforms\MySQL57Platform may not support it.</span><br><span class="line"><span class="comment"># 原因: 迁移文件包含 geometry 字段类型</span></span><br><span class="line"><span class="comment"># 解决:</span></span><br><span class="line">vendor/barryvdh/laravel-ide-helper/src/Console/ModelsCommand.php - line 155</span><br><span class="line"><span class="variable">$schema</span> = \Illuminate\Support\Facades\Schema::getConnection()-&gt;getDoctrineSchemaManager();</span><br><span class="line"><span class="variable">$schema</span>-&gt;getDatabasePlatform()-&gt;registerDoctrineTypeMapping(<span class="string">'geometry'</span>, <span class="string">'string'</span>);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Laravel</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>laravel</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo 自定义文章排序规则</title>
    <url>/Hexo/hexo-custom-post-collation.html</url>
    <content><![CDATA[<div class="note danger"><p>按文章更新时间排序, 这里需要注意的是排序值的KEY不能为updated, 要不然就是使用文章更新时间来排序了</p></div>
<ol>
<li><p>配置 <code>next.yml</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">post_meta:</span></span><br><span class="line"><span class="attr">  updated_at:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  updated_diff:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑 <code>themes/next/layout/_macro/post.swig</code>, 在 <code>&lt;span class=&quot;post-time&quot;&gt;&lt;/span&gt;</code> 后添加以下代码</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">if</span></span> post.updateTime %&#125;</span></span><br><span class="line">    &lt;span class="post-meta-divider"&gt;|&lt;/span&gt;</span><br><span class="line">    &lt;span class="post-meta-item-icon"&gt;</span><br><span class="line">        &lt;i class="fa fa-calendar-check-o"&gt;&lt;/i&gt;</span><br><span class="line">    &lt;/span&gt;</span><br><span class="line">    &lt;span class="post-meta-item-text"&gt;<span class="template-variable">&#123;&#123; __('post.modified') &#125;&#125;</span>&amp;#58;&lt;/span&gt;</span><br><span class="line">    &lt;time title="<span class="template-variable">&#123;&#123; __('post.modified') &#125;&#125;</span>" itemprop="dateModified" datetime="<span class="template-variable">&#123;&#123; moment(post.updateTime).format() &#125;&#125;</span>"&gt;<span class="template-variable">&#123;&#123; <span class="name">date</span><span class="params">(post.updateTime, config.date_format)</span> &#125;&#125;</span>&lt;/time&gt;</span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">endif</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>hexo</code> 文件夹下的 <code>node_modules/hexo-generator-index/lib/generator.js</code>, 在生成文章之前进行文章 <code>updateTime</code> 值排序 </p>
 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pagination = <span class="built_in">require</span>(<span class="string">'hexo-pagination'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">locals</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> config = <span class="keyword">this</span>.config;</span><br><span class="line">    <span class="comment">/*******START*******/</span></span><br><span class="line">    <span class="comment">//var posts = locals.posts.sort(config.index_generator.order_by);</span></span><br><span class="line">    <span class="keyword">var</span> paginationDir = config.pagination_dir || <span class="string">'page'</span>;</span><br><span class="line">    <span class="keyword">var</span> path = config.index_generator.path || <span class="string">''</span>;  </span><br><span class="line">    <span class="keyword">var</span> posts = locals.posts;</span><br><span class="line">    posts.data = posts.data.sort(<span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> aUpdateTime = a.updateTime ? (<span class="keyword">new</span> <span class="built_in">Date</span>(a.updateTime)).getTime() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> bUpdateTime = b.updateTime ? (<span class="keyword">new</span> <span class="built_in">Date</span>(b.updateTime)).getTime() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (aUpdateTime &amp;&amp; bUpdateTime) &#123;</span><br><span class="line">        <span class="comment">// updateTime 一样, 则按照文章日期降序, 否则按照 updateTime 降序</span></span><br><span class="line">          <span class="keyword">return</span> aUpdateTime === bUpdateTime ? b.date - a.date : bUpdateTime - aUpdateTime;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 更新时间不能大于发布时间</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (aUpdateTime &amp;&amp; !bUpdateTime) &#123;</span><br><span class="line">          <span class="keyword">return</span> aUpdateTime &gt; b.date ? <span class="number">-1</span> : <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!aUpdateTime &amp;&amp; bUpdateTime) &#123;</span><br><span class="line">          <span class="keyword">return</span> bUpdateTime &gt; a.date ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 按照文章日期降序</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> b.date - a.date;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">/*******END*******/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pagination(path, posts, &#123;</span><br><span class="line">        perPage: config.index_generator.per_page,</span><br><span class="line">        layout: [<span class="string">'index'</span>, <span class="string">'archive'</span>],</span><br><span class="line">        format: paginationDir + <span class="string">'/%d/'</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">        __index: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"># 调用方式</span><br><span class="line">---</span><br><span class="line">title: Hexo 自定义文章排序规则</span><br><span class="line">date: <span class="number">2018</span><span class="number">-04</span><span class="number">-24</span> <span class="number">14</span>:<span class="number">18</span>:<span class="number">20</span></span><br><span class="line">updateTime: <span class="number">2018</span><span class="number">-04</span><span class="number">-27</span> <span class="number">09</span>:<span class="number">46</span>:<span class="number">00</span></span><br><span class="line">categories: Hexo</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
</li>
<li><p>清除 <code>hexo</code> 缓存</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Composer 相关</title>
    <url>/Composer/composer-about.html</url>
    <content><![CDATA[<div class="note danger"><p>版本号说明</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 版本格式：主版本号.次版本号.修订号,版本号递增规则如下:</span></span><br><span class="line">    <span class="comment"># 主版本号：当你做了不兼容的 API 修改</span></span><br><span class="line">    <span class="comment"># 次版本号：当你做了向下兼容的功能性新增</span></span><br><span class="line">    <span class="comment"># 修订号：当你做了向下兼容的问题修正</span></span><br><span class="line">    <span class="comment"># 先行版本号及版本编译元数据可以加到"主版本号.次版本号.修订号"的后面,作为延伸</span></span><br><span class="line"></span><br><span class="line">~ 和 ^ 的意思很接近,在 x.y 的情况下是一样的都是代表 x.y &lt;= 版本号 &lt; (x+1).0,但是在版本号是 x.y.z 的情况下有区别</span><br><span class="line"></span><br><span class="line"><span class="comment"># ~ 表示版本号只能改变最末尾那段(如果是 ~x.y 末尾就是 y,如果是 ~x.y.z 末尾就是 z)</span></span><br><span class="line">~1.2.3 代表 1.2.3 &lt;= 版本号 &lt; 1.3.0</span><br><span class="line">~1.2   代表  1.2 &lt;= 版本号 &lt; 2.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ^ 表示除了大版本号以外,小版本号和补丁版本号都可以变</span></span><br><span class="line">^1.2.3 代表 1.2.3 &lt;= 版本号 &lt; 2.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 特殊情况 0 开头的版本号：</span></span><br><span class="line">^0.3.0 等于 0.3.0 &lt;= 版本号 &lt;0.4.0  注意：不是 &lt; 1.0.0</span><br><span class="line"><span class="comment"># 因为：semantic versioning 的规定是,大版本号以 0 开头表示这是一个非稳定版本(unstable),如果处于非稳定状态,小版本号是允许不向下兼容的</span></span><br><span class="line"><span class="comment"># 所以如果你要指定 0 开头的库那一定要注意：</span></span><br><span class="line">危险写法：~0.1 等于 0.1.0 &lt;= 版本号 &lt; 1.0.0</span><br><span class="line">保险写法：^0.1 等于 0.1.0 &lt;= 版本号 &lt; 0.2.0</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Composer</category>
      </categories>
      <tags>
        <tag>composer</tag>
      </tags>
  </entry>
  <entry>
    <title>Composer 扩展包开发</title>
    <url>/Composer/composer-package-development.html</url>
    <content><![CDATA[<div class="note danger"><p>Composer 扩展包开发</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 Package Builder 包结构创建工具</span></span><br><span class="line">composer global require overtrue/package-builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建目录结构 - 包名 sevming/helper</span></span><br><span class="line">package-builder build packages/helper</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置本地安装目录</span></span><br><span class="line">composer config repositories.helper path packages/helper</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装扩展包</span></span><br><span class="line">composer require sevming/helper:dev-master</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Composer</category>
      </categories>
      <tags>
        <tag>composer</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 相关命令</title>
    <url>/MySQL/mysql-commands.html</url>
    <content><![CDATA[<div class="note danger"><p>查看数据库大小</p></div>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">#进去指定 schema 数据库(存放了其他的数据库的信息)</span><br><span class="line"><span class="keyword">use</span> information_schema;	</span><br><span class="line">#查询所有数据的大小 </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(<span class="keyword">ROUND</span>(<span class="keyword">SUM</span>(DATA_LENGTH/<span class="number">1024</span>/<span class="number">1024</span>), <span class="number">2</span>), <span class="string">'MB'</span>) <span class="keyword">AS</span> <span class="keyword">data</span> <span class="keyword">FROM</span> <span class="keyword">TABLES</span>;</span><br><span class="line">#查看指定数据库实例的大小, 比如说数据库 test</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(<span class="keyword">ROUND</span>(<span class="keyword">SUM</span>(DATA_LENGTH/<span class="number">1024</span>/<span class="number">1024</span>), <span class="number">2</span>), <span class="string">'MB'</span>) <span class="keyword">AS</span> <span class="keyword">data</span> <span class="keyword">FROM</span> <span class="keyword">TABLES</span> <span class="keyword">WHERE</span> table_schema=<span class="string">'test'</span>;</span><br><span class="line">#查看指定数据库的表的大小, 比如说数据库 test 中的 user 表	</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(<span class="keyword">ROUND</span>(<span class="keyword">SUM</span>(DATA_LENGTH/<span class="number">1024</span>/<span class="number">1024</span>), <span class="number">2</span>), <span class="string">'MB'</span>) <span class="keyword">AS</span> <span class="keyword">data</span> <span class="keyword">FROM</span> <span class="keyword">TABLES</span> <span class="keyword">WHERE</span> table_schema=<span class="string">'test'</span> <span class="keyword">AND</span> table_name=<span class="string">'user'</span>;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>查看表碎片</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SHOW TABLE STATUS from yiyuansha like <span class="string">'yys_shangpin'</span>\G</span><br><span class="line">Data_free  字段大于 0, 就表示有碎片</span><br><span class="line">(1)InnoDB 整理碎片, 使用 ALTER TABLE table_name ENGINE=INNODB; 会删除旧表, 并		重新导入数据, 重新建立索引</span><br><span class="line">(2)MyISAM 整理碎片, 使用 OPTIMIZE TABLE table_name;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>binlog</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysqlbinlog -vv --base64-output=decode-rows --start-datetime=<span class="string">"2020-03-24 18:40:00"</span> --stop-datetime=<span class="string">"2020-03-24  19:00:00"</span> <span class="string">"D:\mysql-bin.000536"</span> | grep -i <span class="string">"keyword"</span> -A 10 -B 10 &gt; <span class="string">"D:\test.sql"</span></span><br><span class="line"></span><br><span class="line">grep命令常用参数说明</span><br><span class="line">参数	说明</span><br><span class="line">-A	除了显示符合条件的那一行之外，并显示该列之后的指定行的内容内容。</span><br><span class="line">-B	除了显示符合条件的那一行之外，并显示该列之前的指定行的内容内容。</span><br><span class="line">-c	计算符合结果的行数。</span><br><span class="line">-i	忽略字符大小写</span><br><span class="line">-v	反向查找</span><br><span class="line">-e	按指定字符串查找</span><br><span class="line">-E	按指定字符串指定的正则查找</span><br><span class="line">-n	在显示符合条件的那一行前，标识出该行的行数标号。</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>MySQL 5.7 数据库用户授权</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.使用 root 管理员登陆 mysql</span></span><br><span class="line"><span class="comment"># 2.创建数据库</span></span><br><span class="line">CREATE DATABASE <span class="built_in">test</span>;</span><br><span class="line"><span class="comment"># 3.创建新用户 ( % 所有情况都能访问, localhost 本机才能访问, 111.222.33.44 指定IP 才能访问)</span></span><br><span class="line">CREATE USER <span class="string">'用户名'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'密码'</span>;</span><br><span class="line"><span class="comment"># 4.给该用户添加权限</span></span><br><span class="line">GRANT ALL PRIVILEGES on 数据库名.* to <span class="string">'用户名'</span>@<span class="string">'%'</span>;</span><br><span class="line"><span class="comment"># 5.删除用户</span></span><br><span class="line">DELETE FROM mysql.user WHERE User=<span class="string">'用户名'</span>;</span><br><span class="line"><span class="comment"># 6.刷新权限</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker 相关</title>
    <url>/Docker/docker-abount.html</url>
    <content><![CDATA[<div class="note danger"><p>mattrayner/lamp 配置和安装 redis 扩展 (参考 <a href="/Docker/docker-install.html">Docker 安装</a> 的目录挂载)</p></div>
<h5 id="新建-Dockerfile"><a href="#新建-Dockerfile" class="headerlink" title="新建 Dockerfile"></a>新建 <code>Dockerfile</code></h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM mattrayner/lamp:latest-1804</span><br><span class="line">RUN add-apt-repository -y ppa:ondrej/php &amp;&amp; \</span><br><span class="line">  apt-get update &amp;&amp; \</span><br><span class="line">  apt-get -y upgrade &amp;&amp; \</span><br><span class="line">  apt-get -y install php-redis</span><br></pre></td></tr></table></figure>
<h5 id="生成镜像"><a href="#生成镜像" class="headerlink" title="生成镜像"></a>生成镜像</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t sevming/lamp:1.1 .</span><br></pre></td></tr></table></figure>
<h5 id="宿主机新建-mysql、app-文件夹"><a href="#宿主机新建-mysql、app-文件夹" class="headerlink" title="宿主机新建 mysql、app 文件夹"></a>宿主机新建 <code>mysql</code>、<code>app</code> 文件夹</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir /d/docker/mysql</span><br><span class="line">mkdir /d/docker/app</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="新建-docker-compose-yml"><a href="#新建-docker-compose-yml" class="headerlink" title="新建 docker-compose.yml"></a>新建 <code>docker-compose.yml</code></h5><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  lamp:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">sevming/lamp:1.1</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">lamp</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">3306</span><span class="string">:3306</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/mysql:/var/lib/mysql</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/app:/app</span></span><br><span class="line"><span class="attr">  redis:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/redis/data:/data</span></span><br><span class="line"><span class="attr">    command:</span></span><br><span class="line">      <span class="string">redis-server</span> <span class="bullet">--appendonly</span> <span class="literal">yes</span> <span class="bullet">--requirepass</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>
<h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<hr>
<div class="note danger"><p>Docker CentOS</p></div>
<h5 id="新建-Dockerfile-1"><a href="#新建-Dockerfile-1" class="headerlink" title="新建 Dockerfile"></a>新建 <code>Dockerfile</code></h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM centos:7</span><br><span class="line">ENV container docker</span><br><span class="line">RUN (<span class="built_in">cd</span> /lib/systemd/system/sysinit.target.wants/; <span class="keyword">for</span> i <span class="keyword">in</span> *; <span class="keyword">do</span> [ <span class="variable">$i</span> == \</span><br><span class="line">systemd-tmpfiles-setup.service ] || rm -f <span class="variable">$i</span>; <span class="keyword">done</span>); \</span><br><span class="line">rm -f /lib/systemd/system/multi-user.target.wants/*;\</span><br><span class="line">rm -f /etc/systemd/system/*.wants/*;\</span><br><span class="line">rm -f /lib/systemd/system/<span class="built_in">local</span>-fs.target.wants/*; \</span><br><span class="line">rm -f /lib/systemd/system/sockets.target.wants/*udev*; \</span><br><span class="line">rm -f /lib/systemd/system/sockets.target.wants/*initctl*; \</span><br><span class="line">rm -f /lib/systemd/system/basic.target.wants/*;\</span><br><span class="line">rm -f /lib/systemd/system/anaconda.target.wants/*;</span><br><span class="line">VOLUME [ <span class="string">"/sys/fs/cgroup"</span> ]</span><br><span class="line">CMD [<span class="string">"/usr/sbin/init"</span>]</span><br></pre></td></tr></table></figure>
<h5 id="生成镜像镜像"><a href="#生成镜像镜像" class="headerlink" title="生成镜像镜像"></a>生成镜像镜像</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build --rm -t sevming/centos7:0.1 .</span><br></pre></td></tr></table></figure>
<h5 id="启用-systemd-容器"><a href="#启用-systemd-容器" class="headerlink" title="启用 systemd 容器"></a>启用 systemd 容器</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -it -v /sys/fs/cgroup:/sys/fs/cgroup:ro sevming/centos7:0.1</span><br></pre></td></tr></table></figure>
<h5 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 问题：</span></span><br><span class="line">Failed to mount tmpfs at /run: Operation not permitted</span><br><span class="line">Failed to mount cgroup at /sys/fs/cgroup/systemd: Operation not permitted</span><br><span class="line">[!!!!!!] Failed to mount API filesystems, freezing.</span><br><span class="line"><span class="comment"># 解决方法：</span></span><br><span class="line">docker run -it -d --name=centos7 --privileged=<span class="literal">true</span> -p 80:80 -v /sys/fs/cgroup:/sys/fs/cgroup:ro sevming/centos7:0.1</span><br><span class="line">docker <span class="built_in">exec</span> -it centos7 /bin/bash</span><br><span class="line">systemctl status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题：</span></span><br><span class="line">Error response from daemon: cgroups: cannot find cgroup mount destination: unknown.</span><br><span class="line"><span class="comment"># 解决方法：</span></span><br><span class="line"><span class="comment"># 1.进入虚拟机</span></span><br><span class="line">docker-machine ssh</span><br><span class="line"><span class="comment"># 2.创建 systemd</span></span><br><span class="line">sudo mkdir /sys/fs/cgroup/systemd</span><br><span class="line"><span class="comment"># 3.挂载一棵cgroup树,但不关联任何subsystem</span></span><br><span class="line">sudo mount -t cgroup -o none,name=systemd cgroup /sys/fs/cgroup/systemd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 若提示 mkdir: can't create directory '/sys/fs/cgroup/systemd': Read-only file system</span></span><br><span class="line"><span class="comment"># 进入不能创建目录的外层目录</span></span><br><span class="line"><span class="built_in">cd</span> /sys/fs</span><br><span class="line"><span class="comment"># 执行命令</span></span><br><span class="line">mount -o remount,rw cgroup/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题 (docker-compose 启动 mysql 错误)：</span></span><br><span class="line">[ERROR] Could not open file <span class="string">'/var/log/mysql/error.log'</span> <span class="keyword">for</span> error logging: Permission denied</span><br><span class="line"><span class="comment"># 解决方案一 (宿主机创建 mysql  用户和组)：</span></span><br><span class="line">    <span class="comment"># 添加 mysql 组</span></span><br><span class="line">    groupadd mysql</span><br><span class="line">    <span class="comment"># 创建 mysql 用户并加入 mysql 组</span></span><br><span class="line">    useradd mysql -g mysql</span><br><span class="line">    <span class="comment"># 禁止 mysql 用户登录</span></span><br><span class="line">    vim /etc/passwd</span><br><span class="line">    mysql:x:1005:1005::/home/mysql:/sbin/nologin</span><br><span class="line"><span class="comment"># 解决方案二 (配置 docker-compose.yml)：</span></span><br><span class="line">    services:</span><br><span class="line">	mysql:</span><br><span class="line">	  <span class="comment"># 指定mysql容器启动后默认执行的命令</span></span><br><span class="line">		<span class="built_in">command</span>:</span><br><span class="line">          - <span class="string">"--default-authentication-plugin=mysql_native_password"</span></span><br><span class="line">		<span class="comment"># 启动容器后需要执行的命令</span></span><br><span class="line">        entrypoint: bash -c <span class="string">"chown -R mysql:mysql /var/log/mysql &amp;&amp; exec /entrypoint.sh mysqld"</span></span><br></pre></td></tr></table></figure>
<hr>
<div class="note danger"><p>Docker Node + Git 运行并部署 Hexo 项目</p></div>
<h5 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM node:12</span><br><span class="line"></span><br><span class="line">RUN mv /etc/apt/sources.list /etc/apt/sources.list.bak \</span><br><span class="line">	&amp;&amp; <span class="built_in">echo</span> <span class="string">'deb http://mirrors.aliyun.com/debian/ buster main non-free contrib'</span> &gt; /etc/apt/sources.list \</span><br><span class="line">	&amp;&amp; <span class="built_in">echo</span> <span class="string">'deb http://mirrors.aliyun.com/debian/ buster-updates main non-free contrib'</span> &gt;&gt; /etc/apt/sources.list \</span><br><span class="line">	&amp;&amp; <span class="built_in">echo</span> <span class="string">'deb http://mirrors.aliyun.com/debian/ buster-backports main non-free contrib'</span> &gt;&gt; /etc/apt/sources.list \</span><br><span class="line">	&amp;&amp; <span class="built_in">echo</span> <span class="string">'deb http://mirrors.aliyun.com/debian-security buster/updates main'</span> &gt;&gt; /etc/apt/sources.list \</span><br><span class="line">	&amp;&amp; <span class="built_in">echo</span> <span class="string">'deb-src http://mirrors.aliyun.com/debian/ buster main non-free contrib'</span> &gt;&gt; /etc/apt/sources.list \</span><br><span class="line">	&amp;&amp; <span class="built_in">echo</span> <span class="string">'deb-src http://mirrors.aliyun.com/debian/ buster-updates main non-free contrib'</span> &gt;&gt; /etc/apt/sources.list \</span><br><span class="line">	&amp;&amp; <span class="built_in">echo</span> <span class="string">'deb-src http://mirrors.aliyun.com/debian/ buster-backports main non-free contrib'</span> &gt;&gt; /etc/apt/sources.list \</span><br><span class="line">	&amp;&amp; <span class="built_in">echo</span> <span class="string">'deb-src http://mirrors.aliyun.com/debian-security buster/updates main'</span> &gt;&gt; /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line">RUN apt update &amp;&amp; apt install -y wget &amp;&amp; apt install -y vim &amp;&amp; apt install -y iputils-ping &amp;&amp; apt install -y git</span><br></pre></td></tr></table></figure>
<h5 id="生成镜像-1"><a href="#生成镜像-1" class="headerlink" title="生成镜像"></a>生成镜像</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t sevming/node12:0.1 .</span><br></pre></td></tr></table></figure>
<h5 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 运行容器</span></span><br><span class="line">docker run -itd --name node -p 4000:4000 -v /Users/sev/project/docker:/home/node sevming/node12:0.1</span><br><span class="line"><span class="comment"># 访问容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it node /bin/bash</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>centos</tag>
        <tag>mattrayner</tag>
      </tags>
  </entry>
  <entry>
    <title>GitHub</title>
    <url>/Other/github.html</url>
    <content><![CDATA[<div class="note danger"><p>GitHub 搜索技巧</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 按照项目名/仓库名搜索(大小写不敏感)</span></span><br><span class="line"><span class="keyword">in</span>:name xxx</span><br><span class="line"><span class="comment"># 按照README搜索(大小写不敏感)</span></span><br><span class="line"><span class="keyword">in</span>:readme xxx</span><br><span class="line"><span class="comment"># 按照description搜索(大小写不敏感)</span></span><br><span class="line"><span class="keyword">in</span>:description xxx</span><br><span class="line"><span class="comment"># stars数大于xxx</span></span><br><span class="line">stars:&gt;xxx</span><br><span class="line"><span class="comment"># forks数大于xxx</span></span><br><span class="line">forks:&gt;xxx</span><br><span class="line"><span class="comment"># 编程语言为xxx</span></span><br><span class="line">language:xxx</span><br><span class="line"><span class="comment"># 最新更新时间晚于YYYY-MM-DD</span></span><br><span class="line">pushed:&gt;YYYY-MM-DD</span><br><span class="line"><span class="comment"># 例子：</span></span><br><span class="line"><span class="keyword">in</span>:name symfony stars:&gt;500 forks:&gt;100</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>GitHub 访问慢</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打开 https://ipaddress.com/</span></span><br><span class="line"><span class="comment"># 搜索 github.global.ssl.fastly.net、github.com、avatars0. githubusercontent.com 的IP, 并添加至 hosts</span></span><br><span class="line"><span class="comment">#GitHub</span></span><br><span class="line">199.232.69.194 github.global.ssl.fastly.net</span><br><span class="line">140.82.114.4 github.com</span><br><span class="line">185.199.108.153 assets-cdn.github.com</span><br><span class="line">185.199.109.153 assets-cdn.github.com</span><br><span class="line">185.199.110.153 assets-cdn.github.com</span><br><span class="line">185.199.111.153 assets-cdn.github.com</span><br><span class="line">199.232.68.133 avatars0.githubusercontent.com</span><br><span class="line">199.232.68.133 avatars1.githubusercontent.com</span><br><span class="line">199.232.68.133 avatars2.githubusercontent.com</span><br><span class="line">199.232.68.133 avatars3.githubusercontent.com</span><br><span class="line">199.232.68.133 avatars4.githubusercontent.com</span><br><span class="line">199.232.68.133 raw.githubusercontent.com</span><br><span class="line">199.232.96.133 camo.githubusercontent.com</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Other</category>
      </categories>
      <tags>
        <tag>github</tag>
      </tags>
  </entry>
  <entry>
    <title>阿里云OSS 视频截帧、媒体管理(提交截图作业)</title>
    <url>/Aliyun/video-snapshot.html</url>
    <content><![CDATA[<div class="note danger"><p>场景：小程序上传视频到阿里云OSS, 并将视频地址及宽高提交给服务端, 服务端通过 OSS 提供的 <a href="https://help.aliyun.com/document_detail/64555.html?spm=a2c4g.11174283.6.1410.7eac7da28NLB6w" target="_blank" rel="noopener">视频截帧</a> 生成封面图片地址</p></div>
<h5 id="问题：Android设备横拍的视频生成的封面图片会被拉伸-而iOS设备则是竖拍的视频所生成的封面图片会被拉伸"><a href="#问题：Android设备横拍的视频生成的封面图片会被拉伸-而iOS设备则是竖拍的视频所生成的封面图片会被拉伸" class="headerlink" title="问题：Android设备横拍的视频生成的封面图片会被拉伸, 而iOS设备则是竖拍的视频所生成的封面图片会被拉伸"></a>问题：Android设备横拍的视频生成的封面图片会被拉伸, 而iOS设备则是竖拍的视频所生成的封面图片会被拉伸</h5><h5 id="解决方案一"><a href="#解决方案一" class="headerlink" title="解决方案一"></a>解决方案一</h5><blockquote><p>&lt;原视频URL&gt;?x-oss-process=video/snapshot,t_1000,f_jpg,w_0,h_0,m_fast,ar_auto - 添加 ar 参数即可<br>参考文档：<a href="https://help.aliyun.com/document_detail/64555.html?spm=a2c4g.11174283.6.809.718b7da2oK1pj3" target="_blank" rel="noopener">https://help.aliyun.com/document_detail/64555.html?spm=a2c4g.11174283.6.809.718b7da2oK1pj3</a></p>
</blockquote>
<h5 id="解决方案二"><a href="#解决方案二" class="headerlink" title="解决方案二"></a>解决方案二</h5><ol>
<li>视频截帧时设置宽高为0, 这样图片不会变形, 但是会被旋转90度, 即Android视频封面全是竖的, iOS视频封面全是横的</li>
<li>使用 <a href="https://help.aliyun.com/document_detail/29232.html?spm=5176.11114354.959322.32.400066ddhdqTKh" target="_blank" rel="noopener">阿里云媒体管理 - 提交截图作业</a>, 开通媒体管理后, 需要给 OSS Bucket 所属的用户添加权限 AliyunMTSFullAccess 管理媒体转码服务(MTS)的权限, <a href="https://github.com/aliyun/openapi-sdk-php/tree/master/src/Mts" target="_blank" rel="noopener">MTS SDK</a>, 可以通过 <a href="https://developer.aliyun.com/sdk" target="_blank" rel="noopener">阿里云SDK平台</a> 查看使用方法<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$accessKey = <span class="string">'xxxx'</span>;</span><br><span class="line">$accessSecret = <span class="string">'yyyy'</span>;</span><br><span class="line">$regionId = <span class="string">'cn-hangzhou'</span>;</span><br><span class="line">$ossBucket = <span class="string">'test'</span>;</span><br><span class="line">$ossLocation = <span class="string">'oss-cn-hangzhou'</span>;</span><br><span class="line"></span><br><span class="line">AlibabaCloud::accessKeyClient($accessKey, $accessSecret)</span><br><span class="line">        -&gt;regionId($regionId)</span><br><span class="line">        -&gt;asDefaultClient();</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $option = [</span><br><span class="line">        <span class="string">'query'</span> =&gt; [</span><br><span class="line">            <span class="string">'Input'</span> =&gt; json_encode([</span><br><span class="line">                <span class="string">'Bucket'</span> =&gt; $ossBucket,</span><br><span class="line">                <span class="string">'Location'</span> =&gt; $ossLocation,</span><br><span class="line">                <span class="string">'Object'</span> =&gt; <span class="string">'1.mp4'</span>,</span><br><span class="line">            ]),</span><br><span class="line">            <span class="string">'SnapshotConfig'</span> =&gt; json_encode([</span><br><span class="line">                <span class="string">'OutputFile'</span> =&gt; [</span><br><span class="line">                    <span class="string">'Bucket'</span> =&gt; $ossBucket,</span><br><span class="line">                    <span class="string">'Location'</span> =&gt; $ossLocation,</span><br><span class="line">                    <span class="string">'Object'</span> =&gt; <span class="string">'1.jpg'</span>,</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">'Time'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">            ])</span><br><span class="line">        ]</span><br><span class="line">    ];</span><br><span class="line">    $result = Mts::v20140618()</span><br><span class="line">        -&gt;submitSnapshotJob($option)</span><br><span class="line">        -&gt;request(); </span><br><span class="line">    <span class="comment">// 若Code已定义,则截图失败</span></span><br><span class="line">    var_dump($result-&gt;has(<span class="string">'SnapshotJob.Code'</span>));</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">exit</span>($e-&gt;getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>Aliyun</category>
      </categories>
      <tags>
        <tag>aliyun</tag>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>composer 配置</title>
    <url>/Composer/composer-configuration.html</url>
    <content><![CDATA[<div class="note danger"><p>配置全局镜像源</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Composer</category>
      </categories>
      <tags>
        <tag>composer</tag>
      </tags>
  </entry>
  <entry>
    <title>开发配置</title>
    <url>/Other/development-config.html</url>
    <content><![CDATA[<div class="note danger"><p>Git 换行符</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 提交检出均不转换</span></span><br><span class="line">git config --global core.autocrlf <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<div class="note danger"><p>.gitattributes - 对个别文件或目录定义不同的合并策略,让 Git 知道怎样比较非文本文件,在你提交或签出前让 Git 过滤内容</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 对任何文件, 文件的行尾自动转换(如果是文本文件, 则在文件入 Git 库时, 行尾自动转换为 LF; 如果已经在入 Git 库中的文件的行尾为 CRLF, 则该文件在入 Git 库时, 不再转换为 LF)</span></span><br><span class="line"><span class="comment"># * text=auto</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对于 .txt 文件, 标记为文本文件, 并进行行尾规范化</span></span><br><span class="line"><span class="comment"># *.txt text</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对于 .jpg 文件, 标记为非文本文件, 不进行任何的行尾转换</span></span><br><span class="line"><span class="comment"># *.jpg -text  </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对于 .vcproj 文件, 标记为文本文件, 在文件入 Git 库时进行规范化, 即行尾转换为 LF, 但是在检出到工作目录时, 行尾自动转换为 CRLF</span></span><br><span class="line"><span class="comment"># *.vcproj text eol=crlf </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对于 .sh 文件, 标记为文本文件, 在文件入 Git 库时进行规范化, 即行尾为 LF, 但是在检出到工作目录时, 行尾也不会转换为 CRLF (即保持 LF )</span></span><br><span class="line"><span class="comment"># *.sh text eol=lf  </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对于 .py 文件, 只针对工作目录中的文件, 行尾为 LF</span></span><br><span class="line"><span class="comment"># *.py eol=lf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GitHub 是根据项目里文件数目最多的文件类型, 识别项目类型. 后端项目难免会包含前端的资源, 有时候就会被标记成前端语言, 因为项目里 css 等文件比较多, 被误识别成 css 项目, 可以通过忽略文件的方式来达到指定语言</span></span><br><span class="line"><span class="comment"># 忽略目录下的文件的语言</span></span><br><span class="line"><span class="comment"># public/* linguist-vendored</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在文件比较分散的情况下, 可以按文件的类型进行忽略</span></span><br><span class="line"><span class="comment"># *.css linguist-vendored</span></span><br><span class="line"><span class="comment"># *.scss linguist-vendored</span></span><br><span class="line"><span class="comment"># *.js linguist-vendored</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当你的项目是作为一个扩展发布在 packagist.org 上的时候, 使用者需要的可能只是你的 src 文件夹和 composer.json 文件, 而不需要其他的一些文件, 它的作用就是会忽略这些文件</span></span><br><span class="line"><span class="comment"># 当使用 composer 安装你的软件包(扩展包)的时候, --prefer-dist 会从 github 或 cvs 下载一个 zip 包, 并将其解压缩. 使用 .gitattributes 文件, 可以通过添加 export-ignore 属性来忽略不需要下载的文件.</span></span><br><span class="line"><span class="comment"># 在使用 composer 安装扩展的时候, .travis.yml 文件是不会下载下来的.</span></span><br><span class="line"><span class="comment"># 适用于 Github 和 Bitbucket</span></span><br><span class="line"><span class="comment"># .travis.yml export-ignore</span></span><br><span class="line"></span><br><span class="line">* text=auto</span><br><span class="line">*.css linguist-vendored</span><br><span class="line">*.scss linguist-vendored</span><br><span class="line">*.js linguist-vendored</span><br><span class="line">CHANGELOG.md <span class="built_in">export</span>-ignore</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>.gitkeep - 如果一个目录为空, 是无法纳入到 git 版本控制中的, 所以创建了一个随意命名(最好还是按业界通用做法命名为 .gitkeep) 的隐藏文件来保证目录不为空</p></div>
<a id="more"></a>
<div class="note danger"><p>IDE 配置(这里以 PHPSTORM 为例)</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置换行符</span></span><br><span class="line">Settings -&gt; Editor -&gt; Code Style</span><br><span class="line">    General -&gt; Line separator：Unix and macOS (\n)</span><br><span class="line"><span class="comment"># 设置编码 UTF-8</span></span><br><span class="line">Settings -&gt; Editor -&gt; File Encodings </span><br><span class="line">    [Global,Project,properties files] -&gt; UTF-8</span><br><span class="line">    BOM -&gt; with NO BOM</span><br><span class="line"><span class="comment"># 设置 Tab 为 4 个空格</span></span><br><span class="line">Settings -&gt; Editor -&gt; Code Style -&gt; PHP</span><br><span class="line">    取消 Use tab character 勾选    </span><br><span class="line">    Tab size 设置为 4</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>.editorconfig - 定义编码规范 (编辑器配置文件, 比如缩进大小、换行模式等)</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 通配符</span></span><br><span class="line"><span class="comment"># *             匹配除 / 之外的任意字符串</span></span><br><span class="line"><span class="comment"># **            匹配任意字符串</span></span><br><span class="line"><span class="comment"># ?             匹配任意单个字符</span></span><br><span class="line"><span class="comment"># [name]        匹配 name 中的任意一个单一字符</span></span><br><span class="line"><span class="comment"># [!name]       匹配不存在 name 中的任意一个单一字符</span></span><br><span class="line"><span class="comment"># &#123;s1,s2,s3&#125;    匹配给定的字符串中的任意一个(逗号分割)</span></span><br><span class="line"><span class="comment"># &#123;num1..num2&#125;  匹配 num1 到 num2 之间的任意一个整数(num1 和 num2 可以为正整数也可以为负整数)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># root                      表明是最顶层的配置文件,发现设为 true 时,才会停止查找 .editorconfig 文件</span></span><br><span class="line"><span class="comment"># charset                   编码 latin1、utf-8、utf-8-bom、utf-16be、utf-16le</span></span><br><span class="line"><span class="comment"># indent_style              缩进风格 tab、space</span></span><br><span class="line"><span class="comment"># indent_size               缩进风格为 space 时, 缩进的字符数</span></span><br><span class="line"><span class="comment"># tab_width                 缩进为 tab 时, 缩进的宽度</span></span><br><span class="line"><span class="comment"># end_of_line               换行符的类型 lf、cr、crlf</span></span><br><span class="line"><span class="comment"># trim_trailing_whitespace  是否将行尾空格自动删除</span></span><br><span class="line"><span class="comment"># insert_final_newline      是否使文件以一个空白行结尾</span></span><br><span class="line"></span><br><span class="line">root = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[*]</span><br><span class="line">charset = utf-8</span><br><span class="line">indent_style = space</span><br><span class="line">indent_size = 4</span><br><span class="line">end_of_line = lf</span><br><span class="line">trim_trailing_whitespace = <span class="literal">true</span></span><br><span class="line">insert_final_newline = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[*.md]</span><br><span class="line">trim_trailing_whitespace = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">[*.&#123;yml,yaml&#125;]</span><br><span class="line">indent_size = 2</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>squizlabs/PHP_CodeSniffer 代码检查工具(全局安装)</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">composer global require <span class="string">"squizlabs/php_codesniffer=*"</span></span><br><span class="line"><span class="comment"># 查看全局 vendor 目录</span></span><br><span class="line">composer global config bin-dir --absolute</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux 环境 - 设置 phpcs、phpcbf 软链</span></span><br><span class="line">ln -s /root/.composer/vendor/bin/phpcs /usr/<span class="built_in">local</span>/bin</span><br><span class="line">ln -s /root/.composer/vendor/bin/phpcbf /usr/<span class="built_in">local</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows 环境 - 设置 phpcs、phpcbf 环境变量  </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认代码标准</span></span><br><span class="line">phpcs --config-set default_standard PSR12</span><br><span class="line">phpcbf --config-set default_standard PSR12</span><br></pre></td></tr></table></figure>
<hr>
<div class="note danger"><p>PHPSTORM 推荐插件</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 翻译插件 - Translation</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证和格式化JSON字符串 - Json Parser </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串操作(大小写 &amp; 驼峰转换等) - String Manipulation</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 代码风格规范 - Editorconfig </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># env 函数提示 - .env file support</span></span><br></pre></td></tr></table></figure>
<div class="note danger"><p>.php_cs - 代码格式修复工具 PHP-CS-Fixer 配置文件</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/squizlabs/PHP_CodeSniffer</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://blog.csdn.net/xiaoxiong_web/article/details/78788449</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$header = <span class="string">&lt;&lt;&lt;'EOF'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line"></span><br><span class="line">$finder = PhpCsFixer\Finder::create()</span><br><span class="line">            -&gt;exclude(<span class="string">'tests/Fixtures'</span>)   <span class="comment">// 排除文件</span></span><br><span class="line">            -&gt;in(<span class="keyword">__DIR__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> PhpCsFixer\Config::create()</span><br><span class="line">    -&gt;setRiskyAllowed(<span class="keyword">true</span>)</span><br><span class="line">    -&gt;setRules([</span><br><span class="line">        <span class="string">'@PSR2'</span>                                 =&gt; <span class="keyword">true</span>,</span><br><span class="line">        <span class="string">'@Symfony:risky'</span>                        =&gt; <span class="keyword">true</span>,</span><br><span class="line">        <span class="string">'array_syntax'</span>                          =&gt; [<span class="string">'syntax'</span> =&gt; <span class="string">'short'</span>],</span><br><span class="line">        <span class="string">'combine_consecutive_unsets'</span>            =&gt; <span class="keyword">true</span>,  <span class="comment">// 多个unset,合并成一个</span></span><br><span class="line">        <span class="comment">// one should use PHPUnit methods to set up expected exception instead of annotations</span></span><br><span class="line">        <span class="string">'general_phpdoc_annotation_remove'</span>      =&gt; [<span class="string">'expectedException'</span>, <span class="string">'expectedExceptionMessage'</span>, <span class="string">'expectedExceptionMessageRegExp'</span>], <span class="comment">//phpdocs中应该省略已经配置的注释</span></span><br><span class="line">        <span class="comment">//'header_comment'                        =&gt; array('header' =&gt; $header), // 添加,替换或者删除 header 注释</span></span><br><span class="line">        <span class="string">'heredoc_to_nowdoc'</span>                     =&gt; <span class="keyword">true</span>,  <span class="comment">// 删除配置中多余的空行和/或者空行。</span></span><br><span class="line">        <span class="string">'no_extra_consecutive_blank_lines'</span>      =&gt; [<span class="string">'break'</span>, <span class="string">'continue'</span>, <span class="string">'extra'</span>, <span class="string">'return'</span>, <span class="string">'throw'</span>, <span class="string">'use'</span>, <span class="string">'parenthesis_brace_block'</span>, <span class="string">'square_brace_block'</span>, <span class="string">'curly_brace_block'</span>],</span><br><span class="line">        <span class="string">'no_unreachable_default_argument_value'</span> =&gt; <span class="keyword">false</span>, <span class="comment">// 在函数参数中,不能有默认值在非缺省值之前的参数.有风险</span></span><br><span class="line">        <span class="string">'no_useless_else'</span>                       =&gt; <span class="keyword">true</span>,  <span class="comment">// 删除无用的eles</span></span><br><span class="line">        <span class="string">'no_useless_return'</span>                     =&gt; <span class="keyword">true</span>,  <span class="comment">// 删除函数末尾无用的return</span></span><br><span class="line">        <span class="string">'no_empty_phpdoc'</span>                       =&gt; <span class="keyword">true</span>,  <span class="comment">// 删除空注释</span></span><br><span class="line">        <span class="string">'no_empty_statement'</span>                    =&gt; <span class="keyword">true</span>,  <span class="comment">// 删除多余的分号</span></span><br><span class="line">        <span class="string">'no_leading_namespace_whitespace'</span>       =&gt; <span class="keyword">true</span>,  <span class="comment">// 删除namespace声明行包含前导空格</span></span><br><span class="line">        <span class="string">'no_spaces_inside_parenthesis'</span>          =&gt; <span class="keyword">true</span>,  <span class="comment">// 删除括号后内两端的空格</span></span><br><span class="line">        <span class="string">'no_trailing_whitespace'</span>                =&gt; <span class="keyword">true</span>,  <span class="comment">// 删除非空白行末尾的空白</span></span><br><span class="line">        <span class="string">'no_unused_imports'</span>                     =&gt; <span class="keyword">true</span>,  <span class="comment">// 删除未使用的use语句</span></span><br><span class="line">        <span class="string">'no_whitespace_before_comma_in_array'</span>   =&gt; <span class="keyword">true</span>,  <span class="comment">// 删除数组声明中,每个逗号前的空格</span></span><br><span class="line">        <span class="string">'no_whitespace_in_blank_line'</span>           =&gt; <span class="keyword">true</span>,  <span class="comment">// 删除空白行末尾的空白</span></span><br><span class="line">        <span class="string">'ordered_class_elements'</span>                =&gt; <span class="keyword">false</span>, <span class="comment">// class elements排序</span></span><br><span class="line">        <span class="string">'ordered_imports'</span>                       =&gt; <span class="keyword">false</span>, <span class="comment">// use 排序</span></span><br><span class="line">        <span class="string">'phpdoc_add_missing_param_annotation'</span>   =&gt; <span class="keyword">true</span>,  <span class="comment">// 添加缺少的 Phpdoc @param参数</span></span><br><span class="line">        <span class="string">'phpdoc_trim'</span>                           =&gt; <span class="keyword">true</span>,</span><br><span class="line">        <span class="comment">//   'phpdoc_trim_consecutive_blank_line_separation' =&gt; true, // 删除在摘要之后和PHPDoc中的描述之后,多余的空行</span></span><br><span class="line">        <span class="string">'phpdoc_order'</span>                          =&gt; <span class="keyword">true</span>,</span><br><span class="line">        <span class="string">'psr4'</span>                                  =&gt; <span class="keyword">true</span>,</span><br><span class="line">        <span class="comment">// 'strict_comparison'                     =&gt; true,   // 严格比较,会修改代码有风险</span></span><br><span class="line">        <span class="comment">//'strict_param'                          =&gt; true,</span></span><br><span class="line">        <span class="string">'ternary_operator_spaces'</span>               =&gt; <span class="keyword">true</span>,  <span class="comment">// 标准化三元运算的格式</span></span><br><span class="line">        <span class="string">'ternary_to_null_coalescing'</span>            =&gt; <span class="keyword">true</span>,  <span class="comment">// 尽可能使用null合并运算符??. 需要PHP&gt; = 7.0</span></span><br><span class="line">        <span class="string">'whitespace_after_comma_in_array'</span>       =&gt; <span class="keyword">true</span>,  <span class="comment">// 在数组声明中,每个逗号后必须有一个空格</span></span><br><span class="line">        <span class="string">'trim_array_spaces'</span>                     =&gt; <span class="keyword">true</span>,  <span class="comment">// 删除数组首或尾随单行空格</span></span><br><span class="line">        <span class="string">'align_multiline_comment'</span>               =&gt; [      <span class="comment">// 每行多行 DocComments 必须有一个星号(PSR-5),并且必须与第一行对齐</span></span><br><span class="line">            <span class="string">'comment_type'</span> =&gt; <span class="string">'phpdocs_only'</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">'array_indentation'</span>                 =&gt; <span class="keyword">true</span>,      <span class="comment">// 数组的每个元素必须缩进一次</span></span><br><span class="line">    ])</span><br><span class="line">    -&gt;setFinder($finder);</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Other</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>Git 配置</title>
    <url>/Git/git-configuration.html</url>
    <content><![CDATA[<div class="note danger"><p>Git 忽略已跟踪文件的改动</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 忽略 .htaccess 文件的改动</span></span><br><span class="line">git update-index --assume-unchanged .htaccess</span><br><span class="line"></span><br><span class="line"><span class="comment"># 取消忽略</span></span><br><span class="line">git update-index --no-assume-unchanged .htaccess</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看本地仓库忽略的文件列表</span></span><br><span class="line">git ls-files -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找出被忽略的文件</span></span><br><span class="line">git ls-files -v | grep <span class="string">'^h\ '</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取忽略文件路径</span></span><br><span class="line">git ls-files -v | grep <span class="string">'^h\ '</span> | awk <span class="string">'&#123;print $2&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有被忽略的文件取消忽略</span></span><br><span class="line">git ls-files -v | grep <span class="string">'^h'</span> | awk <span class="string">'&#123;print $2&#125;'</span> |xargs git update-index --no-assume-unchanged</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>区分大小写</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git config core.ignorecase <span class="literal">false</span></span><br><span class="line"><span class="comment"># 查看全局配置</span></span><br><span class="line">git config --global --list</span><br><span class="line"><span class="comment"># 全局配置区分大小写</span></span><br><span class="line">git config --global core.ignorecase <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<div class="note danger"><p>换行符配置</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 提交时转换为 LF, 检出时转换为 CRLF (推荐windows)</span></span><br><span class="line">git config --global core.autocrlf <span class="literal">true</span></span><br><span class="line"><span class="comment"># 提交时转换为LF, 检出时不转换(推荐*unix/mac)</span></span><br><span class="line">git config --global core.autocrlf input</span><br><span class="line"><span class="comment"># 提交检出均不转换</span></span><br><span class="line">git config --global core.autocrlf <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拒绝提交包含混合换行符的文件</span></span><br><span class="line">git config --global core.safecrlf <span class="literal">true</span></span><br><span class="line"><span class="comment"># 允许提交包含混合换行符的文件</span></span><br><span class="line">git config --global core.safecrlf <span class="literal">false</span></span><br><span class="line"><span class="comment"># 提交包含混合换行符的文件时给出警告</span></span><br><span class="line">git config --global core.safecrlf warn</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP 项目中常用算法</title>
    <url>/PHP/algorithm.html</url>
    <content><![CDATA[<div class="note danger"><p>蓄水池算法</p></div>
<h5 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$k = <span class="number">3</span>;</span><br><span class="line">$n = <span class="number">10</span>;</span><br><span class="line">$pool = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>];</span><br><span class="line">$result = [];</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $k; $i++) &#123;</span><br><span class="line">    <span class="comment">// 前 k 个元素直接放入数组中</span></span><br><span class="line">    $result[$i] = $pool[$i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($i = $k; $i &lt; $n; $i++) &#123;</span><br><span class="line">    $r = mt_rand(<span class="number">0</span>, $i);</span><br><span class="line">    <span class="comment">// 随机整数落在[0, k - 1]范围内,则替换蓄水池中的元素</span></span><br><span class="line">    <span class="keyword">if</span> ($r &lt; $k) &#123;</span><br><span class="line">        $result[$r] = $pool[$i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="应用场景-等概率抽奖"><a href="#应用场景-等概率抽奖" class="headerlink" title="应用场景 - 等概率抽奖"></a>应用场景 - 等概率抽奖</h5><ol>
<li><p>参与抽奖时进行中奖序号计算</p>
 <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 已参与人数</span></span><br><span class="line">$participantCount = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// 第N人参与时</span></span><br><span class="line">$participantCount += <span class="number">1</span>;</span><br><span class="line"><span class="comment">// 计算排名</span></span><br><span class="line">$rank = mt_rand(<span class="number">1</span>, $participantCount);</span><br><span class="line"><span class="keyword">if</span> ($rank !== $participantCount) &#123;</span><br><span class="line">    <span class="comment">// 与指定用户的排名互换,若更新失败,则不互换</span></span><br><span class="line">    $result = <span class="string">'UPDATE test_table SET rank = $participantCount WHERE rank = $rank;'</span>;</span><br><span class="line">    <span class="keyword">if</span> (!$result) &#123;</span><br><span class="line">        $rank = $participantCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存参与记录</span></span><br><span class="line">$result = <span class="string">'INSERT INTO test_table(rank) VALUES($rank)'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>防并发处理</p>
 <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisService</span> </span></span><br><span class="line"><span class="class"></span>&#123;        </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> Redis</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> $redis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Bootstrap.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> RedisException|Exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::__construct(config(<span class="string">'redis.'</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;redis = <span class="keyword">new</span> Redis();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;redis-&gt;connect(<span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'host'</span>), <span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'port'</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;redis-&gt;auth(<span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'auth'</span>))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RedisException(<span class="string">"redis password verification failed, auth=&#123;$this-&gt;config-&gt;get('auth')&#125;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;redis-&gt;ping() !== <span class="string">'+PONG'</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RedisException(<span class="string">"redis connection is not available, ping=&#123;$this-&gt;redis-&gt;ping()&#125;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Incr Atomic.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string $key</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> int    $defaultValue</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> int    $value</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">incrAtomic</span><span class="params">(string $key, int $defaultValue = <span class="number">1</span>, int $value = <span class="number">1</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 使用 redis 的 eval (lua 语法), 把对比和自增变成原子操作</span></span><br><span class="line">        $script = <span class="string">"if redis.call('get', KEYS[1]) == false then return redis.call('incrBy', KEYS[1], ARGV[1]) else return redis.call('incrBy', KEYS[1], ARGV[2]) end"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;redis-&gt;eval($script, [$key, $defaultValue, $value], <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$lottery = [</span><br><span class="line">    <span class="string">'lotteryId'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">    <span class="string">'participantCount'</span> =&gt; <span class="number">10</span>,</span><br><span class="line">];</span><br><span class="line">$redisService = <span class="keyword">new</span> RedisService();</span><br><span class="line"><span class="comment">// 获取当前活动参与人数</span></span><br><span class="line">$participantCount = $redisService-&gt;incrAtomic(<span class="string">"lottery:incr_&#123;$lottery['lotteryId']&#125;"</span>, $lottery[<span class="string">'participantCount'</span>] + <span class="number">1</span>);</span><br><span class="line"><span class="comment">// 计算中奖序号</span></span><br><span class="line">$winningNumber = mt_rand(<span class="number">1</span>, $participantCount);</span><br><span class="line"><span class="comment">// 开启事务</span></span><br><span class="line">$participationRecordModel-&gt;startTrans();</span><br><span class="line"><span class="comment">// 与已有的中奖序号互换</span></span><br><span class="line"><span class="keyword">if</span> ($winningNumber !== $participantCount) &#123;</span><br><span class="line">    $updateResult = $participationRecordModel::where([</span><br><span class="line">        <span class="string">'lottery_id'</span> =&gt; $lottery[<span class="string">'lotteryId'</span>],</span><br><span class="line">        <span class="string">'winning_number'</span> =&gt; $winningNumber,</span><br><span class="line">    ])-&gt;update([</span><br><span class="line">        <span class="string">'winning_number'</span> =&gt; $participantCount</span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">if</span> (!$updateResult) &#123;</span><br><span class="line">        $winningNumber = $participantCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存参与记录</span></span><br><span class="line">$participationRecordModel-&gt;insertGetId([</span><br><span class="line">    <span class="string">'lottery_id'</span> =&gt; $lottery[<span class="string">'lotteryId'</span>],</span><br><span class="line">    <span class="string">'user_id'</span> =&gt; $user-&gt;userId,</span><br><span class="line">    <span class="string">'winning_number'</span> =&gt; $winningNumber,</span><br><span class="line">    <span class="string">'generate_time'</span> =&gt; date(<span class="string">'Y-m-d H:i:s'</span>),</span><br><span class="line">]);</span><br><span class="line"><span class="comment">// 提交事务</span></span><br><span class="line">$participationRecordModel-&gt;commit();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<div class="note danger"><p>转盘抽奖</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$lotteryPrize = [];</span><br><span class="line">$prizes = [</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'prizeId'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">        <span class="string">'prizeLevel'</span> =&gt; <span class="string">'一等奖'</span>,</span><br><span class="line">        <span class="string">'prizeName'</span> =&gt; <span class="string">'iphone'</span>,</span><br><span class="line">        <span class="string">'prizeCount'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">        <span class="string">'prizeProbability'</span> =&gt; <span class="string">'0.001'</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'prizeId'</span> =&gt; <span class="number">2</span>,</span><br><span class="line">        <span class="string">'prizeLevel'</span> =&gt; <span class="string">'二等奖'</span>,</span><br><span class="line">        <span class="string">'prizeName'</span> =&gt; <span class="string">'ipad'</span>,</span><br><span class="line">        <span class="string">'prizeCount'</span> =&gt; <span class="number">3</span>,</span><br><span class="line">        <span class="string">'prizeProbability'</span> =&gt; <span class="string">'0.005'</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'prizeId'</span> =&gt; <span class="number">3</span>,</span><br><span class="line">        <span class="string">'prizeLevel'</span> =&gt; <span class="string">'三等奖'</span>,</span><br><span class="line">        <span class="string">'prizeName'</span> =&gt; <span class="string">'500购物券'</span>,</span><br><span class="line">        <span class="string">'prizeCount'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">        <span class="string">'prizeProbability'</span> =&gt; <span class="string">'10.000'</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'prizeId'</span> =&gt; <span class="number">4</span>,</span><br><span class="line">        <span class="string">'prizeLevel'</span> =&gt; <span class="string">'四等奖'</span>,</span><br><span class="line">        <span class="string">'prizeName'</span> =&gt; <span class="string">'200元话费'</span>,</span><br><span class="line">        <span class="string">'prizeCount'</span> =&gt; <span class="number">10</span>,</span><br><span class="line">        <span class="string">'prizeProbability'</span> =&gt; <span class="string">'30.000'</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'prizeId'</span> =&gt; <span class="number">5</span>,</span><br><span class="line">        <span class="string">'prizeLevel'</span> =&gt; <span class="string">'五等奖'</span>,</span><br><span class="line">        <span class="string">'prizeName'</span> =&gt; <span class="string">'100元话费'</span>,</span><br><span class="line">        <span class="string">'prizeCount'</span> =&gt; <span class="number">30</span>,</span><br><span class="line">        <span class="string">'prizeProbability'</span> =&gt; <span class="string">'50.000'</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'prizeId'</span> =&gt; <span class="number">6</span>,</span><br><span class="line">        <span class="string">'prizeLevel'</span> =&gt; <span class="string">'六等奖'</span>,</span><br><span class="line">        <span class="string">'prizeName'</span> =&gt; <span class="string">'50元话费'</span>,</span><br><span class="line">        <span class="string">'prizeCount'</span> =&gt; <span class="number">50</span>,</span><br><span class="line">        <span class="string">'prizeProbability'</span> =&gt; <span class="string">'50.000'</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'prizeId'</span> =&gt; <span class="number">7</span>,</span><br><span class="line">        <span class="string">'prizeLevel'</span> =&gt; <span class="string">'七等奖'</span>,</span><br><span class="line">        <span class="string">'prizeName'</span> =&gt; <span class="string">'30元话费'</span>,</span><br><span class="line">        <span class="string">'prizeCount'</span> =&gt; <span class="number">100</span>,</span><br><span class="line">        <span class="string">'prizeProbability'</span> =&gt; <span class="string">'90.000'</span></span><br><span class="line">    ]</span><br><span class="line">];</span><br><span class="line"><span class="comment">// 按概率从低到高排序</span></span><br><span class="line">$probabilityArray = array_column($prizes, <span class="string">'prizeProbability'</span>);</span><br><span class="line">array_multisort($probabilityArray, SORT_ASC, $prizes);</span><br><span class="line"><span class="comment">// 奖品数组</span></span><br><span class="line">$prizesArray = [];</span><br><span class="line"><span class="comment">// 总概率</span></span><br><span class="line">$probabilitySum = <span class="number">0</span>;</span><br><span class="line">$rate = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($prizes <span class="keyword">as</span> $prize) &#123;</span><br><span class="line">    <span class="comment">// 奖品有库存</span></span><br><span class="line">    <span class="keyword">if</span> ($prize[<span class="string">'prizeCount'</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        $prize[<span class="string">'prizeProbability'</span>] *= $rate;</span><br><span class="line">        $prizesArray[$prize[<span class="string">'prizeId'</span>]] = $prize;</span><br><span class="line">        $probabilitySum += $prize[<span class="string">'prizeProbability'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中奖的奖品ID</span></span><br><span class="line">$winningPrizeId = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 原始概率</span></span><br><span class="line">$originalProbability = <span class="number">100</span> * $rate;</span><br><span class="line"><span class="keyword">foreach</span> ($prizesArray <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">    <span class="comment">// 总概率不足$originalProbability时</span></span><br><span class="line">    $max = $probabilitySum &lt; $originalProbability ? $originalProbability : $probabilitySum;</span><br><span class="line">    $rand = mt_rand(<span class="number">1</span>, $max);</span><br><span class="line">    <span class="keyword">if</span> ($rand &lt;= $value[<span class="string">'prizeProbability'</span>]) &#123;</span><br><span class="line">        $winningPrizeId = $key;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $probabilitySum -= $value[<span class="string">'prizeProbability'</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">isset</span>($prizesArray[$winningPrizeId]) &amp;&amp; ($lotteryPrize = $prizesArray[$winningPrizeId]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'中奖奖品:'</span>;</span><br><span class="line">print_r($lotteryPrize);</span><br></pre></td></tr></table></figure>
<hr>
<div class="note danger"><p>砍价</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算用户砍价金额</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> float $remainingAmount</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int   $remainingCount</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int   $bargainCount</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">$calculateBargainAmountFunc = <span class="function"><span class="keyword">function</span> <span class="params">(float $remainingAmount, int $remainingCount, int $bargainCount)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 剩余一次</span></span><br><span class="line">    <span class="keyword">if</span> ($remainingCount == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> $remainingAmount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $minMoney = <span class="number">0.01</span>;</span><br><span class="line">    <span class="comment">// 剩余金额 = 剩余金额 - (剩余刀数 * 最低金额)</span></span><br><span class="line">    $remainingAmount = bcsub($remainingAmount, $remainingCount * $minMoney);</span><br><span class="line">    <span class="comment">// 平均金额</span></span><br><span class="line">    $avgAmount = bcdiv($remainingAmount, $remainingCount);</span><br><span class="line">    <span class="comment">// 剩余刀数占比</span></span><br><span class="line">    $remainingProgress = bcdiv($remainingCount, $bargainCount);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一刀 = (总刀数的15% ~ 30%) * 平均金额</span></span><br><span class="line">    <span class="keyword">if</span> (bccomp($remainingProgress, <span class="number">1</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">        $minScaleFactor = $remainingCount * <span class="number">0.15</span>;</span><br><span class="line">        $maxScaleFactor = $remainingCount * <span class="number">0.35</span>;</span><br><span class="line">    &#125; <span class="comment">// 前30%刀 = 平均金额 * (2 ~ 4)</span></span><br><span class="line">    <span class="keyword">elseif</span> (bccomp($remainingProgress, <span class="number">0.7</span>) !== <span class="number">-1</span>) &#123;</span><br><span class="line">        $minScaleFactor = <span class="number">2</span>;</span><br><span class="line">        $maxScaleFactor = <span class="number">4</span>;</span><br><span class="line">    &#125; <span class="comment">// 后70%刀 = 平均金额 * (0.1 ~ 2)</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        $minScaleFactor = <span class="number">0.1</span>;</span><br><span class="line">        $maxScaleFactor = <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $minAmount = bcmul($avgAmount, $minScaleFactor);</span><br><span class="line">    $maxAmount = bcmul($avgAmount, $maxScaleFactor);</span><br><span class="line">    <span class="comment">// 最大金额超出剩余金额</span></span><br><span class="line">    $maxAmount &gt; $remainingAmount &amp;&amp; ($maxAmount = $remainingAmount);</span><br><span class="line">    <span class="comment">// 最低金额大于最大金额</span></span><br><span class="line">    $minAmount &gt; $maxAmount &amp;&amp; ($minAmount = $maxAmount);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 砍价金额</span></span><br><span class="line">    <span class="keyword">return</span> bcadd(bcdiv(mt_rand($minAmount * <span class="number">100</span>, $maxAmount * <span class="number">100</span>), <span class="number">100</span>), $minMoney);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$totalAmount = <span class="number">100</span>;</span><br><span class="line">$estimateBargainCount = <span class="number">20</span>;</span><br><span class="line">$bargainedCount = <span class="number">0</span>;</span><br><span class="line">$t = <span class="number">0</span>;</span><br><span class="line">bcscale(<span class="number">2</span>);</span><br><span class="line"><span class="keyword">while</span> ($bargainedCount &lt; $estimateBargainCount) &#123;</span><br><span class="line">    $remainingCount = $estimateBargainCount - $bargainedCount;</span><br><span class="line">    $bargainAmount = $calculateBargainAmountFunc($totalAmount, $remainingCount, $estimateBargainCount);</span><br><span class="line">    $totalAmount = bcsub($totalAmount, $bargainAmount);</span><br><span class="line">    $bargainedCount++;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"第&#123;$bargainedCount&#125;次,砍价金额：&#123;$bargainAmount&#125;"</span>, <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line">    $t = bcadd($t, $bargainAmount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>algorithm</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker 搭建 LAMP</title>
    <url>/Docker/docker-lamp.html</url>
    <content><![CDATA[<div class="note danger"><p>参考 <a href="/Docker/docker-lnmp-redis.html">Docker 搭建 LNMP + Redis</a> </p></div> 
<ol>
<li><p>新建 <code>php-apache</code> 目录</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir php-apache</span><br></pre></td></tr></table></figure>
</li>
<li><p>复制配置文件</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.进入宿主机 php-apache 目录</span></span><br><span class="line"><span class="built_in">cd</span> /data/php-apache</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.拉取 php:7.2-apache</span></span><br><span class="line">docker pull php:7.2-apache</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.拉取 php-extension-installer</span></span><br><span class="line">docker pull mlocati/php-extension-installer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 复制 php.ini-development</span></span><br><span class="line">docker run --rm php:7.2-apache cat /usr/<span class="built_in">local</span>/etc/php/php.ini-development &gt; php.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.复制 000-default.conf 至 conf.d 目录</span></span><br><span class="line">docker run --rm php:7.2-apache cat /etc/apache2/sites-enabled/000-default.conf &gt; ./conf.d/default.conf</span><br></pre></td></tr></table></figure>
</li>
</ol>
<a id="more"></a>
<ol>
<li><p>修改 <code>default.conf</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerAdmin webmaster@localhost</span><br><span class="line">    DocumentRoot <span class="string">"/data/app/default"</span></span><br><span class="line">    ServerName localhost</span><br><span class="line">    ErrorLog <span class="variable">$&#123;APACHE_LOG_DIR&#125;</span>/error.log</span><br><span class="line">    CustomLog <span class="variable">$&#123;APACHE_LOG_DIR&#125;</span>/access.log combined</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 <code>Dockerfile</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM php:7.2-apache</span><br><span class="line">RUN mkdir -p /data/app</span><br><span class="line"></span><br><span class="line">RUN ln -s /etc/apache2/mods-available/rewrite.load /etc/apache2/mods-enabled/rewrite.load</span><br><span class="line"></span><br><span class="line">ENV APACHE_DOCUMENT_ROOT /data/app</span><br><span class="line">RUN sed -ri -e <span class="string">'s!/var/www/html!$&#123;APACHE_DOCUMENT_ROOT&#125;!g'</span> /etc/apache2/sites-available/*.conf</span><br><span class="line">RUN sed -ri -e <span class="string">'s!/var/www/!$&#123;APACHE_DOCUMENT_ROOT&#125;!g'</span> /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install Extensions</span></span><br><span class="line">COPY --from=mlocati/php-extension-installer /usr/bin/install-php-extensions /usr/bin/</span><br><span class="line">RUN install-php-extensions zip gd xdebug redis \</span><br><span class="line">    &amp;&amp; docker-php-ext-install bcmath pcntl pdo_mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add Composer</span></span><br><span class="line">RUN php -r <span class="string">"copy('https://install.phpcomposer.com/installer', 'composer-setup.php');"</span> \</span><br><span class="line">    &amp;&amp; php composer-setup.php \</span><br><span class="line">    &amp;&amp; php -r <span class="string">"unlink('composer-setup.php');"</span> \</span><br><span class="line">    &amp;&amp; mv composer.phar /usr/<span class="built_in">local</span>/bin/composer</span><br><span class="line"></span><br><span class="line">ENV TZ=Asia/Shanghai</span><br><span class="line">RUN ln -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="variable">$TZ</span> &gt; /etc/timezone</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成镜像并上传,然后运行容器</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成镜像</span></span><br><span class="line">docker build -t sevming/php72-apache:0.1 .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传镜像</span></span><br><span class="line">docker push sevming/php72-apache:0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行容器</span></span><br><span class="line">docker run -itd --rm --name php-apache -p 80:80 -v /data/app:/data/app -v /data/php-apache/php.ini:/usr/<span class="built_in">local</span>/etc/php/php.ini -v /data/php-apache/conf.d:/etc/apache2/sites-enabled --net lnmp --ip 172.18.0.8 sevming/php72-apache:0.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问 <code>服务器IP</code></p>
</li>
<li><p><code>docker-compose.yml</code> 配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">php-apache:</span></span><br><span class="line"><span class="attr">  build:</span> <span class="string">./php-apache</span></span><br><span class="line"><span class="attr">  container_name:</span> <span class="string">php-apache</span></span><br><span class="line"><span class="attr">  restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/data/php-apache/php.ini:/usr/local/etc/php/php.ini</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/data/php-apache/conf.d:/etc/apache2/sites-enabled</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/data/app:/data/app</span></span><br><span class="line"><span class="attr">  networks:</span></span><br><span class="line"><span class="attr">    lnmp:</span></span><br><span class="line"><span class="attr">      ipv4_address:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.8</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<div class="note warning"><p>以上 <code>PHP</code> 连接 <code>Apache</code> 采用的 <code>mod_php</code>, 下面是 <code>PHP-FPM</code> 的安装方式, 但是有个问题暂未解决, 暂时不推荐</p></div>
<h5 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h5><ol>
<li><p>复制配置文件</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.进入 httpd 目录</span></span><br><span class="line"><span class="built_in">cd</span> /data/httpd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.拉取 httpd</span></span><br><span class="line">docker pull httpd:2.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.复制 httpd.conf 至当前目录</span></span><br><span class="line">docker run --rm httpd:2.4 cat /usr/<span class="built_in">local</span>/apache2/conf/httpd.conf &gt; httpd.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.复制 default.conf 至当前 conf.d 目录</span></span><br><span class="line">docker run --rm httpd:2.4 cat /usr/<span class="built_in">local</span>/apache2/conf/conf.d/default.conf &gt; ./conf.d/default.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>httpd.conf</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">LoadModule proxy_module modules/mod_proxy.so</span><br><span class="line">LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so</span><br><span class="line">LoadModule rewrite_module modules/mod_rewrite.so</span><br><span class="line">&lt;Directory /&gt;</span><br><span class="line">    AllowOverride all</span><br><span class="line">    Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line">&lt;IfModule dir_module&gt;</span><br><span class="line">    DirectoryIndex index.php index.html</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line">include conf.d/*.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>default.conf</code> </p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerAdmin webmaster@dummy-host.example.com</span><br><span class="line">    DocumentRoot <span class="string">"/data/app/default"</span></span><br><span class="line">    ServerName localhost</span><br><span class="line">    <span class="comment">#ServerAlias www.dummy-host.example.com</span></span><br><span class="line">    ErrorLog <span class="string">"logs/default.com-error_log"</span></span><br><span class="line">    CustomLog <span class="string">"logs/default.com-access_log"</span> common</span><br><span class="line"></span><br><span class="line">    &lt;Directory <span class="string">"/data/app/default"</span>&gt;</span><br><span class="line">        Options None</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">    </span><br><span class="line">    ProxyPassMatch <span class="string">"^/(.*\.php(/.*)?)$"</span> <span class="string">"fcgi://172.18.0.7:9000/data/app/default/<span class="variable">$1</span>"</span></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 <code>Dockerfile</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM httpd:2.4</span><br><span class="line">RUN mkdir -p /data/app</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成镜像并运行容器</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成镜像</span></span><br><span class="line">docker build -t sevming/httpd .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行容器</span></span><br><span class="line">docker run -itd --rm --name httpd -p 80:80 -v /data/app:/data/app -v /data/httpd/httpd.conf:/usr/<span class="built_in">local</span>/apache2/conf/httpd.conf -v /data/httpd/conf.d:/usr/<span class="built_in">local</span>/apache2/conf.d --net lnmp --ip 172.18.0.8 sevming/httpd</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问 <code>服务器IP</code></p>
</li>
<li><code>docker-compose.yml</code> 配置 <figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">httpd:</span></span><br><span class="line"><span class="attr">build:</span> <span class="string">./httpd</span></span><br><span class="line"><span class="attr">container_name:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">443</span><span class="string">:443</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/data/httpd/httpd.conf:/usr/local/apache2/conf/httpd.conf</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/data/httpd/conf.d:/usr/local/apache2/conf.d</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/data/app:/data/app</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  lamp:</span></span><br><span class="line"><span class="attr">    ipv4_address:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.8</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">httpd.conf 设置 DirectoryIndex index.php index.html</span><br><span class="line">项目目录下只有 index.html, 访问项目会报 File not found, 不会识别 index.html</span><br><span class="line">目前未找到解决方案, 所以采用 php:7.2-apache 作为镜像源</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>lamp</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker 命令</title>
    <url>/Docker/docker-commands.html</url>
    <content><![CDATA[<div class="note danger"><p>基本命令</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker run</span></span><br><span class="line">run: </span><br><span class="line">  -v 本地/服务器 对应的本地资源/服务器资源地址</span><br><span class="line">  -i 以交互模式运行容器，通常与 -t 同时使用</span><br><span class="line">  -t 为容器重新分配一个伪输入终端，通常与 -i 同时使用</span><br><span class="line">  -d 设置容器后台一直运行</span><br><span class="line">  -p 8080:80  对应本地端口:服务器端口</span><br><span class="line">  —name 设置容器别名</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务器IP</span></span><br><span class="line">docker-machine ip default</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录</span></span><br><span class="line">docker login</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>docker image</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 镜像列表</span></span><br><span class="line">docker images</span><br><span class="line"><span class="comment"># 删除镜像</span></span><br><span class="line">docker rmi id</span><br><span class="line"><span class="comment"># 删除 none 镜像</span></span><br><span class="line">docker rmi $(docker images | grep <span class="string">"none"</span> | awk <span class="string">'&#123;print $3&#125;'</span>)</span><br><span class="line"><span class="comment"># 删除所有镜像</span></span><br><span class="line">docker rmi $(docker images -q)</span><br><span class="line"><span class="comment"># 搜索镜像</span></span><br><span class="line">docker search 镜像ID或者镜像名称 </span><br><span class="line"><span class="comment"># 拉取镜像, tag 版本</span></span><br><span class="line">docker pull image:[tag] </span><br><span class="line"><span class="comment"># 直接从镜像加速地址进行拉取</span></span><br><span class="line">docker pull registry.docker-cn.com/myname/myrepo:mytag</span><br><span class="line"><span class="comment"># 使用当前目录的 Dockerfile 创建镜像</span></span><br><span class="line">docker build -t [username]/[repository]:[tag] .</span><br><span class="line"><span class="comment"># 推送镜像到仓库</span></span><br><span class="line">docker push [OPTIONS] [username]/[repository]:[tag]</span><br><span class="line"><span class="comment"># 从容器创建一个新的镜像</span></span><br><span class="line">docker commit -a <span class="string">"作者名称"</span> -m <span class="string">"说明"</span> 容器名称或ID 打包的镜像名称:标签</span><br><span class="line">    <span class="comment"># OPTIONS说明：</span></span><br><span class="line">    -a :提交的镜像作者</span><br><span class="line">    -c :使用Dockerfile指令来创建镜像</span><br><span class="line">    -m :提交时的说明文字</span><br><span class="line">    -p :在commit时,将容器暂停</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p>docker container</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 容器列表</span></span><br><span class="line">docker ps -a </span><br><span class="line"><span class="comment"># 停止运行容器</span></span><br><span class="line">docker stop id/name </span><br><span class="line"><span class="comment"># 重启容器</span></span><br><span class="line">docker restart id/name</span><br><span class="line"><span class="comment"># 删除容器</span></span><br><span class="line">docker rm id/name</span><br><span class="line"><span class="comment"># 删除所有容器</span></span><br><span class="line">docker rm $(docker ps -qa)</span><br><span class="line"><span class="comment"># 复制文件</span></span><br><span class="line">docker cp id:服务器资源路径 本地资源路径</span><br><span class="line"><span class="comment"># 复制容器内的文件至当前文件夹</span></span><br><span class="line">docker run --rm httpd:2.4 cat /usr/<span class="built_in">local</span>/apache2/conf/httpd.conf &gt; httpd.conf </span><br><span class="line"><span class="comment"># 查看容器完整的command</span></span><br><span class="line">docker ps -a --no-trunc</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>docker network</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看网络列表</span></span><br><span class="line">docker network ls</span><br><span class="line"><span class="comment"># 创建自定义网络</span></span><br><span class="line">docker network create --subnet=172.18.0.0/16 testNet </span><br><span class="line"><span class="comment"># 查看容器IP</span></span><br><span class="line">docker inspect 容器ID grep | <span class="string">"IPAddress"</span> </span><br><span class="line"><span class="comment"># 容器运行时指定IP(需先创建自定义网络)</span></span><br><span class="line">docker run --net testNet --ip 172.18.0.1 httpd:2.4</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>docker-compose</p></div>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  php:</span></span><br><span class="line">    <span class="comment"># command 运行多条命令</span></span><br><span class="line"><span class="attr">    command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">-c</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">|</span></span><br><span class="line"><span class="string">        composer --version</span></span><br><span class="line"><span class="string">        php-fpm</span></span><br><span class="line"><span class="string">    # 内存和CPU限制</span></span><br><span class="line"><span class="string"></span><span class="attr">    deploy:</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line">              <span class="comment"># cpu 限制不超过70%</span></span><br><span class="line"><span class="attr">              cpus:</span> <span class="string">'0.70'</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">12288</span><span class="string">M</span></span><br><span class="line">              </span><br><span class="line"><span class="comment"># 启动和停止</span></span><br><span class="line"><span class="string">docker-compose</span> <span class="bullet">--compatibility</span> <span class="string">up</span> <span class="bullet">-d</span></span><br><span class="line"><span class="string">docker-compose</span> <span class="bullet">--compatibility</span> <span class="string">stop</span></span><br><span class="line"><span class="comment"># 由于做了资源限制,并且没有使用swarm,所以要加上--compatibility参数,不然会报错</span></span><br><span class="line"><span class="attr">WARNING:</span> <span class="string">Some</span> <span class="string">services</span> <span class="string">(web)</span> <span class="string">use</span> <span class="string">the</span> <span class="string">'deploy'</span> <span class="string">key,</span> <span class="string">which</span> <span class="string">will</span> <span class="string">be</span> <span class="string">ignored.</span> <span class="string">Compose</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">'deploy'</span> <span class="string">configuration</span> <span class="bullet">-</span> <span class="string">use</span> <span class="string">docker</span> <span class="string">stack</span> <span class="string">deploy</span> <span class="string">to</span> <span class="string">deploy</span> <span class="string">to</span> <span class="string">a</span> <span class="string">swarm.</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>docker-compose</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx 相关</title>
    <url>/Nginx/nginx-about.html</url>
    <content><![CDATA[<div class="note danger"><p>nginx 安装新模块</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#以 OneinStack 安装 nginx-rtmp-module 模块为例子, OneinStack 解压后的目录为 /packages/oneinstack</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 下载 nginx-rtmp-module 并解压</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/arut/nginx-rtmp-module.git</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 查看 nginx 已安装的模块</span></span><br><span class="line">[root@192 ~]<span class="comment"># nginx -V</span></span><br><span class="line">nginx version: nginx/1.14.2</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-36) (GCC) </span><br><span class="line">built with OpenSSL 1.1.1a  20 Nov 2018</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/<span class="built_in">local</span>/nginx --user=www --group=www --with-http_stub_status_module --with-http_v2_module --with-http_ssl_module --with-http_gzip_static_module --with-http_realip_module --with-http_flv_module --with-http_mp4_module --with-openssl=../openssl-1.1.1a --with-pcre=../pcre-8.42 --with-pcre-jit --with-ld-opt=-ljemalloc</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 解压 nginx、openssl-1.1.1a、pcre-8.42</span></span><br><span class="line">tar -zxvf /packages/oneinstack/src/nginx-1.14.2.tar.gz</span><br><span class="line">tar -zxvf /packages/oneinstack/src/openssl-1.1.1a.tar.gz</span><br><span class="line">tar -zxvf /packages/oneinstack/src/pcre-8.42.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 编译 nginx (不要 make install), 这里添加模块 --add-module=/packages/nginx-rtmp-module</span></span><br><span class="line"><span class="built_in">cd</span> /packages/oneinstack/src/nginx-1.14.2</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx --user=www --group=www --add-module=/packages/nginx-rtmp-module --with-http_stub_status_module --with-http_v2_module --with-http_ssl_module --with-http_gzip_static_module --with-http_realip_module --with-http_flv_module --with-http_mp4_module --with-openssl=../openssl-1.1.1a --with-pcre=../pcre-8.42 --with-pcre-jit --with-ld-opt=-ljemalloc</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="comment">#5. 替换 nginx 二进制文件</span></span><br><span class="line">cp /usr/<span class="built_in">local</span>/nginx/sbin/nginx /usr/<span class="built_in">local</span>/nginx/sbin/nginx.bak</span><br><span class="line">cp ./objs/nginx /usr/<span class="built_in">local</span>/nginx/sbin/</span><br><span class="line"></span><br><span class="line"><span class="comment">#6. 重启nginx</span></span><br><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p>nginx + apache 动静分离</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#服务器 IP：192.168.1.7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1. apache 虚拟主机相关配置</span></span><br><span class="line">&lt;VirtualHost *:88&gt;</span><br><span class="line">  DocumentRoot <span class="string">"/data/wwwroot/default"</span></span><br><span class="line">  ServerName 127.0.0.1</span><br><span class="line">  ErrorLog <span class="string">"/data/wwwlogs/error_apache.log"</span></span><br><span class="line">  CustomLog <span class="string">"/data/wwwlogs/access_apache.log"</span> common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. default 目录下有2个文件, test.html 和 test.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 配置 apache - conf/httpd.conf, 修改默认端口为 88</span></span><br><span class="line">Listen 88</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 配置 nginx - conf/nginx.conf, server &#123;&#125; 中添加以下代码</span></span><br><span class="line">access_log /data/logs/access_nginx.log combined;</span><br><span class="line">location / &#123;</span><br><span class="line">    try_files <span class="variable">$uri</span> @apache;</span><br><span class="line">&#125;</span><br><span class="line">location @apache &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:88;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:88</span></span><br><span class="line">location ~ \.php$ &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:88;</span><br><span class="line">&#125;</span><br><span class="line">location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|flv|mp4|ico)$ &#123;</span><br><span class="line">    expires 30d;</span><br><span class="line">    access_log off;</span><br><span class="line">&#125;</span><br><span class="line">location ~ .*\.(js|css)?$ &#123;</span><br><span class="line">    expires 7d;</span><br><span class="line">    access_log off;</span><br><span class="line">    proxy_pass http://127.0.0.1:8080;</span><br><span class="line">&#125;</span><br><span class="line">location ~ /\.ht &#123;</span><br><span class="line">    deny all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#5. 访问 192.168.1.7/test.html, 查看 access_apache.log 和 access_nginx.log, 发现只有 access_nginx.log 有日志, 说明已实现静态分离</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#6. 访问  192.168.1.7/test.php, 查看 access_apache.log 和 access_nginx.log, 发现两个文件都有新的日志生成, 说明已实现动态分离</span></span><br></pre></td></tr></table></figure>
<div class="note danger"><p>nginx 设置反向代理后, js|css 无法加载</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#修改对应的项目配置文件, 添加以下代码</span></span><br><span class="line">server &#123;</span><br><span class="line">    location ~ .*\.(js|css)?$ &#123;</span><br><span class="line">        expires 7d;</span><br><span class="line">        access_log off;</span><br><span class="line">        <span class="comment">#反向代理地址需与项目配置的一样</span></span><br><span class="line">        proxy_pass http://127.0.0.1:88;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>nginx ssl 配置</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 下载证书相关文件,并重命名为 cert.pem 和 cert.key, 上传至 /usr/local/nginx/conf/cert 目录下</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 配置 nginx.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  www.xxx.com;</span><br><span class="line"></span><br><span class="line">    ssl_certificate      cert/cert.pem;</span><br><span class="line">    ssl_certificate_key  cert/cert.key;</span><br><span class="line"></span><br><span class="line">    ssl_session_cache    shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  5m;</span><br><span class="line"></span><br><span class="line">    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /www/<span class="built_in">test</span>;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>nginx 支持 php-fpm 模块</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. PHP 编译安装时,需在编译参数后面加上 --enable-fpm 就行, 比如</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/php --with-config-file-path=/usr/<span class="built_in">local</span>/php --<span class="built_in">enable</span>-fpm</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 进入 PHP 源码包</span></span><br><span class="line">cp /usr/<span class="built_in">local</span>/php/etc/php-fpm.conf.default /usr/<span class="built_in">local</span>/php/etc/php-fpm.conf</span><br><span class="line">cp /usr/<span class="built_in">local</span>/php/etc/php-fpm.d/www.conf.default /usr/<span class="built_in">local</span>/php/etc/php-fpm.d/www.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. vi /usr/local/php/etc/php-fpm.d/www.conf</span></span><br><span class="line">; Unix user/group of processes</span><br><span class="line">; Note: The user is mandatory. If the group is not <span class="built_in">set</span>, the default user<span class="string">'s group</span></span><br><span class="line"><span class="string">;       will be used.</span></span><br><span class="line"><span class="string">user = apache</span></span><br><span class="line"><span class="string">group = apache</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#4. 启动 php-fpm</span></span><br><span class="line"><span class="string">/usr/local/php/sbin/php-fpm</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#5. 配置 nginx.conf</span></span><br><span class="line"><span class="string">vi /usr/local/nginx/conf/nginx.conf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">location ~ \.php$ &#123;</span></span><br><span class="line"><span class="string">    root           /www/test;</span></span><br><span class="line"><span class="string">    fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line"><span class="string">    fastcgi_index  index.php;</span></span><br><span class="line"><span class="string">    fastcgi_param  SCRIPT_FILENAME  /www/test$fastcgi_script_name;</span></span><br><span class="line"><span class="string">    include        fastcgi_params;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#6. 重启 nginx</span></span><br><span class="line"><span class="string">service nginx restart</span></span><br></pre></td></tr></table></figure>
<div class="note danger"><p>将 nginx 添加为 service 服务</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/init.d/nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># nginx Startup script for the Nginx HTTP Server</span></span><br><span class="line"><span class="comment"># it is v.0.0.2 version.</span></span><br><span class="line"><span class="comment"># chkconfig: - 85 15</span></span><br><span class="line"><span class="comment"># description: Nginx is a high-performance web and proxy server.</span></span><br><span class="line"><span class="comment">#              It has a lot of features, but it's not for everyone.</span></span><br><span class="line"><span class="comment"># processname: nginx</span></span><br><span class="line"><span class="comment"># pidfile: /var/run/nginx.pid</span></span><br><span class="line"><span class="comment"># config: /usr/local/nginx/conf/nginx.conf</span></span><br><span class="line">nginxd=/usr/<span class="built_in">local</span>/nginx/sbin/nginx</span><br><span class="line">nginx_config=/usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line">nginx_pid=/var/run/nginx.pid</span><br><span class="line">RETVAL=0</span><br><span class="line">prog=<span class="string">"nginx"</span></span><br><span class="line"><span class="comment"># Source function library.</span></span><br><span class="line">. /etc/rc.d/init.d/<span class="built_in">functions</span></span><br><span class="line"><span class="comment"># Source networking configuration.</span></span><br><span class="line">. /etc/sysconfig/network</span><br><span class="line"><span class="comment"># Check that networking is up.</span></span><br><span class="line">[ <span class="variable">$&#123;NETWORKING&#125;</span> = <span class="string">"no"</span> ] &amp;&amp; <span class="built_in">exit</span> 0</span><br><span class="line">[ -x <span class="variable">$nginxd</span> ] || <span class="built_in">exit</span> 0</span><br><span class="line"><span class="comment"># Start nginx daemons functions.</span></span><br><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line"><span class="keyword">if</span> [ -e <span class="variable">$nginx_pid</span> ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"nginx already running...."</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">   <span class="built_in">echo</span> -n $<span class="string">"Starting <span class="variable">$prog</span>: "</span></span><br><span class="line">   daemon <span class="variable">$nginxd</span> -c <span class="variable">$&#123;nginx_config&#125;</span></span><br><span class="line">   RETVAL=$?</span><br><span class="line">   <span class="built_in">echo</span></span><br><span class="line">   [ <span class="variable">$RETVAL</span> = 0 ] &amp;&amp; touch /var/lock/subsys/nginx</span><br><span class="line">   <span class="built_in">return</span> <span class="variable">$RETVAL</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># Stop nginx daemons functions.</span></span><br><span class="line">stop() </span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">"Stopping <span class="variable">$prog</span>: "</span></span><br><span class="line">        killproc <span class="variable">$nginxd</span></span><br><span class="line">        RETVAL=$?</span><br><span class="line">        <span class="built_in">echo</span></span><br><span class="line">        [ <span class="variable">$RETVAL</span> = 0 ] &amp;&amp; rm -f /var/lock/subsys/nginx /var/run/nginx.pid</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># reload nginx service functions.</span></span><br><span class="line"><span class="function"><span class="title">reload</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">"Reloading <span class="variable">$prog</span>: "</span></span><br><span class="line">    <span class="comment">#kill -HUP `cat $&#123;nginx_pid&#125;`</span></span><br><span class="line">    killproc <span class="variable">$nginxd</span> -HUP</span><br><span class="line">    RETVAL=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># See how we were called.</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">        start</span><br><span class="line">        ;;</span><br><span class="line">stop)</span><br><span class="line">        stop</span><br><span class="line">        ;;</span><br><span class="line">reload)</span><br><span class="line">        reload</span><br><span class="line">        ;;</span><br><span class="line">restart)</span><br><span class="line">        stop</span><br><span class="line">        start</span><br><span class="line">        ;;</span><br><span class="line">status)</span><br><span class="line">        status <span class="variable">$prog</span></span><br><span class="line">        RETVAL=$?</span><br><span class="line">        ;;</span><br><span class="line">*)</span><br><span class="line">        <span class="built_in">echo</span> $<span class="string">"Usage: <span class="variable">$prog</span> &#123;start|stop|restart|reload|status|help&#125;"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span> <span class="variable">$RETVAL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#保存退出后,设置可执行权限</span></span><br><span class="line">chmod +x /etc/rc.d/init.d/nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加系统服务</span></span><br><span class="line">chkconfig --add nginx</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>Rewrite 配置</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /data/app/default/public;</span><br><span class="line">        index  index.php index.html index.htm;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!-e <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">            <span class="comment"># 重定向</span></span><br><span class="line">            rewrite ^/web/(\d+)?(.*)$ /web/<span class="variable">$2</span> last;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!-e <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">            rewrite  ^(.*)$  /index.php?s=/<span class="variable">$1</span> last;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker 基于 LNMP 扩展安装</title>
    <url>/Docker/docker-lnmp-extensions.html</url>
    <content><![CDATA[<div class="note primary"><p>以下扩展安装基于 <a href="/Docker/docker-lnmp-redis.html">Docker 搭建 LNMP + Redis</a> </p></div>
<hr>
<div class="note danger"><p>全局安装 Laravel dd() 函数</p></div>
<h5 id="创建-composer-文件夹"><a href="#创建-composer-文件夹" class="headerlink" title="创建 composer 文件夹"></a>创建 composer 文件夹</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/php</span><br><span class="line">mkdir composer</span><br><span class="line"><span class="built_in">cd</span> composer</span><br></pre></td></tr></table></figure>
<h5 id="新建-data-php-composer-composer-json"><a href="#新建-data-php-composer-composer-json" class="headerlink" title="新建 /data/php/composer/composer.json"></a>新建 <code>/data/php/composer/composer.json</code></h5><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"require"</span>: &#123;</span><br><span class="line">        <span class="attr">"squizlabs/php_codesniffer"</span>: <span class="string">"*"</span>,</span><br><span class="line">        <span class="attr">"fxp/composer-asset-plugin"</span>: <span class="string">"^1.4"</span>,</span><br><span class="line">        <span class="attr">"symfony/var-dumper"</span>: <span class="string">"3.3.16"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"autoload"</span>: &#123;</span><br><span class="line">        <span class="attr">"files"</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="新建-data-php-debugHelper-php"><a href="#新建-data-php-debugHelper-php" class="headerlink" title="新建 /data/php/debugHelper.php"></a>新建 <code>/data/php/debugHelper.php</code></h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install symfony/var-dump to your project</span></span><br><span class="line"><span class="comment"># composer require symfony/var-dumper</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// use namespace</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">VarDumper</span>\<span class="title">Cloner</span>\<span class="title">VarCloner</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">VarDumper</span>\<span class="title">Dumper</span>\<span class="title">CliDumper</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">VarDumper</span>\<span class="title">Dumper</span>\<span class="title">HtmlDumper</span> <span class="title">as</span> <span class="title">SymfonyHtmlDumper</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Class HtmlDumper</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HtmlDumper</span> <span class="keyword">extends</span> <span class="title">SymfonyHtmlDumper</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Colour definitions for output.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> $styles = [</span><br><span class="line">        <span class="string">'default'</span> =&gt; <span class="string">'background-color:#fff; color:#222; line-height:1.2em; font-weight:normal; font:12px Monaco, Consolas, monospace; word-wrap: break-word; white-space: pre-wrap; position:relative; z-index:100000'</span>,</span><br><span class="line">        <span class="string">'num'</span> =&gt; <span class="string">'color:#a71d5d'</span>,</span><br><span class="line">        <span class="string">'const'</span> =&gt; <span class="string">'color:#795da3'</span>,</span><br><span class="line">        <span class="string">'str'</span> =&gt; <span class="string">'color:#df5000'</span>,</span><br><span class="line">        <span class="string">'cchr'</span> =&gt; <span class="string">'color:#222'</span>,</span><br><span class="line">        <span class="string">'note'</span> =&gt; <span class="string">'color:#a71d5d'</span>,</span><br><span class="line">        <span class="string">'ref'</span> =&gt; <span class="string">'color:#a0a0a0'</span>,</span><br><span class="line">        <span class="string">'public'</span> =&gt; <span class="string">'color:#795da3'</span>,</span><br><span class="line">        <span class="string">'protected'</span> =&gt; <span class="string">'color:#795da3'</span>,</span><br><span class="line">        <span class="string">'private'</span> =&gt; <span class="string">'color:#795da3'</span>,</span><br><span class="line">        <span class="string">'meta'</span> =&gt; <span class="string">'color:#b729d9'</span>,</span><br><span class="line">        <span class="string">'key'</span> =&gt; <span class="string">'color:#df5000'</span>,</span><br><span class="line">        <span class="string">'index'</span> =&gt; <span class="string">'color:#a71d5d'</span>,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Class Dumper</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dumper</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Dump a value with elegance.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span>  mixed  $value</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dump</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (class_exists(CliDumper::class)) &#123;</span><br><span class="line">            $dumper = <span class="string">'cli'</span> === PHP_SAPI ? <span class="keyword">new</span> CliDumper : <span class="keyword">new</span> HtmlDumper;</span><br><span class="line">            $dumper-&gt;dump((<span class="keyword">new</span> VarCloner)-&gt;cloneVar($value));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            var_dump($value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (! function_exists(<span class="string">'dd'</span>)) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Dump the passed variables and end the script.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span>  mixed</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dd</span><span class="params">(...$args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($args <span class="keyword">as</span> $x) &#123;</span><br><span class="line">            (<span class="keyword">new</span> Dumper)-&gt;dump($x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">die</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (! function_exists(<span class="string">'dda'</span>)) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Dump the passed array variables and end the script.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span>  mixed</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dda</span><span class="params">(...$args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($args <span class="keyword">as</span> $x) &#123;</span><br><span class="line">            (<span class="keyword">new</span> Dumper)-&gt;dump($x-&gt;toArray());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">die</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="修改-data-docker-compose-yml-后重启容器"><a href="#修改-data-docker-compose-yml-后重启容器" class="headerlink" title="修改 /data/docker-compose.yml 后重启容器"></a>修改 <code>/data/docker-compose.yml</code> 后重启容器</h5><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">php:</span></span><br><span class="line"><span class="attr">  container_name:</span> <span class="string">php</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/data/php/debugHelper.php:/usr/local/etc/php/debugHelper.php</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/data/php/composer/composer.json:/var/www/.composer/composer.json</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose restart</span><br></pre></td></tr></table></figure>
<h5 id="进入-php-容器安装-dd-函数依赖包并复制至本地"><a href="#进入-php-容器安装-dd-函数依赖包并复制至本地" class="headerlink" title="进入 php 容器安装 dd 函数依赖包并复制至本地"></a>进入 <code>php</code> 容器安装 <code>dd</code> 函数依赖包并复制至本地</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it php /bin/bash</span><br><span class="line"><span class="comment"># 1.修改 /var/www 所属用户和组</span></span><br><span class="line">chown -R www-data:www-data /var/www</span><br><span class="line"><span class="comment"># 2.设置 www-data 用户可登录(查看用户ID可使用命令 id www-data)</span></span><br><span class="line">usermod -s /bin/bash -u 33 www-data</span><br><span class="line"><span class="comment"># 3.切换至 www-data</span></span><br><span class="line">su www-data</span><br><span class="line"><span class="comment"># 4.设置 composer 镜像源</span></span><br><span class="line">composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/</span><br><span class="line"><span class="comment"># 5.更新 composer 包</span></span><br><span class="line">composer global update</span><br><span class="line"><span class="comment"># 6.退出 www-data 用户</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="comment"># 7.退出容器</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="comment"># 8.复制容器内的 vendor 目录至本地</span></span><br><span class="line">docker cp php:/var/www/.composer/vendor /data/php/composer/</span><br></pre></td></tr></table></figure>
<h5 id="停止运行容器"><a href="#停止运行容器" class="headerlink" title="停止运行容器"></a>停止运行容器</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose stop</span><br></pre></td></tr></table></figure>
<h5 id="映射-composer-和-debugHelper-php"><a href="#映射-composer-和-debugHelper-php" class="headerlink" title="映射 composer 和 debugHelper.php"></a>映射 <code>composer</code> 和 <code>debugHelper.php</code></h5><ol>
<li><p>修改 <code>php.ini</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">auto_prepend_file = <span class="string">"/var/www/.composer/vendor/autoload.php"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>/data/php/composer.json</code></p>
 <figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"require"</span>: &#123;</span><br><span class="line">        <span class="attr">"squizlabs/php_codesniffer"</span>: <span class="string">"*"</span>,</span><br><span class="line">        <span class="attr">"fxp/composer-asset-plugin"</span>: <span class="string">"^1.4"</span>,</span><br><span class="line">        <span class="attr">"symfony/var-dumper"</span>: <span class="string">"3.3.16"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"autoload"</span>: &#123;</span><br><span class="line">        <span class="attr">"files"</span>: [</span><br><span class="line">            <span class="string">"/usr/local/etc/php/debugHelper.php"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>docker-compose.yml</code> 并重启(需重新构建)</p>
 <figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">php:</span></span><br><span class="line"><span class="attr">  container_name:</span> <span class="string">php</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/data/php/debugHelper.php:/usr/local/etc/php/debugHelper.php</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/data/php/composer:/var/www/.composer</span></span><br></pre></td></tr></table></figure>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose up -d --build</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入容器, 更新 <code>composer</code> 自动加载</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it php /bin/bash</span><br><span class="line"><span class="comment"># 1.修改 /var/www 所属用户和组</span></span><br><span class="line">chown -R www-data:www-data /var/www</span><br><span class="line"><span class="comment"># 2.设置 www-data 用户可登录(查看用户ID可使用命令 id www-data)</span></span><br><span class="line">usermod -s /bin/bash -u 33 www-data</span><br><span class="line"><span class="comment"># 3.切换至 www-data</span></span><br><span class="line">su www-data</span><br><span class="line"><span class="comment"># 4.更新 composer 自动加载</span></span><br><span class="line">composer global dump-autoload</span><br><span class="line"><span class="comment"># 5.退出 www-data 用户</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="comment"># 6.重新设置 www-data 用户不可登录(查看用户ID可使用命令 id www-data)</span></span><br><span class="line">usermod -s /usr/sbin/nologin -u 33 www-data</span><br><span class="line"><span class="comment"># 7.退出容器</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<div class="note danger"><p>Docker PhpStorm + Xdebug</p></div>
<h5 id="编辑-docker-php-ext-xdebug-ini"><a href="#编辑-docker-php-ext-xdebug-ini" class="headerlink" title="编辑 docker-php-ext-xdebug.ini"></a>编辑 <code>docker-php-ext-xdebug.ini</code></h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">zend_extension=/usr/<span class="built_in">local</span>/lib/php/extensions/no-debug-non-zts-20170718/xdebug.so</span><br><span class="line">xdebug.profiler_enable=on</span><br><span class="line">xdebug.trace_output_dir=<span class="string">"/usr/local/php/xdebug_trace"</span></span><br><span class="line">xdebug.profiler_output_dir=<span class="string">"/usr/local/php/xdebug_profiler"</span></span><br><span class="line">xdebug.default_enable=0</span><br><span class="line">xdebug.remote_enable=1</span><br><span class="line">xdebug.remote_handler=dbgp</span><br><span class="line"><span class="comment">#宿主机IP</span></span><br><span class="line">xdebug.remote_host=192.168.0.7</span><br><span class="line">xdebug.remote_port=9001</span><br><span class="line">xdebug.remote_connect_back=0</span><br><span class="line">xdebug.remote_autostart=1</span><br><span class="line">xdebug.idekey=PHPSTORM</span><br><span class="line">xdebug.remote_log=/usr/<span class="built_in">local</span>/php/xdebug/remote.log</span><br></pre></td></tr></table></figure>
<h5 id="配置-PhpStorm"><a href="#配置-PhpStorm" class="headerlink" title="配置 PhpStorm"></a>配置 PhpStorm</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.配置端口</span></span><br><span class="line">Settings -&gt; Languages &amp; Frameworks -&gt; PHP -&gt; Debug -&gt; Debug port 配置端口与 xdebug 一致</span><br><span class="line"><span class="comment"># 2.映射目录(例：Windows - D:/docker/app/default -&gt; /data/app/default)</span></span><br><span class="line">Settings -&gt; Languages &amp; Frameworks -&gt; PHP -&gt; Servers -&gt; Use Path mappings -&gt; Absolute path on the server (docker 容器内的项目路径)</span><br></pre></td></tr></table></figure>
<h5 id="PhpStorm-启用监听即可"><a href="#PhpStorm-启用监听即可" class="headerlink" title="PhpStorm 启用监听即可"></a>PhpStorm 启用监听即可</h5><hr>
<div class="note danger"><p>Docker wkhtmltopdf, 基于原先打包好的 <code>sevming/php72:0.1</code> 镜像</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.运行容器</span></span><br><span class="line">docker run -itd --rm --name testPhp sevming/php72:0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.进入 php 容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it testPhp /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.安装软件</span></span><br><span class="line"><span class="built_in">set</span> -eux \</span><br><span class="line">    &amp;&amp; apt-get update \</span><br><span class="line">    &amp;&amp; apt-get install -y --no-install-recommends wget unzip fontconfig \</span><br><span class="line">    libfontenc1 libjpeg62-turbo libx11-6 libx11-data libxau6 libxcb1 \</span><br><span class="line">    libxdmcp6 libxext6 libxrender1 x11-common xfonts-75dpi \</span><br><span class="line">    xfonts-base xfonts-encodings xfonts-utils</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.安装 wkhtmltopdf</span></span><br><span class="line">wget https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.5/wkhtmltox_0.12.5-1.buster_amd64.deb -O wkhtmltox_0.12.5-1.buster_amd64.deb \</span><br><span class="line">    &amp;&amp; dpkg -i wkhtmltox_0.12.5-1.buster_amd64.deb    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># 5.清理无用的依赖包 </span></span><br><span class="line"><span class="built_in">set</span> -eux \</span><br><span class="line">    &amp;&amp; apt-get autoremove \</span><br><span class="line">    &amp;&amp; apt-get autoclean \</span><br><span class="line">    &amp;&amp; apt-get clean \</span><br><span class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 6.默认安装[微软雅黑], 字体安装参考 https://sevming.github.io/PHP/html-to-pdf-image.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.生成镜像</span></span><br><span class="line">docker build -t sevming/php72:0.2 .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.上传镜像</span></span><br><span class="line">docker push sevming/php72:0.2</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>dd</tag>
        <tag>xdebug</tag>
        <tag>wkhtmltoimage</tag>
        <tag>wkhtmltopdf</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker 搭建 LNMP + Redis</title>
    <url>/Docker/docker-lnmp-redis.html</url>
    <content><![CDATA[<div class="note danger"><p>软件安装前的准备工作</p></div> 
<h5 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a><a href="/Docker/docker-install.html">安装 Docker</a></h5><h5 id="创建项目及服务目录"><a href="#创建项目及服务目录" class="headerlink" title="创建项目及服务目录"></a>创建项目及服务目录</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir /data &amp;&amp; <span class="built_in">cd</span> /data</span><br><span class="line">mkdir -p php/conf.d php/logs nginx/conf.d nginx/cert nginx/logs mysql/data mysql/logs redis/data app/default</span><br></pre></td></tr></table></figure>
<h5 id="在-data-app-default-目录下创建测试用的项目文件"><a href="#在-data-app-default-目录下创建测试用的项目文件" class="headerlink" title="在 /data/app/default 目录下创建测试用的项目文件"></a>在 <code>/data/app/default</code> 目录下创建测试用的项目文件</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /data/app/default/index.php</span></span><br><span class="line">&lt;?php</span><br><span class="line">date_default_timezone_set(<span class="string">'PRC'</span>);</span><br><span class="line"><span class="built_in">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>);</span><br><span class="line"></span><br><span class="line">// Redis 测试</span><br><span class="line"><span class="variable">$redis</span> = new Redis();</span><br><span class="line"><span class="variable">$redis</span>-&gt;connect(<span class="string">'172.18.0.10'</span>, 6379);</span><br><span class="line"><span class="variable">$redis</span>-&gt;auth(<span class="string">'123456'</span>);</span><br><span class="line"><span class="variable">$redis</span>-&gt;<span class="built_in">set</span>(mt_rand(1, 9999), date(<span class="string">'Y-m-d H:i:s'</span>));</span><br><span class="line"></span><br><span class="line">// MySQL 测试</span><br><span class="line">try &#123;</span><br><span class="line">    <span class="variable">$dbh</span> = new PDO(<span class="string">'mysql:host=172.18.0.9;dbname=test'</span>, <span class="string">'root'</span>, <span class="string">'123456'</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$dbh</span>-&gt;query(<span class="string">'SHOW TABLES'</span>);</span><br><span class="line">    foreach (<span class="variable">$result</span> as <span class="variable">$row</span>) &#123;</span><br><span class="line">        var_dump(<span class="variable">$row</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; catch (PDOException <span class="variable">$e</span>) &#123;</span><br><span class="line">    var_dump(<span class="variable">$e</span>-&gt;getMessage());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">phpinfo();</span><br><span class="line"></span><br><span class="line"><span class="comment"># /data/app/default/index.html</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    It Works.</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h5 id="创建自定义网络"><a href="#创建自定义网络" class="headerlink" title="创建自定义网络"></a>创建自定义网络</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker network create --subnet=172.18.0.0/16 lnmp</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<hr>
<div class="note danger"><p>软件安装</p></div>
<h5 id="PHP-FPM"><a href="#PHP-FPM" class="headerlink" title="PHP-FPM"></a>PHP-FPM</h5><ol>
<li><p>复制配置文件</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/php</span><br><span class="line"><span class="comment"># 拉取 php-fpm</span></span><br><span class="line">docker pull php:7.2-fpm</span><br><span class="line"><span class="comment"># 复制 php.ini-development 到本地</span></span><br><span class="line">docker run --rm php:7.2-fpm cat /usr/<span class="built_in">local</span>/etc/php/php.ini-development &gt; php.ini</span><br><span class="line"><span class="comment"># 拉取 php-extension-installer</span></span><br><span class="line">docker pull mlocati/php-extension-installer</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 <code>Dockerfile</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM php:7.2-fpm</span><br><span class="line"></span><br><span class="line">RUN mv /etc/apt/sources.list /etc/apt/sources.list.bak \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">'deb http://mirrors.aliyun.com/debian/ buster main non-free contrib'</span> &gt; /etc/apt/sources.list \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">'deb http://mirrors.aliyun.com/debian/ buster-updates main non-free contrib'</span> &gt;&gt; /etc/apt/sources.list \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">'deb http://mirrors.aliyun.com/debian/ buster-backports main non-free contrib'</span> &gt;&gt; /etc/apt/sources.list \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">'deb http://mirrors.aliyun.com/debian-security buster/updates main'</span> &gt;&gt; /etc/apt/sources.list \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">'deb-src http://mirrors.aliyun.com/debian/ buster main non-free contrib'</span> &gt;&gt; /etc/apt/sources.list \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">'deb-src http://mirrors.aliyun.com/debian/ buster-updates main non-free contrib'</span> &gt;&gt; /etc/apt/sources.list \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">'deb-src http://mirrors.aliyun.com/debian/ buster-backports main non-free contrib'</span> &gt;&gt; /etc/apt/sources.list \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">'deb-src http://mirrors.aliyun.com/debian-security buster/updates main'</span> &gt;&gt; /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line">RUN apt update &amp;&amp; apt install -y wget &amp;&amp; apt install -y vim &amp;&amp; apt install -y iputils-ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install Extensions</span></span><br><span class="line">COPY --from=mlocati/php-extension-installer /usr/bin/install-php-extensions /usr/bin/</span><br><span class="line">RUN install-php-extensions zip gd xdebug redis \</span><br><span class="line">    &amp;&amp; docker-php-ext-install bcmath pcntl pdo_mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add Composer</span></span><br><span class="line">RUN php -r <span class="string">"copy('https://install.phpcomposer.com/installer', 'composer-setup.php');"</span> \</span><br><span class="line">    &amp;&amp; php composer-setup.php \</span><br><span class="line">    &amp;&amp; php -r <span class="string">"unlink('composer-setup.php');"</span> \</span><br><span class="line">    &amp;&amp; mv composer.phar /usr/<span class="built_in">local</span>/bin/composer</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成并上传镜像, 然后运行容器</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成镜像</span></span><br><span class="line">docker build -t sevming/php72:0.1 .</span><br><span class="line"><span class="comment"># 上传镜像</span></span><br><span class="line">docker push sevming/php72:0.1</span><br><span class="line"><span class="comment"># 运行容器</span></span><br><span class="line">docker run -itd --rm --name php --net lnmp --ip 172.18.0.7 -v /data/app:/data/app -v /data/php/php.ini:/usr/<span class="built_in">local</span>/etc/php/php.ini sevming/php72:0.1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h5><ol>
<li><p>复制配置文件</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/nginx</span><br><span class="line"><span class="comment"># 拉取 nginx</span></span><br><span class="line">docker pull nginx:1.19.0</span><br><span class="line"><span class="comment"># 复制 nginx.conf 到本地</span></span><br><span class="line">docker run --rm nginx:1.19.0 cat /etc/nginx/nginx.conf &gt; nginx.conf</span><br><span class="line"><span class="comment"># 复制 default.conf 至 conf.d 目录</span></span><br><span class="line">docker run --rm nginx:1.19.0 cat /etc/nginx/conf.d/default.conf &gt; ./conf.d/default.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 <code>default.conf</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#charset koi8-r;</span></span><br><span class="line">    <span class="comment">#access_log  /var/log/nginx/host.access.log  main;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#禁止使用ip直接访问</span></span><br><span class="line">    <span class="comment">#if ( $host ~* "\d+\.\d+\.\d+\.\d+" ) &#123;</span></span><br><span class="line">    <span class="comment">#   return 501;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /data/app/default;</span><br><span class="line">        index  index.php index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /data/app/default;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">    <span class="comment">#    proxy_pass   http://127.0.0.1;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        root           /data/app/default;</span><br><span class="line">        fastcgi_pass   172.18.0.7:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># deny access to .htaccess files, if Apache's document root</span></span><br><span class="line">    <span class="comment"># concurs with nginx's one</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#location ~ /\.ht &#123;</span></span><br><span class="line">    <span class="comment">#    deny  all;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># SSL 配置,不需要就注释</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#charset koi8-r;</span></span><br><span class="line">    <span class="comment">#access_log  /var/log/nginx/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/nginx/cert/default.pem;</span><br><span class="line">    ssl_certificate_key /etc/nginx/cert/default.key;</span><br><span class="line">    ssl_session_timeout 5m;</span><br><span class="line">    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /data/app/default;</span><br><span class="line">        index  index.php index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /data/app/default;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">    <span class="comment">#    proxy_pass   http://127.0.0.1;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        root           /data/app/default;</span><br><span class="line">        fastcgi_pass   172.18.0.7:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># deny access to .htaccess files, if Apache's document root</span></span><br><span class="line">    <span class="comment"># concurs with nginx's one</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#location ~ /\.ht &#123;</span></span><br><span class="line">    <span class="comment">#    deny  all;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 <code>Dockerfile</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM nginx:1.19.0</span><br><span class="line">RUN mkdir -p /data/app</span><br><span class="line">ENV TZ=Asia/Shanghai</span><br><span class="line">RUN ln -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="variable">$TZ</span> &gt; /etc/timezone</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成镜像并运行容器</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成镜像</span></span><br><span class="line">docker build -t sevming/nginx .</span><br><span class="line"><span class="comment"># 运行容器</span></span><br><span class="line">docker run -itd --rm --name nginx -p 80:80 -v /data/app:/data/app -v /data/nginx/nginx.conf:/etc/nginx/nginx.conf -v /data/nginx/conf.d:/etc/nginx/conf.d -v /data/nginx/cert:/etc/nginx/cert -v /data/nginx/logs:/var/<span class="built_in">log</span>/nginx --net lnmp --ip 172.18.0.8 sevming/nginx</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h5><ol>
<li><p>拉取镜像</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/mysql</span><br><span class="line"><span class="comment"># 拉取镜像</span></span><br><span class="line">docker pull mysql:5.7</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建 <code>my.cnf</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[client]</span><br><span class="line">port = 3306</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">port = 3306</span><br><span class="line">datadir = /var/lib/mysql</span><br><span class="line"></span><br><span class="line">character-set-server=utf8</span><br><span class="line"></span><br><span class="line">skip-name-resolve</span><br><span class="line"></span><br><span class="line">log_error = /var/<span class="built_in">log</span>/mysql/error.log</span><br><span class="line"></span><br><span class="line">sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建 <code>Dockerfile</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM mysql:5.7</span><br><span class="line">RUN chown -R mysql:mysql /var/<span class="built_in">log</span>/mysql</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成镜像并运行容器</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成镜像</span></span><br><span class="line">docker build -t sevming/mysql .</span><br><span class="line"><span class="comment"># 运行容器</span></span><br><span class="line">docker run --rm -itd --name mysql -p 3306:3306 -v /data/mysql/data:/var/lib/mysql -v /data/mysql/my.cnf:/etc/mysql/conf.d/my.cnf -v /data/mysql/logs:/var/<span class="built_in">log</span>/mysql --net lnmp --ip 172.18.0.9 -e MYSQL_ROOT_PASSWORD=123456 sevming/mysql</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h5><ol>
<li><p>进入 <code>redis</code> 目录 (<code>cd /data/redis</code>), 并新建 <code>redis.conf</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 持久化存储</span></span><br><span class="line">appendonly yes</span><br><span class="line"><span class="comment"># 密码设置</span></span><br><span class="line">requirepass 123456</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 <code>Dockerfile</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM redis:latest</span><br><span class="line">CMD [ <span class="string">"redis-server"</span>, <span class="string">"/usr/local/etc/redis.conf"</span> ]</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成镜像并运行容器</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成镜像</span></span><br><span class="line">docker build -t sevming/redis .</span><br><span class="line"><span class="comment"># 运行容器</span></span><br><span class="line">docker run --rm -d --name redis -p 6379:6379 -v /data/redis/data:/data -v /data/redis/redis.conf:/usr/<span class="built_in">local</span>/etc/redis.conf --net lnmp --ip 172.18.0.10 sevming/redis</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="浏览器访问-服务器IP"><a href="#浏览器访问-服务器IP" class="headerlink" title="浏览器访问 服务器IP"></a>浏览器访问 <code>服务器IP</code></h5><hr>
<div class="note danger"><p>以上这种方式, 需要一个个启动容器, 可以采用 <code>docker-compose</code> 来配置服务</p></div>
<h5 id="修改-data-nginx-conf-d-default-conf"><a href="#修改-data-nginx-conf-d-default-conf" class="headerlink" title="修改 /data/nginx/conf.d/default.conf"></a>修改 <code>/data/nginx/conf.d/default.conf</code></h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">location ~ \.php$ &#123;</span><br><span class="line">    root           /data/app/default;</span><br><span class="line">    fastcgi_pass   php:9000;</span><br><span class="line">    fastcgi_index  index.php;</span><br><span class="line">    fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">    include        fastcgi_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="新建-data-docker-compose-yml"><a href="#新建-data-docker-compose-yml" class="headerlink" title="新建 /data/docker-compose.yml"></a>新建 <code>/data/docker-compose.yml</code></h5><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  nginx:</span></span><br><span class="line"><span class="attr">    build:</span> <span class="string">./nginx</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">443</span><span class="string">:443</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/nginx/nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/nginx/cert:/etc/nginx/cert</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/nginx/logs:/var/log/nginx</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/app:/data/app</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      lnmp:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  php:</span></span><br><span class="line">    <span class="comment">#build: ./php</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">sevming/php72:0.1</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">php</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/php/php.ini:/usr/local/etc/php/php.ini</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/app:/data/app</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      lnmp:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.7</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  mysql:</span></span><br><span class="line"><span class="attr">    build:</span> <span class="string">./mysql</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">3306</span><span class="string">:3306</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/mysql/my.cnf:/etc/mysql/conf.d/my.cnf</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/mysql/data:/var/lib/mysql</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/mysql/logs:/var/log/mysql</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      MYSQL_ROOT_PASSWORD:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      lnmp:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.9</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  redis:</span></span><br><span class="line"><span class="attr">    build:</span> <span class="string">./redis</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/redis/redis.conf/:/usr/local/etc/redis.conf</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/data/redis/data:/data</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      lnmp:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  lnmp:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">bridge</span></span><br><span class="line"><span class="attr">    ipam:</span></span><br><span class="line"><span class="attr">      config:</span></span><br><span class="line"><span class="attr">        - subnet:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br></pre></td></tr></table></figure>
<h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># --build 重新构建</span></span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<hr>
<div class="note primary"><p>Windows 下使用 <code>Docker</code> 作为开发环境</p></div>
<h5 id="MySQL-1"><a href="#MySQL-1" class="headerlink" title="MySQL"></a>MySQL</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 需加入 --innodb-use-native-aio=0</span></span><br><span class="line">docker run --rm -itd --name mysql -p 3306:3306 -v /data/mysql/data:/var/lib/mysql -v /data/mysql/my.cnf:/etc/mysql/conf.d/my.cnf -v /data/mysql/logs:/var/<span class="built_in">log</span>/mysql --net lnmp --ip 172.18.0.9 -e MYSQL_ROOT_PASSWORD=123456 sevming/mysql --innodb-use-native-aio=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line">mysql:</span><br><span class="line">  build: ./mysql</span><br><span class="line">  container_name: mysql</span><br><span class="line">  <span class="built_in">command</span>: --innodb-use-native-aio=0</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>lnmp</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker 安装</title>
    <url>/Docker/docker-install.html</url>
    <content><![CDATA[<div class="note danger"><p>Linux 安装 Docker + docker-compose</p></div>
<blockquote><p><a href="https://docs.docker.com/engine/install/centos/#install-using-the-repository" target="_blank" rel="noopener">Docker</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.卸载旧版本</span></span><br><span class="line">sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 使用 Repository 安装</span></span><br><span class="line">sudo yum install -y yum-utils</span><br><span class="line">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment"># 若下载太慢,可替换镜像源</span></span><br><span class="line">sed -i <span class="string">'s/download.docker.com/mirrors.tuna.tsinghua.edu.cn\/docker-ce/g'</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.安装 docker</span></span><br><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.启动 docker</span></span><br><span class="line">sudo systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.卸载 docker</span></span><br><span class="line">sudo yum remove docker-ce docker-ce-cli containerd.io</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.删除所有镜像 </span></span><br><span class="line">sudo rm -rf /var/lib/docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.配置镜像源</span></span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"registry-mirrors"</span>: [<span class="string">"镜像源地址"</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.重启 docker</span></span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>
<blockquote><p><a href="https://docs.docker.com/compose/install/" target="_blank" rel="noopener">docker-compose</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -L https://github.com/docker/compose/releases/download/1.23.2/docker-compose-`uname -s`-`uname -m` &gt; /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line">chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<hr>
<div class="note danger"><p><a href="https://docs.docker.com/toolbox/toolbox_install_windows/" target="_blank" rel="noopener">Docker Toolbox</a> </p></div>
<blockquote><p>参考 <a href="https://blog.51cto.com/11954248/2478916" target="_blank" rel="noopener">本地目录挂载至 Docker 虚拟机</a>,设置 <code>D:\docker</code> 为共享文件夹</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置镜像源</span></span><br><span class="line">docker-machine ssh</span><br><span class="line">sudo sed -i <span class="string">"s|EXTRA_ARGS='|EXTRA_ARGS='\n--registry-mirror=镜像源地址 |g"</span> /var/lib/boot2docker/profile</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">docker-machine restart default</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载目录 /data 至 docker 目录</span></span><br><span class="line">docker-machine ssh</span><br><span class="line">sudo -i</span><br><span class="line">mkdir /data</span><br><span class="line">mount -t vboxsf docker /data</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<hr>
<div class="note danger"><p><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">Docker Desktop</a></p></div>
<blockquote><p>配置镜像源</p>
</blockquote>
<p><img src="/uploads/docker/docker-install/zq4QXU45oPySdUfze2a0AfS0gvkRy2Me.png" style="display:inline-block"></p>
<blockquote><p>配置共享文件夹</p>
</blockquote>
<p><img src="/uploads/docker/docker-install/wZL0oDxAKmSteCMXjGHSQAFN21tE1eck.png" style="display:inline-block"></p>
<hr>
<div class="note danger"><p>Docker Desktop + WSL 2</p></div>
<ol>
<li>Win10 版本要求 19041 及以上 , <a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10" target="_blank" rel="noopener">WSL 2 安装教程</a></li>
<li>注册 Microsoft 并安装 Ubuntu</li>
<li>更新 <a href="https://docs.microsoft.com/zh-cn/windows/wsl/wsl2-kernel" target="_blank" rel="noopener">WSL 2 Linux 内核</a></li>
<li>下载 Docker Desktop, 并 <a href="https://docs.docker.com/docker-for-windows/wsl/" target="_blank" rel="noopener">配置 WSL 2</a></li>
<li>Ubuntu 命令 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 IP</span></span><br><span class="line">ip addr</span><br><span class="line"><span class="comment"># Windows 的数据挂载在 Ubuntu /mnt 目录下</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<div class="note warning"><p>Windows 下 Docker Toolbox | Docker Desktop | Docker Desktop + WSL 2 区别, 建议使用 Docker Desktop</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Docker Toolbox：文件系统 I/0 慢, 一个 http 请求需要 1秒多</span><br><span class="line">Docker Desktop：一个 http 请求需要 200ms 上下</span><br><span class="line">Docker Desktop + WSL 2：文件系统 I/0 慢, 和 Docker Toolbox 差不多</span><br></pre></td></tr></table></figure>
<hr>
<div class="note default"><p>参考资料：<br><a href="https://blog.csdn.net/ljlfather/article/details/105477745" target="_blank" rel="noopener">获取阿里云镜像源</a></p></div>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>linux</tag>
        <tag>windows</tag>
      </tags>
  </entry>
  <entry>
    <title>Kafka 安装</title>
    <url>/Kafka/kafka-install.html</url>
    <content><![CDATA[<div class="note danger"><p>Windows Kafka 安装</p></div>
<ol>
<li><p>安装 JDK</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.下载 [JRE](https://www.oracle.com/java/technologies/javase-jre8-downloads.html) 并安装</span></span><br><span class="line"><span class="comment"># 2.系统环境变量 -&gt; 添加系统变量 -&gt; JAVA_HOME = D:\Web\Java\jre1.8.0_251</span></span><br><span class="line"><span class="comment"># 3.系统环境变量 -&gt; 编辑 Path 变量 -&gt; 添加路径 %JAVA_HOME%\bin</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 zookeeper</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.下载 [zookeeper](https://zookeeper.apache.org/releases.html#download) (bin 版,即安装包带bin的)</span></span><br><span class="line"><span class="comment"># 2.解压 apache-zookeeper-3.6.0-bin.tar.gz 至 D:\Web\kafka, 并进入 apache-zookeeper-3.6.0-bin\conf</span></span><br><span class="line"><span class="comment"># 3.重命名 zoo_sample.cfg 为 zoo.cfg</span></span><br><span class="line"><span class="comment"># 4.编辑 zoo.cfg</span></span><br><span class="line">    <span class="comment"># 修改 dataDir</span></span><br><span class="line">    dataDir = dataDir=D:/Web/kafka/apache-zookeeper-3.6.0-bin/data</span><br><span class="line">    <span class="comment"># 修改 admin.serverPort</span></span><br><span class="line">    admin.serverPort = 8888</span><br><span class="line"><span class="comment"># 5.系统环境变量 -&gt; 编辑 Path 变量 -&gt; 添加路径 D:\Web\kafka\apache-zookeeper-3.6.0-bin\bin</span></span><br><span class="line"><span class="comment"># 6.打开 CMD 窗口, 运行 zkserver</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 kafka</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.下载 [kafka](https://kafka.apache.org/downloads) (下载二进制版本)</span></span><br><span class="line"><span class="comment"># 2.解压 kafka_2.12-2.5.0.tgz 至 D:\Web\kafka</span></span><br><span class="line"><span class="comment"># 3.编辑 kafka_2.12-2.5.0/config/server.properties</span></span><br><span class="line">    log.dirs=D:/Web/kafka/kafka_2.12-2.5.0/kafka-logs</span><br><span class="line">    zookeeper.connect=localhost:2181</span><br><span class="line"><span class="comment"># 4.kafka 默认在9092端口上运行,并连接zookeeper的默认端口：2181</span></span><br><span class="line"><span class="comment"># 5.进入 kafka_2.12-2.5.0/bin/windows 并打开 CMD 窗口, 运行 .\kafka-server-start.bat ..\..\config\server.properties</span></span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>kafka</tag>
      </tags>
  </entry>
  <entry>
    <title>doctrine/migrations 数据库迁移</title>
    <url>/PHP/doctrine-migrations.html</url>
    <content><![CDATA[<div class="note danger"><p>doctrine/migrations 数据库迁移</p></div>
<ol>
<li><code>composer require &quot;doctrine/migrations:^2.0&quot;</code></li>
<li>整合至项目 <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">DBAL</span>\<span class="title">DBALException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">DBAL</span>\<span class="title">DriverManager</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">Migrations</span>\<span class="title">Configuration</span>\<span class="title">Configuration</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">Migrations</span>\<span class="title">Tools</span>\<span class="title">Console</span>\<span class="title">Command</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">Migrations</span>\<span class="title">Tools</span>\<span class="title">Console</span>\<span class="title">Helper</span>\<span class="title">ConfigurationHelper</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">DBAL</span>\<span class="title">Tools</span>\<span class="title">Console</span>\<span class="title">Helper</span>\<span class="title">ConnectionHelper</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Console</span>\<span class="title">Application</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Console</span>\<span class="title">Helper</span>\<span class="title">HelperSet</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Console</span>\<span class="title">Helper</span>\<span class="title">QuestionHelper</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* # 生成迁移脚本</span></span><br><span class="line"><span class="comment">* php migration.php migrations:generate</span></span><br><span class="line"><span class="comment">* # 执行迁移到指定版本或最新版本</span></span><br><span class="line"><span class="comment">* php migration.php migrations:migrate [first|prev|next|latest|版本号]</span></span><br><span class="line"><span class="comment">* # --dry-run 是空转参数,只显示操作结果,不执行修改</span></span><br><span class="line"><span class="comment">* php migration.php migrations:migrate --dry-run</span></span><br><span class="line"><span class="comment">* # 不执行操作,只写入文件,对于生产环境需要手动验证并执行的场景有用</span></span><br><span class="line"><span class="comment">* php migration.php migrations:migrate --write-sql=file.sql</span></span><br><span class="line"><span class="comment">* # 查看详细信息</span></span><br><span class="line"><span class="comment">* php migration.php status</span></span><br><span class="line"><span class="comment">* # 查看命令列表</span></span><br><span class="line"><span class="comment">* php migration.php list</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">$dbParams = [</span><br><span class="line">    <span class="string">'dbname'</span> =&gt; <span class="string">'test'</span>,</span><br><span class="line">    <span class="string">'user'</span> =&gt; <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'password'</span> =&gt; <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'host'</span> =&gt; <span class="string">'localhost'</span>,</span><br><span class="line">    <span class="string">'driver'</span> =&gt; <span class="string">'pdo_mysql'</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $connection = DriverManager::getConnection($dbParams);</span><br><span class="line">    <span class="comment">// 迁移组件</span></span><br><span class="line">    $configuration = <span class="keyword">new</span> Configuration($connection);</span><br><span class="line">    $configuration-&gt;setName(<span class="string">'test'</span>);                                                        <span class="comment">// 组件名称</span></span><br><span class="line">    $configuration-&gt;setMigrationsNamespace(<span class="string">'database\Migrations'</span>);                          <span class="comment">// 迁移类的命名空间</span></span><br><span class="line">    $configuration-&gt;setMigrationsTableName(<span class="string">'test_migration_versions'</span>);                      <span class="comment">// 迁移组件的表名</span></span><br><span class="line">    $configuration-&gt;setMigrationsDirectory(<span class="string">'D:\Web\Project\private\database\Migrations'</span>);   <span class="comment">// 迁移类的文件</span></span><br><span class="line">    $configuration-&gt;setAllOrNothing(<span class="keyword">true</span>);                                                  <span class="comment">// 是否在单个事务中包装多个迁移</span></span><br><span class="line">    $configuration-&gt;setCheckDatabasePlatform(<span class="keyword">true</span>);                                         <span class="comment">// 是否在生成代码的开头添加数据库平台检查</span></span><br><span class="line"></span><br><span class="line">    $helperSet = <span class="keyword">new</span> HelperSet();</span><br><span class="line">    $helperSet-&gt;set(<span class="keyword">new</span> QuestionHelper(), <span class="string">'question'</span>);</span><br><span class="line">    $helperSet-&gt;set(<span class="keyword">new</span> ConnectionHelper($connection), <span class="string">'db'</span>);</span><br><span class="line">    $helperSet-&gt;set(<span class="keyword">new</span> ConfigurationHelper($connection, $configuration));</span><br><span class="line"></span><br><span class="line">    $cli = <span class="keyword">new</span> Application(<span class="string">'Doctrine Migrations'</span>);</span><br><span class="line">    $cli-&gt;setCatchExceptions(<span class="keyword">true</span>);</span><br><span class="line">    $cli-&gt;setHelperSet($helperSet);</span><br><span class="line"></span><br><span class="line">    $cli-&gt;addCommands([</span><br><span class="line">        <span class="keyword">new</span> Command\DumpSchemaCommand(),</span><br><span class="line">        <span class="keyword">new</span> Command\ExecuteCommand(),</span><br><span class="line">        <span class="keyword">new</span> Command\GenerateCommand(),</span><br><span class="line">        <span class="keyword">new</span> Command\LatestCommand(),</span><br><span class="line">        <span class="keyword">new</span> Command\MigrateCommand(),</span><br><span class="line">        <span class="keyword">new</span> Command\RollupCommand(),</span><br><span class="line">        <span class="keyword">new</span> Command\StatusCommand(),</span><br><span class="line">        <span class="keyword">new</span> Command\VersionCommand()</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    $cli-&gt;run();</span><br><span class="line">&#125; <span class="keyword">catch</span> (DBALException $e) &#123;</span><br><span class="line">    <span class="keyword">exit</span>($e-&gt;getMessage() . PHP_EOL);</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">exit</span>($e-&gt;getMessage() . PHP_EOL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>migrations</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux 相关配置</title>
    <url>/Linux/linux-related-configuration.html</url>
    <content><![CDATA[<div class="note danger"><p>禁止 root 用户登录</p></div>
<ol>
<li><p>新建 test 用户并设置密码</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">useradd <span class="built_in">test</span></span><br><span class="line">passwd <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>ssh</code> 配置文件,去掉 <code>PermitRootLogin</code> 前面的 # 号,并将 <code>yes</code> 修改为 <code>no</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/ssh/sshd_config</span><br><span class="line">PermitRootLogin no</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启 ssh 服务</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service sshd restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <code>su root</code> 来获取 root 权限</p>
</li>
</ol>
<div class="note danger"><p>修改 ssh 默认端口</p></div>
<ol>
<li><p>修改 ssh 配置文件,去掉 <code>Port 22</code> 前面的 # 号,并添加为新的端口号 <code>6666</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/ssh/sshd_config</span><br><span class="line">Port 22</span><br><span class="line">Port 6666</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启 SSH 服务</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/etc/init.d/sshd restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启后使用 <code>6666</code> 端口测试能否登录,若可以,则把 <code>Port 22</code> 端口删除,如果不能登录,则查看防火墙是否开放 <code>6666</code> 端口</p>
</li>
</ol>
<a id="more"></a>
<div class="note danger"><p>配置阿里云 yum 源</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 禁用 yum插件 fastestmirror</span></span><br><span class="line">cp /etc/yum/pluginconf.d/fastestmirror.conf /etc/yum/pluginconf.d/fastestmirror.conf.bak </span><br><span class="line">vi /etc/yum/pluginconf.d/fastestmirror.conf</span><br><span class="line"><span class="comment"># 由1改为0, 禁用该插件</span></span><br><span class="line">enabled = 1         </span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改yum的配置文件</span></span><br><span class="line">cp /etc/yum.conf /etc/yum.conf.bak</span><br><span class="line">vi /etc/yum.conf</span><br><span class="line"><span class="comment"># 改为0, 不使用插件</span></span><br><span class="line">plugins=1         </span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取阿里云 repo</span></span><br><span class="line">cp /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak</span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">cp /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.bak </span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理原来的缓存,重新缓存 </span></span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>阿里云RDS数据库导出</title>
    <url>/Aliyun/rds-export-local.html</url>
    <content><![CDATA[<div class="note danger"><p>阿里云RDS数据库导出到本地 (MySql 5.7)</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 Percona XtraBackup 2.4</span></span><br><span class="line">yum install https://repo.percona.com/yum/percona-release-latest.noarch.rpm</span><br><span class="line">yum install percona-xtrabackup-24</span><br><span class="line"><span class="comment"># 安装 qpress</span></span><br><span class="line">wget http://www.quicklz.com/qpress-11-linux-x64.tar</span><br><span class="line">tar xvf qpress-11-linux-x64.tar</span><br><span class="line">chmod 775 qpress</span><br><span class="line">cp qpress /usr/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载数据库备份文件 (xbstream 文件包 _qp.xb 后缀)</span></span><br><span class="line">wget -c <span class="string">'&lt;数据备份文件外网下载地址&gt;'</span> -O test_qb.xb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一种(推荐)：</span></span><br><span class="line"><span class="comment"># 1.备份旧数据 </span></span><br><span class="line">mv /data/mysql /data/mysqlbak</span><br><span class="line"><span class="comment"># 2.解包 </span></span><br><span class="line"><span class="built_in">cd</span> /data/mysqlbak </span><br><span class="line">cat test_qp.xb | xbstream -x -v -C ./</span><br><span class="line"><span class="comment"># 3.解压</span></span><br><span class="line">innobackupex --decompress --remove-original ./</span><br><span class="line"><span class="comment"># 4.恢复解压好的备份文件</span></span><br><span class="line">innobackupex --defaults-file=./backup-my.cnf --apply-log ./</span><br><span class="line"><span class="comment"># 5.执行如下命令,修改文件属主</span></span><br><span class="line">chown -R mysql:mysql /data/mysql</span><br><span class="line"><span class="comment"># 6.启动MySQL进程</span></span><br><span class="line">service mysqld start</span><br><span class="line"><span class="comment"># 7.登录账号密码与RDS数据库的一致</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二种：</span></span><br><span class="line"><span class="comment"># 1.解包</span></span><br><span class="line">cat test_qb.xb | xbstream -x -v -C /home/mysql/data</span><br><span class="line"><span class="comment"># 2.解压</span></span><br><span class="line">innobackupex --decompress --remove-original /home/mysql/data</span><br><span class="line"><span class="comment"># 3.查询解压后生成的文件</span></span><br><span class="line">ls -l /home/mysql/data</span><br><span class="line"><span class="comment"># 4.恢复解压好的备份文件</span></span><br><span class="line">innobackupex --defaults-file=/home/mysql/data/backup-my.cnf --apply-log /home/mysql/data</span><br><span class="line"><span class="comment"># 5.为避免版本问题,需修改backup-my.cnf参数</span></span><br><span class="line">vi /home/mysql/data/backup-my.cnf</span><br><span class="line"><span class="comment">#innodb_log_checksum_algorithm</span></span><br><span class="line"><span class="comment">#innodb_fast_checksum</span></span><br><span class="line"><span class="comment">#innodb_log_block_size</span></span><br><span class="line"><span class="comment">#innodb_doublewrite_file</span></span><br><span class="line"><span class="comment">#rds_encrypt_data</span></span><br><span class="line"><span class="comment">#innodb_encrypt_algorithm</span></span><br><span class="line"><span class="comment">#redo_log_version</span></span><br><span class="line"><span class="comment">#master_key_id</span></span><br><span class="line"><span class="comment"># 说明</span></span><br><span class="line">如果自建数据库使用的是MyISAM引擎,和阿里云的InnoDB不兼容,需要多注释掉如下参数并增加skip-grant-tables参数</span><br><span class="line"><span class="comment">#innodb_log_checksum_algorithm=strict_crc32</span></span><br><span class="line"><span class="comment">#redo_log_version=1</span></span><br><span class="line">skip-grant-tables</span><br><span class="line"><span class="comment"># 如果自建数据库使用的是MyIAM引擎,且对系统表进行操作时报错（存储引擎相关），请按如下操作进行存储引擎的转换：</span></span><br><span class="line">alter engine &lt;表名&gt; engine=myisam;</span><br><span class="line"><span class="comment"># 6.执行如下命令,修改文件属主,并确定文件所属为MySQL用户</span></span><br><span class="line">chown -R mysql:mysql /home/mysql</span><br><span class="line"><span class="comment"># 7.执行如下命令,启动MySQL进程</span></span><br><span class="line">mysqld_safe --defaults-file=/home/mysql/data/backup-my.cnf --user=mysql --datadir=/home/mysql/data &amp;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Aliyun</category>
      </categories>
      <tags>
        <tag>aliyun</tag>
      </tags>
  </entry>
  <entry>
    <title>Beanstalkd 队列</title>
    <url>/PHP/beanstalkd.html</url>
    <content><![CDATA[<div class="note danger"><p>场景：订单超时事件、礼品券过期事件, 类似这些场景的, 都可以使用延迟队列来处理, 由于 beanstalkd 是单进程, 可以考虑结合 workerman 创建多进程来处理任务</p></div>
<h5 id="文档地址"><a href="#文档地址" class="headerlink" title="文档地址"></a>文档地址</h5><p><a href="https://www.kancloud.cn/vson/php-message-queue/891904" target="_blank" rel="noopener">https://www.kancloud.cn/vson/php-message-queue/891904</a></p>
<h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://github.com/beanstalkd/beanstalkd/archive/v1.11.tar.gz</span><br><span class="line">tar -zxvf v1.11.tar.gz</span><br><span class="line"><span class="built_in">cd</span> beanstalkd-1.11</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="comment">#查看版本</span></span><br><span class="line">beanstalkd -v</span><br><span class="line"><span class="comment">#启动 - 若 127.0.0.1 设为 0.0.0.0, 则都可以连接</span></span><br><span class="line">beanstalkd -l 127.0.0.1 -p 11300 -b /data/beanstalkd/binlog &amp;</span><br></pre></td></tr></table></figure>
<h5 id="相关工具"><a href="#相关工具" class="headerlink" title="相关工具"></a>相关工具</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># beanstalk CLI 工具</span></span><br><span class="line">wget https://github.com/src<span class="_">-d</span>/beanstool/releases/download/v0.2.0/beanstool_v0.2.0_linux_amd64.tar.gz</span><br><span class="line">tar -zxvf beanstool_v0.2.0_linux_amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> beanstool_v0.2.0_linux_amd64/</span><br><span class="line">./beanstool stats</span><br><span class="line"></span><br><span class="line"><span class="comment"># beanstalkd 可视化界面</span></span><br><span class="line">wget https://github.com/xuri/aurora/releases/download/2.2/aurora_linux_amd64_v2.2.tar.gz</span><br><span class="line">tar -zxvf aurora_linux_amd64_v2.2.tar.gz</span><br><span class="line">./aurora</span><br><span class="line"><span class="comment">#需开放对应的端口,如果是搭建在虚拟机,主机需要访问时,需配置 aurora.toml, 配置 listen 的监听IP为虚拟机IP 即可, 切记, 配置的IP为 ip addr 命令下的IP, 如果是阿里云服务器, 配置的是私有IP, 访问的时候使用公网IP + 端口</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># producer</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Pheanstalk</span>\<span class="title">Pheanstalk</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'../vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">$pheanstalk = Pheanstalk::create(<span class="string">'127.0.0.1'</span>, <span class="number">11300</span>);</span><br><span class="line"></span><br><span class="line">$tubeName = <span class="string">'test'</span>;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt;= <span class="number">10</span>; $i++) &#123;</span><br><span class="line">    $nowTime = date(<span class="string">'Y-m-d H:i:s'</span>);</span><br><span class="line">    $delay = mt_rand(<span class="number">1</span>, <span class="number">20</span>);</span><br><span class="line">    $job = [</span><br><span class="line">        <span class="string">'id'</span> =&gt; $i,</span><br><span class="line">        <span class="string">'delay'</span> =&gt; $delay,</span><br><span class="line">        <span class="string">'runTime'</span> =&gt; date(<span class="string">'Y-m-d H:i:s'</span>, strtotime($nowTime) + $delay),</span><br><span class="line">    ];</span><br><span class="line">    $pheanstalk-&gt;useTube($tubeName)</span><br><span class="line">        -&gt;put(json_encode($job), <span class="number">0</span>, $job[<span class="string">'delay'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># consumer</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Pheanstalk</span>\<span class="title">Pheanstalk</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'../vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">$worker = <span class="keyword">new</span> Worker();</span><br><span class="line">$worker-&gt;count = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">$pheanstalk = Pheanstalk::create(<span class="string">'127.0.0.1'</span>, <span class="number">11300</span>);</span><br><span class="line"></span><br><span class="line">$worker-&gt;onWorkerStart = <span class="function"><span class="keyword">function</span> <span class="params">($worker)</span> <span class="title">use</span> <span class="params">($pheanstalk)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $tubeName = <span class="string">'test'</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            $job = $pheanstalk-&gt;watch($tubeName)-&gt;ignore(<span class="string">'default'</span>)-&gt;reserve();</span><br><span class="line">            $data = json_decode($job-&gt;getData(), <span class="keyword">true</span>);</span><br><span class="line">            file_put_contents(<span class="string">'./test.log'</span>, <span class="string">"当前进程ID："</span> . posix_getpid() . <span class="string">", 任务ID：&#123;$data['id']&#125;, 任务预定时间：&#123;$data['runTime']&#125;, 当前时间："</span> . date(<span class="string">'Y-m-d H:i:s'</span>) . PHP_EOL, FILE_APPEND);</span><br><span class="line">            $pheanstalk-&gt;delete($job);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        print_r($e-&gt;getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Worker::runAll();</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="Windows-安装-Beanstalkd"><a href="#Windows-安装-Beanstalkd" class="headerlink" title="Windows 安装 Beanstalkd"></a>Windows 安装 Beanstalkd</h5><ol>
<li><p>下载并安装 <a href="http://www.cygwin.com/" target="_blank" rel="noopener">cygwin</a></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. 添加镜像地址 - http://mirrors.aliyun.com</span><br><span class="line">2. 下载 `gcc`、`gcc-core`、`make`、`automake`, 在 Devel 分支下</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载 <a href="https://github.com/caidongyun/beanstalkd-win" target="_blank" rel="noopener">beanstalkd-win</a> 包</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. 解压并进入beanstalkd-win目录</span><br><span class="line">2. 打开CMD窗口,运行 ./beanstalkd.exe -l 127.0.0.1 -p 11300</span><br></pre></td></tr></table></figure>
</li>
</ol>
<!-- more -->
<ol>
<li><p><a href="https://github.com/mariuswilms/queue/tree/master/libs/beanstalk/src/Socket" target="_blank" rel="noopener">PHP Beanstalkd Service</a></p>
 <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* beanstalk: A minimalistic PHP beanstalk client.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Copyright (c) 2009-2013 David Persson</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Distributed under the terms of the MIT License.</span></span><br><span class="line"><span class="comment">* Redistributions of files must retain the above copyright notice.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@copyright</span>  2009-2013 David Persson &lt;nperson<span class="doctag">@gmx</span>.de&gt;</span></span><br><span class="line"><span class="comment">* <span class="doctag">@license</span>    http://www.opensource.org/licenses/mit-license.php The MIT License</span></span><br><span class="line"><span class="comment">* <span class="doctag">@link</span>       http://github.com/davidpersson/beanstalk</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* An interface to the beanstalk queue service. Implements the beanstalk</span></span><br><span class="line"><span class="comment">* protocol spec 1.2. Where appropriate the documentation from the protcol has</span></span><br><span class="line"><span class="comment">* been added to the docblocks in this class.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@link</span> https://github.com/kr/beanstalkd/blob/master/doc/protocol.txt</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeanstalkdService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Holds a boolean indicating whether a connection to the server is</span></span><br><span class="line"><span class="comment">    * currently established or not.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> boolean</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> $connected = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Holds configuration values.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> $_config = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The current connection resource handle (if any).</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> resource</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> $_connection;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Generated errors. Will hold a maximum of 200 error messages at any time</span></span><br><span class="line"><span class="comment">    * to prevent pilling up messages and using more and more memory. This is</span></span><br><span class="line"><span class="comment">    * especially important if this class is used in long-running workers.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> Socket_Beanstalk::errors()</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> Socket_Beanstalk::_error()</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> $_errors = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Constructor.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> array $config     An array of configuration values:</span></span><br><span class="line"><span class="comment">    *                          - `'persistent'`  Whether to make the connection persistent or</span></span><br><span class="line"><span class="comment">    *                          not, defaults to `true` as the FAQ recommends</span></span><br><span class="line"><span class="comment">    *                          persistent connections.</span></span><br><span class="line"><span class="comment">    *                          - `'host'`        The beanstalk server hostname or IP address to</span></span><br><span class="line"><span class="comment">    *                          connect to, defaults to `127.0.0.1`.</span></span><br><span class="line"><span class="comment">    *                          - `'port'`        The port of the server to connect to, defaults</span></span><br><span class="line"><span class="comment">    *                          to `11300`.</span></span><br><span class="line"><span class="comment">    *                          - `'timeout'`     Timeout in seconds when establishing the</span></span><br><span class="line"><span class="comment">    *                          connection, defaults to `1`.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array $config = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $defaults = [</span><br><span class="line">            <span class="string">'persistent'</span> =&gt; <span class="keyword">true</span>,</span><br><span class="line">            <span class="string">'host'</span> =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">            <span class="string">'port'</span> =&gt; <span class="number">11300</span>,</span><br><span class="line">            <span class="string">'timeout'</span> =&gt; <span class="number">1</span></span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_config = $config + $defaults;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Destructor, disconnects from the server.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;disconnect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Initiates a socket connection to the beanstalk server. The resulting</span></span><br><span class="line"><span class="comment">    * stream will not have any timeout set on it. Which means it can wait an</span></span><br><span class="line"><span class="comment">    * unlimited amount of time until a packet becomes available. This is</span></span><br><span class="line"><span class="comment">    * required for doing blocking reads.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> boolean `true` if the connection was established, `false` otherwise.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> Socket_Beanstalk::reserve()</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> Socket_Beanstalk::$_connection</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;_connection)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;disconnect();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $function = <span class="keyword">$this</span>-&gt;_config[<span class="string">'persistent'</span>] ? <span class="string">'pfsockopen'</span> : <span class="string">'fsockopen'</span>;</span><br><span class="line">        $errNum = <span class="keyword">null</span>;</span><br><span class="line">        $errStr = <span class="keyword">null</span>;</span><br><span class="line">        $params = [<span class="keyword">$this</span>-&gt;_config[<span class="string">'host'</span>], <span class="keyword">$this</span>-&gt;_config[<span class="string">'port'</span>], &amp;$errNum, &amp;$errStr];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;_config[<span class="string">'timeout'</span>]) &#123;</span><br><span class="line">            $params[] = <span class="keyword">$this</span>-&gt;_config[<span class="string">'timeout'</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_connection = @call_user_func_array($function, $params);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($errNum) || !<span class="keyword">empty</span>($errStr)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_error(<span class="string">"&#123;$errNum&#125;: &#123;$errStr&#125;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;connected = is_resource(<span class="keyword">$this</span>-&gt;_connection);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;connected) &#123;</span><br><span class="line">            stream_set_timeout(<span class="keyword">$this</span>-&gt;_connection, <span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;connected;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Closes the connection to the beanstalk server.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> boolean `true` if diconnecting was successful.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">disconnect</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!is_resource(<span class="keyword">$this</span>-&gt;_connection)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;connected = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;connected = !fclose(<span class="keyword">$this</span>-&gt;_connection);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;connected) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_connection = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> !<span class="keyword">$this</span>-&gt;connected;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns collected error messages.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> array An array of error messages.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">errors</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_errors;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Pushes an error message to `Beanstalk::$_errors`. Ensures</span></span><br><span class="line"><span class="comment">    * that at any point there are not more than 200 messages.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string $message The error message.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_error</span><span class="params">($message)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (count(<span class="keyword">$this</span>-&gt;_errors) &gt;= <span class="number">200</span>) &#123;</span><br><span class="line">            array_shift(<span class="keyword">$this</span>-&gt;_errors);</span><br><span class="line">        &#125;</span><br><span class="line">        array_push(<span class="keyword">$this</span>-&gt;_errors, $message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Writes a packet to the socket. Prior to writing to the socket will check</span></span><br><span class="line"><span class="comment">    * for availability of the connection.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string $data</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> integer|boolean number of written bytes or `false` on error.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_write</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;connected &amp;&amp; !<span class="keyword">$this</span>-&gt;connect()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $data .= <span class="string">"\r\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> fwrite(<span class="keyword">$this</span>-&gt;_connection, $data, strlen($data));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Reads a packet from the socket. Prior to reading from the socket will</span></span><br><span class="line"><span class="comment">    * check for availability of the connection.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> int $length Number of bytes to read.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean Data or `false` on error.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_read</span><span class="params">($length = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;connected &amp;&amp; !<span class="keyword">$this</span>-&gt;connect()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($length) &#123;</span><br><span class="line">            <span class="keyword">if</span> (feof(<span class="keyword">$this</span>-&gt;_connection)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $data = stream_get_contents(<span class="keyword">$this</span>-&gt;_connection, $length + <span class="number">2</span>);</span><br><span class="line">            $meta = stream_get_meta_data(<span class="keyword">$this</span>-&gt;_connection);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ($meta[<span class="string">'timed_out'</span>]) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_error(<span class="string">'Connection timed out.'</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $packet = rtrim($data, <span class="string">"\r\n"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $packet = stream_get_line(<span class="keyword">$this</span>-&gt;_connection, <span class="number">16384</span>, <span class="string">"\r\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $packet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Producer Commands */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The `put` command is for any process that wants to insert a job into the queue.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> integer $pri   Jobs with smaller priority values will be scheduled</span></span><br><span class="line"><span class="comment">    *                       before jobs with larger priorities. The most urgent priority is</span></span><br><span class="line"><span class="comment">    *                       0; the least urgent priority is 4294967295.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> integer $delay Seconds to wait before putting the job in the</span></span><br><span class="line"><span class="comment">    *                       ready queue.  The job will be in the "delayed" state during this time.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> integer $ttr   Time to run - Number of seconds to allow a worker to</span></span><br><span class="line"><span class="comment">    *                       run this job.  The minimum ttr is 1.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string  $data  The job body.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> integer|boolean `false` on error otherwise an integer indicating</span></span><br><span class="line"><span class="comment">    *         the job id.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">put</span><span class="params">($pri, $delay, $ttr, $data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(sprintf(<span class="string">"put %d %d %d %d\r\n%s"</span>, $pri, $delay, $ttr, strlen($data), $data));</span><br><span class="line">        $status = strtok(<span class="keyword">$this</span>-&gt;_read(), <span class="string">' '</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($status) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'INSERTED'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'BURIED'</span>:</span><br><span class="line">                <span class="keyword">return</span> (integer)strtok(<span class="string">' '</span>); <span class="comment">// job id</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'EXPECTED_CRLF'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'JOB_TOO_BIG'</span>:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_error($status);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The `use` command is for producers. Subsequent put commands will put jobs into</span></span><br><span class="line"><span class="comment">    * the tube specified by this command. If no use command has been issued, jobs</span></span><br><span class="line"><span class="comment">    * will be put into the tube named `default`.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * Please note that while obviously this method should better be named</span></span><br><span class="line"><span class="comment">    * `use` it is not. This is because `use` is a reserved keyword in PHP.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string $tube A name at most 200 bytes. It specifies the tube to</span></span><br><span class="line"><span class="comment">    *                     use.  If the tube does not exist, it will be created.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean `false` on error otherwise the name of the tube.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">choose</span><span class="params">($tube)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(sprintf(<span class="string">'use %s'</span>, $tube));</span><br><span class="line">        $status = strtok(<span class="keyword">$this</span>-&gt;_read(), <span class="string">' '</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($status) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'USING'</span>:</span><br><span class="line">                <span class="keyword">return</span> strtok(<span class="string">' '</span>);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_error($status);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Alias for choose.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string $tube</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> Socket_Beanstalk::choose()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">useTube</span><span class="params">($tube)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;choose($tube);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Worker Commands */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Reserve a job (with a timeout)</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> integer $timeout If given specifies number of seconds to wait for</span></span><br><span class="line"><span class="comment">    *                         a job. 0 returns immediately.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> array|false `false` on error otherwise an array holding job id</span></span><br><span class="line"><span class="comment">    *         and body.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">reserve</span><span class="params">($timeout = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($timeout)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_write(sprintf(<span class="string">'reserve-with-timeout %d'</span>, $timeout));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_write(<span class="string">'reserve'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $status = strtok(<span class="keyword">$this</span>-&gt;_read(), <span class="string">' '</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($status) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'RESERVED'</span>:</span><br><span class="line">                <span class="keyword">return</span> [</span><br><span class="line">                    <span class="string">'id'</span> =&gt; (integer)strtok(<span class="string">' '</span>),</span><br><span class="line">                    <span class="string">'body'</span> =&gt; <span class="keyword">$this</span>-&gt;_read((integer)strtok(<span class="string">' '</span>))</span><br><span class="line">                ];</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'DEADLINE_SOON'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'TIMED_OUT'</span>:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_error($status);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Removes a job from the server entirely.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> integer $id The id of the job.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> boolean `false` on error, `true` on success.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span><span class="params">($id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(sprintf(<span class="string">'delete %d'</span>, $id));</span><br><span class="line">        $status = <span class="keyword">$this</span>-&gt;_read();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($status) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'DELETED'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'NOT_FOUND'</span>:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_error($status);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Puts a reserved job back into the ready queue.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> integer $id    The id of the job.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> integer $pri   Priority to assign to the job.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> integer $delay Number of seconds to wait before putting the job in the ready queue.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> boolean `false` on error, `true` on success.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">release</span><span class="params">($id, $pri, $delay)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(sprintf(<span class="string">'release %d %d %d'</span>, $id, $pri, $delay));</span><br><span class="line">        $status = <span class="keyword">$this</span>-&gt;_read();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($status) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'RELEASED'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'BURIED'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'NOT_FOUND'</span>:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_error($status);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Puts a job into the `buried` state Buried jobs are put into a FIFO</span></span><br><span class="line"><span class="comment">    * linked list and will not be touched until a client kicks them.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> integer $id  The id of the job.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> integer $pri *New* priority to assign to the job.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> boolean `false` on error, `true` on success.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bury</span><span class="params">($id, $pri)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(sprintf(<span class="string">'bury %d %d'</span>, $id, $pri));</span><br><span class="line">        $status = <span class="keyword">$this</span>-&gt;_read();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($status) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'BURIED'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'NOT_FOUND'</span>:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_error($status);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Allows a worker to request more time to work on a job</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> integer $id The id of the job.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> boolean `false` on error, `true` on success.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">touch</span><span class="params">($id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(sprintf(<span class="string">'touch %d'</span>, $id));</span><br><span class="line">        $status = <span class="keyword">$this</span>-&gt;_read();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($status) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'TOUCHED'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'NOT_TOUCHED'</span>:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_error($status);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Adds the named tube to the watch list for the current</span></span><br><span class="line"><span class="comment">    * connection.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string $tube Name of tube to watch.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> integer|boolean `false` on error otherwise number of tubes in watch list.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">watch</span><span class="params">($tube)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(sprintf(<span class="string">'watch %s'</span>, $tube));</span><br><span class="line">        $status = strtok(<span class="keyword">$this</span>-&gt;_read(), <span class="string">' '</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($status) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'WATCHING'</span>:</span><br><span class="line">                <span class="keyword">return</span> (integer)strtok(<span class="string">' '</span>);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_error($status);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Remove the named tube from the watch list.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string $tube Name of tube to ignore.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> integer|boolean `false` on error otherwise number of tubes in watch list.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ignore</span><span class="params">($tube)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(sprintf(<span class="string">'ignore %s'</span>, $tube));</span><br><span class="line">        $status = strtok(<span class="keyword">$this</span>-&gt;_read(), <span class="string">' '</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($status) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'WATCHING'</span>:</span><br><span class="line">                <span class="keyword">return</span> (integer)strtok(<span class="string">' '</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'NOT_IGNORED'</span>:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_error($status);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Other Commands */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Inspect a job by its id.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> integer $id The id of the job.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean `false` on error otherwise the body of the job.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">peek</span><span class="params">($id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(sprintf(<span class="string">'peek %d'</span>, $id));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_peekRead();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Inspect the next ready job.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean `false` on error otherwise the body of the job.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">peekReady</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(<span class="string">'peek-ready'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_peekRead();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Inspect the job with the shortest delay left.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean `false` on error otherwise the body of the job.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">peekDelayed</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(<span class="string">'peek-delayed'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_peekRead();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Inspect the next job in the list of buried jobs.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean `false` on error otherwise the body of the job.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">peekBuried</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(<span class="string">'peek-buried'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_peekRead();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Handles response for all peek methods.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean|array `false` on error otherwise the body of the job.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_peekRead</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $status = strtok(<span class="keyword">$this</span>-&gt;_read(), <span class="string">' '</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($status) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'FOUND'</span>:</span><br><span class="line">                <span class="keyword">return</span> [</span><br><span class="line">                    <span class="string">'id'</span> =&gt; (integer)strtok(<span class="string">' '</span>),</span><br><span class="line">                    <span class="string">'body'</span> =&gt; <span class="keyword">$this</span>-&gt;_read((integer)strtok(<span class="string">' '</span>))</span><br><span class="line">                ];</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'NOT_FOUND'</span>:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_error($status);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Moves jobs into the ready queue (applies to the current tube).</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * If there are buried jobs those get kicked only otherwise</span></span><br><span class="line"><span class="comment">    * delayed jobs get kicked.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> integer $bound Upper bound on the number of jobs to kick.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> integer|boolean False on error otherwise number of job kicked.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">kick</span><span class="params">($bound)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(sprintf(<span class="string">'kick %d'</span>, $bound));</span><br><span class="line">        $status = strtok(<span class="keyword">$this</span>-&gt;_read(), <span class="string">' '</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($status) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'KICKED'</span>:</span><br><span class="line">                <span class="keyword">return</span> (integer)strtok(<span class="string">' '</span>);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_error($status);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Stats Commands */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Gives statistical information about the specified job if it exists.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> integer $id The job id</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean `false` on error otherwise a string with a yaml formatted dictionary</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">statsJob</span><span class="params">($id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(sprintf(<span class="string">'stats-job %d'</span>, $id));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_statsRead();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Gives statistical information about the specified tube if it exists.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string $tube Name of the tube.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean `false` on error otherwise a string with a yaml formatted dictionary.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">statsTube</span><span class="params">($tube)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(sprintf(<span class="string">'stats-tube %s'</span>, $tube));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_statsRead();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Gives statistical information about the system as a whole.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean `false` on error otherwise a string with a yaml formatted dictionary.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stats</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(<span class="string">'stats'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_statsRead();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns a list of all existing tubes.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean `false` on error otherwise a string with a yaml formatted list.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listTubes</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(<span class="string">'list-tubes'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_statsRead();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns the tube currently being used by the producer.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean `false` on error otherwise a string with the name of the tube.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listTubeUsed</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(<span class="string">'list-tube-used'</span>);</span><br><span class="line">        $status = strtok(<span class="keyword">$this</span>-&gt;_read(), <span class="string">' '</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($status) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'USING'</span>:</span><br><span class="line">                <span class="keyword">return</span> strtok(<span class="string">' '</span>);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_error($status);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Alias for listTubeUsed.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean `false` on error otherwise a string with the name of the tube.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> Socket_Beanstalk::listTubeUsed()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listTubeChosen</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;listTubeUsed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns a list of tubes currently being watched by the worker.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|boolean `false` on error otherwise a string with a yaml formatted list.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listTubesWatched</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_write(<span class="string">'list-tubes-watched'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_statsRead();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Handles responses for all stat methods.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> boolean $decode Whether to decode data before returning it or not. Default is `true`.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> array|string|boolean `false` on error otherwise statistical data.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_statsRead</span><span class="params">($decode = true)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $status = strtok(<span class="keyword">$this</span>-&gt;_read(), <span class="string">' '</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($status) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'OK'</span>:</span><br><span class="line">                $data = <span class="keyword">$this</span>-&gt;_read((integer)strtok(<span class="string">' '</span>));</span><br><span class="line">                <span class="keyword">return</span> $decode ? <span class="keyword">$this</span>-&gt;_decode($data) : $data;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_error($status);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Decodes YAML data. This is a super naive decoder which just works on a</span></span><br><span class="line"><span class="comment">    * subset of YAML which is commonly returned by beanstalk.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string $data The data in YAML format, can be either a list or a dictionary.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> array An (associative) array of the converted data.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_decode</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $data = array_slice(explode(<span class="string">"\n"</span>, $data), <span class="number">1</span>);</span><br><span class="line">        $result = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($value[<span class="number">0</span>] === <span class="string">'-'</span>) &#123;</span><br><span class="line">                $value = ltrim($value, <span class="string">'- '</span>);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (strpos($value, <span class="string">':'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">                <span class="keyword">list</span>($key, $value) = explode(<span class="string">':'</span>, $value);</span><br><span class="line">                $value = ltrim($value, <span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is_numeric($value)) &#123;</span><br><span class="line">                $value = (integer)$value == $value ? (integer)$value : (float)$value;</span><br><span class="line">            &#125;</span><br><span class="line">            $result[$key] = $value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用方法</p>
 <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'BeanstalkdService.php'</span>;</span><br><span class="line"></span><br><span class="line">$beanstalk = <span class="keyword">new</span> BeanstalkdService([</span><br><span class="line">    <span class="string">'persistent'</span> =&gt; <span class="keyword">false</span>,  <span class="comment">// 是否长连接</span></span><br><span class="line">    <span class="string">'host'</span> =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'port'</span> =&gt; <span class="number">11300</span>,        <span class="comment">// 端口号默认11300</span></span><br><span class="line">    <span class="string">'timeout'</span> =&gt; <span class="number">3</span>          <span class="comment">// 连接超时时间</span></span><br><span class="line">]);</span><br><span class="line"><span class="comment">// 判断beanstalk是否已连接</span></span><br><span class="line"><span class="keyword">if</span> (!$beanstalk-&gt;connect()) &#123;</span><br><span class="line">    <span class="keyword">exit</span>(current($beanstalk-&gt;errors()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用test这个tube</span></span><br><span class="line"><span class="comment">//$beanstalk-&gt;useTube('test');</span></span><br><span class="line"><span class="comment">//// 往tube增加数据</span></span><br><span class="line"><span class="comment">//// 参数意义:10表示任务的优先级,0不等待直接放到ready队列中,60处理job的超时时间,job内容</span></span><br><span class="line"><span class="comment">//$put = $beanstalk-&gt;put(10, 0, 60, 'test');</span></span><br><span class="line"><span class="comment">//if (!$put) &#123;</span></span><br><span class="line"><span class="comment">//    exit('commit job fail');</span></span><br><span class="line"><span class="comment">//&#125; else &#123;</span></span><br><span class="line"><span class="comment">//    var_dump($put);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">set_time_limit(<span class="number">0</span>);</span><br><span class="line">$beanstalk-&gt;watch(<span class="string">'test'</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        $job = $beanstalk-&gt;reserve();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($job)) &#123;</span><br><span class="line">            $beanstalk-&gt;delete($job[<span class="string">'id'</span>]);</span><br><span class="line">            file_put_contents(<span class="string">'D:/test.txt'</span>, json_encode($job) . PHP_EOL, FILE_APPEND);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    $beanstalk-&gt;disconnect();</span><br><span class="line">    <span class="keyword">exit</span>($e-&gt;getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>beanstalkd</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP 商品SKU</title>
    <url>/PHP/goods-sku.html</url>
    <content><![CDATA[<div class="note danger"><p>商品SKU<br><code>ps: 暂时只有新增, 后续补充编辑</code></p></div>
<h5 id="创建相关表"><a href="#创建相关表" class="headerlink" title="创建相关表"></a>创建相关表</h5><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`goods`</span> (</span><br><span class="line"><span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'商品ID'</span>,</span><br><span class="line"><span class="string">`goods_title`</span> <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品标题'</span>,</span><br><span class="line"><span class="string">`generate_time`</span> DATETIME <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'商品表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`goods_sku`</span> (</span><br><span class="line"><span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'SKU ID'</span>,</span><br><span class="line"><span class="string">`goods_id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品ID'</span>,</span><br><span class="line"><span class="string">`title`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'集成名称'</span>,</span><br><span class="line"><span class="string">`price`</span> <span class="built_in">DECIMAL</span>(<span class="number">11</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'价格'</span>,</span><br><span class="line"><span class="string">`stock`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'库存'</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'商品SKU信息表'</span>;</span><br><span class="line"> *</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`goods_sku_serial`</span> (</span><br><span class="line"><span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line"><span class="string">`goods_id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品ID'</span>,</span><br><span class="line"><span class="string">`goods_sku_id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品SKU ID'</span>,</span><br><span class="line"><span class="string">`goods_spec_type_id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品规格类型ID'</span>,</span><br><span class="line"><span class="string">`goods_spec_type_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品规格类型名称'</span>,</span><br><span class="line"><span class="string">`goods_spec_value_id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品规格类型值ID'</span>,</span><br><span class="line"><span class="string">`goods_spec_value_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品规格类型值名称'</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'SKU与规格关系表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`goods_spec_type`</span> (</span><br><span class="line"><span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'规格类型ID'</span>,</span><br><span class="line"><span class="string">`goods_id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品ID'</span>,</span><br><span class="line"><span class="string">`type_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'规格类型名称'</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line"><span class="keyword">KEY</span> <span class="string">`goods_id`</span> (<span class="string">`goods_id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'商品规格类型表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`goods_spec_value`</span> (</span><br><span class="line"><span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'规格项ID'</span>,</span><br><span class="line"><span class="string">`goods_id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品ID'</span>,</span><br><span class="line"><span class="string">`spec_type_id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'规格类型ID'</span>,</span><br><span class="line"><span class="string">`value_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'规格项名称'</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line"><span class="keyword">KEY</span> <span class="string">`goods_id`</span> (<span class="string">`goods_id`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line"><span class="keyword">KEY</span> <span class="string">`spec_type_id`</span> (<span class="string">`spec_type_id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'商品规格项表'</span>;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="前端代码"><a href="#前端代码" class="headerlink" title="前端代码"></a>前端代码</h5><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>SKU<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"static/plugin/bootstrap/css/bootstrap.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"static/plugin/font-awesome/css/font-awesome.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"static/plugin/toastr/toastr.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"static/jquery-3.3.1.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"static/plugin/bootstrap/js/bootstrap.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"static/plugin/toastr/toastr.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">        a, a:focus, a:hover &#123;text-decoration: none;&#125;</span></span><br><span class="line"><span class="undefined">        .c-red &#123;</span></span><br><span class="line"><span class="undefined">            color: red;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        #goods-spec &#123;</span></span><br><span class="line"><span class="undefined">            /*display: none;*/</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        #goods-spec .spec &#123;</span></span><br><span class="line"><span class="undefined">            margin-bottom: 15px;</span></span><br><span class="line"><span class="undefined">            padding: 10px;</span></span><br><span class="line"><span class="undefined">            border: 1px solid #E7EAEC;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        #goods-spec .spec .spec-items .spec-item &#123;</span></span><br><span class="line"><span class="undefined">            position: relative;</span></span><br><span class="line"><span class="undefined">            float: left;</span></span><br><span class="line"><span class="undefined">            width: 250px;</span></span><br><span class="line"><span class="undefined">            margin: 0 10px 10px 0;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        #goods-spec .spec .spec-items .spec-item:last-child &#123;</span></span><br><span class="line"><span class="undefined">            margin-bottom: -5px;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        #goods-spec .spec-btn-table &#123;</span></span><br><span class="line"><span class="undefined">            margin-bottom: 15px;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        #goods-spec .spec-btn-table &gt; tbody &gt; tr &gt; td &#123;</span></span><br><span class="line"><span class="undefined">            padding-left: 0;</span></span><br><span class="line"><span class="undefined">            border: 0;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        #goods-spec .spec-btn-table .alert-danger &#123;</span></span><br><span class="line"><span class="undefined">            margin-bottom: 0;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        #goods-spec .table &gt; thead &gt; tr &gt; th, #goods-spec .table &gt; tbody &gt; tr &gt; td &#123;</span></span><br><span class="line"><span class="undefined">            vertical-align: middle;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        #goods-spec .spec-btn-table &gt; tbody &gt; tr:last-child &#123;</span></span><br><span class="line"><span class="undefined">            display: none;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        #goods-spec .spec-btn-table a &#123;</span></span><br><span class="line"><span class="undefined">            margin-right: 10px;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        #goods-spec .sku .sku-title &#123;</span></span><br><span class="line"><span class="undefined">            padding-bottom: 10px;</span></span><br><span class="line"><span class="undefined">            text-align: center;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        #goods-spec .sku .table &#123;</span></span><br><span class="line"><span class="undefined">            table-layout: fixed;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        #goods-spec .sku .table input &#123;</span></span><br><span class="line"><span class="undefined">            font-weight: normal;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-horizontal"</span> <span class="attr">action</span>=<span class="string">"sku.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"goods-spec"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"alert alert-info"</span>&gt;</span></span><br><span class="line">                    1. 更改规格及规格项后请点击下方的【刷新规格项目表】来更新数据<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                    2. 每一种规格代表不同型号,例如颜色为一种规格,尺寸为一种规格,如果设置多规格,手机用户必须每一种规格都选择一个规格项,才能添加购物车或购买</span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"specs"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table spec-btn-table"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">id</span>=<span class="string">"add-spec"</span> <span class="attr">title</span>=<span class="string">"添加规格"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-plus"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 添加规格<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">title</span>=<span class="string">"刷新规格项目表"</span> <span class="attr">class</span>=<span class="string">"btn btn-danger refresh-spec"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-refresh"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 刷新规格项目表<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"alert alert-danger"</span>&gt;</span>警告：规格数据有变动，请重新点击上方 [刷新规格项目表] 按钮！<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"sku"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-success"</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">        $(function() &#123;</span></span><br><span class="line"><span class="undefined">            toastr.options = &#123;</span></span><br><span class="line"><span class="undefined">                closeButton: true,</span></span><br><span class="line"><span class="undefined">                progressBar: true,</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            $('form').on('submit', function () &#123;</span></span><br><span class="line"><span class="undefined">                $.ajax(&#123;</span></span><br><span class="line"><span class="undefined">                    url: 'sku.php',</span></span><br><span class="line"><span class="undefined">                    type: 'POST',</span></span><br><span class="line"><span class="undefined">                    data: $('form').serialize(),</span></span><br><span class="line"><span class="undefined">                    success: function () &#123;</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                return false;</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            $(document).on('input propertychange change', '.specs input', function () &#123;</span></span><br><span class="line"><span class="undefined">                window.optionchanged = true;</span></span><br><span class="line"><span class="undefined">                $('.spec-btn-table &gt; tbody &gt; tr:last-child').show();</span></span><br><span class="line"><span class="undefined">            &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            let goodsSku = &#123;&#125;;</span></span><br><span class="line"><span class="undefined">            // 添加规格</span></span><br><span class="line"><span class="undefined">            $('#add-spec').on('click', function () &#123;</span></span><br><span class="line"><span class="undefined">                let specid = (new Date()).valueOf().toString(16);</span></span><br><span class="line"><span class="undefined">                let html = `</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"spec"</span> <span class="attr">id</span>=<span class="string">"spec-$&#123;specid&#125;"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-12"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"spec[$&#123;specid&#125;]"</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">class</span>=<span class="string">"form-control spec-title"</span> <span class="attr">placeholder</span>=<span class="string">"规格名称 (比如: 颜色)"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group-btn"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">specid</span>=<span class="string">"$&#123;specid&#125;"</span> <span class="attr">class</span>=<span class="string">"btn btn-info add-spec-item"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-plus"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 添加规格项<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">                                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">specid</span>=<span class="string">"$&#123;specid&#125;"</span> <span class="attr">class</span>=<span class="string">"btn btn-danger remove-spec"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-remove"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-12"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"spec-items-$&#123;specid&#125;"</span> <span class="attr">class</span>=<span class="string">"spec-items"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="undefined">            `;</span></span><br><span class="line"><span class="undefined">                $('.specs').append(html);</span></span><br><span class="line"><span class="undefined">            &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            // 删除规格</span></span><br><span class="line"><span class="undefined">            $(document).on('click', '.remove-spec', function () &#123;</span></span><br><span class="line"><span class="undefined">                $('#spec-' + $(this).attr('specid')).remove();</span></span><br><span class="line"><span class="undefined">            &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            // 添加规格项</span></span><br><span class="line"><span class="undefined">            $(document).on('click', '.add-spec-item', function () &#123;</span></span><br><span class="line"><span class="undefined">                let specid = $(this).attr('specid');</span></span><br><span class="line"><span class="undefined">                let specitemid = (new Date()).valueOf().toString(16);</span></span><br><span class="line"><span class="undefined">                let html = `</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"spec-item"</span> <span class="attr">data-specitemid</span>=<span class="string">"$&#123;specitemid&#125;"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control spec-item-title"</span> <span class="attr">name</span>=<span class="string">"spec_item[$&#123;specid&#125;][$&#123;specitemid&#125;]"</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">placeholder</span>=<span class="string">"规格项"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"input-group-addon"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"remove-spec-item"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-times"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="undefined">            `;</span></span><br><span class="line"><span class="undefined">                $('#spec-items-' + specid).append(html);</span></span><br><span class="line"><span class="undefined">                let len = $('#spec-items-' + specid + ' .spec-item-title').length -1;</span></span><br><span class="line"><span class="undefined">                $('#spec-items-' + specid + ' .spec-item-title:eq(' + len +  ')').focus();</span></span><br><span class="line"><span class="undefined">            &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            // 删除规格项</span></span><br><span class="line"><span class="undefined">            $(document).on('click', '.remove-spec-item', function () &#123;</span></span><br><span class="line"><span class="undefined">                $(this).closest('.spec-item').remove();</span></span><br><span class="line"><span class="undefined">            &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            // 规格项目批量设置</span></span><br><span class="line"><span class="undefined">            $(document).on('click', '.sku-all', function() &#123;</span></span><br><span class="line"><span class="undefined">                let cls = '.sku-' + $(this).data('text');</span></span><br><span class="line"><span class="undefined">                $(cls).val($(cls + '-all').val());</span></span><br><span class="line"><span class="undefined">            &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            // 刷新规格项目表</span></span><br><span class="line"><span class="undefined">            $('.refresh-spec').on('click', refreshSpec);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            // 刷新规格项目表</span></span><br><span class="line"><span class="undefined">            function refreshSpec() &#123;</span></span><br><span class="line"><span class="xml">                let html = '<span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table table-bordered table-condensed"</span>&gt;</span><span class="tag">&lt;<span class="name">thead</span>&gt;</span><span class="tag">&lt;<span class="name">tr</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span>';</span></span><br><span class="line"><span class="undefined">                let specs = [];</span></span><br><span class="line"><span class="undefined">                let specFlag = true;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                // 未添加规格</span></span><br><span class="line"><span class="undefined">                if ($('.spec').length &lt;= 0) &#123;</span></span><br><span class="line"><span class="undefined">                    return;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                // 获取规格/规格项JSON数据</span></span><br><span class="line"><span class="undefined">                $('.spec').each(function(i) &#123;</span></span><br><span class="line"><span class="undefined">                    let _this = $(this);</span></span><br><span class="line"><span class="undefined">                    let specTitle = _this.find('.spec-title').val();</span></span><br><span class="line"><span class="undefined">                    if (!specTitle || specTitle === 'undefined') &#123;</span></span><br><span class="line"><span class="undefined">                        specFlag = false;</span></span><br><span class="line"><span class="undefined">                        _this.find('.spec-title').focus();</span></span><br><span class="line"><span class="undefined">                        toastr.error('规格名称不能为空!');</span></span><br><span class="line"><span class="undefined">                        return;</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                    let spec = &#123;title: specTitle&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                    if (_this.find('.spec-item').length &lt;= 0) &#123;</span></span><br><span class="line"><span class="undefined">                        specFlag = false;</span></span><br><span class="line"><span class="undefined">                        toastr.error('请先添加规格项!');</span></span><br><span class="line"><span class="undefined">                        return;</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                    let items = [];</span></span><br><span class="line"><span class="undefined">                    _this.find('.spec-item').each(function() &#123;</span></span><br><span class="line"><span class="undefined">                        let __this = $(this);</span></span><br><span class="line"><span class="undefined">                        let itemTitle = __this.find('.spec-item-title').val();</span></span><br><span class="line"><span class="undefined">                        if (!itemTitle || itemTitle === 'undefined') &#123;</span></span><br><span class="line"><span class="undefined">                            specFlag = false;</span></span><br><span class="line"><span class="undefined">                            __this.find('.spec-item-title').focus();</span></span><br><span class="line"><span class="undefined">                            toastr.error('规格项不能为空!');</span></span><br><span class="line"><span class="undefined">                            return;</span></span><br><span class="line"><span class="undefined">                        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                        let item = &#123;</span></span><br><span class="line"><span class="undefined">                            id: __this.data('specitemid'),</span></span><br><span class="line"><span class="undefined">                            title: itemTitle,</span></span><br><span class="line"><span class="undefined">                        &#125;;</span></span><br><span class="line"><span class="undefined">                        items.push(item);</span></span><br><span class="line"><span class="undefined">                    &#125;);</span></span><br><span class="line"><span class="undefined">                    spec.items = items;</span></span><br><span class="line"><span class="undefined">                    specs.push(spec);</span></span><br><span class="line"><span class="undefined">                &#125;);</span></span><br><span class="line"><span class="undefined">                if (!specFlag) return;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                // 计算规格的所有组合,并生成rowSpans</span></span><br><span class="line"><span class="undefined">                let specLen = specs.length;</span></span><br><span class="line"><span class="undefined">                // 规格的所有组合</span></span><br><span class="line"><span class="undefined">                let skuNums = 1;</span></span><br><span class="line"><span class="undefined">                // 规格表格数组</span></span><br><span class="line"><span class="undefined">                let specTable = new Array(specLen);</span></span><br><span class="line"><span class="undefined">                // 单元格的rowSpan</span></span><br><span class="line"><span class="undefined">                let rowSpans = new Array(specLen);</span></span><br><span class="line"><span class="undefined">                for (let i = 0; i &lt; specLen; i++) &#123;</span></span><br><span class="line"><span class="xml">                    html += '<span class="tag">&lt;<span class="name">th</span>&gt;</span>' + specs[i].title + '<span class="tag">&lt;/<span class="name">th</span>&gt;</span>';</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                    let itemLen = specs[i].items.length;</span></span><br><span class="line"><span class="undefined">                    if (itemLen &lt;= 0) &#123;</span></span><br><span class="line"><span class="undefined">                        itemLen = 1;</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                    skuNums *= itemLen;</span></span><br><span class="line"><span class="undefined">                    specTable[i] = new Array(skuNums);</span></span><br><span class="line"><span class="undefined">                    for (let j = 0; j &lt; skuNums; j++) &#123;</span></span><br><span class="line"><span class="undefined">                        specTable[i][j] = new Array();</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                    itemLen = specs[i].items.length;</span></span><br><span class="line"><span class="undefined">                    rowSpans[i] = 1;</span></span><br><span class="line"><span class="undefined">                    for (let j = i + 1; j &lt; specLen; j++) &#123;</span></span><br><span class="line"><span class="undefined">                        rowSpans[i] *= specs[j].items.length;</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                html += `</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"sku-title"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"c-red"</span>&gt;</span>* <span class="tag">&lt;/<span class="name">span</span>&gt;</span>价格 (元)<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">class</span>=<span class="string">"form-control input-sm sku-price-all"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"input-group-addon"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"fa fa-angle-double-down sku-all"</span> <span class="attr">data-text</span>=<span class="string">"price"</span> <span class="attr">title</span>=<span class="string">"批量设置"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"sku-title"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"c-red"</span>&gt;</span>* <span class="tag">&lt;/<span class="name">span</span>&gt;</span>数量 (件)<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">class</span>=<span class="string">"form-control input-sm sku-stock-all"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"input-group-addon"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"fa fa-angle-double-down sku-all"</span> <span class="attr">data-text</span>=<span class="string">"stock"</span> <span class="attr">title</span>=<span class="string">"批量设置"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="undefined">            `;</span></span><br><span class="line"><span class="xml">                html += '<span class="tag">&lt;/<span class="name">tr</span>&gt;</span><span class="tag">&lt;/<span class="name">thead</span>&gt;</span>';</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                // 规格表格数据填充</span></span><br><span class="line"><span class="undefined">                for (let m = 0; m &lt; specLen; m++) &#123;</span></span><br><span class="line"><span class="undefined">                    let itemIndex = 0, k = 0;</span></span><br><span class="line"><span class="undefined">                    for (let j = 0; j &lt; skuNums; j++) &#123;</span></span><br><span class="line"><span class="undefined">                        let rowSpan = rowSpans[m];</span></span><br><span class="line"><span class="undefined">                        let specItem = specs[m].items[itemIndex] || &#123;&#125;;</span></span><br><span class="line"><span class="undefined">                        let specItemTitle = !specItem.title || specItem.title === 'undefined' ? '' : specItem.title;</span></span><br><span class="line"><span class="undefined">                        let tdData = &#123;</span></span><br><span class="line"><span class="undefined">                            id: specItem.id,</span></span><br><span class="line"><span class="undefined">                            title: specItemTitle,</span></span><br><span class="line"><span class="undefined">                            html: '',</span></span><br><span class="line"><span class="undefined">                        &#125;;</span></span><br><span class="line"><span class="undefined">                        if (j % rowSpan === 0) &#123;</span></span><br><span class="line"><span class="xml">                            tdData.html = '<span class="tag">&lt;<span class="name">td</span> <span class="attr">rowspan</span>=<span class="string">"' + rowSpan + '"</span>&gt;</span>' + specItemTitle + '<span class="tag">&lt;/<span class="name">td</span>&gt;</span>';</span></span><br><span class="line"><span class="undefined">                        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                        specTable[m][j] = tdData;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                        k++;</span></span><br><span class="line"><span class="undefined">                        if (k === rowSpan) &#123;</span></span><br><span class="line"><span class="undefined">                            itemIndex++;</span></span><br><span class="line"><span class="undefined">                            if (itemIndex &gt; specs[m].items.length - 1) &#123;</span></span><br><span class="line"><span class="undefined">                                itemIndex = 0;</span></span><br><span class="line"><span class="undefined">                            &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                            k = 0;</span></span><br><span class="line"><span class="undefined">                        &#125;</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                // 生成规格项目表</span></span><br><span class="line"><span class="undefined">                let specTableHtml = '';</span></span><br><span class="line"><span class="undefined">                for (let i = 0; i &lt; skuNums; i++) &#123;</span></span><br><span class="line"><span class="xml">                    specTableHtml += '<span class="tag">&lt;<span class="name">tr</span>&gt;</span>';</span></span><br><span class="line"><span class="undefined">                    let ids = [], titles = [];</span></span><br><span class="line"><span class="undefined">                    for (let j = 0; j &lt; specLen; j++) &#123;</span></span><br><span class="line"><span class="undefined">                        specTableHtml += specTable[j][i].html;</span></span><br><span class="line"><span class="undefined">                        ids.push(specTable[j][i].id);</span></span><br><span class="line"><span class="undefined">                        titles.push(specTable[j][i].title);</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                    ids = ids.join('_');</span></span><br><span class="line"><span class="undefined">                    let skuData = &#123;</span></span><br><span class="line"><span class="undefined">                        id: goodsSku.hasOwnProperty(ids) ? goodsSku[ids].id : 0,</span></span><br><span class="line"><span class="undefined">                        price: goodsSku.hasOwnProperty(ids) ? goodsSku[ids].price : '',</span></span><br><span class="line"><span class="undefined">                        stock: goodsSku.hasOwnProperty(ids) ? goodsSku[ids].stock : '',</span></span><br><span class="line"><span class="undefined">                    &#125;;</span></span><br><span class="line"><span class="undefined">                    specTableHtml += `</span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">td</span> <span class="attr">rowspan</span>=<span class="string">"1"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"sku[$&#123;ids&#125;][id]"</span> <span class="attr">value</span>=<span class="string">"$&#123;skuData.id&#125;"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"sku[$&#123;ids&#125;][price]"</span> <span class="attr">value</span>=<span class="string">"$&#123;skuData.price&#125;"</span> <span class="attr">class</span>=<span class="string">"form-control sku-price"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">td</span> <span class="attr">rowspan</span>=<span class="string">"1"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"sku[$&#123;ids&#125;][stock]"</span> <span class="attr">value</span>=<span class="string">"$&#123;skuData.stock&#125;"</span> <span class="attr">class</span>=<span class="string">"form-control sku-stock"</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="undefined">                    `;</span></span><br><span class="line"><span class="xml">                    specTableHtml += '<span class="tag">&lt;/<span class="name">tr</span>&gt;</span>';</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                html += specTableHtml;</span></span><br><span class="line"><span class="xml">                html += '<span class="tag">&lt;/<span class="name">table</span>&gt;</span>';</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                $('.sku').html(html);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                // 刷新后重置</span></span><br><span class="line"><span class="undefined">                window.optionchanged = false;</span></span><br><span class="line"><span class="undefined">                $('.spec-btn-table &gt; tbody &gt; tr:last-child').hide();</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="服务端代码"><a href="#服务端代码" class="headerlink" title="服务端代码"></a>服务端代码</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$postData = $_POST;</span><br><span class="line"><span class="comment">// 商品规格</span></span><br><span class="line">$specArray = $_POST[<span class="string">'spec'</span>];</span><br><span class="line"><span class="comment">// 商品规格项</span></span><br><span class="line">$specItemArray = $_POST[<span class="string">'spec_item'</span>];</span><br><span class="line"><span class="comment">// 商品SKU</span></span><br><span class="line">$skuArray = $_POST[<span class="string">'sku'</span>];</span><br><span class="line"><span class="comment">// SKU所有组合数量</span></span><br><span class="line">$skuNums = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// 商品规格及规格项校验</span></span><br><span class="line"><span class="keyword">foreach</span> ($specArray <span class="keyword">as</span> $specId =&gt; $specName) &#123;</span><br><span class="line">    $specItem = $specItemArray[$specId] ?? [];</span><br><span class="line">    <span class="keyword">if</span> (!$specItem || <span class="keyword">empty</span>($specName)) &#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">'商品规格参数错误'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($specItem <span class="keyword">as</span> $itemName) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($itemName)) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">'商品规格参数错误'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $skuNums *= count($specItem);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 商品SKU一次不能生成太多,容易造成内存溢出</span></span><br><span class="line"><span class="keyword">if</span> (count($skuArray) &gt; <span class="number">500</span>) &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">'商品规格项目生成数量过多,请求失败'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 商品SKU</span></span><br><span class="line"><span class="keyword">if</span> (count($skuArray) !== $skuNums) &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">'商品规格参数错误'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TODO 若严格点校验的话,可通过商品规格和规格项生成SKU,再进行验证</span></span><br><span class="line"><span class="keyword">foreach</span> ($skuArray <span class="keyword">as</span> &amp;$sku) &#123;</span><br><span class="line">    $sku = [</span><br><span class="line">        <span class="string">'price'</span> =&gt; bcadd($sku[<span class="string">'price'</span>], <span class="number">0</span>, <span class="number">2</span>),</span><br><span class="line">        <span class="string">'stock'</span> =&gt; (int)$sku[<span class="string">'stock'</span>],</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unset</span>($sku);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $config = [</span><br><span class="line">        <span class="string">'host'</span> =&gt; <span class="string">'localhost'</span>,</span><br><span class="line">        <span class="string">'dbname'</span> =&gt; <span class="string">'test'</span>,</span><br><span class="line">        <span class="string">'username'</span> =&gt; <span class="string">'root'</span>,</span><br><span class="line">        <span class="string">'password'</span> =&gt; <span class="string">'root'</span>,</span><br><span class="line">    ];</span><br><span class="line">    $prefix = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    $conn = <span class="keyword">new</span> PDO(<span class="string">"mysql:host=&#123;$config['host']&#125;;dbname=&#123;$config['dbname']&#125;"</span>, $config[<span class="string">'username'</span>], $config[<span class="string">'password'</span>]);</span><br><span class="line">    $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);</span><br><span class="line">    <span class="comment">// 开启事务</span></span><br><span class="line">    $conn-&gt;beginTransaction();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存商品</span></span><br><span class="line">    $sth = $conn-&gt;prepare(<span class="string">"INSERT INTO &#123;$prefix&#125;goods(goods_title, generate_time) VALUES(:goodsTitle, :generateTime)"</span>);</span><br><span class="line">    $sth-&gt;execute([</span><br><span class="line">        <span class="string">':goodsTitle'</span> =&gt; <span class="string">'test'</span> . mt_rand(),</span><br><span class="line">        <span class="string">':generateTime'</span> =&gt; date(<span class="string">'Y-m-d H:i:s'</span>)</span><br><span class="line">    ]);</span><br><span class="line">    <span class="comment">// 商品ID</span></span><br><span class="line">    $goodsId = $conn-&gt;lastInsertId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 商品规格项</span></span><br><span class="line">    $specValueArray = [];</span><br><span class="line">    <span class="comment">// 保存商品规格及规格项</span></span><br><span class="line">    <span class="keyword">foreach</span> ($specArray <span class="keyword">as</span> $specId =&gt; $specName) &#123;</span><br><span class="line">        <span class="comment">// 保存商品规格类型</span></span><br><span class="line">        $sth = $conn-&gt;prepare(<span class="string">"INSERT INTO &#123;$prefix&#125;goods_spec_type(goods_id, type_name) VALUES(:goodsId, :specName)"</span>);</span><br><span class="line">        $sth-&gt;execute([</span><br><span class="line">            <span class="string">':goodsId'</span> =&gt; $goodsId,</span><br><span class="line">            <span class="string">':specName'</span> =&gt; $specName,</span><br><span class="line">        ]);</span><br><span class="line">        <span class="comment">// 规格类型ID</span></span><br><span class="line">        $specTypeId = $conn-&gt;lastInsertId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($specItemArray[$specId] <span class="keyword">as</span> $specValueId =&gt; $specValueName) &#123;</span><br><span class="line">            <span class="comment">// 保存商品规格项</span></span><br><span class="line">            $sth = $conn-&gt;prepare(<span class="string">"INSERT INTO &#123;$prefix&#125;goods_spec_value(goods_id, spec_type_id, value_name) VALUES(:goodsId, :specTypeId, :specValueName)"</span>);</span><br><span class="line">            $sth-&gt;execute([</span><br><span class="line">                <span class="string">':goodsId'</span> =&gt; $goodsId,</span><br><span class="line">                <span class="string">':specTypeId'</span> =&gt; $specTypeId,</span><br><span class="line">                <span class="string">':specValueName'</span> =&gt; $specValueName,</span><br><span class="line">            ]);</span><br><span class="line">            <span class="comment">// 规格项ID</span></span><br><span class="line">            $specTypeValueId = $conn-&gt;lastInsertId();</span><br><span class="line">            <span class="comment">// SKU信息</span></span><br><span class="line">            $specValueArray[$specValueId] = [</span><br><span class="line">                <span class="string">'specId'</span> =&gt; $specTypeId,</span><br><span class="line">                <span class="string">'specName'</span> =&gt; $specName,</span><br><span class="line">                <span class="string">'specValueId'</span> =&gt; $specTypeValueId,</span><br><span class="line">                <span class="string">'specValueName'</span> =&gt; $specValueName,</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存商品SKU</span></span><br><span class="line">    <span class="keyword">foreach</span> ($skuArray <span class="keyword">as</span> $specValueIds =&gt; $sku) &#123;</span><br><span class="line">        $specValueIdArray = explode(<span class="string">'_'</span>, $specValueIds);</span><br><span class="line">        $skuTitle = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($specValueIdArray <span class="keyword">as</span> $specValueId) &#123;</span><br><span class="line">            $skuTitle .= $specValueArray[$specValueId][<span class="string">'specName'</span>] . <span class="string">':'</span> . $specValueArray[$specValueId][<span class="string">'specValueName'</span>] . <span class="string">'  '</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存商品SKU信息</span></span><br><span class="line">        $sth = $conn-&gt;prepare(<span class="string">"INSERT INTO &#123;$prefix&#125;goods_sku(goods_id, title, price, stock) VALUES(:goodsId, :skuTitle, :skuPrice, :skuStock)"</span>);</span><br><span class="line">        $sth-&gt;execute([</span><br><span class="line">            <span class="string">':goodsId'</span> =&gt; $goodsId,</span><br><span class="line">            <span class="string">':skuTitle'</span> =&gt; $skuTitle,</span><br><span class="line">            <span class="string">':skuPrice'</span> =&gt; $sku[<span class="string">'price'</span>],</span><br><span class="line">            <span class="string">':skuStock'</span> =&gt; $sku[<span class="string">'stock'</span>]</span><br><span class="line">        ]);</span><br><span class="line">        <span class="comment">// SKU ID</span></span><br><span class="line">        $skuId = $conn-&gt;lastInsertId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存商品SKU与规格关系</span></span><br><span class="line">        <span class="keyword">foreach</span> ($specValueIdArray <span class="keyword">as</span> $specValueId) &#123;</span><br><span class="line">            $specValue = $specValueArray[$specValueId];</span><br><span class="line">            $sth = $conn-&gt;prepare(<span class="string">"INSERT INTO &#123;$prefix&#125;goods_sku_serial(goods_id, goods_sku_id, goods_spec_type_id, goods_spec_type_name, goods_spec_value_id, goods_spec_value_name) VALUES(:goodsId, :skuId, :specTypeId, :specTypeName, :specValueId, :specValueName)"</span>);</span><br><span class="line">            $sth-&gt;execute([</span><br><span class="line">                <span class="string">':goodsId'</span> =&gt; $goodsId,</span><br><span class="line">                <span class="string">':skuId'</span> =&gt; $skuId,</span><br><span class="line">                <span class="string">':specTypeId'</span> =&gt; $specValue[<span class="string">'specId'</span>],</span><br><span class="line">                <span class="string">':specTypeName'</span> =&gt; $specValue[<span class="string">'specName'</span>],</span><br><span class="line">                <span class="string">':specValueId'</span> =&gt; $specValue[<span class="string">'specValueId'</span>],</span><br><span class="line">                <span class="string">':specValueName'</span> =&gt; $specValue[<span class="string">'specValueName'</span>],</span><br><span class="line">            ]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提交事务</span></span><br><span class="line">    $conn-&gt;commit();</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="comment">// 事务回滚</span></span><br><span class="line">    <span class="keyword">isset</span>($conn) &amp;&amp; $conn-&gt;rollBack();</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"ERROR: &#123;$e-&gt;getMessage()&#125;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>sku</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL SQL 查询相关</title>
    <url>/MySQL/mysql-sql.html</url>
    <content><![CDATA[<div class="note danger"><p>MySql COUNT 加 IF 条件</p></div>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">#以下两条SQL查询结果一致</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="number">1</span>) <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> account_status = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="keyword">IF</span>(account_status = <span class="number">0</span>, <span class="literal">true</span>, <span class="literal">null</span>)) <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p>MySql 排名、并列排名、查询指定用户名次</p></div>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 用户表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`score`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">8</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"><span class="comment">-- 测试数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`user`</span>(<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`score`</span>) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'A'</span>, <span class="number">7</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`user`</span>(<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`score`</span>) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">'B'</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`user`</span>(<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`score`</span>) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">'C'</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`user`</span>(<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`score`</span>) <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">'D'</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`user`</span>(<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`score`</span>) <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="string">'E'</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`user`</span>(<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`score`</span>) <span class="keyword">VALUES</span> (<span class="number">6</span>, <span class="string">'F'</span>, <span class="number">9</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`user`</span>(<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`score`</span>) <span class="keyword">VALUES</span> (<span class="number">7</span>, <span class="string">'G'</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 说明</span></span><br><span class="line">@rank := @rank + 1 中, := 是赋值的作用, 意思是先执行 @rank + 1, 然后把值赋给 @rank</span><br><span class="line">(<span class="keyword">SELECT</span> @<span class="keyword">rank</span> := <span class="number">0</span>) r 意思是设置 <span class="keyword">rank</span> 字段的初始值为<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 1. 查询结果后排序</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	u.*,</span><br><span class="line">	@<span class="keyword">rank</span> := @<span class="keyword">rank</span> + <span class="number">1</span> <span class="keyword">AS</span> <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">	(<span class="keyword">SELECT</span> @<span class="keyword">rank</span> := <span class="number">0</span>) r,</span><br><span class="line">	<span class="string">`user`</span> u</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> u.score <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 并列排名</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	u.*,</span><br><span class="line">	(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> @prev = u.score <span class="keyword">THEN</span> @<span class="keyword">rank</span></span><br><span class="line">		<span class="keyword">WHEN</span> @prev := u.score <span class="keyword">THEN</span> @<span class="keyword">rank</span> := @<span class="keyword">rank</span> + <span class="number">1</span></span><br><span class="line">		<span class="keyword">WHEN</span> @prev = <span class="number">0</span> <span class="keyword">THEN</span> @<span class="keyword">rank</span> := @<span class="keyword">rank</span> + <span class="number">1</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">	(<span class="keyword">SELECT</span> @<span class="keyword">rank</span> := <span class="number">0</span>, @prev := <span class="literal">NULL</span>) r,</span><br><span class="line">	<span class="string">`user`</span> u</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">	u.score <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 指定用户排名</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	*</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">	(</span><br><span class="line">		<span class="keyword">SELECT</span> </span><br><span class="line">			u.*,</span><br><span class="line">			(<span class="keyword">CASE</span> </span><br><span class="line">				<span class="keyword">WHEN</span> @prev = u.score <span class="keyword">THEN</span> @<span class="keyword">rank</span></span><br><span class="line">				<span class="keyword">WHEN</span> @prev := u.score <span class="keyword">THEN</span> @<span class="keyword">rank</span> := @<span class="keyword">rank</span> + <span class="number">1</span></span><br><span class="line">				<span class="keyword">WHEN</span> @prev = <span class="number">0</span> <span class="keyword">THEN</span> @<span class="keyword">rank</span> := @<span class="keyword">rank</span> + <span class="number">1</span></span><br><span class="line">			<span class="keyword">END</span>) <span class="keyword">AS</span> <span class="keyword">rank</span></span><br><span class="line">		<span class="keyword">FROM</span> </span><br><span class="line">			(<span class="keyword">SELECT</span> @<span class="keyword">rank</span> := <span class="number">0</span>, @prev := <span class="literal">NULL</span>) r,</span><br><span class="line">			<span class="string">`user`</span> u</span><br><span class="line">		<span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">			u.score <span class="keyword">DESC</span></span><br><span class="line">	) ur</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	ur.id = <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>MySql 查询每件商品最低价格</p></div>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 1. 创建表</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`goods_sku`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'SKU ID'</span>,</span><br><span class="line">  <span class="string">`goods_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品ID'</span>,</span><br><span class="line">  <span class="string">`sku_title`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'集成名称'</span>,</span><br><span class="line">  <span class="string">`sku_price`</span> <span class="built_in">decimal</span>(<span class="number">12</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'价格'</span>,</span><br><span class="line">  <span class="string">`sku_stock`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'库存'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`goods_id`</span> (<span class="string">`goods_id`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`goods_id_price`</span> (<span class="string">`goods_id`</span>,<span class="string">`sku_price`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'商品SKU信息表'</span>;</span><br><span class="line"></span><br><span class="line"># 2. 插入测试数据</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`goods_sku`</span>(<span class="string">`id`</span>, <span class="string">`goods_id`</span>, <span class="string">`sku_title`</span>, <span class="string">`sku_price`</span>, <span class="string">`sku_stock`</span>) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">'颜色:红色 尺寸:l'</span>, <span class="number">0.02</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`goods_sku`</span>(<span class="string">`id`</span>, <span class="string">`goods_id`</span>, <span class="string">`sku_title`</span>, <span class="string">`sku_price`</span>, <span class="string">`sku_stock`</span>) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="string">'颜色:红色 尺寸:xl'</span>, <span class="number">0.01</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`goods_sku`</span>(<span class="string">`id`</span>, <span class="string">`goods_id`</span>, <span class="string">`sku_title`</span>, <span class="string">`sku_price`</span>, <span class="string">`sku_stock`</span>) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">1</span>, <span class="string">'颜色:黄色 尺寸:l'</span>, <span class="number">0.03</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`goods_sku`</span>(<span class="string">`id`</span>, <span class="string">`goods_id`</span>, <span class="string">`sku_title`</span>, <span class="string">`sku_price`</span>, <span class="string">`sku_stock`</span>) <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">1</span>, <span class="string">'颜色:黄色 尺寸:xl'</span>, <span class="number">0.04</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`goods_sku`</span>(<span class="string">`id`</span>, <span class="string">`goods_id`</span>, <span class="string">`sku_title`</span>, <span class="string">`sku_price`</span>, <span class="string">`sku_stock`</span>) <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="number">2</span>, <span class="string">'颜色:红色 尺寸:l'</span>, <span class="number">0.02</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`goods_sku`</span>(<span class="string">`id`</span>, <span class="string">`goods_id`</span>, <span class="string">`sku_title`</span>, <span class="string">`sku_price`</span>, <span class="string">`sku_stock`</span>) <span class="keyword">VALUES</span> (<span class="number">6</span>, <span class="number">2</span>, <span class="string">'颜色:红色 尺寸:xl'</span>, <span class="number">0.02</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`goods_sku`</span>(<span class="string">`id`</span>, <span class="string">`goods_id`</span>, <span class="string">`sku_title`</span>, <span class="string">`sku_price`</span>, <span class="string">`sku_stock`</span>) <span class="keyword">VALUES</span> (<span class="number">7</span>, <span class="number">2</span>, <span class="string">'颜色:黄色 尺寸:l'</span>, <span class="number">0.07</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`goods_sku`</span>(<span class="string">`id`</span>, <span class="string">`goods_id`</span>, <span class="string">`sku_title`</span>, <span class="string">`sku_price`</span>, <span class="string">`sku_stock`</span>) <span class="keyword">VALUES</span> (<span class="number">8</span>, <span class="number">2</span>, <span class="string">'颜色:黄色 尺寸:xl'</span>, <span class="number">0.01</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`goods_sku`</span>(<span class="string">`id`</span>, <span class="string">`goods_id`</span>, <span class="string">`sku_title`</span>, <span class="string">`sku_price`</span>, <span class="string">`sku_stock`</span>) <span class="keyword">VALUES</span> (<span class="number">9</span>, <span class="number">3</span>, <span class="string">'颜色:红色 尺寸:l'</span>, <span class="number">0.01</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`goods_sku`</span>(<span class="string">`id`</span>, <span class="string">`goods_id`</span>, <span class="string">`sku_title`</span>, <span class="string">`sku_price`</span>, <span class="string">`sku_stock`</span>) <span class="keyword">VALUES</span> (<span class="number">10</span>, <span class="number">3</span>, <span class="string">'颜色:红色 尺寸:xl'</span>, <span class="number">0.02</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`goods_sku`</span>(<span class="string">`id`</span>, <span class="string">`goods_id`</span>, <span class="string">`sku_title`</span>, <span class="string">`sku_price`</span>, <span class="string">`sku_stock`</span>) <span class="keyword">VALUES</span> (<span class="number">11</span>, <span class="number">3</span>, <span class="string">'颜色:黄色 尺寸:l'</span>, <span class="number">0.03</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`goods_sku`</span>(<span class="string">`id`</span>, <span class="string">`goods_id`</span>, <span class="string">`sku_title`</span>, <span class="string">`sku_price`</span>, <span class="string">`sku_stock`</span>) <span class="keyword">VALUES</span> (<span class="number">12</span>, <span class="number">3</span>, <span class="string">'颜色:黄色 尺寸:xl'</span>, <span class="number">0.04</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"># 3.1 查询语句 - 子查询</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	<span class="keyword">id</span>,</span><br><span class="line">	sku_price </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	goods_sku gs </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	<span class="keyword">NOT</span> <span class="keyword">EXISTS</span> ( <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> goods_sku gss <span class="keyword">WHERE</span> gs.goods_id = gss.goods_id <span class="keyword">AND</span> gs.sku_price &gt; gss.sku_price )</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">	goods_id;</span><br><span class="line">	</span><br><span class="line"># 3.2 查询语句 - JOIN </span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	gs.id,</span><br><span class="line">	gs.sku_price</span><br><span class="line">	#,gss.id</span><br><span class="line">	#,gss.sku_price</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	goods_sku gs</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> goods_sku gss <span class="keyword">ON</span> gss.goods_id = gs.goods_id <span class="keyword">AND</span> gss.sku_price &lt; gs.sku_price </span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">    gss.id <span class="keyword">IS</span> <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux 特殊转义字符</title>
    <url>/Linux/linux-special-escape-character.html</url>
    <content><![CDATA[<h5 id="特殊转义字符"><a href="#特殊转义字符" class="headerlink" title="特殊转义字符"></a>特殊转义字符</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 格式: </span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\033[字背景颜色;字体颜色m字符串\033[0m"</span></span><br><span class="line"><span class="comment"># 其中41的位置代表底色,36的位置是代表字的颜色</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\033[41;36m something here \033[0m"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符含义</span></span><br><span class="line">\033[0m 关闭所有属性 </span><br><span class="line">\033[1m 设置高亮度 </span><br><span class="line">\033[4m 下划线 </span><br><span class="line">\033[5m 闪烁 </span><br><span class="line">\033[7m 反显 </span><br><span class="line">\033[8m 消隐 </span><br><span class="line">\033[30m -- \33[37m 设置前景色 </span><br><span class="line">\033[40m -- \33[47m 设置背景色 </span><br><span class="line">\033[nA 光标上移n行 </span><br><span class="line">\033[nB 光标下移n行 </span><br><span class="line">\033[nC 光标右移n行 </span><br><span class="line">\033[nD 光标左移n行 </span><br><span class="line">\033[y;xH设置光标位置 </span><br><span class="line">\033[2J 清屏 </span><br><span class="line">\033[K 清除从光标到行尾的内容 </span><br><span class="line">\033[s 保存光标位置 </span><br><span class="line">\033[u 恢复光标位置 </span><br><span class="line">\033[?25l 隐藏光标 </span><br><span class="line">\033[?25h 显示光标 </span><br><span class="line">\x1b[2J\x1b[$;1H    $表示行位</span><br><span class="line"></span><br><span class="line"><span class="comment"># XX 表示下面的数字, ascii code 是对颜色调用的始末. </span></span><br><span class="line">\033[XX; m …… \033[0m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字颜色: 30-37</span></span><br><span class="line">30:黑 </span><br><span class="line">31:红 </span><br><span class="line">32:绿 </span><br><span class="line">33:黄 </span><br><span class="line">34:蓝色 </span><br><span class="line">35:紫色 </span><br><span class="line">36:深绿 </span><br><span class="line">37:白色 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 字背景颜色范围: 40-47</span></span><br><span class="line">40:黑 </span><br><span class="line">41:深红 </span><br><span class="line">42:绿 </span><br><span class="line">43:黄色 </span><br><span class="line">44:蓝色 </span><br><span class="line">45:紫色 </span><br><span class="line">46:深绿 </span><br><span class="line">47:白色</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字体加亮颜色: 90-97</span></span><br><span class="line">90:黑 </span><br><span class="line">91:红 </span><br><span class="line">92:绿 </span><br><span class="line">93:黄 </span><br><span class="line">94:蓝色 </span><br><span class="line">95:紫色 </span><br><span class="line">96:深绿 </span><br><span class="line">97:白色</span><br><span class="line"></span><br><span class="line"><span class="comment"># 背景加亮颜色范围: 100-107</span></span><br><span class="line">100:黑 </span><br><span class="line">101:深红 </span><br><span class="line">102:绿 </span><br><span class="line">103:黄色 </span><br><span class="line">104:蓝色 </span><br><span class="line">105:紫色 </span><br><span class="line">106:深绿 </span><br><span class="line">107:白色</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL、MongoDB 数据库备份</title>
    <url>/Other/database-backup.html</url>
    <content><![CDATA[<div class="note danger"><ol>
<li>线上服务器自动备份数据库</li>
<li>内网自动备份数据库及下载线上服务器的数据库备份文件</li>
<li>本地运行PHP脚本,通过 SSH2 连接内网打包数据库备份文件并下载</li>
</ol></div>
<table>
<thead>
<tr>
<th>服务器</th>
<th>Host</th>
<th>Port</th>
<th>备份目录 </th>
</tr>
</thead>
<tbody>
<tr>
<td>线上</td>
<td>192.168.0.7</td>
<td>22</td>
<td>/data/backup</td>
</tr>
<tr>
<td>内网</td>
<td>192.168.0.9</td>
<td>22</td>
<td>/data/backup</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h5 id="自动备份并下载远程数据库脚本-backup-sh"><a href="#自动备份并下载远程数据库脚本-backup-sh" class="headerlink" title="自动备份并下载远程数据库脚本 backup.sh"></a>自动备份并下载远程数据库脚本 backup.sh</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment"># MySQL 参数</span></span><br><span class="line"><span class="built_in">declare</span> -A MYSQL_CONFIG=([<span class="string">'host'</span>]=<span class="string">'127.0.0.1'</span> [<span class="string">'port'</span>]=3306 [<span class="string">'user'</span>]=<span class="string">'backup'</span> [<span class="string">'pwd'</span>]=<span class="string">'123456'</span>)</span><br><span class="line"><span class="comment"># 需要备份的 MySQL 数据库</span></span><br><span class="line">MYSQL_DB_NAMES=(<span class="string">'test'</span> <span class="string">'t1'</span> <span class="string">'t2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># MongoDB 参数</span></span><br><span class="line"><span class="built_in">declare</span> -A MONGODB_CONFIG=([<span class="string">'host'</span>]=<span class="string">'127.0.0.1'</span> [<span class="string">'port'</span>]=27017 [<span class="string">'user'</span>]=<span class="string">'test'</span> [<span class="string">'pwd'</span>]=<span class="string">'123456'</span>)</span><br><span class="line">MONGO_DB_NAMES=(<span class="string">'test'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 远程服务器参数</span></span><br><span class="line"><span class="built_in">declare</span> -A REMOTE_SERVER=([<span class="string">'host'</span>]=<span class="string">'192.168.0.7'</span> [<span class="string">'port'</span>]=22 [<span class="string">'user'</span>]=<span class="string">'root'</span>)</span><br><span class="line"><span class="comment"># 需要备份的目录</span></span><br><span class="line">REMOTE_BACKUP_DIR=<span class="string">'/data/backup/'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份文件路径</span></span><br><span class="line">BACKUP_PATH=<span class="string">'/data/backup'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">doDump</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[33m==&gt;开始备份..."</span></span><br><span class="line">    dump_date=`date +%Y%m%d`</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 遍历要备份的MySQL数据库</span></span><br><span class="line">    <span class="keyword">for</span> db_name <span class="keyword">in</span> <span class="variable">$&#123;MYSQL_DB_NAMES[@]&#125;</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="comment"># 数据库备份路径</span></span><br><span class="line">        backup_dir=<span class="string">"<span class="variable">$&#123;BACKUP_PATH&#125;</span>/mysql/<span class="variable">$&#123;dump_date&#125;</span>"</span></span><br><span class="line">        <span class="comment"># 目录不存在则创建</span></span><br><span class="line">        <span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$&#123;backup_dir&#125;</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="comment"># 创建备份文件目录</span></span><br><span class="line">            mkdir -p <span class="string">"<span class="variable">$&#123;backup_dir&#125;</span>"</span></span><br><span class="line">            <span class="keyword">if</span> [ <span class="string">"$?"</span> -ne <span class="string">"0"</span> ]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> -e <span class="string">"\033[31m无法创建<span class="variable">$&#123;backup_dir&#125;</span>目录"</span></span><br><span class="line">                <span class="built_in">exit</span> 1</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 备份文件路径</span></span><br><span class="line">        dump_file=<span class="string">"<span class="variable">$&#123;backup_dir&#125;</span>/<span class="variable">$&#123;db_name&#125;</span>.sql"</span></span><br><span class="line">        /usr/<span class="built_in">local</span>/mysql/bin/mysqldump -u<span class="variable">$&#123;MYSQL_CONFIG['user']&#125;</span> -p<span class="variable">$&#123;MYSQL_CONFIG['pwd']&#125;</span> -h <span class="variable">$&#123;MYSQL_CONFIG['host']&#125;</span> -P <span class="variable">$&#123;MYSQL_CONFIG['port']&#125;</span> <span class="variable">$&#123;db_name&#125;</span> &gt; <span class="variable">$&#123;dump_file&#125;</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"$?"</span> -eq <span class="string">"0"</span> ]</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[32m mysql - <span class="variable">$&#123;db_name&#125;</span> 备份成功, 路径：<span class="variable">$&#123;dump_file&#125;</span>"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[31m mysql - <span class="variable">$&#123;db_name&#125;</span> 备份失败"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 遍历要备份的MongoDB数据库</span></span><br><span class="line">    <span class="keyword">for</span> db_name <span class="keyword">in</span> <span class="variable">$&#123;MONGO_DB_NAMES[@]&#125;</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="comment"># 数据库备份路径</span></span><br><span class="line">        backup_dir=<span class="string">"<span class="variable">$&#123;BACKUP_PATH&#125;</span>/mongodb/<span class="variable">$&#123;dump_date&#125;</span>"</span></span><br><span class="line">        <span class="comment"># 目录不存在则创建</span></span><br><span class="line">        <span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$&#123;backup_dir&#125;</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="comment"># 创建备份文件目录</span></span><br><span class="line">            mkdir -p <span class="string">"<span class="variable">$&#123;backup_dir&#125;</span>"</span></span><br><span class="line">            <span class="keyword">if</span> [ <span class="string">"$?"</span> -ne <span class="string">"0"</span> ]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> -e <span class="string">"\033[31m无法创建<span class="variable">$&#123;backup_dir&#125;</span>目录"</span></span><br><span class="line">                <span class="built_in">exit</span> 1</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        /usr/<span class="built_in">local</span>/mongodb/bin/mongodump -h <span class="variable">$&#123;MONGODB_CONFIG['host']&#125;</span> --port <span class="variable">$&#123;MONGODB_CONFIG['port']&#125;</span> -u <span class="variable">$&#123;MONGODB_CONFIG['user']&#125;</span> -p <span class="variable">$&#123;MONGODB_CONFIG['pwd']&#125;</span> -d <span class="variable">$&#123;db_name&#125;</span> --out=<span class="variable">$&#123;backup_dir&#125;</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"$?"</span> -eq <span class="string">"0"</span> ]</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[32m mongodb - <span class="variable">$&#123;db_name&#125;</span> 备份成功, 路径：<span class="variable">$&#123;backup_dir&#125;</span>"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[31m mongodb - <span class="variable">$&#123;db_name&#125;</span> 备份失败"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 备份路径</span></span><br><span class="line">    backup_dir=<span class="string">"<span class="variable">$&#123;BACKUP_PATH&#125;</span>/remote"</span></span><br><span class="line">    <span class="comment"># 目录不存在则创建</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$&#123;backup_dir&#125;</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># 创建备份文件目录</span></span><br><span class="line">        mkdir -p <span class="string">"<span class="variable">$&#123;backup_dir&#125;</span>"</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"$?"</span> -ne <span class="string">"0"</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[31m无法创建<span class="variable">$&#123;backup_dir&#125;</span>目录"</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="comment"># 远程服务器文件名称</span></span><br><span class="line">    file_name=<span class="string">"test.<span class="variable">$&#123;dump_date&#125;</span>.sql"</span></span><br><span class="line">    scp -P <span class="variable">$&#123;REMOTE_SERVER['port']&#125;</span> <span class="variable">$&#123;REMOTE_SERVER['user']&#125;</span>@<span class="variable">$&#123;REMOTE_SERVER['host']&#125;</span>:<span class="variable">$&#123;REMOTE_BACKUP_DIR&#125;</span><span class="variable">$&#123;file_name&#125;</span> <span class="variable">$&#123;backup_dir&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[32m file - <span class="variable">$&#123;file_name&#125;</span> 备份成功, 路径：<span class="variable">$&#123;backup_dir&#125;</span>/<span class="variable">$&#123;file_name&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[33m==&gt;备份结束.\033[0m"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">doDump</span><br></pre></td></tr></table></figure>
<h5 id="本地-PHP-脚本"><a href="#本地-PHP-脚本" class="headerlink" title="本地 PHP 脚本"></a>本地 PHP 脚本</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SSH2</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> resource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $ssh;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SSH2 constructor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $host</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int    $port</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $password</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $host, int $port, string $username, string $password)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ssh = ssh2_connect($host, $port);</span><br><span class="line">        ssh2_auth_password(<span class="keyword">$this</span>-&gt;ssh, $username, $password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Exec.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $command</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span><span class="params">(string $command)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $stream = ssh2_exec(<span class="keyword">$this</span>-&gt;ssh, $command);</span><br><span class="line">        stream_set_blocking($stream, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> stream_get_contents($stream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Scp send.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string   $local</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string   $remote</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int|null $mode</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scpSend</span><span class="params">(string $local, string $remote, ?int $mode = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ssh2_scp_send(<span class="keyword">$this</span>-&gt;ssh, $local, $remote, $mode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Scp recv.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $remote</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $local</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scpRecv</span><span class="params">(string $remote, string $local)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ssh2_scp_recv(<span class="keyword">$this</span>-&gt;ssh, $remote, $local);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $ip = <span class="string">'192.168.0.9'</span>;</span><br><span class="line">    $port = <span class="number">22</span>;</span><br><span class="line">    $username = <span class="string">'root'</span>;</span><br><span class="line">    $password = <span class="string">'123456'</span>;</span><br><span class="line">    $ssh2 = <span class="keyword">new</span> SSH2($ip, $port, $username, $password);</span><br><span class="line">    <span class="comment">// 打包远程文件</span></span><br><span class="line">    $ssh2-&gt;exec(<span class="string">'cd /data/backup &amp;&amp; zip -r backup.zip ./'</span>);</span><br><span class="line">    <span class="comment">// 拷贝远程文件至本地</span></span><br><span class="line">    $ssh2-&gt;scpRecv(<span class="string">'/data/backup/backup.zip'</span>, <span class="string">'D:\backup.zip'</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">exit</span>($e-&gt;getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. MySQL 创建备份用户</span></span><br><span class="line">GRANT ALL PRIVILEGES ON <span class="built_in">test</span>.* to <span class="string">'backup'</span>@<span class="string">'127.0.0.1'</span> IDENTIFIED BY <span class="string">'123456'</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"><span class="comment"># 若要授权多个数据库</span></span><br><span class="line">GRANT ALL PRIVILEGES ON t1.* to <span class="string">'backup'</span>@<span class="string">'127.0.0.1'</span>;</span><br><span class="line">GRANT ALL PRIVILEGES ON t2.* to <span class="string">'backup'</span>@<span class="string">'127.0.0.1'</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 可以将 mysql 用于备份的用户信息保存至 my.cnf 配置文件, 避免出现  mysqldump: [Warning] Using a password on the command line interface can be insecure. 警告</span></span><br><span class="line">vi /etc/my.cnf</span><br><span class="line">[mysqldump]</span><br><span class="line">user=backup</span><br><span class="line">password=123456</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. MongoDB 数据库恢复命令</span></span><br><span class="line">mongorestore -h 127.0.0.1 --port 27017 -u <span class="built_in">test</span> -p 123456 -d yapi /data/backup/mongodb/20190930/<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. crontab 命令 - 每天 00:30 运行脚本</span></span><br><span class="line">30 0 * * * /bin/sh /data/backup/backup.sh &gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Other</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>linux</tag>
        <tag>mysql</tag>
        <tag>mongodb</tag>
      </tags>
  </entry>
  <entry>
    <title>MAMP 安装 PHP SSH2 扩展</title>
    <url>/Mac/mamp-install-php-ext.html</url>
    <content><![CDATA[<h5 id="MAMP-安装-ssh2-扩展"><a href="#MAMP-安装-ssh2-扩展" class="headerlink" title="MAMP 安装 ssh2 扩展"></a>MAMP 安装 ssh2 扩展</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 安装 libssh2</span></span><br><span class="line">brew install libssh2</span><br><span class="line"><span class="comment">#2. 下载ssh2源码包 </span></span><br><span class="line">curl -o ssh2.tgz http://pecl.php.net/get/ssh2-1.1.2.tgz</span><br><span class="line"><span class="comment">#3. 解压并安装</span></span><br><span class="line">tar -zxvf ssh2.tgz</span><br><span class="line"><span class="built_in">cd</span> ssh2-1.1.2</span><br><span class="line">phpize</span><br><span class="line">./configure --with-php-config=/Applications/MAMP/bin/php/php7.2.14/bin/php-config</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="comment">#4. 修改 php.ini</span></span><br><span class="line">extension=ssh2.so</span><br><span class="line"><span class="comment">#5. 重新启动 MAMP</span></span><br></pre></td></tr></table></figure>
<h5 id="phpize-报错"><a href="#phpize-报错" class="headerlink" title="phpize 报错"></a>phpize 报错</h5><ol>
<li><p>缺少PHP的header头文件 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grep: /usr/include/php/main/php.h: No such file or directory</span><br><span class="line">grep: /usr/include/php/Zend/zend_modules.h: No such file or directory</span><br><span class="line">grep: /usr/include/php/Zend/zend_extensions.h: No such file or directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Xcode command line tools </span></span><br><span class="line">xcode-select --install</span><br><span class="line"><span class="comment"># 若报错 xcode-select: error: command line tools are already installed, use "Software Update" to install updates, 安装header头文件SDK</span></span><br><span class="line"><span class="built_in">cd</span> /Library/Developer/CommandLineTools/Packages/</span><br><span class="line">open macOS_SDK_headers_for_macOS_10.14.pkg</span><br></pre></td></tr></table></figure>
</li>
<li><p>Cannot find autoconf.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Cannot find autoconf. Please check your autoconf installation and the</span><br><span class="line"><span class="variable">$PHP_AUTOCONF</span> environment variable. Then, rerun this script.</span><br><span class="line"><span class="comment"># 运行命令</span></span><br><span class="line">brew install autoconf</span><br></pre></td></tr></table></figure>
</li>
</ol>
]]></content>
      <categories>
        <category>Mac</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>mac</tag>
      </tags>
  </entry>
  <entry>
    <title>VMware15 安装 Mac 10.14</title>
    <url>/Mac/vmware-install-mac10.14.html</url>
    <content><![CDATA[<div class="note primary"><p>准备工具：</p>
<ol>
<li>VMware Workstation 15.0.0</li>
<li>VMware15 注册机</li>
<li>Unlocker v3.0.0</li>
<li>macOS Mojave 10.14 18A391.cdr</li>
</ol></div>
<h5 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h5><ol>
<li>安装VMware, 并用Vmware15 注册机生成序列号</li>
<li>解压Unlocker, 以管理员身份运行 win-install.cmd (如果未解锁,创建虚拟机的时候,操作系统没有 MAC OS 10.14 选项)</li>
<li>新建虚拟机 -&gt; 典型 -&gt; 安装程序光盘映像文件(文件格式选择所有,不然无法找到 macOS Mojave 10.14 18A391.cdr)</li>
<li>虚拟机创建后, 先不打开, 编辑虚拟机系统文件下的 macOS 10.14.vmx, 找到 <code>smc.present = &quot;TRUE&quot;</code>, 在其下新增一行 <code>smc.version = &quot;0&quot;</code> 后保存</li>
<li>打开虚拟机, 在 <code>安装macOS</code> 页面点击工具栏的实用工具 -&gt; 磁盘工具 -&gt; 单击左侧的vmware虚拟盘 -&gt; 编辑 -&gt; 抹掉 -&gt; 关闭磁盘工具 -&gt; 回到 <code>安装macOS</code> 页面 -&gt; 选择刚才抹掉后的磁盘 -&gt; 继续安装</li>
</ol>
<a id="more"></a>
<h5 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h5><ol>
<li><p>全屏</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 安装 VMware Tools -&gt; 系统偏好设置 -&gt; 安全和隐私 -&gt; 隐藏 -&gt; 辅助功能 -&gt; 勾选 vmware-tools-daemon</span></span><br><span class="line"><span class="comment">#2. 进入 mac 恢复模式：选中要启动的虚拟机 -&gt; VM 菜单的启动按钮后面向下箭头 -&gt; 打开电源时进入固件 -&gt; Enter setup -&gt; Boot from a file -&gt; Recovery HD -&gt; Recovery HD -&gt; boot efi</span></span><br><span class="line"><span class="comment">#3. 关闭 mac SIP：实用工具 -&gt; 终端 -&gt; 输入命令 csrutil disable -&gt; reboot</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>网络配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 主机打开网络和共享中心 -&gt; 更改适配器设置 -&gt; VMware Network Adapter VMnet1 -&gt; 右键属性 -&gt; IP4 -&gt; 自动获取</span></span><br><span class="line"><span class="comment">#2. 虚拟主机 -&gt; 设置 -&gt; 网络适配器 -&gt; NAT模式</span></span><br><span class="line"><span class="comment">#3. mac 系统偏好设置 -&gt; 网络 -&gt; 使用DHCP</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>打开应用提示已损坏</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 打开终端,输入代码：sudo spctl --master-disable, 回车输入自己电脑的密码</span></span><br><span class="line"><span class="comment">#2. 打开系统偏好设置 &gt; 安全性与隐私, 若显示任何来源, 则表示成功</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<div class="note default"><p>参考资料：<br><a href="https://www.52pojie.cn/thread-804000-1-1.html" target="_blank" rel="noopener">https://www.52pojie.cn/thread-804000-1-1.html</a><br><a href="https://www.cnblogs.com/sunylat/p/6414697.html" target="_blank" rel="noopener">https://www.cnblogs.com/sunylat/p/6414697.html</a><br><a href="https://blog.csdn.net/driverunload/article/details/78626334" target="_blank" rel="noopener">https://blog.csdn.net/driverunload/article/details/78626334</a></p></div>
]]></content>
      <categories>
        <category>Mac</category>
      </categories>
      <tags>
        <tag>mac</tag>
        <tag>vmware</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 相关问题</title>
    <url>/MySQL/mysql-questions.html</url>
    <content><![CDATA[<div class="note danger"><p>MySql 报 could not be resolved: Temporary failure in name resolution</p></div>
<blockquote><p>原因：MYSQL Server在本地内存中维护了一个非本地的Client TCP cache, 这个cache中包含了远程Client的登录信息, 比如IP地址、hostname等信息<br>如果Client连接到服务器后, MySQL首先会在本地TCP池中根据IP地址解析客户端的hostname或者反解析, 如果解析不到, 就会去DNS中进行解析, 如果还是解析失败, 就是在error log中写入这样的警告信息</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#修改mysql配置文件</span></span><br><span class="line">[mysqld]</span><br><span class="line">skip-host-cache</span><br><span class="line">skip-name-resolve</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>MySql5.7 子查询 order by 失效</p></div>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">#获取用户最新的30条评论</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">comment</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">DESC</span>) c <span class="keyword">GROUP</span> <span class="keyword">BY</span> c.user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> c.id <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> <span class="number">30</span></span><br><span class="line"></span><br><span class="line">#问题：MySql5<span class="number">.5</span> 与 MySql5<span class="number">.7</span> 的执行结果不一样, 因为 <span class="number">5.7</span> 会把<span class="keyword">order</span> <span class="keyword">by</span>优化掉</span><br><span class="line"></span><br><span class="line">#解决：使用<span class="keyword">DISTINCT</span>关键字</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> * <span class="keyword">FROM</span> <span class="keyword">comment</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">DESC</span>) c <span class="keyword">GROUP</span> <span class="keyword">BY</span> c.user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> c.id <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p>MySql 多个联表查询统计时, 数据统计不准确</p></div>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 测试表及数据 </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`vote`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'投票活动ID'</span>,</span><br><span class="line">  <span class="string">`title`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'投票活动标题'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'投票活动表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`vote_option_record`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`vote_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'投票活动ID'</span>,</span><br><span class="line">  <span class="string">`option_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'投票选项ID'</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户ID'</span>,</span><br><span class="line">  <span class="string">`vote_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'投票时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'用户投票记录表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`vote_browse`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'浏览ID'</span>,</span><br><span class="line">  <span class="string">`vote_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'投票活动ID'</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户ID'</span>,</span><br><span class="line">  <span class="string">`count`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'浏览次数'</span>,</span><br><span class="line">  <span class="string">`generate_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'投票活动浏览统计'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`vote`</span>(<span class="string">`id`</span>, <span class="string">`title`</span>) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'投票活动标题'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`vote_option_record`</span>(<span class="string">`id`</span>, <span class="string">`vote_id`</span>, <span class="string">`option_id`</span>, <span class="string">`user_id`</span>, <span class="string">`vote_time`</span>) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="string">'2019-07-01 15:39:07'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`vote_option_record`</span>(<span class="string">`id`</span>, <span class="string">`vote_id`</span>, <span class="string">`option_id`</span>, <span class="string">`user_id`</span>, <span class="string">`vote_time`</span>) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="string">'2019-07-01 16:03:43'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`vote_option_record`</span>(<span class="string">`id`</span>, <span class="string">`vote_id`</span>, <span class="string">`option_id`</span>, <span class="string">`user_id`</span>, <span class="string">`vote_time`</span>) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="string">'2019-07-02 15:39:25'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`vote_option_record`</span>(<span class="string">`id`</span>, <span class="string">`vote_id`</span>, <span class="string">`option_id`</span>, <span class="string">`user_id`</span>, <span class="string">`vote_time`</span>) <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="string">'2019-07-02 15:39:33'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`vote_browse`</span>(<span class="string">`id`</span>, <span class="string">`vote_id`</span>, <span class="string">`user_id`</span>, <span class="string">`count`</span>, <span class="string">`generate_time`</span>) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="string">'2019-07-01 00:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`vote_browse`</span>(<span class="string">`id`</span>, <span class="string">`vote_id`</span>, <span class="string">`user_id`</span>, <span class="string">`count`</span>, <span class="string">`generate_time`</span>) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="string">'2019-07-01 00:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`vote_browse`</span>(<span class="string">`id`</span>, <span class="string">`vote_id`</span>, <span class="string">`user_id`</span>, <span class="string">`count`</span>, <span class="string">`generate_time`</span>) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="string">'2019-07-02 00:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`vote_browse`</span>(<span class="string">`id`</span>, <span class="string">`vote_id`</span>, <span class="string">`user_id`</span>, <span class="string">`count`</span>, <span class="string">`generate_time`</span>) <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="string">'2019-07-02 00:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`vote_browse`</span>(<span class="string">`id`</span>, <span class="string">`vote_id`</span>, <span class="string">`user_id`</span>, <span class="string">`count`</span>, <span class="string">`generate_time`</span>) <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="string">'2019-07-02 20:28:25'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 统计投票活动的总投票数和总访问次数</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	v.id voteId,</span><br><span class="line">	v.title <span class="keyword">AS</span> voteTitle,</span><br><span class="line">	<span class="comment">-- 统计总票数</span></span><br><span class="line">	<span class="keyword">COUNT</span>(vor.id) <span class="keyword">AS</span> votes,</span><br><span class="line">	<span class="comment">-- 统计总访问次数</span></span><br><span class="line">	<span class="keyword">SUM</span>(vb.count) <span class="keyword">AS</span> views</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	vote v</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> vote_option_record vor <span class="keyword">ON</span> v.id = vor.vote_id</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> vote_browse vb <span class="keyword">ON</span> v.id = vb.vote_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">	v.id</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询结果</span></span><br><span class="line">+<span class="comment">--------+--------------+-------+-------+</span></span><br><span class="line">| voteId | voteTitle    | votes | views |</span><br><span class="line">+<span class="comment">--------+--------------+-------+-------+</span></span><br><span class="line">|      <span class="number">1</span> | 投票活动标题 |    <span class="number">20</span>  | <span class="number">56</span>    |</span><br><span class="line">+<span class="comment">--------+--------------+-------+-------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 问题：投票活动的总票数应该为4票, 总访问次数为14次, 然后统计后的结果并不准确, 这是因为多表查询时产生了笛卡尔积, </span></span><br><span class="line"><span class="comment">-- 实际统计时的记录条数有 vote_option_record (4条) * vote_browse(5条) 共20条记录, </span></span><br><span class="line"><span class="comment">-- 所以 votes = vote_option_record(4条) * vote_browse(5条) = 20 票, views = vote_browse(14次) * vote_option_record(4条) = 56 次</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 解决方案</span></span><br><span class="line"><span class="comment">-- 1. COUNT() 通过使用 DISTINCT 关键字</span></span><br><span class="line"><span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> vor.id) <span class="keyword">AS</span> votes</span><br><span class="line"><span class="comment">-- 2. SUM() 则不适用 DISTINCT, 因为会过滤掉字段值一样的数据, 可以通过运算计算出正确的数据</span></span><br><span class="line"><span class="keyword">SUM</span>(vb.count) / <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> vor.id) <span class="keyword">AS</span> views</span><br><span class="line"><span class="comment">-- mysql 除数为 0 时会返回 NULL</span></span><br><span class="line"><span class="keyword">IF</span>(<span class="keyword">COUNT</span>(vor.id), <span class="keyword">SUM</span>(vb.count) / <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> vor.id), <span class="number">0</span>) <span class="keyword">AS</span> views</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 完整SQL</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	v.id voteId,</span><br><span class="line">	v.title <span class="keyword">AS</span> voteTitle,</span><br><span class="line">	<span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> vor.id) <span class="keyword">AS</span> votes,</span><br><span class="line">	<span class="keyword">FLOOR</span>(<span class="keyword">IF</span>(<span class="keyword">COUNT</span>(vor.id), <span class="keyword">SUM</span>(vb.count) / <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> vor.id), <span class="number">0</span>)) <span class="keyword">AS</span> views</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	vote v</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> vote_option_record vor <span class="keyword">ON</span> v.id = vor.vote_id</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> vote_browse vb <span class="keyword">ON</span> v.id = vb.vote_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">	v.id</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>MySql server has gone away 问题重现及断线重连</p></div>
<blockquote>
<p>经常出现在长连接项目或者cli模式运行时间过长, 如果没处理好断线重连, 则会出现此问题<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// test.php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> PDO $dbh</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ping</span><span class="params">(PDO $dbh)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $message = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $dbh-&gt;getAttribute(PDO::ATTR_SERVER_INFO);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (\PDOException $e) &#123;</span><br><span class="line">        $message = $e-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $message;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$config = [</span><br><span class="line">    <span class="string">'host'</span> =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'dbname'</span> =&gt; <span class="string">'test'</span>,</span><br><span class="line">    <span class="string">'user'</span> =&gt; <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'password'</span> =&gt; <span class="string">'root'</span>,</span><br><span class="line">];</span><br><span class="line">$options = [</span><br><span class="line">    <span class="comment">// 主动抛出 PDOException 异常</span></span><br><span class="line">    PDO::ATTR_ERRMODE =&gt; PDO::ERRMODE_EXCEPTION</span><br><span class="line">];</span><br><span class="line">$sql = <span class="string">'SELECT * FROM test'</span>;</span><br><span class="line"></span><br><span class="line">$dbh = <span class="keyword">new</span> PDO(<span class="string">"mysql:host=&#123;$config['host']&#125;;dbname=&#123;$config['dbname']&#125;"</span>, $config[<span class="string">'user'</span>], $config[<span class="string">'password'</span>], $options);</span><br><span class="line">$result = $dbh-&gt;query($sql);</span><br><span class="line">var_dump($result, ping($dbh));</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">$message = ping($dbh);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($message)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"MySql错误：&#123;$message&#125;, 正在重连..."</span> . PHP_EOL;</span><br><span class="line">    $dbh = <span class="keyword">new</span> PDO(<span class="string">"mysql:host=&#123;$config['host']&#125;;dbname=&#123;$config['dbname']&#125;"</span>, $config[<span class="string">'user'</span>], $config[<span class="string">'password'</span>], $options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$result = $dbh-&gt;query($sql);</span><br><span class="line">var_dump($result, ping($dbh));</span><br></pre></td></tr></table></figure></p>
<p>测试方式<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 运行 test.php</span></span><br><span class="line">php test.php</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 运行后在 mysql 命令行模式下, 查看当前有哪些连接</span></span><br><span class="line">mysql&gt; SHOW PROCESSLIST;</span><br><span class="line">+----+------+-----------------+------+---------+------+----------+------------------+</span><br><span class="line">| Id | User | Host            | db   | Command | Time | State    | Info             |</span><br><span class="line">+----+------+-----------------+------+---------+------+----------+------------------+</span><br><span class="line">| 95 | root | localhost:58021 | <span class="built_in">test</span> | Query   |    0 | starting | show processlist |</span><br><span class="line">| 96 | root | localhost:58024 | <span class="built_in">test</span> | Sleep   |    4 |          | NULL             |</span><br><span class="line">+----+------+-----------------+------+---------+------+----------+------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.02 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 杀死指定连接, ID = 96, 此连接是 test.php 内的 mysql 连接</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 等 test.php 的休眠时间过后, 即可看到测试结果</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>MySql geometry</title>
    <url>/MySQL/mysql-geometry.html</url>
    <content><![CDATA[<div class="note danger"><p>通过 MySql geometry 存储用户经纬度, 搜索附近的人</p></div>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`longitude`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">7</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`latitude`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">7</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`geom`</span> geometry <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`desc`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 写入数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`test`</span>(<span class="string">`longitude`</span>, <span class="string">`latitude`</span>, <span class="string">`geom`</span>, <span class="string">`desc`</span>) <span class="keyword">VALUES</span> (<span class="number">118.0824300</span>, <span class="number">24.4457900</span>, ST_GeomFromText(<span class="string">'POINT(118.082 24.4458)'</span>), <span class="string">'福建省厦门市思明区民族路33号中共厦门市思明区委员会(寿山路南)'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`test`</span>(<span class="string">`longitude`</span>, <span class="string">`latitude`</span>, <span class="string">`geom`</span>, <span class="string">`desc`</span>) <span class="keyword">VALUES</span> (<span class="number">118.0671500</span>, <span class="number">24.4446400</span>, ST_GeomFromText(<span class="string">'POINT(118.067 24.4446)'</span>), <span class="string">'福建省厦门市思明区鹭江道西侧鼓浪屿'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`test`</span>(<span class="string">`longitude`</span>, <span class="string">`latitude`</span>, <span class="string">`geom`</span>, <span class="string">`desc`</span>) <span class="keyword">VALUES</span> (<span class="number">118.1044670</span>, <span class="number">24.4350380</span>, ST_GeomFromText(<span class="string">'POINT(118.104 24.435)'</span>), <span class="string">'福建省厦门市思明区思明南路422号厦门大学'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`test`</span>(<span class="string">`longitude`</span>, <span class="string">`latitude`</span>, <span class="string">`geom`</span>, <span class="string">`desc`</span>) <span class="keyword">VALUES</span> (<span class="number">118.0826410</span>, <span class="number">24.4528320</span>, ST_GeomFromText(<span class="string">'POINT(118.083 24.4528)'</span>), <span class="string">'福建省厦门市思明区思明南路189号中华城'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`test`</span>(<span class="string">`longitude`</span>, <span class="string">`latitude`</span>, <span class="string">`geom`</span>, <span class="string">`desc`</span>) <span class="keyword">VALUES</span> (<span class="number">118.1727416</span>, <span class="number">24.4857075</span>, ST_GeomFromText(<span class="string">'POINT(118.173 24.4857)'</span>), <span class="string">'福建省厦门市思明区金山路与吕岭路交汇处西北侧宝龙一城'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询与指定经纬度之间的距离</span></span><br><span class="line"><span class="comment">-- 宝龙一城</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(longitude, <span class="string">','</span>, latitude), <span class="string">`desc`</span>, ST_DISTANCE_SPHERE(POINT(<span class="number">118.1727416</span>, <span class="number">24.4857075</span>), geom) <span class="keyword">AS</span> distance <span class="keyword">FROM</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="comment">-- 梅园大厦</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(longitude, <span class="string">','</span>, latitude), <span class="string">`desc`</span>, ST_DISTANCE_SPHERE(POINT(<span class="number">119.0052</span>, <span class="number">25.43842</span>), geom) <span class="keyword">AS</span> distance <span class="keyword">FROM</span> <span class="keyword">test</span>;</span><br></pre></td></tr></table></figure>
<div class="note primary"><p><a href="MySQL/mysql-custom-functions.html">之前也有一种用于计算距离的SQL</a>, 经过对比, 使用 <code>geometry</code> 更准确</p></div>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 不推荐使用</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(longitude, <span class="string">','</span>, latitude), <span class="string">`desc`</span>, GLength(GeomFromText(<span class="keyword">CONCAT</span>(<span class="string">'LineString(24.4857075 118.1727416,'</span>, latitude, <span class="string">' '</span>, longitude, <span class="string">')'</span>))) / <span class="number">0.0000092592666666667</span> <span class="keyword">AS</span> distance <span class="keyword">FROM</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(longitude, <span class="string">','</span>, latitude), <span class="string">`desc`</span>, GLength(GeomFromText(<span class="keyword">CONCAT</span>(<span class="string">'LineString(25.43842 119.0052,'</span>, latitude, <span class="string">' '</span>, longitude, <span class="string">')'</span>))) / <span class="number">0.0000092592666666667</span> <span class="keyword">AS</span> distance <span class="keyword">FROM</span> <span class="keyword">test</span>;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>阿里云 - OneinStack 配置 pure-ftpd</title>
    <url>/Linux/aliyun-oneinstack-pure-ftpd.html</url>
    <content><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 创建用户 https://oneinstack.com/install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2. vi /usr/local/pureftpd/etc/pure-ftpd.conf</span></span><br><span class="line"><span class="comment">#被动连接响应的端口范围</span></span><br><span class="line">PassivePortRange        20000 30000</span><br><span class="line"><span class="comment">#配置服务器公网IP</span></span><br><span class="line">ForcePassiveIP          公网IP</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 防火墙开放21端口及被动端口 20000-30000</span></span><br><span class="line">firewall-cmd --add-port=21/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=20000-30000/tcp --permanent</span><br><span class="line">systemctl restart firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 阿里云安全组开放端口 21/21 (或20/21), 20000/30000</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>FFmpeg + nginx + rtmp 实现推流</title>
    <url>/FFmpeg/ffmpeg-nginx-rtmp.html</url>
    <content><![CDATA[<div class="note danger"><p>项目目录：/www/ffmpeg<br>环境要求：ffmpeg + nginx + php + <a href="https://github.com/arut/nginx-rtmp-module" target="_blank" rel="noopener">nginx-rtmp-module</a><br>H5直播要求：需运行在线上服务器,并申请SSL证书 ( getUserMedia需要https支持 )<br><code>目前FFmpeg推流及H5录制已初步实现,但是FFmpeg如何实时推送H5录制的视频,还未实现</code></p></div>
<h5 id="rtmp-安装-及配置"><a href="#rtmp-安装-及配置" class="headerlink" title="rtmp 安装 及配置"></a>rtmp <a href="/Nginx/nginx-about.html">安装</a> 及配置</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 编辑 nginx.conf</span></span><br><span class="line">vi /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 尾部添加配置</span></span><br><span class="line"><span class="comment">#协议名称</span></span><br><span class="line">rtmp &#123;</span><br><span class="line">    <span class="comment">#服务器相关配置</span></span><br><span class="line">    server &#123;</span><br><span class="line">        <span class="comment">#监听的端口,rtmp协议的默认端口号是1935</span></span><br><span class="line">        listen 1935;</span><br><span class="line">        chunk_size 4000;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#rtmp推流请求路径</span></span><br><span class="line">        application hls &#123;</span><br><span class="line">            <span class="comment">#开启实时</span></span><br><span class="line">            live on;</span><br><span class="line">            <span class="comment">#不记录数据</span></span><br><span class="line">            record off;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 重启nginx</span></span><br><span class="line">systemctl restart nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 开放1935端口</span></span><br><span class="line">iptables -I INPUT 4 -p tcp -m state --state NEW -m tcp --dport 1935 -j ACCEPT</span><br><span class="line">service iptables save</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="配置-HLS"><a href="#配置-HLS" class="headerlink" title="配置 HLS"></a>配置 HLS</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 编辑 nginx.conf</span></span><br><span class="line">vi /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 修改 rtmp 配置</span></span><br><span class="line"><span class="comment">#协议名称</span></span><br><span class="line">rtmp &#123;</span><br><span class="line">    <span class="comment">#服务器相关配置</span></span><br><span class="line">    server &#123;</span><br><span class="line">        <span class="comment">#监听的端口,rtmp协议的默认端口号是1935</span></span><br><span class="line">        listen 1935;</span><br><span class="line">        chunk_size 4000;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#rtmp推流请求路径</span></span><br><span class="line">        application hls &#123;</span><br><span class="line">            <span class="comment">#开启实时</span></span><br><span class="line">            live on;</span><br><span class="line">            <span class="comment">#不记录数据</span></span><br><span class="line">            record off;</span><br><span class="line"></span><br><span class="line">            hls on;</span><br><span class="line">            <span class="comment">#视频流文件目录</span></span><br><span class="line">            hls_path /data/ffmpeg/hls/<span class="built_in">test</span>;</span><br><span class="line">            hls_fragment 3s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 修改 server 的配置</span></span><br><span class="line">server &#123;</span><br><span class="line">  <span class="comment">#加入hls支持</span></span><br><span class="line">  location /hls &#123;</span><br><span class="line">    types &#123;</span><br><span class="line">      application/x-mpegURL</span><br><span class="line">        video/mp2t ts;</span><br><span class="line">        <span class="comment">#application/vnd.apple.mpegurl m3u8;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">alias</span> /data/ffmpeg/hls/<span class="built_in">test</span>;</span><br><span class="line">    expires -1;</span><br><span class="line">    add_header Cache-Control no-cache;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 重启nginx</span></span><br><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>
<h5 id="FFmepg-推流"><a href="#FFmepg-推流" class="headerlink" title="FFmepg 推流"></a>FFmepg 推流</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#第一种：基于已有视频</span></span><br><span class="line">1. 将 test.mp4 上传至 /data/ffmpeg 目录下</span><br><span class="line">2. ffmpeg 目录下新建 hls 目录</span><br><span class="line"></span><br><span class="line"><span class="comment">#第二种：基于可用的 rtmp 直播源</span></span><br><span class="line">1. rtmp://live.hkstv.hk.lxdns.com/live/hks</span><br><span class="line">2. rtmp://live.hkstv.hk.lxdns.com/live/hks1</span><br><span class="line">3. rtmp://live.hkstv.hk.lxdns.com/live/hks2</span><br><span class="line"></span><br><span class="line"><span class="comment">#推流</span></span><br><span class="line">ffmpeg -re -i /data/ffmpeg/test.mp4 -vcodec copy -f flv rtmp://127.0.0.1:1935/hls/<span class="built_in">test</span></span><br><span class="line">ffmpeg -re -i rtmp://live.hkstv.hk.lxdns.com/live/hks -vcodec copy -f flv rtmp://127.0.0.1:1935/hls/<span class="built_in">test</span></span><br><span class="line"><span class="comment">#若视频没有声音,则使用以下命令推流</span></span><br><span class="line">ffmpeg -re -i /data/ffmpeg/test.mp4 -acodec copy -vcodec copy -f flv rtmp://127.0.0.1:1935/hls/<span class="built_in">test</span></span><br><span class="line">ffmpeg -re -i rtmp://live.hkstv.hk.lxdns.com/live/hks1 -acodec copy -vcodec copy -f flv rtmp://127.0.0.1:1935/hls/<span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h5 id="HTML-实时播放-index-html"><a href="#HTML-实时播放-index-html" class="headerlink" title="HTML 实时播放 index.html"></a>HTML 实时播放 index.html</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;!--&lt;link href=<span class="string">"https://unpkg.com/video.js/dist/video-js.css"</span> rel=<span class="string">"stylesheet"</span>&gt;--&gt;</span><br><span class="line">    &lt;link href=<span class="string">"video-js.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--&lt;script src=<span class="string">"https://unpkg.com/video.js/dist/video.js"</span>&gt;&lt;/script&gt;--&gt;</span><br><span class="line">    &lt;!--&lt;script src=<span class="string">"https://unpkg.com/@videojs/http-streaming/dist/videojs-http-streaming.js"</span>&gt;&lt;/script&gt;--&gt;</span><br><span class="line">    &lt;script src=<span class="string">"video.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">"videojs-http-streaming.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;video-js id=<span class="string">"my-video"</span> controls preload=<span class="string">"auto"</span> width=<span class="string">"640"</span> height=<span class="string">"268"</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">source</span> src=<span class="string">"/hls/test.m3u8"</span> <span class="built_in">type</span>=<span class="string">"application/x-mpegURL"</span> /&gt;</span><br><span class="line">&lt;/video-js&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    var player = videojs(<span class="string">'my-video'</span>);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<hr>
<div class="note primary"><p>H5 录制视频并通过websocket上传,服务端将上传的数据保存为视频</p>
<ol>
<li><a href="/Nginx/nginx-about.html">nginx 的 SSL/PHP 配置</a></li>
<li>composer require workerman/workerman</li>
<li>websocket 及 nginx 反向代理配置</li>
<li>worker.php、recording.html 都在 /www/ffmpeg 目录下</li>
</ol></div>
<h5 id="第一步：服务端监听-8181-端口-worker-php"><a href="#第一步：服务端监听-8181-端口-worker-php" class="headerlink" title="第一步：服务端监听 8181 端口 worker.php"></a>第一步：服务端监听 8181 端口 worker.php</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Workerman</span>\<span class="title">Worker</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Workerman</span>\<span class="title">Protocols</span>\<span class="title">Websocket</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'../vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">$context = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'ssl'</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'local_cert'</span> =&gt; <span class="string">'/usr/local/nginx/conf/cert/cert.pem'</span>,</span><br><span class="line">        <span class="string">'local_pk'</span> =&gt; <span class="string">'/usr/local/nginx/conf/cert/cert.key'</span>,</span><br><span class="line">        <span class="string">'verify_peer'</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line">$worker = <span class="keyword">new</span> Worker(<span class="string">'websocket://0.0.0.0:8181'</span>, $context);</span><br><span class="line">$worker-&gt;transport = <span class="string">'ssl'</span>;</span><br><span class="line"></span><br><span class="line">$worker-&gt;onConnect = <span class="function"><span class="keyword">function</span><span class="params">($connection)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $connection-&gt;onWebSocketConnect = <span class="function"><span class="keyword">function</span><span class="params">($connection , $httpHeader)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 二进制数据,则需要指定传输的数据类型</span></span><br><span class="line">        $connection-&gt;websocketType = Websocket::BINARY_TYPE_ARRAYBUFFER;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@var</span> Workerman\Connection\TcpConnection $connection */</span></span><br><span class="line">$worker-&gt;onMessage = <span class="function"><span class="keyword">function</span><span class="params">($connection, $data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 接收websocket传递的视频流并保存为webm</span></span><br><span class="line">    file_put_contents(<span class="string">'test.webm'</span>, $data, FILE_APPEND);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Worker::runAll();</span><br></pre></td></tr></table></figure>
<h5 id="第二步：nginx-反向代理配置-websocket-完整的SSL配置"><a href="#第二步：nginx-反向代理配置-websocket-完整的SSL配置" class="headerlink" title="第二步：nginx 反向代理配置 websocket (完整的SSL配置)"></a>第二步：nginx 反向代理配置 websocket (完整的SSL配置)</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#编辑配置文件</span></span><br><span class="line">vi /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  www.xxx.com;</span><br><span class="line"></span><br><span class="line">    ssl_certificate      cert/cert.pem;</span><br><span class="line">    ssl_certificate_key  cert/cert.key;</span><br><span class="line"></span><br><span class="line">    ssl_session_cache    shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  5m;</span><br><span class="line"></span><br><span class="line">    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /www/ffmpeg;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#加入hls支持</span></span><br><span class="line">    location /hls &#123;</span><br><span class="line">        types &#123;</span><br><span class="line">            application/x-mpegURL</span><br><span class="line">                video/mp2t ts;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">alias</span> /data/ffmpeg/hls/<span class="built_in">test</span>;</span><br><span class="line">        expires -1;</span><br><span class="line">        add_header Cache-Control no-cache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /wss &#123;</span><br><span class="line">        proxy_pass https://127.0.0.1:8181;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header X-Client-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        proxy_set_header Connection <span class="string">"upgrade"</span>;</span><br><span class="line">        proxy_read_timeout 300s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启</span></span><br><span class="line">service nginx restart</span><br></pre></td></tr></table></figure>
<h5 id="第三步：编写-H5-recording-html"><a href="#第三步：编写-H5-recording-html" class="headerlink" title="第三步：编写 H5 recording.html"></a>第三步：编写 H5 recording.html</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">H5 的视频录制主要基于以下三个API</span><br><span class="line">    getUserMedia - https://developer.mozilla.org/zh-CN/docs/Web/API/MediaDevices/getUserMedia</span><br><span class="line">    MediaRecorder - https://developer.mozilla.org/zh-CN/docs/Web/API/MediaRecorder</span><br><span class="line">    FileReader - https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">        body &#123;</span></span><br><span class="line"><span class="undefined">            padding-top: 40px;</span></span><br><span class="line"><span class="undefined">            text-align: center;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        button &#123;</span></span><br><span class="line"><span class="undefined">            height: 40px;</span></span><br><span class="line"><span class="undefined">            line-height: 40px;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"start"</span>&gt;</span>Start Recording<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"stop"</span> <span class="attr">disabled</span>=<span class="string">""</span>&gt;</span>Stop Recording<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">controls</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">"downloadLink"</span> <span class="attr">download</span>=<span class="string">"mediarecorder.webm"</span> <span class="attr">name</span>=<span class="string">"mediarecorder.webm"</span> <span class="attr">href</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"data"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    'use strict';</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    // 避免重复连接</span></span><br><span class="line"><span class="undefined">    let lockReconnect = false;</span></span><br><span class="line"><span class="undefined">    let ws = null;</span></span><br><span class="line"><span class="undefined">    let wsUrl = 'wss://www.xxx.com/wss/';</span></span><br><span class="line"><span class="undefined">    createWebSocket(wsUrl);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    // 建立websocket连接</span></span><br><span class="line"><span class="undefined">    function createWebSocket() &#123;</span></span><br><span class="line"><span class="undefined">        try &#123;</span></span><br><span class="line"><span class="undefined">            ws = new WebSocket(wsUrl);</span></span><br><span class="line"><span class="undefined">            initEventHandle();</span></span><br><span class="line"><span class="undefined">        &#125; catch (e) &#123;</span></span><br><span class="line"><span class="undefined">            reconnect(wsUrl);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    // 重连</span></span><br><span class="line"><span class="undefined">    function reconnect() &#123;</span></span><br><span class="line"><span class="undefined">        if (lockReconnect) &#123;</span></span><br><span class="line"><span class="undefined">            return;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        lockReconnect = true;</span></span><br><span class="line"><span class="undefined">        setTimeout(function () &#123;</span></span><br><span class="line"><span class="undefined">            createWebSocket(wsUrl);</span></span><br><span class="line"><span class="undefined">            console.log('正在重连,当前时间：' + new Date());</span></span><br><span class="line"><span class="undefined">            lockReconnect = false;</span></span><br><span class="line"><span class="undefined">        &#125;, 3000);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    // 初始化</span></span><br><span class="line"><span class="undefined">    function initEventHandle() &#123;</span></span><br><span class="line"><span class="undefined">        // 连接成功后</span></span><br><span class="line"><span class="undefined">        ws.onopen = function() &#123;</span></span><br><span class="line"><span class="undefined">            // 设置发送的信息类型为 ArrayBuffer</span></span><br><span class="line"><span class="undefined">            ws.binaryType = 'arraybuffer';</span></span><br><span class="line"><span class="undefined">            console.log('连接成功');</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        // 连接关闭后</span></span><br><span class="line"><span class="undefined">        ws.onclose = function() &#123;</span></span><br><span class="line"><span class="undefined">            console.log('关闭连接');</span></span><br><span class="line"><span class="undefined">            reconnect(wsUrl);</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        ws.onerror = function () &#123;</span></span><br><span class="line"><span class="undefined">            reconnect();</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    var video = document.querySelector('video');</span></span><br><span class="line"><span class="undefined">    var startBtn = document.querySelector('button#start');</span></span><br><span class="line"><span class="undefined">    var stopBtn = document.querySelector('button#stop');</span></span><br><span class="line"><span class="undefined">    var dataElement = document.querySelector('#data');</span></span><br><span class="line"><span class="undefined">    var downloadLink = document.querySelector('a#downloadLink')</span></span><br><span class="line"><span class="undefined">    var mediaRecorder;</span></span><br><span class="line"><span class="undefined">    var chunks = [];</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    // 开始录制</span></span><br><span class="line"><span class="undefined">    startBtn.onclick = function () &#123;</span></span><br><span class="line"><span class="undefined">        let constraints = &#123;</span></span><br><span class="line"><span class="undefined">            audio: true,</span></span><br><span class="line"><span class="undefined">            video: &#123;</span></span><br><span class="line"><span class="undefined">                width: 300,</span></span><br><span class="line"><span class="undefined">                height: 300,</span></span><br><span class="line"><span class="undefined">                // 优先前置：user, 优先后置： exact: "environment"</span></span><br><span class="line"><span class="undefined">                //facingMode: 'user'</span></span><br><span class="line"><span class="undefined">                facingMode: &#123;exact: "environment"&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined">        navigator.mediaDevices.getUserMedia(constraints).then(function(stream) &#123;</span></span><br><span class="line"><span class="undefined">            video.srcObject = stream;</span></span><br><span class="line"><span class="undefined">            video.onloadedmetadata = function(e) &#123;</span></span><br><span class="line"><span class="undefined">                video.play();</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            let timeslice = 10;</span></span><br><span class="line"><span class="undefined">            mediaRecorder = new MediaRecorder(stream);</span></span><br><span class="line"><span class="undefined">            // 启动视频捕获,若设置毫秒值,则录制的媒体会分割成一个个单独的区块,而不是一个非常大的整块内容</span></span><br><span class="line"><span class="undefined">            mediaRecorder.start(timeslice);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            // 视频数据捕获之后触发事件,若MediaRecorder.start()设置了timeslice,则dataavailable每隔timeslice毫秒触发一次事件</span></span><br><span class="line"><span class="undefined">            mediaRecorder.ondataavailable = function(e) &#123;</span></span><br><span class="line"><span class="undefined">                chunks.push(e.data);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                var reader = new FileReader();</span></span><br><span class="line"><span class="undefined">                // 当读取操作完成时,触发loadend事件,同时result将包含一个ArrayBuffer对象(Blob文件中的数据)</span></span><br><span class="line"><span class="undefined">                reader.addEventListener('loadend', function() &#123;</span></span><br><span class="line"><span class="undefined">                    // 创建视图</span></span><br><span class="line"><span class="undefined">                    var buf = new Uint8Array(reader.result);</span></span><br><span class="line"><span class="undefined">                    if (reader.result.byteLength &gt; 0) &#123;</span></span><br><span class="line"><span class="undefined">                        ws.send(buf);</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125;);</span></span><br><span class="line"><span class="undefined">                // 读取Blob对象并转化为ArrayBuffer</span></span><br><span class="line"><span class="undefined">                reader.readAsArrayBuffer(e.data);</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="undefined">        &#125;).catch(function (error) &#123;</span></span><br><span class="line"><span class="undefined">            alert('Unable to capture your camera. Please check console logs.');</span></span><br><span class="line"><span class="undefined">            console.log(error);</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    function log(message) &#123;</span></span><br><span class="line"><span class="xml">        dataElement.innerHTML = dataElement.innerHTML + '<span class="tag">&lt;<span class="name">br</span> /&gt;</span>' + message;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="客户端视频播放页面"><a href="#客户端视频播放页面" class="headerlink" title="客户端视频播放页面"></a>客户端视频播放页面</h5><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"https://unpkg.com/video.js/dist/video-js.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/video.js/dist/video.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/@videojs/http-streaming/dist/videojs-http-streaming.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video-js</span> <span class="attr">id</span>=<span class="string">"my-video"</span> <span class="attr">controls</span> <span class="attr">preload</span>=<span class="string">"auto"</span> <span class="attr">width</span>=<span class="string">"640"</span> <span class="attr">height</span>=<span class="string">"268"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source</span> <span class="attr">src</span>=<span class="string">"/hls/test.m3u8"</span> <span class="attr">type</span>=<span class="string">"application/x-mpegURL"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">video-js</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    var player = videojs('my-video');</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="测试流程"><a href="#测试流程" class="headerlink" title="测试流程"></a>测试流程</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. 启动 worker.php</span><br><span class="line">php worker.php start</span><br><span class="line"></span><br><span class="line">2. 手机打开链接 https://www.xxx.com/recording.html, 并点击 `Start Recording` 按钮</span><br><span class="line"></span><br><span class="line">3. 查看 /www/ffmpeg 目录, 会生成一个新的文件 test.webm 文件 ( H5 录制的内容 )</span><br><span class="line"></span><br><span class="line">4. 将 test.webm 通过 ffmpeg 转为 mp4</span><br><span class="line">ffmpeg -i test.webm -vf <span class="string">"scale=trunc(iw/2)*2:trunc(ih/2)*2"</span> test.mp4</span><br><span class="line"></span><br><span class="line">5. 转换后的 mp4 就可以使用 ffmpeg 推流</span><br><span class="line">ffmpeg -re -i test.mp4 -acodec copy -vcodec copy -f flv rtmp://127.0.0.1:1935/hls/<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">6. 访问 https://www.xxx.com/index.html</span><br></pre></td></tr></table></figure>
<div class="note warning"><p>参考资料</p></div>
<p><a href="https://www.cnblogs.com/shihuc/p/7603600.html" target="_blank" rel="noopener">基于H5的摄像头视频数据流采集</a><br><a href="https://www.jianshu.com/p/0296a7be7928" target="_blank" rel="noopener">基于Nginx搭建RTMP/HLS视频直播服务器</a><br><a href="https://aotu.io/notes/2016/10/09/HTML5-SopCast/index.html" target="_blank" rel="noopener">H5直播起航</a><br><a href="https://www.nihaoshijie.com.cn/index.php/archives/615/" target="_blank" rel="noopener">H5视频直播扫盲</a></p>
<hr>
<div class="note danger"><p>网页播放m3u8</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 准备好视频 input.mp4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 将视频文件转为视频编码h.264, 音频编码aac格式的mp4文件 (使用ffprobe查看文件编码方式)</span></span><br><span class="line">ffprobe input.mp4</span><br><span class="line"><span class="comment">#若不是mp4,运行以下命令转换</span></span><br><span class="line">ffmpeg -i input.mkv -acodec copy -vcodec copy input.mp4 </span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 将mp4转为完整的ts</span></span><br><span class="line">ffmpeg -i input.mp4 -vcodec copy -acodec copy -vbsf h264_mp4toannexb output.ts</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 将ts切片,并生成m3u8文件 (segment_time 隔几秒切一个文件)</span></span><br><span class="line">ffmpeg -i output.ts -c copy -map 0 -f segment -segment_list play.m3u8 -segment_time 5 output%03d.ts</span><br><span class="line"></span><br><span class="line"><span class="comment">#5. 新建 index.html 文件,代码如下</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;link href=<span class="string">"https://unpkg.com/video.js/dist/video-js.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;video-js id=<span class="string">"my-video"</span> controls preload=<span class="string">"auto"</span> width=<span class="string">"640"</span> height=<span class="string">"268"</span>&gt;</span><br><span class="line">        &lt;<span class="built_in">source</span> src=<span class="string">"play.m3u8"</span> <span class="built_in">type</span>=<span class="string">"application/x-mpegURL"</span>&gt;</span><br><span class="line">    &lt;/video-js&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script src=<span class="string">"https://unpkg.com/video.js/dist/video.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">"https://unpkg.com/@videojs/http-streaming/dist/videojs-http-streaming.js"</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        var player = videojs(<span class="string">'my-video'</span>);</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>FFmpeg</category>
      </categories>
      <tags>
        <tag>ffmpeg</tag>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>FFmpeg 安装</title>
    <url>/FFmpeg/ffmpeg-install.html</url>
    <content><![CDATA[<h5 id="FFmpeg-安装"><a href="#FFmpeg-安装" class="headerlink" title="FFmpeg 安装"></a>FFmpeg 安装</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 安装依赖包</span></span><br><span class="line">yum install autoconf automake bzip2 cmake freetype-devel gcc gcc-c ++ git libtool make mercurial pkgconfig zlib-devel</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 创建 ffmpeg_sources 目录</span></span><br><span class="line">mkdir /ffmpeg_sources</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. NASM - An assembler used by some libraries</span></span><br><span class="line"><span class="built_in">cd</span> /ffmpeg_sources </span><br><span class="line">wget https://www.nasm.us/pub/nasm/releasebuilds/2.14.02/nasm-2.14.02.tar.gz</span><br><span class="line">tar -zxvf nasm-2.14.02.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nasm-2.14.02</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure --prefix=<span class="string">"/usr/local/ffmpeg_build"</span> --bindir=<span class="string">"/usr/local/ffmpeg_build/bin"</span></span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 添加环境变量生效的路径</span></span><br><span class="line">vi /etc/profile</span><br><span class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/ffmpeg_build/bin:<span class="variable">$PATH</span></span><br><span class="line">wq</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#5. YASM - An assembler used by some libraries</span></span><br><span class="line"><span class="built_in">cd</span> /ffmpeg_sources</span><br><span class="line">wget http://www.tortall.net/projects/yasm/releases/yasm-1.3.0.tar.gz</span><br><span class="line">tar xzvf yasm-1.3.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> yasm-1.3.0</span><br><span class="line">./configure --prefix=<span class="string">"/usr/local/ffmpeg_build"</span> --bindir=<span class="string">"/usr/local/ffmpeg_build/bin"</span></span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#6. libx264 - H.264 video encoder (Requires ffmpeg to be configured with --enable-gpl --enable-libx264)</span></span><br><span class="line"><span class="built_in">cd</span> /ffmpeg_sources</span><br><span class="line">wget ftp://ftp.videolan.org/pub/x264/snapshots/last_x264.tar.bz2</span><br><span class="line">tar -xjvf last_x264.tar.bz2</span><br><span class="line"><span class="built_in">cd</span> x264-snapshot-20190128-2245</span><br><span class="line">PKG_CONFIG_PATH=<span class="string">"/usr/local/ffmpeg_build/lib/pkgconfig"</span> ./configure --prefix=<span class="string">"/usr/local/ffmpeg_build"</span> --bindir=<span class="string">"/usr/local/ffmpeg_build/bin"</span> --<span class="built_in">enable</span>-static</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#7. lib265 - H.265/HEVC video encoder (Requires ffmpeg to be configured with --enable-gpl --enable-libx265)</span></span><br><span class="line"><span class="built_in">cd</span> /ffmpeg_sources</span><br><span class="line">hg <span class="built_in">clone</span> https://bitbucket.org/multicoreware/x265</span><br><span class="line"><span class="built_in">cd</span> x265/build/linux</span><br><span class="line">cmake -G <span class="string">"Unix Makefiles"</span> -DCMAKE_INSTALL_PREFIX=<span class="string">"/usr/local/ffmpeg_build"</span> -DENABLE_SHARED:bool=off ../../<span class="built_in">source</span></span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#8. libfdk_aac - AAC audio encoder (Requires ffmpeg to be configured with --enable-libfdk_aac [and --enable-nonfree if you also included --enable-gpl])</span></span><br><span class="line"><span class="built_in">cd</span> /ffmpeg_sources</span><br><span class="line">wget https://downloads.sourceforge.net/opencore-amr/fdk-aac-2.0.0.tar.gz</span><br><span class="line">tar -zxvf fdk-aac-2.0.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> fdk-aac-2.0.0</span><br><span class="line">autoreconf -fiv</span><br><span class="line">./configure --prefix=<span class="string">"/usr/local/ffmpeg_build"</span> --<span class="built_in">disable</span>-shared</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#9. libmp3lame - MP3 audio encoder (Requires ffmpeg to be configured with --enable-libmp3lame)</span></span><br><span class="line"><span class="built_in">cd</span> /ffmpeg_sources</span><br><span class="line">wget https://iweb.dl.sourceforge.net/project/lame/lame/3.100/lame-3.100.tar.gz</span><br><span class="line">tar -zxvf lame-3.100.tar.gz</span><br><span class="line"><span class="built_in">cd</span> lame-3.100</span><br><span class="line">./configure --prefix=<span class="string">"/usr/local/ffmpeg_build"</span> --bindir=<span class="string">"/usr/local/ffmpeg_build/bin"</span> --<span class="built_in">disable</span>-shared --<span class="built_in">enable</span>-nasm</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#10. libopus - Opus audio decoder and encoder (Requires ffmpeg to be configured with --enable-libopus)</span></span><br><span class="line"><span class="built_in">cd</span> /ffmpeg_sources</span><br><span class="line">wget https://archive.mozilla.org/pub/opus/opus-1.3.tar.gz</span><br><span class="line">tar -zxvf opus-1.3.tar.gz</span><br><span class="line"><span class="built_in">cd</span> opus-1.3.1</span><br><span class="line">./configure --prefix=<span class="string">"/usr/local/ffmpeg_build"</span> --<span class="built_in">disable</span>-shared</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#11. libogg - Ogg bitstream library</span></span><br><span class="line"><span class="built_in">cd</span> /ffmpeg_sources</span><br><span class="line">wget https://downloads.xiph.org/releases/ogg/libogg-1.3.3.tar.gz</span><br><span class="line">tar -zxvf libogg-1.3.3.tar.gz</span><br><span class="line"><span class="built_in">cd</span> libogg-1.3.3</span><br><span class="line">./configure --prefix=<span class="string">"/usr/local/ffmpeg_build"</span> --<span class="built_in">disable</span>-shared</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#12. libvorbis - Vorbis audio encoder (Requires ffmpeg to be configured with --enable-libvorbis)</span></span><br><span class="line"><span class="built_in">cd</span> /ffmpeg_sources</span><br><span class="line">wget https://downloads.xiph.org/releases/vorbis/libvorbis-1.3.6.tar.gz</span><br><span class="line">tar xzvf libvorbis-1.3.6.tar.gz</span><br><span class="line"><span class="built_in">cd</span> libvorbis-1.3.6</span><br><span class="line">./configure --prefix=<span class="string">"/usr/local/ffmpeg_build"</span> --with-ogg=<span class="string">"/usr/local/ffmpeg_build"</span> --<span class="built_in">disable</span>-shared</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#13. libvpx - VP8/VP9 video encoder and decoder (Requires ffmpeg to be configured with --enable-libvpx)</span></span><br><span class="line"><span class="built_in">cd</span> /ffmpeg_sources</span><br><span class="line">wget https://github.com/webmproject/libvpx/archive/v1.7.0/libvpx-1.7.0.tar.gz</span><br><span class="line">tar -zxvf libvpx-1.7.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> libvpx-1.7.0</span><br><span class="line">./configure --prefix=<span class="string">"/usr/local/ffmpeg_build"</span> --<span class="built_in">disable</span>-examples --<span class="built_in">disable</span>-unit-tests --<span class="built_in">enable</span>-vp9-highbitdepth --as=yasm</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#14. FFmpeg</span></span><br><span class="line"><span class="built_in">cd</span> /ffmpeg_sources</span><br><span class="line">wget https://ffmpeg.org/releases/ffmpeg-snapshot.tar.bz2</span><br><span class="line">tar -xjvf ffmpeg-snapshot.tar.bz2</span><br><span class="line"><span class="built_in">cd</span> ffmpeg</span><br><span class="line">PATH=<span class="string">"/usr/local/ffmpeg_build/bin:<span class="variable">$PATH</span>"</span> PKG_CONFIG_PATH=<span class="string">"/usr/local/ffmpeg_build/lib/pkgconfig"</span> ./configure --prefix=<span class="string">"/usr/local/ffmpeg_build"</span> --pkg-config-flags=<span class="string">"--static"</span> --extra-cflags=<span class="string">"-I /usr/local/ffmpeg_build/include"</span> --extra-ldflags=<span class="string">"-L /usr/local/ffmpeg_build/lib"</span> --extra-libs=-lpthread --extra-libs=-lm --bindir=<span class="string">"/usr/local/ffmpeg_build/bin"</span> --<span class="built_in">enable</span>-gpl --<span class="built_in">enable</span>-libfdk_aac --<span class="built_in">enable</span>-libfreetype --<span class="built_in">enable</span>-libmp3lame --<span class="built_in">enable</span>-libopus --<span class="built_in">enable</span>-libvorbis --<span class="built_in">enable</span>-libvpx --<span class="built_in">enable</span>-libx264 --<span class="built_in">enable</span>-libx265 --<span class="built_in">enable</span>-nonfree</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="built_in">hash</span> -r</span><br></pre></td></tr></table></figure>
<div class="note warning"><p>参考资料</p></div>
<p><a href="https://trac.ffmpeg.org/wiki/CompilationGuide/Centos" target="_blank" rel="noopener">Compile FFmpeg on CentOS</a></p>
]]></content>
      <categories>
        <category>FFmpeg</category>
      </categories>
      <tags>
        <tag>ffmpeg</tag>
      </tags>
  </entry>
  <entry>
    <title>MySql 分表、分区</title>
    <url>/MySQL/mysql-partitions.html</url>
    <content><![CDATA[<div class="note danger"><p>MySql 分表<br>比如记录用户操作日志, 这种表数据量将会很大, 那么事先创建N个表(结构一样), 表名如 log_00、log_01、log_02…<br><code>目前建议采用第一种, 第二种限制较多</code></p></div>
<h5 id="第一种：利用hash算法-将不同用户的操作日志分配至不同的表中-这里创建-100-张表"><a href="#第一种：利用hash算法-将不同用户的操作日志分配至不同的表中-这里创建-100-张表" class="headerlink" title="第一种：利用hash算法,将不同用户的操作日志分配至不同的表中,这里创建 100 张表"></a>第一种：利用hash算法,将不同用户的操作日志分配至不同的表中,这里创建 100 张表</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_hash_table</span><span class="params">($table, $userId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $str = crc32($userid);</span><br><span class="line">    <span class="keyword">if</span> ($str &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        $hash = <span class="string">'0'</span> . substr(abs($str), <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $hash = substr($str, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $table . <span class="string">'_'</span> . $hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="第二种：利用-merge-存储引擎来分表-表结构需一致且子表存储引擎必须为MyISAM"><a href="#第二种：利用-merge-存储引擎来分表-表结构需一致且子表存储引擎必须为MyISAM" class="headerlink" title="第二种：利用 merge 存储引擎来分表(表结构需一致且子表存储引擎必须为MyISAM)"></a>第二种：利用 merge 存储引擎来分表(表结构需一致且子表存储引擎必须为MyISAM)</h5><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`log_00`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`desc`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=MyISAM <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`log_01`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`desc`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=MyISAM <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line">#INSERT_METHOD：NO(禁止插入)|FIRST(插入UNION列出的第一个表)|LAST(插入UNION列出的最后一个表)</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`log`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`desc`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=MRG_MyISAM <span class="keyword">UNION</span>=(log_00, log_01) INSERT_METHOD=<span class="keyword">LAST</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line">#插入数据,使用 redis 生成全局ID</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`log_00`</span>(<span class="string">`id`</span>, <span class="string">`user_id`</span>, <span class="string">`desc`</span>) <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="string">'A'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`log_00`</span>(<span class="string">`id`</span>, <span class="string">`user_id`</span>, <span class="string">`desc`</span>) <span class="keyword">VALUES</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="string">'B'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`log_01`</span>(<span class="string">`id`</span>, <span class="string">`user_id`</span>, <span class="string">`desc`</span>) <span class="keyword">VALUES</span>(<span class="number">3</span>, <span class="number">3</span>, <span class="string">'C'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`log_01`</span>(<span class="string">`id`</span>, <span class="string">`user_id`</span>, <span class="string">`desc`</span>) <span class="keyword">VALUES</span>(<span class="number">4</span>, <span class="number">4</span>, <span class="string">'D'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`log`</span>(<span class="string">`id`</span>, <span class="string">`user_id`</span>, <span class="string">`desc`</span>) <span class="keyword">VALUES</span>(<span class="number">5</span>, <span class="number">5</span>, <span class="string">'E'</span>);</span><br><span class="line"></span><br><span class="line">#查询</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">log</span>;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>MySql 分区</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 判断 MySql 是否支持分区, 第一条命令是 5.6 以下版本, 第二条命令是 5.6 及以上版本</span></span><br><span class="line">show variables like <span class="string">'%partition%'</span></span><br><span class="line">show plugins</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 分区文档 https://dev.mysql.com/doc/refman/5.7/en/partitioning.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 分区限制, 一个表最多只能有1024个分区</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#4. range columns 与 range 的区别：https://dev.mysql.com/doc/refman/5.7/en/partitioning-columns-range.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#5. 关于 range columnus 多列, 举个例子：</span></span><br><span class="line">CREATE TABLE `<span class="built_in">test</span>` (</span><br><span class="line">  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `<span class="built_in">type</span>` tinyint(1) NOT NULL COMMENT <span class="string">'类型 1:评论,2:点赞'</span>,</span><br><span class="line">  `content` varchar(16) NOT NULL,</span><br><span class="line">  `read_status` tinyint(1) NOT NULL COMMENT <span class="string">'读取状态 0:未读,1:已读'</span>,</span><br><span class="line">  PRIMARY KEY (`id`,`<span class="built_in">type</span>`,`read_status`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8</span><br><span class="line">PARTITION BY RANGE  COLUMNS(`<span class="built_in">type</span>`,read_status)</span><br><span class="line">(PARTITION p0 VALUES LESS THAN (1,1) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p1 VALUES LESS THAN (1,2) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p2 VALUES LESS THAN (2,1) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p3 VALUES LESS THAN (2,2) ENGINE = InnoDB);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>`(`<span class="built_in">type</span>`, `content`, `read_status`) VALUES (1, <span class="string">'A'</span>, 0);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>`(`<span class="built_in">type</span>`, `content`, `read_status`) VALUES (1, <span class="string">'B'</span>, 1);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>`(`<span class="built_in">type</span>`, `content`, `read_status`) VALUES (2, <span class="string">'C'</span>, 0);</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>`(`<span class="built_in">type</span>`, `content`, `read_status`) VALUES (2, <span class="string">'D'</span>, 1);</span><br><span class="line"><span class="comment">#结果是四条数据各占一个分区</span></span><br><span class="line">SELECT PARTITION_NAME,TABLE_ROWS FROM information_schema.`PARTITIONS` WHERE table_name = <span class="string">'test'</span>;</span><br><span class="line"><span class="comment">#因为 range columnus 是基于 元组(列值列表) 之间的比较, 不同于 range 分区的标量值之间的比较, </span></span><br><span class="line"><span class="comment">#比如上面例子的 p0 分区 (1,1), 那么当插入第一条数据时, type = 1, read_status = 0, 由于 type 相等, 所以比较第二个值, 0 &lt; 1, 所以第一条数据分配在 p0 分区, 以此类推</span></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="相关例子"><a href="#相关例子" class="headerlink" title="相关例子"></a>相关例子</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#消息表</span></span><br><span class="line">CREATE TABLE `message` (</span><br><span class="line">  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `<span class="built_in">type</span>` tinyint(1) NOT NULL COMMENT <span class="string">'类型 1:评论,2:点赞,3:红包,4:交易'</span>,</span><br><span class="line">  `content` varchar(16) NOT NULL,</span><br><span class="line">  `generate_time` datetime NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  KEY `generate_time` (`generate_time`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=5000001 DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成随机数</span></span><br><span class="line">CREATE FUNCTION `generate_random`(n INT) RETURNS varchar(255) CHARSET utf8</span><br><span class="line">BEGIN</span><br><span class="line">	DECLARE str varchar(100) DEFAULT <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;	</span><br><span class="line">	DECLARE return_str varchar(255) default <span class="string">''</span>;</span><br><span class="line">	DECLARE i INT DEFAULT 0;</span><br><span class="line">	</span><br><span class="line">	WHILE i &lt; n DO</span><br><span class="line">        SET return_str = concat(return_str, substring(str , FLOOR(1 + RAND() * 62), 1)); </span><br><span class="line">        SET i = i + 1;		</span><br><span class="line">	END WHILE;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">return</span> return_str;</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成测试数据</span></span><br><span class="line">CREATE PROCEDURE `generate_message`(n INT)</span><br><span class="line">BEGIN</span><br><span class="line">	DECLARE <span class="built_in">type</span> INT;</span><br><span class="line">	DECLARE i INT DEFAULT 0;</span><br><span class="line">	DECLARE date VARCHAR(20);</span><br><span class="line">	</span><br><span class="line">	WHILE i &lt; n DO		</span><br><span class="line">		SET <span class="built_in">type</span> = FLOOR(1 + RAND() * 4);</span><br><span class="line">		SET i = i + 1;		</span><br><span class="line">		SET date = FROM_DAYS(TO_DAYS(<span class="string">'2018-01-01'</span>) + FLOOR(RAND() * 364 + 1));</span><br><span class="line">		INSERT INTO message(`<span class="built_in">type</span>`, `content`, `generate_time`) VALUES(<span class="built_in">type</span>, generate_random(16), date);</span><br><span class="line">	END WHILE;</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"><span class="comment">#通过调用存储过程, 生成500W的测试数据</span></span><br><span class="line">call generate_message(5000000);</span><br><span class="line"></span><br><span class="line"><span class="comment">#查询测试数据分布情况</span></span><br><span class="line">SELECT <span class="built_in">type</span>, DATE_FORMAT(generate_time, <span class="string">'%Y-%m'</span>) m, COUNT(1) FROM message GROUP BY <span class="built_in">type</span>, m;</span><br><span class="line"></span><br><span class="line"><span class="comment">#运行SQL, 耗时 1.339s</span></span><br><span class="line">SELECT COUNT(1) FROM message WHERE <span class="built_in">type</span> = 1 AND generate_time = <span class="string">'2018-07-07 00:00:00'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#消息表分区, 通过表结构可以看出, 以 type 和 generate_time 作为分区字段, 每种类型一年有12个分区, 共48个分区</span></span><br><span class="line">CREATE TABLE `message_partition` (</span><br><span class="line">  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `<span class="built_in">type</span>` tinyint(1) NOT NULL COMMENT <span class="string">'类型 1:评论,2:点赞,3:红包,4:交易'</span>,</span><br><span class="line">  `content` varchar(16) NOT NULL,</span><br><span class="line">  `generate_time` datetime NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`,`<span class="built_in">type</span>`,`generate_time`),</span><br><span class="line">  KEY `generate_time` (`generate_time`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=5000001 DEFAULT CHARSET=utf8</span><br><span class="line">PARTITION BY RANGE  COLUMNS(`<span class="built_in">type</span>`,generate_time)</span><br><span class="line">(PARTITION p1d201801 VALUES LESS THAN (1,<span class="string">'2018-02-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p1d201802 VALUES LESS THAN (1,<span class="string">'2018-03-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p1d201803 VALUES LESS THAN (1,<span class="string">'2018-04-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p1d201804 VALUES LESS THAN (1,<span class="string">'2018-05-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p1d201805 VALUES LESS THAN (1,<span class="string">'2018-06-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p1d201806 VALUES LESS THAN (1,<span class="string">'2018-07-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p1d201807 VALUES LESS THAN (1,<span class="string">'2018-08-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p1d201808 VALUES LESS THAN (1,<span class="string">'2018-09-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p1d201809 VALUES LESS THAN (1,<span class="string">'2018-10-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p1d201810 VALUES LESS THAN (1,<span class="string">'2018-11-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p1d201811 VALUES LESS THAN (1,<span class="string">'2018-12-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p1d201812 VALUES LESS THAN (1,<span class="string">'2019-01-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p2d201801 VALUES LESS THAN (2,<span class="string">'2018-02-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p2d201802 VALUES LESS THAN (2,<span class="string">'2018-03-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p2d201803 VALUES LESS THAN (2,<span class="string">'2018-04-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p2d201804 VALUES LESS THAN (2,<span class="string">'2018-05-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p2d201805 VALUES LESS THAN (2,<span class="string">'2018-06-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p2d201806 VALUES LESS THAN (2,<span class="string">'2018-07-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p2d201807 VALUES LESS THAN (2,<span class="string">'2018-08-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p2d201808 VALUES LESS THAN (2,<span class="string">'2018-09-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p2d201809 VALUES LESS THAN (2,<span class="string">'2018-10-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p2d201810 VALUES LESS THAN (2,<span class="string">'2018-11-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p2d201811 VALUES LESS THAN (2,<span class="string">'2018-12-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p2d201812 VALUES LESS THAN (2,<span class="string">'2019-01-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p3d201801 VALUES LESS THAN (3,<span class="string">'2018-02-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p3d201802 VALUES LESS THAN (3,<span class="string">'2018-03-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p3d201803 VALUES LESS THAN (3,<span class="string">'2018-04-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p3d201804 VALUES LESS THAN (3,<span class="string">'2018-05-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p3d201805 VALUES LESS THAN (3,<span class="string">'2018-06-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p3d201806 VALUES LESS THAN (3,<span class="string">'2018-07-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p3d201807 VALUES LESS THAN (3,<span class="string">'2018-08-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p3d201808 VALUES LESS THAN (3,<span class="string">'2018-09-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p3d201809 VALUES LESS THAN (3,<span class="string">'2018-10-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p3d201810 VALUES LESS THAN (3,<span class="string">'2018-11-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p3d201811 VALUES LESS THAN (3,<span class="string">'2018-12-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p3d201812 VALUES LESS THAN (3,<span class="string">'2019-01-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p4d201801 VALUES LESS THAN (4,<span class="string">'2018-02-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p4d201802 VALUES LESS THAN (4,<span class="string">'2018-03-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p4d201803 VALUES LESS THAN (4,<span class="string">'2018-04-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p4d201804 VALUES LESS THAN (4,<span class="string">'2018-05-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p4d201805 VALUES LESS THAN (4,<span class="string">'2018-06-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p4d201806 VALUES LESS THAN (4,<span class="string">'2018-07-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p4d201807 VALUES LESS THAN (4,<span class="string">'2018-08-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p4d201808 VALUES LESS THAN (4,<span class="string">'2018-09-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p4d201809 VALUES LESS THAN (4,<span class="string">'2018-10-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p4d201810 VALUES LESS THAN (4,<span class="string">'2018-11-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p4d201811 VALUES LESS THAN (4,<span class="string">'2018-12-01'</span>) ENGINE = InnoDB,</span><br><span class="line"> PARTITION p4d201812 VALUES LESS THAN (4,<span class="string">'2019-01-01'</span>) ENGINE = InnoDB);</span><br><span class="line"></span><br><span class="line"> <span class="comment">#将测试数据插入分区表</span></span><br><span class="line"> INSERT INTO message_partition(`<span class="built_in">type</span>`, `content`, `generate_time`) SELECT <span class="built_in">type</span>,content,generate_time FROM message;</span><br><span class="line"></span><br><span class="line"> <span class="comment">#查询分区的数据分布情况</span></span><br><span class="line"> SELECT PARTITION_NAME, TABLE_ROWS FROM information_schema.PARTITIONS WHERE table_name = <span class="string">'message_partition'</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">#运行SQL, 耗时 0.020s</span></span><br><span class="line"> SELECT COUNT(1) FROM message_partition WHERE <span class="built_in">type</span> = 1 AND generate_time = <span class="string">'2018-07-07 00:00:00'</span>;</span><br></pre></td></tr></table></figure>
<h5 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h5><div class="note warning"><p><a href="https://www.jianshu.com/p/3dbdd12a7ed7" target="_blank" rel="noopener">https://www.jianshu.com/p/3dbdd12a7ed7</a></p></div>]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>YApi 安装</title>
    <url>/Other/YApi-install.html</url>
    <content><![CDATA[<div class="note danger"><p><a href="http://yapi.demo.qunar.com/" target="_blank" rel="noopener">YApi</a> 一个可视化接口管理工具</p>
<p>部署前准备：</p>
<ol>
<li>服务器环境 Centos7, IP地址 192.168.1.18</li>
<li>Node.js</li>
<li>MongoDb</li>
</ol></div>
<h5 id="NodeJs"><a href="#NodeJs" class="headerlink" title="NodeJs"></a>NodeJs</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://nodejs.org/dist/v10.15.1/node-v10.15.1-linux-x64.tar.gz </span><br><span class="line"></span><br><span class="line">tar -zxvf node-v10.15.1-linux-x64.tar.gz</span><br><span class="line">mkdir /usr/<span class="built_in">local</span>/nodejs</span><br><span class="line">mv node-v10.15.1-linux-x64/* /usr/<span class="built_in">local</span>/nodejs</span><br><span class="line">rm -rf node-v10.15.1-linux-x64</span><br><span class="line"></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/nodejs/bin/node /usr/<span class="built_in">local</span>/bin</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/nodejs/bin/npm /usr/<span class="built_in">local</span>/bin</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="MongoDb"><a href="#MongoDb" class="headerlink" title="MongoDb"></a>MongoDb</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 官网下载</span></span><br><span class="line">wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-4.0.6.tgz</span><br><span class="line"></span><br><span class="line">mkdir /usr/<span class="built_in">local</span>/mongodb</span><br><span class="line">tar -zxvf mongodb-linux-x86_64-4.0.6.tgz</span><br><span class="line">mv mongodb-linux-x86_64-4.0.6/* /usr/<span class="built_in">local</span>/mongodb/</span><br><span class="line">rm -rf mongodb-linux-x86_64-4.0.6</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/mongodb</span><br><span class="line">mkdir data</span><br><span class="line">mkdir logs</span><br><span class="line">touch logs/mongo.log</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/mongodb/bin</span><br><span class="line">./mongod --dbpath=/usr/<span class="built_in">local</span>/mongodb/data --logpath=/usr/<span class="built_in">local</span>/mongodb/logs/mongo.log --logappend --port=27017 --fork</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 通过 Oneinstack 安装 MongoDb</span></span><br><span class="line">wget -c http://mirrors.linuxeye.com/oneinstack-full.tar.gz &amp;&amp; tar xzf oneinstack-full.tar.gz &amp;&amp; ./oneinstack/install.sh --db_option 15 --dbinstallmethod 1 --dbrootpwd vagrant</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建 yapi 数据库, 并创建 yapi 用户</span></span><br><span class="line">mongo</span><br><span class="line">use admin</span><br><span class="line">db.auth(<span class="string">'root'</span>, <span class="string">'vagrant'</span>)</span><br><span class="line">use yapi</span><br><span class="line">db.createUser(&#123;user:<span class="string">"yapi"</span>, <span class="built_in">pwd</span>:<span class="string">"vagrant"</span>, roles:[&#123;role:<span class="string">"dbOwner"</span>, db:<span class="string">"yapi"</span>&#125;]&#125;)</span><br><span class="line"><span class="comment">#创建后并不能看到 yapi 数据库, 需退出再重新登录并插入数据才行</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">mongo</span><br><span class="line">use yapi</span><br><span class="line">db.auth(<span class="string">'yapi'</span>, <span class="string">'vagrant'</span>)</span><br><span class="line">db.foo.insert(&#123;x:1&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">#远程连接</span></span><br><span class="line"><span class="comment">#添加iptables 3306 端口</span></span><br><span class="line">iptables -I INPUT 4 -p tcp -m state --state NEW -m tcp --dport 27017 -j ACCEPT</span><br><span class="line"><span class="comment">#保存iptables规则</span></span><br><span class="line">service iptables save </span><br><span class="line"><span class="comment">#查看添加的iptables规则</span></span><br><span class="line">iptables -nvL</span><br></pre></td></tr></table></figure>
<h5 id="YApi-安装"><a href="#YApi-安装" class="headerlink" title="YApi 安装"></a>YApi 安装</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#第一种：</span></span><br><span class="line">npm install -g yapi-cli --registry https://registry.npm.taobao.org</span><br><span class="line">yapi server</span><br><span class="line"></span><br><span class="line"><span class="comment">#第二种：</span></span><br><span class="line">mkdir yapi</span><br><span class="line"><span class="built_in">cd</span> yapi</span><br><span class="line"><span class="comment">#git 或者 下载 zip 包解压到 vendors 目录</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/YMFE/yapi.git vendors</span><br><span class="line">cp vendors/config_example.json ./config.json</span><br><span class="line"><span class="built_in">cd</span> vendors</span><br><span class="line">npm install --production --registry https://registry.npm.taobao.org</span><br><span class="line"><span class="comment">#安装程序会初始化数据库索引和管理员账号,管理员账号名可在 config.json 配置</span></span><br><span class="line">npm run install-server</span><br><span class="line"><span class="comment">#启动服务器后,请访问 127.0.0.1:&#123;config.json配置的端口&#125;</span></span><br><span class="line">node server/app.js</span><br><span class="line"></span><br><span class="line"><span class="comment">#若是在虚拟机,请开放3000端口</span></span><br><span class="line">iptables -I INPUT 4 -p tcp -m state --state NEW -m tcp --dport 3000 -j ACCEPT</span><br><span class="line">service iptables save</span><br></pre></td></tr></table></figure>
<h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#第一种安装方式的相关问题</span></span><br><span class="line"><span class="comment">#1.</span></span><br><span class="line">依赖库安装完成，正在初始化数据库mongodb...</span><br><span class="line">Error: internal/modules/cjs/loader.js:583 throw err; ^ Error: Cannot find module <span class="string">'sha1'</span> at Function.Module._</span><br><span class="line"><span class="comment">#解决：编辑 /usr/local/nodejs/lib/node_modules/yapi-cli/src/commands/install.js, 找到 handleNpmInstall()</span></span><br><span class="line">将 npm install -q --production --registry https://registry.npm.taobao.org </span><br><span class="line">修改为 yarn install -q --production --registry https://registry.npm.taobao.org </span><br><span class="line"></span><br><span class="line"><span class="comment">#2. </span></span><br><span class="line">依赖库安装完成，正在初始化数据库mongodb...</span><br><span class="line">Error: (node:9716) UnhandledPromiseRejectionWarning: MongoError: <span class="built_in">command</span> insert requires authentication</span><br><span class="line"><span class="comment">#解决：需配置 Mongo 数据库认证, 配置用户名和密码即可</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#第二种安装方式的相关问题</span></span><br><span class="line"><span class="comment">#1. npm install --production --registry https://registry.npm.taobao.org </span></span><br><span class="line">npm ERR! path /data/wwwroot/private/yapi/vendors/node_modules/assert-plus/package.json.1991383012</span><br><span class="line">npm ERR! code ETXTBSY</span><br><span class="line">npm ERR! errno -26</span><br><span class="line">npm ERR! syscall rename</span><br><span class="line">npm ERR! ETXTBSY: text file is busy, rename <span class="string">'/data/wwwroot/private/yapi/vendors/node_modules/assert-plus/package.json.1991383012'</span> -&gt; <span class="string">'/data/wwwroot/private/yapi/vendors/node_modules/assert-plus/package.json'</span></span><br><span class="line"></span><br><span class="line">npm ERR! A complete <span class="built_in">log</span> of this run can be found <span class="keyword">in</span>:</span><br><span class="line">npm ERR!     /root/.npm/_logs/2019-02-20T06_05_59_862Z-debug.log</span><br><span class="line"><span class="comment">#解决</span></span><br><span class="line">npm install -g yarn</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/nodejs/bin/yarn /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">yarn install --production --registry https://registry.npm.taobao.org </span><br><span class="line"></span><br><span class="line"><span class="comment">#2. npm run install-server </span></span><br><span class="line">error: MongoError: Authentication failed., mongodb Authentication failed</span><br><span class="line"><span class="comment">#解决：配置 config.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"db"</span>: &#123;</span><br><span class="line">    <span class="string">"servername"</span>: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"DATABASE"</span>: <span class="string">"yapi"</span>,</span><br><span class="line">    <span class="string">"port"</span>: 27017,</span><br><span class="line">    <span class="string">"user"</span>: <span class="string">"yapi"</span>,</span><br><span class="line">    <span class="string">"pass"</span>: <span class="string">"vagrant"</span>,</span><br><span class="line">    <span class="string">"authSource"</span>: <span class="string">""</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Other</category>
      </categories>
      <tags>
        <tag>yapi</tag>
      </tags>
  </entry>
  <entry>
    <title>Virtualbox + Vagrant + OneinStack 搭建虚拟开发环境</title>
    <url>/Linux/virtualbox-vagrant-oneinstack.html</url>
    <content><![CDATA[<div class="note danger"><p>Vagrant 用于创建和部署虚拟化开发环境, 通过命令和配置文件来管理虚拟机.</p>
<ul>
<li>创建共享文件夹, 用于主机和虚拟机之间进行资源共享</li>
<li>package进行打包分发, 避免二次重建环境, 且可以统一开发环境</li>
</ul></div>
<h5 id="VirtualBox-Vagrant-安装并启动"><a href="#VirtualBox-Vagrant-安装并启动" class="headerlink" title="VirtualBox + Vagrant 安装并启动"></a>VirtualBox + Vagrant 安装并启动</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. 安装 Vagrant https://releases.hashicorp.com/vagrant/2.2.3/vagrant_2.2.3_x86_64.msi</span><br><span class="line"></span><br><span class="line">2. 安装 Virtualbox https://download.virtualbox.org/virtualbox/6.0.2/VirtualBox-6.0.2-128162-Win.exe</span><br><span class="line"></span><br><span class="line">3. 新建 D:/centos7 目录, 并切换至此目录</span><br><span class="line">D:</span><br><span class="line"><span class="built_in">cd</span> centos7</span><br><span class="line"></span><br><span class="line">4. 添加 box 到 vagrant, 选择 virtualbox</span><br><span class="line">vagrant box add centos/7</span><br><span class="line">若下载太慢,可以中断下载,复制box下载链接并下载至D盘 https://vagrantcloud.com/centos/boxes/7/versions/1812.01/providers/virtualbox.box</span><br><span class="line">vagrant box add centos/7 D:/virtualbox.box</span><br><span class="line"></span><br><span class="line">5. 初始化目录, 生成 Vagrantfile 文件</span><br><span class="line">vagrant init centos/7</span><br><span class="line"></span><br><span class="line">6. 由于vagrant没有Guest Additions, 通过vagrant不能创建共享文件夹, 所以需要下载vbguest插件, 当启动时自动安装Guest Additions</span><br><span class="line">vagrant plugin install vagrant-vbguest</span><br><span class="line"></span><br><span class="line">7. 修改 Vagrantfile 配置文件</span><br><span class="line"><span class="comment">#启用 vagrant_data 共享目录(第二个参数不要跟vagrant同名)</span></span><br><span class="line">config.vm.synced_folder <span class="string">"D:/share"</span>, <span class="string">"/vagrant_data"</span></span><br><span class="line"><span class="comment">#配置虚拟机IP(只能主机访问)</span></span><br><span class="line">config.vm.network <span class="string">"private_network"</span>, ip: <span class="string">"192.168.1.7"</span></span><br><span class="line"></span><br><span class="line">8. 启动系统</span><br><span class="line">vagrant up</span><br><span class="line"></span><br><span class="line">9. SSH 连接</span><br><span class="line">vagrant ssh</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="Vagrant-Xshell-连接方式"><a href="#Vagrant-Xshell-连接方式" class="headerlink" title="Vagrant Xshell 连接方式"></a>Vagrant Xshell 连接方式</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#密钥登录</span></span><br><span class="line"><span class="comment">#1. 查看 HostName、User、Port、IdentityFile</span></span><br><span class="line">vagrant ssh-config</span><br><span class="line"><span class="comment">#2. 配置 xshell 的主机、端口</span></span><br><span class="line"><span class="comment">#3. 用户身份验证方法修改为 Public Key, 配置用户名 vagrant, 用户密钥选择 IdentityFile 路径指向的文件即可登录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#密码登录</span></span><br><span class="line"><span class="comment">#1. 切换 root 账号</span></span><br><span class="line">sudo -i</span><br><span class="line"><span class="comment">#2. 设置密码</span></span><br><span class="line">passwd</span><br><span class="line"><span class="comment">#3. 修改 /etc/ssh/sshd_config, 去掉 PermitRootLogin、PasswordAuthentication 前面的 # 号, 并修改为 yes</span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line"><span class="comment">#4. 重启sshd服务</span></span><br><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure>
<h5 id="制作-box"><a href="#制作-box" class="headerlink" title="制作 box"></a>制作 box</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 清除 yum 缓存、删除解压后的 OneinStack</span></span><br><span class="line">yum clean all</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 切换至 D:/centos7, 然后关机</span></span><br><span class="line">vagrant halt</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 切换至 VirtualBox 安装目录下, 查看虚拟机名称</span></span><br><span class="line">vboxmanage list vms</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 打包语法：vagrant package --base 在VirtualBox显示的虚拟机名称 --output 打包后的box, 例：</span></span><br><span class="line">vagrant package --base centos7_default_1548314709374_91318 --output D:/test.box</span><br></pre></td></tr></table></figure>
<h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#启动系统时提示 default: Warning: Authentication failure. Retrying...</span></span><br><span class="line"><span class="comment">#1. vagrant ssh 登录vagrant用户(默认密码vagrant),并切换到 /home/vagrant 目录</span></span><br><span class="line"><span class="built_in">cd</span> /home/vagrant</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 下载官方公钥</span></span><br><span class="line">wget https://raw.githubusercontent.com/mitchellh/vagrant/master/keys/vagrant.pub</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 覆盖authorized_keys</span></span><br><span class="line">mv vagrant.pub /home/vagrant/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 修改authorized_keys文件权限,除了属主vagrant以外,group和其他用户都不可写</span></span><br><span class="line">chmod go-w /home/vagrant/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="comment">#5. 退出并reload</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">vagrant reload</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="OneinStack-LAMP-环境一键搭建"><a href="#OneinStack-LAMP-环境一键搭建" class="headerlink" title="OneinStack LAMP 环境一键搭建"></a><a href="https://oneinstack.com/install/" target="_blank" rel="noopener">OneinStack</a> LAMP 环境一键搭建</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#安装wget</span></span><br><span class="line">yum install -y wget</span><br><span class="line"></span><br><span class="line"><span class="comment">#下载并安装, 访问地址 192.168.1.7</span></span><br><span class="line">wget http://mirrors.linuxeye.com/oneinstack-full.tar.gz &amp;&amp; tar xzf oneinstack-full.tar.gz &amp;&amp; ./oneinstack/install.sh --apache_option 1 --php_option 7 --phpcache_option 1 --php_extensions fileinfo,redis --db_option 2 --dbinstallmethod 1 --dbrootpwd root --redis  --iptables</span><br></pre></td></tr></table></figure>
<h5 id="OneinStack-MySQL远程连接-需配置-private-network"><a href="#OneinStack-MySQL远程连接-需配置-private-network" class="headerlink" title="OneinStack MySQL远程连接 (需配置 private_network)"></a>OneinStack MySQL远程连接 (需配置 private_network)</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 添加iptables 3306 端口</span></span><br><span class="line">iptables -I INPUT 4 -p tcp -m state --state NEW -m tcp --dport 3306 -j ACCEPT</span><br><span class="line"><span class="comment">#保存iptables规则</span></span><br><span class="line">service iptables save </span><br><span class="line"><span class="comment">#查看添加的iptables规则</span></span><br><span class="line">iptables -nvL</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. MySQL 授权, 添加一个用户 vagrant(用户名不能为root), 密码为 123456, 授权为% (%表示所有IP能连接)对 test 数据库所有权限</span></span><br><span class="line">grant all privileges on <span class="built_in">test</span>.* to vagrant@<span class="string">'%'</span> identified by <span class="string">'123456'</span>;</span><br><span class="line"><span class="comment">#刷新权限立即生效</span></span><br><span class="line">flush privileges</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 主机连接</span></span><br><span class="line">Host：192.168.1.7 </span><br><span class="line">User：vagrant</span><br><span class="line">Password：123456</span><br></pre></td></tr></table></figure>
<h5 id="OneinStack-PHP-关闭zend-opcache"><a href="#OneinStack-PHP-关闭zend-opcache" class="headerlink" title="OneinStack PHP 关闭zend opcache"></a>OneinStack PHP 关闭zend opcache</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">phpinfo() 可以看到 opcache 的配置文件路径,将以下两个参数的值修改为0</span><br><span class="line">opcache.enable=0;</span><br><span class="line">opcache_cli=0; </span><br><span class="line"></span><br><span class="line">systemctl restart php-fpm</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="搭建-test-项目-虚拟机配置"><a href="#搭建-test-项目-虚拟机配置" class="headerlink" title="搭建 test 项目 - 虚拟机配置"></a>搭建 test 项目 - 虚拟机配置</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. OneinStack 安装后的项目目录默认为 /data/wwwroot, 在 /data/wwwroot 目录下新建 test 目录</span></span><br><span class="line"><span class="comment">#2. 在 /usr/local/apache/conf/vhost/ 目录下新建 test.conf, 代码如下：</span></span><br><span class="line">Listen 8080</span><br><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">  DocumentRoot <span class="string">"/data/wwwroot/test"</span>  </span><br><span class="line">  ErrorLog <span class="string">"/data/wwwlogs/test_error_apache.log"</span></span><br><span class="line">  CustomLog <span class="string">"/data/wwwlogs/test_apache.log"</span> common</span><br><span class="line">  &lt;Files ~ (\.user.ini|\.htaccess|\.git|\.svn|\.project|LICENSE|README.md)$&gt;</span><br><span class="line">    Order allow,deny</span><br><span class="line">    Deny from all</span><br><span class="line">  &lt;/Files&gt;</span><br><span class="line">  &lt;FilesMatch \.php$&gt;</span><br><span class="line">    SetHandler <span class="string">"proxy:unix:/dev/shm/php-cgi.sock|fcgi://localhost"</span></span><br><span class="line">  &lt;/FilesMatch&gt;</span><br><span class="line">&lt;Directory <span class="string">"/data/wwwroot/test"</span>&gt;</span><br><span class="line">  SetOutputFilter DEFLATE</span><br><span class="line">  Options FollowSymLinks ExecCGI</span><br><span class="line">  Require all granted</span><br><span class="line">  AllowOverride All</span><br><span class="line">  Order allow,deny</span><br><span class="line">  Allow from all</span><br><span class="line">  DirectoryIndex index.php index.html</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 重启apache</span></span><br><span class="line">systemctl restart httpd</span><br><span class="line"><span class="comment">#4. 添加iptables 8080 端口</span></span><br><span class="line">iptables -I INPUT 4 -p tcp -m state --state NEW -m tcp --dport 8080 -j ACCEPT</span><br><span class="line"><span class="comment">#5. 保存iptables规则</span></span><br><span class="line">service iptables save</span><br></pre></td></tr></table></figure>
<h5 id="搭建-test-项目-Vagrant-配置"><a href="#搭建-test-项目-Vagrant-配置" class="headerlink" title="搭建 test 项目 - Vagrant 配置"></a>搭建 test 项目 - Vagrant 配置</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. D盘新建test目录,作为项目目录</span></span><br><span class="line"><span class="comment">#2. 配置 Vagrantfile synced_folder</span></span><br><span class="line">config.vm.synced_folder <span class="string">"D:/test/"</span>, <span class="string">"/data/wwwroot/test"</span></span><br><span class="line"><span class="comment">#3. 重启</span></span><br><span class="line">vagrant reload</span><br></pre></td></tr></table></figure>
<h5 id="搭建-test-项目-测试"><a href="#搭建-test-项目-测试" class="headerlink" title="搭建 test 项目 - 测试"></a>搭建 test 项目 - 测试</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. D:/test 目录下新建 index.php</span></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Test'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 访问 192.168.1.7:8080, 若页面出现 test, 就说明可以了</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>vagrant</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 随机获取N条数据</title>
    <url>/MySQL/mysql-get-random-data.html</url>
    <content><![CDATA[<h5 id="建立测试表"><a href="#建立测试表" class="headerlink" title="建立测试表"></a>建立测试表</h5><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 用户表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`type`</span> TINYINT(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=UTF8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用户映射表,保存type=1的用户ID</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user_map`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`user_id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=UTF8;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="生成测试数据"><a href="#生成测试数据" class="headerlink" title="生成测试数据"></a>生成测试数据</h5><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建存储过程</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`generateUser`</span> (<span class="keyword">IN</span> <span class="keyword">num</span> <span class="built_in">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span>   </span><br><span class="line">	<span class="keyword">DECLARE</span> chars <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">	<span class="keyword">DECLARE</span> nickname <span class="built_in">VARCHAR</span>(<span class="number">24</span>);</span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="keyword">count</span> <span class="built_in">int</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="keyword">len</span> <span class="built_in">int</span>;	</span><br><span class="line">	WHILE count &lt;= num DO</span><br><span class="line">		<span class="keyword">SET</span> <span class="keyword">len</span> = <span class="number">24</span>;</span><br><span class="line">		<span class="keyword">SET</span> nickname = <span class="string">''</span>;		</span><br><span class="line">		WHILE len &gt; 0 DO</span><br><span class="line">			<span class="keyword">SET</span> nickname = <span class="keyword">CONCAT</span>(nickname, <span class="keyword">SUBSTRING</span>(chars, <span class="keyword">FLOOR</span>(<span class="number">1</span> + <span class="keyword">RAND</span>() * <span class="number">62</span>), <span class="number">1</span>));</span><br><span class="line">			<span class="keyword">SET</span> <span class="keyword">len</span> = <span class="keyword">len</span> - <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">END</span> <span class="keyword">WHILE</span>;</span><br><span class="line">		<span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user`</span>(<span class="keyword">type</span>, nickname) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="keyword">RAND</span>() * <span class="number">2</span>), nickname);</span><br><span class="line">		<span class="keyword">SET</span> <span class="keyword">count</span> = <span class="keyword">count</span> + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">WHILE</span>;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 生成500万测试数据</span></span><br><span class="line"><span class="keyword">CALL</span> generateUser(<span class="number">5000000</span>);</span><br></pre></td></tr></table></figure>
<div class="note warning"><p>5OO万数据中获取随机7条记录</p></div>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 第一种：查询时间 6.654s, 数据随机, 大数据量时效率太差(不推荐)</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`user`</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">RAND</span>() <span class="keyword">LIMIT</span> <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第二种 查询时间 0.005s, 生成随机数 rnd, 并获取 id &gt;= rnd 的数据, 所以获取的数据是连续的, 若要获取的数据在表内分布不均匀, 不建议采用此方法</span></span><br><span class="line"><span class="keyword">SELECT</span> u.* <span class="keyword">FROM</span> <span class="keyword">user</span> u </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> <span class="keyword">ROUND</span>(<span class="keyword">RAND</span>() * (<span class="keyword">SELECT</span> <span class="keyword">MAX</span>(<span class="keyword">id</span>) - <span class="keyword">MIN</span>(<span class="keyword">id</span>) <span class="keyword">FROM</span> <span class="keyword">user</span>) + (<span class="keyword">SELECT</span> <span class="keyword">MIN</span>(<span class="keyword">id</span>) <span class="keyword">FROM</span> <span class="keyword">user</span>)) <span class="keyword">AS</span> rnd) uu <span class="keyword">ON</span> u.id &gt;= uu.rnd </span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第三种 查询时间 0.005s, 数据随机</span></span><br><span class="line"><span class="keyword">SELECT</span> u.* <span class="keyword">FROM</span> <span class="keyword">user</span> u </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> <span class="keyword">ROUND</span>(<span class="keyword">RAND</span> ) * (<span class="keyword">SELECT</span> <span class="keyword">MAX</span>(<span class="keyword">id</span>) - <span class="keyword">MIN</span>(<span class="keyword">id</span>) <span class="keyword">FROM</span> <span class="keyword">user</span>) + (<span class="keyword">SELECT</span> <span class="keyword">MIN</span>(<span class="keyword">id</span>) <span class="keyword">FROM</span> <span class="keyword">user</span>)) <span class="keyword">AS</span> rnd <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">LIMIT</span> <span class="number">7</span>) uu <span class="keyword">ON</span> u.id = uu.rnd </span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">7</span>;</span><br></pre></td></tr></table></figure>
<div class="note warning"><p>ID 不连续或分配不均匀<br>场景：总共有用户100个, type = 1 的用户ID为 20-30 和 70-90, 随机获取7条 type = 1 的用户数据</p></div>
<h5 id="错误的解决方案"><a href="#错误的解决方案" class="headerlink" title="错误的解决方案"></a>错误的解决方案</h5><blockquote>
<p>采用第二种方式, 取得的随机数范围为 1-100, 即使在获取随机数时加上条件, 随机数能命中 type = 1 的用户ID的概率并不高, 有可能出现获取数据为空的情况, 所以这种情况下, 不建议采用这种方式获取随机记录<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">MAX</span>(<span class="keyword">id</span>) - <span class="keyword">MIN</span>(<span class="keyword">id</span>) <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> <span class="keyword">type</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h5 id="建议解决方案"><a href="#建议解决方案" class="headerlink" title="建议解决方案"></a>建议解决方案</h5><blockquote>
<p>创建 user_map 表, 保存所有 type = 1 的用户ID, 这样一来, 只要随机获取 user_map 表内的 id, 根据 id 找到对应的用户即可<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> u </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> um.* <span class="keyword">FROM</span> user_map um</span><br><span class="line">	<span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">	    <span class="keyword">SELECT</span> <span class="keyword">ROUND</span>(<span class="keyword">RAND</span>() * (<span class="keyword">SELECT</span> <span class="keyword">MAX</span>(<span class="keyword">id</span>) - <span class="keyword">MIN</span>(<span class="keyword">id</span>) <span class="keyword">FROM</span> user_map) + (<span class="keyword">SELECT</span> <span class="keyword">MIN</span>(<span class="keyword">id</span>) <span class="keyword">FROM</span> user_map)) <span class="keyword">AS</span> rnd <span class="keyword">FROM</span> user_map <span class="keyword">LIMIT</span> <span class="number">7</span></span><br><span class="line">	) umm <span class="keyword">ON</span> um.id = umm.rnd</span><br><span class="line">	<span class="keyword">LIMIT</span> <span class="number">7</span></span><br><span class="line">) um <span class="keyword">ON</span> u.id = um.user_id</span><br></pre></td></tr></table></figure></p>
</blockquote>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis 延迟任务</title>
    <url>/PHP/delayed-task.html</url>
    <content><![CDATA[<h5 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h5><div class="note info"><ol>
<li>订单下单后,30分钟内未支付,则取消订单(类似订单自动退款|自动收货等都一样)</li>
<li>类似支付宝异步通知,在未收到回复前,按此频率 0|30|60|150 通知</li>
</ol></div>
<hr>
<h5 id="方案一：定时任务"><a href="#方案一：定时任务" class="headerlink" title="方案一：定时任务"></a>方案一：定时任务</h5><div class="note danger"><p>创建定时任务,每隔一分钟查询数据库,处理超时订单</p>
<ol>
<li>适用小项目,可参考 <a href="/PHP/timed-task.html">数据库动态配置定时任务</a>、<a href="/Linux/crontab.html">秒级定时任务</a> </li>
<li>缺点：<ul>
<li>时效性差,有延迟</li>
<li>效率差 </li>
</ul>
</li>
</ol></div>
<a id="more"></a>
<h5 id="方案二：redis-psubscribe"><a href="#方案二：redis-psubscribe" class="headerlink" title="方案二：redis psubscribe"></a>方案二：redis psubscribe</h5><div class="note danger"><p>订阅过期事件</p></div>
<blockquote>
<p>配置redis.conf<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># K    键空间通知,以__keyspace@&lt;db&gt;__为前缀  </span></span><br><span class="line"><span class="comment"># E    键事件通知,以__keysevent@&lt;db&gt;__为前缀  </span></span><br><span class="line"><span class="comment"># g    del, expipre, rename 等类型无关的通用命令的通知...  </span></span><br><span class="line"><span class="comment"># $    String命令  </span></span><br><span class="line"><span class="comment"># l    List命令  </span></span><br><span class="line"><span class="comment"># s    Set命令  </span></span><br><span class="line"><span class="comment"># h    Hash命令  </span></span><br><span class="line"><span class="comment"># z    有序集合命令  </span></span><br><span class="line"><span class="comment"># x    过期事件(每次key过期时生成)</span></span><br><span class="line"><span class="comment"># e    驱逐事件(（)当key在内存满了被清除时生成)</span></span><br><span class="line"><span class="comment"># A    g$lshzxe的别名,因此"AKE"意味着所有的事件</span></span><br><span class="line">notify-keyspace-events <span class="string">"Ex"</span></span><br></pre></td></tr></table></figure></p>
<p>代码实现<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">$redis-&gt;auth(<span class="string">'123456'</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"redis password verification failed"</span>);</span><br><span class="line">$redis-&gt;ping() == <span class="string">'+PONG'</span> <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"redis connection is not available, ping=&#123;$redis-&gt;ping()&#125;"</span>);</span><br><span class="line"></span><br><span class="line">$orderList = [];</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt; <span class="number">10</span>; $i++) &#123;</span><br><span class="line">    $orderKey = <span class="string">'order_'</span> . $i;</span><br><span class="line">    $rand = mt_rand(<span class="number">1</span>, <span class="number">30</span>);</span><br><span class="line">    $redis-&gt;setex($orderKey, $rand, $i);</span><br><span class="line">    $orderList[$rand] = $orderKey;</span><br><span class="line">&#125;</span><br><span class="line">ksort($orderList);</span><br><span class="line">var_export($orderList);</span><br><span class="line"></span><br><span class="line">$redis-&gt;setOption(Redis::OPT_READ_TIMEOUT, <span class="number">-1</span>);</span><br><span class="line">$redis-&gt;psubscribe([<span class="string">'__keyevent@0__:expired'</span>], <span class="function"><span class="keyword">function</span> <span class="params">($redis, $pattern, $chan, $msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> PHP_EOL . date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" &#123;$msg&#125;"</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h5 id="方案三：redis-psubscribe-queue"><a href="#方案三：redis-psubscribe-queue" class="headerlink" title="方案三：redis psubscribe + queue"></a>方案三：redis psubscribe + queue</h5><div class="note danger"><p>例：A、B、C 三台服务器<br><span class="label danger">A</span> 订阅过期事件,将过期的订单 <span class="label success">rpush</span> 到 <span class="label success">queue</span>  里, <span class="label danger">B</span> 和 <span class="label danger">C</span> 通过 <span class="label success">blpop</span> 从队列获取订单处理</p></div>
<blockquote>
<p>A服务器订阅过期事件<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRedis</span><span class="params">(bool $reset = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!$reset) &#123;</span><br><span class="line">        <span class="keyword">static</span> $redis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $redis = <span class="keyword">new</span> Redis();</span><br><span class="line">    $redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">    $redis-&gt;auth(<span class="string">'123456'</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"redis password verification failed"</span>);</span><br><span class="line">    $redis-&gt;ping() == <span class="string">'+PONG'</span> <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"redis connection is not available, ping=&#123;$redis-&gt;ping()&#125;"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $redis;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$redis = getRedis(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">$orderList = [];</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt; <span class="number">10</span>; $i++) &#123;</span><br><span class="line">    $orderKey = <span class="string">'order_'</span> . $i;</span><br><span class="line">    $rand = mt_rand(<span class="number">1</span>, <span class="number">30</span>);</span><br><span class="line">    $redis-&gt;setex($orderKey, $rand, $i);</span><br><span class="line">    $orderList[$rand] = $orderKey;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$redis-&gt;setOption(Redis::OPT_READ_TIMEOUT, <span class="number">-1</span>);</span><br><span class="line"><span class="comment">// 一旦客户端进入订阅状态,客户端就只可接受订阅相关的命令SUBSCRIBE、PSUBSCRIBE、UNSUBSCRIBE、PUNSUBSCRIBE,其他命令一律失效</span></span><br><span class="line"><span class="comment">// http://www.redis.cn/commands/subscribe.html</span></span><br><span class="line">$redis-&gt;psubscribe([<span class="string">'__keyevent@0__:expired'</span>], <span class="function"><span class="keyword">function</span> <span class="params">($redis, $pattern, $chan, $msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> PHP_EOL . date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" &#123;$msg&#125;"</span>;</span><br><span class="line"></span><br><span class="line">    $r = getRedis();</span><br><span class="line">    $listKey = <span class="string">'order_list'</span>;</span><br><span class="line">    $r-&gt;rPush($listKey, $msg);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>B、C服务器处理队列<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">$redis-&gt;auth(<span class="string">'123456'</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"redis password verification failed"</span>);</span><br><span class="line">$redis-&gt;ping() == <span class="string">'+PONG'</span> <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"redis connection is not available, ping=&#123;$redis-&gt;ping()&#125;"</span>);</span><br><span class="line"></span><br><span class="line">$redis-&gt;setOption(Redis::OPT_READ_TIMEOUT, <span class="number">-1</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    $data = $redis-&gt;blPop(<span class="string">'order_list'</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"pid："</span> . posix_getpid() . <span class="string">", order_id：&#123;$data['1']&#125;"</span> . PHP_EOL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h5 id="方案四：延迟任务-DelayedTask"><a href="#方案四：延迟任务-DelayedTask" class="headerlink" title="方案四：延迟任务 DelayedTask"></a>方案四：延迟任务 DelayedTask</h5><div class="note danger"><p>项目地址 <a href="https://github.com/sevming/DelayedTask" target="_blank" rel="noopener">Delayed-task</a><br>基于 Redis 的 Sorted Set 实现延迟任务<br>环境要求：</p>
<ul>
<li>Redis</li>
<li>PHP &gt;=7.0.0</li>
<li>PHP 需安装 pctnl、posix、redis 模块</li>
</ul></div>
<blockquote>
<p>整体结构<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. Task Pool 存放所有任务的信息(Redis Hashes)</span><br><span class="line">2. Delay Bucket 存放所有需要延迟的任务ID,以时间戳排序(Redis Sorted Set),以取模的方式将延迟任务分配至多个Bucket</span><br><span class="line">3. 创建多个进程,负责扫描各自的Delay Bucket(取模方式),获取delayTime(延迟执行时间)小于等于当前时间的任务,从Delay Bucket中删除并放入Ready Queue(Redis Lists),按任务优先级存入不同的队列</span><br><span class="line">4. 创建多个进程,负责扫描各自的Ready Queue(先处理优先级高的队列)</span><br></pre></td></tr></table></figure></p>
<p>流程<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. TaskClient-&gt;add() 客户端添加任务</span><br><span class="line">    1.1 初始化任务</span><br><span class="line">        1.1.1 topic 任务类型</span><br><span class="line">        1.1.2 id 任务ID, topic</span><br><span class="line">        1.1.3 url、call 设置一个即可,表示通知URL或call指定方法</span><br><span class="line">        1.1.4 callback 任务执行成功后的回调函数</span><br><span class="line">        1.1.5 任务调用规则</span><br><span class="line">            1.1.5.1 intervalTime = 3, persistent = <span class="literal">true</span> 每隔3秒调用一次</span><br><span class="line">            1.1.5.2 intervalTime = 10, persistent = <span class="literal">false</span> 10秒后调用一次就结束任务</span><br><span class="line">            1.1.5.3 intervalTime = <span class="string">'0,30,60'</span>, persistent = <span class="literal">true</span> 0|30|60 秒后调用任务,第三次调用任务后,之后每隔60秒调用一次</span><br><span class="line">            1.1.5.4 intervalTime = <span class="string">'0,30,60'</span>, persistent = <span class="literal">false</span> 0|30|60 秒后调用任务,第三次调用后结束任务</span><br><span class="line">        1.1.6 priority 任务优先级,不同优先级处理的任务数量也不同,目前支持设置优先级1-3,数字越高优先级越高,优先处理的任务也就越多</span><br><span class="line">        1.1.7 params 额外参数</span><br><span class="line">        1.1.8 status 任务状态,默认为延迟中</span><br><span class="line">    1.2 hSet 保存任务至 Task Pool</span><br><span class="line">    1.3 zAdd 保存任务ID,任务延迟执行时间作为排序值,bucketKey 通过 crc32(topic) % bucketCount 取模,得到任务ID所要保存在哪个Bucket中,便于多进程时的进程一对一监控</span><br><span class="line">2. TaskServer-&gt;scanBucket() 服务端扫描延迟任务</span><br><span class="line">    2.1 创建子进程,通过取模获取当前进程所需要监控的Bucket</span><br><span class="line">    2.2 通过 zRangeByScore 获取delayTime小于等于当前时间的任务</span><br><span class="line">        2.2.1 任务状态为延迟中,则将任务从Bucket中删除,并根据任务优先级添加至不同的队列(这里采用分布式锁,保证原子性)</span><br><span class="line">        2.2.2 任务状态不为延迟中,将任务从Bucket中删除</span><br><span class="line">3. TaskServer-&gt;scanQueue() 服务端扫描队列</span><br><span class="line">    3.1 创建子进程,先处理优先级较高的队列</span><br><span class="line">    3.2 通过 lPop 获取任务,再次检测一下任务状态及delayTime</span><br><span class="line">    3.3 handleTask 处理任务</span><br><span class="line">        3.3.1 OK 调用 callback</span><br><span class="line">        3.3.2 FAIL 不处理</span><br><span class="line">        3.3.3 DELAY 重新计算任务下次执行时间,将任务放入Bucket</span><br></pre></td></tr></table></figure></p>
<p>参考：</p>
<ol>
<li><a href="https://tech.youzan.com/queuing_delay" target="_blank" rel="noopener">有赞延迟队列设计</a></li>
<li><a href="https://github.com/chenlinzhong/php-delayqueue" target="_blank" rel="noopener">chenlinzhong/php-delayqueue</a></li>
<li><a href="https://www.cnblogs.com/peachyy/p/7398430.html" target="_blank" rel="noopener">基于redis的延迟消息队列设计</a></li>
</ol>
</blockquote>
<div class="note warning"><p>注意：涉及延迟任务的处理的只有 TaskServer.php 的 scanBucket、scanQueue、handleTask 方法, 其它方法的作用参考 <a href="/PHP/task-scheduling.html">任务调度</a> </p></div> 
<blockquote>
<p>启动、停止服务 server.php<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 启动：php server.php</span></span><br><span class="line"><span class="comment">// 停止：php server.php stop</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Sevming</span>\<span class="title">DelayedTask</span>\<span class="title">TaskServer</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $server = <span class="keyword">new</span> TaskServer(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>, <span class="string">'123456'</span>);</span><br><span class="line">    $server-&gt;debug = <span class="keyword">true</span>;</span><br><span class="line">    $server-&gt;runAll();</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">exit</span>($e-&gt;getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>添加、删除任务 client.php<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Sevming</span>\<span class="title">DelayedTask</span>\<span class="title">TaskClient</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $client = <span class="keyword">new</span> TaskClient(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>, <span class="string">'123456'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 每隔3秒调用一次Order类的return方法</span></span><br><span class="line">    $client-&gt;add([</span><br><span class="line">        <span class="string">'topic'</span> =&gt; <span class="string">'order:return'</span>,</span><br><span class="line">        <span class="string">'id'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">        <span class="string">'call'</span> =&gt; [<span class="string">'Order'</span>, <span class="string">'return'</span>],</span><br><span class="line">        <span class="string">'intervalTime'</span> =&gt; <span class="number">3</span>,</span><br><span class="line">        <span class="string">'callback'</span> =&gt; [<span class="string">'Order'</span>, <span class="string">'success'</span>],</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 10秒后调用Order类的receipt方法,仅调用1次</span></span><br><span class="line">    $client-&gt;add([</span><br><span class="line">        <span class="string">'topic'</span> =&gt; <span class="string">'order:receipt'</span>,</span><br><span class="line">        <span class="string">'id'</span> =&gt; <span class="number">2</span>,</span><br><span class="line">        <span class="string">'call'</span> =&gt; [<span class="string">'Order'</span>, <span class="string">'receipt'</span>],</span><br><span class="line">        <span class="string">'intervalTime'</span> =&gt; <span class="number">10</span>,</span><br><span class="line">        <span class="string">'persistent'</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 设置优先级,每隔 0|30|60秒 调用一次Order类的timeout,调用三次后结束调用</span></span><br><span class="line">    $client-&gt;add([</span><br><span class="line">        <span class="string">'topic'</span> =&gt; <span class="string">'order:timeout'</span>,</span><br><span class="line">        <span class="string">'id'</span> =&gt; <span class="number">3</span>,</span><br><span class="line">        <span class="string">'call'</span> =&gt; [<span class="string">'Order'</span>, <span class="string">'timeout'</span>],</span><br><span class="line">        <span class="string">'priority'</span> =&gt; <span class="number">2</span>,</span><br><span class="line">        <span class="string">'intervalTime'</span> =&gt; <span class="string">'0,30,60'</span>,</span><br><span class="line">        <span class="string">'persistent'</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 每隔 0|10|20秒 调用一次Order类的refund,调用三次后,间隔时间为20秒调用一次</span></span><br><span class="line">    $client-&gt;add([</span><br><span class="line">        <span class="string">'topic'</span> =&gt; <span class="string">'order:refund'</span>,</span><br><span class="line">        <span class="string">'id'</span> =&gt; <span class="number">4</span>,</span><br><span class="line">        <span class="string">'call'</span> =&gt; [<span class="string">'Order'</span>, <span class="string">'refund'</span>],</span><br><span class="line">        <span class="string">'intervalTime'</span> =&gt; <span class="string">'0,10,20'</span>,</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 每隔 0|15|30秒 请求一次url,请求三次后,不再请求</span></span><br><span class="line">    $client-&gt;add([</span><br><span class="line">        <span class="string">'topic'</span> =&gt; <span class="string">'order:notify'</span>,</span><br><span class="line">        <span class="string">'id'</span> =&gt; <span class="number">5</span>,</span><br><span class="line">        <span class="string">'url'</span> =&gt; <span class="string">'192.168.50.77:8080'</span>,</span><br><span class="line">        <span class="string">'params'</span> =&gt; [</span><br><span class="line">            <span class="string">'content'</span> =&gt; <span class="string">'hello'</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">'intervalTime'</span> =&gt; <span class="string">'0,15,30'</span>,</span><br><span class="line">        <span class="string">'persistent'</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 删除任务,根据添加任务时的topic和id</span></span><br><span class="line">    <span class="comment">//$client-&gt;del('order:return', 1);</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">exit</span>($e-&gt;getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Order.php<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">return</span><span class="params">(array $task)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__FUNCTION__</span> . <span class="string">",id=&#123;$task['id']&#125;,createTime=&#123;$task['createTime']&#125;,count=&#123;$task['rule']['count']&#125;,runTime="</span>  . date(<span class="string">'Y-m-d H:i:s'</span>) . PHP_EOL;</span><br><span class="line">        <span class="comment">// 返回success,则任务结束</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'success'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">receipt</span><span class="params">(array $task)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__FUNCTION__</span> . <span class="string">",id=&#123;$task['id']&#125;,createTime=&#123;$task['createTime']&#125;,count=&#123;$task['rule']['count']&#125;,runTime="</span> . date(<span class="string">'Y-m-d H:i:s'</span>) . PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">timeout</span><span class="params">(array $task)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__FUNCTION__</span> . <span class="string">",id=&#123;$task['id']&#125;,createTime=&#123;$task['createTime']&#125;,count=&#123;$task['rule']['count']&#125;,runTime="</span> . date(<span class="string">'Y-m-d H:i:s'</span>) . PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">refund</span><span class="params">(array $task)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__FUNCTION__</span> . <span class="string">",id=&#123;$task['id']&#125;,createTime=&#123;$task['createTime']&#125;,count=&#123;$task['rule']['count']&#125;,runTime="</span> . date(<span class="string">'Y-m-d H:i:s'</span>) . PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">success</span><span class="params">(array $task)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        var_dump($task);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"任务处理成功\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>TaskClient.php<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Sevming</span>\<span class="title">DelayedTask</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>, <span class="title">RedisException</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskClient</span> <span class="keyword">extends</span> <span class="title">DelayedTask</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add task.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $params</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception|RedisException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(array $params)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $task = <span class="keyword">$this</span>-&gt;initTask($params);</span><br><span class="line">        $redis = <span class="keyword">$this</span>-&gt;getRedisInstance();</span><br><span class="line"></span><br><span class="line">        $taskKey = <span class="keyword">$this</span>-&gt;getTaskKey($task[<span class="string">'topic'</span>], $task[<span class="string">'id'</span>]);</span><br><span class="line">        <span class="comment">// Save task to task pool.</span></span><br><span class="line">        $redis-&gt;hSet(<span class="keyword">$this</span>-&gt;getTaskPoolKey(), $taskKey, json_encode($task));</span><br><span class="line">        <span class="comment">// Save the task ID, with the task delay execution time as the sort value</span></span><br><span class="line">        $redis-&gt;zAdd(<span class="keyword">$this</span>-&gt;getBucketKey($task[<span class="string">'topic'</span>]), $task[<span class="string">'delayTime'</span>], $taskKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Del task.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $topic</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed  $id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool   $softDelete</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception|RedisException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">del</span><span class="params">(string $topic, $id, bool $softDelete = true)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $taskKey = <span class="keyword">$this</span>-&gt;getTaskKey($topic, $id);</span><br><span class="line">        $redis = <span class="keyword">$this</span>-&gt;getRedisInstance();</span><br><span class="line"></span><br><span class="line">        $taskPoolKey = <span class="keyword">$this</span>-&gt;getTaskPoolKey();</span><br><span class="line">        <span class="keyword">if</span> ($task = $redis-&gt;hGet($taskPoolKey, $taskKey)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!$softDelete) &#123;</span><br><span class="line">                $redis-&gt;hDel($taskPoolKey, $taskKey);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $task = json_decode($task, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> ($task[<span class="string">'status'</span>] !== <span class="keyword">static</span>::TASK_STATUS_DELETED) &#123;</span><br><span class="line">                $task[<span class="string">'status'</span>] = <span class="keyword">static</span>::TASK_STATUS_DELETED;</span><br><span class="line">                $redis-&gt;hSet($taskPoolKey, $taskKey, json_encode($task));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Init task.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $params</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">initTask</span><span class="params">(array $params)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($params[<span class="string">'topic'</span>])) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'topic can not be empty.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($params[<span class="string">'id'</span>])) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'id can not be empty.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($params[<span class="string">'url'</span>]) &amp;&amp; <span class="keyword">empty</span>($params[<span class="string">'call'</span>])) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'url or call can not be empty.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($params[<span class="string">'call'</span>])) &#123;</span><br><span class="line">            <span class="keyword">list</span> ($class, $action) = $params[<span class="string">'call'</span>];</span><br><span class="line">            <span class="keyword">if</span> (!class_exists($class) || !method_exists($class, $action)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"call class &#123;$class&#125; not exists or action &#123;$action&#125; not exists."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($params[<span class="string">'callback'</span>])) &#123;</span><br><span class="line">            <span class="keyword">list</span> ($class, $action) = $params[<span class="string">'callback'</span>];</span><br><span class="line">            <span class="keyword">if</span> (!class_exists($class) || !method_exists($class, $action)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"callback class &#123;$class&#125; not exists or action &#123;$action&#125; not exists."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $intervalTimeArray = [<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($params[<span class="string">'intervalTime'</span>])) &#123;</span><br><span class="line">            $intervalTimeArray = explode(<span class="string">','</span>, $params[<span class="string">'intervalTime'</span>]);</span><br><span class="line">            <span class="keyword">foreach</span> ($intervalTimeArray <span class="keyword">as</span> $interval) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!ctype_digit((string)$interval)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"intervalTime incorrect format"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $priority = <span class="keyword">static</span>::QUEUE_PRIORITY_1;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($params[<span class="string">'priority'</span>]) &amp;&amp; in_array($params[<span class="string">'priority'</span>], array_keys(<span class="keyword">$this</span>-&gt;queueTaskPriority))) &#123;</span><br><span class="line">            $priority = $params[<span class="string">'priority'</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $time = time();</span><br><span class="line">        $task = [</span><br><span class="line">            <span class="string">'topic'</span> =&gt; $params[<span class="string">'topic'</span>],</span><br><span class="line">            <span class="string">'id'</span> =&gt; $params[<span class="string">'id'</span>],</span><br><span class="line">            <span class="string">'priority'</span> =&gt; $priority,</span><br><span class="line">            <span class="string">'status'</span> =&gt; <span class="keyword">static</span>::TASK_STATUS_DELAY,</span><br><span class="line">            <span class="string">'url'</span> =&gt; $params[<span class="string">'url'</span>] ?? <span class="string">''</span>,</span><br><span class="line">            <span class="string">'method'</span> =&gt; $params[<span class="string">'method'</span>] ?? <span class="string">'GET'</span>,</span><br><span class="line">            <span class="string">'call'</span> =&gt; $params[<span class="string">'call'</span>] ?? [],</span><br><span class="line">            <span class="string">'params'</span> =&gt; $params[<span class="string">'params'</span>] ?? [],</span><br><span class="line">            <span class="string">'callback'</span> =&gt; $params[<span class="string">'callback'</span>] ?? [],</span><br><span class="line">            <span class="string">'rule'</span> =&gt; [</span><br><span class="line">                <span class="string">'interval'</span> =&gt; $intervalTimeArray,</span><br><span class="line">                <span class="string">'count'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">                <span class="string">'persistent'</span> =&gt; <span class="keyword">isset</span>($params[<span class="string">'persistent'</span>]) ? (bool)($params[<span class="string">'persistent'</span>]) : <span class="keyword">true</span>,</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">'delayTime'</span> =&gt; $params[<span class="string">'delayTime'</span>] ?? ($time + $intervalTimeArray[<span class="number">0</span>]),</span><br><span class="line">            <span class="string">'lastRunTime'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">            <span class="string">'createTime'</span> =&gt; date(<span class="string">'Y-m-d H:i:s'</span>, $time),</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $task;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>TaskServer.php<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Sevming</span>\<span class="title">DelayedTask</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Sevming</span>\<span class="title">DelayedTask</span>\<span class="title">Traits</span>\<span class="title">HttpTrait</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskServer</span> <span class="keyword">extends</span> <span class="title">DelayedTask</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">HttpTrait</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Log file.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $logFile = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The file to store master process PID.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $pidFile = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Debug mode.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $debug = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The PID of master process.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $masterPid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The PID Map of bucket process.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $bucketPidMap = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The PID Map of queue process.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $queuePidMap = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run all.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">runAll</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkEnv();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;init();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;parseCommand();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;daemonize();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;installSignal();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;saveMasterPid();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;scanBucket();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;scanQueue();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;resetStd();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;monitorProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Check env.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkEnv</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Only for cli</span></span><br><span class="line">        <span class="keyword">if</span> (php_sapi_name() != <span class="string">'cli'</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">"only run in command line mode.\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Only for linux</span></span><br><span class="line">        <span class="keyword">if</span> (strpos(strtolower(PHP_OS), <span class="string">'win'</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">"Not support windows.\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Need pcntl extension</span></span><br><span class="line">        <span class="keyword">if</span> (!extension_loaded(<span class="string">'pcntl'</span>)) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">"Please install pcntl extension.\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Need posix extension</span></span><br><span class="line">        <span class="keyword">if</span> (!extension_loaded(<span class="string">'posix'</span>)) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">"Please install posix extension.\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Need redis extension</span></span><br><span class="line">        <span class="keyword">if</span> (!extension_loaded(<span class="string">'redis'</span>)) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">"Please install redis extension.\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Init.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $backtrace = debug_backtrace();</span><br><span class="line">        $startFile = $backtrace[count($backtrace) - <span class="number">1</span>][<span class="string">'file'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;pidFile)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pidFile = <span class="keyword">__DIR__</span> . <span class="string">'/'</span> . str_replace(<span class="string">'/'</span>, <span class="string">'_'</span>, $startFile) . <span class="string">'.pid'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;logFile)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;logFile = <span class="keyword">__DIR__</span> . <span class="string">'/TaskServer.log'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;logFile = (string)<span class="keyword">$this</span>-&gt;logFile;</span><br><span class="line">        <span class="keyword">if</span> (!is_file(<span class="keyword">$this</span>-&gt;logFile)) &#123;</span><br><span class="line">            touch(<span class="keyword">$this</span>-&gt;logFile);</span><br><span class="line">            chmod(<span class="keyword">$this</span>-&gt;logFile, <span class="number">0622</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;setProcessTitle(<span class="string">'master'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Parse command.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseCommand</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $argv;</span><br><span class="line"></span><br><span class="line">        $availableCommands = [<span class="string">'start'</span>, <span class="string">'stop'</span>];</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($argv[<span class="number">1</span>]) || !in_array($argv[<span class="number">1</span>], $availableCommands)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($argv[<span class="number">1</span>])) &#123;</span><br><span class="line">                <span class="keyword">exit</span>(<span class="string">"Unknown command: &#123;$argv[1]&#125;\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $command = <span class="keyword">isset</span>($argv[<span class="number">1</span>]) ? trim($argv[<span class="number">1</span>]) : <span class="string">''</span>;</span><br><span class="line">        <span class="comment">// Avoid repeated run</span></span><br><span class="line">        $masterPid = is_file(<span class="keyword">$this</span>-&gt;pidFile) ? file_get_contents(<span class="keyword">$this</span>-&gt;pidFile) : <span class="number">0</span>;</span><br><span class="line">        $masterIsAlive = $masterPid &amp;&amp; posix_kill($masterPid, <span class="number">0</span>) &amp;&amp; posix_getpid() != $masterPid;</span><br><span class="line">        <span class="keyword">if</span> ($masterIsAlive &amp;&amp; $command === <span class="string">'start'</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;log(<span class="string">'already running'</span>);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($command) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'stop'</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;log(<span class="string">'process is stopping ...'</span>);</span><br><span class="line">                <span class="comment">// Send stop signal to master process.</span></span><br><span class="line">                $masterPid &amp;&amp; posix_kill($masterPid, SIGINT);</span><br><span class="line">                $timeout = <span class="number">5</span>;</span><br><span class="line">                $startTime = time();</span><br><span class="line">                <span class="comment">// Check master process is still alive?</span></span><br><span class="line">                <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                    $masterIsAlive = $masterPid &amp;&amp; posix_kill($masterPid, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> ($masterIsAlive) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (time() - $startTime &gt;= $timeout) &#123;</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;log(<span class="string">'process stop fail.'</span>);</span><br><span class="line">                            <span class="keyword">exit</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        usleep(<span class="number">10000</span>);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">$this</span>-&gt;log(<span class="string">'process stop success.'</span>);</span><br><span class="line">                    <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run as deamon mode.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">daemonize</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;debug) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $pid = pcntl_fork();</span><br><span class="line">        <span class="keyword">if</span> ($pid === <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'fork fail'</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (posix_setsid() === <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'setsid fail'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fork again avoid SVR4 system regain the control of terminal.</span></span><br><span class="line">        $pid = pcntl_fork();</span><br><span class="line">        <span class="keyword">if</span> ($pid === <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'fork fail'</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        umask(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setProcessTitle(<span class="string">'master'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Install signal.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">installSignal</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// stop</span></span><br><span class="line">        pcntl_signal(SIGINT, [<span class="keyword">$this</span>, <span class="string">'signalHandler'</span>], <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">        pcntl_signal(SIGPIPE, SIG_IGN, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Signal handler.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $signal</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">signalHandler</span><span class="params">($signal)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> ($signal) &#123;</span><br><span class="line">            <span class="keyword">case</span> SIGINT:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;stopAll();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Stop all.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stopAll</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// For master process</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;masterPid === posix_getpid()) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;log(<span class="string">"master process &#123;$this-&gt;masterPid&#125; stopping ..."</span>);</span><br><span class="line"></span><br><span class="line">            $childPidMap = array_merge(<span class="keyword">$this</span>-&gt;bucketPidMap, <span class="keyword">$this</span>-&gt;queuePidMap);</span><br><span class="line">            <span class="keyword">foreach</span> ($childPidMap <span class="keyword">as</span> $pid) &#123;</span><br><span class="line">                posix_kill($pid, SIGKILL);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;log(<span class="string">"child process &#123;$pid&#125; stopping success."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="comment">// For child processes</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Save master pid.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">saveMasterPid</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;masterPid = posix_getpid();</span><br><span class="line">        <span class="keyword">if</span> (file_put_contents(<span class="keyword">$this</span>-&gt;pidFile, <span class="keyword">$this</span>-&gt;masterPid) === <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'can not save pid to '</span> . <span class="keyword">$this</span>-&gt;pidFile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reset Std.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resetStd</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;debug) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fclose(STDIN);</span><br><span class="line">        fclose(STDOUT);</span><br><span class="line">        fclose(STDERR);</span><br><span class="line">        $stdoutFile = <span class="string">'/dev/null'</span>;</span><br><span class="line">        fopen($stdoutFile, <span class="string">'r'</span>);</span><br><span class="line">        fopen($stdoutFile, <span class="string">'a'</span>);</span><br><span class="line">        fopen($stdoutFile, <span class="string">'a'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Scan Bucket in real time to handle delayed tasks.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">scanBucket</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="keyword">$this</span>-&gt;bucketCount; $i++) &#123;</span><br><span class="line">            $pid = pcntl_fork();</span><br><span class="line">            <span class="keyword">if</span> ($pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;bucketPidMap[$pid] = $pid;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> ($pid === <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'bucket fork fail'</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// Re-establish a redis connection for each process.</span></span><br><span class="line">                    <span class="keyword">static</span>::$redis = <span class="keyword">null</span>;</span><br><span class="line">                    $redis = <span class="keyword">$this</span>-&gt;getRedisInstance();</span><br><span class="line">                    $taskPoolKey = <span class="keyword">$this</span>-&gt;getTaskPoolKey();</span><br><span class="line">                    $bucketKey = <span class="keyword">$this</span>-&gt;getBucketKey(<span class="string">''</span>, $i);</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;setProcessTitle(<span class="string">'bucket'</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                        pcntl_signal_dispatch();</span><br><span class="line">                        <span class="comment">// Get a delay task with a delay time less than or equal to the current time</span></span><br><span class="line">                        $taskKeyArray = $redis-&gt;zRangeByScore($bucketKey, <span class="string">'-inf'</span>, time(), [</span><br><span class="line">                            <span class="string">'withscores'</span> =&gt; <span class="keyword">true</span>,</span><br><span class="line">                            <span class="string">'limit'</span> =&gt; [<span class="number">0</span>, <span class="keyword">$this</span>-&gt;bucketRangeLimit],</span><br><span class="line">                        ]);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (!<span class="keyword">empty</span>($taskKeyArray)) &#123;</span><br><span class="line">                            <span class="keyword">foreach</span> ($taskKeyArray <span class="keyword">as</span> $taskKey =&gt; $score) &#123;</span><br><span class="line">                                <span class="keyword">if</span> ($task = $redis-&gt;hGet($taskPoolKey, $taskKey)) &#123;</span><br><span class="line">                                    <span class="comment">// Decode task.</span></span><br><span class="line">                                    $task = json_decode($task, <span class="keyword">true</span>);</span><br><span class="line">                                    <span class="keyword">if</span> ($task[<span class="string">'status'</span>] === <span class="keyword">static</span>::TASK_STATUS_DELAY) &#123;</span><br><span class="line">                                        <span class="comment">// Add lock.</span></span><br><span class="line">                                        $lockData = <span class="keyword">$this</span>-&gt;lock($taskKey);</span><br><span class="line"></span><br><span class="line">                                        <span class="keyword">if</span> ($lockData) &#123;</span><br><span class="line">                                            <span class="keyword">if</span> ($redis-&gt;zRem($bucketKey, $taskKey)) &#123;</span><br><span class="line">                                                <span class="comment">// Add tasks to different queues based on task priority</span></span><br><span class="line">                                                <span class="keyword">if</span> (!$redis-&gt;rPush(<span class="keyword">$this</span>-&gt;getQueueKey($task[<span class="string">'priority'</span>]), $taskKey)) &#123;</span><br><span class="line">                                                    <span class="keyword">$this</span>-&gt;log(<span class="string">"bucket rPush fail,taskKey=&#123;$taskKey&#125;"</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                                            &#125;</span><br><span class="line"></span><br><span class="line">                                            <span class="comment">// Unlock.</span></span><br><span class="line">                                            <span class="keyword">$this</span>-&gt;unLock($lockData);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        $redis-&gt;zRem($bucketKey, $taskKey);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;log($e-&gt;getMessage());</span><br><span class="line">                    <span class="keyword">exit</span>(<span class="number">250</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Scan Queue in real time to handle tasks.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">scanQueue</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="keyword">$this</span>-&gt;queueCount; $i++) &#123;</span><br><span class="line">            $pid = pcntl_fork();</span><br><span class="line">            <span class="keyword">if</span> ($pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;queuePidMap[$pid] = $pid;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> ($pid === <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'queue fork fail'</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// Re-establish a redis connection for each process.</span></span><br><span class="line">                    <span class="keyword">static</span>::$redis = <span class="keyword">null</span>;</span><br><span class="line">                    $redis = <span class="keyword">$this</span>-&gt;getRedisInstance();</span><br><span class="line">                    $taskPoolKey = <span class="keyword">$this</span>-&gt;getTaskPoolKey();</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;setProcessTitle(<span class="string">'queue'</span>);</span><br><span class="line">                    $queueTaskPriority = array_reverse(<span class="keyword">$this</span>-&gt;queueTaskPriority, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                        pcntl_signal_dispatch();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">foreach</span> ($queueTaskPriority <span class="keyword">as</span> $priority =&gt; $nums) &#123;</span><br><span class="line">                            $queueKey = <span class="keyword">$this</span>-&gt;getQueueKey($priority);</span><br><span class="line">                            <span class="comment">// Process $nums tasks each time, avoiding the inability to handle higher priority tasks</span></span><br><span class="line">                            <span class="keyword">while</span> ($nums--) &#123;</span><br><span class="line">                                $taskKey = $redis-&gt;lPop($queueKey);</span><br><span class="line">                                <span class="keyword">if</span> (<span class="keyword">empty</span>($taskKey)) &#123;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> ($task = $redis-&gt;hGet($taskPoolKey, $taskKey)) &#123;</span><br><span class="line">                                    $task = json_decode($task, <span class="keyword">true</span>);</span><br><span class="line">                                    <span class="keyword">if</span> ($task[<span class="string">'status'</span>] === <span class="keyword">static</span>::TASK_STATUS_DELAY &amp;&amp; $task[<span class="string">'delayTime'</span>] &lt;= time()) &#123;</span><br><span class="line">                                        $newTask = <span class="keyword">$this</span>-&gt;handleTask($task);</span><br><span class="line">                                        $redis-&gt;hSet($taskPoolKey, $taskKey, json_encode($newTask));</span><br><span class="line">                                        <span class="keyword">if</span> ($newTask[<span class="string">'status'</span>] === <span class="keyword">static</span>::TASK_STATUS_DELAY) &#123;</span><br><span class="line">                                            <span class="comment">// Save the task ID, with the task delay execution time as the sort value</span></span><br><span class="line">                                            $redis-&gt;zAdd(<span class="keyword">$this</span>-&gt;getBucketKey($newTask[<span class="string">'topic'</span>]), $newTask[<span class="string">'delayTime'</span>], $taskKey);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;log($e-&gt;getMessage());</span><br><span class="line">                    <span class="keyword">exit</span>(<span class="number">250</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle task.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $task</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">handleTask</span><span class="params">(array $task)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($task[<span class="string">'url'</span>])) &#123;</span><br><span class="line">            $result = <span class="keyword">static</span>::request($task[<span class="string">'url'</span>], $task[<span class="string">'params'</span>], $task[<span class="string">'method'</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">list</span> ($class, $action) = $task[<span class="string">'call'</span>];</span><br><span class="line">            <span class="keyword">if</span> (!class_exists($class) || !method_exists($class, $action)) &#123;</span><br><span class="line">                $result = <span class="string">'fail'</span>;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;log(<span class="string">"call class &#123;$class&#125; not exists or action &#123;$action&#125; not exists."</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $result = (<span class="keyword">new</span> $class())-&gt;$action($task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $task[<span class="string">'lastRunTime'</span>] = date(<span class="string">'Y-m-d H:i:s'</span>);</span><br><span class="line">        $task[<span class="string">'rule'</span>][<span class="string">'count'</span>]++;</span><br><span class="line">        $result = strtolower((string)$result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($result === <span class="string">'success'</span>) &#123;</span><br><span class="line">            $task[<span class="string">'status'</span>] = <span class="keyword">static</span>::TASK_STATUS_OK;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">empty</span>($task[<span class="string">'callback'</span>])) &#123;</span><br><span class="line">                <span class="keyword">list</span> ($class, $action) = $task[<span class="string">'callback'</span>];</span><br><span class="line">                <span class="keyword">if</span> (!class_exists($class) || !method_exists($class, $action)) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;log(<span class="string">"callback class &#123;$class&#125; not exists or action &#123;$action&#125; not exists."</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $result = (<span class="keyword">new</span> $class())-&gt;$action($task);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($result === <span class="string">'fail'</span>) &#123;</span><br><span class="line">            $task[<span class="string">'status'</span>] = <span class="keyword">static</span>::TASK_STATUS_FAIL;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $index = $task[<span class="string">'rule'</span>][<span class="string">'count'</span>];</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">isset</span>($task[<span class="string">'rule'</span>][<span class="string">'interval'</span>][$index]) &amp;&amp; !$task[<span class="string">'rule'</span>][<span class="string">'persistent'</span>]) &#123;</span><br><span class="line">                $task[<span class="string">'status'</span>] = <span class="keyword">static</span>::TASK_STATUS_FAIL;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $intervalTime = $task[<span class="string">'rule'</span>][<span class="string">'interval'</span>][$index] ?? end($task[<span class="string">'rule'</span>][<span class="string">'interval'</span>]);</span><br><span class="line">                $delayTime = $task[<span class="string">'delayTime'</span>] + $intervalTime;</span><br><span class="line">                $nowTime = time();</span><br><span class="line">                <span class="keyword">if</span> ($delayTime &lt; $nowTime) &#123;</span><br><span class="line">                    $delayTime = $nowTime + $intervalTime;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $task[<span class="string">'delayTime'</span>] = $delayTime;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $task;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Monitor process.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">monitorProcess</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            pcntl_signal_dispatch();</span><br><span class="line">            $status = <span class="number">0</span>;</span><br><span class="line">            $pid = pcntl_wait($status, WUNTRACED);</span><br><span class="line">            pcntl_signal_dispatch();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ($pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ($status !== <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;log(<span class="string">"child process &#123;$pid&#125; exit with status &#123;$status&#125;"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;bucketPidMap[$pid], <span class="keyword">$this</span>-&gt;queuePidMap[$pid]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;bucketPidMap) &amp;&amp; <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;queuePidMap)) &#123;</span><br><span class="line">                @unlink(<span class="keyword">$this</span>-&gt;pidFile);</span><br><span class="line">                <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set process title.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $title</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setProcessTitle</span><span class="params">(string $title)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (function_exists(<span class="string">'cli_set_process_title'</span>)) &#123;</span><br><span class="line">            cli_set_process_title(<span class="keyword">$this</span>-&gt;prefix . $title);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Log.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $msg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(string $msg)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $msg = date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">' ['</span> . <span class="keyword">static</span>::class . <span class="string">'] '</span> . $msg . PHP_EOL;</span><br><span class="line">        file_put_contents((string)<span class="keyword">$this</span>-&gt;logFile, $msg, FILE_APPEND | LOCK_EX);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DelayedTask.php<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Sevming</span>\<span class="title">DelayedTask</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">RedisException</span>, <span class="title">Redis</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DelayedTask</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $prefix = <span class="string">'dt_'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the number of delayed tasks each time.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $bucketRangeLimit = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Number of bucket processes.(Number of storage bucket.)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $bucketCount = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Number of queue processes.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $queueCount = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Redis config.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $config = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Redis instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> $redis = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Number of task processing corresponding to queue priority.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $queueTaskPriority = [</span><br><span class="line">        <span class="keyword">self</span>::QUEUE_PRIORITY_1 =&gt; <span class="number">2</span>,</span><br><span class="line">        <span class="keyword">self</span>::QUEUE_PRIORITY_2 =&gt; <span class="number">3</span>,</span><br><span class="line">        <span class="keyword">self</span>::QUEUE_PRIORITY_3 =&gt; <span class="number">5</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">const</span> QUEUE_PRIORITY_1 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">const</span> QUEUE_PRIORITY_2 = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">const</span> QUEUE_PRIORITY_3 = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Task status delay.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">const</span> TASK_STATUS_DELAY = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Task status ok.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">const</span> TASK_STATUS_OK = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Task status fail.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">const</span> TASK_STATUS_FAIL = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Task status deleted.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">const</span> TASK_STATUS_DELETED = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $host</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int    $port</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $auth</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $host = <span class="string">'127.0.0.1'</span>, int $port = <span class="number">6379</span>, string $auth = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config = [</span><br><span class="line">            <span class="string">'host'</span> =&gt; $host,</span><br><span class="line">            <span class="string">'port'</span> =&gt; $port,</span><br><span class="line">            <span class="string">'auth'</span> =&gt; $auth,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get redis.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Redis</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RedisException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRedisInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="keyword">static</span>::$redis)) &#123;</span><br><span class="line">            $redis = <span class="keyword">new</span> \Redis();</span><br><span class="line">            $redis-&gt;connect(<span class="keyword">$this</span>-&gt;config[<span class="string">'host'</span>], <span class="keyword">$this</span>-&gt;config[<span class="string">'port'</span>]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!$redis-&gt;auth(<span class="keyword">$this</span>-&gt;config[<span class="string">'auth'</span>])) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RedisException(<span class="string">"redis password verification failed, auth=&#123;$this-&gt;config['auth']&#125;"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ($redis-&gt;ping() !== <span class="string">'+PONG'</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RedisException(<span class="string">"redis connection is not available, ping=&#123;$redis-&gt;ping()&#125;"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">static</span>::$redis = $redis;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::$redis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get task pool key.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getTaskPoolKey</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prefix . <span class="string">'task_pool'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get task key.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $topic</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed  $id</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getTaskKey</span><span class="params">(string $topic, $id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $topic . <span class="string">':'</span> . $id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get bucket key.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $topic</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool   $flag</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getBucketKey</span><span class="params">(string $topic = <span class="string">''</span>, $flag = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $key = crc32($topic) % <span class="keyword">$this</span>-&gt;bucketCount;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prefix . <span class="string">'task_bucket:'</span> . ($flag !== <span class="keyword">false</span> ? $flag : $key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get queue key.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $priority</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getQueueKey</span><span class="params">(int $priority)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prefix . <span class="string">'task_queue:'</span> . $priority;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Lock.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $taskKey</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">lock</span><span class="params">(string $taskKey)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $redis = <span class="keyword">$this</span>-&gt;getRedisInstance();</span><br><span class="line">        $lockKey = <span class="keyword">$this</span>-&gt;prefix . <span class="string">'task_lock:'</span> . $taskKey;</span><br><span class="line">        $lockValue = md5(uniqid(md5(microtime(<span class="keyword">true</span>)), <span class="keyword">true</span>));</span><br><span class="line">        $status = $redis-&gt;set($lockKey, $lockValue, [<span class="string">'nx'</span>, <span class="string">'px'</span> =&gt; <span class="number">3000</span>]);</span><br><span class="line">        <span class="keyword">if</span> ($status) &#123;</span><br><span class="line">            <span class="keyword">return</span> [$lockKey, $lockValue];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Unlock.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $lockData</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">unlock</span><span class="params">(array $lockData)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $redis = <span class="keyword">$this</span>-&gt;getRedisInstance();</span><br><span class="line">        $script = <span class="string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $redis-&gt;eval($script, $lockData, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>HttpTrait.php<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Sevming</span>\<span class="title">DelayedTask</span>\<span class="title">Traits</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> HttpTrait</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array  $params</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $method</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int    $timeout</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array  $headers</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array  $userAgent</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">request</span><span class="params">(string $url, array $params = [], string $method = <span class="string">'GET'</span>, int $timeout = <span class="number">1</span>, array $headers = [], array $userAgent = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!preg_match(<span class="string">'/^(http|https)/is'</span>, $url)) &#123;</span><br><span class="line">            $url = <span class="string">'http://'</span> . $url;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        $method = strtoupper($method);</span><br><span class="line">        <span class="keyword">switch</span> ($method) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'GET'</span>:</span><br><span class="line">                $url .= <span class="string">'?'</span> . http_build_query($params);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'POST'</span>:</span><br><span class="line">                curl_setopt($ch, CURLOPT_POST, <span class="keyword">true</span>);</span><br><span class="line">                curl_setopt($ch, CURLOPT_POSTFIELDS, $params);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="keyword">false</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($timeout &gt; <span class="number">0</span> &amp;&amp; $timeout &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            $timeout = (int)($timeout * <span class="number">1000</span>);</span><br><span class="line">            curl_setopt($ch, CURLOPT_NOSIGNAL, <span class="keyword">true</span>);</span><br><span class="line">            curl_setopt($ch, CURLOPT_TIMEOUT_MS, $timeout);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $timeout = (int)$timeout;</span><br><span class="line">            curl_setopt($ch, CURLOPT_TIMEOUT, $timeout);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($headers)) &#123;</span><br><span class="line">            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($userAgent)) &#123;</span><br><span class="line">            curl_setopt($ch, CURLOPT_USERAGENT, $userAgent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $result = curl_exec($ch);</span><br><span class="line">        $errno = curl_errno($ch);</span><br><span class="line">        curl_close($ch);</span><br><span class="line">        <span class="keyword">if</span> (!$errno) &#123;</span><br><span class="line">            <span class="keyword">return</span> $result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis 分布式锁</title>
    <url>/PHP/redis-distributed-lock.html</url>
    <content><![CDATA[<blockquote class="blockquote-center"><p>如果不同的系统或是同一个系统的不同主机之间共享了一个或一组资源, 往往需要互斥来防止彼此干扰, 以保证一致性, 这时就需要用到分布式锁</p>
</blockquote>
<h5 id="分布式锁需要具备的几个条件"><a href="#分布式锁需要具备的几个条件" class="headerlink" title="分布式锁需要具备的几个条件"></a>分布式锁需要具备的几个条件</h5><ol>
<li>只有一个客户端能持有锁</li>
<li>加锁和解锁必须是同一个客户端</li>
<li>网络中断或宕机无法释放锁时,锁会自动清除,不能发生死锁</li>
<li>性能要好</li>
</ol>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$host = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">$port = <span class="number">6379</span>;</span><br><span class="line">$auth = <span class="string">'123456'</span>;</span><br><span class="line"></span><br><span class="line">$redis = <span class="keyword">new</span> \Redis();</span><br><span class="line">$redis-&gt;connect($host, $port);</span><br><span class="line">$redis-&gt;auth($auth) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"redis password verification failed, auth=&#123;$auth&#125;"</span>);</span><br><span class="line">$redis-&gt;ping() == <span class="string">'+PONG'</span> <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"redis connection is not available, ping=&#123;$redis-&gt;ping()&#125;"</span>);</span><br><span class="line"></span><br><span class="line">$expireTime = <span class="number">10000</span>;</span><br><span class="line"><span class="comment">// lockKey 必须唯一</span></span><br><span class="line">$lockKey = <span class="string">'test_1'</span>;</span><br><span class="line"><span class="comment">// lockValue 必须唯一</span></span><br><span class="line">$lockValue = md5(uniqid(md5(microtime(<span class="keyword">true</span>)), <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加锁</span></span><br><span class="line">$status = $redis-&gt;set($lockKey, $lockValue, [<span class="string">'nx'</span>, <span class="string">'px'</span> =&gt; $expireTime]);</span><br><span class="line"><span class="keyword">if</span> ($status) &#123;</span><br><span class="line">    <span class="comment">// 相关逻辑...</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Add lock ok.'</span> . PHP_EOL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 redis 的 eval (lua 语法), 把对比和删除变成原子操作</span></span><br><span class="line">    $script = <span class="string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;</span><br><span class="line">    $result = $redis-&gt;eval($script, [$lockKey, $lockValue], <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Del lock '</span> . ($result ? <span class="string">'ok'</span> : <span class="string">'fail'</span>) . PHP_EOL;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Add lock fail'</span> . PHP_EOL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Websocket 相关</title>
    <url>/Websocket/websocket.html</url>
    <content><![CDATA[<h5 id="心跳包-断线重连"><a href="#心跳包-断线重连" class="headerlink" title="心跳包 - 断线重连"></a>心跳包 - 断线重连</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 避免重复连接</span></span><br><span class="line"><span class="keyword">let</span> lockReconnect = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> ws = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> wsUrl = <span class="string">'192.168.50.37:8181'</span>;</span><br><span class="line">createWebSocket(wsUrl);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立websocket连接</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createWebSocket</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ws = <span class="keyword">new</span> WebSocket(<span class="string">'ws://'</span> + wsUrl);</span><br><span class="line">        initEventHandle();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        reconnect(wsUrl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重连</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconnect</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (lockReconnect) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lockReconnect = <span class="literal">true</span>;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        createWebSocket(wsUrl);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'正在重连,当前时间：'</span> + <span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">        lockReconnect = <span class="literal">false</span>;</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initEventHandle</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 连接成功后</span></span><br><span class="line">    ws.onopen = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'连接成功'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 心跳检测重置</span></span><br><span class="line">        heartCheck.reset();</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 收到消息后</span></span><br><span class="line">    ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 心跳检测重置</span></span><br><span class="line">        heartCheck.reset();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> data = <span class="built_in">JSON</span>.parse(e.data);</span><br><span class="line">        <span class="keyword">switch</span> (data.req_type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'beat'</span>:</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'心跳检测成功,当前时间：'</span> + <span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'login'</span>:</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'SERVER：'</span> + data.body.time);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接关闭后</span></span><br><span class="line">    ws.onclose = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'关闭连接'</span>);</span><br><span class="line">        reconnect(wsUrl);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ws.onerror = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        reconnect();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 心跳检测</span></span><br><span class="line"><span class="keyword">let</span> heartCheck = &#123;</span><br><span class="line">    timeout: <span class="number">15000</span>,</span><br><span class="line">    timeoutObj: <span class="literal">null</span>,</span><br><span class="line">    serverTimeoutObj: <span class="literal">null</span>,</span><br><span class="line">    reset: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        clearTimeout(<span class="keyword">this</span>.timeoutObj);</span><br><span class="line">        clearTimeout(<span class="keyword">this</span>.serverTimeoutObj);</span><br><span class="line">        <span class="keyword">this</span>.start();</span><br><span class="line">    &#125;,</span><br><span class="line">    start: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> self = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">this</span>.timeoutObj = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">let</span> heartData = &#123;</span><br><span class="line">                req_type: <span class="string">'beat'</span>,</span><br><span class="line">                req_id: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(),</span><br><span class="line">                body: [],</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            ws.send(<span class="built_in">JSON</span>.stringify(heartData));</span><br><span class="line">            <span class="comment">// 发送心跳包</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'发送心跳包,当前时间：'</span> + <span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果超过一定时间还没重置,说明后端主动断开了</span></span><br><span class="line">            self.serverTimeoutObj = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                ws.close();</span><br><span class="line">            &#125;, self.timeout);</span><br><span class="line">        &#125;, <span class="keyword">this</span>.timeout)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<div class="note warning"><p>参考资料</p></div>
<p><a href="https://www.cnblogs.com/1wen/p/5808276.html" target="_blank" rel="noopener">初探和实现websocket心跳重连(npm: websocket-heartbeat-js)</a></p>
]]></content>
      <categories>
        <category>Websocket</category>
      </categories>
      <tags>
        <tag>websocket</tag>
      </tags>
  </entry>
  <entry>
    <title>任务调度</title>
    <url>/PHP/task-scheduling.html</url>
    <content><![CDATA[<h5 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> 运行命令 php TaskScheduling.php start -d</span><br><span class="line"><span class="number">2.</span> checkEnv 检测运行环境 </span><br><span class="line"><span class="number">3.</span> init 初始化</span><br><span class="line">    <span class="number">3.1</span> 定义保存主进程ID的文件(pidFile)</span><br><span class="line">    <span class="number">3.2</span> 生成日志文件(logFile)</span><br><span class="line">    <span class="number">3.3</span> 设置主进程标题</span><br><span class="line">    <span class="number">3.4</span> 定时器初始化</span><br><span class="line"><span class="number">4.</span> parseCommand 解析命令</span><br><span class="line">    <span class="number">4.1</span> 检查命令是否正确</span><br><span class="line">    <span class="number">4.2</span> 检测主进程是否存在,避免重复运行</span><br><span class="line"><span class="number">5.</span> daemonize 以守护进程模式运行,即后台运行</span><br><span class="line"><span class="number">6.</span> installSignal 安装信号</span><br><span class="line"><span class="number">7.</span> saveMasterPid 保存主进程ID到文件(pidFile)</span><br><span class="line"><span class="number">8.</span> forkProcess 循环创建子进程,到这一步后,主进程和子进程开始执行各自的逻辑</span><br><span class="line">    <span class="number">8.1</span> 主进程</span><br><span class="line">        <span class="number">8.1</span><span class="number">.1</span> 保存创建的子进程ID(childPidMap)</span><br><span class="line">        <span class="number">8.1</span><span class="number">.2</span> resetStd 关闭标准输出</span><br><span class="line">        <span class="number">8.1</span><span class="number">.3</span> monitorProcess 监控进程</span><br><span class="line">            <span class="number">8.1</span><span class="number">.3</span><span class="number">.1</span> 监控子进程退出(异常退出时记录日志并重新启动)</span><br><span class="line">            <span class="number">8.1</span><span class="number">.3</span><span class="number">.2</span> 监控主进程退出(前提是子进程已全部退出)</span><br><span class="line">    <span class="number">8.2</span> 子进程</span><br><span class="line">        <span class="number">8.2</span><span class="number">.1</span> 执行回调函数 onStart</span><br><span class="line">        <span class="number">8.2</span><span class="number">.2</span> 循环检查是否有未处理的信号</span><br></pre></td></tr></table></figure>
<h5 id="停止流程"><a href="#停止流程" class="headerlink" title="停止流程"></a>停止流程</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> 运行命令 php TaskScheduling.php stop</span><br><span class="line"><span class="number">2.</span> checkEnv 检测运行环境 </span><br><span class="line"><span class="number">3.</span> init 初始化</span><br><span class="line">    <span class="number">3.1</span> 定义保存主进程ID的文件(pidFile)</span><br><span class="line">    <span class="number">3.2</span> 生成日志文件(logFile)</span><br><span class="line">    <span class="number">3.3</span> 设置主进程标题</span><br><span class="line">    <span class="number">3.4</span> 定时器初始化</span><br><span class="line"><span class="number">4.</span> parseCommand 解析命令</span><br><span class="line">    <span class="number">4.1</span> 检查命令是否正确</span><br><span class="line">    <span class="number">4.2</span> 检测主进程是否存在,避免重复运行</span><br><span class="line">    <span class="number">4.3</span> 发送停止信号给主进程</span><br><span class="line">        <span class="number">4.3</span><span class="number">.1</span> signalHandler 触发安装信号时的回调函数 </span><br><span class="line">        <span class="number">4.3</span><span class="number">.2</span> stopAll 停止所有进程</span><br><span class="line">            <span class="number">4.3</span><span class="number">.2</span><span class="number">.1</span> 发送停止信号给所有子进程,到这一步后,主进程和子进程开始执行各自的逻辑</span><br><span class="line">                <span class="number">4.3</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span> 主进程</span><br><span class="line">                    I. 如果不是优雅停止,则启用定时器,<span class="number">2</span>秒后杀死子进程</span><br><span class="line">                    II. 每隔<span class="number">1</span>秒检测子进程是否被杀死,若已被杀死,则释放childPidMap对应的pid</span><br><span class="line">                    III. monitorProcess 监听到子进程退出,则释放childPidMap对应的pid,当子进程全部退出后,则退出主进程,并删除主进程PID的保存文件</span><br><span class="line">                <span class="number">4.3</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span> 子进程</span><br><span class="line">                    I. signalHandler 触发安装信号时的回调函数</span><br><span class="line">                    II. stopAll 停止所有进程</span><br><span class="line">                    III. 执行回调函数 onStop</span><br><span class="line">                    IV. 退出子进程</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="Timer-Class"><a href="#Timer-Class" class="headerlink" title="Timer Class"></a>Timer Class</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tasks that based on ALARM signal.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $tasks = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Init.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Install a signal processor</span></span><br><span class="line">        pcntl_signal(SIGALRM, [<span class="string">'Timer'</span>, <span class="string">'signalHandler'</span>], <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ALARM signal handler.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">signalHandler</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        pcntl_alarm(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">self</span>::tick();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add task.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> float $timeInterval</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> callable $func</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool $persistent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($timeInterval, $func, $persistent = true)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">self</span>::$tasks)) &#123;</span><br><span class="line">            pcntl_alarm(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $nowTime = time();</span><br><span class="line">        $runTime = $nowTime + $timeInterval;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="keyword">self</span>::$tasks[$runTime])) &#123;</span><br><span class="line">            <span class="keyword">self</span>::$tasks[$runTime] = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>::$tasks[$runTime][] = [$timeInterval, $func, $persistent];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tick.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">tick</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">self</span>::$tasks)) &#123;</span><br><span class="line">            pcntl_alarm(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $nowTime = time();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">self</span>::$tasks <span class="keyword">as</span> $runTime =&gt; $taskData) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($nowTime &gt;= $runTime) &#123;</span><br><span class="line">                <span class="keyword">foreach</span> ($taskData <span class="keyword">as</span> $index =&gt; $task) &#123;</span><br><span class="line">                    call_user_func_array($task[<span class="number">1</span>], []);</span><br><span class="line">                    <span class="keyword">if</span> ($task[<span class="number">2</span>]) &#123;</span><br><span class="line">                        <span class="keyword">self</span>::add($task[<span class="number">0</span>], $task[<span class="number">1</span>], $task[<span class="number">2</span>]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">unset</span>(<span class="keyword">self</span>::$tasks[$runTime]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="TaskScheduling-Class"><a href="#TaskScheduling-Class" class="headerlink" title="TaskScheduling Class"></a>TaskScheduling Class</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskScheduling</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Status starting.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> STATUS_STARTING = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Status running.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> STATUS_RUNNING = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Status shutdown.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> STATUS_SHUTDOWN = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Number of processes.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Log file.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $logFile = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The file to store master process PID.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $pidFile = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Emitted when processes start.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> callback</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $onStart = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Emitted when processes stoped.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> callback</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $onStop = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Start file.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $startFile = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Daemonize mode.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $daemonizeMode = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Graceful stop or not.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $gracefulStop = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The PID of master process.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $masterPid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The PID Map of child process.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $childPidMap = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Current status.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run all.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">runAll</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkEnv();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;init();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;parseCommand();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;daemonize();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;installSignal();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;saveMasterPid();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;forkProcess();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;resetStd();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;monitorProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Check env.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkEnv</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Only for cli</span></span><br><span class="line">        <span class="keyword">if</span> (php_sapi_name() != <span class="string">'cli'</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">"only run in command line mode \n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Only for linux</span></span><br><span class="line">        <span class="keyword">if</span> (strpos(strtolower(PHP_OS), <span class="string">'win'</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">"Not support windows\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Need pcntl extension</span></span><br><span class="line">        <span class="keyword">if</span> (!extension_loaded(<span class="string">'pcntl'</span>)) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">"Please install pcntl extension."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Need posix extension</span></span><br><span class="line">        <span class="keyword">if</span> (!extension_loaded(<span class="string">'posix'</span>)) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">"Please install posix extension."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Init.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $backtrace = debug_backtrace();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;startFile = $backtrace[count($backtrace) - <span class="number">1</span>][<span class="string">'file'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;pidFile)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pidFile = <span class="keyword">__DIR__</span> . <span class="string">'/'</span> . str_replace(<span class="string">'/'</span>, <span class="string">'_'</span>, <span class="keyword">$this</span>-&gt;startFile) . <span class="string">'.pid'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;logFile)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;logFile = <span class="keyword">__DIR__</span> . <span class="string">'/'</span> . <span class="keyword">static</span>::class . <span class="string">'.log'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;logFile = (string)<span class="keyword">$this</span>-&gt;logFile;</span><br><span class="line">        <span class="keyword">if</span> (!is_file(<span class="keyword">$this</span>-&gt;logFile)) &#123;</span><br><span class="line">            touch(<span class="keyword">$this</span>-&gt;logFile);</span><br><span class="line">            chmod(<span class="keyword">$this</span>-&gt;logFile, <span class="number">0622</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;status = <span class="keyword">static</span>::STATUS_STARTING;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setProcessTitle(<span class="string">'master process start_file='</span> . <span class="keyword">$this</span>-&gt;startFile);</span><br><span class="line"></span><br><span class="line">        Timer::init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Parse command.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseCommand</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $argv;</span><br><span class="line"></span><br><span class="line">        $availableCommands = [</span><br><span class="line">            <span class="string">'start'</span>,</span><br><span class="line">            <span class="string">'stop'</span>,</span><br><span class="line">        ];</span><br><span class="line">        $usage = <span class="string">"&lt;y&gt;Usage: &lt;/y&gt;\n  php yourfile &lt;command&gt; [mode]\n&lt;y&gt;Available commands:&lt;/y&gt;\n  &lt;g&gt;start&lt;/g&gt;\t\tStart task in DEBUG mode. [Use mode -d to start in DAEMON mode]\n  &lt;g&gt;stop&lt;/g&gt;\t\tStop task.\n"</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($argv[<span class="number">1</span>]) || !in_array($argv[<span class="number">1</span>], $availableCommands)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($argv[<span class="number">1</span>])) &#123;</span><br><span class="line">                <span class="keyword">static</span>::output(<span class="string">"Unknown command: &#123;$argv[1]&#125;\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $command = trim($argv[<span class="number">1</span>]);</span><br><span class="line">        $mode = $argv[<span class="number">2</span>] ?? <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start command.</span></span><br><span class="line">        <span class="keyword">if</span> ($command === <span class="string">'start'</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($mode === <span class="string">'-d'</span> || <span class="keyword">$this</span>-&gt;daemonizeMode) &#123;</span><br><span class="line">                $modeDesc = <span class="string">' in DAEMON mode.'</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $modeDesc = <span class="string">' in DEBUG mode.'</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;log($command . $modeDesc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Avoid repeated run</span></span><br><span class="line">        $masterPid = is_file(<span class="keyword">$this</span>-&gt;pidFile) ? file_get_contents(<span class="keyword">$this</span>-&gt;pidFile) : <span class="number">0</span>;</span><br><span class="line">        $masterIsAlive = $masterPid &amp;&amp; posix_kill($masterPid, <span class="number">0</span>) &amp;&amp; posix_getpid() != $masterPid;</span><br><span class="line">        <span class="keyword">if</span> ($masterIsAlive &amp;&amp; $command === <span class="string">'start'</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;log(<span class="string">'already running'</span>, $masterPid);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($command) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'start'</span>:</span><br><span class="line">                <span class="keyword">if</span> ($mode === <span class="string">'-d'</span>) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;daemonizeMode = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'stop'</span>:</span><br><span class="line">                <span class="keyword">if</span> ($mode === <span class="string">'-g'</span>) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;gracefulStop = <span class="keyword">true</span>;</span><br><span class="line">                    $sig = SIGTERM;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;log(<span class="string">'process is gracefully stopping ...'</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;gracefulStop = <span class="keyword">false</span>;</span><br><span class="line">                    $sig = SIGINT;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;log(<span class="string">'process is stopping ...'</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Send stop signal to master process.</span></span><br><span class="line">                $masterPid &amp;&amp; posix_kill($masterPid, $sig);</span><br><span class="line">                $timeout = <span class="number">5</span>;</span><br><span class="line">                $startTime = time();</span><br><span class="line">                <span class="comment">// Check master process is still alive?</span></span><br><span class="line">                <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                    $masterIsAlive = $masterPid &amp;&amp; posix_kill($masterPid, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> ($masterIsAlive) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;gracefulStop &amp;&amp; time() - $startTime &gt;= $timeout) &#123;</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;log(<span class="string">'process stop fail.'</span>);</span><br><span class="line">                            <span class="keyword">exit</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        usleep(<span class="number">10000</span>);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">$this</span>-&gt;log(<span class="string">'process stop success.'</span>);</span><br><span class="line">                    <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span> :</span><br><span class="line">                <span class="keyword">static</span>::output($usage);</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run as deamon mode.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">daemonize</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;daemonizeMode) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $pid = pcntl_fork();</span><br><span class="line">        <span class="keyword">if</span> ($pid === <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'fork fail'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">elseif</span> ($pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (posix_setsid() === <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'setsid fail'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fork again avoid SVR4 system regain the control of terminal.</span></span><br><span class="line">        $pid = pcntl_fork();</span><br><span class="line">        <span class="keyword">if</span> ($pid === <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'fork fail'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">elseif</span> ($pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        umask(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setProcessTitle(<span class="string">' master process'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Install signal.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">installSignal</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// stop</span></span><br><span class="line">        pcntl_signal(SIGINT, [<span class="keyword">$this</span>, <span class="string">'signalHandler'</span>], <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// graceful stop</span></span><br><span class="line">        pcntl_signal(SIGTERM, [<span class="keyword">$this</span>, <span class="string">'signalHandler'</span>], <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// quit</span></span><br><span class="line">        pcntl_signal(SIGQUIT, [<span class="keyword">$this</span>, <span class="string">'signalHandler'</span>], <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">        pcntl_signal(SIGPIPE, SIG_IGN, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Signal handler.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $signal</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">signalHandler</span><span class="params">($signal)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> ($signal) &#123;</span><br><span class="line">            <span class="keyword">case</span> SIGINT:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;gracefulStop = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;stopAll();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SIGTERM:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;gracefulStop = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;stopAll();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Stop all.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stopAll</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;status = <span class="keyword">static</span>::STATUS_SHUTDOWN;</span><br><span class="line">        <span class="comment">// For master process</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;masterPid === posix_getpid()) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;log(<span class="string">'master process stopping ...'</span>);</span><br><span class="line">            $msg = <span class="string">'child process is'</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;gracefulStop) &#123;</span><br><span class="line">                $sig = SIGTERM;</span><br><span class="line">                $msg .= <span class="string">' gracefully'</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $sig = SIGINT;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $msg .= <span class="string">' stopping ...'</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;childPidMap <span class="keyword">as</span> $pid) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;log($msg, $pid);</span><br><span class="line">                posix_kill($pid, $sig);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;gracefulStop) &#123;</span><br><span class="line">                    $instance = <span class="keyword">$this</span>;</span><br><span class="line">                    Timer::add(<span class="number">2</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($instance, $pid)</span> </span>&#123;</span><br><span class="line">                        posix_kill($pid, SIGKILL);</span><br><span class="line">                        <span class="keyword">$this</span>-&gt;log(<span class="string">'child process stopping success.'</span>, $pid);</span><br><span class="line">                    &#125;, <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Timer::add(<span class="number">1</span>, [<span class="keyword">$this</span>, <span class="string">'checkIfChildRunning'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// For child processes</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;log(<span class="string">'child process stopping success.'</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;onStop) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    call_user_func(<span class="keyword">$this</span>-&gt;onStop, <span class="keyword">$this</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;log($e);</span><br><span class="line">                    <span class="keyword">exit</span>(<span class="number">250</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * private if child processes is really running</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkIfChildRunning</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;childPidMap <span class="keyword">as</span> $pid) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!posix_kill($pid, <span class="number">0</span>)) &#123;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;childPidMap[$pid]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Save master pid.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">saveMasterPid</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;masterPid = posix_getpid();</span><br><span class="line">        <span class="keyword">if</span> (file_put_contents(<span class="keyword">$this</span>-&gt;pidFile, <span class="keyword">$this</span>-&gt;masterPid) === <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'can not save pid to '</span> . <span class="keyword">$this</span>-&gt;pidFile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Fork process.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">forkProcess</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (count(<span class="keyword">$this</span>-&gt;childPidMap) &lt; <span class="keyword">$this</span>-&gt;count) &#123;</span><br><span class="line">            $pid = pcntl_fork();</span><br><span class="line">            <span class="comment">// For master process</span></span><br><span class="line">            <span class="keyword">if</span> ($pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;childPidMap[$pid] = $pid;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// For child processes</span></span><br><span class="line">            <span class="keyword">elseif</span> ($pid === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;setProcessTitle(<span class="string">'child process'</span>);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">                <span class="keyword">exit</span>(<span class="number">250</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'fork fail'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;onStart) &#123;</span><br><span class="line">                call_user_func(<span class="keyword">$this</span>-&gt;onStart, <span class="keyword">$this</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// Calls signal handlers for pending signals.</span></span><br><span class="line">                pcntl_signal_dispatch();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;log($e);</span><br><span class="line">            <span class="comment">// Avoid rapid infinite loop exit.</span></span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">250</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reset Std.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resetStd</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;daemonizeMode) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fclose(STDIN);</span><br><span class="line">        fclose(STDOUT);</span><br><span class="line">        fclose(STDERR);</span><br><span class="line">        $stdoutFile = <span class="string">'/dev/null'</span>;</span><br><span class="line">        fopen($stdoutFile, <span class="string">'r'</span>);</span><br><span class="line">        fopen($stdoutFile, <span class="string">'a'</span>);</span><br><span class="line">        fopen($stdoutFile, <span class="string">'a'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Monitor process.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">monitorProcess</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;status = <span class="keyword">static</span>::STATUS_RUNNING;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            pcntl_signal_dispatch();</span><br><span class="line">            $status = <span class="number">0</span>;</span><br><span class="line">            $pid = pcntl_wait($status, WUNTRACED);</span><br><span class="line">            pcntl_signal_dispatch();</span><br><span class="line">            <span class="keyword">if</span> ($pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;childPidMap)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ($status !== <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">$this</span>-&gt;log(<span class="string">"child process exit with status &#123;$status&#125;."</span>, $pid);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;childPidMap[$pid]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Is still running state then fork a new worker process.</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;status !== <span class="keyword">static</span>::STATUS_SHUTDOWN) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;forkProcess();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;status === <span class="keyword">static</span>::STATUS_SHUTDOWN &amp;&amp; <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;childPidMap)) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;log(<span class="string">'master process stopping success.'</span>);</span><br><span class="line">                @unlink(<span class="keyword">$this</span>-&gt;pidFile);</span><br><span class="line">                <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set process title.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $title</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setProcessTitle</span><span class="params">(string $title)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (function_exists(<span class="string">'cli_set_process_title'</span>)) &#123;</span><br><span class="line">            cli_set_process_title(<span class="keyword">static</span>::class . <span class="string">" &#123;$title&#125;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Log.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $pid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(string $msg, int $pid = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        !$pid &amp;&amp; ($pid = posix_getpid());</span><br><span class="line">        $msg = <span class="string">" [&#123;$this-&gt;startFile&#125;] pid：&#123;$pid&#125; &#123;$msg&#125;"</span> . PHP_EOL;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;daemonizeMode) &#123;</span><br><span class="line">            <span class="keyword">static</span>::output($msg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        file_put_contents((string)<span class="keyword">$this</span>-&gt;logFile, date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">' '</span> . <span class="keyword">static</span>::class . $msg, FILE_APPEND | LOCK_EX);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Output.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $msg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span><span class="params">(string $msg)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $stream = STDOUT;</span><br><span class="line">        $line = <span class="string">"\033[1A\n\033[K"</span>;</span><br><span class="line">        $green = <span class="string">"\033[32;40m"</span>;</span><br><span class="line">        $yellow = <span class="string">"\033[33;40m"</span>;</span><br><span class="line">        $end = <span class="string">"\033[0m"</span>;</span><br><span class="line">        $msg = str_replace([<span class="string">'&lt;n&gt;'</span>, <span class="string">'&lt;g&gt;'</span>, <span class="string">'&lt;y&gt;'</span>], [$line, $green, $yellow], $msg);</span><br><span class="line">        $msg = str_replace([<span class="string">'&lt;/n&gt;'</span>, <span class="string">'&lt;/g&gt;'</span>, <span class="string">'&lt;/y&gt;'</span>], $end, $msg);</span><br><span class="line">        fwrite($stream, $msg);</span><br><span class="line">        fflush($stream);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$task = <span class="keyword">new</span> TaskScheduling();</span><br><span class="line">$task-&gt;count = <span class="number">4</span>;</span><br><span class="line"><span class="comment">// onStart内的方法会运行$this-&gt;count次</span></span><br><span class="line">$task-&gt;onStart = <span class="function"><span class="keyword">function</span> <span class="params">($task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">' pid：'</span> . posix_getpid() . <span class="string">' is start.'</span> . PHP_EOL;</span><br><span class="line">&#125;;</span><br><span class="line">$task-&gt;onStop = <span class="function"><span class="keyword">function</span> <span class="params">($task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">' pid：'</span> . posix_getpid() . <span class="string">' is exit.'</span> . PHP_EOL;</span><br><span class="line">&#125;;</span><br><span class="line">$task-&gt;runAll();</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>WorkerMan</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>workerman</tag>
      </tags>
  </entry>
  <entry>
    <title>RAP2 安装</title>
    <url>/Other/rap2-install.html</url>
    <content><![CDATA[<div class="note danger"><p><a href="http://rap2.taobao.org/" target="_blank" rel="noopener">RAP2</a> 一个可视化接口管理工具, 需要部署前后端服务<br><a href="https://github.com/thx/rap2-delos" target="_blank" rel="noopener">后端数据API服务器</a> 基于Koa + MySQL<br><a href="https://github.com/thx/rap2-dolores" target="_blank" rel="noopener">前端静态资源</a> 基于React</p>
<p>部署前准备：</p>
<ol>
<li>服务器环境 Centos7, IP地址 192.168.1.18</li>
<li>Node.js</li>
<li>Redis</li>
<li>MySQL</li>
<li>Git</li>
</ol></div>
<h5 id="后端服务部署"><a href="#后端服务部署" class="headerlink" title="后端服务部署"></a>后端服务部署</h5><ol>
<li>获取源代码 git clone <a href="https://github.com/thx/rap2-delos.git" target="_blank" rel="noopener">https://github.com/thx/rap2-delos.git</a></li>
<li>创建数据库 CREATE DATABASE IF NOT EXISTS rap2 DEFAULT CHARSET utf8 COLLATE utf8_general_ci;</li>
<li>初始化 npm install<a id="more"></a></li>
<li><p>配置环境 src/config/config.prod.ts (dev 和 local 环境直接配置固定值即可)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#端口配置</span></span><br><span class="line">serve: &#123;</span><br><span class="line">    port: (process.env.EXPOSE_PORT &amp;&amp; parseInt(process.env.EXPOSE_PORT)) || 8181,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#数据库连接配置</span></span><br><span class="line">db: &#123;</span><br><span class="line">    dialect: <span class="string">'mysql'</span>,</span><br><span class="line">    host: process.env.MYSQL_URL || <span class="string">'localhost'</span>,</span><br><span class="line">    port: (process.env.MYSQL_PORT &amp;&amp; parseInt(process.env.MYSQL_PORT)) || 3306,</span><br><span class="line">    username: process.env.MYSQL_USERNAME || <span class="string">'root'</span>,</span><br><span class="line">    password: process.env.MYSQL_PASSWD || <span class="string">'root'</span>,</span><br><span class="line">    database: process.env.MYSQL_SCHEMA || <span class="string">'rap2'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#Redis配置</span></span><br><span class="line">redis: &#123;</span><br><span class="line">    host: process.env.REDIS_URL || <span class="string">'localhost'</span>,</span><br><span class="line">    port: (process.env.REDIS_PORT &amp;&amp; parseInt(process.env.REDIS_PORT)) || 6379,</span><br><span class="line">    auth_pass: process.env.REDIS_PWD || <span class="string">'123456'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译 npm run build</p>
</li>
<li>初始化数据库表 npm run create-db</li>
<li>执行 mocha 测试用例和js代码规范检查 npm run check</li>
<li>生产模式 npm start</li>
<li>访问 192.168.1.18:8181, 提示 RAP2后端服务已启动,请从前端服务(rap2-dolores)访问. RAP2 back-end server is started, please visit via front-end service (rap2-dolores).  </li>
</ol>
<h5 id="前端服务部署"><a href="#前端服务部署" class="headerlink" title="前端服务部署"></a>前端服务部署</h5><ol>
<li>获取源代码 git clone <a href="https://github.com/thx/rap2-dolores.git" target="_blank" rel="noopener">https://github.com/thx/rap2-dolores.git</a></li>
<li>初始化 npm install –unsafe-perm </li>
<li><p>配置后端服务器地址 src/config/config.prod.js </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">  serve: <span class="string">'http://192.168.1.18:8181'</span>,</span><br><span class="line">  keys: [<span class="string">'some secret hurr'</span>],</span><br><span class="line">  session: &#123;</span><br><span class="line">    key: <span class="string">'koa:sess'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译 npm run build</p>
</li>
<li>服务器配置路由至 build 文件夹作为静态服务器即可, 这里配置的是 8282 端口</li>
<li>访问 192.168.1.18:8282</li>
<li>添加伪静态文件 .htaccess <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;IfModule mod_rewrite.c&gt;</span><br><span class="line">    RewriteEngine On</span><br><span class="line"></span><br><span class="line">    RewriteCond %&#123;REQUEST_FILENAME&#125; !-d</span><br><span class="line">    RewriteCond %&#123;REQUEST_FILENAME&#125; !-f</span><br><span class="line"></span><br><span class="line">    RewriteRule ^(.*)$ /index.html [L]</span><br><span class="line">&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>Other</category>
      </categories>
      <tags>
        <tag>rap2</tag>
      </tags>
  </entry>
  <entry>
    <title>socket 即时通讯</title>
    <url>/PHP/socket-im.html</url>
    <content><![CDATA[<div class="note danger"><p>看了 <a href="https://www.workerman.net/" target="_blank" rel="noopener">workerman</a> 源码后, 实现的一个简单DEMO<br>前置知识：守护进程以及信号 <a href="http://php.net/posix" target="_blank" rel="noopener">posix</a>/<a href="http://php.net/pcntl" target="_blank" rel="noopener">pcntl</a>、socket 编程 <a href="http://php.net/manual/zh/book.sockets.php" target="_blank" rel="noopener">socket</a>/<a href="http://php.net/manual/zh/ref.stream.php" target="_blank" rel="noopener">stream_socket</a><br><code>ps：若想多进程, 多执行几次 forkProcess 就行, 但是像进程间通信, 尚未实现</code></p></div>
<a id="more"></a>
<h6 id="Timer-php"><a href="#Timer-php" class="headerlink" title="Timer.php"></a>Timer.php</h6><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tasks that based on ALARM signal.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $tasks = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Init.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 安装一个信号处理器</span></span><br><span class="line">        pcntl_signal(SIGALRM, [<span class="string">'Timer'</span>, <span class="string">'signalHandle'</span>], <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ALARM signal handler.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">signalHandle</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        pcntl_alarm(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">self</span>::tick();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加定时任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> float $timeInterval</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> callable $func</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool $persistent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($timeInterval, $func, $persistent = true)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 未设置定时任务</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">self</span>::$tasks)) &#123;</span><br><span class="line">            <span class="comment">// 创建一个计时器,该计时器在给定的秒数后向进程发送SIGALRM信号</span></span><br><span class="line">            pcntl_alarm(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加定时任务</span></span><br><span class="line">        $nowTime = time();</span><br><span class="line">        $runTime = $nowTime + $timeInterval;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="keyword">self</span>::$tasks[$runTime])) &#123;</span><br><span class="line">            <span class="keyword">self</span>::$tasks[$runTime] = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>::$tasks[$runTime][] = [$timeInterval, $func, $persistent];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tick.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">tick</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 定时任务为空,取消闹钟信号</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">self</span>::$tasks)) &#123;</span><br><span class="line">            pcntl_alarm(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $nowTime = time();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">self</span>::$tasks <span class="keyword">as</span> $runTime =&gt; $taskData) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($nowTime &gt;= $runTime) &#123;</span><br><span class="line">                <span class="keyword">foreach</span> ($taskData <span class="keyword">as</span> $index =&gt; $task) &#123;</span><br><span class="line">                    call_user_func_array($task[<span class="number">1</span>], []);</span><br><span class="line">                    <span class="keyword">if</span> ($task[<span class="number">2</span>]) &#123;</span><br><span class="line">                        <span class="keyword">self</span>::add($task[<span class="number">0</span>], $task[<span class="number">1</span>], $task[<span class="number">2</span>]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 删除任务</span></span><br><span class="line">                <span class="keyword">unset</span>(<span class="keyword">self</span>::$tasks[$runTime]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*// 初始化(安装闹钟信号处理器/处理定时任务)</span></span><br><span class="line"><span class="comment">Timer::init();</span></span><br><span class="line"><span class="comment">// 添加定时任务</span></span><br><span class="line"><span class="comment">Timer::add(2, function () &#123;</span></span><br><span class="line"><span class="comment">    echo date('Y-m-d H:i:s') . PHP_EOL;</span></span><br><span class="line"><span class="comment">&#125;);</span></span><br><span class="line"><span class="comment">while (true) &#123;</span></span><br><span class="line"><span class="comment">    // 调用等待信号的处理器</span></span><br><span class="line"><span class="comment">    pcntl_signal_dispatch();</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br></pre></td></tr></table></figure>
<h6 id="socket-php"><a href="#socket-php" class="headerlink" title="socket.php"></a>socket.php</h6><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'Timer.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Socket</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Process title.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> PROCESS_TITLE = <span class="string">'Socket'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * All clients.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $clients = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Emitted when processes start.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> callback</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $onStart = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Emitted when a socket connection is successfully established.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> callback</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $onConnect = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Emitted when data is received.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> callback</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $onMessage = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Emitted when the other end of the socket sends a FIN packet.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> callback</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $onClose = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Socket name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $socketName = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Listening socket.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> resource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $socket = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * All listeners for read event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $allEvents = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($socketName)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;socketName = $socketName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;daemonize();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;listenSocket();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;forkProcess();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;resetStd();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;monitorProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以守护进程模式运行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">daemonize</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $pid = pcntl_fork();</span><br><span class="line">        <span class="keyword">if</span> ($pid === <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">'fork fail'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 退出父进程</span></span><br><span class="line">        <span class="keyword">elseif</span> ($pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建新会话,并自任该会话的组长,脱离终端</span></span><br><span class="line">        <span class="keyword">if</span> (posix_setsid() === <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">'setsid fail'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 再次fork,并让父进程退出,使子进程不再成为会话组长来禁止进程重新打开控制终端</span></span><br><span class="line">        $pid = pcntl_fork();</span><br><span class="line">        <span class="keyword">if</span> ($pid === <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">'fork fail'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 结束父进程</span></span><br><span class="line">        <span class="keyword">elseif</span> ($pid !== <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 切换工作目录</span></span><br><span class="line">        chdir(<span class="string">'/'</span>);</span><br><span class="line">        <span class="comment">// 设置文件权限掩码</span></span><br><span class="line">        umask(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 设置进程标题</span></span><br><span class="line">        cli_set_process_title(<span class="keyword">self</span>::PROCESS_TITLE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听Socket</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listenSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 服务端收到客户端的请求后,会将比连接存放在连接请求队列里,而backlog就是此队列的数量限制,超过此值,则不再接收新的连接,而accet会从此队列中取出连接,相当于 socket_listen 的第二个参数</span></span><br><span class="line">        $context = stream_context_create([</span><br><span class="line">            <span class="string">'socket'</span> =&gt; [<span class="string">'backlog'</span> =&gt; <span class="number">102400</span>]</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 多个进程监听相同端口(端口复用),并且由系统内核做负载均衡,决定将socket连接交给哪个进程处理,避免了惊群效应,可以提升多进程短连接应用的性能</span></span><br><span class="line">        <span class="comment">// stream_context_set_option($context, 'socket', 'so_reuseport', 1);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建套接字</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;socket = stream_socket_server(<span class="keyword">$this</span>-&gt;socketName, $errno, $errmsg, STREAM_SERVER_BIND | STREAM_SERVER_LISTEN, $context);</span><br><span class="line">        <span class="keyword">if</span> (function_exists(<span class="string">'socket_import_stream'</span>)) &#123;</span><br><span class="line">            $socket = socket_import_stream(<span class="keyword">$this</span>-&gt;socket);</span><br><span class="line">            <span class="comment">// 打开TCP的KEEPALIVE,当连接断开时,会将SIGPIPE信号通知写入该套接字的进程</span></span><br><span class="line">            socket_set_option($socket, SOL_SOCKET, SO_KEEPALIVE, <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// 禁用 Nagle 算法</span></span><br><span class="line">            socket_set_option($socket, SOL_TCP, TCP_NODELAY, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 非阻塞模式</span></span><br><span class="line">        stream_set_blocking(<span class="keyword">$this</span>-&gt;socket, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建子进程并运行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">forkProcess</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $pid = pcntl_fork();</span><br><span class="line">        <span class="keyword">if</span> ($pid === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 设置进程标题</span></span><br><span class="line">            cli_set_process_title(<span class="keyword">self</span>::PROCESS_TITLE);</span><br><span class="line">            <span class="comment">// 当子进程创建后</span></span><br><span class="line">            call_user_func(<span class="keyword">$this</span>-&gt;onStart, <span class="keyword">$this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将socket添加至clients</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;clients[] = <span class="keyword">$this</span>-&gt;socket;</span><br><span class="line">            <span class="comment">// 添加事件</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;allEvents[(int)<span class="keyword">$this</span>-&gt;socket] = [</span><br><span class="line">                [<span class="keyword">$this</span>, <span class="string">'acceptConnection'</span>],</span><br><span class="line">                <span class="keyword">$this</span>-&gt;socket</span><br><span class="line">            ];</span><br><span class="line"></span><br><span class="line">            $write = [];</span><br><span class="line">            $except = [];</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 调用等待信号的处理器</span></span><br><span class="line">                pcntl_signal_dispatch();</span><br><span class="line"></span><br><span class="line">                $read = <span class="keyword">$this</span>-&gt;clients;</span><br><span class="line">                $ret = @stream_select($read, $write, $except, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">if</span> (!$ret) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ($read) &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> ($read <span class="keyword">as</span> $fd) &#123;</span><br><span class="line">                        $fdKey = (int)$fd;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;allEvents[$fdKey])) &#123;</span><br><span class="line">                            call_user_func_array(<span class="keyword">$this</span>-&gt;allEvents[$fdKey][<span class="number">0</span>], [<span class="keyword">$this</span>-&gt;allEvents[$fdKey][<span class="number">1</span>]]);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">250</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重定向标准输入和输出</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">resetStd</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        fclose(STDIN);</span><br><span class="line">        fclose(STDOUT);</span><br><span class="line">        fclose(STDERR);</span><br><span class="line">        $stdoutFile = <span class="string">'/dev/null'</span>;</span><br><span class="line">        fopen($stdoutFile, <span class="string">'r'</span>);</span><br><span class="line">        fopen($stdoutFile, <span class="string">'a'</span>);</span><br><span class="line">        fopen($stdoutFile, <span class="string">'a'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听所有子进程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">monitorProcess</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            $status = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 等待或返回fork的子进程状态</span></span><br><span class="line">            $pid = pcntl_wait($status, WUNTRACED);</span><br><span class="line">            <span class="comment">// 子进程已退出</span></span><br><span class="line">            <span class="keyword">if</span> ($pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 捕获进程退出事件,exit(250) 对应的$status值为64000</span></span><br><span class="line">                <span class="keyword">if</span> ($status == <span class="number">64000</span>) &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">'status='</span> . $status . <span class="string">'-'</span> . $pid . PHP_EOL;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接受连接</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $socket</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">acceptConnection</span><span class="params">($socket)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $newSocket = stream_socket_accept($socket, <span class="number">0</span>, $remoteAddress);</span><br><span class="line">        <span class="keyword">if</span> (!$newSocket) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 非阻塞模式</span></span><br><span class="line">        stream_set_blocking($newSocket, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 设置读缓冲区</span></span><br><span class="line">        stream_set_read_buffer($newSocket, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加新连接到clients</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;clients[] = $newSocket;</span><br><span class="line">        <span class="comment">// 添加新事件</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;allEvents[(int)$newSocket] = [</span><br><span class="line">            [<span class="keyword">$this</span>, <span class="string">'read'</span>],</span><br><span class="line">            $newSocket</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        call_user_func(<span class="keyword">$this</span>-&gt;onConnect, $newSocket);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $socket</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($socket)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $buffer = fread($socket, <span class="number">65535</span>);</span><br><span class="line">        <span class="keyword">if</span> ($buffer === <span class="string">''</span> || $buffer === <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((feof($socket) || !is_resource($socket) || $buffer === <span class="keyword">false</span>)) &#123;</span><br><span class="line">                fclose($socket);</span><br><span class="line">                call_user_func(<span class="keyword">$this</span>-&gt;onClose, $socket);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        call_user_func(<span class="keyword">$this</span>-&gt;onMessage, $socket, <span class="keyword">$this</span>-&gt;decode($buffer));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息给指定客户端</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $socket</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($socket, $string)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        @fwrite($socket, <span class="keyword">$this</span>-&gt;encode($string));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">decode</span><span class="params">($buffer)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> trim($buffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">encode</span><span class="params">($buffer)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $buffer . <span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0.0.0.0 监听本机所有网卡,包括内网ip和外网ip及本地回环127.0.0.1</span></span><br><span class="line"><span class="comment">// 127.0.0.1 表示监听本地回环,只能本机访问,外部无法访问</span></span><br><span class="line"><span class="comment">// 内网IP 192.168.xx.xx, 只监听内网ip, 外网无法访问</span></span><br><span class="line">$worker = <span class="keyword">new</span> Socket(<span class="string">'tcp://0.0.0.0:7000'</span>);</span><br><span class="line"><span class="comment">// 当子进程创建后</span></span><br><span class="line">$worker-&gt;onStart = <span class="function"><span class="keyword">function</span> <span class="params">($worker)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个定时器,定时发送消息给客户端</span></span><br><span class="line">    Timer::init();</span><br><span class="line">    Timer::add(<span class="number">5</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($worker)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($worker-&gt;clients <span class="keyword">as</span> $client) &#123;</span><br><span class="line">            $worker-&gt;send($client, <span class="string">'Server Time: '</span> . date(<span class="string">'Y-m-d H:i:s'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 客户端连接后的处理</span></span><br><span class="line">$worker-&gt;onConnect = <span class="function"><span class="keyword">function</span> <span class="params">($socket)</span> <span class="title">use</span> <span class="params">($worker)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($worker-&gt;clients <span class="keyword">as</span> $client) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($client !== $socket) &#123;</span><br><span class="line">            $worker-&gt;send($client, <span class="string">'Client #'</span> . (int)$socket . <span class="string">' is connected'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 处理客户端发送的消息</span></span><br><span class="line">$worker-&gt;onMessage = <span class="function"><span class="keyword">function</span> <span class="params">($socket, $string)</span> <span class="title">use</span> <span class="params">($worker)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($worker-&gt;clients <span class="keyword">as</span> $client) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($client === $socket) &#123;</span><br><span class="line">            $worker-&gt;send($client, <span class="string">'You: '</span> . $string);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $worker-&gt;send($client, <span class="string">'Client #'</span> . (int)$socket . <span class="string">': '</span> . $string);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 客户端断开后的处理</span></span><br><span class="line">$worker-&gt;onClose = <span class="function"><span class="keyword">function</span> <span class="params">($socket)</span> <span class="title">use</span> <span class="params">($worker)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($worker-&gt;clients <span class="keyword">as</span> $client) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($client !== $socket) &#123;</span><br><span class="line">            $worker-&gt;send($client, <span class="string">'Client #'</span> . (int)$socket . <span class="string">' is close'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">$worker-&gt;run();</span><br></pre></td></tr></table></figure>
<h6 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#启动服务端</span></span><br><span class="line">php socket.php</span><br><span class="line"><span class="comment">#客户端进行连接</span></span><br><span class="line">telnet 127.0.0.1 7000</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>socket</tag>
      </tags>
  </entry>
  <entry>
    <title>umask</title>
    <url>/PHP/php-umask.html</url>
    <content><![CDATA[<div class="note danger"><p>umask 指定当前用户在新建文件或目录时候的权限默认值<br>umask 有四个数字, 第一个为特殊权限, 一般不予考虑, 后三个与一般权限有关<br>umask 设置的值为 需要减掉的权限</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * umask(0)  0取反再创建文件时权限相与,也就是：(~0) &amp; mode 等于八进制的值0777 &amp; mode了</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 创建文件：默认没有x权限,只有r、w权限, 最大为666 -rw-rw-rw-</span></span><br><span class="line"><span class="comment"> * 创建目录：最大为777, drwxrwxrwx</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">umask(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// test.txt 文件权限为 666</span></span><br><span class="line">file_put_contents(<span class="string">'test.txt'</span>, <span class="string">'test'</span>);</span><br><span class="line"><span class="comment">// test 目录权限为 777</span></span><br><span class="line">mkdir(<span class="string">'test'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * umask(0022) - 用户组和其它组减去 w 权限, 即创建的文件权限为 644 -rw-r--r-- , 创建的目录权限为 755 drwxr-xr-x</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">umask(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// test.txt 文件权限为 644</span></span><br><span class="line">file_put_contents(<span class="string">'test.txt'</span>, <span class="string">'test'</span>);</span><br><span class="line"><span class="comment">// test 目录权限为 755</span></span><br><span class="line">mkdir(<span class="string">'test'</span>);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>Vmware 搭建 Centos7 后的网络配置</title>
    <url>/Linux/vmware-centos7-network-configuration.html</url>
    <content><![CDATA[<h4 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h4><div class="note danger"><p>VMwareworkstation_full_12.1.0.2487.1453173744.exe  【密匙：5A02H-AU243-TZJ49-GTC7K-3C61N】<br>CentOS-7-x86_64-DVD-1511.iso</p></div>
<h4 id="网卡配置"><a href="#网卡配置" class="headerlink" title="网卡配置"></a>网卡配置</h4><ol>
<li><p>查看网卡名称和硬件地址</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ip addr</span><br></pre></td></tr></table></figure>
<p><img src="/uploads/linux/vmware-centos7-network-configuration/ff8c0b65b3472b8b89014cd5fb266b18.png" style="display:inline-block"></p>
</li>
<li><p>修改网卡配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/sysconfig/network-scripts/</span><br><span class="line">vi ifcfg-eno16777736</span><br><span class="line"><span class="comment">#修改 NAME 和 DEVICE 的值为 eth0, ONBOOT 的值为 yes, 添加 HWADDR 硬件地址(上面通过ip addr 所查询到的硬件地址)</span></span><br><span class="line">NAME=eth0</span><br><span class="line">DEVICE=eth0</span><br><span class="line">ONBOOT=yes</span><br><span class="line">HWADDR=00:0c:29:7b:ed:a9</span><br></pre></td></tr></table></figure>
</li>
<li><p>重命名 ifcfg-eno16777736 配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mv ifcfg-eno16777769 ifcfg-eth0</span><br></pre></td></tr></table></figure>
</li>
<li><p>禁用该可预测命名规则,对于这一点,可以在启动时传递 “net.ifnames=0 biosdevname=0” 的内核参数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/default/grub</span><br></pre></td></tr></table></figure>
<p><img src="/uploads/linux/vmware-centos7-network-configuration/ed5777711dd3427500946fc3877cd42a.png" style="display:inline-block"> </p>
<a id="more"></a></li>
<li><p>运行命令重新生成GRUB配置并更新内核参数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grub2-mkconfig -o /boot/grub2/grub.cf</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改虚拟机的接入方式, 可以在 “编辑虚拟网络” 中查看, 如图：<br><img src="/uploads/linux/vmware-centos7-network-configuration/a6af20a8fd1bc7ff3b1392eb952a98a6.png" style="display:inline-block"><br><img src="/uploads/linux/vmware-centos7-network-configuration/d0038b9f65b319d14d58be745602bb3a.png" style="display:inline-block"><br><img src="/uploads/linux/vmware-centos7-network-configuration/2091a03c7e10997747b4aaf859c7bb0e.png" style="display:inline-block"></p>
</li>
<li><p>重启服务器</p>
</li>
<li><p>桥接模式静态IP配置</p>
<ol>
<li><p>虚拟机配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 菜单栏 -&gt; 编辑 -&gt; 虚拟网络编辑器 -&gt; 更改设置 -&gt; 桥接模式的桥接网卡将自动修改为指定的网卡(查看任务管理器 -&gt; 性能 -&gt; 查看网卡名称)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Centos7 配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. vi /etc/sysconfig/network-scripts/ifcfg-eth0</span></span><br><span class="line"><span class="comment">#2. 修改内容如下:</span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static <span class="comment"># dhcp 修改为 static</span></span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=eth0</span><br><span class="line">UUID=9f17c6f9-192d-4b86-acf8-93ef3005810b</span><br><span class="line">DEVICE=eth0 </span><br><span class="line">ONBOOT=yes <span class="comment"># 开机启动配置</span></span><br><span class="line">HWADDR=00:0c:29:00:20:B2</span><br><span class="line">IPADDR=192.168.0.99 <span class="comment"># 静态IP地址(与主机在同一网段)</span></span><br><span class="line">NETMASK=255.255.255.0 <span class="comment"># 子网掩码</span></span><br><span class="line">GATEWAY=192.168.0.1 <span class="comment"># 默认网关(与主机一致)</span></span><br><span class="line">DNS1=218.85.157.99 <span class="comment"># DNS1 配置</span></span><br><span class="line"><span class="comment">#3. 重启服务 </span></span><br><span class="line">service network restart</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>NAT模式静态IP配置</p>
<ol>
<li><p>虚拟机配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 菜单栏 -&gt; 编辑 -&gt; 虚拟网络编辑器 -&gt; 选中 VMnet8 NAT 模式 </span></span><br><span class="line"><span class="comment">#2. 点击 DHCP 设置 -&gt; 查看可修改的IP地址范围</span></span><br><span class="line"><span class="comment">#3. 点击 NAT 设置 -&gt; 查看默认网关</span></span><br><span class="line"><span class="comment">#4. 菜单栏 -&gt; 虚拟机 -&gt; 设置 -&gt; 网络适配器 -&gt; NAT 模式</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Centos7 配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. vi /etc/sysconfig/network-scripts/ifcfg-eth0</span></span><br><span class="line"><span class="comment">#2. 修改内容如下:</span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static <span class="comment"># dhcp 修改为 static</span></span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=eth0</span><br><span class="line">UUID=9f17c6f9-192d-4b86-acf8-93ef3005810b</span><br><span class="line">DEVICE=eth0 </span><br><span class="line">ONBOOT=yes <span class="comment"># 开机启动配置</span></span><br><span class="line">HWADDR=00:0c:29:00:20:B2</span><br><span class="line">IPADDR=192.168.23.128 <span class="comment"># 静态IP地址</span></span><br><span class="line">NETMASK=255.255.255.0 <span class="comment"># 子网掩码</span></span><br><span class="line">GATEWAY=192.168.23.2 <span class="comment"># 默认网关</span></span><br><span class="line">DNS1=218.85.157.99 <span class="comment"># DNS1 配置</span></span><br><span class="line"><span class="comment">#3. 重启服务 service network restart</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>centos</tag>
        <tag>vmware</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP Socket 服务端与客户端的通信(IO阻塞/复用)</title>
    <url>/PHP/socket.html</url>
    <content><![CDATA[<div class="note danger"><p>PHP Socket 编程提供了两套API：<br><code>socket_*</code> 系列, 需要安装 socket 扩展(更底层)<br><code>stream_socket_*</code> 系列, 不需要安装扩展(推荐使用, 更方便)</p>
<p><code>ps:分别以 socket 扩展 和 stream_socket 实现了服务端与客户端的通信,测试方式一样</code></p></div>
<a id="more"></a>
<hr>
<div class="note primary"><p>socket 扩展 - 服务端与客户端的通信</p></div>
<h6 id="服务端-server-php"><a href="#服务端-server-php" class="headerlink" title="服务端 server.php"></a>服务端 server.php</h6><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$ip = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">$port = <span class="number">7000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立TCP连接</span></span><br><span class="line">$socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'socket_create fail:'</span> . socket_strerror(socket_last_error()));</span><br><span class="line"><span class="comment">// 绑定IP地址和端口</span></span><br><span class="line">socket_bind($socket, $ip, $port) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'socket_bind fail:'</span> . socket_strerror(socket_last_error()));</span><br><span class="line"><span class="comment">// 监听客户端连接</span></span><br><span class="line">socket_listen($socket, <span class="number">2</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'socket_listen fail:'</span> . socket_strerror(socket_last_error()));</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="comment">// 接受一个客户端的连接请求,并返回一个新的套接字</span></span><br><span class="line">    $newSocket = socket_accept($socket);</span><br><span class="line">    <span class="keyword">if</span> ($newSocket === <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'socket_accept fail:'</span> . socket_strerror(socket_last_error());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 向客户端发送数据, 告知客户端ID</span></span><br><span class="line">        $clientId = (int)$newSocket;</span><br><span class="line">        $response = [</span><br><span class="line">            <span class="string">'type'</span> =&gt; <span class="string">'login'</span>,</span><br><span class="line">            <span class="string">'message'</span> =&gt; $clientId,</span><br><span class="line">        ];</span><br><span class="line">        socket_write($newSocket, json_encode($response) . <span class="string">"\n"</span>);</span><br><span class="line">        <span class="comment">// 输出客户端信息</span></span><br><span class="line">        socket_getpeername($newSocket, $address, $port);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Client #&#123;$clientId&#125; Connected, IP=&#123;$address&#125;, PORT=&#123;$port&#125;."</span> . PHP_EOL;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// 读取客户端数据</span></span><br><span class="line">            $data = @socket_read($newSocket, <span class="number">2048</span>);</span><br><span class="line">            <span class="keyword">if</span> ($data !== <span class="string">''</span>) &#123;</span><br><span class="line">                $data = trim($data);</span><br><span class="line">                <span class="comment">// 发送内容给客户端</span></span><br><span class="line">                $response = [</span><br><span class="line">                    <span class="string">'message'</span> =&gt; strrev($data),</span><br><span class="line">                    <span class="string">'time'</span> =&gt; date(<span class="string">'Y-m-d H:i:s'</span>),</span><br><span class="line">                ];</span><br><span class="line">                socket_write($read, json_encode($response) . <span class="string">"\n"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                socket_close($newSocket);</span><br><span class="line">                <span class="comment">// 输出客户端断开连接</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"Client #&#123;$clientId&#125; Disconnect."</span> . PHP_EOL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭TCP连接</span></span><br><span class="line">socket_close($socket);</span><br></pre></td></tr></table></figure>
<h6 id="客户端-client-php"><a href="#客户端-client-php" class="headerlink" title="客户端 client.php"></a>客户端 client.php</h6><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$ip = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">$port = <span class="number">7000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立TCP连接</span></span><br><span class="line">$socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'socket_create fail:'</span> . socket_strerror(socket_last_error()));</span><br><span class="line"><span class="comment">// 连接服务端</span></span><br><span class="line">socket_connect($socket, $ip, $port) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'socket_connect fail:'</span> . socket_strerror(socket_last_error()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取服务端数据</span></span><br><span class="line">$buffer = socket_read($socket, <span class="number">2048</span>, PHP_NORMAL_READ);</span><br><span class="line">$data = json_decode($buffer, <span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Connection succeeded, ClientId = #&#123;$data['message']&#125;."</span> . PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端与服务端交互</span></span><br><span class="line">interaction($socket);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">interaction</span><span class="params">($socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 获取客户端输入</span></span><br><span class="line">    $content = trim(fgets(STDIN));</span><br><span class="line">    <span class="comment">// 发送数据给服务端</span></span><br><span class="line">    socket_write($socket, $content);</span><br><span class="line">    <span class="comment">// 读取服务端</span></span><br><span class="line">    $buffer = socket_read($socket, <span class="number">2048</span>, PHP_NORMAL_READ);</span><br><span class="line">    $data = json_decode($buffer, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&#123;$data['message']&#125; - &#123;$data['time']&#125;"</span> . PHP_EOL;</span><br><span class="line"></span><br><span class="line">    interaction($socket);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭TCP连接</span></span><br><span class="line">socket_close($socket);</span><br></pre></td></tr></table></figure>
<h6 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 启动服务端</span></span><br><span class="line">php server.php</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 运行客户端, 并输入 'hello', 然后断开连接</span></span><br><span class="line">[root@192 private]<span class="comment"># php client.php </span></span><br><span class="line">Connection succeeded, ClientId = <span class="comment">#18.</span></span><br><span class="line">hello</span><br><span class="line">olleh - 2018-10-17 17:59:20</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 服务端输出</span></span><br><span class="line">[root@192 private]<span class="comment"># php socket.php </span></span><br><span class="line">Client <span class="comment">#17 Connected, IP=127.0.0.1, PORT=33994.</span></span><br><span class="line">Client <span class="comment">#17 Disconnect.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 客户端也可以使用 telnet </span></span><br><span class="line">[root@192 ~]<span class="comment"># telnet 127.0.0.1 7000</span></span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is <span class="string">'^]'</span>.</span><br><span class="line">&#123;<span class="string">"type"</span>:<span class="string">"login"</span>,<span class="string">"message"</span>:17&#125;</span><br><span class="line">hello</span><br><span class="line">&#123;<span class="string">"message"</span>:<span class="string">"olleh"</span>,<span class="string">"time"</span>:<span class="string">"2018-10-17 17:58:06"</span>&#125;</span><br><span class="line">^]</span><br><span class="line">telnet&gt; quit</span><br><span class="line">Connection closed.</span><br></pre></td></tr></table></figure>
<div class="note warning"><p>问题：只能处理一个客户端的连接和数据传输, 只有断开后才能处理新的客户端连接<br>解决：IO 复用</p></div>
<h6 id="IO-复用-服务端-server-php"><a href="#IO-复用-服务端-server-php" class="headerlink" title="IO 复用 - 服务端 server.php"></a>IO 复用 - 服务端 server.php</h6><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$ip = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">$port = <span class="number">7000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立TCP连接</span></span><br><span class="line">$socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'socket_create fail:'</span> . socket_strerror(socket_last_error()));</span><br><span class="line"><span class="comment">// 绑定IP地址和端口</span></span><br><span class="line">socket_bind($socket, $ip, $port) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'socket_bind fail:'</span> . socket_strerror(socket_last_error()));</span><br><span class="line"><span class="comment">// 监听客户端连接</span></span><br><span class="line">socket_listen($socket, <span class="number">2</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'socket_listen fail:'</span> . socket_strerror(socket_last_error()));</span><br><span class="line"><span class="comment">// 客户端集合</span></span><br><span class="line">$clients[(int)$socket] = $socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="comment">// socket_select() 的 $read、$write、$except 三个参数都是引用地址类型, 所以需要将 $clients 赋值给 $reads, 保证 $reads 发生改动后不影响 $clients</span></span><br><span class="line">    $reads = $clients;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接受套接字数组并等待它们改变状态</span></span><br><span class="line">    <span class="keyword">if</span> (socket_select($reads, $writes, $excepts, <span class="keyword">null</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'socket_select fail：'</span> . socket_strerror(socket_last_error()) . PHP_EOL;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// $socket 发生变化, 说明有新的客户端连接</span></span><br><span class="line">    <span class="keyword">if</span> (in_array($socket, $reads)) &#123;</span><br><span class="line">        <span class="comment">// 接受一个客户端的连接请求,并返回一个新的套接字</span></span><br><span class="line">        $newSocket = socket_accept($socket);</span><br><span class="line">        <span class="keyword">if</span> ($newSocket === <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'socket_accept fail:'</span> . socket_strerror(socket_last_error()) . PHP_EOL;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 向客户端发送数据, 告知客户端ID</span></span><br><span class="line">            $clientId = (int)$newSocket;</span><br><span class="line">            $response = [</span><br><span class="line">                <span class="string">'type'</span> =&gt; <span class="string">'login'</span>,</span><br><span class="line">                <span class="string">'message'</span> =&gt; $clientId,</span><br><span class="line">            ];</span><br><span class="line">            socket_write($newSocket, json_encode($response) . <span class="string">"\n"</span>);</span><br><span class="line">            <span class="comment">// 将客户端 $newSocket 加入到 $clients</span></span><br><span class="line">            $clients[$clientId] = $newSocket;</span><br><span class="line">            <span class="comment">// 移除对 $socket 的监听</span></span><br><span class="line">            <span class="keyword">unset</span>($reads[array_search($socket, $reads)]);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 输出客户端信息</span></span><br><span class="line">            socket_getpeername($newSocket, $address, $port);</span><br><span class="line">            $content = <span class="string">"Client #&#123;$clientId&#125; Connected, IP=&#123;$address&#125;, PORT=&#123;$port&#125;."</span> . PHP_EOL;</span><br><span class="line">            <span class="keyword">echo</span> $content;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通知所有客户端,不包含当前客户端</span></span><br><span class="line">            <span class="comment">/*foreach ($clients as $client) &#123;</span></span><br><span class="line"><span class="comment">                if ($client != $socket &amp;&amp; $client != $newSocket) &#123;</span></span><br><span class="line"><span class="comment">                    <span class="doctag">@socket</span>_write($client, $content);</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;*/</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($reads <span class="keyword">as</span> $key =&gt; $read) &#123;</span><br><span class="line">        <span class="comment">// 读取客户端数据</span></span><br><span class="line">        $data = @socket_read($read, <span class="number">2048</span>);</span><br><span class="line">        $clientId = (int)$read;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($data !== <span class="string">''</span>) &#123;</span><br><span class="line">            $data = trim($data);</span><br><span class="line">            <span class="comment">// 发送内容给客户端</span></span><br><span class="line">            $response = [</span><br><span class="line">                <span class="string">'message'</span> =&gt; strrev($data),</span><br><span class="line">                <span class="string">'time'</span> =&gt; date(<span class="string">'Y-m-d H:i:s'</span>),</span><br><span class="line">            ];</span><br><span class="line">            socket_write($read, json_encode($response) . <span class="string">"\n"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 移除对 $read 的监听</span></span><br><span class="line">            <span class="keyword">unset</span>($clients[$clientId]);</span><br><span class="line">            <span class="comment">// 关闭 $read 连接</span></span><br><span class="line">            socket_close($read);</span><br><span class="line">            <span class="comment">// 输出客户端断开连接</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Client #&#123;$clientId&#125; Disconnect."</span> . PHP_EOL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭TCP连接</span></span><br><span class="line">socket_close($socket);</span><br></pre></td></tr></table></figure>
<h6 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 启动服务端</span></span><br><span class="line">php server.php</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 运行多个客户端, 并输入 'hello', 然后断开连接</span></span><br><span class="line">[root@192 private]<span class="comment"># php client.php </span></span><br><span class="line">Connection succeeded, ClientId = <span class="comment">#17.</span></span><br><span class="line">hello</span><br><span class="line">olleh - 2018-10-17 17:59:20</span><br><span class="line"></span><br><span class="line">[root@192 private]<span class="comment"># php client.php </span></span><br><span class="line">Connection succeeded, ClientId = <span class="comment">#18.</span></span><br><span class="line">hello</span><br><span class="line">olleh - 2018-10-17 17:59:24</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 服务端输出</span></span><br><span class="line">[root@192 private]<span class="comment"># php socket.php </span></span><br><span class="line">Client <span class="comment">#17 Connected, IP=127.0.0.1, PORT=34138.</span></span><br><span class="line">Client <span class="comment">#18 Connected, IP=127.0.0.1, PORT=34141.</span></span><br><span class="line">Client <span class="comment">#17 Disconnect.</span></span><br><span class="line">Client <span class="comment">#18 Disconnect.</span></span><br></pre></td></tr></table></figure>
<hr>
<div class="note primary"><p>stream_socket - 服务端与客户端的通信</p></div>
<h5 id="服务端-server-php-1"><a href="#服务端-server-php-1" class="headerlink" title="服务端 server.php"></a>服务端 server.php</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$socketName = <span class="string">'tcp://127.0.0.1:7000'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立连接</span></span><br><span class="line">$socket = stream_socket_server($socketName, $errno, $errstr, STREAM_SERVER_BIND | STREAM_SERVER_LISTEN);</span><br><span class="line"><span class="keyword">if</span> (!$socket) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"stream_socket_server fail：&#123;$errstr&#125; (&#123;$errno&#125;)"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接受由 stream_socket_server() 创建的套接字连接,返回接受套接之后的资源流</span></span><br><span class="line"><span class="keyword">while</span> ($conn = @stream_socket_accept($socket, <span class="number">-1</span>, $remoteAddress)) &#123;</span><br><span class="line">    <span class="comment">// 向客户端发送数据, 告知客户端ID</span></span><br><span class="line">    $clientId = (int)$conn;</span><br><span class="line">    $response = [</span><br><span class="line">        <span class="string">'type'</span> =&gt; <span class="string">'login'</span>,</span><br><span class="line">        <span class="string">'message'</span> =&gt; $clientId,</span><br><span class="line">    ];</span><br><span class="line">    stream_socket_sendto($conn, json_encode($response) . <span class="string">"\n"</span>);</span><br><span class="line">    <span class="comment">// 输出客户端信息</span></span><br><span class="line">    <span class="keyword">list</span> ($address, $port) = explode(<span class="string">':'</span>, $remoteAddress);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Client #&#123;$clientId&#125; Connected, IP=&#123;$address&#125;, PORT=&#123;$port&#125;."</span> . PHP_EOL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 读取客户端数据</span></span><br><span class="line">        $data = stream_socket_recvfrom($conn, <span class="number">2048</span>);</span><br><span class="line">        <span class="keyword">if</span> ($data !== <span class="string">''</span> &amp;&amp; $data !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            $data = trim($data);</span><br><span class="line">            <span class="comment">// 发送内容给客户端</span></span><br><span class="line">            $response = [</span><br><span class="line">                <span class="string">'message'</span> =&gt; strrev($data),</span><br><span class="line">                <span class="string">'time'</span> =&gt; date(<span class="string">'Y-m-d H:i:s'</span>),</span><br><span class="line">            ];</span><br><span class="line">            stream_socket_sendto($conn, json_encode($response) . <span class="string">"\n"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fclose($conn);</span><br><span class="line">            <span class="comment">// 输出客户端断开连接</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Client #&#123;$clientId&#125; Disconnect."</span> . PHP_EOL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭连接</span></span><br><span class="line">fclose($socket);</span><br></pre></td></tr></table></figure>
<h6 id="客户端-client-php-1"><a href="#客户端-client-php-1" class="headerlink" title="客户端 client.php"></a>客户端 client.php</h6><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$socketName = <span class="string">'tcp://127.0.0.1:7000'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立连接</span></span><br><span class="line">$socket = stream_socket_client($socketName, $errno, $errstr, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">if</span> (!$socket) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"stream_socket_client fail：&#123;$errstr&#125; (&#123;$errno&#125;)"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取服务端数据</span></span><br><span class="line">$buffer = stream_socket_recvfrom($socket, <span class="number">2048</span>);</span><br><span class="line">$data = json_decode($buffer, <span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Connection succeeded, ClientId = #&#123;$data['message']&#125;."</span> . PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端与服务端交互</span></span><br><span class="line">interaction($socket);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">interaction</span><span class="params">($socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 获取客户端输入</span></span><br><span class="line">    $content = trim(fgets(STDIN));</span><br><span class="line">    <span class="comment">// 发送数据给服务端</span></span><br><span class="line">    stream_socket_sendto($socket, $content);</span><br><span class="line">    <span class="comment">// 读取服务端</span></span><br><span class="line">    $buffer = stream_socket_recvfrom($socket, <span class="number">2048</span>);</span><br><span class="line">    $data = json_decode($buffer, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&#123;$data['message']&#125; - &#123;$data['time']&#125;"</span> . PHP_EOL;</span><br><span class="line"></span><br><span class="line">    interaction($socket);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭连接</span></span><br><span class="line">fclose($socket);</span><br></pre></td></tr></table></figure>
<h6 id="IO-复用-服务端-server-php-1"><a href="#IO-复用-服务端-server-php-1" class="headerlink" title="IO 复用 - 服务端 server.php"></a>IO 复用 - 服务端 server.php</h6><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$socketName = <span class="string">'tcp://127.0.0.1:7000'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立连接</span></span><br><span class="line">$socket = stream_socket_server($socketName, $errno, $errstr, STREAM_SERVER_BIND | STREAM_SERVER_LISTEN);</span><br><span class="line"><span class="keyword">if</span> (!$socket) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"stream_socket_server fail：&#123;$errstr&#125; (&#123;$errno&#125;)"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端集合</span></span><br><span class="line">$clients = [(int)$socket =&gt; $socket];</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    $reads = $clients;</span><br><span class="line">    <span class="keyword">if</span> (stream_select($reads, $writes, $excepts, <span class="keyword">null</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($reads <span class="keyword">as</span> $read) &#123;</span><br><span class="line">        <span class="comment">// 新客户端连接</span></span><br><span class="line">        <span class="keyword">if</span> ($read === $socket) &#123;</span><br><span class="line">            <span class="comment">// 接受由 stream_socket_server() 创建的套接字连接,返回接受套接之后的资源流</span></span><br><span class="line">            $conn = stream_socket_accept($socket, <span class="number">0</span>, $remoteAddress);</span><br><span class="line">            <span class="comment">// 向客户端发送数据, 告知客户端ID</span></span><br><span class="line">            $clientId = (int)$conn;</span><br><span class="line">            $response = [</span><br><span class="line">                <span class="string">'type'</span> =&gt; <span class="string">'login'</span>,</span><br><span class="line">                <span class="string">'message'</span> =&gt; $clientId,</span><br><span class="line">            ];</span><br><span class="line">            stream_socket_sendto($conn, json_encode($response) . <span class="string">"\n"</span>);</span><br><span class="line">            <span class="comment">// 将客户端 $conn 加入到 $clients</span></span><br><span class="line">            $clients[$clientId] = $conn;</span><br><span class="line">            <span class="comment">// 移除对 $socket 的监听</span></span><br><span class="line">            <span class="keyword">unset</span>($reads[array_search($socket, $reads)]);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 输出客户端信息</span></span><br><span class="line">            <span class="keyword">list</span> ($address, $port) = explode(<span class="string">':'</span>, $remoteAddress);</span><br><span class="line">            $content = <span class="string">"Client #&#123;$clientId&#125; Connected, IP=&#123;$address&#125;, PORT=&#123;$port&#125;."</span> . PHP_EOL;</span><br><span class="line">            <span class="keyword">echo</span> $content;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通知所有客户端,不包含当前客户端</span></span><br><span class="line">            <span class="comment">/*foreach ($clients as $client) &#123;</span></span><br><span class="line"><span class="comment">                if ($client != $socket &amp;&amp; $client != $conn) &#123;</span></span><br><span class="line"><span class="comment">                    stream_socket_sendto($client, $content);</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;*/</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 读取客户端数据</span></span><br><span class="line">            $data = stream_socket_recvfrom($read, <span class="number">2048</span>);</span><br><span class="line">            $clientId = (int)$read;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ($data !== <span class="string">''</span> &amp;&amp; $data !== <span class="keyword">false</span>) &#123;</span><br><span class="line">                $data = trim($data);</span><br><span class="line">                <span class="comment">// 发送内容给客户端</span></span><br><span class="line">                $response = [</span><br><span class="line">                    <span class="string">'message'</span> =&gt; strrev($data),</span><br><span class="line">                    <span class="string">'time'</span> =&gt; date(<span class="string">'Y-m-d H:i:s'</span>),</span><br><span class="line">                ];</span><br><span class="line">                stream_socket_sendto($read, json_encode($response) . <span class="string">"\n"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 移除对 $read 的监听</span></span><br><span class="line">                <span class="keyword">unset</span>($clients[$clientId]);</span><br><span class="line">                <span class="comment">// 关闭连接</span></span><br><span class="line">                fclose($read);</span><br><span class="line">                <span class="comment">// 输出客户端断开连接</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"Client #&#123;$clientId&#125; Disconnect."</span> . PHP_EOL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭连接</span></span><br><span class="line">fclose($socket);</span><br></pre></td></tr></table></figure>
<hr>
<div class="note danger"><p>相关说明：</p>
<ol>
<li>socket_create 创建并返回一个套接字(用于监听[listen]和接受[accept]客户端的连接请求,不能用于与客户端之间发送和接收数据)</li>
<li>socket_accept 接受一个客户端的连接请求, 并返回一个新的套接字, 这个套接字与socket_create 返回的用于监听和接受客户端的连接请求的套接字不是同一个套接字,与本次接受的客户端的通信是通过在这个新的套接字上发送和接收数据来完成的</li>
<li>再次调用 socket_accept 可以接受下一个客户端的连接请求, 并再次返回一个新的套接字(与socket_create 返回的套接字、之前 socket_accept 返回的套接字都不同的新的套接字), 这个新的套接字用于与这次接受的客户端之间的通信</li>
<li>假设一共有3个客户端连接到服务器端, 那么在服务器端就一共有4个套接字, 第1个是 socket_create 返回的(用于监听的套接字),其余3个是分别调用3次 socket_accept 返回的不同的套接字</li>
<li>如果已经有客户端连接到服务器端, 不再需要监听和接受更多的客户端连接的时候, 可以关闭由 socket_create 返回的套接字, 而不会影响与客户端之间的通信</li>
<li>当某个客户端断开连接、或者是与某个客户端的通信完成之后, 服务器端需要关闭用于与该客户端通信的套接字</li>
<li>socket_listen 说明：每个 connect 都是往 listen 队列填装连接, 每一个 accept 操作都会从 listen 队列取连接转成 socket, 等待这个socket close 掉之后再继续从 listen 队列中取连接, 而 listen 队列长度就是 socket_listen 函数的第二个参数 backlog</li>
<li>socket_select 接受三个套接字数组, 分别检查数组中的套接字是否处于可以操作的状态(返回时只保留可操作的套接字), 使用最多的是 $read, 因此以读为例.<br>在套接字数组 $read 中最初应保有一个服务端监听套接字, 每当该套接字可读时, 就表示有一个用户发起了连接, 此时你需要对该连接创建一个套接字, 并加入到 $read 数组中;<br>当然, 并不只是服务端监听的套接字会变成可读的, 用户套接字也会变成可读的, 此时你就可以读取用户发来的数据了;<br>socket_select <code>只在套接字数组发生了变化时才返回</code>, 也就是说, 一旦执行到 socket_select 的下一条语句, 则必有一个套接字是需要你操作的</li>
<li>stream_socket_server($local_socket, $errno, $errstr, STREAM_SERVER_BIND | STREAM_SERVER_LISTEN) 相当于 socket_create()、socket_bind()、socket_listen()</li>
<li>stream_socket_accept 第二个参数 <code>$timeout</code>, 设置为 <code>0</code>, 连接将立即超时, 设置为 <code>-1</code>, 无限期等待连接</li>
<li>stream_select 与 socket_select 用法相似</li>
</ol></div>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>socket</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库动态配置定时任务</title>
    <url>/PHP/timed-task.html</url>
    <content><![CDATA[<div class="note danger"><p>基于 Symfony 框架, 不同框架原理一样</p></div>
<h5 id="数据表"><a href="#数据表" class="headerlink" title="数据表"></a>数据表</h5><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`task`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'任务ID task_id'</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'任务名称'</span>,</span><br><span class="line">  <span class="string">`desc`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'任务描述'</span>,</span><br><span class="line">  <span class="string">`controller`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'控制器名称'</span>,</span><br><span class="line">  <span class="string">`action`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'操作名称'</span>,</span><br><span class="line">  <span class="string">`interval_time`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'间隔时间,单位:秒'</span>,</span><br><span class="line">  <span class="string">`last_execution_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'最后一次执行时间'</span>,</span><br><span class="line">  <span class="string">`log_path`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'日志路径'</span>,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">smallint</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 0:停止, 1:启用'</span>,</span><br><span class="line">  <span class="string">`generate_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=MyISAM <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'定时任务表'</span>;</span><br></pre></td></tr></table></figure>
<h5 id="Linux-Crontab-或-Windows-计划任务-定时执行PHP文件-可创建多个相同任务"><a href="#Linux-Crontab-或-Windows-计划任务-定时执行PHP文件-可创建多个相同任务" class="headerlink" title="Linux Crontab 或 Windows 计划任务 定时执行PHP文件(可创建多个相同任务)"></a>Linux Crontab 或 Windows 计划任务 定时执行PHP文件(可创建多个相同任务)</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">*/1 * * * * /alidata/www/symfony/bin/TaskBatch.php &gt;/dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">AppBundle</span>\<span class="title">Task</span>\<span class="title">ProcessorTask</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../vendor/autoload.php'</span>;</span><br><span class="line"><span class="keyword">if</span> (PHP_VERSION_ID &lt; <span class="number">70000</span>) &#123;</span><br><span class="line">    <span class="keyword">include_once</span> <span class="keyword">__DIR__</span>.<span class="string">'/../var/bootstrap.php.cache'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$kernel = <span class="keyword">new</span> AppKernel(<span class="string">'prod'</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="keyword">if</span> (PHP_VERSION_ID &lt; <span class="number">70000</span>) &#123;</span><br><span class="line">    $kernel-&gt;loadClassCache();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$kernel-&gt;boot();</span><br><span class="line">$task = <span class="keyword">new</span> ProcessorTask($kernel-&gt;getContainer());</span><br><span class="line">$task-&gt;run();</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="定时任务处理代码"><a href="#定时任务处理代码" class="headerlink" title="定时任务处理代码"></a>定时任务处理代码</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">AppBundle</span>\<span class="title">Task</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">AppBundle</span>\<span class="title">Entity</span>\<span class="title">Task</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">AppBundle</span>\<span class="title">Repository</span>\<span class="title">TaskRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProcessorTask</span> <span class="keyword">extends</span> <span class="title">BaseTask</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run Task.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 日志路径</span></span><br><span class="line">        $timedTaskLogPath = <span class="keyword">$this</span>-&gt;getConfigParameter(<span class="string">'system_timed_task_log_path'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/** <span class="doctag">@var</span> TaskRepository $taskRepository */</span></span><br><span class="line">            $taskRepository = <span class="keyword">$this</span>-&gt;getRepository(Task::class);</span><br><span class="line">            <span class="comment">// 定时任务列表,只查询 status = 1 的任务</span></span><br><span class="line">            $taskList = $taskRepository-&gt;getTaskList();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">empty</span>($taskList)) &#123;</span><br><span class="line">                <span class="comment">// 增加内存,防止数据过大溢出</span></span><br><span class="line">                ini_set(<span class="string">'memory_limit'</span>, <span class="string">'256M'</span>);</span><br><span class="line">                <span class="comment">// 设置batch超时时间,避免数据过多处理超时</span></span><br><span class="line">                ini_set(<span class="string">'max_execution_time'</span>, <span class="number">1200</span>);</span><br><span class="line">                <span class="comment">// 当前时间</span></span><br><span class="line">                $nowTime = <span class="keyword">new</span> \DateTime();</span><br><span class="line"></span><br><span class="line">                <span class="comment">/** <span class="doctag">@var</span> Task $task */</span></span><br><span class="line">                <span class="keyword">foreach</span> ($taskList <span class="keyword">as</span> $task) &#123;</span><br><span class="line">                    $taskLockFile = $timedTaskLogPath . <span class="string">'task_'</span> . $task-&gt;getId() . <span class="string">'.lock'</span>;</span><br><span class="line">                    <span class="comment">// 防止任务重复执行</span></span><br><span class="line">                    <span class="keyword">if</span> (file_exists($taskLockFile)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 创建文件锁</span></span><br><span class="line">                    file_put_contents($taskLockFile, $task-&gt;getId(), <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                    $tmpTime = <span class="keyword">clone</span> $nowTime;</span><br><span class="line">                    $tmpTime-&gt;sub(<span class="keyword">new</span> \DateInterval(<span class="string">"PT&#123;$task-&gt;getIntervalTime()&#125;S"</span>));</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">empty</span>($task-&gt;getLastExecutionTime()) || !$task-&gt;getIntervalTime() || $tmpTime &gt; $task-&gt;getLastExecutionTime()) &#123;</span><br><span class="line">                        $taskInstance = <span class="keyword">$this</span>-&gt;get($task-&gt;getController());</span><br><span class="line">                        $logPath = (string)$task-&gt;getLogPath();</span><br><span class="line">                        <span class="keyword">if</span> (!<span class="keyword">empty</span>($logPath)) &#123;</span><br><span class="line">                            $logPath = $timedTaskLogPath . $logPath . <span class="string">'/'</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 执行任务</span></span><br><span class="line">                        $taskInstance-&gt;&#123;$task-&gt;getAction()&#125;($task-&gt;getName(), $logPath);</span><br><span class="line">                        <span class="comment">// 更新任务执行时间</span></span><br><span class="line">                        $taskRepository-&gt;saveEntity([</span><br><span class="line">                            <span class="string">'lastExecutionTime'</span> =&gt; <span class="keyword">new</span> \DateTime(),</span><br><span class="line">                        ], $task);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 解除文件锁</span></span><br><span class="line">                    unlink($taskLockFile);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;generateLog($e-&gt;getMessage(), $timedTaskLogPath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>全国省市区乡村五级联动</title>
    <url>/PHP/linkage.html</url>
    <content><![CDATA[<h5 id="三级联动SQL-包含港澳台-密码：k6l9"><a href="#三级联动SQL-包含港澳台-密码：k6l9" class="headerlink" title="三级联动SQL(包含港澳台), 密码：k6l9"></a><a href="https://pan.baidu.com/s/1TZbxrDd24Sq-CEE_TWAvgQ" target="_blank" rel="noopener">三级联动SQL(包含港澳台), 密码：k6l9</a></h5><h5 id="港澳台JSON数据"><a href="#港澳台JSON数据" class="headerlink" title="港澳台JSON数据"></a>港澳台JSON数据</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">"taiwan"</span>:&#123;<span class="string">"province"</span>:<span class="string">"台湾"</span>,<span class="string">"provinceID"</span>:<span class="string">"710000"</span>,<span class="string">"citys"</span>:[&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"阿莲区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大寮区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大社区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大树区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"凤山区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"冈山区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"鼓山区"</span>,<span class="string">"areaID"</span>:<span class="string">"710205"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"湖内区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"甲仙区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"林园区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"芩雅区"</span>,<span class="string">"areaID"</span>:<span class="string">"710203"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"六龟区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"路竹区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"茂林区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"美浓区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"弥陀区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"楠梓区"</span>,<span class="string">"areaID"</span>:<span class="string">"710210"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"那玛厦区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"内门区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"鸟松区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"旗津区"</span>,<span class="string">"areaID"</span>:<span class="string">"710206"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"旗山区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"其它区"</span>,<span class="string">"areaID"</span>:<span class="string">"710212"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"前金区"</span>,<span class="string">"areaID"</span>:<span class="string">"710202"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"前镇区"</span>,<span class="string">"areaID"</span>:<span class="string">"710207"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"桥头区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"茄萣区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"仁武区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"三民区"</span>,<span class="string">"areaID"</span>:<span class="string">"710208"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"杉林区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"桃源区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"田寮区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"小港区"</span>,<span class="string">"areaID"</span>:<span class="string">"710211"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"新兴区"</span>,<span class="string">"areaID"</span>:<span class="string">"710201"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"燕巢区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"盐埕区"</span>,<span class="string">"areaID"</span>:<span class="string">"710204"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"永安区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"梓官区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"左营区"</span>,<span class="string">"areaID"</span>:<span class="string">"710209"</span>&#125;],<span class="string">"city"</span>:<span class="string">"高雄市"</span>,<span class="string">"cityID"</span>:<span class="string">"710200"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"丰滨乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"凤林镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"富里乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"光复乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"花莲市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"吉安乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"瑞穗乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"寿丰乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"太鲁阁"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"万荣乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"新城乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"秀林乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"玉里镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"卓溪乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"花莲县"</span>,<span class="string">"cityID"</span>:<span class="string">"712600"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"安乐区"</span>,<span class="string">"areaID"</span>:<span class="string">"710705"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"暖暖区"</span>,<span class="string">"areaID"</span>:<span class="string">"710706"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"七堵区"</span>,<span class="string">"areaID"</span>:<span class="string">"710707"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"其它区"</span>,<span class="string">"areaID"</span>:<span class="string">"710708"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"仁爱区"</span>,<span class="string">"areaID"</span>:<span class="string">"710701"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"信义区"</span>,<span class="string">"areaID"</span>:<span class="string">"710702"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"中山区"</span>,<span class="string">"areaID"</span>:<span class="string">"710704"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"中正区"</span>,<span class="string">"areaID"</span>:<span class="string">"710703"</span>&#125;],<span class="string">"city"</span>:<span class="string">"基隆市"</span>,<span class="string">"cityID"</span>:<span class="string">"710700"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"东区"</span>,<span class="string">"areaID"</span>:<span class="string">"710901"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"其它区"</span>,<span class="string">"areaID"</span>:<span class="string">"710903"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"西区"</span>,<span class="string">"areaID"</span>:<span class="string">"710902"</span>&#125;],<span class="string">"city"</span>:<span class="string">"嘉义市"</span>,<span class="string">"cityID"</span>:<span class="string">"710900"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"阿里山乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"布袋镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大林镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大埔乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"东石乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"番路乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"六脚乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"鹿草乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"梅山乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"民雄乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"朴子乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"水上乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"太保市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"溪口乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"新港乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"义竹乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"中埔乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"竹崎乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"嘉义县"</span>,<span class="string">"cityID"</span>:<span class="string">"711900"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"金城镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"金湖镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"金宁乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"金沙镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"烈屿乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"乌坵乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"金门县"</span>,<span class="string">"cityID"</span>:<span class="string">"710500"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"北竿乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"东引乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"莒光乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"南竿乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"连江县"</span>,<span class="string">"cityID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"大湖乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"公馆乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"后龙镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"苗栗市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"南庄乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"三湾乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"三义乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"狮潭乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"泰安乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"铜锣乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"通霄镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"头份镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"头屋乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"西湖乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"苑里镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"造桥乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"竹南镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"卓兰镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"苗栗县"</span>,<span class="string">"cityID"</span>:<span class="string">"711500"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"草屯镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"国姓乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"集集镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"鹿谷乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"名间乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"南投市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"埔里镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"仁爱乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"水里乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"信义乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"鱼池乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"中寮乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"竹山镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"南投县"</span>,<span class="string">"cityID"</span>:<span class="string">"710600"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"白沙乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"湖西乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"马公市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"七美乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"望安乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"西屿乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"澎湖县"</span>,<span class="string">"cityID"</span>:<span class="string">"712700"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"长治乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"潮州镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"车城乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"春日乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"东港镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"枋寮乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"枋山乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"高树乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"桓春镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"佳冬乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"九如乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"崁顶乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"来义乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"里港乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"林边乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"麟洛乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"琉球乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"玛家乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"满州乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"牡丹乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"南州乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"内埔乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"屏东市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"三地门乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"狮子乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"泰武乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"万丹乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"万峦乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"雾台乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"新埤乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"新园乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"盐埔乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"竹田乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"屏东县"</span>,<span class="string">"cityID"</span>:<span class="string">"712400"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"北投区"</span>,<span class="string">"areaID"</span>:<span class="string">"710109"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大安区"</span>,<span class="string">"areaID"</span>:<span class="string">"710105"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大同区"</span>,<span class="string">"areaID"</span>:<span class="string">"710102"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"南港区"</span>,<span class="string">"areaID"</span>:<span class="string">"710111"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"内湖区"</span>,<span class="string">"areaID"</span>:<span class="string">"710110"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"其它区"</span>,<span class="string">"areaID"</span>:<span class="string">"710113"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"士林区"</span>,<span class="string">"areaID"</span>:<span class="string">"710108"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"松山区"</span>,<span class="string">"areaID"</span>:<span class="string">"710104"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"万华区"</span>,<span class="string">"areaID"</span>:<span class="string">"710106"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"文山区"</span>,<span class="string">"areaID"</span>:<span class="string">"710112"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"信义区"</span>,<span class="string">"areaID"</span>:<span class="string">"710107"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"中山区"</span>,<span class="string">"areaID"</span>:<span class="string">"710103"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"中正区"</span>,<span class="string">"areaID"</span>:<span class="string">"710101"</span>&#125;],<span class="string">"city"</span>:<span class="string">"台北市"</span>,<span class="string">"cityID"</span>:<span class="string">"710100"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"卑南乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"长滨乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"成功镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"池上乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"达仁乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大武乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"东河乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"关山镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"海瑞乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"金峰乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"兰屿乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"鹿野乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"绿岛乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"台东市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"太麻里乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"延平乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"台东县"</span>,<span class="string">"cityID"</span>:<span class="string">"712500"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"安定区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"安南区"</span>,<span class="string">"areaID"</span>:<span class="string">"710306"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"安平区"</span>,<span class="string">"areaID"</span>:<span class="string">"710305"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"白河区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"北门区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"北区"</span>,<span class="string">"areaID"</span>:<span class="string">"710304"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大内区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"东区"</span>,<span class="string">"areaID"</span>:<span class="string">"710302"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"东山区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"关庙区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"官田区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"归仁区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"后壁区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"佳里区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"将军区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"六甲区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"柳营区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"龙崎区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"麻豆区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"南化区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"南区"</span>,<span class="string">"areaID"</span>:<span class="string">"710303"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"楠西区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"七股区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"其它区"</span>,<span class="string">"areaID"</span>:<span class="string">"710307"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"仁德区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"善化区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"山上区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"西港区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"下营区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"新化区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"新市区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"新营区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"学甲区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"盐水区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"永康区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"玉井区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"中西区"</span>,<span class="string">"areaID"</span>:<span class="string">"710301"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"左镇区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"台南市"</span>,<span class="string">"cityID"</span>:<span class="string">"710300"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"北区"</span>,<span class="string">"areaID"</span>:<span class="string">"710405"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"北屯区"</span>,<span class="string">"areaID"</span>:<span class="string">"710406"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大安区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大肚区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大甲区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大里区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大雅区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"东区"</span>,<span class="string">"areaID"</span>:<span class="string">"710402"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"东势区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"丰原区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"和平区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"后里区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"龙井区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"南区"</span>,<span class="string">"areaID"</span>:<span class="string">"710403"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"南屯区"</span>,<span class="string">"areaID"</span>:<span class="string">"710408"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"其它区"</span>,<span class="string">"areaID"</span>:<span class="string">"710409"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"清水区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"沙鹿区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"神冈区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"石冈区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"太平区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"潭子区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"外埔区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"雾峰区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"梧栖区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"乌日区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"西区"</span>,<span class="string">"areaID"</span>:<span class="string">"710404"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"西屯区"</span>,<span class="string">"areaID"</span>:<span class="string">"710407"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"新社区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"中区"</span>,<span class="string">"areaID"</span>:<span class="string">"710401"</span>&#125;],<span class="string">"city"</span>:<span class="string">"台中市"</span>,<span class="string">"cityID"</span>:<span class="string">"710400"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"八德市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大溪镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大园乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"复兴乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"观音乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"龟山乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"龙潭乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"芦竹乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"平镇市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"桃园市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"新屋乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"杨梅市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"中坜市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"桃园县"</span>,<span class="string">"cityID"</span>:<span class="string">"711400"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"八里区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"板桥区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"淡水区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"贡寮区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"金山区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"林口区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"芦洲区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"坪林区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"平溪区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"瑞芳区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"三峡区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"三芝区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"三重区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"深坑区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"石碇区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"石门区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"树林区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"双溪区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"泰山区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"土城区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"万里区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"五股区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"乌来区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"汐止区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"新店区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"新庄区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"莺歌区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"永和区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"中和区"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"新北市"</span>,<span class="string">"cityID"</span>:<span class="string">"711100"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"北区"</span>,<span class="string">"areaID"</span>:<span class="string">"710802"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"东区"</span>,<span class="string">"areaID"</span>:<span class="string">"710801"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"其它区"</span>,<span class="string">"areaID"</span>:<span class="string">"710804"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"香山区"</span>,<span class="string">"areaID"</span>:<span class="string">"710803"</span>&#125;],<span class="string">"city"</span>:<span class="string">"新竹市"</span>,<span class="string">"cityID"</span>:<span class="string">"710800"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"宝山乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"北埔乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"峨眉乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"关西镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"横山乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"湖口乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"尖石乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"五峰乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"新丰乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"新埔镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"芎林乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"竹北市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"竹东镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"新竹县"</span>,<span class="string">"cityID"</span>:<span class="string">"711300"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"大同乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"钓鱼台"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"冬山乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"礁溪乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"罗东镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"南澳乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"三星乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"苏澳镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"头城镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"五结乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"宜兰市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"员山乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"壮围乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"宜兰县"</span>,<span class="string">"cityID"</span>:<span class="string">"711200"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"褒忠乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"北港镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"莿桐乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大埤乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"东势乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"斗六乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"斗南镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"二仑乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"古坑乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"虎尾镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"口湖乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"林内乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"仑背乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"麦寮乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"水林乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"四湖乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"台西乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"土库镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"西螺镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"元长乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"云林县"</span>,<span class="string">"cityID"</span>:<span class="string">"712100"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"北斗镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大城乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大村乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"二林镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"二水乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"芳苑乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"芬园乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"福兴乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"和美镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"花坛乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"鹿港镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"埤头乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"埔心乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"埔盐乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"社头乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"伸港乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"田尾乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"田中镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"溪湖镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"溪州乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"线西乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"秀水乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"永靖乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"员林镇"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"彰化市"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"竹塘乡"</span>,<span class="string">"areaID"</span>:<span class="string">""</span>&#125;],<span class="string">"city"</span>:<span class="string">"彰化县"</span>,<span class="string">"cityID"</span>:<span class="string">"711700"</span>&#125;]&#125;,<span class="string">"hk"</span>:&#123;<span class="string">"province"</span>:<span class="string">"香港"</span>,<span class="string">"provinceID"</span>:<span class="string">"810000"</span>,<span class="string">"citys"</span>:[&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"九龙城区"</span>,<span class="string">"areaID"</span>:<span class="string">"810201"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"油尖旺区"</span>,<span class="string">"areaID"</span>:<span class="string">"810202"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"深水埗区"</span>,<span class="string">"areaID"</span>:<span class="string">"810203"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"黄大仙区"</span>,<span class="string">"areaID"</span>:<span class="string">"810204"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"观塘区"</span>,<span class="string">"areaID"</span>:<span class="string">"810205"</span>&#125;],<span class="string">"city"</span>:<span class="string">"九龙"</span>,<span class="string">"cityID"</span>:<span class="string">"810200"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"中西区"</span>,<span class="string">"areaID"</span>:<span class="string">"810101"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"湾仔"</span>,<span class="string">"areaID"</span>:<span class="string">"810102"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"东区"</span>,<span class="string">"areaID"</span>:<span class="string">"810103"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"南区"</span>,<span class="string">"areaID"</span>:<span class="string">"810104"</span>&#125;],<span class="string">"city"</span>:<span class="string">"香港岛"</span>,<span class="string">"cityID"</span>:<span class="string">"810100"</span>&#125;,&#123;<span class="string">"areas"</span>:[&#123;<span class="string">"area"</span>:<span class="string">"北区"</span>,<span class="string">"areaID"</span>:<span class="string">"810301"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"大埔区"</span>,<span class="string">"areaID"</span>:<span class="string">"810302"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"沙田区"</span>,<span class="string">"areaID"</span>:<span class="string">"810303"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"西贡区"</span>,<span class="string">"areaID"</span>:<span class="string">"810304"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"元朗区"</span>,<span class="string">"areaID"</span>:<span class="string">"810305"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"屯门区"</span>,<span class="string">"areaID"</span>:<span class="string">"810306"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"荃湾区"</span>,<span class="string">"areaID"</span>:<span class="string">"810307"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"葵青区"</span>,<span class="string">"areaID"</span>:<span class="string">"810308"</span>&#125;,&#123;<span class="string">"area"</span>:<span class="string">"离岛区"</span>,<span class="string">"areaID"</span>:<span class="string">"810309"</span>&#125;],<span class="string">"city"</span>:<span class="string">"新界"</span>,<span class="string">"cityID"</span>:<span class="string">"810300"</span>&#125;]&#125;,<span class="string">"mo"</span>:&#123;<span class="string">"province"</span>:<span class="string">"澳门"</span>,<span class="string">"provinceID"</span>:<span class="string">"820000"</span>,<span class="string">"citys"</span>:[&#123;<span class="string">"areas"</span>:[],<span class="string">"city"</span>:<span class="string">"澳门半岛"</span>,<span class="string">"cityID"</span>:<span class="string">"820100"</span>&#125;,&#123;<span class="string">"areas"</span>:[],<span class="string">"city"</span>:<span class="string">"离岛"</span>,<span class="string">"cityID"</span>:<span class="string">"820200"</span>&#125;]&#125;&#125;</span><br></pre></td></tr></table></figure>
<h5 id="五级联动DEMO"><a href="#五级联动DEMO" class="headerlink" title="五级联动DEMO"></a>五级联动DEMO</h5><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`location`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`top_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</span><br><span class="line">  <span class="string">`parent_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  <span class="string">`province_code`</span> <span class="built_in">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  <span class="string">`city_code`</span> <span class="built_in">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  <span class="string">`area_code`</span> <span class="built_in">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  <span class="string">`street_code`</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  <span class="string">`village_code`</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  <span class="string">`level`</span> <span class="built_in">smallint</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'1'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=MyISAM <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 ROW_FORMAT=DYNAMIC;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $dbh = <span class="keyword">new</span> PDO(<span class="string">'mysql:host=localhost;dbname=test'</span>, <span class="string">'root'</span>, <span class="string">'root'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($_SERVER[<span class="string">'REQUEST_METHOD'</span>] == <span class="string">'POST'</span>) &#123;</span><br><span class="line">        $type = $_POST[<span class="string">'type'</span>] ?? <span class="string">''</span>;</span><br><span class="line">        $parentId = $_POST[<span class="string">'parent_id'</span>] ?? <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">switch</span> ($type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'province'</span>:</span><br><span class="line">                $level = <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'city'</span>:</span><br><span class="line">                $level = <span class="number">3</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'area'</span>:</span><br><span class="line">                $level = <span class="number">4</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'street'</span>:</span><br><span class="line">                $level = <span class="number">5</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                $level = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $sth = $dbh-&gt;prepare(<span class="string">'SELECT * FROM `location` WHERE `parent_id` = :parentId AND `level` = :level'</span>);</span><br><span class="line">        $sth-&gt;bindParam(<span class="string">':parentId'</span>, $parentId, PDO::PARAM_INT);</span><br><span class="line">        $sth-&gt;bindParam(<span class="string">':level'</span>, $level, PDO::PARAM_INT);</span><br><span class="line">        $sth-&gt;execute();</span><br><span class="line">        $data = $sth-&gt;fetchAll(PDO::FETCH_ASSOC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">die</span>(json_encode([<span class="string">'data'</span> =&gt; $data]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $level = <span class="number">1</span>;</span><br><span class="line">    $sth = $dbh-&gt;prepare(<span class="string">'SELECT * FROM `location` WHERE `level` = :level'</span>);</span><br><span class="line">    $sth-&gt;bindParam(<span class="string">':level'</span>, $level, PDO::PARAM_INT);</span><br><span class="line">    $sth-&gt;execute();</span><br><span class="line">    $provinceList = $sth-&gt;fetchAll(PDO::FETCH_ASSOC);</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">die</span>($e-&gt;getMessage());</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;link href=<span class="string">"layui/css/layui.css"</span> rel=<span class="string">"stylesheet"</span> media=<span class="string">"all"</span> /&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div class="layui-layout layui-layout-admin"&gt;</span><br><span class="line">    &lt;div class="layui-body"&gt;</span><br><span class="line">        &lt;form class="layui-form" action=""&gt;</span><br><span class="line">            &lt;div class="layui-form-item"&gt;</span><br><span class="line">                &lt;div class="layui-input-inline"&gt;</span><br><span class="line">                    &lt;select name=<span class="string">"province"</span>&gt;</span><br><span class="line">                        &lt;option value=<span class="string">""</span>&gt;请选择省&lt;/option&gt;</span><br><span class="line">                        <span class="meta">&lt;?php</span></span><br><span class="line">                            <span class="keyword">foreach</span> ($provinceList <span class="keyword">as</span> $province) &#123;</span><br><span class="line">                                <span class="keyword">echo</span> <span class="string">"&lt;option value=\"&#123;$province['id']&#125;\"&gt;&#123;$province['name']&#125;&lt;/option&gt;"</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        <span class="meta">?&gt;</span></span><br><span class="line">                    &lt;/select&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="layui-input-inline"&gt;</span><br><span class="line">                    &lt;select name=<span class="string">"city"</span>&gt;</span><br><span class="line">                        &lt;option value=<span class="string">""</span>&gt;请选择市&lt;/option&gt;</span><br><span class="line">                    &lt;/select&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="layui-input-inline"&gt;</span><br><span class="line">                    &lt;select name=<span class="string">"area"</span>&gt;</span><br><span class="line">                        &lt;option value=<span class="string">""</span>&gt;请选择县/区&lt;/option&gt;</span><br><span class="line">                    &lt;/select&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="layui-input-inline"&gt;</span><br><span class="line">                    &lt;select name=<span class="string">"street"</span>&gt;</span><br><span class="line">                        &lt;option value=<span class="string">""</span>&gt;请选择街道&lt;/option&gt;</span><br><span class="line">                    &lt;/select&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="layui-input-inline"&gt;</span><br><span class="line">                    &lt;select name=<span class="string">"village"</span>&gt;</span><br><span class="line">                        &lt;option value=<span class="string">""</span>&gt;请选择居委会&lt;/option&gt;</span><br><span class="line">                    &lt;/select&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;script src=<span class="string">"jquery-3.3.1.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=<span class="string">"layui/layui.all.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    layui.<span class="keyword">use</span>([<span class="string">'form'</span>], <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> form = layui.form;</span><br><span class="line"></span><br><span class="line">        form.on(<span class="string">'select'</span>, <span class="function"><span class="keyword">function</span><span class="params">(data)</span> </span>&#123;</span><br><span class="line">            let id = data.value;</span><br><span class="line">            let type = data.elem.name;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (id !== <span class="string">''</span> &amp;&amp; type !== <span class="string">'village'</span>) &#123;</span><br><span class="line">                $.ajax(&#123;</span><br><span class="line">                    url: <span class="string">''</span>,</span><br><span class="line">                    type: <span class="string">'POST'</span>,</span><br><span class="line">                    data: &#123;type: type, parent_id: id&#125;,</span><br><span class="line">                    dataType: <span class="string">'JSON'</span>,</span><br><span class="line">                &#125;).done(<span class="function"><span class="keyword">function</span><span class="params">(response)</span> </span>&#123;</span><br><span class="line">                    let data = response.data;</span><br><span class="line">                    let obj;</span><br><span class="line">                    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'province'</span>:</span><br><span class="line">                            obj = $(<span class="string">'select[name="city"]'</span>);</span><br><span class="line">                            obj.html(<span class="string">'&lt;option value=""&gt;请选择市&lt;/option&gt;'</span>);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'city'</span>:</span><br><span class="line">                            obj = $(<span class="string">'select[name="area"]'</span>);</span><br><span class="line">                            obj.html(<span class="string">'&lt;option value=""&gt;请选择县/区&lt;/option&gt;'</span>);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'area'</span>:</span><br><span class="line">                            obj = $(<span class="string">'select[name="street"]'</span>);</span><br><span class="line">                            obj.html(<span class="string">'&lt;option value=""&gt;请选择街道&lt;/option&gt;'</span>);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'street'</span>:</span><br><span class="line">                            obj = $(<span class="string">'select[name="village"]'</span>);</span><br><span class="line">                            obj.html(<span class="string">'&lt;option value=""&gt;请选择居委会&lt;/option&gt;'</span>);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    $.each(data, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        let option = `&lt;option value=<span class="string">"$&#123;this.id&#125;"</span>&gt;$&#123;this.name&#125;&lt;/option&gt;`;</span><br><span class="line">                        obj.append(option);</span><br><span class="line">                    &#125;);</span><br><span class="line">                    form.render();</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP 系列 (二)</title>
    <url>/PHP/php-series-2.html</url>
    <content><![CDATA[<div class="note danger"><p>获取微信头像时, 将头像地址尾部的 /0 替换成 /96, 即是获取微信头像缩略图</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$headImg = <span class="string">'http://wx.qlogo.cn/mmopen/3NKFAMZl61HUWEYUkOK5oPib1GqOlMWYk7tt1N6WNeqvychibiaU4A0nynlYz4aOHcvNdhDla0bicpDJOdZJrQ6u6vANnktos0eI/0'</span>;</span><br><span class="line"><span class="keyword">if</span> (($index = strrpos($headImg, <span class="string">'/0'</span>)) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">    $thumbHeadImg = substr_replace($headImg, <span class="string">'/96'</span>, $index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>伪造IP</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 伪造IP</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $url</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">forged_ip</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $header = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'CLIENT-IP:'</span> . <span class="string">'111.111.111.'</span> . rand(<span class="number">1</span>, <span class="number">254</span>),</span><br><span class="line">        <span class="string">'X-FORWARDED-FOR:'</span> . <span class="string">'111.111.111.'</span> . rand(<span class="number">1</span>, <span class="number">254</span>),</span><br><span class="line">    );</span><br><span class="line">    $userAgentArr = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; .NET CLR 2.0.50727; InfoPath.2; AskTbPTV/5.17.0.25589; Alexa Toolbar)'</span>,</span><br><span class="line">        <span class="string">'Mozilla/5.0 (Windows NT 5.1; rv:22.0) Gecko/20100101 Firefox/22.0'</span>,</span><br><span class="line">        <span class="string">'Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; .NET4.0C; Alexa Toolbar)'</span>,</span><br><span class="line">        <span class="string">'Mozilla/4.0(compatible; MSIE 6.0; Windows NT 5.1; SV1)'</span>,</span><br><span class="line">        $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]</span><br><span class="line">    );</span><br><span class="line">    $userAgent = $userAgentArr[rand(<span class="number">0</span>, <span class="number">3</span>)];</span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER, $header);</span><br><span class="line">    curl_setopt($ch, CURLOPT_REFERER, $url);</span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_USERAGENT, $userAgent);</span><br><span class="line">    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, <span class="number">7</span>);</span><br><span class="line">    $result = curl_exec($ch);</span><br><span class="line">    curl_close($ch);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p>使用 <code>ReflectionClass</code> <code>ReflectionProperty</code> 创建实例并初始化</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $nickname;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $registerTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户数据</span></span><br><span class="line">$userData = [</span><br><span class="line">    <span class="string">'id'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">    <span class="string">'nickname'</span> =&gt; <span class="string">'test'</span>,</span><br><span class="line">    <span class="string">'age'</span> =&gt; <span class="number">12</span>,</span><br><span class="line">    <span class="string">'registerTime'</span> =&gt; <span class="keyword">new</span> DateTime(),</span><br><span class="line">];</span><br><span class="line"><span class="comment">// 类名</span></span><br><span class="line">$className = <span class="string">'User'</span>;</span><br><span class="line"><span class="comment">// 反射类</span></span><br><span class="line">$reflectionClass = <span class="keyword">new</span> ReflectionClass($className);</span><br><span class="line"><span class="comment">// 创建类的实例</span></span><br><span class="line">$instance = $reflectionClass-&gt;newInstanceWithoutConstructor();</span><br><span class="line"><span class="keyword">foreach</span> ($userData <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    <span class="comment">// 类属性已定义</span></span><br><span class="line">    <span class="keyword">if</span> ($reflectionClass-&gt;hasProperty($key)) &#123;</span><br><span class="line">        <span class="comment">// 获取类属性的相关信息</span></span><br><span class="line">        $reflectionProperty = <span class="keyword">new</span> ReflectionProperty($className, $key);</span><br><span class="line">        <span class="comment">// 属性未公开</span></span><br><span class="line">        <span class="keyword">if</span> (!$reflectionProperty-&gt;isPublic()) &#123;</span><br><span class="line">            <span class="comment">// 将属性设置为可访问</span></span><br><span class="line">            $reflectionProperty-&gt;setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置属性值</span></span><br><span class="line">        $reflectionProperty-&gt;setValue($instance, $val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">var_dump($instance);</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>使用 <code>ReflectionClass</code> <code>ReflectionMethod</code> 实现前置/后置方法功能模块, 执行带参数的方法</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">indexAction</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'index&lt;br /&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testAction</span><span class="params">($year = <span class="number">2012</span>, $month = <span class="number">2</span>, $day = <span class="number">21</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $year . <span class="string">'--------'</span> . $month . <span class="string">'-----------'</span> . $day . <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_before_index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__FUNCTION__</span> . <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_after_index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__FUNCTION__</span> . <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行index方法</span></span><br><span class="line">$method = <span class="keyword">new</span> ReflectionMethod(<span class="string">'IndexController'</span>, <span class="string">'indexAction'</span>);</span><br><span class="line"><span class="comment">// 进行权限判断</span></span><br><span class="line"><span class="keyword">if</span> ($method-&gt;isPublic()) &#123;</span><br><span class="line">    $class = <span class="keyword">new</span> ReflectionClass(<span class="string">'IndexController'</span>);</span><br><span class="line">    <span class="comment">// 执行前置方法</span></span><br><span class="line">    <span class="keyword">if</span> ($class-&gt;hasMethod(<span class="string">'_before_index'</span>)) &#123;</span><br><span class="line">        $beforeMethod = $class-&gt;getMethod(<span class="string">'_before_index'</span>);</span><br><span class="line">        <span class="keyword">if</span> ($beforeMethod-&gt;isPublic()) &#123;</span><br><span class="line">            $beforeMethod-&gt;invoke(<span class="keyword">new</span> IndexController);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $method-&gt;invoke(<span class="keyword">new</span> IndexController);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行后置方法</span></span><br><span class="line">    <span class="keyword">if</span>($class-&gt;hasMethod(<span class="string">'_after_index'</span>))&#123;</span><br><span class="line">        $beforeMethod = $class-&gt;getMethod(<span class="string">'_after_index'</span>);</span><br><span class="line">        <span class="keyword">if</span> ($beforeMethod-&gt;isPublic()) &#123;</span><br><span class="line">            $beforeMethod-&gt;invoke(<span class="keyword">new</span> IndexController);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行带参数的方法</span></span><br><span class="line">$method = <span class="keyword">new</span> ReflectionMethod(<span class="string">'IndexController'</span>, <span class="string">'testAction'</span>);</span><br><span class="line">$params = $method-&gt;getParameters();</span><br><span class="line"><span class="keyword">foreach</span> ($params <span class="keyword">as</span> $param ) &#123;</span><br><span class="line">    $paramName = $param-&gt;getName();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[$paramName])) &#123;</span><br><span class="line">        $args[] = $_REQUEST[$paramName];</span><br><span class="line">    &#125; <span class="keyword">elseif</span> ($param-&gt;isDefaultValueAvailable()) &#123;</span><br><span class="line">        $args[] = $param-&gt;getDefaultValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (count($args) == $method-&gt;getNumberOfParameters()) &#123;</span><br><span class="line">    $method-&gt;invokeArgs(<span class="keyword">new</span> IndexController, $args);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'parameters is not match!'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>ArrayAccess 使对象可以像数组一样被访问<br>JsonSerializable 自定义JSON化的结果</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Configuration</span> <span class="keyword">implements</span> <span class="title">JsonSerializable</span>, <span class="title">ArrayAccess</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $config;</span><br><span class="line">    <span class="keyword">private</span> $configArray;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;configArray = [</span><br><span class="line">            <span class="string">'a'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">'b'</span> =&gt; <span class="number">2</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>::$config == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">self</span>::$config = <span class="keyword">new</span> Configuration();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">jsonSerialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Custom Json：'</span> . serialize(<span class="keyword">new</span> Configuration());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetExists</span><span class="params">($offset)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;configArray[$offset]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetGet</span><span class="params">($offset)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;configArray[$offset];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetSet</span><span class="params">($offset, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;configArray[$offset] = $value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetUnset</span><span class="params">($offset)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;configArray[$offset]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$configuration = Configuration::instance();</span><br><span class="line"></span><br><span class="line">var_dump($configuration[<span class="string">'a'</span>]); <span class="comment">// 输出 1</span></span><br><span class="line">$configuration[<span class="string">'a'</span>] = <span class="number">3</span>;</span><br><span class="line">var_dump($configuration[<span class="string">'a'</span>]); <span class="comment">// 输出 3</span></span><br><span class="line"></span><br><span class="line">var_dump(<span class="keyword">isset</span>($configuration[<span class="string">'b'</span>])); <span class="comment">// 输出 true</span></span><br><span class="line">var_dump(<span class="keyword">isset</span>($configuration[<span class="string">'c'</span>])); <span class="comment">// 输出 false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unset</span>($configuration[<span class="string">'b'</span>]);</span><br><span class="line">var_dump(<span class="keyword">isset</span>($configuration[<span class="string">'b'</span>])); <span class="comment">// 输出 false</span></span><br><span class="line"></span><br><span class="line">var_dump(json_encode($configuration)); <span class="comment">// 输出 Custom Json\uff1aO:13:\"Configuration\":1:&#123;s:26:\"\u0000Configuration\u0000configArray\";a:2:&#123;s:1:\"a\";i:1;s:1:\"b\";i:2;&#125;&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP 常用方法 (二)</title>
    <url>/PHP/php-common-functions-2.html</url>
    <content><![CDATA[<div class="note danger"><p>无限级分类(一维数组)</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 无限级分类(一维数组)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $data</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $fieldNameArr</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $pid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $level</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $showLevel</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTree</span><span class="params">(&amp;$data, $fieldNameArr = [<span class="string">'pid'</span>, <span class="string">'id'</span>], $pid = <span class="number">0</span>, $level = <span class="number">0</span>, $showLevel = <span class="number">3</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($level &gt;= $showLevel) &#123;</span><br><span class="line">        <span class="keyword">return</span> $data[<span class="string">'new'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($data[<span class="string">'old'</span>])) &#123;</span><br><span class="line">        $data = [</span><br><span class="line">            <span class="string">'old'</span> =&gt; $data,</span><br><span class="line">            <span class="string">'new'</span> =&gt; []</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($data[<span class="string">'old'</span>] <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($v[$fieldNameArr[<span class="number">0</span>]] == $pid) &#123;</span><br><span class="line">            $v[<span class="string">'level'</span>] = $level;</span><br><span class="line">            $data[<span class="string">'new'</span>][] = $v;</span><br><span class="line">            <span class="keyword">unset</span>($data[<span class="string">'old'</span>][$k]);</span><br><span class="line">            getTree($data, $fieldNameArr, $v[$fieldNameArr[<span class="number">1</span>]], $level + <span class="number">1</span>, $showLevel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $data[<span class="string">'new'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>无限级分类(多维数组)</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 无限级分类(多维数组)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $data</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $fieldNameArr</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTreeT</span><span class="params">($data, $fieldNameArr = [<span class="string">'pid'</span>, <span class="string">'id'</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $dataArr = [];</span><br><span class="line">    <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $d) &#123;</span><br><span class="line">        $dataArr[$d[$fieldNameArr[<span class="number">1</span>]]] = $d;</span><br><span class="line">        $dataArr[$d[$fieldNameArr[<span class="number">1</span>]]][<span class="string">'child'</span>] = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> ($dataArr <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($v[$fieldNameArr[<span class="number">0</span>]] != <span class="number">0</span>) &#123;</span><br><span class="line">            $dataArr[$v[$fieldNameArr[<span class="number">0</span>]]][<span class="string">'child'</span>][$v[$fieldNameArr[<span class="number">1</span>]]] = &amp;$dataArr[$v[$fieldNameArr[<span class="number">1</span>]]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> ($dataArr <span class="keyword">as</span> $tk =&gt; $tv) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($tv[$fieldNameArr[<span class="number">0</span>]] != <span class="number">0</span> || !<span class="keyword">isset</span>($tv[$fieldNameArr[<span class="number">0</span>]])) &#123;</span><br><span class="line">            <span class="keyword">unset</span>($dataArr[$tk]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $dataArr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p>获取某个分类下的所有子类</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取某个分类下的所有子类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $data</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $parentId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $fieldNameArr</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array $dataArr</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCateChild</span><span class="params">($data, $parentId, $fieldNameArr = [<span class="string">'pid'</span>, <span class="string">'id'</span>], &amp;$dataArr = array<span class="params">()</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($v[$fieldNameArr[<span class="number">0</span>]] == $parentId) &#123;</span><br><span class="line">            $dataArr[] = $v[$fieldNameArr[<span class="number">1</span>]];</span><br><span class="line">            getCateChild($data, $v[$fieldNameArr[<span class="number">1</span>]], $fieldNameArr, $dataArr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $dataArr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>IP转换为整数</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * IP转换为整数</span></span><br><span class="line"><span class="comment"> * IP段地址：http://ipblock.chacuo.net/down/t_txt=c_CN</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> boolean $rand 获取国内随机IP</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_ip_convert</span><span class="params">($rand = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($rand) &#123;</span><br><span class="line">        $ipLong = [</span><br><span class="line">            [<span class="string">'610271232'</span>, <span class="string">'618659839'</span>],     <span class="comment">// 36.96.0.0    -   36.223.255.255</span></span><br><span class="line">            [<span class="string">'1002434560'</span>, <span class="string">'1008730111'</span>],   <span class="comment">// 59.191.240.0 -   60.31.255.255</span></span><br><span class="line">            [<span class="string">'1861222400'</span>, <span class="string">'1866465279'</span>],   <span class="comment">// 110.240.0.0  -   111.63.255.255</span></span><br><span class="line">            [<span class="string">'-569376768'</span>, <span class="string">'-564133889'</span>],   <span class="comment">// 222.16.0.0   -   222.95.255.255</span></span><br><span class="line">            [<span class="string">'-1224736768'</span>, <span class="string">'-1220018177'</span>], <span class="comment">// 183.0.0.0    -   183.71.255.255</span></span><br><span class="line">            [<span class="string">'-1212678144'</span>, <span class="string">'-1207959553'</span>], <span class="comment">// 183.184.0.0  -   183.255.255.255</span></span><br><span class="line">            [<span class="string">'1879048192'</span>, <span class="string">'1883504639'</span>],   <span class="comment">// 112.0.0.0    -   112.67.255.255</span></span><br><span class="line">        ];</span><br><span class="line">        $randKey = mt_rand(<span class="number">0</span>, count($ipLong));</span><br><span class="line">        $ipArr = [long2ip(mt_rand($ipLong[$randKey][<span class="number">0</span>], $ipLong[$randKey][<span class="number">1</span>]))];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $ipArr = [$_SERVER[<span class="string">'REMOTE_ADDR'</span>] == <span class="string">'::1'</span> ? <span class="string">'127.0.0.1'</span> : $_SERVER[<span class="string">'REMOTE_ADDR'</span>]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $ipArr[<span class="number">1</span>] = sprintf(<span class="string">'%u'</span>, ip2long($ipArr[<span class="number">0</span>]));</span><br><span class="line">    <span class="keyword">return</span> $ipArr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>笛卡尔积</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cartesianProduct</span><span class="params">(array $params)</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $result = array_shift($params);</span><br><span class="line">    <span class="keyword">while</span> ($item = array_shift($params)) &#123;</span><br><span class="line">        $temp = [];</span><br><span class="line">        <span class="keyword">foreach</span> ($result <span class="keyword">as</span> $res) &#123;</span><br><span class="line">            !is_array($res) &amp;&amp; $res = [$res];</span><br><span class="line">            <span class="keyword">foreach</span> ($item <span class="keyword">as</span> $val) &#123;</span><br><span class="line">                !is_array($val) &amp;&amp; $val = [$val];</span><br><span class="line">                $temp[] = array_merge($res, $val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $result = $temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>客户端类型校验</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 客户端类型校验</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $type 1:微信内置浏览器, 2:支付宝内置浏览器, 3:IOS, 4:Android</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clientTypeValidator</span><span class="params">(int $type)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $mobileFlag = <span class="keyword">self</span>::isMobile();</span><br><span class="line">    <span class="keyword">if</span> ($mobileFlag) &#123;</span><br><span class="line">        $userAgent = strtolower($_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]);</span><br><span class="line">        <span class="keyword">switch</span> ($type) &#123;</span><br><span class="line">            <span class="comment">// 微信内置浏览器</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> strpos($userAgent, <span class="string">'micromessenger'</span>) !== <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// 支付宝内置浏览器</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> strpos($userAgent, <span class="string">'aliapp'</span>) !== <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// IOS</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">return</span> strpos($userAgent, <span class="string">'iphone'</span>) !== <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// Android</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="keyword">return</span> strpos($userAgent, <span class="string">'android'</span>) !== <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>判断请求来源是否手机端</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断请求来源是否手机端</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isMobile</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// HTTP_X_WAP_PROFILE|VIA信息含有wap</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_WAP_PROFILE'</span>]) || (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_VIA'</span>]) &amp;&amp; stristr($_SERVER[<span class="string">'HTTP_VIA'</span>], <span class="string">'wap'</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $clientKeywords = [</span><br><span class="line">        <span class="string">'nokia'</span>, <span class="string">'sony'</span>, <span class="string">'ericsson'</span>, <span class="string">'mot'</span>, <span class="string">'samsung'</span>, <span class="string">'htc'</span>, <span class="string">'sgh'</span>, <span class="string">'lg'</span>, <span class="string">'sharp'</span>, <span class="string">'sie-'</span>, <span class="string">'philips'</span>, <span class="string">'panasonic'</span>, <span class="string">'alcatel'</span>, <span class="string">'lenovo'</span>, <span class="string">'iphone'</span>,</span><br><span class="line">        <span class="string">'ipod'</span>, <span class="string">'blackberry'</span>, <span class="string">'meizu'</span>, <span class="string">'android'</span>, <span class="string">'netfront'</span>, <span class="string">'symbian'</span>, <span class="string">'ucweb'</span>, <span class="string">'windowsce'</span>, <span class="string">'palm'</span>, <span class="string">'operamini'</span>, <span class="string">'operamobi'</span>, <span class="string">'openwave'</span>,</span><br><span class="line">        <span class="string">'nexusone'</span>, <span class="string">'cldc'</span>, <span class="string">'midp'</span>, <span class="string">'wap'</span>, <span class="string">'mobile'</span></span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/("</span> . implode(<span class="string">'|'</span>, $clientKeywords) . <span class="string">")/i"</span>, strtolower($_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>JSON字符串校验</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JSON字符串校验</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $jsonStr</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> false|array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonValidate</span><span class="params">(string $jsonStr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $result = json_decode($jsonStr, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> (json_last_error() == JSON_ERROR_NONE) ? $result : <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>Sourcetree 跳过注册</title>
    <url>/Git/sourcetree.html</url>
    <content><![CDATA[<div class="note danger"><p><a href="https://www.sourcetreeapp.com/" target="_blank" rel="noopener">Sourcetree</a></p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 打开 我的电脑,复制下面的路径至地址栏</span></span><br><span class="line">%LocalAppData%\Atlassian\SourceTree\</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 新建 accounts.json, 如下：</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"<span class="variable">$id</span>"</span>: <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"<span class="variable">$type</span>"</span>: <span class="string">"SourceTree.Api.Host.Identity.Model.IdentityAccount, SourceTree.Api.Host.Identity"</span>,</span><br><span class="line">    <span class="string">"Authenticate"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"HostInstance"</span>: &#123;</span><br><span class="line">      <span class="string">"<span class="variable">$id</span>"</span>: <span class="string">"2"</span>,</span><br><span class="line">      <span class="string">"<span class="variable">$type</span>"</span>: <span class="string">"SourceTree.Host.Atlassianaccount.AtlassianAccountInstance, SourceTree.Host.AtlassianAccount"</span>,</span><br><span class="line">      <span class="string">"Host"</span>: &#123;</span><br><span class="line">        <span class="string">"<span class="variable">$id</span>"</span>: <span class="string">"3"</span>,</span><br><span class="line">        <span class="string">"<span class="variable">$type</span>"</span>: <span class="string">"SourceTree.Host.Atlassianaccount.AtlassianAccountHost, SourceTree.Host.AtlassianAccount"</span>,</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"atlassian account"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"BaseUrl"</span>: <span class="string">"https://id.atlassian.com/"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"Credentials"</span>: &#123;</span><br><span class="line">      <span class="string">"<span class="variable">$id</span>"</span>: <span class="string">"4"</span>,</span><br><span class="line">      <span class="string">"<span class="variable">$type</span>"</span>: <span class="string">"SourceTree.Model.BasicAuthCredentials, SourceTree.Api.Account"</span>,</span><br><span class="line">      <span class="string">"Username"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"Email"</span>: null</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"IsDefault"</span>: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 重新打开 Sourcetree</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache 配置系列(一)</title>
    <url>/Apache/apache-configuration-1.html</url>
    <content><![CDATA[<div class="note danger"><p>启用 proxy_http 和 proxy_wstunnel</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#httpd.conf</span></span><br><span class="line">LoadModule proxy_module modules/mod_proxy.so</span><br><span class="line">LoadModule proxy_http_module modules/mod_proxy_http.so</span><br><span class="line">LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so</span><br><span class="line"><span class="comment"># 访问 http://127.0.0.1/ 转发至 http://127.0.0.1:8080</span></span><br><span class="line">ProxyPass / http://127.0.0.1:8080/</span><br><span class="line"><span class="comment"># websocket 连接地址为 ws://127.0.0.1/ws 转发至 8181 端口</span></span><br><span class="line">ProxyPass /ws ws://0.0.0.0:8181</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>Apache 版本：2.4.34<br>PHP 两个版本：5.6.37 和 7.2.8</p></div>
<h5 id="安装-mod-fcgid-模块"><a href="#安装-mod-fcgid-模块" class="headerlink" title="安装 mod_fcgid 模块"></a>安装 mod_fcgid 模块</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#官网 http://httpd.apache.org/download.cgi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#编译安装模块</span></span><br><span class="line">wget http://mirrors.hust.edu.cn/apache//httpd/mod_fcgid/mod_fcgid-2.3.9.tar.gz</span><br><span class="line">tar -zxvf mod_fcgid-2.3.9.tar.gz</span><br><span class="line"><span class="built_in">cd</span> mod_fcgid-2.3.9</span><br><span class="line">apxs=/web/server/httpd/bin/apxs ./configure.apxs</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#加载模块</span></span><br><span class="line">vi /web/server/httpd/conf/httpd.conf</span><br><span class="line">LoadModule fcgid_module modules/mod_fcgid.so</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="注释-apache-加载-PHP-模块的配置"><a href="#注释-apache-加载-PHP-模块的配置" class="headerlink" title="注释 apache 加载 PHP 模块的配置"></a>注释 apache 加载 PHP 模块的配置</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#LoadModule php7_module        modules/libphp7.so</span></span><br><span class="line"><span class="comment">#LoadModule php5_module        modules/libphp5.so</span></span><br><span class="line"><span class="comment">#&lt;FilesMatch "\.ph(p[2-6]?|tml)$"&gt;</span></span><br><span class="line"><span class="comment">#    SetHandler application/x-httpd-php</span></span><br><span class="line"><span class="comment">#&lt;/FilesMatch&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="使用-fcgid-加载-默认全局-PHP7-2-8-版本"><a href="#使用-fcgid-加载-默认全局-PHP7-2-8-版本" class="headerlink" title="使用 fcgid 加载 (默认全局 PHP7.2.8 版本)"></a>使用 fcgid 加载 (默认全局 PHP7.2.8 版本)</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /web/server/httpd/conf/httpd.conf</span><br><span class="line">&lt;IfModule fcgid_module&gt;</span><br><span class="line">    AddHandler fcgid-script .fcgi .php</span><br><span class="line">    AddType application/x-httpd-php .php</span><br><span class="line">    <span class="comment">#php.ini的存放目录</span></span><br><span class="line">    FcgidInitialEnv PHPRC <span class="string">"/web/server/php"</span></span><br><span class="line">    <span class="comment"># 设置PHP_FCGI_MAX_REQUESTS大于或等于FcgidMaxRequestsPerProcess, 防止php-cgi进程在处理完所有请求前退出</span></span><br><span class="line">    FcgidInitialEnv PHP_FCGI_MAX_REQUESTS 1000</span><br><span class="line">    <span class="comment">#php-cgi每个进程的最大请求数</span></span><br><span class="line">    FcgidMaxRequestsPerProcess 1000</span><br><span class="line">    <span class="comment">#php-cgi最大的进程数</span></span><br><span class="line">    FcgidMaxProcesses 5</span><br><span class="line">    <span class="comment">#最大执行时间</span></span><br><span class="line">    FcgidIOTimeout 120</span><br><span class="line">    FcgidIdleTimeout 120</span><br><span class="line">    <span class="comment">#php-cgi的路径</span></span><br><span class="line">    FcgidWrapper <span class="string">"/web/server/php/bin/php-cgi"</span> .php</span><br><span class="line">&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure>
<h5 id="配置虚拟主机"><a href="#配置虚拟主机" class="headerlink" title="配置虚拟主机"></a>配置虚拟主机</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Listen 9001</span><br><span class="line">&lt;VirtualHost *:9001&gt;</span><br><span class="line">    DocumentRoot <span class="string">"/web/www/symfony3.4/web"</span></span><br><span class="line">    &lt;Directory <span class="string">"/web/www/symfony3.4/web"</span>&gt;</span><br><span class="line">        Options Indexes FollowSymLinks</span><br><span class="line">        <span class="comment">#需要配置 Options +ExecCGI, 不然会报 403 Forbidden</span></span><br><span class="line">        Options +ExecCGI</span><br><span class="line">        AllowOverride all</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">    ErrorLog <span class="string">"/web/log/httpd/symfony3.4-error.log"</span></span><br><span class="line">    CustomLog <span class="string">"/web/log/httpd/symfony3.4.log"</span> common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">Listen 9002</span><br><span class="line">&lt;VirtualHost *:9002&gt;</span><br><span class="line">    DocumentRoot <span class="string">"/web/www/walle-web/web"</span></span><br><span class="line">    <span class="comment">#指定PHP版本及配置文件</span></span><br><span class="line">    FcgidInitialEnv PHPRC <span class="string">"/web/server/php5.6"</span></span><br><span class="line">    FcgidWrapper <span class="string">"/web/server/php5.6/bin/php-cgi"</span> .php</span><br><span class="line"></span><br><span class="line">    &lt;Directory <span class="string">"/web/www/walle-web/web"</span>&gt;</span><br><span class="line">        Options Indexes FollowSymLinks</span><br><span class="line">        Options +ExecCGI</span><br><span class="line">        AllowOverride all</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">    ErrorLog <span class="string">"/web/log/httpd/walle-web-error.log"</span></span><br><span class="line">    CustomLog <span class="string">"/web/log/httpd/walle-web.log"</span> common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><ul>
<li>提示 <code>No input file specified.</code>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#修改项目的 .htaccess</span></span><br><span class="line">RewriteRule ^(.*)$ index.php/<span class="variable">$1</span> [QSA,PT,L] </span><br><span class="line"><span class="comment">#修改为 </span></span><br><span class="line">RewriteRule ^(.*)$ index.php [L,E=PATH_INFO:<span class="variable">$1</span>]</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Apache</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>apache</tag>
      </tags>
  </entry>
  <entry>
    <title>GitLab 与 Walle 部署</title>
    <url>/Other/gitlab-and-walle.html</url>
    <content><![CDATA[<table>
<thead>
<tr>
<th>系统</th>
<th>PHP版本</th>
<th>宿主机(A)</th>
<th>目标主机(B)</th>
<th>GitLab安装目录</th>
<th>Walle安装目录</th>
</tr>
</thead>
<tbody>
<tr>
<td>Centos7</td>
<td>5.6.37</td>
<td>192.168.1.20</td>
<td>192.168.7.20:8888</td>
<td>/opt/gitlab</td>
<td>/web/www/walle-web</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>宿主机PHP进程用户</th>
<th>宿主机代码检出目录</th>
<th>目标主机SSH账号</th>
<th>目标主机SSH密码</th>
<th>目标主机代码的最终部署目录</th>
<th>目标主机代码的发布版本库</th>
</tr>
</thead>
<tbody>
<tr>
<td>www</td>
<td>/web/data/walle/symfony</td>
<td>sevming</td>
<td>123456789</td>
<td>/web/www/symfony</td>
<td>/web/www/symfony/releases</td>
</tr>
</tbody>
</table>
<p><code>ps：这里是LAMP环境, 所以PHP进程用户即Apache配置文件里指定的用户,建议目标主机SSH账号与目标主机PHP进程用户是同一个账号</code></p>
<a id="more"></a>
<h5 id="GitLab-安装"><a href="#GitLab-安装" class="headerlink" title="GitLab 安装"></a>GitLab 安装</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 安装依赖组件</span></span><br><span class="line">yum install -y curl policycoreutils-python openssh-server postfix</span><br><span class="line">systemctl <span class="built_in">enable</span> sshd</span><br><span class="line">systemctl start sshd</span><br><span class="line">systemctl <span class="built_in">enable</span> postfix</span><br><span class="line">systemctl start postfix</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 开启设置防火墙</span></span><br><span class="line">firewall-cmd --permanent --add-service=http</span><br><span class="line">systemctl reload firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 获取GitLab的rpm包(通过清华开源镜像站下载rpm包)</span></span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-11.1.4-ce.0.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 安装rpm包</span></span><br><span class="line">rpm -ivh gitlab-ce-11.1.4-ce.0.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment">#5. 修改gitlab配置文件指定服务器ip和自定义端口[预留8000端口]</span></span><br><span class="line">vi /etc/gitlab/gitlab.rb</span><br><span class="line">external_url <span class="string">'http://192.168.1.20:7777'</span>      <span class="comment">#访问地址</span></span><br><span class="line">firewall-cmd --add-port=7777/tcp --permanent <span class="comment">#防火墙添加开放端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#6. 重新配置并启动GitLab</span></span><br><span class="line">gitlab-ctl reconfigure</span><br><span class="line">gitlab-ctl restart</span><br><span class="line"></span><br><span class="line"><span class="comment">#7. 访问192.168.1.20, 默认账号为 root</span></span><br></pre></td></tr></table></figure>
<h5 id="GitLab-卸载"><a href="#GitLab-卸载" class="headerlink" title="GitLab 卸载"></a>GitLab 卸载</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#停止GitLab</span></span><br><span class="line">gitlab-ctl stop</span><br><span class="line"><span class="comment">#卸载GitLab</span></span><br><span class="line">rpm -e gitlab-ce</span><br><span class="line"><span class="comment">#查看GitLab进程</span></span><br><span class="line">ps aux | grep gitlab</span><br><span class="line"><span class="comment">#杀掉第一个进程(有很多.............的进程)</span></span><br><span class="line"><span class="built_in">kill</span> -9 1111</span><br><span class="line"><span class="comment">#删除所有包含GitLab文件</span></span><br><span class="line">find / -name gitlab|xargs rm -rf</span><br></pre></td></tr></table></figure>
<h5 id="GitLab-常见问题"><a href="#GitLab-常见问题" class="headerlink" title="GitLab 常见问题"></a>GitLab 常见问题</h5><ol>
<li><p><code>502 Whoops, GitLab is taking too much time to respond</code> </p>
<ul>
<li>内存过小, 需要4G内存</li>
<li>8080 端口被占用</li>
</ul>
</li>
<li><p><code>gitlab-ctl reconfigure</code> 卡在 <code>ruby_block[supervise_redis_sleep] action run</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl restart gitlab-runsvdir</span><br><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>
</li>
<li><p>重置用户密码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 切换目录</span></span><br><span class="line"><span class="built_in">cd</span> /opt/gitlab/bin</span><br><span class="line"><span class="comment">#2. 进入管理后台</span></span><br><span class="line">gitlab-rails console production</span><br><span class="line"><span class="comment">#3. 通过 user=User.where(id:1).first 来查找与切换账号 (User.all 查看所有用户)</span></span><br><span class="line">user=User.where(id:1)</span><br><span class="line"><span class="comment">#4. 重置密码</span></span><br><span class="line">user.password=12345678</span><br><span class="line"><span class="comment">#5. 确认密码</span></span><br><span class="line">user.password_confirmation=12345678</span><br><span class="line"><span class="comment">#6. 保存新密码</span></span><br><span class="line">user.save</span><br><span class="line"><span class="comment">#7. 退出</span></span><br><span class="line">quit</span><br></pre></td></tr></table></figure>
</li>
<li><p>移除 GitLab 中的IP黑名单</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 获取哪里记录的IP黑名单(三个中总会找到gitlab连接的redis所用的socket文件)</span></span><br><span class="line">grep <span class="string">"Rack_Attack"</span> /var/<span class="built_in">log</span>/gitlab/gitlab-rails/auth.log</span><br><span class="line">grep <span class="string">"Rack_Attack"</span> /var/<span class="built_in">log</span>/gitlab/gitlab-rails/production.log</span><br><span class="line">grep unixsocket /var/opt/gitlab/redis/redis.conf</span><br><span class="line"><span class="comment">#2. 利用 redis-cli 连接</span></span><br><span class="line">redis-cli -s /var/opt/gitlab/redis/redis.socket</span><br><span class="line"><span class="comment">#3. 查看哪些被列表黑名单</span></span><br><span class="line">redis /var/opt/gitlab/redis/redis.socket&gt;keys *attack*</span><br><span class="line"><span class="string">"cache:gitlab:rack::attack:allow2ban:ban:192.168.0.143"</span></span><br><span class="line"><span class="comment">#4. 删除黑名单中的IP</span></span><br><span class="line">del cache:gitlab:rack::attack:allow2ban:ban:192.168.0.143</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="Walle-安装"><a href="#Walle-安装" class="headerlink" title="Walle 安装"></a>Walle 安装</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 代码检出</span></span><br><span class="line">mkdir -p /web/www &amp;&amp; <span class="built_in">cd</span> /web/www</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/meolu/walle-web.git</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 设置mysql连接</span></span><br><span class="line">vi config/local.php</span><br><span class="line"><span class="string">'db'</span> =&gt; [</span><br><span class="line">    <span class="string">'dsn'</span>       =&gt; <span class="string">'mysql:host=127.0.0.1;dbname=walle'</span>, <span class="comment"># 新建数据库walle</span></span><br><span class="line">    <span class="string">'username'</span>  =&gt; <span class="string">'root'</span>,                              <span class="comment"># 连接的用户名</span></span><br><span class="line">    <span class="string">'password'</span>  =&gt; <span class="string">'root'</span>,                              <span class="comment"># 连接的密码</span></span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 安装vendor, 若是安装太慢, 去此地址下载 https://pan.baidu.com/s/1kU6gdZD</span></span><br><span class="line">composer install</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 初始化项目</span></span><br><span class="line">./yii walle/setup</span><br><span class="line"></span><br><span class="line"><span class="comment">#5. 配置 apache vhosts, /web/server/httpd/conf/extra/httpd-vhosts.conf</span></span><br><span class="line">Listen 9002</span><br><span class="line">&lt;VirtualHost *:9002&gt;</span><br><span class="line">    DocumentRoot <span class="string">"/web/www/walle-web/web"</span></span><br><span class="line">    &lt;Directory <span class="string">"/web/www/walle-web/web"</span>&gt;</span><br><span class="line">        Options Indexes FollowSymLinks</span><br><span class="line">        AllowOverride all</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#6. 添加开放端口</span></span><br><span class="line">firewall-cmd --add-port=9002/tcp --permanent <span class="comment">#防火墙开放端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#7. 访问 192.168.1.20:9002, 默认账号：admin, 密码：admin</span></span><br></pre></td></tr></table></figure>
<h5 id="Walle-项目检测问题"><a href="#Walle-项目检测问题" class="headerlink" title="Walle 项目检测问题"></a>Walle 项目检测问题</h5><ol>
<li><p>宿主机代码检出检测出错, 请确认php进程用户有代码存储仓库 <code>/web/data/walle/symfony</code> 读写权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#宿主机执行以下命令</span></span><br><span class="line">mkdir -p/web/data/walle</span><br><span class="line">chown -R www:www /web/data/walle</span><br></pre></td></tr></table></figure>
</li>
<li><p>宿主机代码检出检测出错, 请确认把php进程用户的ssh-key加入git的deploy-keys列表</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#宿主机执行以下命令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1. GitLab的项目记得设置为 public </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 切换为www用户</span></span><br><span class="line">su www</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 生成rsa key</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 查看公钥并复制</span></span><br><span class="line">cat ~/.ssh/id_rsa.pub</span><br><span class="line"></span><br><span class="line"><span class="comment">#5. 将公钥添加至GitLab -&gt; Settings -&gt; SSH Keys</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#若以上命令执行后仍然报此错误, 那应该是项目配置的 git 地址是 ssh 格式, 且宿主机内未 git clone 过项目代码, 运行命令</span></span><br><span class="line">su www</span><br><span class="line">git <span class="built_in">clone</span> git@192.168.1.20:symfony/symfony.git</span><br><span class="line"><span class="comment">#输入 yes 后回车</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>目标机器检测出错, 请确认php进程用户ssh-key加入目标机器的ming用户ssh-key信任列表(项目配置里的目标机器IP列表记得带端口)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#宿主机执行以下命令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 切换为www用户</span></span><br><span class="line">su www</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 加入目标机群信任</span></span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub -p 8888 sevming@192.168.7.20</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 目标机器需满足以下三个条件</span></span><br><span class="line">/home/sevming 755</span><br><span class="line">~/.ssh 700</span><br><span class="line">~/.ssh/authorized_keys 644 或 600</span><br></pre></td></tr></table></figure>
</li>
<li><p>目标机器检测出错, 请确认ming有目标机器发布版本库/web/www/symfony写入权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#目标主机执行以下命令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 创建目录</span></span><br><span class="line">mkdir /web/www/symfony</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 修改目录的所有者与组</span></span><br><span class="line">chown -R sevming:sevming /web/www/symfony</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h5 id="Walle2-0-部署"><a href="#Walle2-0-部署" class="headerlink" title="Walle2.0 部署"></a>Walle2.0 部署</h5><ol>
<li><p>代码检出</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /web/www &amp;&amp; <span class="built_in">cd</span> /web/www </span><br><span class="line">git <span class="built_in">clone</span> https://github.com/meolu/walle-web.git</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置虚拟主机</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">upstream webservers &#123;</span><br><span class="line">    server 0.0.0.0:5000 weight=1; <span class="comment"># 负载设置</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       8888;</span><br><span class="line">    <span class="comment">#server_name  admin.walle-web.io; # 域名设置</span></span><br><span class="line">    access_log /web/www/logs/walle_access_nginx.log combined;</span><br><span class="line">    error_log /web/www/logs/walle_error_nginx.log crit;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">        add_header access-control-allow-origin *;</span><br><span class="line">        root /web/www/walle-web/fe;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ^~ /api/ &#123;</span><br><span class="line">        add_header access-control-allow-origin *;</span><br><span class="line">        proxy_pass      http://webservers;</span><br><span class="line">        proxy_set_header X-Forwarded-Host <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">        proxy_set_header  X-Real-IP  <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header    Origin        <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">        proxy_set_header    Referer       <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ^~ /socket.io/ &#123;</span><br><span class="line">        add_header access-control-allow-origin *;</span><br><span class="line">        proxy_pass      http://webservers;</span><br><span class="line">        proxy_set_header X-Forwarded-Host <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">        proxy_set_header  X-Real-IP  <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header    Origin        <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">        proxy_set_header    Referer       <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">        proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">        proxy_set_header X-NginX-Proxy <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># WebScoket Support</span></span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        proxy_set_header Connection <span class="string">"upgrade"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Python 2.7 + pip</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sh admin.sh init</span><br></pre></td></tr></table></figure>
</li>
<li><p>Config setting</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi walle/config/settings_prod.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务启动 @TODO</span></span><br><span class="line"><span class="comment"># HOST 修改为与 nginx server_name 一致.</span></span><br><span class="line">HOST = <span class="string">'localhost'</span></span><br><span class="line">PORT = 5000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库设置</span></span><br><span class="line">SQLALCHEMY_DATABASE_URI = <span class="string">'mysql://root:root@localhost:3306/walle?charset=utf8'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>mysql 创建数据库 walle </p>
</li>
<li><p>Data Migration</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sh admin.sh migration</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sh admin.sh start</span><br></pre></td></tr></table></figure>
</li>
<li><p>开放端口</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#添加开放端口(--permanent 表示永久生效)</span></span><br><span class="line">firewall-cmd --add-port=8888/tcp --permanent</span><br><span class="line"><span class="comment">#重启服务</span></span><br><span class="line">systemctl restart firewalld</span><br></pre></td></tr></table></figure>
</li>
<li><p>super - 创建空间, owner - 创建项目及部署上线</p>
</li>
<li><p>项目配置模板</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 目标集群部署路径 </span></span><br><span class="line">/web/www/symfony</span><br><span class="line"><span class="comment">#2. 目标集群部署仓库 </span></span><br><span class="line">/web/www/symfony/releases</span><br><span class="line"><span class="comment">#3. 高级任务-Release前置任务</span></span><br><span class="line">/bin/systemctl stop httpd</span><br><span class="line"><span class="comment">#4. 高级任务-Release后置任务</span></span><br><span class="line">cp /web/www/symfony/releases/.env /web/www/symfony/</span><br><span class="line">chown -R www:www /web/www/symfony</span><br><span class="line"><span class="comment">#修改软链指向的源文件所属组和所属用户</span></span><br><span class="line">chown -H -R www:www /web/www/symfony</span><br><span class="line">/bin/systemctl start httpd</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务器配置使用 root 用户</p>
</li>
<li><p>宿主机配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. 生成rsa key</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 查看公钥并复制</span></span><br><span class="line">cat ~/.ssh/id_rsa.pub</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 将公钥添加至GitLab -&gt; Settings -&gt; SSH Keys</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#若以上命令执行后仍然报此错误, 那应该是项目配置的 git 地址是 ssh 格式, 且宿主机内未 git clone 过项目代码, 运行命令</span></span><br><span class="line">git <span class="built_in">clone</span> git@192.168.1.20:symfony/symfony.git</span><br><span class="line"><span class="comment">#输入 yes 后回车</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 加入目标机群信任</span></span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub -p 8888 sevming@192.168.7.20</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>Other</category>
      </categories>
      <tags>
        <tag>gitlab</tag>
        <tag>walle</tag>
        <tag>deploy</tag>
      </tags>
  </entry>
  <entry>
    <title>搭建LAMP环境</title>
    <url>/PHP/build-lamp.html</url>
    <content><![CDATA[<div class="note danger"><p>环境：Centos7<br>/www/package/apache Apache 相关安装包目录<br>/www/package/mysql  MySQL 相关安装包目录<br>/www/package/php    PHP 相关安装包目录<br>/www/server         环境安装目录</p></div>
<h5 id="预先安装以下组件"><a href="#预先安装以下组件" class="headerlink" title="预先安装以下组件"></a>预先安装以下组件</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install gcc-c++</span><br><span class="line">yum install openssl openssl-devel</span><br><span class="line">yum install perl perl-devel</span><br><span class="line">yum install libxml2 libxml2-devel </span><br><span class="line">yum install curl curl-devel</span><br><span class="line">yum install autoconf</span><br></pre></td></tr></table></figure>
<h5 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h5><blockquote><p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#下载相关包至Apache安装包目录</span></span><br><span class="line"><span class="built_in">cd</span> /www/package/apache</span><br><span class="line">wget http://mirrors.hust.edu.cn/apache/httpd/httpd-2.4.25.tar.gz</span><br><span class="line">wget http://mirrors.hust.edu.cn/apache/apr/apr-1.5.2.tar.gz</span><br><span class="line">wget http://mirrors.hust.edu.cn/apache/apr/apr-util-1.5.4.tar.gz</span><br><span class="line">wget https://sourceforge.net/projects/pcre/files/pcre/8.40/pcre-8.40.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#install apr</span></span><br><span class="line">tar -zxvf apr-1.5.2.tar.gz  </span><br><span class="line"><span class="built_in">cd</span> apr-1.5.2</span><br><span class="line">./configure --prefix=/www/server/apr</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#install apr-util</span></span><br><span class="line">tar -zxvf apr-util-1.5.4.tar-gz</span><br><span class="line"><span class="built_in">cd</span> apr-util-1.5.4</span><br><span class="line">./configure --prefix=/www/server/apr-util -with-apr=/www/server/apr/bin/apr-1-config</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#install pcre</span></span><br><span class="line">tar -zxvf pcre-8.40.tar.gz</span><br><span class="line"><span class="built_in">cd</span> pcre-8.40</span><br><span class="line">./configure --prefix=/www/server/pcre</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#install httpd</span></span><br><span class="line">tar -zxvf httpd-2.4.25.tar.gz</span><br><span class="line"><span class="built_in">cd</span> httpd-2.4.25</span><br><span class="line">./configure --prefix=/www/server/httpd --with-apr=/www/server/apr --with-apr-util=/www/server/apr-util --with-pcre=/www/server/pcre --<span class="built_in">enable</span>-module=so --<span class="built_in">enable</span>-mods-shared=all --with-ssl=/usr/bin/openssl --<span class="built_in">enable</span>-ssl</span><br><span class="line">make</span><br><span class="line">mak install</span><br><span class="line"><span class="comment">#PS：--enable-module=so 开启模块, --enable-mods-shared=all启用所有支持的动态加载模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果提示 make[2]: *** [htpasswd] Error 1 错误, 则 ./configure 加上 --with-included-apr, 并将 apr 与 apr-util 的解压包复制到 srclib 目录下</span></span><br><span class="line">cp -r /www/package/apache/apr-1.6.3 /www/package/apache/httpd-2.4.34/srclib/apr</span><br><span class="line">cp -r /www/package/apache/apr-util-1.6.1 /www/package/apache/httpd-2.4.34/srclib/apr-util</span><br></pre></td></tr></table></figure>
<p>  <img src="/uploads/php/build-lamp/mPK4PxZ94drgeYv4KIDhvA3ZJdhthjSK.png" style="display:inline-block"></p>
<a id="more"></a>
<blockquote><p>配置</p>
</blockquote>
<ol>
<li>配置 httpd.conf, 去掉 ServerName www.example.com:80  前面的 # 号</li>
<li><p>启动apache</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/www/server/httpd/bin/apachetcl start</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问 ip, 如果出现It Works 说明安装成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#如果访问失败,可能是防火墙没开放80端口</span></span><br><span class="line">firewall-cmd --add-port=80/tcp --permanent</span><br><span class="line">systemctl restart firewalld</span><br></pre></td></tr></table></figure>
</li>
<li><p>给 apache 服务分配用户和组</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#建立一个apache的组</span></span><br><span class="line">groupadd apache </span><br><span class="line"><span class="comment">#建立apache用户, 并把用户放到apache组</span></span><br><span class="line">useradd -r -g apache apache </span><br><span class="line"><span class="comment">#给apache用户设置一个密码</span></span><br><span class="line">passwd apache</span><br><span class="line"><span class="comment">#配置 httpd.conf, 将 User 和 Group 改成刚刚创建的用户与用户组</span></span><br><span class="line">User apache</span><br><span class="line">Group apache</span><br></pre></td></tr></table></figure>
</li>
<li><p>给目录/www/server/httpd 更改拥有者</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chown -R apache:apache /www/server/httpd</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加httpd服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /www/server/httpd</span><br><span class="line">cp bin/apachectl /etc/init.d/httpd</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service httpd start</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果 session 保存不了, 或者 报 session_start():open failed:Permission denied(), 原因是：session 默认是保存在 /tmp 目录下, 但是修改 apache 的 User 和 Group 之后, 没有 /tmp 的操作权限, 只需要新建一个目录, 并更改拥有者为apache即可</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#编辑 php.ini</span></span><br><span class="line">vi php.ini</span><br><span class="line"><span class="comment">#修改 session.save_path</span></span><br><span class="line">session.save_path = “/www/session”</span><br><span class="line"></span><br><span class="line"><span class="comment">#在/www 目录下新建 session 目录</span></span><br><span class="line">mkdir /www/session</span><br><span class="line"><span class="comment">#修改文件夹拥有者和所属组</span></span><br><span class="line">chown -R apache:apache /www/session</span><br><span class="line"><span class="comment">#启动 apache</span></span><br><span class="line">service httpd restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>Apache 虚拟主机配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#httpd.conf</span></span><br><span class="line"><span class="comment">#DocumentRoot 和 Directory 改成 站点根目录, AllowOverride None 改成 AllowOverride All, Require all denied改成Require all granted</span></span><br><span class="line">DocumentRoot <span class="string">"/www/web"</span></span><br><span class="line">&lt;Directory <span class="string">"/www/web"</span>&gt;</span><br><span class="line">    ...</span><br><span class="line">    AllowOverride All</span><br><span class="line">    ...</span><br><span class="line">    Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去掉 httpd-vhosts.conf 前的 # 号</span></span><br><span class="line">Include conf/extra/httpd-vhosts.conf</span><br><span class="line"><span class="comment">#开启 mod_rewrite 模块</span></span><br><span class="line">LoadModule rewrite_module modules/mod_rewrite.so</span><br><span class="line"></span><br><span class="line"><span class="comment">#extra/httd-vhosts.conf</span></span><br><span class="line"><span class="comment">#配置虚拟站点 - 域名 www.test.com</span></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">	DocumentRoot /www/web/<span class="built_in">test</span></span><br><span class="line">	ServerName www.test.com</span><br><span class="line">	ServerAlias test1.com test2.com</span><br><span class="line">	&lt;Directory <span class="string">"/www/web/test"</span>&gt;</span><br><span class="line">	    Options Indexes FollowSymLinks</span><br><span class="line">	    AllowOverride all</span><br><span class="line">	    Require all granted</span><br><span class="line">	&lt;/Directory&gt;</span><br><span class="line">	ErrorLog <span class="string">"/www/logs/httpd/test-error.log"</span></span><br><span class="line">	CustomLog <span class="string">"/www/logs/httpd/test.log"</span> common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"><span class="comment">#监听不同端口</span></span><br><span class="line">Listen 8080</span><br><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">	DocumentRoot /www/web/<span class="built_in">test</span></span><br><span class="line">	ServerName localhost</span><br><span class="line">	&lt;Directory <span class="string">"/www/web/test"</span>&gt;</span><br><span class="line">	    Options Indexes FollowSymLinks</span><br><span class="line">	    AllowOverride all</span><br><span class="line">	    Require all granted</span><br><span class="line">	&lt;/Directory&gt;</span><br><span class="line">	ErrorLog <span class="string">"/www/log/httpd/test-error.log"</span></span><br><span class="line">	CustomLog <span class="string">"/www/log/httpd/test.log"</span> common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"><span class="comment">#配置403, 禁止ip访问, 只能域名访问, 将此配置放在第一个</span></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">	DocumentRoot /www/web/403</span><br><span class="line">	&lt;Directory <span class="string">"/www/web/test"</span>&gt;</span><br><span class="line">	    AllowOverride None</span><br><span class="line">	    Require all denied</span><br><span class="line">	&lt;/Directory&gt;</span><br><span class="line">	ErrorLog <span class="string">"/www/log/httpd/403-error.log"</span></span><br><span class="line">	CustomLog <span class="string">"/www/log/httpd/403.log"</span> common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h5><blockquote><p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /www/package/php</span><br><span class="line">wget http://cn2.php.net/distributions/php-7.1.4.tar.gz</span><br><span class="line">tar -zxvf php-7.1.4.tar.gz</span><br><span class="line"><span class="built_in">cd</span> php-7.1.4</span><br><span class="line">./configure --prefix=/www/server/php --with-apxs2=/www/server/httpd/bin/apxs --with-config-file-path=/www/server/php</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#提示 Sorry, I cannot run apxs, 查找 perl 安装目录, 一般在 /usr/bin/perl</span></span><br><span class="line"><span class="built_in">which</span> perl </span><br><span class="line"><span class="comment">#修改 /www/server/httpd/bin/apxs 第一行, 将 #!/replace/with/path/to/perl/interpreter -w 修改为</span></span><br><span class="line"><span class="comment">#!/usr/bin/perl -w</span></span><br></pre></td></tr></table></figure>
<blockquote><p>配置</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /www/package/php/php-7.1.4</span><br><span class="line">cp php.ini-production /www/server/php/lib/php.ini</span><br><span class="line"></span><br><span class="line"><span class="comment">#httpd.conf</span></span><br><span class="line"><span class="comment">#搜索php7, 如果没有找到, 则需要添加指令</span></span><br><span class="line">LoadModule php7_module modules/libphp7.so</span><br><span class="line"><span class="comment">#搜索 DirectoryIndex 字符串, 添加 index.php index.phtml</span></span><br><span class="line">DirectoryIndex index.php index.phtml index.html index.htm</span><br><span class="line"><span class="comment">#添加一段指令</span></span><br><span class="line">&lt;FilesMatch <span class="string">"\.ph(p[2-6]?|tml)$"</span>&gt;</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line"><span class="comment">#这段指令告诉 apache, 碰到文件名以.php,.php2,.php3,.php4,.php5,.php6 或 phtml 结尾的文件使用libphp7.so模块进行解析, 其中 "\.ph(p[2-6]?|tml)$" 为正则表达式, 可以随意更改, 只要符合PCRE 正则表达式语法就行</span></span><br><span class="line"><span class="comment">#重启 apache  </span></span><br><span class="line">service httpd restart</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建test.php文件, 内容为 phpinfo(), 访问 test.php 文件</span></span><br></pre></td></tr></table></figure>
<h5 id="MYSQL"><a href="#MYSQL" class="headerlink" title="MYSQL"></a>MYSQL</h5><blockquote><p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /www/package/mysql</span><br><span class="line">wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.18-linux-glibc2.5-x86_64.tar.gz</span><br><span class="line">tar -zxvf mysql-5.7.18-linux-glibc2.5-x86_64.tar.gz</span><br><span class="line">mv mysql-5.7.18-linux-glibc2.5-x86_64/* /www/server/mysql</span><br><span class="line"><span class="built_in">cd</span> /www/server/mysql</span><br><span class="line">mkdir data</span><br></pre></td></tr></table></figure>
<blockquote><p>配置</p>
</blockquote>
<ol>
<li><p>配置 my.cnf</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#/etc/my.cnf</span></span><br><span class="line">vi /etc/my.cnf</span><br><span class="line">[client]</span><br><span class="line">port=3306</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">port=3306</span><br><span class="line">user=mysql</span><br><span class="line">character_set_server=utf8</span><br><span class="line">default-storage-engine=INNODB</span><br><span class="line">log_timestamps = SYSTEM</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">basedir=/www/server/mysql</span><br><span class="line">datadir=/www/server/mysql/data</span><br><span class="line">pid-file=/www/server/mysql/data/mysql.pid</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span>-error=/www/logs/mysql/mysql-error.log</span><br><span class="line"><span class="comment">#log_output=table</span></span><br><span class="line">general_log=on</span><br><span class="line">general_log_file=/www/logs/mysql/general.log</span><br><span class="line"><span class="built_in">log</span>-raw=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES</span><br></pre></td></tr></table></figure>
</li>
<li><p>给 mysql 服务分配用户和组</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#建立一个mysql的组</span></span><br><span class="line">groupadd mysql</span><br><span class="line"><span class="comment">#建立mysql用户,并把用户放到mysql组</span></span><br><span class="line">useradd -r -g mysql mysql </span><br><span class="line"><span class="comment">#给mysql用户设置一个密码</span></span><br><span class="line">passwd mysql</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改目录/www/server/mysql 拥有者</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chown -R mysql:mysql /www/server/mysql</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成日志目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /www/logs/mysql</span><br><span class="line">chown -R mysql:mysql /www/logs/mysql</span><br><span class="line">touch /www/logs/mysql/mysql-error.log </span><br><span class="line">touch /www/logs/mysql/general.log</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /www/server/mysql</span><br><span class="line">bin/mysqld --initialize --user=mysql --basedir=/www/server/mysql --datadir=/www/server/mysql/data</span><br><span class="line"><span class="comment">#数据库加密,可不加密</span></span><br><span class="line">bin/mysql_ssl_rsa_setup --datadir=/www/server/mysql/data</span><br><span class="line"><span class="comment">#修改目录 /www/server/mysql/data 拥有者,因为数据库加密后生成的文件拥有者并不是mysql</span></span><br><span class="line">chown -R mysql:mysql /www/server/mysql/data</span><br><span class="line"><span class="comment">#查看mysql密码, 因为设置了log_error, 所以初始化后的密码会保存到 mysql-error.log日志里</span></span><br><span class="line">cat /www/logs/mysql/mysql-error.log</span><br></pre></td></tr></table></figure>
</li>
<li><p>注册服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /www/server/mysql</span><br><span class="line">cp support-files/mysql.server /etc/init.d/mysql</span><br><span class="line"><span class="comment">#因为mysql不是安装在/usr/local/mysql 目录下,所以这里需要修改/etc/init.d/mysql 文件</span></span><br><span class="line">vi /etc/init.d/mysql</span><br><span class="line"><span class="comment">#找到basedir 和 datadir</span></span><br><span class="line">basedir=/www/server/mysql</span><br><span class="line">datadir=/www/server/mysql/data</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service mysqld start</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入 mysql 命令行窗口</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /www/server/mysql</span><br><span class="line">bin/mysql -u root -p</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 mysql 密码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> password = password(<span class="string">'root'</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果需要重新初始化mysql, 则把 mysql/data目录删除即可</p>
</li>
<li>查看ssl加密是否开启<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#have_ssl 为 yes 代表已开启,这里只是开启了SSL加密,如果要使用SSL账号,另找资料</span></span><br><span class="line">show variables like <span class="string">'have_ssl'</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="添加-Apache-PHP-MySQL-环境变量"><a href="#添加-Apache-PHP-MySQL-环境变量" class="headerlink" title="添加 Apache PHP MySQL 环境变量"></a>添加 Apache PHP MySQL 环境变量</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"><span class="comment">#在最下面添加</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/www/server/httpd/bin:/www/server/php/bin:/www/server/mysql/bin</span><br><span class="line"><span class="comment">#保存后运行以下命令,立即生效</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>
<h5 id="设置-Apache-MySQL-开机启动"><a href="#设置-Apache-MySQL-开机启动" class="headerlink" title="设置 Apache MySQL 开机启动"></a>设置 Apache MySQL 开机启动</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/rc.d/rc.local</span><br><span class="line"><span class="comment">#在最下面添加</span></span><br><span class="line">/etc/init.d/httpd start</span><br><span class="line">/etc/init.d/mysql start</span><br></pre></td></tr></table></figure>
<h5 id="禁止-mysql-和-apache-用户登录"><a href="#禁止-mysql-和-apache-用户登录" class="headerlink" title="禁止 mysql 和 apache 用户登录"></a>禁止 mysql 和 apache 用户登录</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#mysq与apache 都添加了用户组和用户,平时不需要登录</span></span><br><span class="line"><span class="comment">#禁止登录</span></span><br><span class="line">usermod -L apache</span><br><span class="line">usermod -L mysql</span><br><span class="line"><span class="comment">#解除禁用</span></span><br><span class="line">usermod -U 用户名</span><br></pre></td></tr></table></figure>
<h5 id="PHP-扩展安装"><a href="#PHP-扩展安装" class="headerlink" title="PHP 扩展安装"></a>PHP 扩展安装</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#pdo扩展</span></span><br><span class="line"><span class="built_in">cd</span> /www/package/php-7.1.4/ext/pdo</span><br><span class="line">phpize</span><br><span class="line">./configure --with-php-config=/www/server/php/bin/php-config --<span class="built_in">enable</span>-pdo=shared</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="built_in">cd</span> /www/package/php-7.1.4/ext/pdo_mysql</span><br><span class="line">./configure --with-php-config=/www/server/php/bin/php-config --with-pdo-mysql=/www/server/mysql</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="comment">#添加扩展</span></span><br><span class="line">vi /www/server/php/lib/php.ini</span><br><span class="line">extension=pdo.so</span><br><span class="line">extension=pdo_mysql.so</span><br><span class="line"></span><br><span class="line"><span class="comment">#mb_string</span></span><br><span class="line"><span class="built_in">cd</span> /www/package/php-7.1.4/ext/mbstring</span><br><span class="line">phpize</span><br><span class="line">./configure --with-php-config=/www/server/php/bin/php-config</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="comment">#添加扩展</span></span><br><span class="line">vi /www/server/php/lib/php.ini</span><br><span class="line">extension=mbstring.so</span><br><span class="line"></span><br><span class="line"><span class="comment">#gd2</span></span><br><span class="line">yum install -y libvpx libvpx-devel</span><br><span class="line">yum install -y libjpeg-turbo libjpeg-turbo-devel</span><br><span class="line">yum install -y libpng libpng-devel</span><br><span class="line">yum install -y freetype freetype-devel</span><br><span class="line"><span class="built_in">cd</span> /www/package/php-7.1.4/ext/gd</span><br><span class="line">phpize</span><br><span class="line">./configure --with-php-config=/www/server/php/bin/php-config --with-vpx-dir=/usr/<span class="built_in">local</span>/ --with-jpeg-dir=/usr/<span class="built_in">local</span>/  --with-png-dir=/usr/<span class="built_in">local</span>/ --with-freetype-dir=/usr/<span class="built_in">local</span></span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="comment">#添加扩展</span></span><br><span class="line">vi /www/server/php/lib/php.ini</span><br><span class="line">extension=gd.so</span><br><span class="line"></span><br><span class="line"><span class="comment">#openssl</span></span><br><span class="line"><span class="built_in">cd</span> /www/package/php-7.1.4/ext/openssl</span><br><span class="line">phpize</span><br><span class="line">./configure --with-php-config=/www/server/php/bin/php-config --with-openssl</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="comment">#添加扩展</span></span><br><span class="line">vi /www/server/php/lib/php.ini</span><br><span class="line">extension=openssl.so</span><br><span class="line"><span class="comment">#提示 `Cannot find config.m4`, 将当前目录下的 config0.m4 重命名为 config.m4</span></span><br><span class="line">mv config0.m4 config.m4</span><br><span class="line"></span><br><span class="line"><span class="comment">#curl</span></span><br><span class="line"><span class="built_in">cd</span> /www/package/php-7.1.4/ext/curl</span><br><span class="line">phpize</span><br><span class="line">./configure --with-php-config=/www/server/php/bin/php-config --with-curl</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="comment">#添加扩展</span></span><br><span class="line">vi /www/server/php/lib/php.ini</span><br><span class="line">extension=curl.so</span><br><span class="line"><span class="comment">#提示 make: *** No targets specified and no makefile found.  Stop.</span></span><br><span class="line">wget http://ftp.gnu.org/pub/gnu/ncurses/ncurses-5.6.tar.gz</span><br><span class="line">tar zxvf ncurses-5.6.tar.gz</span><br><span class="line"><span class="built_in">cd</span> ncurses-5.6</span><br><span class="line">./configure -prefix=/usr/<span class="built_in">local</span> -with-shared -without-debug</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#sockets</span></span><br><span class="line"><span class="built_in">cd</span> /www/package/php-7.1.4/ext/sockets</span><br><span class="line">phpize</span><br><span class="line">./configure --with-php-config=/www/server/php/bin/php-config --<span class="built_in">enable</span>-sockets</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="comment">#添加扩展</span></span><br><span class="line">vi /www/server/php/lib/php.ini</span><br><span class="line">extension=sockets.so</span><br><span class="line"></span><br><span class="line"><span class="comment">#mysqli</span></span><br><span class="line"><span class="built_in">cd</span> /www/package/php-7.1.4/ext/mysqli</span><br><span class="line">phpize</span><br><span class="line">./configure --with-php-config=/www/server/php/bin/php-config --with-mysqli=/www/server/mysql/bin/mysql_config</span><br><span class="line">make</span><br><span class="line"><span class="comment">#如果 make 时报：make: *** [mysqli_api.lo] Error 1, 运行以下命令</span></span><br><span class="line">mkdir -p ext/mysqlnd</span><br><span class="line">cp ../mysqlnd/mysql_float_to_double.h ext/mysqlnd/</span><br><span class="line">make install</span><br><span class="line"><span class="comment">#添加扩展</span></span><br><span class="line">vi /www/server/php/lib/php.ini</span><br><span class="line">extension=mysqli.so</span><br></pre></td></tr></table></figure>
<h5 id="Apache-模块安装"><a href="#Apache-模块安装" class="headerlink" title="Apache 模块安装"></a>Apache 模块安装</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#加载 mod_deflate模块</span></span><br><span class="line"><span class="built_in">cd</span> /www/package/apache/httpd-2.4.25/modules/filters</span><br><span class="line">apxs -i -a -c mod_deflate.c</span><br><span class="line"></span><br><span class="line"><span class="comment">#加载 mod_ssl 模块</span></span><br><span class="line">./configure --prefix=/www/server/httpd --with-apr=/www/server/apr --with-apr-util=/www/server/apr-util --with-pcre=/www/server/pcre --<span class="built_in">enable</span>-module=so --<span class="built_in">enable</span>-mods-shared=all --with-ssl=/usr/bin/openssl --<span class="built_in">enable</span>-ssl</span><br><span class="line"><span class="comment">#重新编译不会覆盖httpd.conf文件, 所以需要httpd.conf手动加载模块</span></span><br><span class="line">LoadModule ssl_module     modules/mod_ssl.so</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>lamp</tag>
      </tags>
  </entry>
  <entry>
    <title>APP 接口设计(加密/签名/TOKEN认证/接口版本)</title>
    <url>/PHP/app-interface-security.html</url>
    <content><![CDATA[<div class="note danger"><p>接口安全问题：</p>
<ol>
<li>请求来源是否合法</li>
<li>请求参数是否被篡改</li>
<li>请求是唯一的(即同样的请求, 只有一次会生效)</li>
<li>数据传输的安全性</li>
</ol></div>
<h5 id="客户端请求流程"><a href="#客户端请求流程" class="headerlink" title="客户端请求流程"></a>客户端请求流程</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. 请求服务端,获取 RSA公钥(rsaPublicKey) 以及 接口密钥(key)</span><br><span class="line">2. 生成 AES密钥(aesKey)</span><br><span class="line">3. 定义 Params参数[TOKEN, PLATFORM, VERSION, NONCESTR, TIMESTAMP], 使用 AES密钥(aesKey) 加密, 得到加密后的数据(encryptParams)</span><br><span class="line">4. 使用 RSA公钥(rsaPublicKey) 对 AES密钥(aesKey) 加密, 得到加密后的AES密钥(encryptAesKey)</span><br><span class="line">5. 将 加密后的AES密钥(encryptAesKey) 作为HEADER参数之一, 完整的HEADER参数：[KEY =&gt; encryptAesKey, VALUE =&gt; encryptParams]</span><br><span class="line">6. 提取请求数据相关参数, 拼接 接口密钥(key) 生成签名, 然后发送请求给服务端, 等待响应</span><br><span class="line">7. 收到服务端的响应后, 使用请求时发送的 AES密钥(aesKey) 进行解密</span><br><span class="line"></span><br><span class="line">Params参数说明：</span><br><span class="line">    TOKEN 用户登录凭证</span><br><span class="line">    PLATFORM 请求来源所属平台</span><br><span class="line">    VERSION 平台版本</span><br><span class="line">    NONCESTR 随机字符串,用于验证请求是否重复</span><br><span class="line">    TIMESTAMP 请求时间,用于验证请求是否超时</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="服务端处理流程"><a href="#服务端处理流程" class="headerlink" title="服务端处理流程"></a>服务端处理流程</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. 响应客户端的请求, 获取客户端传输过来的HEADER参数[KEY, VALUE]</span><br><span class="line">2. 使用 RSA私钥(rsaPrivateKey) 对 加密后的AES密钥(KEY) 进行RSA解密, 得到AES密钥(decryptKey)</span><br><span class="line">3. 使用 解密后的AES密钥(decryptKey) 对 加密后的数据(VALUE) 进行AES解密, 得到解密后的JSON数据(decryptValue)</span><br><span class="line">4. 对 解密后的JSON数据(decryptValue) 进行JSON解析</span><br><span class="line">5. 若 解密后的AES密钥(decryptKey) 与 解密后的JSON数据(decryptValue) 不为空, 说明请求合法</span><br><span class="line">6. 获取 请求时间(decryptKey[TIMESTAMP]) 与 服务端时间(serverTime), 判断时间差是否大于 请求有效时间(requestExpireTime), 若大于则说明请求已超时(无效)</span><br><span class="line">7. 获取 随机字符串(decryptKey[NONCESTR]), 校验此记录是否存在 服务端的NONCESTR集合 内, 若存在则说明是重复请求(无效), 否则记录此NONCESTR, 并删除集合内超过 请求有效时间(requestExpireTime) 的NONCESTR (可以使用redis的expire, 新增nonce的同时设置它的超时失效时间)</span><br><span class="line">8. 若当前请求需要验证用户是否登录, 则 用户登录凭证(decryptValue[TOKEN]) 不能为空, 并查询数据库, 判断 TOKEN 是否过期</span><br><span class="line">9. 获取 请求数据(requestData), 使用 接口密钥(secretKey) 对请求数据验签</span><br><span class="line">10. 返回数据时, 转为JSON格式后, 使用 解密后的AES密钥(decryptKey) 进行加密, 然后返回给客户端</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>框架：Symfony3.4.13<br>JS插件包：<a href="https://github.com/travist/jsencrypt" target="_blank" rel="noopener">jsencrypt</a>、<a href="https://code.google.com/archive/p/crypto-js/downloads" target="_blank" rel="noopener">CryptJS</a></p>
<p>若使用 WEB 模拟请求接口的话, 需注释 <code>ApiRequestListener.php</code> 第 91 行</p></div>
<h5 id="配置代码"><a href="#配置代码" class="headerlink" title="配置代码"></a>配置代码</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">// app.yml</span><br><span class="line">parameters:</span><br><span class="line">    #服务端RSA公钥</span><br><span class="line">    server_rsa_public_key: 'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuPEVGUuo+0C6bXh6jjL7lSQ3UY3OqhN+5va+6h+sIsJpSIxRx2h8xlqWb8/BKQPUJL2WyQISOIDt/Mkdgzgy/5U/gA1iYvLdZanLAP/qgqEpVc2S++uVxQMMtS5/1ozECNtO3/jTKXkeAaow5JrstuJOkaSVJ/KkDVx/5DjyLgE0dMpJg7FgYbxZWLRKRz0B1yI4FdfhxSIJ6HQWPd7pqb5uiP1W5ftwYlNbZ8dGWrZgk2Ck15LrsNJLp4IFpNw1Wo8jxuOW7JaEck/gazyi082x1dpWQqrL4aH9F69+JsPBRbtFfj4K2jk0YQoOmW6TePnZG6yXq+MSxjMAOemA9wIDAQAB'</span><br><span class="line">    #服务端RSA私钥</span><br><span class="line">    server_rsa_private_key: 'MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC48RUZS6j7QLpteHqOMvuVJDdRjc6qE37m9r7qH6wiwmlIjFHHaHzGWpZvz8EpA9QkvZbJAhI4gO38yR2DODL/lT+ADWJi8t1lqcsA/+qCoSlVzZL765XFAwy1Ln/WjMQI207f+NMpeR4BqjDkmuy24k6RpJUn8qQNXH/kOPIuATR0ykmDsWBhvFlYtEpHPQHXIjgV1+HFIgnodBY93umpvm6I/Vbl+3BiU1tnx0ZatmCTYKTXkuuw0kunggWk3DVajyPG45bsloRyT+BrPKLTzbHV2lZCqsvhof0Xr34mw8FFu0V+PgraOTRhCg6ZbpN4+dkbrJer4xLGMwA56YD3AgMBAAECggEAMNp+WFBEMxrGJGTO+wE8tAj9E+4ByaucuiY0CGSVdBkm9qMadzKCw2Lqml6nB86bG5l5W1/QsFxegYge46rUze7+9zSR6NF+6nwPxBPWPuuTn7bOPP3eckx77uB5pJNKtYw5KbDxFuOHqajrgXfrT+Q4HQD85bCS5XSp0/+2+a+khp0oZodwKezspNdKQYhFrly/W0meWF3fQqVZ4Rh1BpPKxjAX7s7xAPApn1nTmo1Uy39oM1Ud6ATx4NnbVqm+C1ahmgA/Nbwz0XyEpaKjOY4Vr52MLtLessY+Q8kaNyfuqzH/MrLtyLKnxNSbVDjYy6s8j8bBlBTB6GFdif0WAQKBgQDqQGZJBIiUE3uPG8XPysQEXwoa7ASk0hNLVIelb9Z3xfhQWaWicB0sY8dtsl8bam2l4qZ4iQEYhUGNRiLxrfMeMmNxy7pyI9eP63vt0908T/1HZDMcWL6CYKccaA6AtjHDgJLEinWatrqiEq4TfH43MTa6tzpYZtCugRTYQvNvvwKBgQDKHLSyXVP/J35x9eTKkBKsN7QQ+l9mFpp2K8B8EPS3ds7aIitAiw97H6c3xXHTGH35QixlSWd0kq4sE5frBnNuYwPBWcXfX0poQfkAwWEph1f/iQdY9j16KORiqsm27e+ZK1vtt+RZfWU/n1RoSopuMe96RDhCqJYWtTefCuo8yQKBgEsh9Kyew5+a0BqKcdu/0TcFtJwF70deCcozhn5NbKBl4ssCtdlv1CuUpTZN66tDa3+1PmeSqcNPmkLRqAuUG1IoHzU0fsx1KoKCqPES7vaVQUtQnAQPgqsWjQLTbTNjPHrUFj7rmeTRjvLEwwiE+YaCRmeEtTX9ZBlUVXc3ohTJAoGAIyaW7qZ4o1m1DhDb97bS6IzPjlxdFx47Qu4dDfbM+NN66kkjCJim2p0IshRu1W3fCujNW9hGW+nezN+jfkai8MHbt1brqQujnzpKGi2HvndBgLnOQ1SgIIzYG6jkaCI9l4AI/vEKj93VLBmDzpeYN84LflI7DqzPXaeqwshdMLECgYEAs/7vspm7m/J58S+bJtDk1xc2/FwHgRLkCm6dXa9sORWGotVZQheF+rtwJ/N4DVqsTmwvHr/JI7P6DA4kE3cvuijB1e5DAv7LpkW9oFEjXDDlIp+9xkBjQ1LKgLAtjSCx+xx2fPPNwJk/ydSzvLyTi88uR0LDFlEPXlyUNax24EY='</span><br><span class="line">    #客户端RSA公钥</span><br><span class="line">    client_rsa_public_key: 'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAm57YawNBbWEysl+ItxIzOyhP/k0M4gnfJRIGWWhxkJqWkKFd7sfHeXkzTvmTNsAXmSu6JtVdOqAIUdACHLy7+wGRLbJuYx2B9sYTKJvAOmjhq53khLQ3ucz6m4Bpcig1jyZt9Sd9maFLN8dyrDpXzMsLML360d6qVcZiezba3p+mopZ9KSXdyj4wfctlAlpZsdMit/S6m0IWMirIV+xT3gbwAMXDLGUgRoIYILwhpIb4uLFckBBtf3hKOKsjwBELzMxwmNgYBfx4kxBUbWM+sA8gi+EqojFk/HLGc058+qtyQMHn0tOCICk3rN96lMS/IFPoQsojDD9ifFFeDJJYWQIDAQAB'</span><br><span class="line">    #客户端RSA私钥</span><br><span class="line">    client_rsa_private_key: 'MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCbnthrA0FtYTKyX4i3EjM7KE/+TQziCd8lEgZZaHGQmpaQoV3ux8d5eTNO+ZM2wBeZK7om1V06oAhR0AIcvLv7AZEtsm5jHYH2xhMom8A6aOGrneSEtDe5zPqbgGlyKDWPJm31J32ZoUs3x3KsOlfMywswvfrR3qpVxmJ7Ntren6ailn0pJd3KPjB9y2UCWlmx0yK39LqbQhYyKshX7FPeBvAAxcMsZSBGghggvCGkhvi4sVyQEG1/eEo4qyPAEQvMzHCY2BgF/HiTEFRtYz6wDyCL4SqiMWT8csZzTnz6q3JAwefS04IgKTes33qUxL8gU+hCyiMMP2J8UV4MklhZAgMBAAECggEAZMB8oRvkeipZpj5PxybTYFODJsM/ugBmJhv7XFtQWyyamly+8d8J+E1NuK3Ab8wB+zriNE4jI9eES2N+Wpieo62qDondCfKKt/gZY0sjMy3AHVoGHxyGj5Z0EcUbf7skod9hhTziBlr01dIdHgBP49j5D7+P6dxdL1dXXypunX6A1lCgxrRC0Z0iydxb9VWXOLyCb5sIAmh90FNTKUGV5y5KtyUZQAw7JdI4+Se0cqErOakwQr/VpAWRo9AxwPZ5HGqvrEAJHYd7acw1aLe7tXW1DoA9ou4iknmlAJ/oHogHsyzvbq8mLYkyZROXlcs8qAas2hB/wMBvo/0HJK+MYQKBgQDNiZioL1ieOZ1fwwfONaFRpGAKM8UJMvKmK5JVHlbqfXpHBQ0m4HSRlPAKvkXq5Jbomvb8rpbvZzIYOXhyZF/3F9/u6UIMmeakftxFLhnNYJyT7y1xPdoKWgxI1hePsiVps+DE8sYxO1LBzfDuMnwr4DXzSOeeQyiaJOsk2C88LQKBgQDB0+AXqWS9TZvUS5vLHJi2fXsKchO5YxgoWvXsdTnaUat0nb62yejW48jqdGCIL/5c9yXFTcAnd5h+a6UBZznxj/z6N4KDF7WsZSaPuvdP/5eOMQ6iuSMPF3jxtV34k0b+jTamoufFQ2Xjb9sUlkyRDwhjVfi1/KZdWnjrnbDsXQKBgDDyXpdWxxzPDao7cMVrwiIGKhTj5T1ek6h84dlBY2NuREtbaZljhH8S3+M/ErlwfHuiQ8VC8pDKm4RnU0aynqPiXKKxi9giYmm0CFK1OtHM+xzDrae1GhKzBQ/nZC8FNqGog5ODWS1qOjgLCiA/h5CPUWnBZ98pkSa8Of9JOF51AoGAM0iX9iq/mMa8AEOxCOCcF0zEDVN5nId3kNXgU5wAnp8VOlmyaDKsBI9oTYBVOjNYnchWmgmkWczu8CQTGHfzgNKUILAnPAA99UseFNFnNiduNhUMxkkt2YRgX7OZFXgCRL+gQh7ALBVVFAQ4dw39XDQaCA5rK9uZOQIDFHQ4p5ECgYEAkYIhEhcKtVtziSaJjil1TznCZcLRYyxACHJQOBob7j+HehIA4OK2g3KwJFUJm06kSTrNirWruiGONpOn4El5/it3ir/EW7Kj1lUyGVOOsha+gIVcaNB4k8Jz9me9KCaCbuY6zmdTmp22qYsSh93RTZEvEHpj7DjmKs/0UmamAOI='</span><br><span class="line">    </span><br><span class="line">    #API请求过期时间(单位：秒)</span><br><span class="line">    api_request_expire_time: 1200</span><br><span class="line">    #API接口密钥</span><br><span class="line">    api_secret_key: 'Lx8cQ659aM!T6zvKcwcoybA0^ltPbNqT'</span><br><span class="line">    #API SESSION前缀</span><br><span class="line">    api_session_prefix: 'API_'</span><br><span class="line"></span><br><span class="line">    #用户登录凭证TOKEN过期时间(单位：秒)</span><br><span class="line">    api_user_token_expire_time: 1200</span><br><span class="line">    </span><br><span class="line">    #REDIS配置</span><br><span class="line">    redis_config:</span><br><span class="line">        host: 127.0.0.1</span><br><span class="line">        port: 6379</span><br><span class="line">        auth: 123456</span><br></pre></td></tr></table></figure>
<h5 id="注册服务"><a href="#注册服务" class="headerlink" title="注册服务"></a>注册服务</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">services:</span><br><span class="line">    _defaults:</span><br><span class="line">        autowire: true</span><br><span class="line">        public: true</span><br><span class="line"></span><br><span class="line">    #============================HEADER解密服务==============================</span><br><span class="line">    api_request_listener:</span><br><span class="line">        class: Bundles\ApiBundle\Listener\ApiRequestListener</span><br><span class="line">        tags:</span><br><span class="line">            - &#123; name: kernel.event_listener, event: kernel.request, method: onKernelRequest, priority: 10 &#125;</span><br><span class="line"></span><br><span class="line">    #============================Response加密服务==============================</span><br><span class="line">    api_response_listener:</span><br><span class="line">        class: Bundles\ApiBundle\Listener\ApiResponseListener</span><br><span class="line">        tags:</span><br><span class="line">            - &#123; name: kernel.event_listener, event: kernel.response, method: onKernelResponse, priority: 10 &#125;</span><br></pre></td></tr></table></figure>
<h5 id="路由配置"><a href="#路由配置" class="headerlink" title="路由配置"></a>路由配置</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">//routing_user.yml</span><br><span class="line">#========================================API V1.0 START========================================</span><br><span class="line">#用户登录</span><br><span class="line">user_login:</span><br><span class="line">    path: /login</span><br><span class="line">    defaults: &#123; _controller: ApiBundle:V1\User\Center:login &#125;</span><br><span class="line">    methods: [GET, POST]</span><br><span class="line"></span><br><span class="line">#获取用户信息</span><br><span class="line">user_get_user_info:</span><br><span class="line">    path: /getUserInfo</span><br><span class="line">    defaults: &#123; _controller: ApiBundle:V1\User\Center:getUserInfo &#125;</span><br><span class="line">    methods: POST</span><br><span class="line">#========================================API V1.0 END========================================</span><br></pre></td></tr></table></figure>
<h5 id="服务端请求校验"><a href="#服务端请求校验" class="headerlink" title="服务端请求校验"></a>服务端请求校验</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Listener</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpKernel</span>\<span class="title">Event</span>\<span class="title">GetResponseEvent</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">DependencyInjection</span>\<span class="title">ContainerInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Util</span>\<span class="title">Crypt</span>\<span class="title">RSA</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Util</span>\<span class="title">Crypt</span>\<span class="title">AES</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Util</span>\<span class="title">Redis</span>\<span class="title">RedisHandler</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApiRequestListener</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> ContainerInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $container;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $controllerNameSpace = <span class="string">'Bundles\ApiBundle\Controller\\'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(ContainerInterface $container)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;container = $container;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> GetResponseEvent $event</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onKernelRequest</span><span class="params">(GetResponseEvent $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!$event-&gt;isMasterRequest()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $request = $event-&gt;getRequest();</span><br><span class="line">        $attributes = $request-&gt;attributes;</span><br><span class="line">        $currentRoute = $attributes-&gt;get(<span class="string">'_route'</span>);</span><br><span class="line">        $serverTime = <span class="keyword">new</span> \DateTime();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 无需认证的路由</span></span><br><span class="line">        $ignoreAuthRoute = array_values(<span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'ignore_auth_route'</span>));</span><br><span class="line">        <span class="keyword">if</span> (!in_array($currentRoute, $ignoreAuthRoute)) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * TOKEN 用户登录凭证,可为空</span></span><br><span class="line"><span class="comment">             * PLATFORM 平台</span></span><br><span class="line"><span class="comment">             * VERSION APP版本</span></span><br><span class="line"><span class="comment">             * NONCESTR 随机字符串</span></span><br><span class="line"><span class="comment">             * TIMESTAMP 请求时间,用于验证请求是否超时</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            $headerParams = [<span class="string">'TOKEN'</span>, <span class="string">'PLATFORM'</span>, <span class="string">'VERSION'</span>, <span class="string">'TIMESTAMP'</span>];</span><br><span class="line">            <span class="comment">// RSA加密后的AES KEY</span></span><br><span class="line">            $encryptKey = $request-&gt;server-&gt;get(<span class="string">'HTTP_KEY'</span>);</span><br><span class="line">            <span class="comment">// AES加密后的数据</span></span><br><span class="line">            $encryptValue = $request-&gt;server-&gt;get(<span class="string">'HTTP_VALUE'</span>);</span><br><span class="line">            $decryptKey = $decryptValue = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">empty</span>($encryptKey) &amp;&amp; !<span class="keyword">empty</span>($encryptValue)) &#123;</span><br><span class="line">                $decryptKey = RSA::decrypt($encryptKey, <span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'server_rsa_private_key'</span>));</span><br><span class="line">                $decryptValue = json_decode(AES::decrypt($encryptValue, $decryptKey), <span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">foreach</span> ($headerParams <span class="keyword">as</span> $headerParam) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="keyword">isset</span>($decryptValue[$headerParam]) || ($headerParam != <span class="string">'TOKEN'</span> &amp;&amp; <span class="keyword">empty</span>($decryptValue[$headerParam]))) &#123;</span><br><span class="line">                        $decryptValue = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 请求有效时间</span></span><br><span class="line">                $requestExpireTime = <span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'api_request_expire_time'</span>);</span><br><span class="line">                $requestTime = (<span class="keyword">new</span> \DateTime($decryptValue[<span class="string">'TIMESTAMP'</span>]))-&gt;add(<span class="keyword">new</span> \DateInterval(<span class="string">"PT&#123;$requestExpireTime&#125;S"</span>));</span><br><span class="line">                <span class="comment">// 请求超时</span></span><br><span class="line">                <span class="keyword">if</span> ($requestTime &lt; $serverTime) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;respond(<span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'MSG002'</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 初始化Redis</span></span><br><span class="line">                $redis = <span class="keyword">new</span> RedisHandler(<span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'redis_config'</span>));</span><br><span class="line">                <span class="comment">// 重复请求</span></span><br><span class="line">                <span class="keyword">if</span> ($redis-&gt;getRedis()-&gt;get($decryptValue[<span class="string">'NONCESTR'</span>])) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;respond(<span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'MSG003'</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 保存NonceStr至Redis,并设置过期时间</span></span><br><span class="line">                $redis-&gt;getRedis()-&gt;setex($decryptValue[<span class="string">'NONCESTR'</span>], $requestExpireTime, $decryptValue[<span class="string">'TIMESTAMP'</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 保存AES KEY到attributes</span></span><br><span class="line">                $attributes-&gt;set(<span class="string">'AESKEY'</span>, $decryptKey);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// HEADER参数错误,非法请求</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>($decryptKey) || <span class="keyword">empty</span>($decryptValue)) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;respond(<span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'MSG006'</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 无需验证登录的路由</span></span><br><span class="line">            $ignoreLoginRoute = array_reduce(array_values(<span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'ignore_login_route'</span>)), <span class="string">'array_merge'</span>, []);</span><br><span class="line">            <span class="keyword">if</span> (!in_array($currentRoute, $ignoreLoginRoute)) &#123;</span><br><span class="line">                $user = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">empty</span>($decryptValue[<span class="string">'TOKEN'</span>])) &#123;</span><br><span class="line">                    $userRepository = <span class="keyword">$this</span>-&gt;container-&gt;get(<span class="string">'doctrine'</span>)-&gt;getRepository(<span class="string">'CommonBundle:Api:User'</span>);</span><br><span class="line">                    $user = $userRepository-&gt;findOneBy([<span class="string">'token'</span> =&gt; $decryptValue[<span class="string">'TOKEN'</span>]]);</span><br><span class="line">                    <span class="comment">// 用户不存在或被禁用</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">empty</span>($user) || $user-&gt;getAccountStatus() != <span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="keyword">$this</span>-&gt;respond(<span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'MSG009'</span>));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// TOKEN已过期</span></span><br><span class="line">                    <span class="keyword">if</span> ($user-&gt;getTokenExpireTime() &lt; $serverTime) &#123;</span><br><span class="line">                        $user = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 保存用户信息至SESSION</span></span><br><span class="line">                    $request-&gt;getSession()-&gt;set(<span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'api_session_prefix'</span>) . <span class="string">'USER'</span>, $user);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">empty</span>($user)) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;respond(<span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'MSG008'</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 需要验签的路由</span></span><br><span class="line">            $verifySignRoute = array_reduce(array_values(<span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'verify_sign_route'</span>)), <span class="string">'array_merge'</span>, []);</span><br><span class="line">            <span class="keyword">if</span> (in_array($currentRoute, $verifySignRoute) &amp;&amp; $request-&gt;isMethod(<span class="string">'POST'</span>)) &#123;</span><br><span class="line">                <span class="comment">// 请求数据</span></span><br><span class="line">                $requestData = $request-&gt;request-&gt;all();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 第一种签名校验,使用客户端的RSA公钥验签</span></span><br><span class="line">                <span class="comment">//$verifySignResult = RSA::verifySign($requestData, $this-&gt;container-&gt;getParameter('client_rsa_public_key'));</span></span><br><span class="line">                <span class="comment">// 第二种签名校验,使用服务端的密钥重新生成签名比对</span></span><br><span class="line">                $verifySignResult = RSA::verifySignNoneOpenssl($requestData, <span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'api_secret_key'</span>));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 签名校验失败</span></span><br><span class="line">                <span class="keyword">if</span> (!$verifySignResult) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;respond(<span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'MSG007'</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 匹配路由并转发</span></span><br><span class="line">            $version = $request-&gt;server-&gt;get(<span class="string">'HTTP_APIVER'</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;matchRouteAndForward($request, $attributes-&gt;get(<span class="string">'_controller'</span>), $version);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 匹配路由并转发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \Symfony\Component\HttpFoundation\Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $controller</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $version</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">matchRouteAndForward</span><span class="params">($request, $controller, $version)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_numeric($version) &amp;&amp; $version) &#123;</span><br><span class="line">            $delimiter = <span class="string">'::'</span>;</span><br><span class="line">            <span class="keyword">if</span> (strpos($controller, $delimiter) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (strpos($version, <span class="string">'.'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">                    <span class="comment">// 主版本</span></span><br><span class="line">                    $major = (int)substr($version, <span class="number">0</span>, strpos($version, <span class="string">'.'</span>));</span><br><span class="line">                    <span class="comment">// 次版本</span></span><br><span class="line">                    $minor = (int)substr($version, strpos($version, <span class="string">'.'</span>) + <span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $major = (int)$version;</span><br><span class="line">                    $minor = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 主版本为空或版本号为 1或1.0</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">empty</span>($major) || $major === <span class="number">1</span> &amp;&amp; <span class="keyword">empty</span>($minor)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">list</span>($controllerName, $actionName) = explode($delimiter, $controller, <span class="number">2</span>);</span><br><span class="line">                <span class="comment">// 获取版本对应的控制器</span></span><br><span class="line">                $controllerName = str_replace(<span class="keyword">self</span>::$controllerNameSpace, <span class="string">''</span>, $controllerName);</span><br><span class="line">                $controllerName = <span class="keyword">self</span>::$controllerNameSpace . <span class="string">"V&#123;$major&#125;\\"</span> . substr($controllerName, strpos($controllerName, <span class="string">'\\'</span>) + <span class="number">1</span>);</span><br><span class="line">                <span class="comment">// 次版本不为空,则重新定义Action</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">empty</span>($minor)) &#123;</span><br><span class="line">                    $actionName = substr($actionName, <span class="number">0</span>, <span class="number">-6</span>) . <span class="string">"M&#123;$minor&#125;"</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 根据版本号,更改路由对应的控制器方法</span></span><br><span class="line">                $request-&gt;attributes-&gt;set(<span class="string">'_controller'</span>, $controllerName . $delimiter . $actionName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Respond.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $data</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">respond</span><span class="params">($message, $data = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $data = [<span class="string">'data'</span> =&gt; <span class="keyword">empty</span>($data) ? (object)$data : $data];</span><br><span class="line">        $respond = array_merge($message, $data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">die</span>(json_encode($respond));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="服务端接口处理"><a href="#服务端接口处理" class="headerlink" title="服务端接口处理"></a>服务端接口处理</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Controller</span>\<span class="title">V1</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Controller</span>\<span class="title">BaseController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Traits</span>\<span class="title">User</span>\<span class="title">CenterAbstractTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Controller</span>\<span class="title">V1</span>\<span class="title">User</span>\<span class="title">Traits</span>\<span class="title">CenterTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Util</span>\<span class="title">DateTime</span>\<span class="title">DateHelper</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Util</span>\<span class="title">Helper</span>\<span class="title">Helper</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CenterController</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">CenterAbstractTrait</span>, <span class="title">CenterTrait</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户登录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Symfony\Component\HttpFoundation\JsonResponse|\Symfony\Component\HttpFoundation\Response</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loginAction</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isPost()) &#123;</span><br><span class="line">            $request = <span class="keyword">$this</span>-&gt;getRequest();</span><br><span class="line">            $account = $request-&gt;request-&gt;get(<span class="string">'account'</span>);</span><br><span class="line">            $password = $request-&gt;request-&gt;get(<span class="string">'password'</span>);</span><br><span class="line">            $userRepository = <span class="keyword">$this</span>-&gt;getApiRepository(<span class="string">'User'</span>);</span><br><span class="line">            $user = $userRepository-&gt;findOneBy([</span><br><span class="line">                <span class="string">'account'</span> =&gt; $account,</span><br><span class="line">                <span class="string">'accountStatus'</span> =&gt; <span class="number">1</span></span><br><span class="line">            ]);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">empty</span>($user)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (md5($password) === $user-&gt;getPassword()) &#123;</span><br><span class="line">                    $nowTime = DateHelper::getNowDateTime();</span><br><span class="line">                    $data = [</span><br><span class="line">                        <span class="string">'token'</span> =&gt; Helper::generateToken(),</span><br><span class="line">                        <span class="string">'tokenExpireTime'</span> =&gt; $nowTime-&gt;add(<span class="keyword">new</span> \DateInterval(<span class="string">"PT&#123;$this-&gt;getCfgParameter('api_user_token_expire_time')&#125;S"</span>))</span><br><span class="line">                    ];</span><br><span class="line">                    <span class="comment">/** <span class="doctag">@var</span> \Bundles\CommonBundle\Entity\User $user */</span></span><br><span class="line">                    $user = $userRepository-&gt;saveEntity($data, $user);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;objMessage(<span class="keyword">$this</span>-&gt;getCfgParameter(<span class="string">'MSG001'</span>), [<span class="string">'token'</span> =&gt; $user-&gt;getToken()]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;objMessage(<span class="keyword">$this</span>-&gt;getCfgParameter(<span class="string">'MSG000'</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;render(<span class="string">'@Api/User/login.html.twig'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Symfony\Component\HttpFoundation\JsonResponse</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUserInfoAction</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isPost()) &#123;</span><br><span class="line">            $user = <span class="keyword">$this</span>-&gt;getUserInfo();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;objMessage(<span class="keyword">$this</span>-&gt;getCfgParameter(<span class="string">'MSG001'</span>), [</span><br><span class="line">                <span class="string">'user_id'</span> =&gt; $user-&gt;getId(),</span><br><span class="line">            ]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;objMessage(<span class="keyword">$this</span>-&gt;getCfgParameter(<span class="string">'MSG000'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="服务端返回数据"><a href="#服务端返回数据" class="headerlink" title="服务端返回数据"></a>服务端返回数据</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Listener</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpKernel</span>\<span class="title">Event</span>\<span class="title">FilterResponseEvent</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">DependencyInjection</span>\<span class="title">ContainerInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpFoundation</span>\<span class="title">JsonResponse</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Util</span>\<span class="title">Crypt</span>\<span class="title">AES</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApiResponseListener</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> ContainerInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $container;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(ContainerInterface $container)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;container = $container;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onKernelResponse</span><span class="params">(FilterResponseEvent $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!$event-&gt;isMasterRequest()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $request = $event-&gt;getRequest();</span><br><span class="line">        $currentRoute = $request-&gt;attributes-&gt;get(<span class="string">'_route'</span>);</span><br><span class="line">        <span class="comment">// 无需认证的路由</span></span><br><span class="line">        $ignoreAuthRoute = array_values(<span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'ignore_auth_route'</span>));</span><br><span class="line">        <span class="keyword">if</span> (!in_array($currentRoute, $ignoreAuthRoute)) &#123;</span><br><span class="line">            $response = $event-&gt;getResponse();</span><br><span class="line">            <span class="keyword">if</span> ($response <span class="keyword">instanceof</span> JsonResponse) &#123;</span><br><span class="line">                <span class="comment">// 无需加密数据的路由</span></span><br><span class="line">                $ignoreEncryptRoute = array_reduce(array_values(<span class="keyword">$this</span>-&gt;container-&gt;getParameter(<span class="string">'ignore_encrypt_route'</span>)), <span class="string">'array_merge'</span>, []);</span><br><span class="line">                <span class="keyword">if</span> (!in_array($currentRoute, $ignoreEncryptRoute)) &#123;</span><br><span class="line">                    $content = json_decode($response-&gt;getContent(), <span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// AES加密</span></span><br><span class="line">                    $content[<span class="string">'data'</span>] = AES::encrypt(base64_encode(json_encode($content[<span class="string">'data'</span>])), $request-&gt;attributes-&gt;get(<span class="string">'AESKEY'</span>));</span><br><span class="line">                    $response-&gt;setData($content);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="WEB-模拟请求接口"><a href="#WEB-模拟请求接口" class="headerlink" title="WEB 模拟请求接口"></a>WEB 模拟请求接口</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&#123;% block javascripts %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; asset('/static/js/jquery-3.3.1.min.js') &#125;&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; asset('/static/js/jsencrypt.min.js') &#125;&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; asset('/static/js/CryptoJS v3.1.2/components/core-min.js') &#125;&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; asset('/static/js/CryptoJS v3.1.2/rollups/aes.js') &#125;&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; asset('/static/js/CryptoJS v3.1.2/rollups/sha256.js') &#125;&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; asset('/static/js/base64.js') &#125;&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    &#123;&#123; getConfigParameter('app_name') &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"account"</span> <span class="attr">required</span>=<span class="string">"required"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">required</span>=<span class="string">"required"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Login"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">        $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// 生成HEADER参数</span></span></span><br><span class="line"><span class="javascript">            <span class="function"><span class="keyword">function</span> <span class="title">generateHeader</span>(<span class="params">token, apiver</span>)</span></span></span><br><span class="line"><span class="undefined">            &#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 服务端公钥,用于加密AES KEY</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> serverRsaPublicKey = <span class="string">'-----BEGIN PUBLIC KEY-----&#123;&#123; getConfigParameter('</span>server_rsa_public_key<span class="string">') &#125;&#125;-----END PUBLIC KEY-----'</span>;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> RSA = <span class="keyword">new</span> JSEncrypt();</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 设置公钥</span></span></span><br><span class="line"><span class="undefined">                RSA.setPublicKey(serverRsaPublicKey);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="comment">// AES KEY</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> aesKey = generateRandom();</span></span><br><span class="line"><span class="javascript">                <span class="comment">// AES IV</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> aesIv = CryptoJS.MD5(aesKey).toString().substring(<span class="number">0</span>, <span class="number">16</span>);</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 请求参数</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> params = &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">'TOKEN'</span>: token || <span class="string">''</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">'PLATFORM'</span>: <span class="string">'WEB'</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">'VERSION'</span>: <span class="string">'1.0'</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">'NONCESTR'</span>: generateRandom(<span class="number">16</span>),</span></span><br><span class="line"><span class="javascript">                    <span class="string">'TIMESTAMP'</span>: <span class="keyword">new</span> <span class="built_in">Date</span>().format(<span class="string">'yyyy-MM-dd hh:mm:ss'</span>),</span></span><br><span class="line"><span class="undefined">                &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="undefined">                    aes: &#123;</span></span><br><span class="line"><span class="undefined">                        key: aesKey,</span></span><br><span class="line"><span class="undefined">                        iv: aesIv,</span></span><br><span class="line"><span class="undefined">                    &#125;,</span></span><br><span class="line"><span class="undefined">                    header: &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="comment">// 使用 RSA 对 aesKey 加密</span></span></span><br><span class="line"><span class="undefined">                        KEY: RSA.encrypt(aesKey),</span></span><br><span class="line"><span class="javascript">                        <span class="comment">// 使用 AES 对 params 加密</span></span></span><br><span class="line"><span class="undefined">                        VALUE: aesEncrypt(params, aesKey, aesIv),</span></span><br><span class="line"><span class="javascript">                        <span class="comment">// 接口版本号</span></span></span><br><span class="line"><span class="javascript">                        APIVER: apiver || <span class="string">'1.0'</span>,</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125;;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">            $(<span class="string">'form'</span>).on(<span class="string">'submit'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> postData = &#123;</span></span><br><span class="line"><span class="javascript">                    account: $(<span class="string">'input[name="account"]'</span>).val(),</span></span><br><span class="line"><span class="javascript">                    password: $(<span class="string">'input[name="password"]'</span>).val(),</span></span><br><span class="line"><span class="undefined">                    nonece: generateRandom(16),</span></span><br><span class="line"><span class="javascript">                    timestamp: <span class="keyword">new</span> <span class="built_in">Date</span>().format(<span class="string">'yyyy-MM-dd hh:mm:ss'</span>),</span></span><br><span class="line"><span class="undefined">                &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                /*// 第一种加签方式：使用客户端的RSA私钥加签</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 客户端私钥,用于生成签名</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> clientRsaPrivateKey = <span class="string">'-----BEGIN PRIVATE KEY-----&#123;&#123; getConfigParameter('</span>client_rsa_private_key<span class="string">') &#125;&#125;-----END PRIVATE KEY-----'</span>;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 客户端公钥,用于验签</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> clientRsaPublicKey = <span class="string">'-----BEGIN PUBLIC KEY-----&#123;&#123; getConfigParameter('</span>client_rsa_public_key<span class="string">') &#125;&#125;-----END PUBLIC KEY-----'</span>;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 生成签名</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> postStr = generateSign(postData);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> signRSA = <span class="keyword">new</span> JSEncrypt();</span></span><br><span class="line"><span class="undefined">                signRSA.setPrivateKey(clientRsaPrivateKey);</span></span><br><span class="line"><span class="javascript">                postData.sign = signRSA.sign(postStr, CryptoJS.SHA256, <span class="string">"sha256"</span>);</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 验证签名</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> verifyRSA = <span class="keyword">new</span> JSEncrypt();</span></span><br><span class="line"><span class="undefined">                verifyRSA.setPublicKey(clientRsaPublicKey);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> verifySign = verifyRSA.verify(postStr, postData.sign, CryptoJS.SHA256);</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(verifySign);*<span class="regexp">/</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="comment">// 第二种加签方式：使用服务端的密钥拼接生成签名</span></span></span><br><span class="line"><span class="javascript">                postData.sign = generateSign(postData, <span class="string">'&#123;&#123; getConfigParameter('</span>api_secret_key<span class="string">') &#125;&#125;'</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> headerJson = generateHeader();</span></span><br><span class="line"><span class="javascript">                $.ajax(&#123;</span></span><br><span class="line"><span class="javascript">                    type: <span class="string">'POST'</span>,</span></span><br><span class="line"><span class="javascript">                    url: <span class="string">''</span>,</span></span><br><span class="line"><span class="undefined">                    data: postData,</span></span><br><span class="line"><span class="javascript">                    dataType: <span class="string">'JSON'</span>,</span></span><br><span class="line"><span class="undefined">                    headers: headerJson.header,</span></span><br><span class="line"><span class="javascript">                &#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">if</span> (res.code === <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">let</span> data = <span class="built_in">JSON</span>.parse(aesDecrypt(res.data, headerJson.aes.key, headerJson.aes.iv));</span></span><br><span class="line"><span class="javascript">                        <span class="comment">// 获取用户信息</span></span></span><br><span class="line"><span class="undefined">                        headerJson = generateHeader(data.token);</span></span><br><span class="line"><span class="javascript">                        $.ajax(&#123;</span></span><br><span class="line"><span class="javascript">                            type: <span class="string">'POST'</span>,</span></span><br><span class="line"><span class="javascript">                            url: <span class="string">'&#123;&#123; path('</span>user_get_user_info<span class="string">') &#125;&#125;'</span>,</span></span><br><span class="line"><span class="undefined">                            data: &#123;&#125;,</span></span><br><span class="line"><span class="javascript">                            dataType: <span class="string">'JSON'</span>,</span></span><br><span class="line"><span class="undefined">                            headers: headerJson.header,</span></span><br><span class="line"><span class="javascript">                        &#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">if</span> (res.code === <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="javascript">                                <span class="keyword">let</span> data = <span class="built_in">JSON</span>.parse(aesDecrypt(res.data, headerJson.aes.key, headerJson.aes.iv));</span></span><br><span class="line"><span class="javascript">                                alert(<span class="built_in">JSON</span>.stringify(data));</span></span><br><span class="line"><span class="undefined">                            &#125;</span></span><br><span class="line"><span class="undefined">                        &#125;);</span></span><br><span class="line"><span class="javascript">                    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="undefined">                        alert(res.message);</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">            &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">            <span class="comment">// AES加密</span></span></span><br><span class="line"><span class="javascript">            <span class="function"><span class="keyword">function</span> <span class="title">aesEncrypt</span>(<span class="params">data, key, iv</span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">                key = CryptoJS.enc.Utf8.parse(key);</span></span><br><span class="line"><span class="undefined">                iv = CryptoJS.enc.Utf8.parse(iv);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (<span class="keyword">typeof</span>(data) === <span class="string">'object'</span>) &#123;</span></span><br><span class="line"><span class="javascript">                    data = <span class="built_in">JSON</span>.stringify(data);</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> string = <span class="keyword">new</span> Base64().encode(data);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> encrypted = CryptoJS.AES.encrypt(string, key, &#123;</span></span><br><span class="line"><span class="undefined">                    iv: iv,</span></span><br><span class="line"><span class="undefined">                    mode: CryptoJS.mode.CBC,</span></span><br><span class="line"><span class="undefined">                    padding: CryptoJS.pad.Pkcs7</span></span><br><span class="line"><span class="undefined">                &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> encrypted.ciphertext.toString();</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">            <span class="comment">// AES解密</span></span></span><br><span class="line"><span class="javascript">            <span class="function"><span class="keyword">function</span> <span class="title">aesDecrypt</span>(<span class="params">string, key, iv</span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">                key = CryptoJS.enc.Utf8.parse(key);</span></span><br><span class="line"><span class="undefined">                iv = CryptoJS.enc.Utf8.parse(iv);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> encryptedHexStr = CryptoJS.enc.Hex.parse(string);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> srcs = CryptoJS.enc.Base64.stringify(encryptedHexStr);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> decrypt = CryptoJS.AES.decrypt(srcs, key, &#123;</span></span><br><span class="line"><span class="undefined">                    iv: iv,</span></span><br><span class="line"><span class="undefined">                    mode: CryptoJS.mode.CBC,</span></span><br><span class="line"><span class="undefined">                    padding: CryptoJS.pad.Pkcs7</span></span><br><span class="line"><span class="undefined">                &#125;);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> decryptedStr = decrypt.toString(CryptoJS.enc.Utf8);</span></span><br><span class="line"><span class="javascript">                decryptedStr = <span class="keyword">new</span> Base64().decode(decryptedStr);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> decryptedStr;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">            <span class="comment">// 生成签名</span></span></span><br><span class="line"><span class="javascript">            <span class="function"><span class="keyword">function</span> <span class="title">generateSign</span>(<span class="params">postData, secretKey</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                secretKey = secretKey || <span class="string">''</span>;</span></span><br><span class="line"><span class="undefined">                postData = ksort(postData);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> postStr = <span class="string">''</span>;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> postData) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">if</span> (postData[key] !== <span class="string">''</span> &amp;&amp; <span class="keyword">typeof</span> postData[key] !== <span class="string">'undefined'</span> &amp;&amp; key !== <span class="string">'sign'</span>) &#123;</span></span><br><span class="line"><span class="javascript">                        postStr += key + <span class="string">'='</span> + postData[key] + <span class="string">'&amp;'</span>;</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                postStr = postStr.substring(0, postStr.length - 1);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (secretKey !== <span class="string">''</span> &amp;&amp; <span class="keyword">typeof</span> secretKey !== <span class="string">'undefined'</span>) &#123;</span></span><br><span class="line"><span class="javascript">                    postStr += <span class="string">'&amp;key='</span> + secretKey;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                postStr = CryptoJS.MD5(postStr).toString().toUpperCase();</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> postStr;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">            <span class="comment">// 日期格式化</span></span></span><br><span class="line"><span class="javascript">            <span class="built_in">Date</span>.prototype.format = <span class="function"><span class="keyword">function</span>(<span class="params">format</span>)</span></span></span><br><span class="line"><span class="undefined">            &#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> o = &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">"M+"</span>: <span class="keyword">this</span>.getMonth() + <span class="number">1</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">"d+"</span>: <span class="keyword">this</span>.getDate(),</span></span><br><span class="line"><span class="javascript">                    <span class="string">"h+"</span>: <span class="keyword">this</span>.getHours(),</span></span><br><span class="line"><span class="javascript">                    <span class="string">"m+"</span>: <span class="keyword">this</span>.getMinutes(),</span></span><br><span class="line"><span class="javascript">                    <span class="string">"s+"</span>: <span class="keyword">this</span>.getSeconds(),</span></span><br><span class="line"><span class="javascript">                    <span class="string">"q+"</span>: <span class="built_in">Math</span>.floor((<span class="keyword">this</span>.getMonth() + <span class="number">3</span>) / <span class="number">3</span>),</span></span><br><span class="line"><span class="javascript">                    <span class="string">"S"</span>: <span class="keyword">this</span>.getMilliseconds()</span></span><br><span class="line"><span class="undefined">                &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span>(<span class="regexp">/(y+)/</span>.test(format)) &#123;</span></span><br><span class="line"><span class="javascript">                    format = format.replace(<span class="built_in">RegExp</span>.$<span class="number">1</span>, (<span class="keyword">this</span>.getFullYear() + <span class="string">""</span>).substr(<span class="number">4</span> - <span class="built_in">RegExp</span>.$<span class="number">1.</span>length));</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="keyword">for</span>(<span class="keyword">let</span> k <span class="keyword">in</span> o) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">if</span>(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"("</span>+ k +<span class="string">")"</span>).test(format)) &#123;</span></span><br><span class="line"><span class="javascript">                        format = format.replace(<span class="built_in">RegExp</span>.$<span class="number">1</span>, <span class="built_in">RegExp</span>.$<span class="number">1.</span>length === <span class="number">1</span> ? o[k] : (<span class="string">"00"</span> + o[k]).substr((<span class="string">""</span> + o[k]).length));</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> format;</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">            <span class="comment">// ksort 排序</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> ksort = <span class="function"><span class="keyword">function</span>(<span class="params">inputArr, sort_flags</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> tmp_arr = &#123;&#125;,</span></span><br><span class="line"><span class="undefined">                    keys = [],</span></span><br><span class="line"><span class="javascript">                    sorter, i, k, that = <span class="keyword">this</span>,</span></span><br><span class="line"><span class="javascript">                    strictForIn = <span class="literal">false</span>,</span></span><br><span class="line"><span class="undefined">                    populateArr = &#123;&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="keyword">switch</span> (sort_flags) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">case</span> <span class="string">'SORT_STRING'</span>:</span></span><br><span class="line"><span class="javascript">                        <span class="comment">// compare items as strings</span></span></span><br><span class="line"><span class="javascript">                        sorter = <span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">return</span> that.strnatcmp(a, b);</span></span><br><span class="line"><span class="undefined">                        &#125;;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">case</span> <span class="string">'SORT_LOCALE_STRING'</span>:</span></span><br><span class="line"><span class="javascript">                        <span class="comment">// compare items as strings, original by the current locale (set with  i18n_loc_set_default() as of PHP6)</span></span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> loc = <span class="keyword">this</span>.i18n_loc_get_default();</span></span><br><span class="line"><span class="javascript">                        sorter = <span class="keyword">this</span>.php_js.i18nLocales[loc].sorting;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">case</span> <span class="string">'SORT_NUMERIC'</span>:</span></span><br><span class="line"><span class="javascript">                        <span class="comment">// compare items numerically</span></span></span><br><span class="line"><span class="javascript">                        sorter = <span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">return</span> ((a + <span class="number">0</span>) - (b + <span class="number">0</span>));</span></span><br><span class="line"><span class="undefined">                        &#125;;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="javascript">                    <span class="comment">// case 'SORT_REGULAR': // compare items normally (don't change types)</span></span></span><br><span class="line"><span class="javascript">                    <span class="keyword">default</span>:</span></span><br><span class="line"><span class="javascript">                        sorter = <span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">var</span> aFloat = <span class="built_in">parseFloat</span>(a),</span></span><br><span class="line"><span class="javascript">                                bFloat = <span class="built_in">parseFloat</span>(b),</span></span><br><span class="line"><span class="javascript">                                aNumeric = aFloat + <span class="string">''</span> === a,</span></span><br><span class="line"><span class="javascript">                                bNumeric = bFloat + <span class="string">''</span> === b;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">if</span> (aNumeric &amp;&amp; bNumeric) &#123;</span></span><br><span class="line"><span class="javascript">                                <span class="keyword">return</span> aFloat &gt; bFloat ? <span class="number">1</span> : aFloat &lt; bFloat ? <span class="number">-1</span> : <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (aNumeric &amp;&amp; !bNumeric) &#123;</span></span><br><span class="line"><span class="javascript">                                <span class="keyword">return</span> <span class="number">1</span>;</span></span><br><span class="line"><span class="javascript">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!aNumeric &amp;&amp; bNumeric) &#123;</span></span><br><span class="line"><span class="javascript">                                <span class="keyword">return</span> <span class="number">-1</span>;</span></span><br><span class="line"><span class="undefined">                            &#125;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">return</span> a &gt; b ? <span class="number">1</span> : a &lt; b ? <span class="number">-1</span> : <span class="number">0</span>;</span></span><br><span class="line"><span class="undefined">                        &#125;;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="comment">// Make a list of key names</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">for</span> (k <span class="keyword">in</span> inputArr) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">if</span> (inputArr.hasOwnProperty(k)) &#123;</span></span><br><span class="line"><span class="undefined">                        keys.push(k);</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined">                keys.sort(sorter);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="comment">// BEGIN REDUNDANT</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">this</span>.php_js = <span class="keyword">this</span>.php_js || &#123;&#125;;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">this</span>.php_js.ini = <span class="keyword">this</span>.php_js.ini || &#123;&#125;;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// END REDUNDANT</span></span></span><br><span class="line"><span class="javascript">                strictForIn = <span class="keyword">this</span>.php_js.ini[<span class="string">'phpjs.strictForIn'</span>] &amp;&amp; <span class="keyword">this</span>.php_js.ini[<span class="string">'phpjs.strictForIn'</span>].local_value &amp;&amp; <span class="keyword">this</span>.php_js</span></span><br><span class="line"><span class="javascript">                    .ini[<span class="string">'phpjs.strictForIn'</span>].local_value !== <span class="string">'off'</span>;</span></span><br><span class="line"><span class="undefined">                populateArr = strictForIn ? inputArr : populateArr;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="comment">// Rebuild array with sorted key names</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span></span><br><span class="line"><span class="undefined">                    k = keys[i];</span></span><br><span class="line"><span class="undefined">                    tmp_arr[k] = inputArr[k];</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">if</span> (strictForIn) &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">delete</span> inputArr[k];</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">for</span> (i <span class="keyword">in</span> tmp_arr) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">if</span> (tmp_arr.hasOwnProperty(i)) &#123;</span></span><br><span class="line"><span class="undefined">                        populateArr[i] = tmp_arr[i];</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> strictForIn || populateArr;</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">            <span class="comment">// 生成随机字符串</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> generateRandom = <span class="function"><span class="keyword">function</span>(<span class="params">len</span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">                len = len || 32;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> chars = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'</span>;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> length = chars.length;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> str = <span class="string">''</span>;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span></span><br><span class="line"><span class="javascript">                    str += chars.charAt(<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * length));</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> str;</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure>
<h5 id="PHP-模拟生成HEADER请求头及请求数据"><a href="#PHP-模拟生成HEADER请求头及请求数据" class="headerlink" title="PHP 模拟生成HEADER请求头及请求数据"></a>PHP 模拟生成HEADER请求头及请求数据</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成HEADER请求头</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 请求参数</span></span><br><span class="line">$params = [</span><br><span class="line">    <span class="comment">// 用户登录凭证</span></span><br><span class="line">    <span class="string">'TOKEN'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">    <span class="comment">// 请求来源所属平台</span></span><br><span class="line">    <span class="string">'PLATFORM'</span> =&gt; <span class="string">'iOS'</span>,</span><br><span class="line">    <span class="comment">// 平台版本</span></span><br><span class="line">    <span class="string">'VERSION'</span> =&gt; <span class="string">'1.0'</span>,</span><br><span class="line">    <span class="comment">// 随机字符串,用于验证请求是否重复</span></span><br><span class="line">    <span class="string">'NONCESTR'</span> =&gt; Helper::generateRandom(<span class="number">16</span>),</span><br><span class="line">    <span class="comment">// 请求时间,用于验证请求是否超时</span></span><br><span class="line">    <span class="string">'TIMESTAMP'</span> =&gt; date(<span class="string">'Y-m-d H:i:s'</span>),</span><br><span class="line">];</span><br><span class="line"><span class="comment">// 生成AES KEY</span></span><br><span class="line">$aesKey = Helper::generateRandom(<span class="number">32</span>);</span><br><span class="line"><span class="comment">// 生成HEADER请求参数</span></span><br><span class="line">$header = [</span><br><span class="line">    <span class="comment">// RSA公钥加密$aesKey</span></span><br><span class="line">    <span class="string">'KEY'</span> =&gt; RSA::encrypt($aesKey, <span class="keyword">$this</span>-&gt;getCfgParameter(<span class="string">'server_rsa_public_key'</span>)),</span><br><span class="line">    <span class="comment">// AES加密$params</span></span><br><span class="line">    <span class="string">'VALUE'</span> =&gt; AES::encrypt(base64_encode(json_encode($params)), $aesKey),</span><br><span class="line">    <span class="comment">// API接口版本</span></span><br><span class="line">    <span class="string">'APIVER'</span> =&gt; <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成请求数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">$data = [</span><br><span class="line">    <span class="string">'account'</span> =&gt; <span class="string">'13512345678'</span>,</span><br><span class="line">    <span class="string">'password'</span> =&gt; <span class="string">'123456'</span>,</span><br><span class="line">    <span class="comment">// 随机字符串,防止生成签名时重复</span></span><br><span class="line">    <span class="string">'noncestr'</span> =&gt; Helper::generateRandom(),</span><br><span class="line">    <span class="comment">// 请求时间,防止生成签名时重复</span></span><br><span class="line">    <span class="string">'timestamp'</span> =&gt; date(<span class="string">'Y-m-d H:i:s'</span>),</span><br><span class="line">];</span><br><span class="line"><span class="comment">// 第一种加签方式：使用客户端的RSA私钥加签</span></span><br><span class="line"><span class="comment">//$data['sign'] = RSA::generateSign($data, $this-&gt;getCfgParameter('client_rsa_private_key'));</span></span><br><span class="line"><span class="comment">// 第二种加签方式：使用服务端的密钥拼接生成签名</span></span><br><span class="line">$data[<span class="string">'sign'</span>] = RSA::generateSignNoneOpenssl($data, <span class="keyword">$this</span>-&gt;getCfgParameter(<span class="string">'api_secret_key'</span>));</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>symfony</tag>
      </tags>
  </entry>
  <entry>
    <title>API 版本控制</title>
    <url>/PHP/api-versioning.html</url>
    <content><![CDATA[<blockquote><p>开发APP时,随着业务需求的不断变化,服务端接口返回的数据也就会有各种变动,但由于APP无法动态更新请求接口,那么服务端接口变动时就需要兼容旧版本,所以服务端这边就需要对接口做版本控制</p>
</blockquote>
<div class="note primary"><p>版本控制方式(这里使用 Symfony 框架实现了第一种和第四种)：</p>
<ol>
<li>使用一个 URI 参数：<a href="https://example.com/api/v1/login" target="_blank" rel="noopener">https://example.com/api/v1/login</a>  </li>
<li>使用查询参数：<a href="https://example.com/api/login?version=v1" target="_blank" rel="noopener">https://example.com/api/login?version=v1</a></li>
<li>自定义 Accept mime-type： Accept: application/json; version=1</li>
<li>自定义 Header：VERSION: 1</li>
</ol></div>
<h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Bundles/</span><br><span class="line">    ApiBundle/</span><br><span class="line">        Controller</span><br><span class="line">            V1/</span><br><span class="line">                User/</span><br><span class="line">                    Traits/</span><br><span class="line">                        LoginTrait.php      </span><br><span class="line">                    CenterController.php</span><br><span class="line">            V2/</span><br><span class="line">                User/</span><br><span class="line">                    Traits/</span><br><span class="line">                        LoginTrait.php</span><br><span class="line">                    CenterController.php    </span><br><span class="line">            BaseController.php    </span><br><span class="line">        Traits/</span><br><span class="line">            User/</span><br><span class="line">                LoginAbstractTrait.php  User模块通用方法</span><br><span class="line">            ApiTrait.php</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="接口基类"><a href="#接口基类" class="headerlink" title="接口基类"></a>接口基类</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// BaseController.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Bundle</span>\<span class="title">FrameworkBundle</span>\<span class="title">Controller</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Traits</span>\<span class="title">AbstractTrait</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">AbstractTrait</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="接口相关代码"><a href="#接口相关代码" class="headerlink" title="接口相关代码"></a>接口相关代码</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// V1 版本</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Controller</span>\<span class="title">V1</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Controller</span>\<span class="title">BaseController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Traits</span>\<span class="title">User</span>\<span class="title">LoginAbstractTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Controller</span>\<span class="title">V1</span>\<span class="title">User</span>\<span class="title">Traits</span>\<span class="title">LoginTrait</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CenterController</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">LoginAbstractTrait</span>, <span class="title">LoginTrait</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// V1.0</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loginAction</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'版本V1'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// V1.1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loginM1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'版本V1.1'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// V2 版本</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Controller</span>\<span class="title">V2</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Controller</span>\<span class="title">BaseController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Traits</span>\<span class="title">User</span>\<span class="title">LoginAbstractTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Controller</span>\<span class="title">V2</span>\<span class="title">User</span>\<span class="title">Traits</span>\<span class="title">LoginTrait</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CenterController</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">LoginAbstractTrait</span>, <span class="title">LoginTrait</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// V2.0</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loginAction</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'版本V2'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// V2.1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loginM1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'版本V2.1'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="注册监听器服务"><a href="#注册监听器服务" class="headerlink" title="注册监听器服务"></a>注册监听器服务</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">services:</span><br><span class="line">    _defaults:</span><br><span class="line">        # ... be sure autowiring is enabled</span><br><span class="line">        autowire: true</span><br><span class="line"></span><br><span class="line">    api_request_listener:</span><br><span class="line">        class: Bundles\ApiBundle\Listener\ApiRequestListener</span><br><span class="line">        tags:</span><br><span class="line">            - &#123; name: kernel.event_listener, event: kernel.request, method: onKernelRequest, priority: 10 &#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>自定义HEADER参数<br>实现原理：获取HEADER的自定义参数VERSION, 根据版本号调用不同方法<br>API接口：</p>
<pre><code>1. localhost:8080/user/login    HEADER：VERSION = 1
2. localhost:8080/user/login    HEADER：VERSION = 1.1
3. localhost:8080/user/login    HEADER：VERSION = 2
4. localhost:8080/user/login    HEADER：VERSION = 2.1
</code></pre></div>
<h5 id="路由配置"><a href="#路由配置" class="headerlink" title="路由配置"></a>路由配置</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">user_login:</span><br><span class="line">    path: /login</span><br><span class="line">    defaults: &#123; _controller: ApiBundle:V1\User\Center:login &#125;</span><br><span class="line">    methods: [GET, POST]</span><br></pre></td></tr></table></figure>
<h5 id="请求监听器"><a href="#请求监听器" class="headerlink" title="请求监听器"></a>请求监听器</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Listener</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpKernel</span>\<span class="title">Event</span>\<span class="title">GetResponseEvent</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">DependencyInjection</span>\<span class="title">ContainerInterface</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApiRequestListener</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> ContainerInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $container;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $controllerNameSpace = <span class="string">'Bundles\ApiBundle\Controller\\'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(ContainerInterface $container)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;container = $container;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> GetResponseEvent $event</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onKernelRequest</span><span class="params">(GetResponseEvent $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!$event-&gt;isMasterRequest()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $request = $event-&gt;getRequest();</span><br><span class="line">        $attributes = $request-&gt;attributes;</span><br><span class="line">        $version = $request-&gt;server-&gt;get(<span class="string">'HTTP_VERSION'</span>);</span><br><span class="line">        <span class="keyword">if</span> (is_numeric($version) &amp;&amp; $version) &#123;</span><br><span class="line">            $controller = $attributes-&gt;get(<span class="string">'_controller'</span>);</span><br><span class="line">            $delimiter = <span class="string">'::'</span>;</span><br><span class="line">            <span class="keyword">if</span> (strpos($controller, $delimiter) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (strpos($version, <span class="string">'.'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">                    $major = (int)substr($version, <span class="number">0</span>, strpos($version, <span class="string">'.'</span>));</span><br><span class="line">                    $minor = (int)substr($version, strpos($version, <span class="string">'.'</span>) + <span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $major = (int)$version;</span><br><span class="line">                    $minor = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">empty</span>($major) || $major === <span class="number">1</span> &amp;&amp; <span class="keyword">empty</span>($minor)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">list</span>($controllerName, $actionName) = explode($delimiter, $controller, <span class="number">2</span>);</span><br><span class="line">                $controllerName = str_replace(<span class="keyword">self</span>::$controllerNameSpace, <span class="string">''</span>, $controllerName);</span><br><span class="line">                $controllerName = <span class="keyword">self</span>::$controllerNameSpace . <span class="string">"V&#123;$major&#125;\\"</span> . substr($controllerName, strpos($controllerName, <span class="string">'\\'</span>) + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">empty</span>($minor)) &#123;</span><br><span class="line">                    $actionName = substr($actionName, <span class="number">0</span>, <span class="number">-6</span>) . <span class="string">"M&#123;$minor&#125;"</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $request-&gt;attributes-&gt;set(<span class="string">'_controller'</span>, $controllerName . $delimiter . $actionName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>URI参数, 动态匹配接口版本号, 根据版本号调用不同方法<br>API接口：</p>
<pre><code>1. localhost:8080/user/login
2. localhost:8080/user/v1.1/login
3. localhost:8080/user/v2/login
4. localhost:8080/user/v2.1/login
</code></pre></div>
<h5 id="接口路由"><a href="#接口路由" class="headerlink" title="接口路由"></a>接口路由</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">#=================================版本V1.0 API START===================================#</span><br><span class="line">user_login:</span><br><span class="line">    path: /login</span><br><span class="line">    defaults: &#123; _controller: ApiBundle:V1\User\Center:login &#125;</span><br><span class="line">    methods: [GET, POST]</span><br><span class="line"></span><br><span class="line">v1_user_login:</span><br><span class="line">    path: /&#123;version&#125;/login</span><br><span class="line">    defaults: &#123; _controller: ApiBundle:V1\User\Center:login &#125;</span><br><span class="line">    methods: [GET, POST]</span><br><span class="line">    requirements:</span><br><span class="line">        version: 'v1\.\d+'</span><br><span class="line"></span><br><span class="line">=================================版本V2.0 API START===================================#</span><br><span class="line">v2_user_login:</span><br><span class="line">    path: /&#123;version&#125;/login</span><br><span class="line">    defaults: &#123; _controller: ApiBundle:V2\User\Center:login &#125;</span><br><span class="line">    methods: [GET, POST]</span><br><span class="line">    requirements:</span><br><span class="line">        version: 'v2(\.\d+)?'</span><br></pre></td></tr></table></figure>
<h5 id="请求监听器-1"><a href="#请求监听器-1" class="headerlink" title="请求监听器"></a>请求监听器</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Bundles</span>\<span class="title">ApiBundle</span>\<span class="title">Listener</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpKernel</span>\<span class="title">Event</span>\<span class="title">GetResponseEvent</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApiRequestListener</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onKernelRequest</span><span class="params">(GetResponseEvent $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!$event-&gt;isMasterRequest()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $request = $event-&gt;getRequest();</span><br><span class="line">        $attributes = $request-&gt;attributes;  </span><br><span class="line">        $version = <span class="keyword">isset</span>($attributes-&gt;get(<span class="string">'_route_params'</span>)[<span class="string">'version'</span>]) ? $attributes-&gt;get(<span class="string">'_route_params'</span>)[<span class="string">'version'</span>] : <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($version)) &#123;</span><br><span class="line">            $controller = $attributes-&gt;get(<span class="string">'_controller'</span>);</span><br><span class="line">            $delimiter = <span class="string">'::'</span>;</span><br><span class="line">            <span class="keyword">if</span> (strpos($controller, $delimiter) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (strpos($version, <span class="string">'.'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">                    $major = (int)substr($version, <span class="number">1</span>, strpos($version, <span class="string">'.'</span>));</span><br><span class="line">                    $minor = (int)substr($version, strpos($version, <span class="string">'.'</span>) + <span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $major = (int)$version;</span><br><span class="line">                    $minor = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">empty</span>($major) || $major === <span class="number">1</span> &amp;&amp; <span class="keyword">empty</span>($minor)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">list</span>($controllerName, $actionName) = explode($delimiter, $controller, <span class="number">2</span>);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">empty</span>($minor)) &#123;</span><br><span class="line">                    $actionName = substr($actionName, <span class="number">0</span>, <span class="number">-6</span>) . <span class="string">"M&#123;$minor&#125;"</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $request-&gt;attributes-&gt;set(<span class="string">'_controller'</span>, $controllerName . $delimiter . $actionName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>symfony</tag>
      </tags>
  </entry>
  <entry>
    <title>Symfony3 Doctrine2 CURD</title>
    <url>/Symfony/symfony-doctrine2-curd.html</url>
    <content><![CDATA[<div class="note danger"><p>在Symfony中调用EntityManger-&gt;flush()时,默认会开启一个事务,如果不想要开启事务,可以参考以下的方法</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 取得用户持久类</span></span><br><span class="line">$userRepository = <span class="keyword">$this</span>-&gt;getEntityManager()-&gt;getRepository(<span class="string">'CommonBundle:User'</span>);</span><br><span class="line"><span class="comment">// 获取用户</span></span><br><span class="line">$user = $userRepository-&gt;find(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 更新数据</span></span><br><span class="line">$updateData = [<span class="string">'nickname'</span> =&gt; <span class="string">'test'</span>];</span><br><span class="line"><span class="comment">// 插入数据</span></span><br><span class="line">$insertData = [<span class="string">'nickname'</span> =&gt; <span class="string">'xxxx'</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第一种方式：saveUser1 方法, 使用 EntityManager [flush] 来更新或插入(persist), 每次更新或插入会开启事务</span></span><br><span class="line"><span class="comment">// 更新</span></span><br><span class="line">$updateUser = $userRepository-&gt;saveUser1($user, $updateData);</span><br><span class="line"><span class="comment">// 插入</span></span><br><span class="line">$insertUser = $userRepository-&gt;saveUser1(<span class="string">'User'</span>, $insertData);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种方式：saveUser2 方法, 使用 EntityManager [update,insert] 来更新或插入, 每次更新或插入不会开启事务</span></span><br><span class="line"><span class="comment">// 更新</span></span><br><span class="line">$updateUser = $userRepository-&gt;saveUser2($user, $updateData);</span><br><span class="line"><span class="comment">// 插入</span></span><br><span class="line">$insertUser = $userRepository-&gt;saveUser2(<span class="string">'User'</span>, $insertData);</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Bundles\CommonBundle\Entity\UserRepository</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Bundles</span>\<span class="title">CommonBundle</span>\<span class="title">EntityRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">EntityRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UserRepository</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This class was generated by the Doctrine ORM. Add your own custom</span></span><br><span class="line"><span class="comment"> * repository methods below.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">EntityRepository</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> ENTITY_NAMESPACE = <span class="string">'Bundles\CommonBundle\Entity\\'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存用户信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \Bundles\CommonBundle\Entity\User $user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $data</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Bundles\CommonBundle\Entity\User|bool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saveUser1</span><span class="params">($user, $data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user = <span class="keyword">$this</span>-&gt;getEntityInstance($user, $data);</span><br><span class="line">        $em = <span class="keyword">$this</span>-&gt;getEntityManager();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $em-&gt;persist($user);</span><br><span class="line">            $em-&gt;flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>($e-&gt;getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存用户信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \Bundles\CommonBundle\Entity\User $user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $data</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Bundles\CommonBundle\Entity\User|bool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saveUser2</span><span class="params">($entity, $data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 更新</span></span><br><span class="line">            <span class="keyword">if</span> (is_object($entity) &amp;&amp; $entity-&gt;getId()) &#123;</span><br><span class="line">                $query = <span class="keyword">$this</span>-&gt;createQueryBuilder(<span class="string">'e'</span>)</span><br><span class="line">                    -&gt;where(<span class="string">"e.id = :eId"</span>)</span><br><span class="line">                    -&gt;setParameter(<span class="string">'eId'</span>, $entity-&gt;getId());</span><br><span class="line">                <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">                    $query-&gt;set(<span class="string">"e.&#123;$key&#125;"</span>, <span class="string">":&#123;$key&#125;"</span>)-&gt;setParameter($key, $val);</span><br><span class="line">                &#125;;</span><br><span class="line">                $query-&gt;update()-&gt;getQuery()-&gt;execute();</span><br><span class="line">                $entity = <span class="keyword">$this</span>-&gt;getEntityInstance($entity, $data);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> $entity;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 插入</span></span><br><span class="line">            $em = <span class="keyword">$this</span>-&gt;getEntityManager();</span><br><span class="line">            $entity = <span class="keyword">$this</span>-&gt;getEntityInstance($entity, $data);</span><br><span class="line">            $class = $em-&gt;getClassMetadata(get_class($entity));</span><br><span class="line">            $query = $em-&gt;getConnection()-&gt;createQueryBuilder();</span><br><span class="line">            <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">                <span class="keyword">if</span> ($val <span class="keyword">instanceof</span> \DateTime) &#123;</span><br><span class="line">                    $val = $val-&gt;format(<span class="string">'Y-m-d H:i:s'</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $query-&gt;setValue(<span class="string">"&#123;$class-&gt;columnNames[$key]&#125;"</span>, <span class="string">":&#123;$key&#125;"</span>)-&gt;setParameter($key, $val);</span><br><span class="line">            &#125;;</span><br><span class="line">            $result = $query-&gt;insert($class-&gt;getTableName())-&gt;execute();</span><br><span class="line">            <span class="keyword">if</span> ($result) &#123;</span><br><span class="line">                $data[<span class="string">'id'</span>] = $class-&gt;idGenerator-&gt;generate($em, $entity);</span><br><span class="line">                $entity = $em-&gt;getUnitOfWork()-&gt;createEntity($class-&gt;name, $data);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> $entity;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>($e-&gt;getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取得初始化数据后的实例</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string|object $entity 实例对象或命名空间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $initData 初始化数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getEntityInstance</span><span class="params">($entity, $initData = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_string($entity)) &#123;</span><br><span class="line">            $entity = <span class="keyword">self</span>::ENTITY_NAMESPACE . $entity;</span><br><span class="line">            $instance = <span class="keyword">new</span> $entity();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $instance = $entity;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $reflectionClass = <span class="keyword">new</span> \ReflectionClass($entity);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($initData <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($reflectionClass-&gt;hasProperty($key)) &#123;</span><br><span class="line">                $methodName = <span class="string">'set'</span> . ucfirst($key);</span><br><span class="line">                <span class="keyword">if</span> ($reflectionClass-&gt;hasMethod($methodName)) &#123;</span><br><span class="line">                    $instance-&gt;$methodName($value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>更新或插入,可以使用以下方法</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Bundles</span>\<span class="title">CommonBundle</span>\<span class="title">EntityRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">EntityRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AbstractRepository</span> <span class="keyword">extends</span> <span class="title">EntityRepository</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存实体</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object|string $entity</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * $userRepository = $this-&gt;EntityManager()-&gt;getRepository('User');</span></span><br><span class="line"><span class="comment">     * // 插入</span></span><br><span class="line"><span class="comment">     * $user = $userRepository-&gt;saveEntity(['nickname' =&gt; 'test']);</span></span><br><span class="line"><span class="comment">     * // 更新</span></span><br><span class="line"><span class="comment">     * $user = $userRepository-&gt;findOneById(1);</span></span><br><span class="line"><span class="comment">     * $user = $userRepository-&gt;saveEntity(['nickname' =&gt; 'testabc'], $user);</span></span><br><span class="line"><span class="comment">     * // 取得初始化数据后的实体</span></span><br><span class="line"><span class="comment">     * $user = $userRepository-&gt;getEntityInstance('User', ['nickname' =&gt; 'hello']);</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> false|object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saveEntity</span><span class="params">($data, $entity = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $isInsert = is_object($entity) ? <span class="keyword">false</span> : <span class="keyword">true</span>;</span><br><span class="line">            $em = <span class="keyword">$this</span>-&gt;getEntityManager();</span><br><span class="line">            $entity = <span class="keyword">$this</span>-&gt;getEntityInstance($entity, $data);</span><br><span class="line">            $isInsert &amp;&amp; $em-&gt;persist($entity);</span><br><span class="line">            $em-&gt;flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $entity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取得初始化数据后的实例</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object|string $entity 实例对象或实体名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $initData 初始化数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getEntityInstance</span><span class="params">($entity, $initData = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_object($entity)) &#123;</span><br><span class="line">            $instance = $entity;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $classMetadata = <span class="keyword">$this</span>-&gt;getClassMetadata();</span><br><span class="line">            $entity = is_string($entity) ? <span class="string">"&#123;$classMetadata-&gt;namespace&#125;\\&#123;$entity&#125;"</span> : $classMetadata-&gt;getName();</span><br><span class="line">            $instance = <span class="keyword">new</span> $entity();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $reflectionClass = <span class="keyword">new</span> \ReflectionClass($entity);</span><br><span class="line">        <span class="keyword">foreach</span> ($initData <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($reflectionClass-&gt;hasProperty($key)) &#123;</span><br><span class="line">                $methodName = <span class="string">'set'</span> . ucfirst($key);</span><br><span class="line">                <span class="keyword">if</span> ($reflectionClass-&gt;hasMethod($methodName)) &#123;</span><br><span class="line">                    $instance-&gt;$methodName($value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Symfony</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>symfony</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux 使用 LVM 的方式进行分区/挂载/硬盘扩容</title>
    <url>/Linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion.html</url>
    <content><![CDATA[<h5 id="LVM-分区"><a href="#LVM-分区" class="headerlink" title="LVM 分区"></a>LVM 分区</h5><ol>
<li><code>fdisk -l</code> 查看本地硬盘使用情况<br> <img src="/uploads/linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion/uyR5oVF0MpnrXRexK6w1bFO113hwOIjr.png" style="display:inline-block"></li>
<li>查看内核 <code>uname -a</code><br> <img src="/uploads/linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion/VHAyQzLK5hfY8DJGhxky3Pjk5whlO7Ao.png" style="display:inline-block"><br> <code>ps：lvm的安装, 首先加载 device-mapper 模块, 从linux内核2.6.9开始, device-mapper 模块就已经包含在内, 所以只需加载, 不需要安装</code></li>
<li>安装 device-mapper 模块  <code>yum install lvm2 device-mapper</code>   (2.6.9以后版本不需要安装)<br> <img src="/uploads/linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion/pvWmMOdwJHr1pTboHpzJmyaigp1Cvj4j.png" style="display:inline-block"></li>
<li>加载 mapper 模块, 先查看模块是否已经加载<br> <img src="/uploads/linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion/h0TN8oAmcO4YQ9W7eh7SmyncuXYTHASM.png" style="display:inline-block"><br> 若未加载, 运行命令 <code>modprobe dm_mod</code><br> <img src="/uploads/linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion/My29Ex3v9B1vrQjGhqoiAvNPYkWU8S9g.png" style="display:inline-block"><a id="more"></a></li>
<li>创建lvm分区, 运行 <code>fdisk /dev/vdb</code>, 然后输入 <code>l</code><br> <img src="/uploads/linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion/ViuLAcccK5Z9fY69OMiLeYMKlMTU1bXZ.png" style="display:inline-block"><br> 可以看到 lvm 分区格式为 8e</li>
<li>继续输入命令：<code>n</code> -&gt; <code>p</code>-&gt; <code>1</code> -&gt; 回车 -&gt; <code>+20G</code> -&gt; <code>p</code> -&gt; <code>t</code> -&gt; <code>8e</code> -&gt; <code>p</code><br> <img src="/uploads/linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion/df16Aud5K3vXoiEL9T09vUxVs8mXchor.png" style="display:inline-block"></li>
<li>保存退出<br> <img src="/uploads/linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion/ywigZ2M3kW71X1RvuUUfBqdZOPcuX1dz.png" style="display:inline-block"></li>
<li>创建逻辑卷组以及逻辑卷等<br> <img src="/uploads/linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion/GGtLN1t86R9WRVgRwfi1FQLUxgD3GPBg.png" style="display:inline-block"></li>
<li>格式化逻辑卷<br> <img src="/uploads/linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion/1Jo3L0Fv2PTJcA1IRWTvjk6takcP6DqR.png" style="display:inline-block"></li>
<li>设置自动挂载, 并查看分区<br><img src="/uploads/linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion/8PcMnNkYVDxB5u9kAy1erT0HCHwodMns.png" style="display:inline-block"></li>
<li>重启服务器 <code>reboot</code>, 到此 lvm 新建分区就结束了</li>
</ol>
<h5 id="挂载"><a href="#挂载" class="headerlink" title="挂载"></a>挂载</h5><blockquote><p>将 /www 下的项目移动到 /mnt, 并将磁盘挂载到 /www 目录下</p>
</blockquote>
<ol>
<li><p>将 /www 目录下的所有文件移动到 /mnt 目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mv /www/* /mnt</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置自动挂载, 并查看分区</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'/dev/ms/mslg1 /www ext4 defaults 0 0'</span> &gt;&gt; /etc/fstab</span><br><span class="line">mount /www</span><br><span class="line">df -lh</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="扩容硬盘到已有逻辑卷"><a href="#扩容硬盘到已有逻辑卷" class="headerlink" title="扩容硬盘到已有逻辑卷"></a>扩容硬盘到已有逻辑卷</h5><ol>
<li>创建新的分区<br> <img src="/uploads/linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion/ZZUIEAIRGM54fe7e3QZQzi0ogWlwjHxH.png" style="display:inline-block"><br> <img src="/uploads/linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion/gVSKdUJwK4KPjstBK95BiM02nzOlMLKJ.png" style="display:inline-block"></li>
<li>重启服务器 <code>reboot</code></li>
<li>创建物理卷, 并加入卷组, 重新规定 /dev/ms/mslg1 的大小<br> <img src="/uploads/linux/linux-lvm-partitioning-and-mounting-and-hard-disk-expansion/Xfwz0bvI42kV93jfrsXrBkvCVFngGE1J.png" style="display:inline-block"></li>
</ol>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux 相关问题</title>
    <url>/Linux/linux-questions.html</url>
    <content><![CDATA[<div class="note danger"><p>xshell 连接虚拟机安装的 Linux 慢</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ssh的服务端在连接时会自动检测dns环境是否一致导致响应慢</span></span><br><span class="line">vi /etc/ssh/sshd_config</span><br><span class="line">UseDNS yes <span class="comment">#默认为注释行</span></span><br><span class="line">UseDNS no  <span class="comment">#把注释打开,然后重启ssh服务即可</span></span><br><span class="line"> </span><br><span class="line">/bin/systemctl restart sshd.service</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>Centos Yum install 提示 Could not resolve host: mirrors.shuosc.org; Unknown error</p></div>
<blockquote><p><code>http://mirrors.shuosc.org/centos/7.4.1708/os/x86_64/repodata/repomd.xml: [Errno 14] curl#6 - &quot;Could not resolve host: mirrors.shuosc.org; Unknown error&quot;</code><br>原因：DNS服务器错误</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/resolv.conf</span><br><span class="line"><span class="comment">#新增一个DNS</span></span><br><span class="line">nameserver 218.85.157.99</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p>Linux磁盘空间被未知资源耗尽</p></div>
<blockquote><p>在Linux中, 当使用rm在linux上删除了大文件, 但是如果有进程打开了这个大文件, 却没有关闭这个文件的句柄, 那么 linux 内核还是不会释放这个文件的磁盘空间, 最后造成磁盘空间占用100%, 整个系统无法正常运行, 这种情况下, 通过 <code>df</code> 和 <code>du</code> 命令查找的磁盘空间, 两者是无法匹配的, 可能 <code>df</code> 显示磁盘 100%, 而 <code>du</code> 查找目录的磁盘容量占用却很小, 遇到这种情况, 基本可以断定是某些大文件被某些程序占用了, 并且这些大文件已经被删除了, 但是对应的文件句柄没有被某些程序关闭, 造成内核无法收回这些文件占用的空间, 使用 <code>lsof -n | grep deleted</code> 命令, 打印出所有针对已删除文件的读写操作, 这类操作是无效的, 也正是磁盘空间莫名消失的根本原因, 使用 <code>kill -9 PID</code> 只需把进程删掉就能释放空间</p>
</blockquote>  
<p>  <img src="/uploads/linux/linux-questions/O4i8VoLwTRspVkCTnekc0TCr4yFpRtwl.png" style="display:inline-block"></p>
<!-- more -->
<div class="note danger"><p><code>Failed: No space left on device</code> 问题 (磁盘空间满了或 磁盘的 <code>Inode usage</code> [索引节点] 耗尽)<br>举个PHP碰到的问题,  a 页面设置 session 后, b 页面无法获取, 即无法生成session文件</p></div>
<ol>
<li>运行 <code>df -lh</code>, 发现磁盘并没有满<br><img src="/uploads/linux/linux-questions/bI9lWnBD5jpxfBaWZkKMujOpsBZesrqh.png" style="display:inline-block"></li>
<li>运行 <code>df -i</code>, 发现 <code>/dev/vda1</code> 的 <code>Inodes</code> 已经耗尽<br><img src="/uploads/linux/linux-questions/RAEPq0PSGRVwCujunpqikn6IhRcDuzal.png" style="display:inline-block"></li>
<li>运行 <code>du -sh *</code>  看哪个目录占用空间大, 再使用 <code>ls | wc -l</code> 查看目录下的文件,  删除文件即可</li>
<li>目前仅在两种情况下发现 <code>Inode usage</code> 耗尽<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#1. /tmp 下的 session 文件过多</span></span><br><span class="line"><span class="comment">#2. /var/spool/clientmqueue 文件过多, 如果系统中有用户开启了 cron, 而 cron 执行的程序有输出内容, 输出内容会以邮件的形式发给 cron 的用户, </span></span><br><span class="line"><span class="comment">#而 sendemail 没有启动所以就产生了这些文件, 为防止这种情况出现, 在 cron 的自动执行语句后加上 &gt; /dev/null 2&gt;&amp;1</span></span><br><span class="line">例：*/1 * * * * /bin/sh mscron.sh &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">当 clientmqueue 文件过多时, 使用 <span class="string">"rm -rf *"</span> 时候会提示<span class="string">"-bash:/bin/rm:Argument list too long"</span> 意思是参数大长, rm 干不了, </span><br><span class="line">可以用 <span class="string">"ls | xargs rm -f"</span> 命令删除</span><br></pre></td></tr></table></figure>
</li>
</ol>
<div class="note danger"><p>firewalld 问题</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 问题</span></span><br><span class="line">Active: failed (Result: timeout) </span><br><span class="line"><span class="comment"># 解决</span></span><br><span class="line">systemctl stop firewalld </span><br><span class="line">pkill -f firewalld </span><br><span class="line">systemctl start firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题</span></span><br><span class="line">WARNING: AllowZoneDrifting is enabled. This is considered an insecure configuration option. It will be removed <span class="keyword">in</span> a future release. Please consider disabling it now.</span><br><span class="line"><span class="comment"># 解决</span></span><br><span class="line">vim /etc/firewalld/firewalld.conf </span><br><span class="line">AloowZoneDrifting=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题</span></span><br><span class="line">Failed to start firewalld.service: Unit is masked.</span><br><span class="line"><span class="comment"># 解决</span></span><br><span class="line">systemctl unmask firewalld</span><br><span class="line">systemctl start firewalld</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>centos</tag>
        <tag>linux</tag>
        <tag>vmware</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP openssl 签名/验签,非对称加解密</title>
    <url>/PHP/php-openssl.html</url>
    <content><![CDATA[<div class="note danger"><p>一、公钥加密<br>    假设一下,我找了两个数字,一个是1,一个是2.我喜欢2这个数字,就保留起来,不告诉你们(私钥),然后我告诉大家,1是我的公钥.<br>    我有一个文件,不能让别人看,我就用1加密了.别人找到了这个文件,但是他不知道2就是解密的私钥啊,所以他解不开,只有我可以用<br>    数字2,就是我的私钥,来解密.这样我就可以保护数据了.<br>    我的好朋友x用我的公钥1加密了字符a,加密后成了b,放在网上.别人偷到了这个文件,但是别人解不开,因为别人不知道2就是我的私钥,<br>    只有我才能解密,解密后就得到a.这样,我们就可以传送加密的数据了.</p>
<p> 二、私钥签名<br>    如果我用私钥加密一段数据（当然只有我可以用私钥加密,因为只有我知道2是我的私钥),结果所有的人都看到我的内容了,因为他们都知<br>    道我的公钥是1,那么这种加密有什么用处呢？<br>    但是我的好朋友x说有人冒充我给他发信.怎么办呢？我把我要发的信,内容是c,用我的私钥2,加密,加密后的内容是d,发给x,再告诉他<br>    解密看是不是c.他用我的公钥1解密,发现果然是c.<br>    这个时候,他会想到,能够用我的公钥解密的数据,必然是用我的私钥加的密.只有我知道我得私钥,因此他就可以确认确实是我发的东西.<br>    这样我们就能确认发送方身份了.这个过程叫做数字签名.当然具体的过程要稍微复杂一些.用私钥来加密数据,用途就是数字签名.</p>
<p>总结：公钥和私钥是成对的,它们互相解密.<br>    公钥加密,私钥解密.<br>    私钥数字签名,公钥验证.</p></div>
<a id="more"></a>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Openssl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $config = [</span><br><span class="line">        <span class="string">'digest_alg'</span> =&gt; <span class="string">'sha1'</span>,</span><br><span class="line">        <span class="string">'private_key_bits'</span> =&gt; <span class="number">2048</span>,</span><br><span class="line">        <span class="string">'private_key_type'</span> =&gt; OPENSSL_KEYTYPE_RSA,</span><br><span class="line">        <span class="comment">// 这里临时指定openssl.cnf的路径,参考http://php.net/manual/zh/openssl.installation.php进行配置</span></span><br><span class="line">        <span class="string">'config'</span> =&gt; <span class="string">'D:/web/apache/conf/openssl.cnf'</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $privateKeyFile = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> $publicKeyFile = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> $privateKey = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> $publicKey = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造函数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $publicKeyFile 私钥文件(生成私钥/签名/解密时传入)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $privateKeyFile 公钥文件(生成公钥/验签/加密时传入)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool $create 是否重新生成</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($privateKeyFile = <span class="string">''</span>, $publicKeyFile = <span class="string">''</span>, $create = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;privateKeyFile = $privateKeyFile;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;publicKeyFile = $publicKeyFile;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (file_exists($privateKeyFile) &amp;&amp; file_exists($publicKeyFile) &amp;&amp; !$create) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;getPrivateKey();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;getPublicKey();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $res = openssl_pkey_new(<span class="keyword">$this</span>-&gt;config);                             <span class="comment">// 生成公钥和私钥</span></span><br><span class="line">            openssl_pkey_export($res, <span class="keyword">$this</span>-&gt;privateKey, <span class="keyword">null</span>, <span class="keyword">$this</span>-&gt;config);  <span class="comment">// 提取私钥</span></span><br><span class="line">            $pubKey = openssl_pkey_get_details($res);                           <span class="comment">// 提取公钥</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;publicKey = $pubKey[<span class="string">'key'</span>];</span><br><span class="line">            file_put_contents(<span class="keyword">$this</span>-&gt;privateKeyFile, <span class="keyword">$this</span>-&gt;privateKey);</span><br><span class="line">            file_put_contents(<span class="keyword">$this</span>-&gt;publicKeyFile, <span class="keyword">$this</span>-&gt;publicKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成签名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $str 签名材料</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $code 签名编码(base64/hex)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">generateSign</span><span class="params">($str, $code = <span class="string">'base64'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $sign = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (openssl_sign($str, $signature, <span class="keyword">$this</span>-&gt;privateKey)) &#123;</span><br><span class="line">            $sign = <span class="keyword">$this</span>-&gt;encode($signature, $code);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $sign;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证签名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $str 签名材料</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $sign 签名值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $code 签名编码(base64/hex)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verifySign</span><span class="params">($str, $sign, $code = <span class="string">'base64'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $res = <span class="keyword">false</span>;</span><br><span class="line">        $sign = <span class="keyword">$this</span>-&gt;decode($sign, $code);</span><br><span class="line">        <span class="keyword">if</span> ($sign !== <span class="keyword">false</span> &amp;&amp; openssl_verify($str, $sign, <span class="keyword">$this</span>-&gt;publicKey) == <span class="number">1</span>) &#123;</span><br><span class="line">            $res = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对数据编码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $str</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $code</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">encode</span><span class="params">($str, $code)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (strtolower($code)) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'base64'</span>:</span><br><span class="line">                $str = base64_encode($str);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'hex'</span>:</span><br><span class="line">                $str = bin2hex($str);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                $str = <span class="string">''</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对数据解码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $str</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $code</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">decode</span><span class="params">($str, $code)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (strtolower($code)) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'base64'</span>:</span><br><span class="line">                $str = base64_decode($str);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'hex'</span>:</span><br><span class="line">                $str = preg_match(<span class="string">'/^[0-9a-fA-F]+$/i'</span>, $str) ? pack(<span class="string">'H*'</span>, $str) : <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                $str = <span class="string">''</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $str 明文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $code 密文编码(base64/hex)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $padding 填充方式(貌似php有bug,所以目前仅支持OPENSSL_PKCS1_PADDING)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string|bool 密文</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">encrypt</span><span class="params">($str, $code = <span class="string">'base64'</span>, $padding = OPENSSL_PKCS1_PADDING)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;checkPadding($padding, <span class="string">'en'</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'padding error'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (openssl_public_encrypt($str, $result, <span class="keyword">$this</span>-&gt;publicKey, $padding)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;encode($result, $code);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $str 密文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $code 密文编码(base64/hex)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $padding 填充方式(OPENSSL_PKCS1_PADDING / OPENSSL_NO_PADDING)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string 明文</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decrypt</span><span class="params">($str, $code = <span class="string">'base64'</span>, $padding = OPENSSL_PKCS1_PADDING)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $str = <span class="keyword">$this</span>-&gt;decode($str, $code);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;checkPadding($padding, <span class="string">'de'</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'padding error'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($str !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (openssl_private_decrypt($str, $result, <span class="keyword">$this</span>-&gt;privateKey, $padding)) &#123;</span><br><span class="line">                $str = <span class="string">''</span> . $result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检测填充类型</span></span><br><span class="line"><span class="comment">     * 加密只支持PKCS1_PADDING</span></span><br><span class="line"><span class="comment">     * 解密支持PKCS1_PADDING和NO_PADDING</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int 填充模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string 加密en/解密de</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">checkPadding</span><span class="params">($padding, $type)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($type == <span class="string">'en'</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> ($padding) &#123;</span><br><span class="line">                <span class="keyword">case</span> OPENSSL_PKCS1_PADDING:</span><br><span class="line">                    $res = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    $res = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> ($padding) &#123;</span><br><span class="line">                <span class="keyword">case</span> OPENSSL_PKCS1_PADDING:</span><br><span class="line">                <span class="keyword">case</span> OPENSSL_NO_PADDING:</span><br><span class="line">                    $res = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    $res = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取私钥KEY</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrivateKey</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;readFile(<span class="keyword">$this</span>-&gt;privateKeyFile);</span><br><span class="line">        <span class="keyword">if</span> ($content) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;privateKey = openssl_pkey_get_private($content);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取公钥KEY</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getPublicKey</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;readFile(<span class="keyword">$this</span>-&gt;publicKeyFile);</span><br><span class="line">        <span class="keyword">if</span> ($content) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;publicKey = openssl_get_publickey($content);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取文件内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $filePath 文件路径</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">readFile</span><span class="params">($filePath)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!file_exists($filePath)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"The file &#123;$filePath&#125; is not exists"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $content = file_get_contents($filePath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$opensslObj = <span class="keyword">new</span> Openssl(<span class="string">'./test_pri.pem'</span>, <span class="string">'./test_pub.pem'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 签名验证</span></span><br><span class="line">$str = <span class="string">'test'</span>;</span><br><span class="line">$sign = $opensslObj-&gt;generateSign($str);                <span class="comment">// 私钥生成签名</span></span><br><span class="line">$verifyResult = $opensslObj-&gt;verifySign($str, $sign);   <span class="comment">// 公钥验证签名</span></span><br><span class="line">var_dump(<span class="string">"私钥生成签名, 公钥验证签名, 验证结果：&#123;$verifyResult&#125;"</span>);</span><br><span class="line"></span><br><span class="line">$encryptStr = $opensslObj-&gt;encrypt($str);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"原字符串：&#123;$str&#125;&lt;br /&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"公钥加密后：&#123;$encryptStr&#125;&lt;br /&gt;"</span>;</span><br><span class="line">$decryptStr = $opensslObj-&gt;decrypt($encryptStr);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"私钥解密后：&#123;$decryptStr&#125;"</span>;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ 安装</title>
    <url>/RabbitMQ/rabbitmq-install.html</url>
    <content><![CDATA[<div class="note danger"><p>环境：Linux Centos7</p></div>
<h5 id="安装-RabbitMQ-前-需先安装-Erlang"><a href="#安装-RabbitMQ-前-需先安装-Erlang" class="headerlink" title="安装 RabbitMQ 前, 需先安装 Erlang"></a>安装 RabbitMQ 前, 需先安装 Erlang</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#若无法使用 yum 安装 erlang, 去  下载对应的 rpm </span></span><br><span class="line">yum install erlang</span><br><span class="line"><span class="comment">#若无法使用 yum 安装 rabbitmq-server, 去  下载对应的 rpm[ </span></span><br><span class="line">yum install rabbitmq-server-3.7.2-1.el7.noarch.rpm</span><br></pre></td></tr></table></figure>
<h5 id="测试-erlang-是否安装成功"><a href="#测试-erlang-是否安装成功" class="headerlink" title="测试 erlang 是否安装成功"></a>测试 erlang 是否安装成功</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost rabbitmq]<span class="comment"># erl</span></span><br><span class="line">Erlang/OTP 20 [erts-9.2] [<span class="built_in">source</span>] [64-bit] [smp:1:1] [ds:1:1:10] [async-threads:10] [hipe] [kernel-poll:<span class="literal">false</span>]</span><br><span class="line"> </span><br><span class="line">Eshell V9.2  (abort with ^G)</span><br><span class="line">1&gt; 9+3.</span><br><span class="line">12</span><br><span class="line">2&gt; halt().</span><br><span class="line">[root@localhost rabbitmq]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h5 id="RabiitMQ-常用命令"><a href="#RabiitMQ-常用命令" class="headerlink" title="RabiitMQ 常用命令"></a>RabiitMQ 常用命令</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#启动 RabbitMQ Server</span></span><br><span class="line">service rabbitmq-server start</span><br><span class="line"><span class="comment">#停止 RabiitMQ Server</span></span><br><span class="line">service rabbitmq-server stop</span><br><span class="line"><span class="comment">#查看 RabiitMQ Server 状态</span></span><br><span class="line">rabbitmqctl status</span><br></pre></td></tr></table></figure>
<h5 id="安装-php-amqplib-客户端，参考地址"><a href="#安装-php-amqplib-客户端，参考地址" class="headerlink" title="安装 php-amqplib 客户端，参考地址"></a>安装 php-amqplib 客户端，<a href="http://www.rabbitmq.com/tutorials/tutorial-one-php.html" target="_blank" rel="noopener">参考地址</a></h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#添加一个composer.json 到项目中</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"require"</span> : &#123;</span><br><span class="line">      <span class="string">"php-amqplib/php-amqplib"</span> : <span class="string">"&gt;= 2.6.1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#运行命令</span></span><br><span class="line">composer install</span><br></pre></td></tr></table></figure>
<h5 id="demo-示例，在项目目录下新建-send-php-和-receive-php"><a href="#demo-示例，在项目目录下新建-send-php-和-receive-php" class="headerlink" title="demo 示例，在项目目录下新建 send.php 和 receive.php"></a>demo 示例，在项目目录下新建 send.php 和 receive.php</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#send.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 创建一个到 RabbitMQ 服务器的连接</span></span><br><span class="line">    $connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'localhost'</span>, <span class="number">5672</span>, <span class="string">'guest'</span>, <span class="string">'guest'</span>);</span><br><span class="line">    $channel = $connection-&gt;channel();</span><br><span class="line">    <span class="comment">// 声明一个 hello 队列[不存在时才会创建]</span></span><br><span class="line">    $channel-&gt;queue_declare(<span class="string">'hello'</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 发布消息到队列中</span></span><br><span class="line">    $msg = <span class="keyword">new</span> AMQPMessage(<span class="string">'Hello World!'</span>);</span><br><span class="line">    $channel-&gt;basic_publish($msg, <span class="string">''</span>, <span class="string">'hello'</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">" [x] Sent 'Hello World!'\n"</span>;</span><br><span class="line">    <span class="comment">// 关闭队列和连接</span></span><br><span class="line">    $channel-&gt;close();</span><br><span class="line">    $connection-&gt;close();</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $e-&gt;getMessage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#receive.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 创建一个到 RabbitMQ 服务器的连接</span></span><br><span class="line">    $connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'localhost'</span>, <span class="number">5672</span>, <span class="string">'guest'</span>, <span class="string">'guest'</span>);</span><br><span class="line">    $channel = $connection-&gt;channel();</span><br><span class="line">    <span class="comment">// 声明一个 hello 队列</span></span><br><span class="line">    $channel-&gt;queue_declare(<span class="string">'hello'</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">' [*] Waiting for messages. To exit press CTRL+C'</span>, <span class="string">"\n"</span>;</span><br><span class="line">    $callback = <span class="function"><span class="keyword">function</span><span class="params">($msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">" [x] Received "</span>, $msg-&gt;body, <span class="string">"\n"</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 获取队列消息</span></span><br><span class="line">    $channel-&gt;basic_consume(<span class="string">'hello'</span>, <span class="string">''</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, $callback);</span><br><span class="line">    <span class="keyword">while</span>(count($channel-&gt;callbacks)) &#123;</span><br><span class="line">        $channel-&gt;wait();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $e-&gt;getMessage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在终端中,先运行 receive.php </span></span><br><span class="line">php receive.php</span><br><span class="line"><span class="comment">#再运行 send.php</span></span><br><span class="line">php send.php</span><br></pre></td></tr></table></figure>
<h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><blockquote><p>查看 RabbitMQ Server 状态 时, 报 Error: unable to perform an operation on node ‘rabbit@localhost’. Please see diagnostics information and suggestions below. 错误</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl restart rabbitmq-server.service</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>RabbitMQ</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>rabbitmq</tag>
      </tags>
  </entry>
  <entry>
    <title>服务端及时推送消息给客户端</title>
    <url>/WorkerMan/workerman-server-pushes-message-to-client-in-time.html</url>
    <content><![CDATA[<div class="note danger"><p>场景：</p>
<ol>
<li>在商户后台, 若有用户下单, 实时通知商户[Ajax 轮询, 并不是实时]</li>
<li>后台批量导入产品, 每成功导入一个, 就通知前台, 显示导入成功</li>
</ol>
<p>实现原理：</p>
<ol>
<li>服务端 建立一个 Websocket Worker, 用于维护客户端长连接</li>
<li>服务端 Websocket Worker 启动后, 内部建立一个 Text Worker, 由于 Websocket Worker 与 Text Worker 是同一个进程, 方便共享客户端连接</li>
<li>某个独立的后台系统, 通过 Text 协议与 Text Worker 通讯</li>
<li>Text Worker 操作 Websocket Worker 完成数据推送</li>
</ol>
<p>执行流程：</p>
<ol>
<li>启动 start.php, 运行命令：php start.php start -d</li>
<li>浏览器打开 client.html, 支持开启多个, 等于绑定UID, 并接收服务端推送</li>
<li>运行 send.php, 点击下单, client.html 会收到服务端推送的消息</li>
</ol></div>
<a id="more"></a>
<blockquote><p>服务端启动文件 start.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Workerman</span>\<span class="title">Worker</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'./Workerman-master/Autoloader.php'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 初始化一个Websocket Worker容器,监听1234端口</span></span><br><span class="line">$worker = <span class="keyword">new</span> Worker(<span class="string">'websocket://0.0.0.0:1234'</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 注意这里进程数必须设置为1,否则会报端口占用错误(php 7可以设置进程数大于1,前提是$inner_text_worker-&gt;reusePort = true)</span></span><br><span class="line">$worker-&gt;count = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// worker进程启动后创建一个Text Worker以便打开一个内部通讯端口</span></span><br><span class="line">$worker-&gt;onWorkerStart = <span class="function"><span class="keyword">function</span><span class="params">($worker)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 开启一个内部端口,方便内部系统推送数据,Text协议格式 文本 + 换行符</span></span><br><span class="line">    $innerTextWorker = <span class="keyword">new</span> Worker(<span class="string">'text://0.0.0.0:5678'</span>);</span><br><span class="line">    $innerTextWorker-&gt;onMessage = <span class="function"><span class="keyword">function</span><span class="params">($connection, $buffer)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $data = json_decode($buffer, <span class="keyword">true</span>);</span><br><span class="line">        $ret = sendToAll($data[<span class="string">'order_num'</span>]);</span><br><span class="line">        $connection-&gt;send($ret ? <span class="string">'success'</span> : <span class="string">'fail'</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 启用监听5678端口</span></span><br><span class="line">    $innerTextWorker-&gt;listen();</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 新增加一个属性,用来保存uid到connection的映射</span></span><br><span class="line">$worker-&gt;uidConnections = [];</span><br><span class="line"><span class="comment">// 当有客户端发来消息时执行的回调函数</span></span><br><span class="line">$worker-&gt;onMessage = <span class="function"><span class="keyword">function</span><span class="params">($connection, $data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $worker;</span><br><span class="line">    <span class="comment">// 判断当前客户端是否已经验证,即是否设置了uid</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($connection-&gt;uid)) &#123;</span><br><span class="line">        <span class="comment">// 没验证的话把第一个包当做uid</span></span><br><span class="line">        $connection-&gt;uid = $data;</span><br><span class="line">        <span class="comment">// 保存uid到connection的映射,这样可以方便的通过uid查找connection,实现针对特定uid推送数据</span></span><br><span class="line">        $worker-&gt;uidConnections[$connection-&gt;uid][] = $connection;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 当有客户端连接断开时</span></span><br><span class="line">$worker-&gt;onClose = <span class="function"><span class="keyword">function</span><span class="params">($connection)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $worker;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($connection-&gt;uid)) &#123;</span><br><span class="line">        <span class="comment">// 连接断开时删除映射</span></span><br><span class="line">        <span class="keyword">unset</span>($worker-&gt;uidConnections[$connection-&gt;uid]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 向所有验证的用户推送数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendToAll</span><span class="params">($message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $worker;</span><br><span class="line">    <span class="keyword">foreach</span>($worker-&gt;uidConnections <span class="keyword">as</span> $connections) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($connections <span class="keyword">as</span> $connection) &#123;</span><br><span class="line">            $connection-&gt;send($message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 针对uid推送数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendToUid</span><span class="params">($uid, $message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $worker;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($worker-&gt;uidConnections[$uid])) &#123;</span><br><span class="line">        $connection = $worker-&gt;uidConnections[$uid];</span><br><span class="line">        $connection-&gt;send($message);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 运行所有的worker</span></span><br><span class="line">Worker::runAll();</span><br></pre></td></tr></table></figure>
<blockquote><p>前端绑定UID并接收推送的JS, client.html</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">'ws://192.168.50.82:1234'</span>);</span></span><br><span class="line"><span class="javascript">    ws.onopen = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> uid = <span class="number">1</span>;</span></span><br><span class="line"><span class="undefined">        ws.send(uid);</span></span><br><span class="line"><span class="undefined">    &#125;;</span></span><br><span class="line"><span class="javascript">    ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.write(e.data + <span class="string">'&lt;br /&gt;'</span>);</span></span><br><span class="line"><span class="undefined">    &#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote><p>后端推送消息的代码, send.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> ($_SERVER[<span class="string">'REQUEST_METHOD'</span>] === <span class="string">'POST'</span>) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户下单,实时通知后台</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 1,建立socket连接到内部推送端口</span></span><br><span class="line">    $client = stream_socket_client(<span class="string">'tcp://127.0.0.1:5678'</span>, $errno, $errmsg, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 2,推送的数据</span></span><br><span class="line">    $data = [<span class="string">'order_num'</span> =&gt; mt_rand(<span class="number">1</span>, <span class="number">9999</span>)];</span><br><span class="line">    <span class="comment">// 3,发送数据,注意5678端口是Text协议的端口,Text协议需要在数据末尾加上换行符</span></span><br><span class="line">    fwrite($client, json_encode($data) . <span class="string">"\n"</span>);</span><br><span class="line">    <span class="comment">// 4,读取推送结果</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'订单编号：'</span> . $data[<span class="string">'order_num'</span>] . <span class="string">', 推送结果：'</span> . fread($client, <span class="number">8192</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=<span class="string">"send.php"</span> method=<span class="string">"post"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> value=<span class="string">"下单"</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>WorkerMan</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>gatewayworker</tag>
        <tag>workerman</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 自定义函数</title>
    <url>/MySQL/mysql-custom-functions.html</url>
    <content><![CDATA[<div class="note danger"><p>自定义函数获取两点之间距离, <a href="/Symfony/symfony-doctrine2-dql-user-defined-functions.html">Symfony 定义GLength 的DQL</a></p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#语法</span></span><br><span class="line">GLength(GeomFromText(CONCAT(<span class="string">'LineString('</span>, in_from_x, <span class="string">' '</span>, in_from_y, <span class="string">','</span>, in_to_x, <span class="string">' '</span>, in_to_y, <span class="string">')'</span>))) / 0.0000092592666666667</span><br><span class="line"><span class="comment">#样例</span></span><br><span class="line">GLength(GeomFromText(CONCAT(<span class="string">'LineString(25.44433087228 119.01171736304,'</span>, user_latitude, <span class="string">' '</span>, user_longitude, <span class="string">')'</span>))) / 0.0000092592666666667</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>phpmyadmin 导入大文件</title>
    <url>/PHP/php-phpmyadmin.html</url>
    <content><![CDATA[<ol>
<li>重命名根目录下的 config.simple.inc.php 为 config.inc.php</li>
<li>根目录新建 import 和 save 文件夹</li>
<li>将 SQL文件上传到 import 目录下</li>
<li>进入 phpmyadmin -&gt; 导入 -&gt; 选择 从网站服务器上传文件夹import/中选择 <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># config.inc.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$cfg[<span class="string">'UploadDir'</span>] = <span class="string">'import'</span>;</span><br><span class="line">$cfg[<span class="string">'SaveDir'</span>] = <span class="string">'save'</span>;</span><br></pre></td></tr></table></figure>
</li>
</ol>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>Symfony 整合 GatewayWorker 碰到的问题</title>
    <url>/Symfony/symfony-integration-gatewayworker-questions.html</url>
    <content><![CDATA[<div class="note danger"><p>Error while sending QUERY packet 错误</p></div>
<blockquote><p>MySQL 的 <code>max_allowed_packet</code> 太小, 在 <code>[mysqld]</code> 下修改 <code>max_allowed_packet</code>, 然后重启MYSQL</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">max_allowed_packet=16M</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW VARIABLES LIKE <span class="string">'max_allowed_packet'</span>;</span><br><span class="line">+--------------------+----------+</span><br><span class="line">| Variable_name      | Value    |</span><br><span class="line">+--------------------+----------+</span><br><span class="line">| max_allowed_packet | 16777216 |</span><br><span class="line">+--------------------+----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span></span><br></pre></td></tr></table></figure>
<blockquote><p>实际错误可能是 <code>MySQL server has gone away</code>, 设置 MySQL 的 <code>wait_timeout = 10</code>, 并且每次操作后, 主动关闭数据库连接<br><a href="/MySQL/mysql-sleep-too-many.html">wait_timeout 配置</a><br><span id="entityManager">Symfony 中的处理方式, 每次获取 <code>Repository</code> 时, 都需验证 MySQL 连接状态, 若无法ping通, 则断开重连</span> </p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Gets a named entity manager.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $name The entity manager name (null for the default one)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> \Doctrine\ORM\EntityManager</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getEntityManager</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="keyword">self</span>::$em)) &#123;</span><br><span class="line">        <span class="keyword">self</span>::$em = <span class="keyword">self</span>::getService(<span class="string">'doctrine'</span>)-&gt;getManager($name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>::$em-&gt;isOpen()) &#123;</span><br><span class="line">        $doctrine = <span class="keyword">self</span>::getService(<span class="string">'doctrine'</span>);</span><br><span class="line">        $doctrine-&gt;resetManager($name);</span><br><span class="line">        <span class="keyword">self</span>::$em = $doctrine-&gt;getManager($name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $conn = <span class="keyword">self</span>::$em-&gt;getConnection();</span><br><span class="line">    <span class="keyword">if</span> ($conn-&gt;ping() === <span class="keyword">false</span>) &#123;</span><br><span class="line">        $conn-&gt;close();</span><br><span class="line">        $conn-&gt;connect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>::$em;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p>若直接操作数据库进行了数据的修改, TCP 长连接中获取数据不是最新的</p></div>
<blockquote><p>每次获取 <code>Repository</code> 时, 调用 <code>clear()</code> 方法</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Gets the EntityRepository for an entity.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $entityName        The name of the entity.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $entityManagerName The entity manager name (null for the default one)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool $clear               Clears the repository</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> EntityRepository</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getRepository</span><span class="params">($entityName, $entityManagerName = null, $clear = true)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $container = <span class="keyword">self</span>::initContainer();</span><br><span class="line">    $em = <span class="keyword">self</span>::getEntityManager($entityManagerName);</span><br><span class="line">    $entityName = <span class="keyword">self</span>::COMMON_BUNDLE . <span class="string">":&#123;$entityName&#125;"</span>;</span><br><span class="line">    $repository = $em-&gt;getRepository($entityName);</span><br><span class="line">    $repository-&gt;init($container);</span><br><span class="line">    $clear &amp;&amp; $repository-&gt;clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $repository;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p><code>Order</code> 和 <code>User</code> 配置了关联映射, 通过<code>Order#User</code>关系找到一个新实体, 该关系未配置为级联实体的持久操作</p></div>
<blockquote><p>具体错误：<code>A new entity was found through the relationship &#39;Bundles\CommonBundle\Entity\Order#User&#39; that was not configured to cascade persist operations for entity: Bundles\CommonBundle\Entity\User@000000005db8782900000000730db886. To solve this issue: Either explicitly call EntityManager#persist() on this unknown entity or configure cascade persist this association in the mapping for example @ManyToOne(..,cascade={&quot;persist&quot;}). If you cannot find out which entity causes the problem implement &#39;Bundles\CommonBundle\Entity\User#__toString()&#39; to get a clue.</code><br><code>Order</code> 和 <code>User</code> </p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 第一种, 删除 `Order` 和 `User` 的关联配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种：在查询前清除EntityManager</span></span><br><span class="line">$em = <span class="keyword">self</span>::getEntityManager();</span><br><span class="line">$em-&gt;clear();</span><br><span class="line"> </span><br><span class="line">$orderRepository = <span class="keyword">self</span>::getRepository(<span class="string">'Order'</span>);</span><br><span class="line">$order = $orderRepository-&gt;findOneBy([<span class="string">'orderNum'</span> =&gt; <span class="string">'201711271543190607981'</span>]);</span><br><span class="line"> </span><br><span class="line">$userRepository = <span class="keyword">self</span>::getRepository(<span class="string">'User'</span>);</span><br><span class="line">$user = $userRepository-&gt;findOneBy([<span class="string">'id'</span> =&gt; <span class="number">5</span>]);</span><br><span class="line"> </span><br><span class="line">$orderRepository-&gt;saveOrder($order, [</span><br><span class="line">    <span class="string">'orderMoney'</span> =&gt; <span class="string">'12'</span>,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三种：查询 User 后, 调用 clear()</span></span><br><span class="line">$orderRepository = <span class="keyword">self</span>::getRepository(<span class="string">'Order'</span>);</span><br><span class="line">$order = $orderRepository-&gt;findOneBy([<span class="string">'orderNum'</span> =&gt; <span class="string">'201711271543190607981'</span>]);</span><br><span class="line"> </span><br><span class="line">$userRepository = <span class="keyword">self</span>::getRepository(<span class="string">'User'</span>);</span><br><span class="line">$user = $userRepository-&gt;findOneBy([<span class="string">'id'</span> =&gt; <span class="number">5</span>]);</span><br><span class="line">$userRepository-&gt;clear();</span><br><span class="line"> </span><br><span class="line">$orderRepository-&gt;saveOrder($order, [</span><br><span class="line">    <span class="string">'orderMoney'</span> =&gt; <span class="string">'12'</span>,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第四种：在更新 Order 前, 刷新 $order 实体类, 这样 Symfony 就会重新去取得 $order 所映射的 User 实体类</span></span><br><span class="line">$orderRepository = <span class="keyword">self</span>::getRepository(<span class="string">'Order'</span>);</span><br><span class="line">$order = $orderRepository-&gt;findOneBy([<span class="string">'orderNum'</span> =&gt; <span class="string">'201711271543190607981'</span>]);</span><br><span class="line"> </span><br><span class="line">$userRepository = <span class="keyword">self</span>::getRepository(<span class="string">'User'</span>);</span><br><span class="line">$user = $userRepository-&gt;findOneBy([<span class="string">'id'</span> =&gt; <span class="number">5</span>]);</span><br><span class="line"> </span><br><span class="line">$em-&gt;refresh($order);</span><br><span class="line">$orderRepository-&gt;saveOrder($order, [</span><br><span class="line">    <span class="string">'orderMoney'</span> =&gt; <span class="string">'12'</span>,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第五种：调整执行顺序</span></span><br><span class="line">$orderRepository = <span class="keyword">self</span>::getRepository(<span class="string">'Order'</span>);</span><br><span class="line">$order = $orderRepository-&gt;findOneBy([<span class="string">'orderNum'</span> =&gt; <span class="string">'201711271543190607981'</span>]);</span><br><span class="line"> </span><br><span class="line">$orderRepository-&gt;saveOrder($order, [</span><br><span class="line">    <span class="string">'orderMoney'</span> =&gt; <span class="string">'12'</span>,</span><br><span class="line">]);</span><br><span class="line"> </span><br><span class="line">$userRepository = <span class="keyword">self</span>::getRepository(<span class="string">'User'</span>);</span><br><span class="line">$user = $userRepository-&gt;findOneBy([<span class="string">'id'</span> =&gt; <span class="number">5</span>]);</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>开启事务后, 偶尔会提示 <code>There is no active transaction.</code></p></div>
<blockquote><p><code>EntityManager</code> 重复定义所导致, 使用单例模式<br>当初碰到这个错误的时是因为开启事务的时候, 实例化了 EntityManager, 当获取持久类时, getRepository 时又实例化了 EntityManager, 这是两个不同的 EntityManager, 所以偶尔会出现以上错误</p>
</blockquote>
<div class="note danger"><p>开启事务后, 偶尔会提示 <code>The entityManager is closed.</code></p></div>
<blockquote><p>每次事务处理完后都关闭 <code>EntityManager</code>, 当收到新请求, 重新调用 <code>EntityManager</code> 时, 没有判断是否被关闭, <a href="#entityManager">EntityManager 获取方法</a></p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * rollback and close transaction.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">closeTransaction</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">self</span>::$em)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>::$em-&gt;getConnection()-&gt;isTransactionActive()) &#123;</span><br><span class="line">            <span class="keyword">self</span>::$em-&gt;close();</span><br><span class="line">            <span class="keyword">self</span>::$em-&gt;rollback();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Symfony</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>symfony</tag>
        <tag>gatewayworker</tag>
        <tag>workerman</tag>
      </tags>
  </entry>
  <entry>
    <title>Symfony3 自定义 Repository Factory</title>
    <url>/Symfony/symfony-customized-repository-factory.html</url>
    <content><![CDATA[<div class="note danger"><p>需求：<code>CommonBundle 存放数据库表的映射/实体/持久类</code>, 现有 <code>AdminBundle</code> 和 <code>ApiBundle</code> 使用同一数据库, 现在需要将两个<code>Bundle</code>的<code>Repository</code>分开, 比如有个表为 <code>User</code>, 则需要两个 <code>Repository</code>, 在 <code>CommonBundle</code> 下新建 <code>Admin/UserRepository.php</code> 和 <code>Api/UserRepository.php</code>, 即将两个<code>Bundle</code>的<code>Repository</code>放在不同的目录下</p></div>
<a id="more"></a>
<h4 id="创建-EnhancedRepositoryFactory-php"><a href="#创建-EnhancedRepositoryFactory-php" class="headerlink" title="创建 EnhancedRepositoryFactory.php"></a>创建 EnhancedRepositoryFactory.php</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Bundles</span>\<span class="title">CommonBundle</span>\<span class="title">EntityRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">EntityManagerInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Repository</span>\<span class="title">RepositoryFactory</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Factory that set a default EntityRepository for specific entities.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EnhancedRepositoryFactory</span> <span class="keyword">implements</span> <span class="title">RepositoryFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The list of EntityRepository instances.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Doctrine\Common\Persistence\ObjectRepository[]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $repositoryList = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRepository</span><span class="params">(EntityManagerInterface $entityManager, $entityName)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $port = <span class="keyword">null</span>;</span><br><span class="line">        $explodeArray = explode(<span class="string">':'</span>, $entityName);</span><br><span class="line">        <span class="keyword">if</span> (count($explodeArray) &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">list</span>($namespaceAlias, $port, $targetEntity) = $explodeArray;</span><br><span class="line">            $entityName = <span class="string">"&#123;$namespaceAlias&#125;:&#123;$targetEntity&#125;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $repositoryHash = $entityManager-&gt;getClassMetadata($entityName)-&gt;getName() . spl_object_hash($entityManager);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;repositoryList[$repositoryHash])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;repositoryList[$repositoryHash];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;repositoryList[$repositoryHash] = <span class="keyword">$this</span>-&gt;createRepository($entityManager, $entityName, $port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new repository instance for an entity class.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \Doctrine\ORM\EntityManagerInterface $entityManager The EntityManager instance.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string                               $entityName    The name of the entity.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string                               $port</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Doctrine\Common\Persistence\ObjectRepository</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">createRepository</span><span class="params">(EntityManagerInterface $entityManager, $entityName, $port)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/* <span class="doctag">@var</span> $metadata \Doctrine\ORM\Mapping\ClassMetadata */</span></span><br><span class="line">        $metadata            = $entityManager-&gt;getClassMetadata($entityName);</span><br><span class="line">        <span class="keyword">if</span> (is_null($port)) &#123;</span><br><span class="line">            $repositoryClassName = $metadata-&gt;customRepositoryClassName ?: $entityManager-&gt;getConfiguration()-&gt;getDefaultRepositoryClassName();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $repositoryClassName = str_replace(<span class="string">'\\Entity\\'</span>, <span class="string">'\\EntityRepository\\'</span> . $port . <span class="string">'\\'</span>, $metadata-&gt;name) . <span class="string">'Repository'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> $repositoryClassName($entityManager, $metadata);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="将-EnhancedRepositoryFactory-注册为服务"><a href="#将-EnhancedRepositoryFactory-注册为服务" class="headerlink" title="将 EnhancedRepositoryFactory 注册为服务"></a>将 EnhancedRepositoryFactory 注册为服务</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">services:</span><br><span class="line">    _defaults:</span><br><span class="line">        public: true</span><br><span class="line"></span><br><span class="line">    #==========================EnhancedRepositoryFactory======================</span><br><span class="line">    app.doctrine.repository.factory:</span><br><span class="line">        class: Bundles\CommonBundle\EntityRepository\EnhancedRepositoryFactory</span><br></pre></td></tr></table></figure>
<h4 id="配置-config-yml"><a href="#配置-config-yml" class="headerlink" title="配置 config.yml"></a>配置 config.yml</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"># Doctrine Configuration</span><br><span class="line">doctrine:</span><br><span class="line">    orm:</span><br><span class="line">        repository_factory: app.doctrine.repository.factory</span><br></pre></td></tr></table></figure>
<h4 id="调用方式"><a href="#调用方式" class="headerlink" title="调用方式"></a>调用方式</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$em = <span class="keyword">$this</span>-&gt;getEntityManager();</span><br><span class="line">$adminUserRepository = $em-&gt;getRepository(<span class="string">'CommonBundle:Admin:User'</span>);</span><br><span class="line">$apiUserRepository = $em-&gt;getRepository(<span class="string">'CommonBundle:Api:User'</span>);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Symfony</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>symfony</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 解决死锁</title>
    <url>/MySQL/mysql-deadlock.html</url>
    <content><![CDATA[<h4 id="模拟死锁-第一步-创建表-并插入数据"><a href="#模拟死锁-第一步-创建表-并插入数据" class="headerlink" title="模拟死锁 - 第一步(创建表,并插入数据)"></a>模拟死锁 - 第一步(创建表,并插入数据)</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CREATE TABLE `<span class="built_in">test</span>` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `title` varchar(16) COLLATE utf8_bin NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_bin;</span><br><span class="line"></span><br><span class="line">INSERT INTO <span class="built_in">test</span>(title) VALUES(<span class="string">'A'</span>),(<span class="string">'B'</span>);</span><br></pre></td></tr></table></figure>
<h4 id="模拟死锁-第二步-会话一：开启事务-更新不提交"><a href="#模拟死锁-第二步-会话一：开启事务-更新不提交" class="headerlink" title="模拟死锁 - 第二步(会话一：开启事务,更新不提交)"></a>模拟死锁 - 第二步(会话一：开启事务,更新不提交)</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">begin;</span><br><span class="line">UPDATE <span class="built_in">test</span> SET title = <span class="string">'C'</span> WHERE id = 1;</span><br></pre></td></tr></table></figure>
<h4 id="模拟死锁-第三步-会话二：开启事务-更新同一条数据"><a href="#模拟死锁-第三步-会话二：开启事务-更新同一条数据" class="headerlink" title="模拟死锁 - 第三步(会话二：开启事务,更新同一条数据)"></a>模拟死锁 - 第三步(会话二：开启事务,更新同一条数据)</h4><p><code>经过一段时间后,提示 Lock wait timeout exceeded; try restarting transaction</code><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">UPDATE <span class="built_in">test</span> SET title = <span class="string">'D'</span> WHERE id = 1;</span><br></pre></td></tr></table></figure></p>
<h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看未提交的事务,trx_mysql_thread_id 为线程ID,比如查询出来的 trx_mysql_thread_id = 853</span></span><br><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX;</span><br><span class="line"><span class="comment">#执行 kill 线程ID</span></span><br><span class="line">KILL 853</span><br></pre></td></tr></table></figure>
<p><code>相关命令</code><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#显示哪些线程正在运行</span></span><br><span class="line">SHOW PROCESSLIST;</span><br><span class="line"><span class="comment">#查看当前锁定的事务</span></span><br><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS;</span><br><span class="line"><span class="comment">#查看当前等待的事务</span></span><br><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS;</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 下 Sleep 过多解决方法</title>
    <url>/MySQL/mysql-sleep-too-many.html</url>
    <content><![CDATA[<h5 id="配置-wait-timeout-和-interactive-timeout"><a href="#配置-wait-timeout-和-interactive-timeout" class="headerlink" title="配置 wait_timeout  和 interactive_timeout"></a>配置 wait_timeout  和 interactive_timeout</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="comment">#默认值：28800秒(8小时),服务器关闭非交互连接之前等待活动的秒数</span></span><br><span class="line"><span class="comment">#在线程启动时,根据全局 wait_timeout 值或全局 interactive_timeout 值初始化会话 wait_timeout 值,取决于客户端类型(由mysql_real_connect()的连接选项CLIENT_INTERACTIVE定义)</span></span><br><span class="line">wait_timeout=10</span><br><span class="line"><span class="comment">#默认值：28800秒(8小时),服务器关闭交互式连接前等待活动的秒数</span></span><br><span class="line"><span class="comment">#交互式客户端定义为在mysql_real_connect()中使用CLIENT_INTERACTIVE选项的客户端,interactive的值如果设置的和wait_timeout不同,在交互模式下(CLIENT_INTERACTIVE),interactive_timeout 会覆盖 wait_timeout</span></span><br><span class="line">interactive_timeout=10</span><br></pre></td></tr></table></figure>
<h5 id="代码中程序执行完毕-应显式调用-mysql-close"><a href="#代码中程序执行完毕-应显式调用-mysql-close" class="headerlink" title="代码中程序执行完毕,应显式调用 mysql_close"></a>代码中程序执行完毕,应显式调用 mysql_close</h5><h5 id="MySQL-相关命令"><a href="#MySQL-相关命令" class="headerlink" title="MySQL 相关命令"></a>MySQL 相关命令</h5><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">#查看连接数, 每有一个新连接请求, max_connections++, 每中止一个连接 max_connections--</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">processlist</span>;</span><br><span class="line">mysql&gt; show processlist;</span><br><span class="line">+<span class="comment">----+------+---------------------+-----+---------+------+-------+------------------+</span></span><br><span class="line">| Id | User | Host                | db  | Command | Time | State | Info             |</span><br><span class="line">+<span class="comment">----+------+---------------------+-----+---------+------+-------+------------------+</span></span><br><span class="line">|  1 | root | 192.168.227.1:53897 | ymd | Query   |    0 | init  | <span class="keyword">show</span> <span class="keyword">processlist</span> |</span><br><span class="line">|  <span class="number">9</span> | root | <span class="number">192.168</span><span class="number">.227</span><span class="number">.1</span>:<span class="number">55732</span> | ymd | <span class="keyword">Sleep</span>   | <span class="number">8720</span> |       | <span class="literal">NULL</span>             |</span><br><span class="line">+<span class="comment">----+------+---------------------+-----+---------+------+-------+------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span></span><br><span class="line"></span><br><span class="line"># Command 当前连接执行的命令, <span class="keyword">Time</span> 连接持续时间  </span><br><span class="line"># 当 Command = <span class="keyword">Sleep</span>, 则 <span class="keyword">Time</span> 持续时间为 wait_timeout 设置的值, wait_timeout 秒后就会关闭连接</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP 常用方法 (一)</title>
    <url>/PHP/php-common-functions-1.html</url>
    <content><![CDATA[<div class="note danger"><p>获取当前时间,精确到微秒</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取当前时间,精确到微秒</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCurrentTime</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">list</span>($usec, $sec) = explode(<span class="string">' '</span>, microtime());</span><br><span class="line">    <span class="keyword">return</span> date(<span class="string">'Y-m-d H:i:s'</span>, $sec) . substr((float)$usec, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>递归创建目录</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 递归创建目录</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $dir</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $mode</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">recursive_mkdirs</span><span class="params">($dir, $mode = <span class="number">0777</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_dir($dir) || @mkdir($dir, $mode)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!mkdirs(dirname($dir), $mode)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> @mkdir($dir, $mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p>获取指定目录下所有文件</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取指定目录下所有文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $dir 指定目录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $files</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAllFiles</span><span class="params">($dir, &amp;$files)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $handle = @opendir($dir);</span><br><span class="line">    <span class="keyword">if</span> ($handle) &#123;</span><br><span class="line">        <span class="keyword">while</span> (($file = readdir($handle)) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($file != <span class="string">'.'</span> &amp;&amp; $file != <span class="string">'..'</span>) &#123;</span><br><span class="line">                $curPath = $dir . DIRECTORY_SEPARATOR . $file;</span><br><span class="line">                <span class="keyword">if</span> (is_dir($curPath)) &#123;</span><br><span class="line">                    getAllFiles($curPath, $files);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $files[] = $curPath;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>递归删除目录和目录下所有文件</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 递归删除目录和目录下所有文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $dir</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">recursive_deldirs</span><span class="params">($dir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $handle = @opendir($dir);</span><br><span class="line">    <span class="keyword">while</span> (($file = readdir($handle)) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($file != <span class="string">'.'</span> &amp;&amp; $file != <span class="string">'..'</span>) &#123;</span><br><span class="line">            $curPath = $dir . DIRECTORY_SEPARATOR . $file;</span><br><span class="line">            <span class="keyword">if</span> (is_dir($curPath)) &#123;</span><br><span class="line">                recursive_deldirs($curPath);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                @unlink($curPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (readdir($handle) == <span class="keyword">false</span>) &#123;</span><br><span class="line">        closedir($handle);</span><br><span class="line">        @rmdir($dir);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>过滤emoji表情</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 过滤emoji表情</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $str</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filterEmoji</span><span class="params">($str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $str = preg_replace_callback(<span class="string">'/./u'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(array $match)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> strlen($match[<span class="number">0</span>]) &gt;= <span class="number">4</span> ? <span class="string">''</span> : $match[<span class="number">0</span>];</span><br><span class="line">    &#125;, $str);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>cURL 毫秒级,也可作为异步请求</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * curl模拟GET|POST请求</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $url 请求地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $params 请求参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $headers 请求头</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool $isPost 默认post请求</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $timeOut 超时秒数</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curlRequest</span><span class="params">($url, $params = [], $headers = [], $isPost = true, $timeOut = <span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'/^(http|https)/is'</span>, $url)) &#123;</span><br><span class="line">        $url = <span class="string">'http://'</span> . $url;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 忽略证书和host的验证</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="keyword">false</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class="keyword">false</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 超时时间为毫秒级 的话,需要配置 NOSIGNAL</span></span><br><span class="line">    <span class="keyword">if</span> ($timeOut &gt; <span class="number">0</span> &amp;&amp; $timeOut &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        $timeOut = (int)($timeOut * <span class="number">1000</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_NOSIGNAL, <span class="keyword">true</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_TIMEOUT_MS, $timeOut);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $timeOut = (int)$timeOut;</span><br><span class="line">        curl_setopt($ch, CURLOPT_TIMEOUT, $timeOut);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 设置请求头</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($headers)) &#123;</span><br><span class="line">        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// POST请求</span></span><br><span class="line">    <span class="keyword">if</span> ($isPost) &#123;</span><br><span class="line">        curl_setopt($ch, CURLOPT_POST, <span class="keyword">true</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_POSTFIELDS, $params);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    $result = curl_exec($ch);</span><br><span class="line">    curl_close($ch);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>友好时间</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 友好的时间显示</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * size = 1, 显示1位,如: 1年、3个月、5天、20小时...</span></span><br><span class="line"><span class="comment"> * size = 2, 显示2位,如: 1年1个月、1年3天、5天4小时、2小时25分...</span></span><br><span class="line"><span class="comment"> * size = 3, 显示3位,如: 1年1个月4天、1年3天20小时、5天4小时3秒、2小时25分10秒...</span></span><br><span class="line"><span class="comment"> * size = 4, 显示4位,如: 1年1个月4天16小时...</span></span><br><span class="line"><span class="comment"> * size &gt;= 5, 显示5位,如: 1年1个月4天16小时15分钟...</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string|DateTime $datetime 日期字符串或日期 DateTime 对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $size 精确到位数</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">friendlyDate</span><span class="params">($datetime, $size = <span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_string($datetime)) &#123;</span><br><span class="line">        $datetime = <span class="keyword">new</span> DateTime($datetime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $now = <span class="keyword">new</span> DateTime();</span><br><span class="line">    $interval = $now-&gt;diff($datetime);</span><br><span class="line">    $intervalData = [$interval-&gt;y, $interval-&gt;m, $interval-&gt;d, $interval-&gt;h, $interval-&gt;i, $interval-&gt;s];</span><br><span class="line">    $intervalFormat = [<span class="string">'年'</span>, <span class="string">'个月'</span>, <span class="string">'天'</span>, <span class="string">'小时'</span>, <span class="string">'分钟'</span>, <span class="string">'秒'</span>];</span><br><span class="line">    print_r($intervalData);</span><br><span class="line">    <span class="keyword">foreach</span> ($intervalData <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($value) &#123;</span><br><span class="line">            $intervalData[$key] = $value . $intervalFormat[$key];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">unset</span>($intervalData[$key]);</span><br><span class="line">            <span class="keyword">unset</span>($intervalFormat[$key]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> implode(<span class="string">''</span>, array_slice($intervalData, <span class="number">0</span>, $size));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>验证字符串是否序列化</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证字符串是否序列化</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $string</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool $strict</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateSerialized</span><span class="params">($string, $strict = true)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!is_string($string)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $string = trim($string);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'N;'</span> == $string) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (strlen($string) &lt; <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">':'</span> !== $string[<span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($strict) &#123;</span><br><span class="line">        $lastc = substr($string, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">';'</span> !== $lastc &amp;&amp; <span class="string">'&#125;'</span> !== $lastc) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $semicolon = strpos($string, <span class="string">';'</span>);</span><br><span class="line">        $brace = strpos($string, <span class="string">'&#125;'</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span> === $semicolon &amp;&amp; <span class="keyword">false</span> === $brace) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span> !== $semicolon &amp;&amp; $semicolon &lt; <span class="number">3</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span> !== $brace &amp;&amp; $brace &lt; <span class="number">4</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $token = $string[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">switch</span> ($token) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'s'</span> :</span><br><span class="line">            <span class="keyword">if</span> ($strict) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">'"'</span> !== substr($string, <span class="number">-2</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="keyword">false</span> === strpos($string, <span class="string">'"'</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'a'</span> :</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'O'</span> :</span><br><span class="line">            <span class="keyword">return</span> (bool)preg_match(<span class="string">"/^&#123;$token&#125;:[0-9]+:/s"</span>, $string);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'b'</span> :</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'i'</span> :</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'d'</span> :</span><br><span class="line">            $end = $strict ? <span class="string">'$'</span> : <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">return</span> (bool)preg_match(<span class="string">"/^&#123;$token&#125;:[0-9.E-]+;$end/"</span>, $string);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>坐标常用函数</title>
    <url>/PHP/longitude-latitude-functions.html</url>
    <content><![CDATA[<div class="note danger"><p>百度/高德计算两经纬度坐标的距离和某个经纬度坐标的周边    </p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算两点之前距离</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $long1 出发地经度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $lat1 出发地纬度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $long2 目的地经度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $lat2 目的地纬度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $type 1:公里,2:米</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLatLngDistance</span><span class="params">($long1, $lat1, $long2, $lat2, $type = <span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $PI = <span class="number">3.1415926535898</span>;</span><br><span class="line">    $EARTH_RADIUS = <span class="number">6378.137</span>;</span><br><span class="line">    $radLat1 = $lat1 * ($PI / <span class="number">180</span>);</span><br><span class="line">    $radLat2 = $lat2 * ($PI / <span class="number">180</span>);</span><br><span class="line">    $a = $radLat1 - $radLat2;</span><br><span class="line">    $b = ($long1 * ($PI / <span class="number">180</span>)) - ($long2 * ($PI / <span class="number">180</span>));</span><br><span class="line">    $s = <span class="number">2</span> * asin(sqrt(pow(sin($a / <span class="number">2</span>), <span class="number">2</span>) + cos($radLat1) * cos($radLat2) * pow(sin($b / <span class="number">2</span>), <span class="number">2</span>)));</span><br><span class="line">    $s = $s * $EARTH_RADIUS;</span><br><span class="line">    $s = round($s * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $type == <span class="number">1</span> ? ($s / <span class="number">1000</span>) : $s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算范围</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $long 中心点经度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $lat 中心点纬度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> double $radius 范围[单位:米]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLatLngRange</span><span class="params">($long, $lat, $radius)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $PI = <span class="number">3.1415926535898</span>;</span><br><span class="line">    <span class="comment">// 计算纬度</span></span><br><span class="line">    $degree = (<span class="number">24901</span> * <span class="number">1609</span>) / <span class="number">360.0</span>;</span><br><span class="line">    $dpmLat = <span class="number">1</span> / $degree;</span><br><span class="line">    $radiusLat = $dpmLat * $radius;</span><br><span class="line">    $minLat = $lat - $radiusLat;    <span class="comment">// 得到最小纬度</span></span><br><span class="line">    $maxLat = $lat + $radiusLat;    <span class="comment">// 得到最大纬度</span></span><br><span class="line">    <span class="comment">// 计算经度</span></span><br><span class="line">    $mpdLong = $degree * cos($lat * ($PI / <span class="number">180</span>));</span><br><span class="line">    $dpmLong = <span class="number">1</span> / $mpdLong;</span><br><span class="line">    $radiusLong = $dpmLong * $radius;</span><br><span class="line">    $minLong = $long - $radiusLong; <span class="comment">// 得到最小经度</span></span><br><span class="line">    $maxLong = $long + $radiusLong; <span class="comment">// 得到最大经度</span></span><br><span class="line">    <span class="comment">// 范围</span></span><br><span class="line">    $range = [</span><br><span class="line">        <span class="string">'minLat'</span> =&gt; $minLat,</span><br><span class="line">        <span class="string">'maxLat'</span> =&gt; $maxLat,</span><br><span class="line">        <span class="string">'minLong'</span> =&gt; $minLong,</span><br><span class="line">        <span class="string">'maxLong'</span> =&gt; $maxLong</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $range;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p>火星[高德]坐标与百度坐标的相互转换</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 火星坐标系(GCJ-02) 转换 百度坐标系(BD-09)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gcj02_to_bd09</span><span class="params">($long, $lat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $xPi = <span class="number">3.14159265358979324</span> * <span class="number">3000.0</span> / <span class="number">180.0</span>;</span><br><span class="line">    $z = sqrt($long * $long + $lat * $lat) + <span class="number">0.00002</span> * sin($lat * $xPi);</span><br><span class="line">    $theta = atan2($lat, $long) + <span class="number">0.000003</span> * cos($long * $xPi);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'lat'</span> =&gt; $z * sin($theta) + <span class="number">0.006</span>,</span><br><span class="line">        <span class="string">'lng'</span> =&gt; $z * cos($theta) + <span class="number">0.0065</span>,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 百度坐标系(BD-09) 转 火星坐标系(GCJ-02)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $long 经度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $lat 纬度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bd09_to_gcj02</span><span class="params">($long, $lat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $xPi = <span class="number">3.14159265358979324</span> * <span class="number">3000.0</span> / <span class="number">180.0</span>;</span><br><span class="line">    $x = $long - <span class="number">0.0065</span>;</span><br><span class="line">    $y = $lat - <span class="number">0.006</span>;</span><br><span class="line">    $z = sqrt($x * $x + $y * $y) - <span class="number">0.00002</span> * sin($y * $xPi);</span><br><span class="line">    $theta = atan2($y, $x) - <span class="number">0.000003</span> * cos($x * $xPi);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'long'</span> =&gt; $z * sin($theta),</span><br><span class="line">        <span class="string">'lat'</span> =&gt; $z * cos($theta),</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 火星坐标</span></span><br><span class="line">$gcj02 = [</span><br><span class="line">    <span class="string">'long'</span> =&gt; <span class="string">'118.996547'</span>,</span><br><span class="line">    <span class="string">'lat'</span> =&gt; <span class="string">'25.418467'</span>,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'火星[高德]坐标：'</span>;</span><br><span class="line">print_r($gcj02);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'火星坐标转百度坐标：'</span>;</span><br><span class="line">$bd09 = gcj02_to_bd09($gcj02[<span class="string">'long'</span>], $gcj02[<span class="string">'lat'</span>]);</span><br><span class="line">print_r($bd09);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'百度坐标转火星坐标：'</span>;</span><br><span class="line">print_r(bd09_to_gcj02($bd09[<span class="string">'long'</span>], $bd09[<span class="string">'lat'</span>]));</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>微信小程序 - websocket wss</title>
    <url>/PHP/wxapp-websocket.html</url>
    <content><![CDATA[<div class="note danger"><p>准备工作：<br>1、<a href="https://www.workerman.net/doc" target="_blank" rel="noopener">GatewayWorker</a> 监听 8585 端口(websocket协议)<br>2、已经申请了ssl证书[阿里云免费证书], 放在了/server/httpd/cert/ 下<br>3、利用apache转发443端口至指定端口<br>4、httpd-ssl.conf 已加载<br>5、openssl 已安装<br>6、小程序已设置 socket 合法域名 <code>wss://www.xxx.com</code></p>
<p><code>如果处于开发阶段,关闭小程序的相关校验, 微信web开发者工具 -&gt; 设置 -&gt; 项目设置 -&gt; 勾选 不校验安全域名、web-view 域名、TLS 版本以及 HTTPS 证书</code></p></div>
<h4 id="启用-proxy-wstunnel-module-模块"><a href="#启用-proxy-wstunnel-module-模块" class="headerlink" title="启用 proxy_wstunnel_module 模块"></a>启用 proxy_wstunnel_module 模块</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#httpd.conf</span></span><br><span class="line">LoadModule proxy_module modules/mod_proxy.so</span><br><span class="line">LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="配置SSL及代理"><a href="#配置SSL及代理" class="headerlink" title="配置SSL及代理"></a>配置SSL及代理</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#extra/httpd-ssl.conf</span></span><br><span class="line">DocumentRoot <span class="string">"/www/socket"</span></span><br><span class="line">ServerName localhost</span><br><span class="line">ErrorLog <span class="string">"/log/httpd/socket-error.log"</span></span><br><span class="line">TransferLog <span class="string">"/log/httpd/socket-access.log"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Proxy Config</span></span><br><span class="line">SSLProxyEngine on</span><br><span class="line"><span class="comment">#监听的路径和转发的路径,需要输入https://和最后面的/</span></span><br><span class="line">ProxyRequests Off</span><br><span class="line">ProxyPass /wss ws://0.0.0.0:8585</span><br><span class="line">ProxyPassReverse /wss ws://0.0.0.0:8585</span><br><span class="line"><span class="comment">#ProxyPass / https://www.baidu.com</span></span><br><span class="line"><span class="comment">#ProxyPassReverse / https://www.baidu.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 SSL 协议支持协议,去掉不安全的协议</span></span><br><span class="line">SSLProtocol all -SSLv2 -SSLv3</span><br><span class="line"><span class="comment"># 修改加密套件如下</span></span><br><span class="line">SSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUM</span><br><span class="line">SSLHonorCipherOrder on</span><br><span class="line"><span class="comment"># 证书公钥配置</span></span><br><span class="line">SSLCertificateFile cert/public.pem</span><br><span class="line"><span class="comment"># 证书私钥配置</span></span><br><span class="line">SSLCertificateKeyFile cert/2222222222222.key</span><br><span class="line"><span class="comment"># 证书链配置,如果该属性开头有 '#'字符,请删除掉</span></span><br><span class="line">SSLCertificateChainFile cert/chain.pem</span><br></pre></td></tr></table></figure>
<h4 id="配置-GatewayWorker-并启动"><a href="#配置-GatewayWorker-并启动" class="headerlink" title="配置 GatewayWorker,并启动"></a>配置 GatewayWorker,并启动</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># socket.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Workerman</span>\<span class="title">Worker</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Workerman</span>\<span class="title">Lib</span>\<span class="title">Timer</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">GatewayWorker</span>\<span class="title">Register</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">GatewayWorker</span>\<span class="title">Gateway</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">GatewayWorker</span>\<span class="title">BusinessWorker</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (strpos(strtolower(PHP_OS), <span class="string">'win'</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"Not support windows\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!extension_loaded(<span class="string">'pcntl'</span>)) &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"Please install pcntl extension. See http://doc3.workerman.net/appendices/install-extension.html\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!extension_loaded(<span class="string">'posix'</span>)) &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"Please install posix extension. See http://doc3.workerman.net/appendices/install-extension.html\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$config = [</span><br><span class="line">    <span class="string">'path'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/GatewayWorker/'</span>,</span><br><span class="line">    <span class="string">'register_address'</span> =&gt; <span class="string">'127.0.0.1:1251'</span>,</span><br><span class="line">    <span class="string">'ws_gateway_socket'</span> =&gt; <span class="string">'websocket://0.0.0.0:8585'</span>,</span><br><span class="line">    <span class="string">'ws_gateway_name'</span> =&gt; <span class="string">'ws_gateway'</span>,</span><br><span class="line">    <span class="string">'ws_gateway_count'</span> =&gt; <span class="number">4</span>,</span><br><span class="line">    <span class="string">'gateway_lan_ip'</span> =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'ws_gateway_start_port'</span> =&gt; <span class="number">6000</span>,</span><br><span class="line">    <span class="string">'gateway_ping_interval'</span> =&gt; <span class="number">2500</span>,</span><br><span class="line">    <span class="string">'gateway_ping_not_response_limit'</span> =&gt; <span class="number">2</span>,</span><br><span class="line">    <span class="string">'gateway_ping_data'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">    <span class="string">'businessworker_name'</span> =&gt; <span class="string">'businessworker'</span>,</span><br><span class="line">    <span class="string">'businessworker_count'</span> =&gt; <span class="number">4</span>,</span><br><span class="line">    <span class="string">'businessworker_event_handler'</span> =&gt; <span class="string">'SocketEvents'</span>,</span><br><span class="line">    <span class="string">'log_file'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/multiprotocol.log'</span></span><br><span class="line">];</span><br><span class="line"><span class="keyword">require_once</span> $config[<span class="string">'path'</span>] . <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// register服务</span></span><br><span class="line">$register = <span class="keyword">new</span> Register(<span class="string">'text://'</span> . $config[<span class="string">'register_address'</span>]);</span><br><span class="line"></span><br><span class="line">$context = [];</span><br><span class="line"><span class="comment">// 若是h5 websocket,wss可以指定端口,就不需要配置apache代理,只需要配置$context即可</span></span><br><span class="line"><span class="comment">// $context = array(</span></span><br><span class="line"><span class="comment">//     'ssl' =&gt; array(</span></span><br><span class="line"><span class="comment">//         'local_cert'  =&gt; '/server/httpd/cert/2222222222222.pem',</span></span><br><span class="line"><span class="comment">//         'local_pk'    =&gt; '/server/httpd/cert/2222222222222.key',</span></span><br><span class="line"><span class="comment">//         'verify_peer' =&gt; false</span></span><br><span class="line"><span class="comment">//     )</span></span><br><span class="line"><span class="comment">// );</span></span><br><span class="line"><span class="comment">// gateway进程</span></span><br><span class="line">$gateway = <span class="keyword">new</span> Gateway($config[<span class="string">'ws_gateway_socket'</span>], $context);</span><br><span class="line"><span class="comment">// 开启SSL,websocket+SSL 即wss</span></span><br><span class="line">!<span class="keyword">empty</span>($context) &amp;&amp; $gateway-&gt;transport = <span class="string">'ssl'</span>;</span><br><span class="line">$gateway-&gt;name = $config[<span class="string">'ws_gateway_name'</span>];</span><br><span class="line">$gateway-&gt;count = $config[<span class="string">'ws_gateway_count'</span>];</span><br><span class="line">$gateway-&gt;lanIp = $config[<span class="string">'gateway_lan_ip'</span>];</span><br><span class="line">$gateway-&gt;startPort = $config[<span class="string">'ws_gateway_start_port'</span>];</span><br><span class="line">$gateway-&gt;registerAddress = $config[<span class="string">'register_address'</span>];</span><br><span class="line">$gateway-&gt;pingInterval = $config[<span class="string">'gateway_ping_interval'</span>];</span><br><span class="line">$gateway-&gt;pingNotResponseLimit = $config[<span class="string">'gateway_ping_not_response_limit'</span>];</span><br><span class="line">$gateway-&gt;pingData = $config[<span class="string">'gateway_ping_data'</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// bussinessWorker 进程</span></span><br><span class="line">$worker = <span class="keyword">new</span> BusinessWorker();</span><br><span class="line">$worker-&gt;name = $config[<span class="string">'businessworker_name'</span>];</span><br><span class="line">$worker-&gt;count = $config[<span class="string">'businessworker_count'</span>];</span><br><span class="line">$worker-&gt;registerAddress = $config[<span class="string">'register_address'</span>];</span><br><span class="line">$worker-&gt;eventHandler = $config[<span class="string">'businessworker_event_handler'</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监控文件更新并自动reload[只有在debug模式启动后才有效,daemon模式不生效]</span></span><br><span class="line"><span class="keyword">global</span> $lastMtime;</span><br><span class="line">$lastMtime = time();</span><br><span class="line">$worker = <span class="keyword">new</span> Worker();</span><br><span class="line">$worker-&gt;name = <span class="string">'FileMonitor'</span>;</span><br><span class="line">$worker-&gt;reloadable = <span class="keyword">false</span>;</span><br><span class="line">$worker-&gt;onWorkerStart = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $monitorDir = <span class="keyword">__DIR__</span>;</span><br><span class="line">    <span class="keyword">if</span> (!Worker::$daemonize) &#123;</span><br><span class="line">        Timer::add(<span class="number">1</span>, <span class="string">'check_files_change'</span>, [$monitorDir]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义workerman日志路径</span></span><br><span class="line">Worker::$logFile = $config[<span class="string">'log_file'</span>];</span><br><span class="line"></span><br><span class="line">Worker::runAll();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_files_change</span><span class="params">($monitorDir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $lastMtime;</span><br><span class="line">    $dirIterator = <span class="keyword">new</span> RecursiveDirectoryIterator($monitorDir);</span><br><span class="line">    $iterator = <span class="keyword">new</span> RecursiveIteratorIterator($dirIterator);</span><br><span class="line">    <span class="keyword">foreach</span> ($iterator <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(pathinfo($file, PATHINFO_EXTENSION) != <span class="string">'php'</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($lastMtime &lt; $file-&gt;getMTime())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&#123;$file&#125; update and reload\n"</span>;</span><br><span class="line">            <span class="comment">// send SIGUSR1 signal to master process for reload</span></span><br><span class="line">            posix_kill(posix_getppid(), SIGUSR1);</span><br><span class="line">            $lastMtime = $file-&gt;getMTime();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">php socket.php start</span><br></pre></td></tr></table></figure>
<h4 id="h5-websocket"><a href="#h5-websocket" class="headerlink" title="h5 websocket"></a>h5 websocket</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 普通方式</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">// var ws = new WebSocket('wss://www.xxx.com:8585');</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 使用代理的方式</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">'wss://www.xxx.com/wss'</span>);</span></span><br><span class="line"><span class="javascript">    ws.onopen = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        ws.send(<span class="string">'this is h5'</span>);</span></span><br><span class="line"><span class="undefined">    &#125;;</span></span><br><span class="line"><span class="javascript">    ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(e.data);</span></span><br><span class="line"><span class="undefined">    &#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="小程序"><a href="#小程序" class="headerlink" title="小程序"></a>小程序</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生命周期函数--监听页面加载</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">onLoad: <span class="function"><span class="keyword">function</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">    wx.connectSocket(&#123;</span><br><span class="line">        url: <span class="string">"wss://www.xxx.com/wss"</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    wx.onSocketOpen(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'WebSocket连接已打开！'</span>);    </span><br><span class="line">    &#125;;</span><br><span class="line">    wx.sendSocketMessage(&#123;</span><br><span class="line">        data: <span class="string">'this is wxapp'</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    wx.onSocketMessage(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'收到服务器内容：'</span> + res.data);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    wx.onSocketError(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'WebSocket连接打开失败，请检查！'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>websocket</tag>
        <tag>gatewayworker</tag>
      </tags>
  </entry>
  <entry>
    <title>Symfony3 Doctrine2 自定义 DQL 函数</title>
    <url>/Symfony/symfony-doctrine2-dql-user-defined-functions.html</url>
    <content><![CDATA[<blockquote><p>在 Symfony 中使用 mysql 函数时,有些函数需要注册自定义 DQL 函数来实现,否则无法使用<br>自定义 DQL 函数时需要查看的两个文件：<br><code>verdor/doctrine/orm/lib/Doctrine/ORM/Query/Parser.php</code><br><code>verdor/doctrine/orm/lib/Doctrine/ORM/Query/Lexer.php</code></p>
</blockquote>
<h4 id="需要实现的三个函数-DATE-FORMAT-GLength-If"><a href="#需要实现的三个函数-DATE-FORMAT-GLength-If" class="headerlink" title="需要实现的三个函数, DATE_FORMAT, GLength, If"></a>需要实现的三个函数, DATE_FORMAT, GLength, If</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># app/config/config.yml</span></span><br><span class="line"><span class="comment"># Doctrine Configuration</span></span><br><span class="line">doctrine:</span><br><span class="line">    orm:</span><br><span class="line">        dql:</span><br><span class="line">            datetime_functions:</span><br><span class="line">                DATE_FORMAT: Bundles\CommonBundle\DQL\DateFormatFunction</span><br><span class="line">            numeric_functions:</span><br><span class="line">                GLength: Bundles\CommonBundle\DQL\GLengthFunction</span><br><span class="line">            string_functions:</span><br><span class="line">                If: Bundles\CommonBundle\DQL\IfFunction</span><br></pre></td></tr></table></figure>
<blockquote><p><code>datetime_functions</code>、<code>numeric_functions</code>、<code>string_functions</code> 是固定的,必须按此命名<br><code>DateFormat</code>、<code>GLength</code>、<code>If</code> 命名可以自定义,但是SQL调用的时候,必须与这里定义的一致</p>
</blockquote>
<a id="more"></a>
<h4 id="DATE-FORMAT-用于格式化字段类型-datetime"><a href="#DATE-FORMAT-用于格式化字段类型-datetime" class="headerlink" title="DATE_FORMAT 用于格式化字段类型 datetime"></a>DATE_FORMAT 用于格式化字段类型 datetime</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Bundles/CommonBundle/DQL/DateFormatFunction.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Bundles</span>\<span class="title">CommonBundle</span>\<span class="title">DQL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">AST</span>\<span class="title">Functions</span>\<span class="title">FunctionNode</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">Lexer</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">Parser</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">SqlWalker</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DATE_FORMAT("StringPrimary", "StringPrimary")</span></span><br><span class="line"><span class="comment"> * 日期格式化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DateFormatFunction</span> <span class="keyword">extends</span> <span class="title">FunctionNode</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $dateExpression;</span><br><span class="line">    <span class="keyword">protected</span> $formatString;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parse</span><span class="params">(Parser $parser)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $parser-&gt;match(Lexer::T_IDENTIFIER);</span><br><span class="line">        $parser-&gt;match(Lexer::T_OPEN_PARENTHESIS);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dateExpression = $parser-&gt;StringPrimary();</span><br><span class="line">        $parser-&gt;match(Lexer::T_COMMA);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;formatString = $parser-&gt;StringPrimary();</span><br><span class="line">        $parser-&gt;match(Lexer::T_CLOSE_PARENTHESIS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSql</span><span class="params">(SqlWalker $sqlWalker)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'DATE_FORMAT('</span> . $sqlWalker-&gt;walkStringPrimary(<span class="keyword">$this</span>-&gt;dateExpression)</span><br><span class="line">            . <span class="string">','</span> . $sqlWalker-&gt;walkStringPrimary(<span class="keyword">$this</span>-&gt;formatString) . <span class="string">')'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="IF-函数-此函数有2种用法"><a href="#IF-函数-此函数有2种用法" class="headerlink" title="IF 函数,此函数有2种用法"></a>IF 函数,此函数有2种用法</h4><blockquote><p>赋值  u.mobile = IF(u.age = 1, ‘12345678901’, ‘12345678902’)<br>IF(条件, true执行条件, false执行条件)</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Bundles/CommonBundle/DQL/IfFunction.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Bundles</span>\<span class="title">CommonBundle</span>\<span class="title">DQL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">AST</span>\<span class="title">Functions</span>\<span class="title">FunctionNode</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">Lexer</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">Parser</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">SqlWalker</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * IF("ConditionalExpression", "ArithmeticExpression", "ArithmeticExpression")</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IfFunction</span> <span class="keyword">extends</span> <span class="title">FunctionNode</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $expr = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * WHERE u.mobile = IF(u.age = 1, '12345678901', '12345678902')</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parse</span><span class="params">(Parser $parser)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $parser-&gt;match(Lexer::T_IDENTIFIER);</span><br><span class="line">        $parser-&gt;match(Lexer::T_OPEN_PARENTHESIS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;expr[] = $parser-&gt;ConditionalExpression();</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">2</span>; $i++) &#123;</span><br><span class="line">            $parser-&gt;match(Lexer::T_COMMA);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;expr[] = $parser-&gt;ArithmeticPrimary();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        $parser-&gt;match(Lexer::T_CLOSE_PARENTHESIS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * WHERE 1 = IF(u.age = 1, u.mobile = '12345678901', u.status = '1')</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/*public function parse(Parser $parser)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_IDENTIFIER);</span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_OPEN_PARENTHESIS);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        $this-&gt;expr[] = $parser-&gt;ConditionalExpression();</span></span><br><span class="line"><span class="comment">        for ($i = 0; $i &lt; 2; $i++) &#123;</span></span><br><span class="line"><span class="comment">            $parser-&gt;match(Lexer::T_COMMA);</span></span><br><span class="line"><span class="comment">            $this-&gt;expr[] = $parser-&gt;ConditionalExpression();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_CLOSE_PARENTHESIS);</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSql</span><span class="params">(SqlWalker $sqlWalker)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sprintf(<span class="string">'If(%s, %s, %s)'</span>,</span><br><span class="line">            $sqlWalker-&gt;walkConditionalExpression(<span class="keyword">$this</span>-&gt;expr[<span class="number">0</span>]),</span><br><span class="line">            $sqlWalker-&gt;walkArithmeticPrimary(<span class="keyword">$this</span>-&gt;expr[<span class="number">1</span>]),</span><br><span class="line">            $sqlWalker-&gt;walkArithmeticPrimary(<span class="keyword">$this</span>-&gt;expr[<span class="number">2</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * WHERE 1 = IF(u.age = 1, 1, DATE_FORMAT(u.createdAt, '%m-%d') &lt; '09-29')</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/*public function parse(Parser $parser)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_IDENTIFIER);</span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_OPEN_PARENTHESIS);          // 左括号</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">        $this-&gt;expr[] = $parser-&gt;ConditionalExpression();   // u.age = 1</span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_COMMA);                     // 符号 ','</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">        $this-&gt;expr[] = $parser-&gt;ArithmeticPrimary();       // 1</span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_COMMA);                     // 符号 ','</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">        $this-&gt;expr[] = $parser-&gt;StringPrimary();           // u.createdAt, '%m-%d'</span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_LOWER_THAN);                // 符号 '&lt;'</span></span><br><span class="line"><span class="comment">        $this-&gt;expr[] = $parser-&gt;StringPrimary();           // 09-29</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_CLOSE_PARENTHESIS);         // 右括号</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">    public function getSql(SqlWalker $sqlWalker)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        return sprintf('If(%s, %s, %s)',</span></span><br><span class="line"><span class="comment">            $sqlWalker-&gt;walkConditionalExpression($this-&gt;expr[0]),</span></span><br><span class="line"><span class="comment">            $sqlWalker-&gt;walkArithmeticPrimary($this-&gt;expr[1]),</span></span><br><span class="line"><span class="comment">            $sqlWalker-&gt;walkStringPrimary($this-&gt;expr[2]) . '&lt;' . $sqlWalker-&gt;walkStringPrimary($this-&gt;expr[3]));</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 基于Doctrine2, 此处写法为 1 = IF(), 不能直接 IF()</span></span><br><span class="line"><span class="comment">     * WHERE("1 = IF(u.age = 1, u.id IN(1, 2), 1)")</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/*public function parse(Parser $parser)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_IDENTIFIER);</span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_OPEN_PARENTHESIS);</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">        $this-&gt;expr[] = $parser-&gt;ConditionalExpression();</span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_COMMA);</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">        $this-&gt;expr[] = $parser-&gt;ArithmeticPrimary();</span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_IN);</span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_OPEN_PARENTHESIS);</span></span><br><span class="line"><span class="comment">        $this-&gt;concatExpressions[] = $parser-&gt;ArithmeticPrimary();</span></span><br><span class="line"><span class="comment">        // 判断下一个字符是不是逗号</span></span><br><span class="line"><span class="comment">        while ($parser-&gt;getLexer()-&gt;isNextToken(Lexer::T_COMMA)) &#123;</span></span><br><span class="line"><span class="comment">            $parser-&gt;match(Lexer::T_COMMA);</span></span><br><span class="line"><span class="comment">            $this-&gt;concatExpressions[] = $parser-&gt;ArithmeticPrimary();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_CLOSE_PARENTHESIS);</span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_COMMA);</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">        $this-&gt;expr[] = $parser-&gt;ArithmeticPrimary();</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">        $parser-&gt;match(Lexer::T_CLOSE_PARENTHESIS);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">    public function getSql(SqlWalker $sqlWalker)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        $params = [];</span></span><br><span class="line"><span class="comment">        foreach ($this-&gt;concatExpressions as $expression) &#123;</span></span><br><span class="line"><span class="comment">            $params[] = $sqlWalker-&gt;walkArithmeticPrimary($expression);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">        return sprintf('If(%s, %s, %s)',</span></span><br><span class="line"><span class="comment">            $sqlWalker-&gt;walkConditionalExpression($this-&gt;expr[0]),</span></span><br><span class="line"><span class="comment">            $sqlWalker-&gt;walkArithmeticPrimary($this-&gt;expr[1]) . ' IN(' . implode(',', $params) . ')',</span></span><br><span class="line"><span class="comment">            $sqlWalker-&gt;walkStringPrimary($this-&gt;expr[2]));</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="GLength-函数-配合相关函数计算两点间的距离"><a href="#GLength-函数-配合相关函数计算两点间的距离" class="headerlink" title="GLength 函数,配合相关函数计算两点间的距离"></a>GLength 函数,配合相关函数计算两点间的距离</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Bundles/CommonBundle/DQL/GLengthFunction.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Bundles</span>\<span class="title">CommonBundle</span>\<span class="title">DQL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">AST</span>\<span class="title">Functions</span>\<span class="title">FunctionNode</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">Lexer</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">Parser</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">SqlWalker</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GLength</span></span><br><span class="line"><span class="comment"> * MySql 调用 GLength(GeomFromText(CONCAT('LineString(', from_lat, ' ', from_lng, ',', to_lat, ' ', to_lng, ')') / 0.0000092592666666667</span></span><br><span class="line"><span class="comment"> * EntityRepository 调用 GLength(from_lat, from_lng, to_lat, to_lng) / 0.0000092592666666667</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GLengthFunction</span> <span class="keyword">extends</span> <span class="title">FunctionNode</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $onePriamry;</span><br><span class="line">    <span class="keyword">public</span> $twoPriamry;</span><br><span class="line">    <span class="keyword">public</span> $threePriamry;</span><br><span class="line">    <span class="keyword">public</span> $fourPriamry;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parse</span><span class="params">(Parser $parser)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $parser-&gt;match(Lexer::T_IDENTIFIER);</span><br><span class="line">        $parser-&gt;match(Lexer::T_OPEN_PARENTHESIS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;onePriamry = $parser-&gt;ArithmeticPrimary();</span><br><span class="line">        $parser-&gt;match(Lexer::T_COMMA);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;twoPriamry = $parser-&gt;ArithmeticPrimary();</span><br><span class="line">        $parser-&gt;match(Lexer::T_COMMA);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;threePriamry = $parser-&gt;ArithmeticPrimary();</span><br><span class="line">        $parser-&gt;match(Lexer::T_COMMA);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;fourPriamry = $parser-&gt;ArithmeticPrimary();</span><br><span class="line"></span><br><span class="line">        $parser-&gt;match(Lexer::T_CLOSE_PARENTHESIS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSql</span><span class="params">(SqlWalker $sqlWalker)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"GLength(GeomFromText(CONCAT('LineString(&#123;$sqlWalker-&gt;walkArithmeticPrimary($this-&gt;onePriamry)&#125; &#123;$sqlWalker-&gt;walkArithmeticPrimary($this-&gt;twoPriamry)&#125;,',&#123;$sqlWalker-&gt;walkStringPrimary($this-&gt;threePriamry)&#125;,' ',&#123;$sqlWalker-&gt;walkStringPrimary($this-&gt;fourPriamry)&#125;,')')))"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Symfony</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>doctrine</tag>
        <tag>symfony</tag>
        <tag>dql</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP 系列 (一)</title>
    <url>/PHP/php-series-1.html</url>
    <content><![CDATA[<div class="note danger"><p>浮点数计算不准确|保留两位小数不四舍五入</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 结果 float(0.099999999999998) </span></span><br><span class="line">var_dump(<span class="number">19.45</span> - <span class="number">19.35</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置所有bc数学函数的小数点保留位数</span></span><br><span class="line">bcscale(<span class="number">2</span>);</span><br><span class="line">var_dump(bcsub(<span class="number">19.45</span>, <span class="number">19.35</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保留两位小数,不四舍五入</span></span><br><span class="line">var_dump(bcsub(<span class="number">1.339</span>, <span class="number">0</span>, <span class="number">2</span>));</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>DateTime 获取当前时间, 以微秒为单位</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 输出当前时间, 以微秒为单位, 若直接将 $timeZone 作为 createFromFormat 的第三个参数是无效的, 问题是 microtime() 和 time()  返回的是当前时区的时间戳</span></span><br><span class="line"><span class="comment">// 参考 http://php.net/manual/zh/datetime.createfromformat.php#120552</span></span><br><span class="line">$timeZone = <span class="keyword">new</span> DateTimeZone(date_default_timezone_get() ? : <span class="string">'Asia/Shanghai'</span>);</span><br><span class="line">$ds = DateTime::createFromFormat(<span class="string">'U.u'</span>, microtime(<span class="keyword">true</span>))-&gt;setTimezone($timeZone);</span><br><span class="line">var_dump($ds-&gt;format(<span class="string">'Y-m-d H:i:s.u'</span>));</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>删除不可见字符与BOM头</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 删除ASCII码 0-31,127-255 字符</span></span><br><span class="line">$string = preg_replace(<span class="string">'/[\x00-\x1F\x7F-\xFF]/'</span>, <span class="string">''</span>, $string);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除ASCII码 0-31,127 字符</span></span><br><span class="line">$string = preg_replace(<span class="string">'/[\x00-\x1F\x7F]/'</span>, <span class="string">''</span>, $string);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除BOM,BOM的ASCII码为 239,187,191</span></span><br><span class="line">$string = trim($string, <span class="string">"\xEF\xBB\xBF"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// IOS提交的不可见字符</span></span><br><span class="line">$string = <span class="string">"‭1234567890‬"</span>;</span><br><span class="line">var_dump(json_encode([$string]));</span><br><span class="line">$string = preg_replace(<span class="string">'/[\x7F-\xFF]/'</span>, <span class="string">''</span>, $string);</span><br><span class="line">var_dump(json_encode([$string]));</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div class="note danger"><p>cURL 自定义 HEADER 参数</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$method = strtoupper($_SERVER[<span class="string">'REQUEST_METHOD'</span>]);</span><br><span class="line"><span class="keyword">if</span> ($method == <span class="string">'POST'</span>) &#123;</span><br><span class="line">    $postData = $_POST;</span><br><span class="line">    $headers = [];</span><br><span class="line">    $paramsArray = [<span class="string">'USERID'</span>, <span class="string">'RANDOM'</span>];</span><br><span class="line">    <span class="keyword">foreach</span> ($paramsArray <span class="keyword">as</span> $param) &#123;</span><br><span class="line">        $headers[$param] = $_SERVER[<span class="string">'HTTP_'</span> . $param];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    header(<span class="string">'content-type:application/json;charset=utf8'</span>);</span><br><span class="line">    <span class="keyword">die</span>(json_encode([$postData, $headers]));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $url = <span class="string">'http://localhost:8080/index.php'</span>;</span><br><span class="line">    $header = [<span class="string">'USERID:1'</span>, <span class="string">'RANDOM:'</span> . mt_rand(<span class="number">1</span>, <span class="number">1000</span>)];</span><br><span class="line">    $content = [<span class="string">'name'</span> =&gt; <span class="string">'test'</span>];</span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER, $header);</span><br><span class="line">    curl_setopt($ch, CURLOPT_POST, <span class="keyword">true</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($content));</span><br><span class="line">    $response = curl_exec($ch);</span><br><span class="line">    curl_close($ch);</span><br><span class="line">    var_dump($response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>二维数组指定字段排序</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$array = [</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'t1'</span>, <span class="string">'val'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'t3'</span>, <span class="string">'val'</span> =&gt; <span class="number">3</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'t2'</span>, <span class="string">'val'</span> =&gt; <span class="number">2</span>],</span><br><span class="line">];</span><br><span class="line">array_multisort($array, array_column($array, <span class="string">'val'</span>));</span><br><span class="line"><span class="comment">//array_multisort(array_column($array, 'val'), SORT_ASC, $array);</span></span><br><span class="line">var_dump($array);</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>图片转换数据流</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$imgPath = <span class="string">'./1.jpg'</span>;</span><br><span class="line"><span class="keyword">if</span> (file_exists($imgPath)) &#123;</span><br><span class="line">    $img = base64_encode(file_get_contents($imgPath));</span><br><span class="line">    $img = <span class="string">'data:image/jpg;base64,'</span> . $img;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $img = <span class="string">'data:image/jpg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/4QAiRXhpZgAATU0AKgAAAAgAAQESAAMAAAABAAEAAAAAAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAAkADIDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD7r/aV+LWl/sx/B/UvEfi7UElWYra2MCssZvJJG8sKzzFkVd7xpkqQocsc7dp+ZP2Rv2udb/aQ/aouvDXhH4c/bvC+qtZaXpEl9qCJPZ3MVneXV5e3J2BYxKEjjig+UCOJHADSMr9p+23+y9qX7Q9za2vhAa5ofiTxHp15pdo40+1lRLdbS8nSJHnjlaCR7sQbZYdjRK5EYw7g/cf7G/7BfhH9h7wFa+HfC0MZghEkc8nzMblFuZpbZiXLMJVjmdWYN87O7NuLbq/I8oyuWKlJvWOl/L08+vWyeq2T/SsbjsLhcHFWvUlf0+aXRfe31ttxWo/sq+P/ABZItrcar4d8OWapzDp9xPcSufRpPKTaB/dQ56jcQcjctv2EvC+m2yy3l/q1y8OcsojXceucsrE9u/Uc5r368mVAXZdqo3YfyrLv5mvdqrtKyEdeQBjP419TT4fwMNXHmfm3+W34HyjzbEy0TsvJf0zyHxt+zP4I8KfBzxU1jon2fUH0y4FtfJHNeXVnM0LhHiVSz/I3zBI+WYAYJxXh+gOviDw1Y30mktbzXSxvIhVNqkqCwBDE7QT16cZ5r6x+JnxI0X4T+CdS1/xFqNhpOj6dGjS3N3P5USksFUbj3ZmCgdSSB3r5Mn8T+HfEHiTxFqlp4msNW0ObUnurG8stQ3Ws8E0ccuEAIGI3mkhIxndCQfmyK8LiPCU6ShKklFbWSt/Wx6eU4ipU5lUbb3u9fkaEumhpWP8AZsLcnkyrz+YoqnDFotxCsnnTHzFDZ85xnPsWB/MUV8uexd9jsPDOh6xo/jDQ9WvvF1xJDp+o2906C0hRJEEqllJ2FgGAIJyOCeRivqzWPENvHdmNZApVmUEdcjg4HJr4h1XwN4H0rRo18QTxzQwxqkjatqTNGGAzn942Af1x617N8Jv2mPA8/wALPDuq67440eObVLGG5WSa5RZ7l/LXzdsaks+xgVYqm0EEclWr6bh3HKlKdF2SlZ3b009e54+a4OVSMaiu7aaLvr09Ge4Xtyottg5djxk9PU/5+lVTKPLkC5XHB2Lk+gA9PTHpXn1v+0x4B1q+t9O0jxx4Y/ta43SQ22oTNayXYUAsqCTYc4K/MA23I+U5AqL9pj4qXnwv+H80eiTPbeJr+WDTNMleya6t7W9upo7aGWdS8amGGSXzZQXTMcbAHcVFfXPFU1F1Lqy7aniRwlRyVOzu++h5B/wV18X3nw3/AGI/iN4ivvDtr4s8MaRo6XN5pTXhtXmk84IjGVR5sRSV7d4zERyku8hQFf8AHT9nvxr40/Zw8eqsPizUP7WggW7vNLmgt30e9Wd43dI42DyECZ3BdpfNbg7wS4T9Vv2wf2lZPh3pXiL4V+Odc8HX9n4ojvYY/tVvGtv4g0mWOJJLedAWVZImuPs8jK0e7Cuuwkhfyt8c+G/FutfFHUNB+HV9BHe6M0dtaa9JHJeLZBkDq0M6sYJZIshf3jZidIiRIwDD5bOm6yUoS93VO+0WuvXzvbXa19D6nJ6MoJxa13Vuq/q2/wA7an0NL/wXV8F6PK1nqfw7+J0epWpMN2lnocs9skq8OI5MfOgYHa3cYPeivTvhxqeg6H8PdBstYtbKTVrPTreC9YajbSbp1iVZDuMmW+YHk9aK+OljqCdlRl/4F/8AanufUZdWvu/+2O8/bY8MaP8Asz/slfETxr4d0fT5de8N6Wbqye/VriISllXe0ZIVsbicEYz1BGQeX8QabefBb4RTavofiDxRb65e6GmqX+oLrFxC+pSpHEYxNFEyQOqfaX2/ugRsjOcrmiiuyMnGKlHR3f5HPRbkve11X6GvZ/sXaDr3wLm8UX/iLxnqesyad9veTUtQTUYXlRWlUmG4jkiOHJIymVPzKVYBhxn7Ln7d/wARPjF4Es21jULFtQ1Sz020XUo7UG+tVmW9VnEz7mlkCwqBJcea2WYkljuBRXZltSapVLN7P8jTEQjO3Mr+8lr2ujovFvwy01fiZqHi3U2vvEXiDVNOj0Ke41W6e4gWzSUhYY7XItokBO7bHEq7stjc7lvYvCv7OfgrS9LOpXHh3S9Wv7hBum1C3S42rwAqqRtVQMDCgdBRRXmKTlK8tf8AhjPEScYWjpqPl8L6BbyNHH4W8KrHGSqqNHt8ADoPu0UUVtZHHzy7n//Z'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;img src='&#123;$img&#125;' /&gt;"</span>;</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>HEADER 介绍</p></div>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'HTTP/1.1 200 OK'</span>);                                              <span class="comment">// ok 正常访问</span></span><br><span class="line">header(<span class="string">'HTTP/1.1 404 Not Found'</span>);                                       <span class="comment">// 通知浏览器 页面不存在</span></span><br><span class="line">header(<span class="string">'HTTP/1.1 301 Moved Permanently'</span>);                               <span class="comment">// 设置地址被永久的重定向 301</span></span><br><span class="line">header(<span class="string">'Location: http://www.ruonu.com/'</span>);                              <span class="comment">// 跳转到一个新的地址</span></span><br><span class="line">header(<span class="string">'Refresh: 10; url=http://www.ruonu.com/'</span>);                       <span class="comment">// 延迟转向 也就是隔几秒跳转</span></span><br><span class="line">header(<span class="string">'X-Powered-By: PHP/6.0.0'</span>);                                      <span class="comment">// 修改 X-Powered-By信息</span></span><br><span class="line">header(<span class="string">'Content-language: en'</span>);                                         <span class="comment">// 文档语言</span></span><br><span class="line">header(<span class="string">'Content-Length: 1234'</span>);                                         <span class="comment">// 设置内容长度</span></span><br><span class="line">header(<span class="string">'Last-Modified: '</span> . gmdate(<span class="string">'D, d M Y H:i:s'</span>, $time) . <span class="string">' GMT'</span>);   <span class="comment">// 告诉浏览器最后一次修改时间</span></span><br><span class="line">header(<span class="string">'HTTP/1.1 304 Not Modified'</span>);                                    <span class="comment">// 告诉浏览器文档内容没有发生改变</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">###内容类型###</span></span><br><span class="line">header(<span class="string">'Content-Type: text/html; charset=utf-8'</span>);                       <span class="comment">// 网页编码</span></span><br><span class="line">header(<span class="string">'Content-Type: text/plain'</span>);                                     <span class="comment">// 纯文本格式</span></span><br><span class="line">header(<span class="string">'Content-Type: image/jpeg'</span>);                                     <span class="comment">// JPG、JPEG</span></span><br><span class="line">header(<span class="string">'Content-Type: application/zip'</span>);                                <span class="comment">// ZIP文件</span></span><br><span class="line">header(<span class="string">'Content-Type: application/pdf'</span>);                                <span class="comment">// PDF文件</span></span><br><span class="line">header(<span class="string">'Content-Type: audio/mpeg'</span>);                                     <span class="comment">// 音频文件</span></span><br><span class="line">header(<span class="string">'Content-type: text/css'</span>);                                       <span class="comment">// css文件</span></span><br><span class="line">header(<span class="string">'Content-type: text/javascript'</span>);                                <span class="comment">// js文件</span></span><br><span class="line">header(<span class="string">'Content-type: application/json'</span>);                               <span class="comment">// json</span></span><br><span class="line">header(<span class="string">'Content-type: application/pdf'</span>);                                <span class="comment">// pdf</span></span><br><span class="line">header(<span class="string">'Content-type: text/xml'</span>);                                       <span class="comment">// xml</span></span><br><span class="line">header(<span class="string">'Content-Type: application/x-shockw**e-flash'</span>);                  <span class="comment">// Flash动画</span></span><br><span class="line">header(<span class="string">'Content-Type: application/octet-stream'</span>);                       <span class="comment">// .*( 二进制流, 不知道下载文件类型)</span></span><br><span class="line"><span class="comment">######</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">###声明一个下载的文件###</span></span><br><span class="line">header(<span class="string">'Content-Description:File'</span>);                                     <span class="comment">// 描述</span></span><br><span class="line">header(<span class="string">'Content-Type: application/octet-stream'</span>);</span><br><span class="line">header(<span class="string">'Content-Disposition: attachment; filename="ITblog.zip"'</span>);</span><br><span class="line">header(<span class="string">'Content-Transfer-Encoding: binary'</span>);</span><br><span class="line">readfile(<span class="string">'test.zip'</span>);</span><br><span class="line"><span class="comment">######</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">###对当前文档禁用缓存###</span></span><br><span class="line">header(<span class="string">'Cache-Control: no-cache, no-store, max-age=0, must-revalidate'</span>);</span><br><span class="line">header(<span class="string">'Expires: Mon, 26 Jul 1997 05:00:00 GMT'</span>);</span><br><span class="line"><span class="comment">######</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">###显示一个需要验证的登陆对话框###</span></span><br><span class="line">header(<span class="string">'HTTP/1.1 401 Unauthorized'</span>);</span><br><span class="line">header(<span class="string">'WWW-Authenticate: Basic realm="Top Secret"'</span>);</span><br><span class="line"><span class="comment">######</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">###声明一个需要下载的xls文件###</span></span><br><span class="line">header(<span class="string">'Content-Disposition: attachment; filename=ithhc.xlsx'</span>);</span><br><span class="line">header(<span class="string">'Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'</span>);</span><br><span class="line">header(<span class="string">'Content-Length: '</span>.filesize(<span class="string">'./test.xls'</span>));</span><br><span class="line">header(<span class="string">'Content-Transfer-Encoding: binary'</span>);</span><br><span class="line">header(<span class="string">'Cache-Control: must-revalidate'</span>);</span><br><span class="line">header(<span class="string">'Pragma: public'</span>);</span><br><span class="line">readfile(<span class="string">'./test.xls'</span>);</span><br><span class="line"><span class="comment">######</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP 全局使用 Laravel 辅助函数 dd</title>
    <url>/PHP/global-uses-the-laravel-helper-function-dd.html</url>
    <content><![CDATA[<div class="note danger"><p>dump() 方法</p></div>
<h5 id="全局-composer-json"><a href="#全局-composer-json" class="headerlink" title="全局 composer.json"></a>全局 composer.json</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">"require"</span>: &#123;</span><br><span class="line">    <span class="string">"squizlabs/php_codesniffer"</span>: <span class="string">"*"</span>,</span><br><span class="line">    <span class="string">"fxp/composer-asset-plugin"</span>: <span class="string">"^1.4"</span>,</span><br><span class="line">    <span class="string">"symfony/var-dumper"</span>: <span class="string">"3.3.16"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="配置PHP-ini"><a href="#配置PHP-ini" class="headerlink" title="配置PHP.ini"></a>配置PHP.ini</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">auto_prepend_file = <span class="string">"C:\Users\MS\AppData\Roaming\Composer\vendor\autoload.php"</span></span><br></pre></td></tr></table></figure>
<h4 id="更新Composer"><a href="#更新Composer" class="headerlink" title="更新Composer"></a>更新Composer</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">composer global update</span><br></pre></td></tr></table></figure>
<p>更新后重启apache就可以全局使用函数 <code>dump()</code> </p>
<a id="more"></a>
<hr>
<div class="note danger"><p>dd() 方法</p></div>
<h4 id="全局-composer-json-1"><a href="#全局-composer-json-1" class="headerlink" title="全局 composer.json"></a>全局 composer.json</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># C:\Users\MS\AppData\Roaming\Composer\composer.json</span></span><br><span class="line"><span class="comment"># 新增 autoload</span></span><br><span class="line"><span class="string">"autoload"</span>: &#123;</span><br><span class="line">    <span class="string">"files"</span>: [</span><br><span class="line">        <span class="string">"D:/web/php/debugHelper.php"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="新建-debugHelper-php"><a href="#新建-debugHelper-php" class="headerlink" title="新建 debugHelper.php"></a>新建 <code>debugHelper.php</code></h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install symfony/var-dump to your project</span></span><br><span class="line"><span class="comment"># composer require symfony/var-dumper</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// use namespace</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">VarDumper</span>\<span class="title">Cloner</span>\<span class="title">VarCloner</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">VarDumper</span>\<span class="title">Dumper</span>\<span class="title">CliDumper</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">VarDumper</span>\<span class="title">Dumper</span>\<span class="title">HtmlDumper</span> <span class="title">as</span> <span class="title">SymfonyHtmlDumper</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Class HtmlDumper</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HtmlDumper</span> <span class="keyword">extends</span> <span class="title">SymfonyHtmlDumper</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Colour definitions for output.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $styles = [</span><br><span class="line">        <span class="string">'default'</span> =&gt; <span class="string">'background-color:#fff; color:#222; line-height:1.2em; font-weight:normal; font:12px Monaco, Consolas, monospace; word-wrap: break-word; white-space: pre-wrap; position:relative; z-index:100000'</span>,</span><br><span class="line">        <span class="string">'num'</span> =&gt; <span class="string">'color:#a71d5d'</span>,</span><br><span class="line">        <span class="string">'const'</span> =&gt; <span class="string">'color:#795da3'</span>,</span><br><span class="line">        <span class="string">'str'</span> =&gt; <span class="string">'color:#df5000'</span>,</span><br><span class="line">        <span class="string">'cchr'</span> =&gt; <span class="string">'color:#222'</span>,</span><br><span class="line">        <span class="string">'note'</span> =&gt; <span class="string">'color:#a71d5d'</span>,</span><br><span class="line">        <span class="string">'ref'</span> =&gt; <span class="string">'color:#a0a0a0'</span>,</span><br><span class="line">        <span class="string">'public'</span> =&gt; <span class="string">'color:#795da3'</span>,</span><br><span class="line">        <span class="string">'protected'</span> =&gt; <span class="string">'color:#795da3'</span>,</span><br><span class="line">        <span class="string">'private'</span> =&gt; <span class="string">'color:#795da3'</span>,</span><br><span class="line">        <span class="string">'meta'</span> =&gt; <span class="string">'color:#b729d9'</span>,</span><br><span class="line">        <span class="string">'key'</span> =&gt; <span class="string">'color:#df5000'</span>,</span><br><span class="line">        <span class="string">'index'</span> =&gt; <span class="string">'color:#a71d5d'</span>,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Class Dumper</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dumper</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Dump a value with elegance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  mixed  $value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dump</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (class_exists(CliDumper::class)) &#123;</span><br><span class="line">            $dumper = <span class="string">'cli'</span> === PHP_SAPI ? <span class="keyword">new</span> CliDumper : <span class="keyword">new</span> HtmlDumper;</span><br><span class="line">            $dumper-&gt;dump((<span class="keyword">new</span> VarCloner)-&gt;cloneVar($value));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            var_dump($value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (! function_exists(<span class="string">'dd'</span>)) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Dump the passed variables and end the script.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  mixed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dd</span><span class="params">(...$args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($args <span class="keyword">as</span> $x) &#123;</span><br><span class="line">            (<span class="keyword">new</span> Dumper)-&gt;dump($x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">die</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (! function_exists(<span class="string">'dda'</span>)) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Dump the passed array variables and end the script.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  mixed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dda</span><span class="params">(...$args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($args <span class="keyword">as</span> $x) &#123;</span><br><span class="line">            (<span class="keyword">new</span> Dumper)-&gt;dump($x-&gt;toArray());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">die</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="更新composer自动加载"><a href="#更新composer自动加载" class="headerlink" title="更新composer自动加载"></a>更新composer自动加载</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">composer global dump-autoload</span><br></pre></td></tr></table></figure>
<p>更新后就可以全局使用函数 <code>dd()</code> </p>
<div class="note default"><p>原文链接：<a href="https://novnan.github.io/PHP/php-global-uses-the-laravel-helper-function-dd/" target="_blank" rel="noopener">PHP 全局使用 Laravel 辅助函数 dd</a></p></div>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 主从配置</title>
    <url>/MySQL/mysql-master-slave-configuration.html</url>
    <content><![CDATA[<table>
<thead>
<tr>
<th>操作系统</th>
<th>mysql版本</th>
<th>IP</th>
<th>主从关系</th>
<th>简称</th>
</tr>
</thead>
<tbody>
<tr>
<td>Win8.1-64位</td>
<td>5.7.14</td>
<td>192.168.50.87</td>
<td>主【Master】</td>
<td>Master</td>
</tr>
<tr>
<td>虚拟机【Centos7 64位】</td>
<td>5.7.18</td>
<td>192.168.227.128</td>
<td>从【Slave】</td>
<td>Slave</td>
</tr>
</tbody>
</table>
<h4 id="Master-配置"><a href="#Master-配置" class="headerlink" title="Master 配置"></a>Master 配置</h4><ol>
<li><p>配置 my.ini, 配置后需重启</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id=1             <span class="comment">#标识唯一的数据库,这里设置为1,在设置从库的时候就需要设置为其他值</span></span><br><span class="line"><span class="built_in">log</span>-bin=mysql-bin       <span class="comment">#打开日志</span></span><br><span class="line">binlog-ignore-db=mysql  <span class="comment">#指定不需要同步的数据库[可以添加多条binlog-ignore-db命令]</span></span><br><span class="line">binlog-do-db=<span class="built_in">test</span>       <span class="comment">#指定需要同步的数据库[可以添加多条binlog-do-db命令]</span></span><br><span class="line"><span class="comment">#expire_log_days=1      #自动清理1天前的log文件</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建从库权限账号 <code>test</code>, 密码 <code>test</code>,设置 <code>File</code>、<code>REPLICATION SALVE</code> 权限, 并只允许来源地址为 <code>192.168.227.128</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">FILE</span>,<span class="keyword">REPLICATION</span> <span class="keyword">SLAVE</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'test'</span>@<span class="string">'192.168.50.82'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'test'</span>;</span><br><span class="line"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看主库信息,这里的 <code>File</code>, <code>Position</code> 在配置 <strong>Slave</strong> 时会用到</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line">+<span class="comment">------------------+----------+---------------+------------------+-------------------+</span></span><br><span class="line">| File             | Position | Binlog_Do_DB  | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+<span class="comment">------------------+----------+---------------+------------------+-------------------+</span></span><br><span class="line">| mysql-bin.000001 |      154 | test          | mysql            |                   |</span><br><span class="line">+<span class="comment">------------------+----------+---------------+------------------+-------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.20</span> sec)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<a id="more"></a>
<ol>
<li><p>在 <strong>Slave</strong> 连接 <strong>Master</strong> 的 MySQL,测试是否能连接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql -h 192.168.50.87 -u <span class="built_in">test</span> -p</span><br><span class="line"><span class="comment">#若 虚拟机 的网络连接方式为 NAT 模式【桥接模式不需要】,则需要在 Master 运行如下命令：</span></span><br><span class="line">UPDATE `user` SET Host=<span class="string">'%'</span> WHERE user = <span class="string">'test'</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"><span class="comment">#若还是无法连接,配置主机的防火墙-&gt;高级设置-&gt;入站规则-&gt;端口-&gt;TCP、特定本地端口、3306</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主库相关命令：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">#查看主机二进制Log文件列表</span><br><span class="line"><span class="keyword">show</span> <span class="built_in">binary</span> <span class="keyword">logs</span>;</span><br><span class="line">#提交日志(生成新的二进制日志文件)</span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">logs</span>;</span><br><span class="line">#清除之前所有的二进制Log文件,并且新的Log文件后缀从 000001 开始</span><br><span class="line"><span class="keyword">reset</span> <span class="keyword">master</span>;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="Slave-配置"><a href="#Slave-配置" class="headerlink" title="Slave 配置"></a>Slave 配置</h4><ol>
<li><p>配置 /etc/my.cnf, 配置后需重启</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line"><span class="built_in">log</span>-bin=mysql-bin</span><br><span class="line">replicate-ignore-db=mysql   <span class="comment">#指定不需要从主机同步的数据库</span></span><br><span class="line">replicate-do-db=<span class="built_in">test</span>        <span class="comment">#指定需要从主机同步的数据库</span></span><br><span class="line"><span class="built_in">log</span>-slave-updates           <span class="comment">#从库从主库复制的数据会写入log-bin日志文件,若未开启,则不会写入log-bin日志文件</span></span><br><span class="line">slave-skip-errors=all       <span class="comment">#跳过错误</span></span><br><span class="line">slave-net-timeout=60        <span class="comment">#若60秒主库没有推送数据,则会重连并且追赶这段时间主库的数据</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>运行如下命令： [<code>master_log_file</code> 对应配置 <strong>Master</strong> 时的File, <code>master_log_pos</code> 对应配置 <strong>Master</strong> 时的 <code>Position</code>]</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">stop</span> <span class="keyword">slave</span>;</span><br><span class="line"><span class="keyword">change</span> <span class="keyword">master</span> <span class="keyword">to</span> master_host=<span class="string">'192.168.50.87'</span>,master_user=<span class="string">'test'</span>,master_password=<span class="string">'test'</span>,master_log_file=<span class="string">'mysql-bin.000001'</span>,master_log_pos=<span class="number">617</span>;</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">slave</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看从库信息</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.50.87</span><br><span class="line">                  Master_User: test</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000015</span><br><span class="line">          Read_Master_Log_Pos: 154</span><br><span class="line">               Relay_Log_File: localhost-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 286</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000015</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: test</span><br><span class="line">          Replicate_Ignore_DB: mysql</span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 154</span><br><span class="line">              Relay_Log_Space: 463</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: 3e9c0cca-984e-11e7-82aa-1c1b0d252d4a</span><br><span class="line">             Master_Info_File: /alidata/server/mysql-5.6.21/data/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to <span class="keyword">update</span> it</span><br><span class="line">           Master_Retry_Count: <span class="number">86400</span></span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: <span class="number">0</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>从库相关命令：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">#在从机上查询主机二进制Log文件列表</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">master</span> <span class="keyword">logs</span>;  </span><br><span class="line">#如果从库同步出错,解决方法如下：</span><br><span class="line">#第一种</span><br><span class="line"><span class="keyword">stop</span> <span class="keyword">slave</span>;</span><br><span class="line"><span class="keyword">change</span> <span class="keyword">master</span> <span class="keyword">to</span> master_host=<span class="string">'192.168.50.87'</span>,master_user=<span class="string">'test'</span>,master_password=<span class="string">'test'</span>,master_log_file=<span class="string">'mysql-bin.000001'</span>,master_log_pos=<span class="number">617</span>;</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">slave</span>;</span><br><span class="line">#第二种</span><br><span class="line"><span class="keyword">stop</span> <span class="keyword">slave</span>;</span><br><span class="line"><span class="keyword">reset</span> <span class="keyword">slave</span>;</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">slave</span>;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="/uploads/mysql/mysql-master-slave-configuration/4e2e2c4b7b42e6c215126fdefc706fc8.gif" alt=""></p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Symfony3 相关问题</title>
    <url>/Symfony/symfony-questions.html</url>
    <content><![CDATA[<ol>
<li><p>访问新Bundle报错</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(1/1) ClassNotFoundException</span><br><span class="line">Attempted to load class <span class="string">"AppBundle"</span> from namespace <span class="string">"Bundles\AppBundle"</span>.</span><br><span class="line">Did you forget a <span class="string">"use"</span> statement <span class="keyword">for</span> another namespace?</span><br></pre></td></tr></table></figure>
<p>打开 composer.json 文件,修改如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">"autoload"</span>: &#123;</span><br><span class="line">  <span class="string">"psr-4"</span>: &#123;</span><br><span class="line">      <span class="string">""</span>: <span class="string">"src/"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"classmap"</span>: [ <span class="string">"app/AppKernel.php"</span>, <span class="string">"app/AppCache.php"</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改后运行 <code>composer dump-autoload</code></p>
</li>
<li><p>生成实体类报错</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[RuntimeException]</span><br><span class="line">  Namespace <span class="string">"Bundles\CommonBundle"</span> does not contain any mapped entities.</span><br></pre></td></tr></table></figure>
<p>打开 config.yml, 配置 doctrine, 添加 mappings</p>
<pre><code class="bash">orm:    
 mappings:
     CommonBundle: ~
     <span class="comment">#CommonBundle:</span>
     <span class="comment">#    type: yml</span>
     <span class="comment">#    dir: Resources/config/doctrine</span>
</code></pre>
</li>
</ol>
]]></content>
      <categories>
        <category>Symfony</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>symfony</tag>
      </tags>
  </entry>
  <entry>
    <title>Symfony3 常用命令</title>
    <url>/Symfony/symfony-commands.html</url>
    <content><![CDATA[<div class="note danger"><p>Bundle</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#生成Bundle,配置格式选择 yml</span></span><br><span class="line">php bin/console generate:bundle --namespace=Bundles/AppBundle</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>Doctrine</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#Doctrine 自检数据库并生成相应的元数据文件</span></span><br><span class="line">php bin/console doctrine:mapping:import CommonBundle yml</span><br><span class="line"><span class="comment">#生成单个表对应的元数据文件</span></span><br><span class="line">php bin/console doctrine:mapping:import CommonBundle --filter=Admin yml</span><br><span class="line"><span class="comment">#生成实体类</span></span><br><span class="line">php bin/console doctrine:generate:entities CommonBundle</span><br><span class="line"><span class="comment">#生成单个表的实体类</span></span><br><span class="line">php bin/console doctrine:generate:entities CommonBundle:Admin --path=src</span><br></pre></td></tr></table></figure>
<p>生成元数据文件后,并未生成 <code>repositoryClass</code> 参数,方法如下(修改后重新生成元数据文件即可)：<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// \vendor\doctrine\orm\lib\Doctrine\ORM\Tools\Export\Driver\YamlExporter.php</span></span><br><span class="line"><span class="comment">// exportClassMetadata 方法,添加 $metadata-&gt;customRepositoryClassName 为空的处理</span></span><br><span class="line"><span class="keyword">if</span> ($metadata-&gt;customRepositoryClassName) &#123;</span><br><span class="line">    $array[<span class="string">'repositoryClass'</span>] = $metadata-&gt;customRepositoryClassName;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $array[<span class="string">'repositoryClass'</span>] = str_replace(<span class="string">'\\Entity\\'</span>, <span class="string">'\\EntityRepository\\'</span>, $metadata-&gt;name) . <span class="string">'Repository'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>生成不带表前缀的元数据文件 <code>vendor\doctrine\doctrine-bundle\Command\ImportMappingDoctrineCommand.php</code> 第 137 行</p>
]]></content>
      <categories>
        <category>Symfony</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>symfony</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux Crontab 实现秒级定时任务及普通用户运行crontab</title>
    <url>/Linux/crontab.html</url>
    <content><![CDATA[<blockquote><p>crontab.sh</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">PHP_BIN=/alidata/server/php/bin/php</span><br><span class="line">BASE_PATH=/alidata/www/symfony/bin/</span><br><span class="line"></span><br><span class="line">cd $&#123;BASE_PATH&#125;</span><br><span class="line"></span><br><span class="line">umask 002</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;PHP_BIN&#125; \</span></span><br><span class="line">-d date.timezone=Asia/Shanghai \</span><br><span class="line">-d mbstring.http_input=UTF-8 \</span><br><span class="line">-d mbstring.http_output=UTF-8 \</span><br><span class="line">-d mbstring.internal_encoding=UTF-8 \</span><br><span class="line">-d default_charset=UTF-8 \</span><br><span class="line">-d magic_quotes_gpc=off \</span><br><span class="line">-d magic_quotes_runtime=off \</span><br><span class="line">crontab.php</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<blockquote><p>crontab.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">file_put_contents(<span class="string">'./crontab.txt'</span>, date(<span class="string">'Y-m-d H:i:s'</span>) . PHP_EOL, FILE_APPEND);</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>推荐使用第一种方式,若对时间精确度要求不高可以使用第二种方式</p></div>
<h4 id="第一种方式：创建多个定时任务"><a href="#第一种方式：创建多个定时任务" class="headerlink" title="第一种方式：创建多个定时任务"></a>第一种方式：创建多个定时任务</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#crontab 添加任务</span></span><br><span class="line">*/1 * * * * /alidata/www/symfony/bin/crontab.sh &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">*/1 * * * * sleep 5 &amp;&amp; /alidata/www/symfony/bin/crontab.sh &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">*/1 * * * * sleep 10 &amp;&amp; /alidata/www/symfony/bin/crontab.sh &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">*/1 * * * * sleep 15 &amp;&amp; /alidata/www/symfony/bin/crontab.sh &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">*/1 * * * * sleep 20 &amp;&amp; /alidata/www/symfony/bin/crontab.sh &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">*/1 * * * * sleep 25 &amp;&amp; /alidata/www/symfony/bin/crontab.sh &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">*/1 * * * * sleep 30 &amp;&amp; /alidata/www/symfony/bin/crontab.sh &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">*/1 * * * * sleep 35 &amp;&amp; /alidata/www/symfony/bin/crontab.sh &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">*/1 * * * * sleep 40 &amp;&amp; /alidata/www/symfony/bin/crontab.sh &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">*/1 * * * * sleep 45 &amp;&amp; /alidata/www/symfony/bin/crontab.sh &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">*/1 * * * * sleep 50 &amp;&amp; /alidata/www/symfony/bin/crontab.sh &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">*/1 * * * * sleep 55 &amp;&amp; /alidata/www/symfony/bin/crontab.sh &gt;/dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<h4 id="第二种方式：Shell-循环"><a href="#第二种方式：Shell-循环" class="headerlink" title="第二种方式：Shell 循环"></a>第二种方式：Shell 循环</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#contab 添加任务,每分钟执行一次</span></span><br><span class="line">crontab -e</span><br><span class="line">*/1 * * * * /alidata/www/symfony/bin/crontab.sh &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="comment">#修改crontab.sh</span></span><br><span class="line">step=5</span><br><span class="line"><span class="keyword">for</span> ((i = 0; i &lt; 60; i = (i + step)))</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="variable">$&#123;PHP_BIN&#125;</span> \</span><br><span class="line">        -d date.timezone=Asia/Shanghai \</span><br><span class="line">        -d mbstring.http_input=UTF-8 \</span><br><span class="line">        -d mbstring.http_output=UTF-8 \</span><br><span class="line">        -d mbstring.internal_encoding=UTF-8 \</span><br><span class="line">        -d default_charset=UTF-8 \</span><br><span class="line">        -d magic_quotes_gpc=off \</span><br><span class="line">        -d magic_quotes_runtime=off \</span><br><span class="line">        crontab.php</span><br><span class="line">        sleep <span class="variable">$step</span></span><br><span class="line">    <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<div class="note danger"><p>普通用户运行crontab</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#指定www用户主目录,必须有效,用户是否能登录不重要</span></span><br><span class="line">vi /etc/passwd</span><br><span class="line">www:x:1000:1000::/alidata/www:/sbin/nologin</span><br><span class="line"><span class="comment">#搜索下sh执行程序路径,这里路径是 /usr/bin/sh</span></span><br><span class="line">[root@localhost bin]<span class="comment"># whereis sh</span></span><br><span class="line">sh: /usr/bin/sh /usr/share/man/man1/sh.1.gz</span><br><span class="line"><span class="comment">#添加定时任务,指定为www用户添加定时任务</span></span><br><span class="line">crontab -e -u www</span><br><span class="line">*/1 * * * * /usr/bin/sh /alidata/www/symfony/bin/crontab.sh</span><br><span class="line"><span class="comment">#重启服务</span></span><br><span class="line">service crond restart</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>crontab 常用命令</p></div>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#为指定用户添加定时任务</span></span><br><span class="line">crontab -e -u 用户名</span><br><span class="line"><span class="comment">#查看指定用户的定时任务</span></span><br><span class="line">crontab -l -u 用户名</span><br><span class="line"><span class="comment">#启动|停止|重启服务</span></span><br><span class="line">service crond start|stop|restart </span><br><span class="line"><span class="comment">#查看定时任务执行情况</span></span><br><span class="line">tail -f /var/<span class="built_in">log</span>/cron</span><br><span class="line"><span class="comment">#定时任务生成的文件所在路径,可直接编辑</span></span><br><span class="line">/var/spool/cron/用户名</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>crontab</tag>
      </tags>
  </entry>
  <entry>
    <title>生成XML的四种方式</title>
    <url>/PHP/generate-xml.html</url>
    <content><![CDATA[<ol>
<li>使用纯粹的PHP代码生成字符串,并把这个字符串写入一个以XML为后缀的文件<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create_item</span><span class="params">($titleData, $titleSize, $contentData, $pubdateData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $item = <span class="string">"&lt;item&gt;\n"</span>;</span><br><span class="line">    $item .= <span class="string">"&lt;title size=\""</span> . $titleSize . <span class="string">"\"&gt;"</span> . $titleData . <span class="string">"&lt;/title&gt;\n"</span>;</span><br><span class="line">    $item .= <span class="string">"&lt;content&gt;"</span> . $contentData . <span class="string">"&lt;/content&gt;\n"</span>;</span><br><span class="line">    $item .= <span class="string">"&lt;pubdate&gt;"</span> . $pubdateData . <span class="string">"&lt;/pubdate&gt;\n"</span>;</span><br><span class="line">    $item .= <span class="string">"&lt;/item&gt;\n"</span>;</span><br><span class="line">    <span class="keyword">return</span> $item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$dataArray = [</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'title'</span> =&gt; <span class="string">'title1'</span>,</span><br><span class="line">        <span class="string">'content'</span> =&gt; <span class="string">'content1'</span>,</span><br><span class="line">        <span class="string">'pubdate'</span> =&gt; <span class="string">'2009-10-11'</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'title'</span> =&gt; <span class="string">'title2'</span>,</span><br><span class="line">        <span class="string">'content'</span> =&gt; <span class="string">'content2'</span>,</span><br><span class="line">        <span class="string">'pubdate'</span> =&gt; <span class="string">'2009-11-11'</span></span><br><span class="line">    ]</span><br><span class="line">];</span><br><span class="line">$titleSize = <span class="number">1</span>;</span><br><span class="line">$xml = <span class="string">"&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n"</span>;</span><br><span class="line">$xml .= <span class="string">"&lt;article&gt;\n"</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($dataArray <span class="keyword">as</span> $data) &#123;</span><br><span class="line">    $xml .= create_item($data[<span class="string">'title'</span>], $titleSize, $data[<span class="string">'content'</span>], $data[<span class="string">'pubdate'</span>]);</span><br><span class="line">&#125;</span><br><span class="line">$xml .= <span class="string">"&lt;/article&gt;\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $xml;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<a id="more"></a>
<ol>
<li><p>使用DomDocument生成XML文件,创建节点使用createElement方法,创建文本内容使用createTextNode方法,添加子节点使用appendChild方法,创建属性使用createAttribute方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// $$ 可变变量,例：$one = 'hello'; $hello = 'world'; echo $one . ' ' . $$one; 结果为： hello world</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create_item</span><span class="params">($dom, $item, $data, $attribute)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">            <span class="comment">// 创建元素</span></span><br><span class="line">            $$key = $dom-&gt;createElement($key);</span><br><span class="line">            $item-&gt;appendchild($$key);</span><br><span class="line">            <span class="comment">// 创建元素值</span></span><br><span class="line">            $text = $dom-&gt;createTextNode($val);</span><br><span class="line">            $$key-&gt;appendchild($text);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($attribute[$key])) &#123;</span><br><span class="line">                <span class="comment">// 如果此字段存在相关属性需要设置</span></span><br><span class="line">                <span class="keyword">foreach</span> ($attribute[$key] <span class="keyword">as</span> $akey =&gt; $row) &#123;</span><br><span class="line">                    <span class="comment">// 创建属性节点</span></span><br><span class="line">                    $$akey = $dom-&gt;createAttribute($akey);</span><br><span class="line">                    $$key-&gt;appendchild($$akey);</span><br><span class="line">                    <span class="comment">// 创建属性值节点</span></span><br><span class="line">                    $aval = $dom-&gt;createTextNode($row);</span><br><span class="line">                    $$akey-&gt;appendChild($aval);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$dataArray = [</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'title'</span> =&gt; <span class="string">'title1'</span>,</span><br><span class="line">        <span class="string">'content'</span> =&gt; <span class="string">'content1'</span>,</span><br><span class="line">        <span class="string">'pubdate'</span> =&gt; <span class="string">'2009-10-11'</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'title'</span> =&gt; <span class="string">'title2'</span>,</span><br><span class="line">        <span class="string">'content'</span> =&gt; <span class="string">'content2'</span>,</span><br><span class="line">        <span class="string">'pubdate'</span> =&gt; <span class="string">'2009-11-11'</span></span><br><span class="line">    ]</span><br><span class="line">];</span><br><span class="line"><span class="comment">// 属性数组</span></span><br><span class="line">$attributeArray = [<span class="string">'title'</span> =&gt; [<span class="string">'size'</span> =&gt; <span class="number">1</span>]];</span><br><span class="line"><span class="comment">// 创建一个XML文档并设置XML版本和编码</span></span><br><span class="line">$dom = <span class="keyword">new</span> DomDocument(<span class="string">'1.0'</span>, <span class="string">'utf-8'</span>);</span><br><span class="line"><span class="comment">// 创建根节点</span></span><br><span class="line">$article = $dom-&gt;createElement(<span class="string">'article'</span>);</span><br><span class="line">$dom-&gt;appendchild($article);</span><br><span class="line"><span class="keyword">foreach</span> ($dataArray <span class="keyword">as</span> $data) &#123;</span><br><span class="line">    $item = $dom-&gt;createElement(<span class="string">'item'</span>);</span><br><span class="line">    $article-&gt;appendchild($item);</span><br><span class="line">    create_item($dom, $item, $data, $attributeArray);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $dom-&gt;saveXML();</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用XMLWriter类创建XML文件,此方法在PHP 5.1.2后有效.另外,它可以输出多种编码的XML,但是输入只能是utf-8</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$dataArray = [</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'title'</span> =&gt; <span class="string">'title1'</span>,</span><br><span class="line">        <span class="string">'content'</span> =&gt; <span class="string">'content1'</span>,</span><br><span class="line">        <span class="string">'pubdate'</span> =&gt; <span class="string">'2009-10-11'</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'title'</span> =&gt; <span class="string">'title2'</span>,</span><br><span class="line">        <span class="string">'content'</span> =&gt; <span class="string">'content2'</span>,</span><br><span class="line">        <span class="string">'pubdate'</span> =&gt; <span class="string">'2009-11-11'</span></span><br><span class="line">    ]</span><br><span class="line">];</span><br><span class="line"><span class="comment">// 属性数组</span></span><br><span class="line">$attributeArray = [<span class="string">'title'</span> =&gt; [<span class="string">'size'</span> =&gt; <span class="number">1</span>]];</span><br><span class="line">$xml = <span class="keyword">new</span> XMLWriter();</span><br><span class="line">$xml-&gt;openUri(<span class="string">"php://output"</span>);</span><br><span class="line"><span class="comment">// 输出方式, 也可以设置为某个xml文件地址, 直接输出成文件</span></span><br><span class="line">$xml-&gt;setIndentString(<span class="string">'  '</span>);</span><br><span class="line">$xml-&gt;setIndent(<span class="keyword">true</span>);</span><br><span class="line">$xml-&gt;startDocument(<span class="string">'1.0'</span>, <span class="string">'utf-8'</span>);</span><br><span class="line"><span class="comment">// 开始创建文件, 根结点</span></span><br><span class="line">$xml-&gt;startElement(<span class="string">'article'</span>);</span><br><span class="line"><span class="keyword">foreach</span> ($dataArray <span class="keyword">as</span> $data) &#123;</span><br><span class="line">    $xml-&gt;startElement(<span class="string">'item'</span>);</span><br><span class="line">    <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $row) &#123;</span><br><span class="line">            $xml-&gt;startElement($key);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($attributeArray[$key]) &amp;&amp; is_array($attributeArray[$key])) &#123;</span><br><span class="line">                <span class="keyword">foreach</span> ($attributeArray[$key] <span class="keyword">as</span> $akey =&gt; $aval) &#123;</span><br><span class="line">                    <span class="comment">// 设置属性值</span></span><br><span class="line">                    $xml-&gt;writeAttribute($akey, $aval);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $xml-&gt;text($row);</span><br><span class="line">            $xml-&gt;endElement();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $xml-&gt;endElement();</span><br><span class="line">&#125;</span><br><span class="line">$xml-&gt;endElement();</span><br><span class="line">$xml-&gt;endDocument();</span><br><span class="line">$xml-&gt;flush();</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用SimpleXML创建XML文档</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$dataArray = [</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'title'</span> =&gt; <span class="string">'title1'</span>,</span><br><span class="line">        <span class="string">'content'</span> =&gt; <span class="string">'content1'</span>,</span><br><span class="line">        <span class="string">'pubdate'</span> =&gt; <span class="string">'2009-10-11'</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'title'</span> =&gt; <span class="string">'title2'</span>,</span><br><span class="line">        <span class="string">'content'</span> =&gt; <span class="string">'content2'</span>,</span><br><span class="line">        <span class="string">'pubdate'</span> =&gt; <span class="string">'2009-11-11'</span></span><br><span class="line">    ]</span><br><span class="line">];</span><br><span class="line"><span class="comment">// 属性数组</span></span><br><span class="line">$attributeArray = [<span class="string">'title'</span> =&gt; [<span class="string">'size'</span> =&gt; <span class="number">1</span>]];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 第一种</span></span><br><span class="line">$string = <span class="string">&lt;&lt;&lt;XML</span></span><br><span class="line"><span class="string">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="string">&lt;article&gt;</span></span><br><span class="line"><span class="string">&lt;/article&gt;</span></span><br><span class="line"><span class="string">XML;</span></span><br><span class="line">$xml = simplexml_load_string($string);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 第二种</span></span><br><span class="line">$xml = <span class="keyword">new</span> SimpleXMLElement(<span class="string">'&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;article&gt;&lt;/article&gt;'</span>); </span><br><span class="line"><span class="keyword">foreach</span> ($dataArray <span class="keyword">as</span> $data) &#123;</span><br><span class="line">    $item = $xml-&gt;addChild(<span class="string">'item'</span>);</span><br><span class="line">    <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $row) &#123;</span><br><span class="line">            $node = $item-&gt;addChild($key, $row);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($attributeArray[$key]) &amp;&amp; is_array($attributeArray[$key])) &#123;</span><br><span class="line">                <span class="keyword">foreach</span> ($attributeArray[$key] <span class="keyword">as</span> $akey =&gt; $aval) &#123;</span><br><span class="line">                    <span class="comment">// 设置属性值</span></span><br><span class="line">                    $node-&gt;addAttribute($akey, $aval);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $xml-&gt;asXML();</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>xml</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP 代码规范</title>
    <url>/PHP/coding-standards.html</url>
    <content><![CDATA[<div class="note danger"><p>基本要求</p></div>
<ol>
<li>以标准计算机英文为蓝本,杜绝一切拼音、或拼音英文混杂的命名方式</li>
<li>纯PHP代码源文件只使用 <font color="red">&lt;?php</font> 标签,省略关闭标签 <font color="red">?&gt;</font></li>
<li>源文件中PHP代码的编码格式必须是无BOM的UTF-8格式</li>
<li>一个源文件只做一种类型的声明,即这个文件专门用来声明Class,那个文件专门用来设置配置信息,别混在一起写</li>
<li>使用Tab键来缩进,每个Tab键长度设置为4个空格</li>
<li>一行推荐的是最多写120个字符,多于这个字符就应该换行了</li>
<li>关键字必须小写,boolean值：true,false,null 也必须小写</li>
<li>涉及到多个数据表 更新/添加 操作时,最外层要用事务,保证数据库操作的原子性</li>
<li>Model层,只做简单的数据表的查询</li>
<li>业务逻辑统一封装到 Logic层</li>
<li>控制器只做URL路由,不要当作 业务方法 调用,不能出现SQL操作语句</li>
</ol>
<a id="more"></a>
<div class="note danger"><p>命名规范</p></div>
<ol>
<li>变量命名,采用驼峰式写法,以大写字母作为单词的分隔,其他的字母均使用小写,单词的首个字母使用小写.例：$orderList</li>
<li>数组变量命名,采用驼峰式写法,以大写字母作为单词的分隔,其他的字母均使用小写,单词的首个字母使用小写.例：$userArray</li>
<li>全局变量命名,带前缀 ‘g’,采用驼峰式写法,使用大写字母作为词的分隔,其他的字母均使用小写,标明一个变量的作用域.例：global $gLog;</li>
<li>全局常量命名,所有字母都使用大写,以下划线 ‘_’ 分隔每个单词.例：define(‘WEB_NAME’, ‘博客’);</li>
<li>静态变量命名,带前缀 ‘s’,采用驼峰式写法,使用大写字母作为词的分隔,其他的字母均使用小写.例：function test() {static $sStatus = 0;}</li>
<li>函数命名,使用小写字母、下划线组合.例：function get_client_ip () {}</li>
<li>类文件命名,类的文件名与类的名字保持一致,包括大小写,以 “ .class.php”作为文件的后缀.例：User 类保存的文件名称是 User.class.php,UserAccount 类保存的文件名称是 UserAccount.class.php</li>
<li>类的命名,采用驼峰式写法,以大写字母作为词的分隔,其他的字母均使用小写,名词的首个字母使用大写,不使用下划线.例：class User {}, class UserAccount {}</li>
<li>类属性命名,以字符 ‘m’ 为前缀,采用驼峰式写法,以大写字母作为词的分隔,其他的字母均使用小写.例：public $mUserName;  (习惯了 public $userName; 通常下划线开头的属性为私有属性 private $_userName;)</li>
<li>类方法命名,采用驼峰法,即以大写字母作为词的分隔,其他的字母均使用小写.例：public function checkEmail () {}  (通常下划线开头的方法为私有方法 private function _checkEmail () {})</li>
<li>类方法参数命名,采用驼峰式写法,以大写字母作为单词的分隔,其他的字母均使用小写,单词的首个字母使用小写.例：public function checkPwd ($oldPwd, $newPwd) {}</li>
<li>类的实例对象的命名(对象变量命名),以下划线开头,采用驼峰式写法,以大写字母作为单词的分隔,其他的字母均使用小写,单词的首个字母使用小写.例：$_user = new User();  $_userAccount = new UserAccount();  也可以使用 $user_obj = new User();  $user_account_obj = new UserAccount();</li>
<li>引用变量,以字符 ‘r’ 为前缀.例：function get_tree (&amp;$rData) {}</li>
<li>所有命名可以组合使用.例：class User { public static $msUserName;} 既是类属性又是静态变量</li>
<li>模板文件名命名,所有字母都使用小写,使用 ‘_’ 作为每个词的分界.例：user_list.html  </li>
<li>文件名的命名,所有字母都使用小写,使用 ‘_’ 作为每个词的分界.例：user_list.php</li>
<li>数据库命名,表名所有字母都使用小写,使用 ‘_’ 作为每个词的分界,数据字段命名也与数据表命名相同.例： ms_user,ms_user_info</li>
</ol>
<!-- more -->
<div class="note danger"><p>代码样式风格</p></div>
<ol>
<li><p>命名空间(Namespace) 和 导入(Use)声明</p>
<blockquote><ol>
<li>命名空间(namespace)的声明后面必须有一行空行</li>
<li>所有的导入(use)声明必须放在命名空间(namespace)声明的下面</li>
<li>一句声明中,必须只有一个导入(use)关键字</li>
<li>在导入(use)声明代码块后面必须有一行空行</li>
</ol>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Lib</span>\<span class="title">Databases</span>;                <span class="comment">// 下面必须空一行</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">FooInterface</span>;                       <span class="comment">// use 必须在namespace 后面声明</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">BarClass</span> <span class="title">as</span> <span class="title">Bar</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">OtherVendor</span>\<span class="title">OtherPackage</span>\<span class="title">BazClass</span>;  <span class="comment">// 下面必须空一行</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySQL</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>类(class),属性(property)和方法(method)</p>
<blockquote><ol>
<li>继承(extends) 和实现(implement) 必须和 class name 写在一行</li>
<li>属性(property),必须声明其可见性,到底是 public 还是 protected 还是 private,不能省略,也不能使用var,var是php老版本中的什么方式,等用于public</li>
<li>方法(method),必须 声明其可见性,到底是 public 还是 protected 还是 private,不能省略;如果有多个参数,第一个参数后紧接 “,”,再加一个空格：function_name ($par, $par2, $pa3), 如果参数有默认值, “=” 左右各有一个空格分开</li>
<li>当用到抽象(abstract)和终结(final)来做类声明时,它们必须放在可见性声明 (public 还是protected还是private) 的前面;当用到静态(static)来做类声明时,则必须放在可见性声明的后面</li>
</ol>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Lib</span>\<span class="title">Databaes</span>;</span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySQL</span> <span class="keyword">extends</span> <span class="title">ParentClass</span> <span class="keyword">implements</span> \<span class="title">PDO</span>, \<span class="title">DB</span>    // 写一行</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $foo = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> $name = <span class="string">'yangyi'</span>;</span><br><span class="line">    <span class="keyword">protected</span> $age = <span class="string">'17'</span>;</span><br><span class="line">    <span class="keyword">public</span> getInfo($name, $age, $gender = <span class="number">1</span>)            <span class="comment">// 参数之间有一个空格,默认参数的"="左右各有一个空格</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassName</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> $foo;              <span class="comment">// static放后面</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">zim</span><span class="params">()</span></span>;  <span class="comment">// abstract放前面</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span>  // <span class="title">final</span>放前面,<span class="title">static</span>放最后</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>控制结构</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> ($expr1) &#123;       <span class="comment">// if 与 ( 之间有一个空格, ) 与 &#123; 之间有一个空格</span></span><br><span class="line">     </span><br><span class="line">&#125; <span class="keyword">elseif</span> ($expr2) &#123; <span class="comment">// elesif 连着写,与 ( 之间有一个空格, ) 与 &#123; 之间有一个空格</span></span><br><span class="line">     </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;            <span class="comment">// else 左右各一个空格</span></span><br><span class="line">     </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">switch</span> ($expr) &#123;    <span class="comment">// switch 与 ( 之间有一个空格, ) 与 &#123; 之间有一个空格</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'First case, with a break'</span>; <span class="comment">// 对齐</span></span><br><span class="line">        <span class="keyword">break</span>;                           <span class="comment">// 换行写break,也对齐</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'return instead of break'</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Default case'</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">while</span> ($expr) &#123;     <span class="comment">// while 与 ( 之间有一个空格, ) 与 &#123; 之间有一个空格</span></span><br><span class="line">     </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">do</span> &#123;                <span class="comment">// do 与 &#123; 之间有一个空格</span></span><br><span class="line">     </span><br><span class="line">&#125; <span class="keyword">while</span> ($expr);    <span class="comment">// while 左右各有一个空格</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">10</span>; $i++) &#123;           <span class="comment">// for 与 ( 之间有一个空格, 二元操作符 "="、"&lt;" 左右各有一个空格, ) 与 &#123; 之间有一个空格</span></span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">foreach</span> ($iterable <span class="keyword">as</span> $key =&gt; $value) &#123; <span class="comment">// foreach 与 ( 之间有一个空格, "=&gt;" 左右各有一个空格, ) 与 &#123; 之间有一个空格</span></span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">try</span> &#123;                               <span class="comment">// try 右边有一个空格</span></span><br><span class="line"> </span><br><span class="line">&#125; <span class="keyword">catch</span> (FirstExceptionType $e) &#123;   <span class="comment">// catch 与 ( 之间有一个空格, ) 与 &#123; 之间有一个空格</span></span><br><span class="line"> </span><br><span class="line">&#125; <span class="keyword">catch</span> (OtherExceptionType $e) &#123;   <span class="comment">// catch 与 ( 之间有一个空格, ) 与 &#123; 之间有一个空格</span></span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>注释</p>
<blockquote><ol>
<li>行注释  // 后面需要加一个空格,如果 // 前面有非空字符,则 // 前面需要加一个空格</li>
<li>函数注释,参数名、属性名、标签的文本 上下要对齐,在第一个标签前加一个空行</li>
</ol>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is a sample function to illustrate additional PHP</span></span><br><span class="line"><span class="comment"> * formatter options.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>        $one   The first parameter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int    $two   The second parameter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $three The third parameter with a longer</span></span><br><span class="line"><span class="comment"> *                      comment to illustrate wrapping.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>  phpgo.cnblogs.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@license</span> GPL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">($one, $two = <span class="number">0</span>, $three = <span class="string">"String"</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>空格</p>
<blockquote><ol>
<li>赋值操作符(=,+= 等)、逻辑操作符(&amp;&amp;,||)、等号操作符(==,!=)、关系运算符(&lt;,&gt;,&lt;=,&gt;=)、按位操作符(&amp;,|,^)、连接符(.) 左右各有一个空格</li>
<li>if,else,elseif,while,do,switch,for,foreach,try,catch,finally 等 与 紧挨的左括号”(“之间有一个空格</li>
<li>函数、方法的各个参数之间,逗号(“,”)后面有一个空格</li>
</ol>
</blockquote></li>
<li><p>空行</p>
<blockquote><ol>
<li>所有左花括号 { 都不换行,并且 { 紧挨着的下方,一定不是空行</li>
<li>同级代码(缩进相同)的 注释(行注释/块注释)前面,必须有一个空行</li>
<li>各个方法/函数 之间有一个空行</li>
<li>namespace语句、use语句、clase语句 之间有一个空行</li>
<li>return语句,如果 return 语句之前只有一行PHP代码,return 语句之前不需要空行; 如果 return 语句之前有至少二行PHP代码,return 语句之前加一个空行</li>
<li>if,while,switch,for,foreach,try 等代码块之间 以及 与其他代码之间有一个空行</li>
</ol>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获得用户统计信息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $userId 用户ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUserCard</span><span class="params">($userId)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $userId = intval($userId);</span><br><span class="line">    <span class="keyword">return</span> UserMainLogic::instance()-&gt;getUserCard($userId);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据Id 获取用户信息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int    $userId 用户Id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $field  显示字段</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getByUserId</span><span class="params">($userId = <span class="number">0</span>, $field = <span class="string">'*'</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    $where = [<span class="string">'id'</span> =&gt; $userId];</span><br><span class="line">    $info = <span class="keyword">$this</span>-&gt;field($field)-&gt;where($where)-&gt;find();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($info[<span class="string">'image'</span>]) &amp;&amp; <span class="keyword">isset</span>($info[<span class="string">'sex'</span>])) &#123;</span><br><span class="line">        $info[<span class="string">'image'</span>] = ImageHelper::GetImageUrl($info[<span class="string">'image'</span>], $info[<span class="string">'sex'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> $info;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">$serv = <span class="keyword">new</span> swoole_server(<span class="string">"127.0.0.1"</span>, <span class="number">9502</span>);</span><br><span class="line">  </span><br><span class="line"><span class="comment">// sets server configuration, we set task_worker_num config greater than 0 to enable task workers support</span></span><br><span class="line">$serv-&gt;set([<span class="string">'task_worker_num'</span> =&gt; <span class="number">4</span>]);</span><br><span class="line">  </span><br><span class="line"><span class="comment">// attach handler for receive event, which have explained above.</span></span><br><span class="line">$serv-&gt;on(<span class="string">'receive'</span>, <span class="function"><span class="keyword">function</span><span class="params">($serv, $fd, $from_id, $data)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// we dispath a task to task workers by invoke the task() method of $serv</span></span><br><span class="line">    <span class="comment">// this method returns a task id as the identity of ths task</span></span><br><span class="line">    $task_id = $serv-&gt;task($data);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Dispath AsyncTask: id=$task_id\n"</span>;</span><br><span class="line">&#125;);</span><br><span class="line">  </span><br><span class="line"><span class="comment">// attach handler for task event, the handler will be executed in task workers.</span></span><br><span class="line">$serv-&gt;on(<span class="string">'task'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($serv, $task_id, $from_id, $data)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// handle the task, do what you want with $data</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"New AsyncTask[id=$task_id]"</span>.PHP_EOL;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// after the task task is handled, we return the results to caller worker.</span></span><br><span class="line">    $serv-&gt;finish(<span class="string">"$data -&gt; OK"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">  </span><br><span class="line"><span class="comment">// attach handler for finish event, the handler will be executed in server workers, the same worker dispatched this task before.</span></span><br><span class="line">$serv-&gt;on(<span class="string">'finish'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($serv, $task_id, $data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"AsyncTask[$task_id] Finish: $data"</span>.PHP_EOL;</span><br><span class="line">&#125;);</span><br><span class="line">  </span><br><span class="line">$serv-&gt;start();</span><br></pre></td></tr></table></figure>
</li>
<li><p>数组的书写格式</p>
<ul>
<li><p>只有一个键值对时,就写成一行：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$where = [<span class="string">'id'</span> =&gt; <span class="number">789</span>];</span><br></pre></td></tr></table></figure>
</li>
<li><p>有多个(二个或二个以上)键值对时,就换行：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$where = [</span><br><span class="line">    <span class="string">'id'</span> =&gt; <span class="number">789</span>,</span><br><span class="line">    <span class="string">'user_name'</span> =&gt; <span class="string">'phpgo'</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>IP地理位置查询类(纯真IP地址库)</title>
    <url>/PHP/ip-location-cz.html</url>
    <content><![CDATA[<blockquote><p>由于使用UTF8编码,如果使用纯真IP地址库的话,需要对返回结果进行编码转换<br>纯真IP地址库 <a href="http://www.cz88.net/" target="_blank" rel="noopener">http://www.cz88.net/</a> 安装完成后，到安装目录把 qqwry.dat 拷贝出来</p>
</blockquote>
<a id="more"></a>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * IP 地理位置查询类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IpLocation</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_provinces = [<span class="string">'黑龙江省'</span>, <span class="string">'辽宁省'</span>, <span class="string">'吉林省'</span>, <span class="string">'河北省'</span>, <span class="string">'河南省'</span>, <span class="string">'湖北省'</span>, <span class="string">'湖南省'</span>, <span class="string">'山东省'</span>,</span><br><span class="line">        <span class="string">'山西省'</span>, <span class="string">'陕西省'</span>, <span class="string">'安徽省'</span>, <span class="string">'浙江省'</span>, <span class="string">'江苏省'</span>, <span class="string">'福建省'</span>, <span class="string">'广东省'</span>, <span class="string">'海南省'</span>, <span class="string">'四川省'</span>, <span class="string">'云南省'</span>, <span class="string">'贵州省'</span>,</span><br><span class="line">        <span class="string">'青海省'</span>, <span class="string">'甘肃省'</span>, <span class="string">'江西省'</span>, <span class="string">'台湾省'</span>, <span class="string">'内蒙古'</span>, <span class="string">'宁夏'</span>, <span class="string">'新疆'</span>, <span class="string">'西藏'</span>, <span class="string">'广西'</span>, <span class="string">'北京市'</span>, <span class="string">'上海市'</span>,</span><br><span class="line">        <span class="string">'天津市'</span>, <span class="string">'重庆市'</span>, <span class="string">'香港'</span>, <span class="string">'澳门'</span>];</span><br><span class="line">    <span class="keyword">private</span> $_filterCity = [<span class="string">'北京市'</span>, <span class="string">'上海市'</span>, <span class="string">'天津市'</span>, <span class="string">'重庆市'</span>];</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * qqwry.dat文件指针</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> resource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $fp;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第一条IP记录的偏移地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $firstip;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最后一条IP记录的偏移地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $lastip;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * IP记录的总条数（不包含版本信息记录）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $totalip;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造函数,打开 qqwry.dat 文件并初始化类中的信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>   string  $filename</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  IpLocation</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename = <span class="string">'qqwry.dat'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;fp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">$this</span>-&gt;fp = fopen(dirname(<span class="keyword">__FILE__</span>) . <span class="string">'/'</span> . $filename, <span class="string">'rb'</span>)) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;firstip = <span class="keyword">$this</span>-&gt;getlong();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;lastip = <span class="keyword">$this</span>-&gt;getlong();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;totalip = (<span class="keyword">$this</span>-&gt;lastip - <span class="keyword">$this</span>-&gt;firstip) / <span class="number">7</span>;</span><br><span class="line">             </span><br><span class="line">            <span class="comment">// 注册析构函数,使其在程序执行结束时执行</span></span><br><span class="line">            register_shutdown_function(<span class="keyword">array</span>(&amp;<span class="keyword">$this</span>, <span class="string">'__destruct'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回读取的长整型数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getlong</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 将读取的little-endian编码的4个字节转化为长整型数</span></span><br><span class="line">        $result = unpack(<span class="string">'Vlong'</span>, fread(<span class="keyword">$this</span>-&gt;fp, <span class="number">4</span>));</span><br><span class="line">        <span class="keyword">return</span> $result[<span class="string">'long'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回读取的3个字节的长整型数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getlong3</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 将读取的little-endian编码的3个字节转化为长整型数</span></span><br><span class="line">        $result = unpack(<span class="string">'Vlong'</span>, fread(<span class="keyword">$this</span>-&gt;fp, <span class="number">3</span>) . chr(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">return</span> $result[<span class="string">'long'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回压缩后可进行比较的IP地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $ip</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">packip</span><span class="params">($ip)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 将IP地址转化为长整型数,如果在PHP5中,IP地址错误,则返回False</span></span><br><span class="line">        <span class="comment">// 这时intval将Flase转化为整数-1,之后压缩成big-endian编码的字符串</span></span><br><span class="line">        <span class="keyword">return</span> pack(<span class="string">'N'</span>, intval(ip2long($ip)));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回读取的字符串</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getstring</span><span class="params">($data = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $char = fread(<span class="keyword">$this</span>-&gt;fp, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">while</span> (ord($char) &gt; <span class="number">0</span>) &#123;            <span class="comment">// 字符串按照C格式保存,以\0结束</span></span><br><span class="line">            $data .= $char;                 <span class="comment">// 将读取的字符连接到给定字符串之后</span></span><br><span class="line">            $char = fread(<span class="keyword">$this</span>-&gt;fp, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回地区信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getarea</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $byte = fread(<span class="keyword">$this</span>-&gt;fp, <span class="number">1</span>);                <span class="comment">// 标志字节</span></span><br><span class="line">        <span class="keyword">switch</span> (ord($byte)) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:                                 <span class="comment">// 没有区域信息</span></span><br><span class="line">                $area = <span class="string">''</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:                                 <span class="comment">// 标志字节为1或2，表示区域信息被重定向</span></span><br><span class="line">                fseek(<span class="keyword">$this</span>-&gt;fp, <span class="keyword">$this</span>-&gt;getlong3());</span><br><span class="line">                $area = <span class="keyword">$this</span>-&gt;getstring();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:                                <span class="comment">// 否则,表示区域信息没有被重定向</span></span><br><span class="line">                $area = <span class="keyword">$this</span>-&gt;getstring($byte);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $area;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据所给 IP 地址或域名返回所在地区信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $ip</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getlocation</span><span class="params">($ip, $convert_utf8 = true)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;fp) <span class="keyword">return</span> <span class="keyword">null</span>;                        <span class="comment">// 如果数据文件没有被正确打开，则直接返回空</span></span><br><span class="line">        $location[<span class="string">'ip'</span>] = gethostbyname($ip);               <span class="comment">// 将输入的域名转化为IP地址</span></span><br><span class="line">        $ip = <span class="keyword">$this</span>-&gt;packip($location[<span class="string">'ip'</span>]);               <span class="comment">// 将输入的IP地址转化为可比较的IP地址,不合法的IP地址会被转化为255.255.255.255</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 对分搜索</span></span><br><span class="line">        $l = <span class="number">0</span>;                                             <span class="comment">// 搜索的下边界</span></span><br><span class="line">        $u = <span class="keyword">$this</span>-&gt;totalip;                                <span class="comment">// 搜索的上边界</span></span><br><span class="line">        $findip = <span class="keyword">$this</span>-&gt;lastip;                            <span class="comment">// 如果没有找到就返回最后一条IP记录(qqwry.Dat的版本信息)</span></span><br><span class="line">        <span class="keyword">while</span> ($l &lt;= $u) &#123;                                  <span class="comment">// 当上边界小于下边界时,查找失败</span></span><br><span class="line">            $i = floor(($l + $u) / <span class="number">2</span>);                      <span class="comment">// 计算近似中间记录</span></span><br><span class="line">            fseek(<span class="keyword">$this</span>-&gt;fp, <span class="keyword">$this</span>-&gt;firstip + $i * <span class="number">7</span>);</span><br><span class="line">            $beginip = strrev(fread(<span class="keyword">$this</span>-&gt;fp, <span class="number">4</span>));         <span class="comment">// 获取中间记录的开始IP地址,strrev函数在这里的作用是将little-endian的压缩IP地址转化为big-endian的格式,以便用于比较,后面相同</span></span><br><span class="line">            <span class="keyword">if</span> ($ip &lt; $beginip) &#123;                           <span class="comment">// 用户的IP小于中间记录的开始IP地址时</span></span><br><span class="line">                $u = $i - <span class="number">1</span>;                                <span class="comment">// 将搜索的上边界修改为中间记录减一</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                fseek(<span class="keyword">$this</span>-&gt;fp, <span class="keyword">$this</span>-&gt;getlong3());</span><br><span class="line">                $endip = strrev(fread(<span class="keyword">$this</span>-&gt;fp, <span class="number">4</span>));       <span class="comment">// 获取中间记录的结束IP地址</span></span><br><span class="line">                <span class="keyword">if</span> ($ip &gt; $endip) &#123;                         <span class="comment">// 用户的IP大于中间记录的结束IP地址时</span></span><br><span class="line">                    $l = $i + <span class="number">1</span>;                            <span class="comment">// 将搜索的下边界修改为中间记录加一</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;                                    <span class="comment">// 用户的IP在中间记录的IP范围内时</span></span><br><span class="line">                    $findip = <span class="keyword">$this</span>-&gt;firstip + $i * <span class="number">7</span>;</span><br><span class="line">                    <span class="keyword">break</span>;                                  <span class="comment">// 则表示找到结果,退出循环</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 获取查找到的IP地理位置信息</span></span><br><span class="line">        fseek(<span class="keyword">$this</span>-&gt;fp, $findip);</span><br><span class="line">        $location[<span class="string">'beginip'</span>] = long2ip(<span class="keyword">$this</span>-&gt;getlong());   <span class="comment">// 用户IP所在范围的开始地址</span></span><br><span class="line">        $offset = <span class="keyword">$this</span>-&gt;getlong3();</span><br><span class="line">        fseek(<span class="keyword">$this</span>-&gt;fp, $offset);</span><br><span class="line">        $location[<span class="string">'endip'</span>] = long2ip(<span class="keyword">$this</span>-&gt;getlong());     <span class="comment">// 用户IP所在范围的结束地址</span></span><br><span class="line">        $byte = fread(<span class="keyword">$this</span>-&gt;fp, <span class="number">1</span>);                        <span class="comment">// 标志字节</span></span><br><span class="line">        <span class="keyword">switch</span> (ord($byte)) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:                                         <span class="comment">// 标志字节为1,表示国家和区域信息都被同时重定向</span></span><br><span class="line">                $countryOffset = <span class="keyword">$this</span>-&gt;getlong3();         <span class="comment">// 重定向地址</span></span><br><span class="line">                fseek(<span class="keyword">$this</span>-&gt;fp, $countryOffset);</span><br><span class="line">                $byte = fread(<span class="keyword">$this</span>-&gt;fp, <span class="number">1</span>);                <span class="comment">// 标志字节</span></span><br><span class="line">                <span class="keyword">switch</span> (ord($byte)) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">2</span>:                                 <span class="comment">// 标志字节为2,表示国家信息又被重定向</span></span><br><span class="line">                        fseek(<span class="keyword">$this</span>-&gt;fp, <span class="keyword">$this</span>-&gt;getlong3());</span><br><span class="line">                        $location[<span class="string">'country'</span>] = <span class="keyword">$this</span>-&gt;getstring();</span><br><span class="line">                        fseek(<span class="keyword">$this</span>-&gt;fp, $countryOffset + <span class="number">4</span>);</span><br><span class="line">                        $location[<span class="string">'area'</span>] = <span class="keyword">$this</span>-&gt;getarea();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:                                <span class="comment">// 否则,表示国家信息没有被重定向</span></span><br><span class="line">                        $location[<span class="string">'country'</span>] = <span class="keyword">$this</span>-&gt;getstring($byte);</span><br><span class="line">                        $location[<span class="string">'area'</span>] = <span class="keyword">$this</span>-&gt;getarea();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:                                         <span class="comment">// 标志字节为2,表示国家信息被重定向</span></span><br><span class="line">                fseek(<span class="keyword">$this</span>-&gt;fp, <span class="keyword">$this</span>-&gt;getlong3());</span><br><span class="line">                $location[<span class="string">'country'</span>] = <span class="keyword">$this</span>-&gt;getstring();</span><br><span class="line">                fseek(<span class="keyword">$this</span>-&gt;fp, $offset + <span class="number">8</span>);</span><br><span class="line">                $location[<span class="string">'area'</span>] = <span class="keyword">$this</span>-&gt;getarea();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:                                        <span class="comment">// 否则,表示国家信息没有被重定向</span></span><br><span class="line">                $location[<span class="string">'country'</span>] = <span class="keyword">$this</span>-&gt;getstring($byte);</span><br><span class="line">                $location[<span class="string">'area'</span>] = <span class="keyword">$this</span>-&gt;getarea();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (trim($location[<span class="string">'country'</span>]) == <span class="string">'CZ88.NET'</span>) &#123;     <span class="comment">// CZ88.NET表示没有有效信息</span></span><br><span class="line">            $location[<span class="string">'country'</span>] = <span class="string">'未知'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (trim($location[<span class="string">'area'</span>]) == <span class="string">'CZ88.NET'</span>) &#123;</span><br><span class="line">            $location[<span class="string">'area'</span>] = <span class="string">''</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($convert_utf8) &#123;</span><br><span class="line">            $location[<span class="string">'country'</span>] = iconv(<span class="string">'GB2312'</span>, <span class="string">'UTF-8//IGNORE'</span>, $location[<span class="string">'country'</span>]);</span><br><span class="line">            $location[<span class="string">'area'</span>] = iconv(<span class="string">'GB2312'</span>, <span class="string">'UTF-8//IGNORE'</span>, $location[<span class="string">'area'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;_provinces <span class="keyword">as</span> $province) &#123;</span><br><span class="line">            <span class="keyword">if</span> (strpos($location[<span class="string">'country'</span>], $province) === <span class="number">0</span>) &#123;</span><br><span class="line">               $location[<span class="string">'province'</span>] = $province;</span><br><span class="line">               <span class="keyword">if</span> (in_array($province, <span class="keyword">$this</span>-&gt;_filterCity)) &#123;</span><br><span class="line">                   $location[<span class="string">'city'</span>] = $province;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   $location[<span class="string">'city'</span>] = str_replace($province, <span class="string">''</span>, $location[<span class="string">'country'</span>]);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">empty</span>($location[<span class="string">'city'</span>]) &amp;&amp; $location[<span class="string">'city'</span>] = $province;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// country 错误值：[未知,局域网,IANA]</span></span><br><span class="line">        <span class="keyword">return</span> $location;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 析构函数,用于在页面执行结束后自动关闭打开的文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;fp) &#123;</span><br><span class="line">            fclose(<span class="keyword">$this</span>-&gt;fp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;fp = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ip_location_obj = <span class="keyword">new</span> IpLocation();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;pre&gt;'</span>;</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'127.0.0.1'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'10.10.0.0'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'123.164.3.9'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'175.160.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'122.136.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'106.112.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'123.8.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'58.48.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'222.240.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'182.32.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'118.72.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'202.200.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'60.168.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'115.224.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'117.80.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'120.32.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'113.96.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'223.198.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'182.128.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'182.240.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'114.138.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'223.220.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'42.88.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'115.148.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'61.57.155.236'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'123.178.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'124.224.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'49.112.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'27.98.224.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'222.216.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'58.31.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'124.76.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'221.196.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'125.80.104.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'202.97.96.123'</span>);</span><br><span class="line">print_r($address);</span><br><span class="line">$address = $ip_location_obj-&gt;getlocation(<span class="string">'202.175.34.123'</span>);</span><br><span class="line">print_r($address);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>ip</tag>
        <tag>纯真</tag>
      </tags>
  </entry>
  <entry>
    <title>SESSION 阻塞</title>
    <url>/PHP/session-block.html</url>
    <content><![CDATA[<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>使用session过程中,在开启session后,同一浏览器执行同一程序,不同页面会被锁,不同浏览器不会出现这种情况</p>
<h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><p>由于PHP的Session信息是写入文件的,1个客户端占有1个session文件,因此,当 session_start 被调用的时候,该文件是被锁住的,而且是以读写模式锁住的,所以第2次调用 session_start 的时候就被阻塞了</p>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>使用 session_write_close 函数(Write session data and end session),也就是写session的数据,同时关闭这个session,因此在用完session之后,调用这个函数关闭 session 文件即可解除锁定</p>
<h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><p>创建 test1.php 和 test2.php 文件<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// test1.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">date_default_timezone_set(<span class="string">'PRC'</span>);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[<span class="string">'test1'</span>] = date(<span class="string">'H:i:s'</span>);</span><br><span class="line"><span class="comment">//session_write_close(); </span></span><br><span class="line">sleep(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">echo</span> $_SESSION[<span class="string">'test1'</span>];</span><br></pre></td></tr></table></figure></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// test2.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">date_default_timezone_set(<span class="string">'PRC'</span>);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[<span class="string">'test2'</span>] = date(<span class="string">'H:i:s'</span>);</span><br><span class="line"><span class="keyword">echo</span> $_SESSION[<span class="string">'test2'</span>];</span><br></pre></td></tr></table></figure>
<p>先访问 test1.php 再访问 test2.php, test2.php 必须等 test1.php 执行完毕后才会执行,这时将 test1.php 的 session_write_close() 取消注释,再测试一遍,这时2个脚本就可以同时执行了</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>session</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows/Linux 下 Composer 的安装使用</title>
    <url>/Composer/composer-install.html</url>
    <content><![CDATA[<h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><ol>
<li><p><a href="http://docs.phpcomposer.com/" target="_blank" rel="noopener">http://docs.phpcomposer.com/</a> 上下载 windows 安装包, 安装后的 composer.phar 可能在以下几个路径：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Win8 ： C:\ProgramData\ComposerSetup\bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>找到 Composter 的安装路径, 修改 composer.bat 内容为</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">@php <span class="string">"%~dp0composer.phar"</span> %*</span><br></pre></td></tr></table></figure>
</li>
<li><p>复制到 composer、composer.bat、composer.phar 到 php 安装目录下</p>
</li>
<li>运行  composer.bat 即可</li>
</ol>
<h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><ol>
<li><p>下载并安装 composer</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -sS https://getcomposer.org/installer | php</span><br><span class="line">mv composer.phar /usr/<span class="built_in">local</span>/bin/composer</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建用户, 并设置密码, 切换至test用户就可以使用composer</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">useradd <span class="built_in">test</span> <span class="comment">#添加test用户</span></span><br><span class="line">passwd <span class="comment">#设置密码</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h4><ol>
<li>Undefined index: process <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /usr/<span class="built_in">local</span>/php/etc/php.ini</span><br><span class="line"><span class="comment"># 从 disable_functions 中移除 proc_open、proc_get_status</span></span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>Composer</category>
      </categories>
      <tags>
        <tag>composer</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis集群</title>
    <url>/Redis/redis-cluster.html</url>
    <content><![CDATA[<h4 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h4><div class="note danger"><p>redis-4.0.0.tar.gz</p></div>
<ol>
<li><p>下载并解压redis</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /alidata/package</span><br><span class="line">wget http://download.redis.io/releases/redis-4.0.0.tar.gz</span><br><span class="line">tar -zxvf redis-4.0.0.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> redis-4.0.0</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建 redis 目录,便于管理</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /alidata</span><br><span class="line">mkdir -p redis/bin</span><br><span class="line">mkdir -p redis/etc</span><br><span class="line">cp package/redis-4.0.0/redis.conf redis/etc</span><br><span class="line"><span class="built_in">cd</span> package/redis-4.0.0/src</span><br><span class="line">cp mkreleasehdr.sh redis-benchmark redis-check-aof redis-check-rdb redis-cli redis-sentinel redis-server redis-trib.rb /alidata/redis/bin/</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建 redis_cluster 目录, 并在目录下新建 7001,7002,7003,7004,7005,7006 子目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /alidata</span><br><span class="line">mkdir redis_cluster</span><br><span class="line"><span class="built_in">cd</span> redis_cluster</span><br><span class="line">mkdir 7000 7001 7002 7003 7004 7005 7006</span><br></pre></td></tr></table></figure>
</li>
</ol>
<a id="more"></a>
<ol>
<li><p>将 redis.conf 拷贝至 7000-7006 这几个目录里</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cp /alidata/redis/etc/redis.conf 7000/</span><br><span class="line">cp /alidata/redis/etc/redis.conf 7001/</span><br><span class="line">cp /alidata/redis/etc/redis.conf 7002/</span><br><span class="line">cp /alidata/redis/etc/redis.conf 7003/</span><br><span class="line">cp /alidata/redis/etc/redis.conf 7004/</span><br><span class="line">cp /alidata/redis/etc/redis.conf 7005/</span><br><span class="line">cp /alidata/redis/etc/redis.conf 7006/</span><br></pre></td></tr></table></figure>
</li>
<li><p>依次修改 7000-7006 目录下的redis.conf</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">port 7000 <span class="comment">#端口7000-7006</span></span><br><span class="line"><span class="built_in">bind</span> 127.0.0.1 </span><br><span class="line">daemonize yes <span class="comment">#后台运行</span></span><br><span class="line">pidfile /var/run/redis_7000.pid <span class="comment">#pidfile文件对应7000-7006</span></span><br><span class="line">cluster-enabled yes <span class="comment">#开启集群</span></span><br><span class="line">cluster-config-file nodes-7000.conf <span class="comment">#集群的配置,对应7000-7006</span></span><br><span class="line">cluster-node-timeout 15000 <span class="comment">#请求超时,默认15秒</span></span><br><span class="line">appendonly  yes <span class="comment">#aof日志开启</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动节点</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /alidata/redis/bin</span><br><span class="line">redis-server /alidata/redis_cluster/7000/redis.conf</span><br><span class="line">redis-server /alidata/redis_cluster/7001/redis.conf</span><br><span class="line">redis-server /alidata/redis_cluster/7002/redis.conf</span><br><span class="line">redis-server /alidata/redis_cluster/7003/redis.conf</span><br><span class="line">redis-server /alidata/redis_cluster/7004/redis.conf</span><br><span class="line">redis-server /alidata/redis_cluster/7005/redis.conf</span><br><span class="line">redis-server /alidata/redis_cluster/7006/redis.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>检测redis启动情况</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ps -ef | grep redis</span><br></pre></td></tr></table></figure>
<p><img src="/uploads/redis/redis-cluster/1dee6097d7c454e8ff8e5215189d3d0d.png" style="display:inline-block"></p>
</li>
<li><p>创建集群</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">redis-trib.rb create --replicas 1 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 127.0.0.1:7006</span><br></pre></td></tr></table></figure>
<p><img src="/uploads/redis/redis-cluster/d38d614386a0b0333a0b22ef2819de15.png" style="display:inline-block"><br>若提示：<font color="red">/usr/bin/env: ruby: No such file or directory</font>, 则安装 ruby 后重新运行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum -y install ruby ruby-devel rubygems rpm-build</span><br><span class="line">gem install redis</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入 yes<br><img src="/uploads/redis/redis-cluster/9088b48ed1f8ae01800d74c5c01e342b.png" style="display:inline-block"></p>
</li>
<li>运行命令<br><img src="/uploads/redis/redis-cluster/3d85202a6397186a29f9acd1281a969a.png" style="display:inline-block"></li>
</ol>
<h4 id="多台服务器集群步骤"><a href="#多台服务器集群步骤" class="headerlink" title="多台服务器集群步骤"></a>多台服务器集群步骤</h4><blockquote><p>例：A(192.168.160.130)，B(192.168.160.131) 两台服务器</p>
</blockquote>
<ol>
<li>A服务器创建 7000、7001、7002  三个目录,  B服务器创建 7003、7004、7005 三个目录</li>
<li>配置 redis.conf, 7000、7001、7002 三个目录下的redis.conf的 bind 127.0.0.1 修改成  bind 192.168.160.130, 而7003、7004、7005 三个目录下的 redis.conf 的 bind 127.0.0.1 修改成 bind 192.168.160.131</li>
<li>启动A、B服务器的节点</li>
<li><p>创建集群</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">redis-trib.rb create --replicas 1 192.168.160.130:7000 192.168.160.130:7001 192.168.160.130:7002 192.168.160.131:7003 192.168.160.131:7004 192.168.160.131:7005 127.0.0.1:7006</span><br></pre></td></tr></table></figure>
</li>
<li><p>在A服务器运行命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">redis-cli -c -h 192.168.160.130 -p 7000 </span><br><span class="line"><span class="built_in">set</span> foo bar</span><br></pre></td></tr></table></figure>
</li>
<li><p>在B服务器运行命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">redis-cli -c -h 192.168.160.131 -p 7003</span><br><span class="line">get foo</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows64位 WAMP环境搭建</title>
    <url>/PHP/win64-build-wamp.html</url>
    <content><![CDATA[<h4 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h4><div class="note danger"><p>httpd-2.4.23-x64-vc14.zip （vc14.x64.exe）<br>mysql-5.7.14-winx64.zip<br>php-5.6.24-Win32-VC11-x64.zip （vc11.x64.exe）</p></div>
<h4 id="APACHE"><a href="#APACHE" class="headerlink" title="APACHE"></a>APACHE</h4><ol>
<li>解压httpd-2.4.23-x64-vc14.zip</li>
<li>将 httpd-2.4.23-x64-vc14 目录下的 Apache24 重命名为 apache, 并拷贝至 D 盘根目录下</li>
<li>安装 vc14.x64.exe</li>
<li><p>打开 apache/conf/httpd.conf 文件, 修改第38行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#Define SRVROOT "/Apache24"</span></span><br><span class="line">Define SRVROOT <span class="string">"/apache"</span>    <span class="comment">#apache的安装目录</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>注册 apache 服务, cmd命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:</span><br><span class="line"><span class="built_in">cd</span> apache/bin</span><br><span class="line">httpd.exe -k install -n <span class="string">"APACHE"</span> <span class="comment">#卸载服务命令为 httpd.exe -k uninstall -n "APACHE"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>进入命令行窗口, 运行 net start APACHE , 启动 apache 服务</p>
</li>
<li>浏览器访问 localhost, 提示 It Works 说明安装成功</li>
</ol>
<a id="more"></a>
<h4 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h4><ol>
<li>解压 php-5.6.24-Win32-VC11-x64.zip </li>
<li>将 php-5.6.24-Win32-VC11-x64 重命名为 php 并拷贝至 D 盘根目录下</li>
<li>安装 vc11.x64.exe</li>
<li>将 php 目录下的 php.ini-development 重命名为 php.ini </li>
<li><p>打开 D:/apache/conf/httpd.conf 文件, 在文件尾部添加如下代码：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">LoadModule php5_module <span class="string">"D:/php/php5apache2_4.dll"</span></span><br><span class="line">AddType application/x-httpd-php .php</span><br><span class="line">PHPIniDir <span class="string">"D:/php"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>打开 D:/apache/conf/httpd.conf 文件, 搜索 DirectoryIndex, 修改为：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DirectoryIndex index.php index.html index.htm</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 D:/apache/htdocs 目录下新建 index.php 文件, 内容为：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启 apache 服务, 浏览器访问  localhost, 若显示 PHP 信息, 说明安装成功</p>
</li>
</ol>
<h4 id="MYSQL"><a href="#MYSQL" class="headerlink" title="MYSQL"></a>MYSQL</h4><ol>
<li>解压 mysql-5.7.14-winx64.zip</li>
<li>将 mysql-5.7.14-winx64/mysql-5.7.14-winx64 重命名为 mysql 并拷贝至 D 盘根目录下</li>
<li>将 mysql 目录下的 my-default.ini 重命名为 my.ini</li>
<li><p>去掉 basedir, datadir, port 前面的 # 号, 修改如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">basedir = D:\mysql</span><br><span class="line">datadir = D:\mysql\data</span><br><span class="line">port = 3306</span><br></pre></td></tr></table></figure>
</li>
<li><p>注册 mysql 服务, cmd命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:</span><br><span class="line"><span class="built_in">cd</span> mysql/bin</span><br><span class="line">mysqld --install MYSQL  <span class="comment">#卸载服务  mysqld --remove MYSQL</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化数据库,初始化后可以看到 root@localhost 后台有一串字符, 这是 mysql 初始密码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:</span><br><span class="line"><span class="built_in">cd</span> mysql/bin</span><br><span class="line">mysqld --initialize --console</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动 mysql, cmd命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">net start MYSQL</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改密码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:</span><br><span class="line"><span class="built_in">cd</span> mysql/bin</span><br><span class="line">mysql -u root -p</span><br><span class="line"><span class="comment">#登录后....</span></span><br><span class="line"><span class="built_in">set</span> password = password(<span class="string">'root'</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置环境变量, 计算机-&gt;右键属性-&gt;高级系统设置-&gt;高级-&gt;环境变量-&gt;系统变量-&gt;Path-&gt;编辑-&gt;在变量值后面追加</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">;D:\mysql\bin  <span class="comment">#不同的路径使用 ; 分开</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>重新打开命令行窗口, 输入 mysql -u root -p 就可以直接进行登录了</p>
</li>
</ol>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>php报错：<font color="red">PHP Warning:  PHP Startup: Unable to load dynamic library ‘D:\web\php\ext\php_curl.dll’</font>, 需要在系统变量里添加  php\ext 的路径：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\web\php;D:\web\php\ext  <span class="comment">#添加此系统变量</span></span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>wamp</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo + Github + 码云 搭建博客</title>
    <url>/Hexo/hexo-github-gitee-build-blog.html</url>
    <content><![CDATA[<ol>
<li>下载并安装 Visual Studio Code, <a href="https://www.visualstudio.com/" target="_blank" rel="noopener">官方下载</a></li>
<li><p>下载并安装 Nodejs, <a href="http://nodejs.cn/download/" target="_blank" rel="noopener">官方下载</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node -v</span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>
<p>npm 镜像源修改为 淘宝NPM镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载并安装 Git, <a href="https://git-scm.com/download/win" target="_blank" rel="noopener">官方下载</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#配置名字和邮箱</span></span><br><span class="line">git config --global user.name <span class="string">"test"</span></span><br><span class="line">git config --global user.email <span class="string">"test@.com"</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
</li>
<li><p>安装 Hexo, <a href="https://hexo.io/zh-cn/docs/" target="_blank" rel="noopener">官方文档</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cnpm install -g hexo-cli</span><br><span class="line">hexo -v</span><br></pre></td></tr></table></figure>
<p>初始化博客目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> D</span><br><span class="line">hexo init blog</span><br><span class="line"><span class="built_in">cd</span> blog</span><br><span class="line">cnpm install</span><br></pre></td></tr></table></figure>
<p>启动服务器,本地预览</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo server</span><br></pre></td></tr></table></figure>
</li>
<li><p>Hexo 常用站点配置_config.yml</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#网站标题</span></span><br><span class="line">title: <span class="built_in">test</span></span><br><span class="line"><span class="comment">#作者昵称</span></span><br><span class="line">author: <span class="built_in">test</span></span><br><span class="line"><span class="comment">#站点描述[签名]</span></span><br><span class="line">description: 站点描述</span><br><span class="line"><span class="comment">#网站地址</span></span><br><span class="line">url: http://www.test.com</span><br><span class="line"><span class="comment">#文章的链接格式</span></span><br><span class="line">permalink: :title.html</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加标签</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#生成文件路径 source/tags/index.md</span></span><br><span class="line">hexo new page tags</span><br><span class="line"><span class="comment">#编辑index.md,添加type</span></span><br><span class="line"><span class="built_in">type</span>: <span class="string">"tags"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加分类</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#生成文件路径 source/categories/index.md</span></span><br><span class="line">hexo new page categories</span><br><span class="line"><span class="comment">#编辑index.md,添加type</span></span><br><span class="line"><span class="built_in">type</span>: <span class="string">"categories"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>文章添加标签与分类</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">categories:</span><br><span class="line">  - hexo</span><br><span class="line">tags:</span><br><span class="line">  - hexo</span><br><span class="line">  - github</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置阅读全文</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#在文章中使用 &lt;!-- more --&gt; 手动截断 </span></span><br><span class="line">&lt;!-- more --&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Hexo 主题,这里选择 <strong>Next</strong>, <a href="https://github.com/theme-next/hexo-theme-next" target="_blank" rel="noopener">Github地址</a> <a href="http://theme-next.iissnan.com/" target="_blank" rel="noopener">文档</a><br>安装 Next 主题</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/iissnan/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure>
<p>启用主题并设置语言,站点配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">theme: next</span><br><span class="line">language: zh-CN</span><br></pre></td></tr></table></figure>
<p>主题常用配置,themes/next/_config.yml</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#主题外观设定</span></span><br><span class="line">scheme: Gemini</span><br><span class="line"><span class="comment">#设置菜单</span></span><br><span class="line">menu:</span><br><span class="line">  home: / || home</span><br><span class="line">  tags: /tags/ || tags</span><br><span class="line">  categories: /categories/ || th</span><br><span class="line">  archives: /archives/ || archive</span><br><span class="line"><span class="comment">#设置代码高亮主题</span></span><br><span class="line">highlight_theme: night eighties</span><br><span class="line"><span class="comment">#添加友情链接</span></span><br><span class="line">links:</span><br><span class="line">  <span class="built_in">test</span>: http://www.test.com</span><br><span class="line"><span class="comment">#文章自动添加版权声明</span></span><br><span class="line">post_copyright:</span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span></span><br><span class="line"><span class="comment">#返回顶部按钮显示百分比</span></span><br><span class="line">sidebar:</span><br><span class="line">  scrollpercent: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>设置RSS,安装<a href="https://github.com/hexojs/hexo-generator-feed" target="_blank" rel="noopener">hexo-generator-feed</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cnpm install hexo-generator-feed --save</span><br></pre></td></tr></table></figure>
<p>安装hexo-generator-searchdb,添加百度/谷歌/本地 自定义站点内容搜索</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cnpm install hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure>
<p>启用搜索,主题配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">local_search:</span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>配置搜索,站点配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">search:</span><br><span class="line">  path: search.xml</span><br><span class="line">  field: post</span><br><span class="line">  format: html</span><br><span class="line">  <span class="built_in">limit</span>: 7777</span><br></pre></td></tr></table></figure>
<p>设置favicon.ico,将favicon.ico上传至站点根目录/source 目录下,主题配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">favicon:</span><br><span class="line">  small: favicon.ico</span><br><span class="line">  medium: favicon.ico</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署Hexo至Github<br>安装 hexo-deployer-git</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cnpm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>
<p>站点配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  <span class="built_in">type</span>: git</span><br><span class="line">  repo: https://github.com/github账号/github账号.github.io.git</span><br></pre></td></tr></table></figure>
<p>生成并部署</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo d -g</span><br></pre></td></tr></table></figure>
</li>
<li><p>Github 自定义域名,由于Hexo每次部署到Github都会覆盖Github的域名配置,所以直接在Hexo配置,然后再部署,在根目录下的source目录下新建CNAME文件,无后缀名</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#自定义域名</span></span><br><span class="line">xxx.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>解析域名到 github.io,记录类型 = CNAME, 记录值 = github账号.github.io</p>
</li>
<li>码云新建一个项目, 路径 <a href="https://gitee.com/test/test.git" target="_blank" rel="noopener">https://gitee.com/test/test.git</a></li>
<li><p>Hexo 目录说明</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.deploy_git Hexo默认的.git配置文件夹</span><br><span class="line">public 根据<span class="built_in">source</span>文件夹内容自动生成</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入 Hexo根目录,执行以下命令,先删除 themes/next 目录下的 .gitignore 文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#初始化仓库</span></span><br><span class="line">git init</span><br><span class="line"><span class="comment">#添加远程主机</span></span><br><span class="line">git remote add origin https://gitee.com/<span class="built_in">test</span>/test.git</span><br><span class="line"><span class="comment">#添加目录下所有文件,不包含 .gitignore 声明的文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment">#添加更新说明</span></span><br><span class="line">git commit -m <span class="string">"hexo first commit"</span></span><br><span class="line"><span class="comment">#推送更新到云端服务器</span></span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 test 目录,将 Git 的内容同步到本地并安装Hexo</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir <span class="built_in">test</span></span><br><span class="line"><span class="built_in">cd</span> <span class="built_in">test</span></span><br><span class="line">git init</span><br><span class="line">git remote add origin https://gitee.com/<span class="built_in">test</span>/test.git</span><br><span class="line">git fetch --all</span><br><span class="line">git reset --hard origin/master</span><br><span class="line">cnpm install</span><br></pre></td></tr></table></figure>
</li>
<li><p>blog 目录是A电脑, test 目录是B电脑, 更新文章后的同步操作：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#A电脑修改了 test.md,添加更新说明并推送到远程仓库,使用git status查看状态会显示刚刚更改过的文件状态</span></span><br><span class="line">git commit -m <span class="string">"update test.md"</span></span><br><span class="line">git push origin master</span><br><span class="line">git status</span><br><span class="line"><span class="comment">#B电脑同步更新</span></span><br><span class="line">git pull origin master</span><br><span class="line"><span class="comment">#可以通过指定当前目录工作分支与远程仓库分支之间的链接关系</span></span><br><span class="line">git branch --<span class="built_in">set</span>-upstream-to=origin/master master</span><br></pre></td></tr></table></figure>
</li>
<li><p>hexo 数据文件,通用配置文件,新建 source/_data 目录, 主题的配置可以在此目录下配置,以 Next 主题为例,在此目录下新建 next.yml, 则 next.yml 的配置会覆盖 themes/next/_config.yml 的相同配置</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>github</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
</search>
